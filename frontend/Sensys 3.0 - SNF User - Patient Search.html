<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sensys - Patient Search</title>
  <style>
    :root{
      --navy:#0D3B66;
      --mint:#A8E6CF;
      --mint-strong:#86d9ba;
      --bg:#ffffff;
      --bg-2:#F5F7FA;
      --icon-mint:#92e1c6;
      --text:#0f172a;
      --muted:#5b6b84;
      --line: rgba(13,59,102,.12);
      --shadow:0 16px 30px rgba(13,59,102,.08);
      --r-lg:18px;
      --r-md:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(
          900px 320px at 50% 1%,
          rgba(15,23,42,.035),
          rgba(255,255,255,0) 80%
        ),
        linear-gradient(180deg, #ffffff 0%, #f5f7fa 100%);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    .page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      padding-top:150px;
      gap:18px;
      text-align:center;
      position:relative;
    }
    .back{
      position:absolute;
      left:22px;
      top:25px;
      color:var(--navy);
      cursor:pointer;
      opacity:9;
    }
    .back svg{width:28px;height:28px}
    .back .cls-1{
      stroke:currentColor;
      fill:none;
      stroke-linecap:round;
      stroke-linejoin:round;
      stroke-width:6px;
    }
    .sensys-logo{
      height:200px;
      width:auto;
    }
    .kicker{
      margin:0 0 6px;
      font-size:12px;
      letter-spacing:.6px;
      text-transform:uppercase;
      color:var(--muted);
      font-weight:800;
    }
    h1{
      margin:0 0 10px;
      font-size:44px;
      font-weight:400;
      color:var(--navy);
      letter-spacing:.2px;
    }
    .search-wrap{
      width:min(520px, 92vw);
      margin-top:6px;
      position:relative;
    }
    .search{
      width:100%;
      padding:14px 16px;
      border-radius:14px;
      border:1px solid rgba(13,59,102,.18);
      background:#fff;
      font-size:14px;
      outline:none;
      box-shadow:0 8px 16px rgba(13,59,102,.06);
      transition: border-color .15s ease, box-shadow .15s ease, transform .15s ease;
    }
    .search:focus{
      border-color: rgba(168,230,207,.95);
      box-shadow: 0 10px 22px rgba(13,59,102,.12);
      transform: translateY(-1px);
    }
    .dropdown{
      position:absolute;
      left:0;
      right:0;
      top:56px;
      background:#fff;
      border:1px solid rgba(13,59,102,.12);
      border-radius:14px;
      box-shadow:var(--shadow);
      text-align:left;
      overflow:hidden;
      display:none;
      z-index:2;
    }
    .row{
      padding:12px 14px;
      border-bottom:1px solid rgba(13,59,102,.08);
      cursor:pointer;
    }
    .row:last-child{border-bottom:0}
    .row:hover{background:rgba(168,230,207,.12)}
    .row.active{background:rgba(168,230,207,.2)}
    .row .name{
      font-size:14px;
      font-weight:800;
      color:var(--navy);
    }
    .row .dob{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
    }
    .muted{
      font-size:12px;
      color:var(--muted);
      margin-top:8px;
    }
    @media (max-width: 980px){
      h1{font-size:36px}
      .sensys-logo{height:160px}
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="back" id="backBtn" aria-label="Back">
      <svg viewBox="0 0 180 180" aria-hidden="true">
        <polyline class="cls-1" points="110 30 50 90 110 150" />
      </svg>
    </div>

    <img class="sensys-logo" src="/static/images/Sensys-S-blue2.svg" alt="Sensys" />

    <div>
      <div class="kicker">Enter Discharge Plan</div>
      <h1>Which patient would you like to discharge?</h1>
    </div>

    <div class="search-wrap">
      <input id="search" class="search" placeholder="Start typing a patient name..." autocomplete="off" />
      <div id="dropdown" class="dropdown"></div>
    </div>

    <div class="muted">Search starts after 3 letters.</div>
  </div>

<script>
(function(){
  const search = document.getElementById("search");
  const dropdown = document.getElementById("dropdown");
  const backBtn = document.getElementById("backBtn");
  let allRows = [];
  let activeIndex = -1;

  function token(){
    return (localStorage.getItem("sensys_token") || "").trim();
  }

  function authHeaders(){
    return { "Authorization": "Bearer " + token() };
  }

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function showDropdown(items, showEmpty){
    activeIndex = -1;
    if(!items.length && !showEmpty){
      dropdown.style.display = "none";
      dropdown.innerHTML = "";
      return;
    }
    dropdown.innerHTML = items.length
      ? items.map(r => `
          <div class="row" data-id="${esc(r.id)}">
            <div class="name">${esc(r.patient_name || "Patient")}</div>
            <div class="dob">DOB: ${esc(r.patient_dob || "â€”")}</div>
          </div>
        `).join("")
      : `<div class="row" style="cursor:default;">
          <div class="name" style="color:#6b7280;">No patients found</div>
          <div class="dob">Try a different spelling.</div>
        </div>`;
    dropdown.style.display = "block";

    dropdown.querySelectorAll(".row[data-id]").forEach(row => {
      row.addEventListener("click", () => {
        const id = row.getAttribute("data-id");
        if(id){
          window.location.href = "/sensys/snf-user/discharge-plan?admission_id=" + encodeURIComponent(id);
        }
      });
    });
  }

  function rows(){
    return Array.from(dropdown.querySelectorAll(".row[data-id]"));
  }

  function setActive(index){
    const list = rows();
    list.forEach(r => r.classList.remove("active"));
    if(index >= 0 && index < list.length){
      list[index].classList.add("active");
      activeIndex = index;
    }
  }

  function selectActive(){
    const list = rows();
    if(!list.length){
      return false;
    }
    const index = activeIndex >= 0 ? activeIndex : 0;
    list[index].click();
    return true;
  }

  function handleSearch(){
    const q = (search.value || "").trim().toLowerCase();
    if(q.length < 3){
      showDropdown([]);
      return;
    }
    const matches = allRows.filter(r => {
      const hay = `${r.patient_name || ""}`.toLowerCase();
      return hay.includes(q);
    });
    showDropdown(matches.slice(0, 30), true);
  }

  async function load(){
    if(!token()){
      window.location.href = "/sensys/login";
      return;
    }
    try{
      const res = await fetch("/api/sensys/my-admissions?admitted_only=1", { headers: authHeaders() });
      const data = await res.json();
      if(!res.ok || !data.ok){
        allRows = [];
        return;
      }
      allRows = (data.admissions || []).map(r => ({
        id: r.id,
        patient_name: r.patient_name,
        patient_dob: r.patient_dob
      }));
    }catch(e){
      allRows = [];
    }
  }

  search.addEventListener("input", handleSearch);
  search.addEventListener("keydown", (e) => {
    if(dropdown.style.display !== "block"){
      return;
    }
    if(e.key === "ArrowDown"){
      e.preventDefault();
      const list = rows();
      if(!list.length){
        return;
      }
      const next = Math.min(activeIndex + 1, list.length - 1);
      setActive(next);
      return;
    }
    if(e.key === "ArrowUp"){
      e.preventDefault();
      const list = rows();
      if(!list.length){
        return;
      }
      const prev = Math.max(activeIndex - 1, 0);
      setActive(prev);
      return;
    }
    if(e.key === "Enter" || e.key === "Tab"){
      if(selectActive()){
        e.preventDefault();
      }
    }
  });
  document.addEventListener("click", (e) => {
    if(!dropdown.contains(e.target) && e.target !== search){
      dropdown.style.display = "none";
    }
  });

  backBtn.addEventListener("click", () => {
    window.location.href = "/sensys/snf-user";
  });

  load();
})();
</script>
</body>
</html>
