<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sensys 3.0 — Admin</title>
  <style>
    :root{
      --navy:#0d3b66;
      --mint:#a8e6cf;
      --sky:#4da8da;
      --ink:#0f172a;
      --muted:#64748b;
      --line:rgba(13,59,102,.14);
      --bg:#f6f8fb;
      --card:#ffffff;
      --shadow: 0 10px 24px rgba(13,59,102,.08);
      --r16:16px;
      --r12:12px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--ink);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .topbar{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r16);
      padding:14px 14px;
      box-shadow: 0 1px 0 rgba(15,23,42,.03);
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .brand{
      display:flex;flex-direction:column;gap:2px;
    }
    .brand .kicker{
      font-size:10px;letter-spacing:.16em;text-transform:uppercase;color:var(--muted);
    }
    .brand .title{
      font-size:18px;font-weight:800;color:var(--navy);
    }
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .field{
      display:flex;align-items:center;gap:8px;
      background:#fff;border:1px solid var(--line);
      border-radius:999px;padding:8px 10px;
    }
    .field label{font-size:12px;color:var(--muted)}
    .field input{
      border:none;outline:none;font-size:12px;min-width:240px;
    }
    .btn{
      border:1px solid rgba(13,59,102,.18);
      background:#fff;
      border-radius:999px;
      padding:10px 12px;
      font-weight:800;
      font-size:12px;
      cursor:pointer;
      transition: box-shadow .15s ease, border-color .15s ease, background .15s ease;
    }
    .btn:hover{border-color: rgba(168,230,207,.9); box-shadow: 0 0 0 3px rgba(168,230,207,.35);}
    .btn.primary{
      background: rgba(168,230,207,.22);
      border-color: rgba(168,230,207,.95);
      color: var(--navy);
    }
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .field input{min-width:180px}
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r16);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 14px;
      border-bottom:1px solid rgba(15,23,42,.06);
      display:flex;align-items:flex-end;justify-content:space-between;gap:10px;
    }
    .card .hd h2{margin:0;font-size:14px;color:var(--navy)}
    .hint{font-size:12px;color:var(--muted)}
    .card .body{padding:12px 14px}
    .table-wrap{border-radius:16px;border:1px solid rgba(13,59,102,.14);overflow:hidden;background:#fff;}
    table{width:100%;border-collapse:collapse;font-size:12px}
    thead{background: rgba(13,59,102,.05);}
    th,td{padding:10px 12px;text-align:left;vertical-align:middle}
    th{
      font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.09em;color:#475569;
      border-bottom:1px solid rgba(15,23,42,.08);
      white-space:nowrap;
    }
    tbody tr:nth-child(even){background:#f9fafb}
    tbody tr:hover{background:#eef2ff}
    td{border-bottom:1px solid rgba(15,23,42,.06)}
    tbody tr:last-child td{border-bottom:none}
    .pill{
      display:inline-flex;align-items:center;gap:8px;flex-wrap:wrap;
    }
    .tag{
      display:inline-flex;align-items:center;justify-content:center;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(13,59,102,.18);
      background:#fff;color:#334155;
      font-weight:800;font-size:11px;line-height:1;
      cursor:pointer;
      transition: border-color .15s ease, box-shadow .15s ease, background .15s ease, color .15s ease;
      user-select:none;
    }
    .tag:hover{border-color: rgba(168,230,207,.9); box-shadow: 0 0 0 3px rgba(168,230,207,.35);}
    .tag.on{
      border-color: rgba(168,230,207,.95);
      box-shadow: 0 10px 24px rgba(168,230,207,.18), 0 0 0 3px rgba(168,230,207,.45);
      background: rgba(168,230,207,.18);
      color: var(--navy);
    }
    .stack{display:flex;gap:10px;flex-wrap:wrap}
    .input, .select{
      width:100%;
      border:1px solid rgba(13,59,102,.18);
      border-radius:12px;
      padding:10px 10px;
      font-size:12px;
      outline:none;
      background:#fff;
    }
    .label{font-size:11px;color:var(--muted);margin-bottom:6px}
    .toast{
      margin-top:10px;
      font-size:12px;
      color:#0f172a;
    }
    .toast.ok{color:#065f46}
    .toast.err{color:#991b1b}
    .mini{
      font-size:11px;color:var(--muted);
    }
    
   /* --- NEW: left sidebar layout --- */
   .layout{
     display:grid;
     grid-template-columns: 220px 1fr;
     gap:14px;
     margin-top:14px;
   }
   .sidebar{
     background:var(--card);
     border:1px solid var(--line);
     border-radius:var(--r16);
     box-shadow: 0 1px 0 rgba(15,23,42,.03);
     padding:12px;
     height: calc(100vh - 120px);
     position: sticky;
     top: 18px;
     display:flex;
     flex-direction:column;
     gap:10px;
   }
   .navitem{
     display:flex;
     align-items:center;
     justify-content:space-between;
     gap:10px;
     padding:10px 12px;
     border-radius:12px;
     border:1px solid rgba(13,59,102,.14);
     cursor:pointer;
     font-weight:900;
     color: var(--navy);
     background:#fff;
   }
   .navitem.on{
     background: rgba(168,230,207,.18);
     border-color: rgba(168,230,207,.95);
     box-shadow: 0 0 0 3px rgba(168,230,207,.35);
   }
   .content{min-width:0}
   .panel{display:none}
   .panel.on{display:block}

   /* --- NEW: agency multi-select checklist --- */
   .checkwrap{
     border:1px solid rgba(13,59,102,.18);
     border-radius:12px;
     background:#fff;
     padding:10px;
   }
   .checksearch{
     width:100%;
     border:1px solid rgba(13,59,102,.18);
     border-radius:12px;
     padding:10px;
     font-size:12px;
     outline:none;
     margin-bottom:10px;
   }
   /* Agencies list inside Edit User modal */
   .checklist{
     max-height: 38vh;     /* gives it its own scroll area inside modal */
     overflow: auto;
     padding-right: 6px;
   }

   .checkrow{
     display:flex;
     align-items:flex-start;
     gap:10px;
     padding:8px 6px;
     border-radius:10px;

     font-size: 12px;      /* smaller overall font in agencies list */
     line-height: 1.25;
   }
   .checkrow:hover{background: rgba(77,168,218,08);}

   /* meta text shown next to name */
   .checkrow .agmeta{
     color: var(--muted);
     font-size: 11px;
     font-weight: 700;
   }

   /* --- Modals (full-screen lock + scroll) --- */
   .modal-backdrop{
     position:fixed;
     inset:0;
     background: rgba(0,0,0,.45);
     display:none;
     align-items:center;
     justify-content:center;
     padding:18px;
     z-index:9999;
   }
   .modal-backdrop.on{display:flex;}

   .modal{
     width:min(980px, 96vw);
     max-height:92vh;              /* locks to screen height */
     background:#fff;
     border-radius:18px;
     box-shadow: 0 18px 60px rgba(0,0,0,.30);
     overflow:hidden;              /* keeps header fixed visually */
     border: 1px solid rgba(13,59,102,18);
   }

   .modal-hd{
     display:flex;
     align-items:flex-start;
     justify-content:space-between;
     gap:12px;
     padding:14px 16px;
     border-bottom:1px solid rgba(13,59,102,12);
     background: rgba(250,250,252,1);
   }

   .modal-title{
     margin:0;
     font-size:18px;
     font-weight:900;
     color: var(--navy);
   }
   .modal-sub{
     margin-top:4px;
     color: var(--muted);
     font-size:12px;
   }

   .modal-body{
     padding:16px;
     max-height: calc(92vh - 64px); /* header height allowance */
     overflow:auto;                 /* scrollbars inside modal */
   }

   .iconbtn{
     width:40px;
     height:40px;
     border-radius:12px;
     border:1px solid rgba(13,59,102,.18);
     background:#fff;
     cursor:pointer;
     font-weight:900;
     font-size:20px;
     line-height:1;
     display:flex;
     align-items:center;
     justify-content:center;
     color: var(--navy);
   }
   .iconbtn:hover{ box-shadow: 0 0 0 3px rgba(77,168,218,.18); }

   .xbtn{
     width:40px;
     height:40px;
     border-radius:12px;
     border:1px solid rgba(13,59,102,.18);
     background:#fff;
     cursor:pointer;
     font-weight:900;
     font-size:16px;
     line-height:1;
   }

  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="kicker">Sensys 3.0</div>
        <div class="title">Admin</div>
      </div>

      <div class="row">
        <div class="field">
          <label>ADMIN_TOKEN</label>
          <input id="token" placeholder="paste token here…" />
        </div>
        <button class="btn" id="saveToken">Save</button>
        <button class="btn primary" id="refresh">Refresh</button>
      </div>
    </div>

    <div class="layout">
      <!-- LEFT SIDEBAR -->
      <div class="sidebar">
        <div class="mini" style="font-weight:900;color:var(--muted);letter-spacing:.12em;text-transform:uppercase;">
          Sections
        </div>

        <div class="navitem on" id="tabUsers">Users</div>
        <div class="navitem" id="tabAgencies">Agencies</div>
      </div>

      <!-- USERS PANEL -->
      <div class="panel on" id="panelUsers">
        <!-- RIGHT CONTENT -->
        <div class="content">
          <div class="hd" style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px">
            <div>
              <h2 style="margin:0">Users</h2>
              <div class="hint">Click a row to edit. Roles + agencies are saved separately.</div>
            </div>

            <!-- Add New User (top-right icon) -->
            <button class="iconbtn" id="addUserIcon" title="Add new user" aria-label="Add new user">+</button>
          </div>
          <div class="body">
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Email</th>
                    <th>Name</th>
                    <th>Active</th>
                    <th>Roles</th>
                    <th>Agencies</th>
                    <th>Locked</th>
                  </tr>
                </thead>
                <tbody id="tbody"></tbody>
              </table>
            </div>
            <div id="listMsg" class="toast"></div>
          </div>
        </div>

        <!-- RIGHT: Editor removed (user editing is now a modal) -->
        <div class="card" style="display:none"></div>

      </div><!-- /panelUsers -->

      <!-- =========================
           AGENCIES PANEL
      ========================= -->
      <div class="panel" id="panelAgencies">
        <div class="content">
          <div class="hd" style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px">
            <div>
              <h2 style="margin:0">Agencies</h2>
              <div class="hint">List used for user admission linking and multi-agency access.</div>
            </div>

            <!-- Add New Agency (top-right icon) -->
            <button class="iconbtn" id="addAgencyIcon" title="Add new agency" aria-label="Add new agency">+</button>
          </div>

          <div class="body">
            <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px">
              <input class="input" id="agencyListSearch" placeholder="Search agencies." />
            </div>

            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Evolv Client</th>
                  </tr>
                </thead>
                <tbody id="agencyTbody"></tbody>
              </table>
            </div>

            <div id="agencyListMsg" class="toast"></div>
          </div>
        </div>
      </div><!-- /panelAgencies -->     
    </div><!-- /layout -->
  </div>
<!-- =========================
     USER MODAL
========================= -->
<div class="modal-backdrop" id="userModalBackdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="userModalTitle">
    <div class="modal-hd">
      <div>
        <h3 class="modal-title" id="userModalTitle">Edit User</h3>
        <div class="modal-sub">user_id: <b id="selId">—</b></div>
      </div>
      <button class="xbtn" id="closeUserModal" aria-label="Close">✕</button>
    </div>

    <div class="modal-body">
      <div class="label">Email/Username</div>
      <input class="input" id="email" placeholder="user@email.com" />

      <div style="height:10px"></div>

      <div class="label">Display Name</div>
      <input class="input" id="display_name" placeholder="Full name" />

      <div style="height:10px"></div>

      <div class="label">Active</div>
      <select class="select" id="is_active">
        <option value="1">Yes (Active)</option>
        <option value="0">No (Inactive)</option>
      </select>

      <div style="height:14px"></div>

      <div class="label">Roles</div>
      <div class="pill" id="roles"></div>

      <div style="height:14px"></div>

      <div class="label">Cell Phone</div>
      <input class="input" id="cell_phone" placeholder="(xxx) xxx-xxxx" />

      <div style="height:10px"></div>

      <div class="label">Password</div>
      <input class="input" id="password" type="password" placeholder="Leave blank to keep unchanged" />

      <div style="height:10px"></div>

      <div class="label">Account Locked</div>
      <select class="select" id="account_locked">
        <option value="0">No</option>
        <option value="1">Yes (Locked)</option>
      </select>

      <div style="height:14px"></div>

      <div class="label">Agencies (multi-select)</div>
      <div class="checkwrap">
        <input class="checksearch" id="agencySearch" placeholder="Search agencies." />
        <div class="checklist" id="agencyChecklist"></div>
      </div>

      <div style="height:14px"></div>

      <div class="stack">
        <button class="btn primary" id="saveUser">Save User</button>
      </div>

      <div id="editMsg" class="toast"></div>
    </div>
  </div>
</div>

<!-- =========================
     AGENCY MODAL
========================= -->
<div class="modal-backdrop" id="agencyModalBackdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="agencyModalTitle">
    <div class="modal-hd">
      <div>
        <h3 class="modal-title" id="agencyModalTitle">Edit Agency</h3>
        <div class="modal-sub">agency_id: <b id="selAgencyId">—</b></div>
      </div>
      <button class="xbtn" id="closeAgencyModal" aria-label="Close">✕</button>
    </div>

    <div class="modal-body">
      <div class="label">Agency Name</div>
      <input class="input" id="agency_name" placeholder="Agency name" />

      <div style="height:10px"></div>

      <div class="label">Agency Type</div>
      <select class="select" id="agency_type">
        <option value="Hospital">Hospital</option>
        <option value="SNF">SNF</option>
        <option value="Home Health">Home Health</option>
        <option value="IRF">IRF</option>
        <option value="LTACH">LTACH</option>
        <option value="Hospice">Hospice</option>
        <option value="Outpatient PT">Outpatient PT</option>
      </select>

      <div style="height:10px"></div>

      <div class="label">Facility Code</div>
      <input class="input" id="facility_code" placeholder="Optional code" />

      <div style="height:10px"></div>

      <div class="label">Address</div>
      <input class="input" id="address" placeholder="Street address" />

      <div style="height:10px"></div>

      <div class="label">City</div>
      <input class="input" id="city" placeholder="City" />

      <div style="height:10px"></div>

      <div class="label">State</div>
      <input class="input" id="state" placeholder="State" />

      <div style="height:10px"></div>

      <div class="label">Zip</div>
      <input class="input" id="zip" placeholder="Zip" />

      <div style="height:10px"></div>

      <div class="label">Phone 1</div>
      <input class="input" id="phone1" placeholder="Phone 1" />

      <div style="height:10px"></div>

      <div class="label">Phone 2</div>
      <input class="input" id="phone2" placeholder="Phone 2" />

      <div style="height:10px"></div>

      <div class="label">Email</div>
      <input class="input" id="email2" placeholder="Email" />

      <div style="height:10px"></div>

      <div class="label">Fax</div>
      <input class="input" id="fax" placeholder="Fax" />

      <div style="height:10px"></div>

      <div class="label">Notes</div>
      <input class="input" id="notes" placeholder="Notes" />

      <div style="height:10px"></div>

      <div class="label">Notes 2</div>
      <input class="input" id="notes2" placeholder="Notes 2" />

      <div style="height:10px"></div>

      <div class="label">Evolv Client</div>
      <select class="select" id="evolv_client">
        <option value="0">No</option>
        <option value="1">Yes</option>
      </select>

      <div style="height:14px"></div>

      <div class="stack">
        <button class="btn primary" id="saveAgency">Save Agency</button>
      </div>

      <div id="agencyEditMsg" class="toast"></div>
    </div>
  </div>
</div>

<script>
  const $ = (id) => document.getElementById(id);

  function openUserModal(){
    $("userModalBackdrop").classList.add("on");
  }
  function closeUserModal(){
    $("userModalBackdrop").classList.remove("on");
  }

  function openAgencyModal(){
    $("agencyModalBackdrop").classList.add("on");
  }
  function closeAgencyModal(){
    $("agencyModalBackdrop").classList.remove("on");
  }

  // Close when clicking the dark backdrop
  $("userModalBackdrop").addEventListener("click", (e) => {
    if(e.target.id === "userModalBackdrop") closeUserModal();
  });
  $("agencyModalBackdrop").addEventListener("click", (e) => {
    if(e.target.id === "agencyModalBackdrop") closeAgencyModal();
  });

  // Close buttons
  $("closeUserModal").onclick = closeUserModal;
  $("closeAgencyModal").onclick = closeAgencyModal;

  // ESC key closes whichever modal is open
  document.addEventListener("keydown", (e) => {
    if(e.key !== "Escape") return;
    closeUserModal();
    closeAgencyModal();
  });

  function getToken(){
    return ($("token").value || localStorage.getItem("SENSYS_ADMIN_TOKEN") || "").trim();
  }

  function setMsg(el, text, ok=true){
    el.className = "toast " + (ok ? "ok" : "err");
    el.textContent = text || "";
  }

  let rolesMaster = [];
  let usersCache = [];
  let selectedUserId = null;
  let selectedRoleKeys = new Set();

  let agenciesMaster = [];
  let selectedAgencyIds = new Set();

  let agenciesCache = [];
  let selectedAgencyId = null;

  function renderAgencyChecklist(){
    const wrap = $("agencyChecklist");
    const q = ($("agencySearch").value || "").trim().toLowerCase();
    wrap.innerHTML = "";

    const items = (agenciesMaster || []).filter(a => {
      const hay = `${a.agency_name || ""} ${a.agency_type || ""} ${a.city || ""} ${a.state || ""}`.toLowerCase();
      return !q || hay.includes(q);
    });

    items.forEach(a => {
      const row = document.createElement("div");
      row.className = "checkrow";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = selectedAgencyIds.has(a.id);
      cb.onchange = () => {
        if(cb.checked) selectedAgencyIds.add(a.id);
        else selectedAgencyIds.delete(a.id);
      };

      const label = document.createElement("div");
      const locRaw =
        (a.city || a.state)
          ? (String(a.city || "") + (a.city && a.state ? ", " : "") + String(a.state || ""))
          : "";

      const evolvTag = a.evolv_client ? " (Evolv Client)" : "";
      const metaParts = [
        `${escapeHtml(a.agency_type || "")}${evolvTag}`,
        (locRaw ? escapeHtml(locRaw) : "")
      ].filter(Boolean);

      label.innerHTML = `
        <b>${escapeHtml(a.agency_name || "")}</b>
        <span class="agmeta"> — ${metaParts.join(" • ")}</span>
      `;

      row.appendChild(cb);
      row.appendChild(label);
      wrap.appendChild(row);
    });
  }

  function renderRolesPills(){
    const wrap = $("roles");
    wrap.innerHTML = "";
    rolesMaster.forEach(r => {
      const b = document.createElement("span");
      b.className = "tag " + (selectedRoleKeys.has(r.role_key) ? "on" : "");
      b.textContent = r.role_name;
      b.onclick = () => {
        if(selectedRoleKeys.has(r.role_key)) selectedRoleKeys.delete(r.role_key);
        else selectedRoleKeys.add(r.role_key);
        renderRolesPills();
      };
      wrap.appendChild(b);
    });
  }

  function selectUser(u){
    selectedUserId = u.user_id;
    $("selId").textContent = String(u.user_id);
    $("email").value = u.email || "";
    $("display_name").value = u.display_name || "";
    $("is_active").value = String(u.is_active ?? 1);

    selectedRoleKeys = new Set(u.role_keys || []);
    renderRolesPills();

    $("cell_phone").value = u.cell_phone || "";
    $("password").value = ""; // never auto-fill password
    $("account_locked").value = String(u.account_locked ? 1 : 0);

    selectedAgencyIds = new Set(u.agency_ids || []);
    renderAgencyChecklist();

    setMsg($("editMsg"), "", true);

    // NEW: open modal
    openUserModal();
  }

  function renderUsersTable(){
    const tbody = $("tbody");
    tbody.innerHTML = "";

    usersCache.forEach(u => {
      const tr = document.createElement("tr");
      tr.style.cursor = "pointer";
      tr.onclick = () => selectUser(u);

      const roles = (u.role_keys || []).join(", ");
      const ags = (u.agency_names || []).join(", ");

      tr.innerHTML = `
        <td><b>${escapeHtml(u.email || "")}</b></td>
        <td>${escapeHtml(u.display_name || "")}</td>
        <td>${u.is_active ? "Yes" : "No"}</td>
        <td>${escapeHtml(roles)}</td>
        <td>${escapeHtml(ags)}</td>
        <td>${u.account_locked ? "Yes" : "No"}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  async function apiGet(path){
    const token = getToken();
    if(!token) throw new Error("Missing ADMIN_TOKEN (paste it top-right, click Save)");
    const url = path.includes("?") ? `${path}&token=${encodeURIComponent(token)}` : `${path}?token=${encodeURIComponent(token)}`;
    const res = await fetch(url);
    if(!res.ok) throw new Error(await res.text());
    return await res.json();
  }

  async function apiPost(path, payload){
    const token = getToken();
    if(!token) throw new Error("Missing ADMIN_TOKEN (paste it top-right, click Save)");
    const url = path.includes("?") ? `${path}&token=${encodeURIComponent(token)}` : `${path}?token=${encodeURIComponent(token)}`;
    const res = await fetch(url, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload || {})
    });
    if(!res.ok) throw new Error(await res.text());
    return await res.json();
  }

  async function refreshAll(){
    setMsg($("listMsg"), "Loading…", true);
    try{
      const rolesResp = await apiGet("/api/sensys/admin/roles");
      rolesMaster = rolesResp.roles || [];
      renderRolesPills();

      const agResp = await apiGet("/api/sensys/admin/agencies");
      agenciesMaster = agResp.agencies || [];
      renderAgencyChecklist();

      const usersResp = await apiGet("/api/sensys/admin/users");
      usersCache = usersResp.users || [];
      renderUsersTable();

      setMsg($("listMsg"), `Loaded ${usersCache.length} users.`, true);

    }catch(e){
      setMsg($("listMsg"), String(e.message || e), false);
    }
  }

  function startNewUser(){
    selectedUserId = null;
    $("selId").textContent = "—";
    $("email").value = "";
    $("display_name").value = "";
    $("is_active").value = "1";

    selectedRoleKeys = new Set();
    renderRolesPills();

    selectedAgencyIds = new Set();
    renderAgencyChecklist();

    $("cell_phone").value = "";
    $("password").value = "";
    $("account_locked").value = "0";

    setMsg($("editMsg"), "New user mode (Save User to create).", true);

    openUserModal();
  }

  // NEW: top-right icon
  $("addUserIcon").onclick = startNewUser;

  $("saveUser").onclick = async () => {
    try{
      const payload = {
        user_id: selectedUserId,
        email: ($("email").value || "").trim(),
        display_name: ($("display_name").value || "").trim(),
        is_active: parseInt($("is_active").value, 10),

        cell_phone: ($("cell_phone").value || "").trim(),
        password: ($("password").value || "").trim(), // blank = keep unchanged (backend handles)
        account_locked: $("account_locked").value === "1"
      };

      // 1) Save core user (backend will return user_id)
      const upsertResp = await apiPost("/api/sensys/admin/users/upsert", payload);
      selectedUserId = upsertResp.user_id;              // important for "new user" flow
      $("selId").textContent = String(selectedUserId);  // update modal header id

      // 2) Save roles
      await apiPost("/api/sensys/admin/users/set-roles", {
        user_id: selectedUserId,
        role_keys: Array.from(selectedRoleKeys)
      });

      // 3) Save agencies
      await apiPost("/api/sensys/admin/users/set-agencies", {
        user_id: selectedUserId,
        agency_ids: Array.from(selectedAgencyIds)
      });

      setMsg($("editMsg"), "User + roles + agencies saved.", true);
      await refreshAll();
    }catch(e){
      setMsg($("editMsg"), String(e.message || e), false);
    }
  };

  // load saved token on open
  $("token").value = localStorage.getItem("SENSYS_ADMIN_TOKEN") || "";

  $("agencySearch").addEventListener("input", renderAgencyChecklist);

  function showPanel(which){
    const onUsers = which === "users";

    $("tabUsers").className = "navitem " + (onUsers ? "on" : "");
    $("tabAgencies").className = "navitem " + (!onUsers ? "on" : "");

    // hide both panels first
    $("panelUsers").classList.remove("on");
    $("panelAgencies").classList.remove("on");

    if(onUsers){
      $("panelUsers").classList.add("on");
    }else{
      $("panelAgencies").classList.add("on");
      refreshAgenciesList();
    }

    // optional: jump to top so it feels like a real tab switch
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  $("tabUsers").onclick = () => showPanel("users");
  $("tabAgencies").onclick = () => showPanel("agencies");

  // --- Agencies page logic ---
  function renderAgenciesTable(){
    const tbody = $("agencyTbody");
    tbody.innerHTML = "";

    const q = ($("agencyListSearch").value || "").trim().toLowerCase();
    const items = (agenciesCache || []).filter(a => {
      const hay = `${a.agency_name||""} ${a.agency_type||""}`.toLowerCase();
      return !q || hay.includes(q);
    });

    items.forEach(a => {
      const tr = document.createElement("tr");
      tr.style.cursor = "pointer";
      tr.onclick = () => selectAgency(a);
      tr.innerHTML = `
        <td><b>${escapeHtml(a.agency_name||"")}</b></td>
        <td>${escapeHtml(a.agency_type||"")}</td>
        <td>${a.evolv_client ? "Yes" : "No"}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function selectAgency(a){
    selectedAgencyId = a.id;
    $("selAgencyId").textContent = String(a.id);

    $("agency_name").value = a.agency_name || "";
    $("agency_type").value = a.agency_type || "Hospital";
    $("facility_code").value = a.facility_code || "";
    $("address").value = a.address || "";
    $("city").value = a.city || "";
    $("state").value = a.state || "";
    $("zip").value = a.zip || "";
    $("phone1").value = a.phone1 || "";
    $("phone2").value = a.phone2 || "";
    $("email2").value = a.email || "";
    $("fax").value = a.fax || "";
    $("notes").value = a.notes || "";
    $("notes2").value = a.notes2 || "";
    $("evolv_client").value = String(a.evolv_client ? 1 : 0);

    setMsg($("agencyEditMsg"), "", true);

    // NEW: open modal
    openAgencyModal();
  }

  async function refreshAgenciesList(){
    setMsg($("agencyListMsg"), "Loading…", true);
    try{
      const agResp = await apiGet("/api/sensys/admin/agencies");
      agenciesCache = agResp.agencies || [];
      agenciesMaster = agenciesCache;       // keep master in sync for user checklist
      renderAgenciesTable();
      renderAgencyChecklist();

      setMsg($("agencyListMsg"), `Loaded ${agenciesCache.length} agencies.`, true);
      if(agenciesCache.length && !selectedAgencyId) selectAgency(agenciesCache[0]);
    }catch(e){
      setMsg($("agencyListMsg"), String(e.message || e), false);
    }
  }

  $("agencyListSearch").addEventListener("input", renderAgenciesTable);

  function startNewAgency(){
    selectedAgencyId = null;
    $("selAgencyId").textContent = "—";
    $("agency_name").value = "";
    $("agency_type").value = "Hospital";
    $("facility_code").value = "";
    $("address").value = "";
    $("city").value = "";
    $("state").value = "";
    $("zip").value = "";
    $("phone1").value = "";
    $("phone2").value = "";
    $("email2").value = "";
    $("fax").value = "";
    $("notes").value = "";
    $("notes2").value = "";
    $("evolv_client").value = "0";

    setMsg($("agencyEditMsg"), "New agency mode (Save Agency to create).", true);

    openAgencyModal();
  }

  // NEW: top-right icon
  $("addAgencyIcon").onclick = startNewAgency;


  $("saveAgency").onclick = async () => {
    try{
      const payload = {
        id: selectedAgencyId,
        agency_name: ($("agency_name").value || "").trim(),
        agency_type: ($("agency_type").value || "").trim(),
        facility_code: ($("facility_code").value || "").trim(),
        address: ($("address").value || "").trim(),
        city: ($("city").value || "").trim(),
        state: ($("state").value || "").trim(),
        zip: ($("zip").value || "").trim(),
        phone1: ($("phone1").value || "").trim(),
        phone2: ($("phone2").value || "").trim(),
        email: ($("email2").value || "").trim(),
        fax: ($("fax").value || "").trim(),
        notes: ($("notes").value || "").trim(),
        notes2: ($("notes2").value || "").trim(),
        evolv_client: $("evolv_client").value === "1"
      };

      await apiPost("/api/sensys/admin/agencies/upsert", payload);
      setMsg($("agencyEditMsg"), "Agency saved.", true);
      await refreshAgenciesList();
    }catch(e){
      setMsg($("agencyEditMsg"), String(e.message || e), false);
    }
  };

  // Default panel: Users (no .panel needed). Agencies panel stays hidden until clicked.

  // initial load
  refreshAll();
</script>
</body>
</html>
