<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sensys 3.0 — Admin</title>
  <style>
    :root{
      --navy:#0d3b66;
      --mint:#a8e6cf;
      --sky:#4da8da;
      --ink:#0f172a;
      --muted:#64748b;
      --line:rgba(13,59,102,.14);
      --bg:#f6f8fb;
      --card:#ffffff;
      --shadow: 0 10px 24px rgba(13,59,102,.08);
      --r16:16px;
      --r12:12px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--ink);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .topbar{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r16);
      padding:14px 14px;
      box-shadow: 0 1px 0 rgba(15,23,42,.03);
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .brand{
      display:flex;flex-direction:column;gap:2px;
    }
    .brand .kicker{
      font-size:10px;letter-spacing:.16em;text-transform:uppercase;color:var(--muted);
    }
    .brand .title{
      font-size:18px;font-weight:800;color:var(--navy);
    }
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .field{
      display:flex;align-items:center;gap:8px;
      background:#fff;border:1px solid var(--line);
      border-radius:999px;padding:8px 10px;
    }
    .field label{font-size:12px;color:var(--muted)}
    .field input{
      border:none;outline:none;font-size:12px;min-width:240px;
    }
    .btn{
      border:1px solid rgba(13,59,102,.18);
      background:#fff;
      border-radius:999px;
      padding:10px 12px;
      font-weight:800;
      font-size:12px;
      cursor:pointer;
      transition: box-shadow .15s ease, border-color .15s ease, background .15s ease;
    }
    .btn:hover{border-color: rgba(168,230,207,.9); box-shadow: 0 0 0 3px rgba(168,230,207,.35);}
    .btn.primary{
      background: rgba(168,230,207,.22);
      border-color: rgba(168,230,207,.95);
      color: var(--navy);
    }
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .field input{min-width:180px}
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r16);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 14px;
      border-bottom:1px solid rgba(15,23,42,.06);
      display:flex;align-items:flex-end;justify-content:space-between;gap:10px;
    }
    .card .hd h2{margin:0;font-size:14px;color:var(--navy)}
    .hint{font-size:12px;color:var(--muted)}
    .card .body{padding:12px 14px}
    .table-wrap{border-radius:16px;border:1px solid rgba(13,59,102,.14);overflow:hidden;background:#fff;}
    table{width:100%;border-collapse:collapse;font-size:12px}
    thead{background: rgba(13,59,102,.05);}
    th,td{padding:10px 12px;text-align:left;vertical-align:middle}
    th{
      font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.09em;color:#475569;
      border-bottom:1px solid rgba(15,23,42,.08);
      white-space:nowrap;
    }
    tbody tr:nth-child(even){background:#f9fafb}
    tbody tr:hover{background:#eef2ff}
    td{border-bottom:1px solid rgba(15,23,42,.06)}
    tbody tr:last-child td{border-bottom:none}
    .pill{
      display:inline-flex;align-items:center;gap:8px;flex-wrap:wrap;
    }
    .tag{
      display:inline-flex;align-items:center;justify-content:center;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(13,59,102,.18);
      background:#fff;color:#334155;
      font-weight:800;font-size:11px;line-height:1;
      cursor:pointer;
      transition: border-color .15s ease, box-shadow .15s ease, background .15s ease, color .15s ease;
      user-select:none;
    }
    .tag:hover{border-color: rgba(168,230,207,.9); box-shadow: 0 0 0 3px rgba(168,230,207,.35);}
    .tag.on{
      border-color: rgba(168,230,207,.95);
      box-shadow: 0 10px 24px rgba(168,230,207,.18), 0 0 0 3px rgba(168,230,207,.45);
      background: rgba(168,230,207,.18);
      color: var(--navy);
    }
    .stack{display:flex;gap:10px;flex-wrap:wrap}
    .input, .select{
      width:100%;
      border:1px solid rgba(13,59,102,.18);
      border-radius:12px;
      padding:10px 10px;
      font-size:12px;
      outline:none;
      background:#fff;
    }
    .label{font-size:11px;color:var(--muted);margin-bottom:6px}
    .toast{
      margin-top:10px;
      font-size:12px;
      color:#0f172a;
    }
    .toast.ok{color:#065f46}
    .toast.err{color:#991b1b}
    .mini{
      font-size:11px;color:var(--muted);
    }
    
   /* --- NEW: left sidebar layout --- */
   .layout{
     display:grid;
     grid-template-columns: 220px 1fr;
     gap:14px;
     margin-top:14px;
   }
   .sidebar{
     background:var(--card);
     border:1px solid var(--line);
     border-radius:var(--r16);
     box-shadow: 0 1px 0 rgba(15,23,42,.03);
     padding:12px;
     height: calc(100vh - 120px);
     position: sticky;
     top: 18px;
     display:flex;
     flex-direction:column;
     gap:10px;
   }
   .navitem{
     display:flex;
     align-items:center;
     justify-content:space-between;
     gap:10px;
     padding:10px 12px;
     border-radius:12px;
     border:1px solid rgba(13,59,102,.14);
     cursor:pointer;
     font-weight:900;
     color: var(--navy);
     background:#fff;
   }
   .navitem.on{
     background: rgba(168,230,207,.18);
     border-color: rgba(168,230,207,.95);
     box-shadow: 0 0 0 3px rgba(168,230,207,.35);
   }
   .content{min-width:0}
   .panel{display:none}
   .panel.on{display:block}

   /* --- NEW: agency multi-select checklist --- */
   .checkwrap{
     border:1px solid rgba(13,59,102,.18);
     border-radius:12px;
     background:#fff;
     padding:10px;
   }
   .checksearch{
     width:100%;
     border:1px solid rgba(13,59,102,.18);
     border-radius:12px;
     padding:10px;
     font-size:12px;
     outline:none;
     margin-bottom:10px;
   }
   /* Agencies list inside Edit User modal */
   .checklist{
     max-height: 38vh;     /* gives it its own scroll area inside modal */
     overflow: auto;
     padding-right: 6px;
   }

   .checkrow{
     display:flex;
     align-items:flex-start;
     gap:10px;
     padding:8px 6px;
     border-radius:10px;

     font-size: 12px;      /* smaller overall font in agencies list */
     line-height: 1.25;
   }
   .checkrow:hover{background: rgba(77,168,218,08);}

   /* meta text shown next to name */
   .checkrow .agmeta{
     color: var(--muted);
     font-size: 11px;
     font-weight: 700;
   }

   /* --- Modals (full-screen lock + scroll) --- */
   .modal-backdrop{
     position:fixed;
     inset:0;
     background: rgba(0,0,0,.45);
     display:none;
     align-items:center;
     justify-content:center;
     padding:18px;
     z-index:9999;
   }
   .modal-backdrop.on{display:flex;}

   .modal{
     width:min(980px, 96vw);
     max-height:92vh;              /* locks to screen height */
     background:#fff;
     border-radius:18px;
     box-shadow: 0 18px 60px rgba(0,0,0,.30);
     overflow:hidden;              /* keeps header fixed visually */
     border: 1px solid rgba(13,59,102,18);
   }

   .modal-hd{
     display:flex;
     align-items:flex-start;
     justify-content:space-between;
     gap:12px;
     padding:14px 16px;
     border-bottom:1px solid rgba(13,59,102,12);
     background: rgba(250,250,252,1);
   }

   .modal-title{
     margin:0;
     font-size:18px;
     font-weight:900;
     color: var(--navy);
   }
   .modal-sub{
     margin-top:4px;
     color: var(--muted);
     font-size:12px;
   }

   .modal-body{
     padding:16px;
     max-height: calc(92vh - 64px); /* header height allowance */
     overflow:auto;                 /* scrollbars inside modal */
   }

   .iconbtn{
     width:40px;
     height:40px;
     border-radius:12px;
     border:1px solid rgba(13,59,102,.18);
     background:#fff;
     cursor:pointer;
     font-weight:900;
     font-size:20px;
     line-height:1;
     display:flex;
     align-items:center;
     justify-content:center;
     color: var(--navy);
   }
   .iconbtn:hover{ box-shadow: 0 0 0 3px rgba(77,168,218,18); }

   /* Bulk upload modal */
   .dropzone{
     border:2px dashed rgba(13,59,102,25);
     border-radius:16px;
     padding:18px;
     background: rgba(250,250,252,1);
     display:flex;
     flex-direction:column;
     gap:10px;
     align-items:center;
     justify-content:center;
     text-align:center;
   }
   .dropzone.on{
     box-shadow: 0 0 0 3px rgba(77,168,218,18);
     border-color: rgba(77,168,218,60);
   }
   .smallhint{
     color: var(--muted);
     font-size:12px;
     line-height:1.35;
   }

   .xbtn{
     width:40px;
     height:40px;
     border-radius:12px;
     border:1px solid rgba(13,59,102,.18);
     background:#fff;
     cursor:pointer;
     font-weight:900;
     font-size:16px;
     line-height:1;
   }

  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="kicker">Sensys 3.0</div>
        <div class="title">Admin</div>
      </div>

      <div class="row">
        <div class="field">
          <label>ADMIN_TOKEN</label>
          <input id="token" placeholder="paste token here…" />
        </div>
        <button class="btn" id="saveToken">Save</button>
        <button class="btn primary" id="refresh">Refresh</button>
      </div>
    </div>

    <div class="layout">
      <!-- LEFT SIDEBAR -->
      <div class="sidebar">
        <div class="mini" style="font-weight:900;color:var(--muted);letter-spacing:.12em;text-transform:uppercase;">
          Sections
        </div>

        <div class="navitem on" id="tabUsers">Users</div>
        <div class="navitem" id="tabAgencies">Agencies</div>
        <div class="navitem" id="tabPatients">Patients</div>
        <div class="navitem" id="tabAdmissions">Admissions</div>

        <div style="height:10px"></div>
        <div class="mini" style="font-weight:900;color:var(--muted);letter-spacing:.12em;text-transform:uppercase;">
          Reference
        </div>
        <div class="navitem" id="tabServices">Services</div>
        <div class="navitem" id="tabCareTeam">Care Team</div>
      </div>

      <!-- USERS PANEL -->
      <div class="panel on" id="panelUsers">
        <!-- RIGHT CONTENT -->
        <div class="content">
          <div class="hd" style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px">
            <div>
              <h2 style="margin:0">Users</h2>
              <div class="hint">Click a row to edit. Roles + agencies are saved separately.</div>
            </div>

            <!-- Add New User (top-right icon) -->
            <div style="display:flex;gap:8px;align-items:center">
              <button class="iconbtn" id="bulkUsersIcon" title="Bulk upload users" aria-label="Bulk upload users">⇪</button>
              <button class="iconbtn" id="addUserIcon" title="Add new user" aria-label="Add new user">+</button>
            </div>
          </div>
          <div class="body">
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Email</th>
                    <th>Name</th>
                    <th>Active</th>
                    <th>Roles</th>
                    <th>Agencies</th>
                    <th>Locked</th>
                  </tr>
                </thead>
                <tbody id="tbody"></tbody>
              </table>
            </div>
            <div id="listMsg" class="toast"></div>
          </div>
        </div>

        <!-- RIGHT: Editor removed (user editing is now a modal) -->
        <div class="card" style="display:none"></div>

      </div><!-- /panelUsers -->
      
      <!-- =========================
           AGENCIES PANEL
      ========================= -->
      <div class="panel" id="panelAgencies">
        <div class="content">
          <div class="hd" style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px">
            <div>
              <h2 style="margin:0">Agencies</h2>
              <div class="hint">List used for user admission linking and multi-agency access.</div>
            </div>

            <!-- Add New Agency (top-right icon) -->
            <div style="display:flex;gap:8px;align-items:center">
              <button class="iconbtn" id="bulkAgenciesIcon" title="Bulk upload agencies" aria-label="Bulk upload agencies">⇪</button>
              <button class="iconbtn" id="addAgencyIcon" title="Add new agency" aria-label="Add new agency">+</button>
            </div>
          </div>

          <div class="body">
            <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px">
              <input class="input" id="agencyListSearch" placeholder="Search agencies." />
            </div>

            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Evolv Client</th>
                  </tr>
                </thead>
                <tbody id="agencyTbody"></tbody>
              </table>
            </div>

            <div id="agencyListMsg" class="toast"></div>
          </div>
        </div>
      </div><!-- /panelAgencies -->     
      <!-- =========================
           PATIENTS PANEL
      ========================= -->
      <div class="panel" id="panelPatients">
        <div class="content">
          <div class="hd" style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px">
            <div>
              <h2 style="margin:0">Patients</h2>
              <div class="hint">Manual add/edit for sensys_patients.</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="iconbtn" id="bulkPatientsIcon" title="Bulk upload patients" aria-label="Bulk upload patients">⇪</button>
              <button class="iconbtn" id="addPatientIcon" title="Add new patient" aria-label="Add new patient">+</button>
            </div>
          </div>

          <div class="body">
            <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px">
              <input class="input" id="patientListSearch" placeholder="Search patients (name, DOB, phone, email)..." />
            </div>

            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Patient</th>
                    <th>DOB</th>
                    <th>Phone</th>
                    <th>Active</th>
                  </tr>
                </thead>
                <tbody id="patientTbody"></tbody>
              </table>
            </div>

            <div id="patientListMsg" class="toast"></div>
          </div>
        </div>
      </div><!-- /panelPatients -->


      <!-- =========================
           ADMISSIONS PANEL
      ========================= -->
      <div class="panel" id="panelAdmissions">
        <div class="content">
          <div class="hd" style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px">
            <div>
              <h2 style="margin:0">Admissions</h2>
              <div class="hint">Manual add/edit for sensys_admissions (patient + agency + dates).</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="iconbtn" id="bulkAdmissionsIcon" title="Bulk upload admissions" aria-label="Bulk upload admissions">⇪</button>
              <button class="iconbtn" id="addAdmissionIcon" title="Add new admission" aria-label="Add new admission">+</button>
            </div>
          </div>

          <div class="body">
            <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px">
              <input class="input" id="admissionListSearch" placeholder="Search admissions (patient, agency, dates)..." />
            </div>

            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Patient</th>
                    <th>Agency</th>
                    <th>Admit</th>
                    <th>DC</th>
                    <th>Active</th>
                  </tr>
                </thead>
                <tbody id="admissionTbody"></tbody>
              </table>
            </div>

            <div id="admissionListMsg" class="toast"></div>
          </div>
        </div>
      </div><!-- /panelAdmissions -->
      <!-- =========================
           SERVICES PANEL
      ========================= -->
      <div class="panel" id="panelServices">
        <div class="content">
          <div class="hd" style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px">
            <div>
              <h2 style="margin:0">Services</h2>
              <div class="hint">Reference list used for DC submissions (DME / HH).</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="iconbtn" id="bulkServicesIcon" title="Bulk upload services" aria-label="Bulk upload services">⇪</button>
              <button class="iconbtn" id="addServiceIcon" title="Add new service" aria-label="Add new service">+</button>
            </div>
          </div>

          <div class="body">
            <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px">
              <input class="input" id="servicesListSearch" placeholder="Search services (name/type)." />
            </div>

            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Dropdown</th>
                  </tr>
                </thead>
                <tbody id="servicesTbody"></tbody>
              </table>
            </div>

            <div id="servicesListMsg" class="toast"></div>
          </div>
        </div>
      </div><!-- /panelServices -->

      <!-- =========================
           CARE TEAM PANEL
      ========================= -->
      <div class="panel" id="panelCareTeam">
        <div class="content">
          <div class="hd" style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px">
            <div>
              <h2 style="margin:0">Care Team</h2>
              <div class="hint">Reference list of providers/contacts used on admissions.</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="iconbtn" id="bulkCareTeamIcon" title="Bulk upload care team" aria-label="Bulk upload care team">⇪</button>
              <button class="iconbtn" id="addCareTeamIcon" title="Add new care team member" aria-label="Add new care team member">+</button>
            </div>
          </div>

          <div class="body">
            <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px">
              <input class="input" id="careTeamListSearch" placeholder="Search care team (name/type/npi)." />
            </div>

            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>NPI</th>
                    <th>Active</th>
                  </tr>
                </thead>
                <tbody id="careTeamTbody"></tbody>
              </table>
            </div>

            <div id="careTeamListMsg" class="toast"></div>
          </div>
        </div>
      </div><!-- /panelCareTeam -->

    </div><!-- /layout -->
  </div>
<!-- =========================
     USER MODAL
========================= -->
<div class="modal-backdrop" id="userModalBackdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="userModalTitle">
    <div class="modal-hd">
      <div>
        <h3 class="modal-title" id="userModalTitle">Edit User</h3>
        <div class="modal-sub">user_id: <b id="selId">—</b></div>
      </div>
      <button class="xbtn" id="closeUserModal" aria-label="Close">✕</button>
    </div>

    <div class="modal-body">
      <div class="label">Email/Username</div>
      <input class="input" id="email" placeholder="user@email.com" />

      <div style="height:10px"></div>

      <div class="label">Display Name</div>
      <input class="input" id="display_name" placeholder="Full name" />

      <div style="height:10px"></div>

      <div class="label">Active</div>
      <select class="select" id="is_active">
        <option value="1">Yes (Active)</option>
        <option value="0">No (Inactive)</option>
      </select>

      <div style="height:14px"></div>

      <div class="label">Roles</div>
      <div class="pill" id="roles"></div>

      <div style="height:14px"></div>

      <div class="label">Cell Phone</div>
      <input class="input" id="cell_phone" placeholder="(xxx) xxx-xxxx" />

      <div style="height:10px"></div>

      <div class="label">Password</div>
      <input class="input" id="password" type="password" placeholder="Leave blank to keep unchanged" />

      <div style="height:10px"></div>

      <div class="label">Account Locked</div>
      <select class="select" id="account_locked">
        <option value="0">No</option>
        <option value="1">Yes (Locked)</option>
      </select>

      <div style="height:14px"></div>

      <div class="label">Agencies (multi-select)</div>
      <div class="checkwrap">
        <input class="checksearch" id="agencySearch" placeholder="Search agencies." />
        <div class="checklist" id="agencyChecklist"></div>
      </div>

      <div style="height:14px"></div>

      <div class="stack">
        <button class="btn primary" id="saveUser">Save User</button>
      </div>

      <div id="editMsg" class="toast"></div>
    </div>
  </div>
</div>

<!-- =========================
     AGENCY MODAL
========================= -->
<div class="modal-backdrop" id="agencyModalBackdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="agencyModalTitle">
    <div class="modal-hd">
      <div>
        <h3 class="modal-title" id="agencyModalTitle">Edit Agency</h3>
        <div class="modal-sub">agency_id: <b id="selAgencyId">—</b></div>
      </div>
      <button class="xbtn" id="closeAgencyModal" aria-label="Close">✕</button>
    </div>

    <div class="modal-body">
      <div class="label">Agency Name</div>
      <input class="input" id="agency_name" placeholder="Agency name" />

      <div style="height:10px"></div>

      <div class="label">Agency Type</div>
      <select class="select" id="agency_type">
        <option value="Hospital">Hospital</option>
        <option value="SNF">SNF</option>
        <option value="Home Health">Home Health</option>
        <option value="IRF">IRF</option>
        <option value="LTACH">LTACH</option>
        <option value="Hospice">Hospice</option>
        <option value="Outpatient PT">Outpatient PT</option>
      </select>

      <div style="height:10px"></div>

      <div class="label">Facility Code</div>
      <input class="input" id="facility_code" placeholder="Optional code" />

      <div style="height:10px"></div>

      <div class="label">Address</div>
      <input class="input" id="address" placeholder="Street address" />

      <div style="height:10px"></div>

      <div class="label">City</div>
      <input class="input" id="city" placeholder="City" />

      <div style="height:10px"></div>

      <div class="label">State</div>
      <input class="input" id="state" placeholder="State" />

      <div style="height:10px"></div>

      <div class="label">Zip</div>
      <input class="input" id="zip" placeholder="Zip" />

      <div style="height:10px"></div>

      <div class="label">Phone 1</div>
      <input class="input" id="phone1" placeholder="Phone 1" />

      <div style="height:10px"></div>

      <div class="label">Phone 2</div>
      <input class="input" id="phone2" placeholder="Phone 2" />

      <div style="height:10px"></div>

      <div class="label">Email</div>
      <input class="input" id="email2" placeholder="Email" />

      <div style="height:10px"></div>

      <div class="label">Fax</div>
      <input class="input" id="fax" placeholder="Fax" />

      <div style="height:10px"></div>

      <div class="label">Notes</div>
      <input class="input" id="notes" placeholder="Notes" />

      <div style="height:10px"></div>

      <div class="label">Notes 2</div>
      <input class="input" id="notes2" placeholder="Notes 2" />

      <div style="height:10px"></div>

      <div class="label">Evolv Client</div>
      <select class="select" id="evolv_client">
        <option value="0">No</option>
        <option value="1">Yes</option>
      </select>

      <div style="height:14px"></div>

      <div class="stack">
        <button class="btn primary" id="saveAgency">Save Agency</button>
      </div>

      <div id="agencyEditMsg" class="toast"></div>
    </div>
  </div>
</div>
<!-- =========================
     PATIENT MODAL
========================= -->
<div class="modal-backdrop" id="patientModalBackdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="patientModalTitle">
    <div class="modal-hd">
      <div>
        <h3 class="modal-title" id="patientModalTitle">Edit Patient</h3>
        <div class="modal-sub">patient_id: <b id="selPatientId">—</b></div>
      </div>
      <button class="xbtn" id="closePatientModal" aria-label="Close">✕</button>
    </div>

    <div class="modal-body">
      <div class="label">First Name</div>
      <input class="input" id="p_first_name" />

      <div style="height:10px"></div>

      <div class="label">Last Name</div>
      <input class="input" id="p_last_name" />

      <div style="height:10px"></div>

      <div class="label">DOB</div>
      <input class="input" id="p_dob" placeholder="YYYY-MM-DD or MM/DD/YYYY" />

      <div style="height:10px"></div>

      <div class="label">Gender</div>
      <input class="input" id="p_gender" placeholder="M/F/Other" />

      <div style="height:10px"></div>

      <div class="label">Phone 1</div>
      <input class="input" id="p_phone1" />

      <div style="height:10px"></div>

      <div class="label">Email</div>
      <input class="input" id="p_email" />

      <div style="height:10px"></div>

      <div class="label">Active</div>
      <select class="select" id="p_active">
        <option value="1">Yes (Active)</option>
        <option value="0">No (Inactive)</option>
      </select>

      <div style="height:14px"></div>

      <div class="stack">
        <button class="btn primary" id="savePatient">Save Patient</button>
      </div>

      <div id="patientEditMsg" class="toast"></div>
    </div>
  </div>
</div>


<!-- =========================
     ADMISSION MODAL
========================= -->
<div class="modal-backdrop" id="admissionModalBackdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="admissionModalTitle">
    <div class="modal-hd">
      <div>
        <h3 class="modal-title" id="admissionModalTitle">Edit Admission</h3>
        <div class="modal-sub">admission_id: <b id="selAdmissionId">—</b></div>
      </div>
      <button class="xbtn" id="closeAdmissionModal" aria-label="Close">✕</button>
    </div>

    <div class="modal-body">
      <div class="label">Patient</div>
      <select class="select" id="a_patient_id"></select>

      <div style="height:10px"></div>

      <div class="label">Agency</div>
      <select class="select" id="a_agency_id"></select>

      <div style="height:10px"></div>

      <div class="label">Admit Date</div>
      <input class="input" id="a_admit_date" placeholder="YYYY-MM-DD" />

      <div style="height:10px"></div>

      <div class="label">DC Date</div>
      <input class="input" id="a_dc_date" placeholder="YYYY-MM-DD" />

      <div style="height:10px"></div>

      <div class="label">Room</div>
      <input class="input" id="a_room" />

      <div style="height:10px"></div>

      <div class="label">Reason</div>
      <input class="input" id="a_reason" />

      <div style="height:10px"></div>

      <div class="label">Active</div>
      <select class="select" id="a_active">
        <option value="1">Yes (Active)</option>
        <option value="0">No (Inactive)</option>
      </select>

      <div style="height:14px"></div>

      <div class="stack">
        <button class="btn primary" id="saveAdmission">Save Admission</button>
      </div>

      <div id="admissionEditMsg" class="toast"></div>
    </div>
  </div>
</div>

<!-- =========================
     BULK UPLOAD MODAL (Reusable)
========================= -->
<div class="modal-backdrop" id="bulkModalBackdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="bulkModalTitle">
    <div class="modal-hd">
      <div>
        <h3 class="modal-title" id="bulkModalTitle">Bulk Upload</h3>
        <div class="modal-sub" id="bulkModalSub">Download a template, then upload your CSV.</div>
      </div>
      <button class="xbtn" id="closeBulkModal" aria-label="Close">✕</button>
    </div>

    <div class="modal-body">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <button class="btn" id="downloadTemplateBtn">Download CSV Template</button>
        <div class="smallhint" id="bulkEntityHint"></div>
      </div>

      <div style="height:12px"></div>

      <div class="dropzone" id="dropzone">
        <div style="font-weight:900;color:var(--navy)">Drag &amp; drop CSV here</div>
        <div class="smallhint">Or click to select a file. Headers must match the template.</div>

        <input type="file" id="bulkFileInput" accept=".csv,text/csv" style="display:none" />
        <button class="btn primary" id="chooseFileBtn">Choose CSV File</button>

        <div class="smallhint" id="bulkFileName" style="margin-top:6px;"></div>
      </div>

      <!-- explicit submit BELOW the dotted dropzone -->
      <div style="height:10px"></div>
      <button class="btn primary" id="bulkSubmitBtn" disabled>Process CSV</button>

      <div style="height:12px"></div>

      <div id="bulkMsg" class="toast"></div>
    </div>
  </div>
</div>
<!-- ✅ Service modal -->
<div id="serviceModalBackdrop" class="modal-backdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="serviceModalTitle">
    <div class="modal-hd">
      <div>
        <h3 class="modal-title" id="serviceModalTitle">Edit Service</h3>
        <div class="modal-sub">service_id: <b id="selServiceId">—</b></div>
      </div>
      <button class="xbtn" id="closeServiceModal" aria-label="Close">✕</button>
    </div>

    <div class="modal-body">
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <input id="svc_id" type="hidden" />
        <div style="flex:1;min-width:240px;">
          <div class="label">Name</div>
          <input id="svc_name" class="input" placeholder="Service name" />
        </div>
        <div style="width:180px;">
          <div class="label">Type</div>
          <select id="svc_type" class="input">
            <option value="dme">DME</option>
            <option value="hh">HH</option>
          </select>
        </div>
        <div style="width:160px;">
          <div class="label">Show in dropdown</div>
          <select id="svc_dropdown" class="input">
            <option value="1">Yes</option>
            <option value="0">No</option>
          </select>
        </div>
      </div>

      <div id="svcMsg" class="toast"></div>

      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px;">
        <button id="saveServiceBtn" class="btn primary">Save Service</button>
      </div>
    </div>
  </div>
</div>

<!-- ✅ Care Team modal -->
<div id="careTeamModalBackdrop" class="modal-backdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="careTeamModalTitle">
    <div class="modal-hd">
      <div>
        <h3 class="modal-title" id="careTeamModalTitle">Edit Care Team</h3>
        <div class="modal-sub">care_team_id: <b id="selCareTeamId">—</b></div>
      </div>
      <button class="xbtn" id="closeCareTeamModal" aria-label="Close">✕</button>
    </div>

    <div class="modal-body">
      <input id="ct_id" type="hidden" />

      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <div style="flex:1;min-width:240px;">
          <div class="label">Name</div>
          <input id="ct_name" class="input" placeholder="Full name" />
        </div>
        <div style="width:220px;">
          <div class="label">Type</div>
          <input id="ct_type" class="input" placeholder="PT / OT / MD / SW..." />
        </div>
        <div style="width:180px;">
          <div class="label">NPI</div>
          <input id="ct_npi" class="input" placeholder="NPI" />
        </div>
        <div style="width:160px;">
          <div class="label">Active</div>
          <select id="ct_active" class="input">
            <option value="1">Yes</option>
            <option value="0">No</option>
          </select>
        </div>
      </div>

      <div id="ctMsg" class="toast"></div>

      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px;">
        <button id="saveCareTeamBtn" class="btn primary">Save Care Team</button>
      </div>
    </div>
  </div>
</div>

<script>
  const $ = (id) => document.getElementById(id);

  // ✅ Prevent browser from trying to open/save the file when dragged over the page
  document.addEventListener("dragover", (e) => e.preventDefault());
  document.addEventListener("drop", (e) => e.preventDefault());

  function openServiceModal(service){
    $("svc_id").value = service ? String(service.id || "") : "";
    $("selServiceId").textContent = service && service.id ? String(service.id) : "—";
    $("svc_name").value = service ? (service.name || "") : "";
    $("svc_type").value = service ? (service.service_type || "dme") : "dme";
    $("svc_dropdown").value = service ? String(service.dropdown ? 1 : 0) : "1";
    setMsg($("svcMsg"), "", true);
    $("serviceModalBackdrop").classList.add("on");
  }
  function closeServiceModal(){ $("serviceModalBackdrop").classList.remove("on"); }
  $("closeServiceModal").onclick = closeServiceModal;

  $("saveServiceBtn").onclick = async () => {
    try{
      const payload = {
        id: $("svc_id").value ? Number($("svc_id").value) : null,
        name: ($("svc_name").value || "").trim(),
        service_type: ($("svc_type").value || "").trim(),
        dropdown: Number($("svc_dropdown").value || 1)
      };
      await apiPost("/api/sensys/admin/services/upsert", payload);
      await refreshServicesList();
      setMsg($("servicesListMsg"), "Service saved.", true);
      closeServiceModal();
    }catch(e){
      setMsg($("svcMsg"), String(e.message || e), false);
    }
  };

  function openCareTeamModal(row){
    $("ct_id").value = row ? String(row.id || "") : "";
    $("selCareTeamId").textContent = row && row.id ? String(row.id) : "—";
    $("ct_name").value = row ? (row.name || "") : "";
    $("ct_type").value = row ? (row.type || "") : "";
    $("ct_npi").value = row ? (row.npi || "") : "";
    $("ct_active").value = row ? String(row.active ? 1 : 0) : "1";
    setMsg($("ctMsg"), "", true);
    $("careTeamModalBackdrop").classList.add("on");
  }
  function closeCareTeamModal(){ $("careTeamModalBackdrop").classList.remove("on"); }
  $("closeCareTeamModal").onclick = closeCareTeamModal;

  $("saveCareTeamBtn").onclick = async () => {
    try{
      const payload = {
        id: $("ct_id").value ? Number($("ct_id").value) : null,
        name: ($("ct_name").value || "").trim(),
        type: ($("ct_type").value || "").trim(),
        npi: ($("ct_npi").value || "").trim(),
        active: Number($("ct_active").value || 1)
      };
      await apiPost("/api/sensys/admin/care-team/upsert", payload);
      await refreshCareTeamList();
      closeCareTeamModal();
    }catch(e){
      setMsg($("ctMsg"), String(e.message || e), false);
    }
  };

  function openUserModal(){
    $("userModalBackdrop").classList.add("on");
  }
  function closeUserModal(){
    $("userModalBackdrop").classList.remove("on");
  }

  function openAgencyModal(){
    $("agencyModalBackdrop").classList.add("on");
  }
  function closeAgencyModal(){
    $("agencyModalBackdrop").classList.remove("on");
  }

  // Close when clicking the dark backdrop
  $("userModalBackdrop").addEventListener("click", (e) => {
    if(e.target.id === "userModalBackdrop") closeUserModal();
  });
  $("agencyModalBackdrop").addEventListener("click", (e) => {
    if(e.target.id === "agencyModalBackdrop") closeAgencyModal();
  });

  // ✅ ADD: close services + care team when clicking the dark backdrop
  $("serviceModalBackdrop").addEventListener("click", (e) => {
    if(e.target.id === "serviceModalBackdrop") closeServiceModal();
  });
  $("careTeamModalBackdrop").addEventListener("click", (e) => {
    if(e.target.id === "careTeamModalBackdrop") closeCareTeamModal();
  });

  // Close buttons
  $("closeUserModal").onclick = closeUserModal;
  $("closeAgencyModal").onclick = closeAgencyModal;

  // ESC key closes whichever modal is open
  document.addEventListener("keydown", (e) => {
    if(e.key !== "Escape") return;
    closeUserModal();
    closeAgencyModal();
    closePatientModal();
    closeAdmissionModal();
    closeServiceModal();
    closeCareTeamModal();
    closeBulkModal();
  });

  function getToken(){
    return ($("token").value || localStorage.getItem("SENSYS_ADMIN_TOKEN") || "").trim();
  }

  function getTokenOrThrow(){
    const t = getToken();
    if(!t) throw new Error("Missing ADMIN_TOKEN (paste it top-right, click Save)");
    return t;
  }
  
  function setMsg(el, text, ok=true){
    el.className = "toast " + (ok ? "ok" : "err");
    el.textContent = text || "";
  }

  let rolesMaster = [];
  let usersCache = [];
  let selectedUserId = null;
  let selectedRoleKeys = new Set();

  let agenciesMaster = [];
  let selectedAgencyIds = new Set();

  let agenciesCache = [];
  let selectedAgencyId = null;

  function renderAgencyChecklist(){
    const wrap = $("agencyChecklist");
    const q = ($("agencySearch").value || "").trim().toLowerCase();
    wrap.innerHTML = "";

    const items = (agenciesMaster || []).filter(a => {
      const hay = `${a.agency_name || ""} ${a.agency_type || ""} ${a.city || ""} ${a.state || ""}`.toLowerCase();
      return !q || hay.includes(q);
    });

    items.forEach(a => {
      const row = document.createElement("div");
      row.className = "checkrow";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = selectedAgencyIds.has(a.id);
      cb.onchange = () => {
        if(cb.checked) selectedAgencyIds.add(a.id);
        else selectedAgencyIds.delete(a.id);
      };

      const label = document.createElement("div");
      const locRaw =
        (a.city || a.state)
          ? (String(a.city || "") + (a.city && a.state ? ", " : "") + String(a.state || ""))
          : "";

      const evolvTag = a.evolv_client ? " (Evolv Client)" : "";
      const metaParts = [
        `${escapeHtml(a.agency_type || "")}${evolvTag}`,
        (locRaw ? escapeHtml(locRaw) : "")
      ].filter(Boolean);

      label.innerHTML = `
        <b>${escapeHtml(a.agency_name || "")}</b>
        <span class="agmeta"> — ${metaParts.join(" • ")}</span>
      `;

      row.appendChild(cb);
      row.appendChild(label);
      wrap.appendChild(row);
    });
  }

  function renderRolesPills(){
    const wrap = $("roles");
    wrap.innerHTML = "";
    rolesMaster.forEach(r => {
      const b = document.createElement("span");
      b.className = "tag " + (selectedRoleKeys.has(r.role_key) ? "on" : "");
      b.textContent = r.role_name;
      b.onclick = () => {
        if(selectedRoleKeys.has(r.role_key)) selectedRoleKeys.delete(r.role_key);
        else selectedRoleKeys.add(r.role_key);
        renderRolesPills();
      };
      wrap.appendChild(b);
    });
  }

  function selectUser(u){
    selectedUserId = u.user_id;
    $("selId").textContent = String(u.user_id);
    $("email").value = u.email || "";
    $("display_name").value = u.display_name || "";
    $("is_active").value = String(u.is_active ?? 1);

    selectedRoleKeys = new Set(u.role_keys || []);
    renderRolesPills();

    $("cell_phone").value = u.cell_phone || "";
    $("password").value = ""; // never auto-fill password
    $("account_locked").value = String(u.account_locked ? 1 : 0);

    selectedAgencyIds = new Set(u.agency_ids || []);
    renderAgencyChecklist();

    setMsg($("editMsg"), "", true);

    // NEW: open modal
    openUserModal();
  }

  function renderUsersTable(){
    const tbody = $("tbody");
    tbody.innerHTML = "";

    usersCache.forEach(u => {
      const tr = document.createElement("tr");
      tr.style.cursor = "pointer";
      tr.onclick = () => selectUser(u);

      const roles = (u.role_keys || []).join(", ");
      const ags = (u.agency_names || []).join(", ");

      tr.innerHTML = `
        <td><b>${escapeHtml(u.email || "")}</b></td>
        <td>${escapeHtml(u.display_name || "")}</td>
        <td>${u.is_active ? "Yes" : "No"}</td>
        <td>${escapeHtml(roles)}</td>
        <td>${escapeHtml(ags)}</td>
        <td>${u.account_locked ? "Yes" : "No"}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  async function apiGet(path){
    const token = getToken();
    if(!token) throw new Error("Missing ADMIN_TOKEN (paste it top-right, click Save)");
    const url = path.includes("?") ? `${path}&token=${encodeURIComponent(token)}` : `${path}?token=${encodeURIComponent(token)}`;
    const res = await fetch(url);
    if(!res.ok) throw new Error(await res.text());
    return await res.json();
  }

  async function apiPost(path, payload){
    const token = getToken();
    if(!token) throw new Error("Missing ADMIN_TOKEN (paste it top-right, click Save)");
    const url = path.includes("?") ? `${path}&token=${encodeURIComponent(token)}` : `${path}?token=${encodeURIComponent(token)}`;
    const res = await fetch(url, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload || {})
    });
    if(!res.ok) throw new Error(await res.text());
    return await res.json();
  }

  async function apiUploadCsv(path, file){
    const token = getTokenOrThrow();
    const url = path.includes("?")
      ? `${path}&token=${encodeURIComponent(token)}` : `${path}?token=${encodeURIComponent(token)}`;

    const fd = new FormData();
    fd.append("file", file);

    const res = await fetch(url, { method:"POST", body: fd });
    if(!res.ok) throw new Error(await res.text());
    return await res.json();
  }

  async function refreshAll(){
    setMsg($("listMsg"), "Loading…", true);
    try{
      const rolesResp = await apiGet("/api/sensys/admin/roles");
      rolesMaster = rolesResp.roles || [];
      renderRolesPills();

      const agResp = await apiGet("/api/sensys/admin/agencies");
      agenciesMaster = agResp.agencies || [];
      renderAgencyChecklist();

      const usersResp = await apiGet("/api/sensys/admin/users");
      usersCache = usersResp.users || [];
      renderUsersTable();

      setMsg($("listMsg"), `Loaded ${usersCache.length} users.`, true);

    }catch(e){
      setMsg($("listMsg"), String(e.message || e), false);
    }
  }

  function startNewUser(){
    selectedUserId = null;
    $("selId").textContent = "—";
    $("email").value = "";
    $("display_name").value = "";
    $("is_active").value = "1";

    selectedRoleKeys = new Set();
    renderRolesPills();

    selectedAgencyIds = new Set();
    renderAgencyChecklist();

    $("cell_phone").value = "";
    $("password").value = "";
    $("account_locked").value = "0";

    setMsg($("editMsg"), "New user mode (Save User to create).", true);

    openUserModal();
  }

  // NEW: top-right icon
  $("addUserIcon").onclick = startNewUser;

  $("bulkUsersIcon").onclick = () => openBulkModal("users");
  $("bulkAgenciesIcon").onclick = () => openBulkModal("agencies");
  $("bulkPatientsIcon").onclick = () => openBulkModal("patients");
  $("bulkAdmissionsIcon").onclick = () => openBulkModal("admissions");
  $("bulkServicesIcon").onclick = () => openBulkModal("services");
  $("bulkCareTeamIcon").onclick = () => openBulkModal("care-team");
  $("addServiceIcon").onclick = () => openServiceModal(null);
  $("addCareTeamIcon").onclick = () => openCareTeamModal(null);

  $("saveUser").onclick = async () => {
    try{
      const payload = {
        user_id: selectedUserId,
        email: ($("email").value || "").trim(),
        display_name: ($("display_name").value || "").trim(),
        is_active: parseInt($("is_active").value, 10),

        cell_phone: ($("cell_phone").value || "").trim(),
        password: ($("password").value || "").trim(), // blank = keep unchanged (backend handles)
        account_locked: $("account_locked").value === "1"
      };

      // 1) Save core user (backend will return user_id)
      const upsertResp = await apiPost("/api/sensys/admin/users/upsert", payload);
      selectedUserId = upsertResp.user_id;              // important for "new user" flow
      $("selId").textContent = String(selectedUserId);  // update modal header id

      // 2) Save roles
      await apiPost("/api/sensys/admin/users/set-roles", {
        user_id: selectedUserId,
        role_keys: Array.from(selectedRoleKeys)
      });

      // 3) Save agencies
      await apiPost("/api/sensys/admin/users/set-agencies", {
        user_id: selectedUserId,
        agency_ids: Array.from(selectedAgencyIds)
      });

      setMsg($("editMsg"), "User + roles + agencies saved.", true);
      await refreshAll();
    }catch(e){
      setMsg($("editMsg"), String(e.message || e), false);
    }
  };

  // load saved token on open
  $("token").value = localStorage.getItem("SENSYS_ADMIN_TOKEN") || "";

  $("agencySearch").addEventListener("input", renderAgencyChecklist);

  function showPanel(which){
    const panels = ["users","agencies","patients","admissions","services","careTeam"];

    // nav highlighting
    $("tabUsers").className = "navitem " + (which==="users" ? "on" : "");
    $("tabAgencies").className = "navitem " + (which==="agencies" ? "on" : "");
    $("tabPatients").className = "navitem " + (which==="patients" ? "on" : "");
    $("tabAdmissions").className = "navitem " + (which==="admissions" ? "on" : "");
    $("tabServices").className = "navitem " + (which==="services" ? "on" : "");
    $("tabCareTeam").className = "navitem " + (which==="careTeam" ? "on" : "");

    // hide all
    $("panelUsers").classList.remove("on");
    $("panelAgencies").classList.remove("on");
    $("panelPatients").classList.remove("on");
    $("panelAdmissions").classList.remove("on");
    $("panelServices").classList.remove("on");
    $("panelCareTeam").classList.remove("on");

    if(which==="users"){
      $("panelUsers").classList.add("on");
    }else if(which==="agencies"){
      $("panelAgencies").classList.add("on");
      refreshAgenciesList();
    }else if(which==="patients"){
      $("panelPatients").classList.add("on");
      refreshPatientsList();
    }else if(which==="admissions"){
      $("panelAdmissions").classList.add("on");
      refreshAdmissionsList();
    }else if(which==="services"){
      $("panelServices").classList.add("on");
      refreshServicesList();
    }else{
      $("panelCareTeam").classList.add("on");
      refreshCareTeamList();
    }

    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  $("tabUsers").onclick = () => showPanel("users");
  $("tabAgencies").onclick = () => showPanel("agencies");
  $("tabPatients").onclick = () => showPanel("patients");
  $("tabAdmissions").onclick = () => showPanel("admissions");
  $("tabServices").onclick = () => showPanel("services");
  $("tabCareTeam").onclick = () => showPanel("careTeam");


  // --- Agencies page logic ---
  function renderAgenciesTable(){
    const tbody = $("agencyTbody");
    tbody.innerHTML = "";

    const q = ($("agencyListSearch").value || "").trim().toLowerCase();
    const items = (agenciesCache || []).filter(a => {
      const hay = `${a.agency_name||""} ${a.agency_type||""}`.toLowerCase();
      return !q || hay.includes(q);
    });

    items.forEach(a => {
      const tr = document.createElement("tr");
      tr.style.cursor = "pointer";
      tr.onclick = () => selectAgency(a);
      tr.innerHTML = `
        <td><b>${escapeHtml(a.agency_name||"")}</b></td>
        <td>${escapeHtml(a.agency_type||"")}</td>
        <td>${a.evolv_client ? "Yes" : "No"}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function selectAgency(a){
    selectedAgencyId = a.id;
    $("selAgencyId").textContent = String(a.id);

    $("agency_name").value = a.agency_name || "";
    $("agency_type").value = a.agency_type || "Hospital";
    $("facility_code").value = a.facility_code || "";
    $("address").value = a.address || "";
    $("city").value = a.city || "";
    $("state").value = a.state || "";
    $("zip").value = a.zip || "";
    $("phone1").value = a.phone1 || "";
    $("phone2").value = a.phone2 || "";
    $("email2").value = a.email || "";
    $("fax").value = a.fax || "";
    $("notes").value = a.notes || "";
    $("notes2").value = a.notes2 || "";
    $("evolv_client").value = String(a.evolv_client ? 1 : 0);

    setMsg($("agencyEditMsg"), "", true);

    // NEW: open modal
    openAgencyModal();
  }

  async function refreshAgenciesList(){
    setMsg($("agencyListMsg"), "Loading…", true);
    try{
      const agResp = await apiGet("/api/sensys/admin/agencies");
      agenciesCache = agResp.agencies || [];
      agenciesMaster = agenciesCache;       // keep master in sync for user checklist
      renderAgenciesTable();
      renderAgencyChecklist();

      setMsg($("agencyListMsg"), `Loaded ${agenciesCache.length} agencies.`, true);
      // Do NOT auto-open the first agency. Wait for row click or "Add new" button.

    }catch(e){
      setMsg($("agencyListMsg"), String(e.message || e), false);
    }
  }

  $("agencyListSearch").addEventListener("input", renderAgenciesTable);

  function startNewAgency(){
    selectedAgencyId = null;
    $("selAgencyId").textContent = "—";
    $("agency_name").value = "";
    $("agency_type").value = "Hospital";
    $("facility_code").value = "";
    $("address").value = "";
    $("city").value = "";
    $("state").value = "";
    $("zip").value = "";
    $("phone1").value = "";
    $("phone2").value = "";
    $("email2").value = "";
    $("fax").value = "";
    $("notes").value = "";
    $("notes2").value = "";
    $("evolv_client").value = "0";

    setMsg($("agencyEditMsg"), "New agency mode (Save Agency to create).", true);

    openAgencyModal();
  }

  // NEW: top-right icon
  $("addAgencyIcon").onclick = startNewAgency;


  $("saveAgency").onclick = async () => {
    try{
      const payload = {
        id: selectedAgencyId,
        agency_name: ($("agency_name").value || "").trim(),
        agency_type: ($("agency_type").value || "").trim(),
        facility_code: ($("facility_code").value || "").trim(),
        address: ($("address").value || "").trim(),
        city: ($("city").value || "").trim(),
        state: ($("state").value || "").trim(),
        zip: ($("zip").value || "").trim(),
        phone1: ($("phone1").value || "").trim(),
        phone2: ($("phone2").value || "").trim(),
        email: ($("email2").value || "").trim(),
        fax: ($("fax").value || "").trim(),
        notes: ($("notes").value || "").trim(),
        notes2: ($("notes2").value || "").trim(),
        evolv_client: $("evolv_client").value === "1"
      };

      await apiPost("/api/sensys/admin/agencies/upsert", payload);
      setMsg($("agencyEditMsg"), "Agency saved.", true);
      await refreshAgenciesList();
    }catch(e){
      setMsg($("agencyEditMsg"), String(e.message || e), false);
    }
  };

  // Default panel: Users (no .panel needed). Agencies panel stays hidden until clicked.

  // initial load
  
  function openPatientModal(){ $("patientModalBackdrop").classList.add("on"); }
  function closePatientModal(){ $("patientModalBackdrop").classList.remove("on"); }

  function openAdmissionModal(){ $("admissionModalBackdrop").classList.add("on"); }
  function closeAdmissionModal(){ $("admissionModalBackdrop").classList.remove("on"); }

  $("patientModalBackdrop").addEventListener("click", (e) => {
    if(e.target.id === "patientModalBackdrop") closePatientModal();
  });
  $("admissionModalBackdrop").addEventListener("click", (e) => {
    if(e.target.id === "admissionModalBackdrop") closeAdmissionModal();
  });

  $("closePatientModal").onclick = closePatientModal;
  $("closeAdmissionModal").onclick = closeAdmissionModal;

  let patientsCache = [];
  let selectedPatientId = null;

  let admissionsCache = [];
  let selectedAdmissionId = null;

  function renderPatientsTable(){
    const tbody = $("patientTbody");
    tbody.innerHTML = "";

    const q = ($("patientListSearch").value || "").trim().toLowerCase();
    const items = (patientsCache || []).filter(p => {
      const hay = `${p.last_name||""} ${p.first_name||""} ${p.dob||""} ${p.phone1||""} ${p.email||""}`.toLowerCase();
      return !q || hay.includes(q);
    });

    items.forEach(p => {
      const tr = document.createElement("tr");
      tr.style.cursor = "pointer";
      tr.onclick = () => selectPatient(p);
      tr.innerHTML = `
        <td><b>${escapeHtml((p.last_name||"") + ", " + (p.first_name||""))}</b></td>
        <td>${escapeHtml(p.dob||"")}</td>
        <td>${escapeHtml(p.phone1||"")}</td>
        <td>${p.active ? "Yes" : "No"}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function selectPatient(p){
    selectedPatientId = p.id;
    $("selPatientId").textContent = String(p.id);

    $("p_first_name").value = p.first_name || "";
    $("p_last_name").value = p.last_name || "";
    $("p_dob").value = p.dob || "";
    $("p_gender").value = p.gender || "";
    $("p_phone1").value = p.phone1 || "";
    $("p_email").value = p.email || "";
    $("p_active").value = String(p.active ? 1 : 0);

    setMsg($("patientEditMsg"), "", true);
    openPatientModal();
  }

  async function refreshPatientsList(){
    setMsg($("patientListMsg"), "Loading…", true);
    try{
      const resp = await apiGet("/api/sensys/admin/patients");
      patientsCache = resp.patients || [];
      renderPatientsTable();
      setMsg($("patientListMsg"), `Loaded ${patientsCache.length} patients.`, true);
    }catch(e){
      setMsg($("patientListMsg"), String(e.message || e), false);
    }
  }

  $("patientListSearch").addEventListener("input", renderPatientsTable);

  function startNewPatient(){
    selectedPatientId = null;
    $("selPatientId").textContent = "—";
    $("p_first_name").value = "";
    $("p_last_name").value = "";
    $("p_dob").value = "";
    $("p_gender").value = "";
    $("p_phone1").value = "";
    $("p_email").value = "";
    $("p_active").value = "1";
    setMsg($("patientEditMsg"), "New patient mode (Save Patient to create).", true);
    openPatientModal();
  }

  $("addPatientIcon").onclick = startNewPatient;

  $("savePatient").onclick = async () => {
    try{
      const payload = {
        id: selectedPatientId,
        first_name: ($("p_first_name").value || "").trim(),
        last_name: ($("p_last_name").value || "").trim(),
        dob: ($("p_dob").value || "").trim(),
        gender: ($("p_gender").value || "").trim(),
        phone1: ($("p_phone1").value || "").trim(),
        email: ($("p_email").value || "").trim(),
        active: parseInt($("p_active").value, 10)
      };
      await apiPost("/api/sensys/admin/patients/upsert", payload);
      setMsg($("patientEditMsg"), "Patient saved.", true);
      await refreshPatientsList();
    }catch(e){
      setMsg($("patientEditMsg"), String(e.message || e), false);
    }
  };


  function _fillSelect(el, options, valueKey, labelFn, selectedVal){
    el.innerHTML = "";
    options.forEach(o => {
      const opt = document.createElement("option");
      opt.value = String(o[valueKey]);
      opt.textContent = labelFn(o);
      if(selectedVal != null && String(selectedVal) === String(o[valueKey])) opt.selected = true;
      el.appendChild(opt);
    });
  }

  function renderAdmissionsTable(){
    const tbody = $("admissionTbody");
    tbody.innerHTML = "";

    const q = ($("admissionListSearch").value || "").trim().toLowerCase();
    const items = (admissionsCache || []).filter(a => {
      const hay = `${a.patient_name||""} ${a.agency_name||""} ${a.admit_date||""} ${a.dc_date||""}`.toLowerCase();
      return !q || hay.includes(q);
    });

    items.forEach(a => {
      const tr = document.createElement("tr");
      tr.style.cursor = "pointer";
      tr.onclick = () => selectAdmission(a);
      tr.innerHTML = `
        <td><b>${escapeHtml(a.patient_name||"")}</b></td>
        <td>${escapeHtml(a.agency_name||"")}</td>
        <td>${escapeHtml(a.admit_date||"")}</td>
        <td>${escapeHtml(a.dc_date||"")}</td>
        <td>${a.active ? "Yes" : "No"}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function refreshAdmissionsList(){
    setMsg($("admissionListMsg"), "Loading…", true);
    try{
      // ensure dropdown sources exist
      if(!patientsCache.length){
        const p = await apiGet("/api/sensys/admin/patients");
        patientsCache = p.patients || [];
      }
      if(!agenciesMaster.length){
        const ag = await apiGet("/api/sensys/admin/agencies");
        agenciesMaster = ag.agencies || [];
      }

      const resp = await apiGet("/api/sensys/admin/admissions");
      admissionsCache = resp.admissions || [];
      renderAdmissionsTable();

      setMsg($("admissionListMsg"), `Loaded ${admissionsCache.length} admissions.`, true);
    }catch(e){
      setMsg($("admissionListMsg"), String(e.message || e), false);
    }
  }

  $("admissionListSearch").addEventListener("input", renderAdmissionsTable);

  function selectAdmission(a){
    selectedAdmissionId = a.id;
    $("selAdmissionId").textContent = String(a.id);

    // dropdowns
    _fillSelect(
      $("a_patient_id"),
      patientsCache,
      "id",
      (p) => `${(p.last_name||"")}, ${(p.first_name||"")} (${p.dob||""})`,
      a.patient_id
    );

    _fillSelect(
      $("a_agency_id"),
      agenciesMaster,
      "id",
      (x) => `${x.agency_name||""} — ${x.agency_type||""}`,
      a.agency_id
    );

    $("a_admit_date").value = a.admit_date || "";
    $("a_dc_date").value = a.dc_date || "";
    $("a_room").value = a.room || "";
    $("a_reason").value = a.reason || "";
    $("a_active").value = String(a.active ? 1 : 0);

    setMsg($("admissionEditMsg"), "", true);
    openAdmissionModal();
  }

  function startNewAdmission(){
    selectedAdmissionId = null;
    $("selAdmissionId").textContent = "—";

    _fillSelect(
      $("a_patient_id"),
      patientsCache,
      "id",
      (p) => `${(p.last_name||"")}, ${(p.first_name||"")} (${p.dob||""})`,
      null
    );

    _fillSelect(
      $("a_agency_id"),
      agenciesMaster,
      "id",
      (x) => `${x.agency_name||""} — ${x.agency_type||""}`,
      null
    );

    $("a_admit_date").value = "";
    $("a_dc_date").value = "";
    $("a_room").value = "";
    $("a_reason").value = "";
    $("a_active").value = "1";

    setMsg($("admissionEditMsg"), "New admission mode (Save Admission to create).", true);
    openAdmissionModal();
  }

  let bulkEntity = "users";

  const bulkConfig = {
    users: {
      label: "Users",
      endpoint: "/api/sensys/admin/users/bulk",
      filename: "sensys_users_template.csv",
      headers: ["user_id","email","display_name","is_active","password","cell_phone","account_locked","role_keys","agency_ids"]
    },
    agencies: {
      label: "Agencies",
      endpoint: "/api/sensys/admin/agencies/bulk",
      filename: "sensys_agencies_template.csv",
      headers: ["id","agency_name","agency_type","facility_code","address","city","state","zip","phone1","phone2","email","fax","notes","notes2","evolv_client"]
    },
    patients: {
      label: "Patients",
      endpoint: "/api/sensys/admin/patients/bulk",
      filename: "sensys_patients_template.csv",
      headers: ["id","first_name","last_name","dob","gender","phone1","phone2","email","email2","address1","address2","city","state","zip","insurance_name1","insurance_number1","insurance_name2","insurance_number2","active","notes1","notes2","source","external_patient_id","mrn"]
    },

    admissions: {
      label: "Admissions",
      endpoint: "/api/sensys/admin/admissions/bulk",
      filename: "sensys_admissions_template.csv",
      headers: [
        "id",

        // allow either patient_id OR patient demographics for auto-match/create
        "patient_id",
        "patient_first_name",
        "patient_last_name",
        "patient_dob",
        "patient_mrn",
        "patient_external_patient_id",

        "agency_id",
        "admit_date","dc_date","room","referring_agency","reason","latest_pcp",
        "notes1","notes2","active","next_location","next_agency_id"
      ]
    },

    // ✅ ADD
    services: {
      label: "Services",
      endpoint: "/api/sensys/admin/services/bulk",
      filename: "sensys_services_template.csv",
      headers: ["id","name","service_type","dropdown"]
    },

    // ✅ ADD  (NOTE: this matches your icon call openBulkModal("care-team")【turn13:0†Sensys 3.0 - Admin - DEV.html†L75-L76】)
    "care-team": {
      label: "Care Team",
      endpoint: "/api/sensys/admin/care-team/bulk",
      filename: "sensys_care_team_template.csv",
      headers: ["id","name","type","npi","active","phone1","phone2","email1","email2"]
    }
  };

  // -----------------------------
  // Services page logic
  // -----------------------------
  let servicesCache = [];

  function renderServicesTable(){
    const tbody = $("servicesTbody");
    tbody.innerHTML = "";

    const q = ($("servicesListSearch").value || "").trim().toLowerCase();
    const items = (servicesCache || []).filter(s => {
      const hay = `${s.name||""} ${s.service_type||""}`.toLowerCase();
      return !q || hay.includes(q);
    });

    items.forEach(s => {
      const tr = document.createElement("tr");
      tr.style.cursor = "pointer";
      tr.onclick = () => openServiceModal(s);

      tr.innerHTML = `
        <td><b>${escapeHtml(s.name||"")}</b></td>
        <td>${escapeHtml((s.service_type||"").toUpperCase())}</td>
        <td>${(String(s.dropdown||0)==="1") ? "Yes" : "No"}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function refreshServicesList(){
    setMsg($("servicesListMsg"), "Loading…", true);
    try{
      const resp = await apiGet("/api/sensys/admin/services");
      servicesCache = resp.services || [];
      renderServicesTable();
      setMsg($("servicesListMsg"), `Loaded ${servicesCache.length} services.`, true);
    }catch(e){
      setMsg($("servicesListMsg"), String(e.message || e), false);
    }
  }

  $("servicesListSearch").addEventListener("input", renderServicesTable);

  // -----------------------------
  // Care Team page logic
  // -----------------------------
  let careTeamCache = [];

  function renderCareTeamTable(){
    const tbody = $("careTeamTbody");
    tbody.innerHTML = "";

    const q = ($("careTeamListSearch").value || "").trim().toLowerCase();
    const items = (careTeamCache || []).filter(c => {
      const hay = `${c.name||""} ${c.type||""} ${c.npi||""}`.toLowerCase();
      return !q || hay.includes(q);
    });

    items.forEach(c => {
      const tr = document.createElement("tr");
      tr.style.cursor = "pointer";
      tr.onclick = () => openCareTeamModal(c);

      tr.innerHTML = `
        <td><b>${escapeHtml(c.name||"")}</b></td>
        <td>${escapeHtml(c.type||"")}</td>
        <td>${escapeHtml(c.npi||"")}</td>
        <td>${c.active ? "Yes" : "No"}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function refreshCareTeamList(){
    setMsg($("careTeamListMsg"), "Loading…", true);
    try{
      const resp = await apiGet("/api/sensys/admin/care-team");
      careTeamCache = resp.care_team || [];
      renderCareTeamTable();
      setMsg($("careTeamListMsg"), `Loaded ${careTeamCache.length} care team records.`, true);
    }catch(e){
      setMsg($("careTeamListMsg"), String(e.message || e), false);
    }
  }

  $("careTeamListSearch").addEventListener("input", renderCareTeamTable);

  function openBulkModal(entityKey){
    bulkEntity = entityKey;
    const cfg = bulkConfig[bulkEntity];

    $("bulkModalTitle").textContent = `Bulk Upload — ${cfg.label}`;
    $("bulkEntityHint").textContent = `Uploads to: ${cfg.endpoint}`;
    setMsg($("bulkMsg"), "", true);

    resetBulkSelection(); // NEW: clear previous file + re-enable same-file upload

    $("bulkModalBackdrop").classList.add("on");
  }

  function closeBulkModal(){
    $("bulkModalBackdrop").classList.remove("on");
  }

  $("bulkModalBackdrop").addEventListener("click", (e) => {
    if(e.target.id === "bulkModalBackdrop") closeBulkModal();
  });
  $("closeBulkModal").onclick = closeBulkModal;

  function downloadCsvTemplate(){
    const cfg = bulkConfig[bulkEntity];
    const headerLine = cfg.headers.join(",") + "\n";
    const blob = new Blob([headerLine], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = cfg.filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  $("downloadTemplateBtn").onclick = downloadCsvTemplate;

  // Prevent dropzone click from hijacking button clicks
  $("chooseFileBtn").addEventListener("click", (e) => {
    e.preventDefault();
    e.stopPropagation();
    $("bulkFileInput").click();
  });

  // Only open file picker if the user clicks the dropzone itself (not the buttons)
  $("dropzone").addEventListener("click", (e) => {
    const t = e.target;
    if (t && (t.id === "chooseFileBtn" || t.id === "bulkSubmitBtn")) return;
    $("bulkFileInput").click();
  });

  // Also ensure the submit button never bubbles up into the dropzone click
  $("bulkSubmitBtn").addEventListener("click", (e) => {
    e.stopPropagation();
  });

  // NEW: keep state so user can explicitly submit
  let bulkSelectedFile = null;

  function resetBulkSelection(){
    bulkSelectedFile = null;
    $("bulkFileInput").value = "";                 // allows re-selecting the same file
    $("bulkFileName").textContent = "";
    $("bulkSubmitBtn").disabled = true;
  }

  function setBulkSelectedFile(file){
    bulkSelectedFile = file;
    $("bulkFileName").textContent = file ? `Selected: ${file.name}` : "";
    $("bulkSubmitBtn").disabled = !file;
  }

  // ✅ Only ONE change handler (pick file does NOT upload immediately)
  $("bulkFileInput").addEventListener("change", (e) => {
    const f = e.target.files && e.target.files[0];
    if(f) handleBulkFilePicked(f);
  });

  // ✅ Drag & drop UX
  $("dropzone").addEventListener("dragover", (e) => {
    e.preventDefault();
    $("dropzone").classList.add("on");
  });

  $("dropzone").addEventListener("dragleave", () => {
    $("dropzone").classList.remove("on");
  });

  $("dropzone").addEventListener("drop", (e) => {
    e.preventDefault();
    $("dropzone").classList.remove("on");
    const f = e.dataTransfer.files && e.dataTransfer.files[0];
    if(f) handleBulkFilePicked(f);
  });

  // picking a file no longer uploads immediately
  function handleBulkFilePicked(file){
    try{
      if(!String(file.name || "").toLowerCase().endsWith(".csv")){
        throw new Error("Please upload a .csv file.");
      }
      setBulkSelectedFile(file);
      setMsg($("bulkMsg"), "Ready to upload. Click “Upload CSV”.", true);
    }catch(err){
      setBulkSelectedFile(null);
      setMsg($("bulkMsg"), String(err.message || err), false);
    }
  }

  // explicit submit button
  $("bulkSubmitBtn").onclick = async () => {
    try{
      if(!bulkSelectedFile) throw new Error("Please choose a CSV file first.");

      setMsg($("bulkMsg"), `Uploading ${bulkSelectedFile.name}…`, true);

      const cfg = bulkConfig[bulkEntity];
      const resp = await apiUploadCsv(cfg.endpoint, bulkSelectedFile);

      const msg = `Done. Inserted: ${resp.inserted || 0}, Updated: ${resp.updated || 0}, Errors: ${resp.error_count || 0}`;
      setMsg($("bulkMsg"), msg, true);

      // Refresh the right list after upload
      if(bulkEntity === "users"){
        await refreshAll();
      }else if(bulkEntity === "agencies"){
        await refreshAgenciesList();
      }else if(bulkEntity === "patients"){
        await refreshPatientsList();
      }else if(bulkEntity === "admissions"){
        await refreshAdmissionsList();
      }else if(bulkEntity === "services"){
        await refreshServicesList();
      }else if(bulkEntity === "care-team"){
        await refreshCareTeamList();
      }

      resetBulkSelection();
    }catch(err){
      setMsg($("bulkMsg"), String(err.message || err), false);
    }
  };

  $("addAdmissionIcon").onclick = async () => {
    if(!patientsCache.length) await refreshPatientsList();
    if(!agenciesMaster.length){
      const ag = await apiGet("/api/sensys/admin/agencies");
      agenciesMaster = ag.agencies || [];
    }
    startNewAdmission();
  };

  $("saveAdmission").onclick = async () => {
    try{
      const payload = {
        id: selectedAdmissionId,
        patient_id: parseInt($("a_patient_id").value, 10),
        agency_id: parseInt($("a_agency_id").value, 10),
        admit_date: ($("a_admit_date").value || "").trim(),
        dc_date: ($("a_dc_date").value || "").trim(),
        room: ($("a_room").value || "").trim(),
        reason: ($("a_reason").value || "").trim(),
        active: parseInt($("a_active").value, 10)
      };

      await apiPost("/api/sensys/admin/admissions/upsert", payload);
      setMsg($("admissionEditMsg"), "Admission saved.", true);
      await refreshAdmissionsList();
    }catch(e){
      setMsg($("admissionEditMsg"), String(e.message || e), false);
    }
  };
  
  refreshAll();
</script>
</body>
</html>
