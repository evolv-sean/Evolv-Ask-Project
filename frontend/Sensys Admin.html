<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sensys 3.0 — Admin</title>
  <style>
    :root{
      --navy:#0d3b66;
      --mint:#a8e6cf;
      --sky:#4da8da;
      --ink:#0f172a;
      --muted:#64748b;
      --line:rgba(13,59,102,.14);
      --bg:#f6f8fb;
      --card:#ffffff;
      --shadow: 0 10px 24px rgba(13,59,102,.08);
      --r16:16px;
      --r12:12px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--ink);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .topbar{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r16);
      padding:14px 14px;
      box-shadow: 0 1px 0 rgba(15,23,42,.03);
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .brand{
      display:flex;flex-direction:column;gap:2px;
    }
    .brand .kicker{
      font-size:10px;letter-spacing:.16em;text-transform:uppercase;color:var(--muted);
    }
    .brand .title{
      font-size:18px;font-weight:800;color:var(--navy);
    }
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .field{
      display:flex;align-items:center;gap:8px;
      background:#fff;border:1px solid var(--line);
      border-radius:999px;padding:8px 10px;
    }
    .field label{font-size:12px;color:var(--muted)}
    .field input{
      border:none;outline:none;font-size:12px;min-width:240px;
    }
    .btn{
      border:1px solid rgba(13,59,102,.18);
      background:#fff;
      border-radius:999px;
      padding:10px 12px;
      font-weight:800;
      font-size:12px;
      cursor:pointer;
      transition: box-shadow .15s ease, border-color .15s ease, background .15s ease;
    }
    .btn:hover{border-color: rgba(168,230,207,.9); box-shadow: 0 0 0 3px rgba(168,230,207,.35);}
    .btn.primary{
      background: rgba(168,230,207,.22);
      border-color: rgba(168,230,207,.95);
      color: var(--navy);
    }
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .field input{min-width:180px}
    }

    /* --- Client Surveys split layout --- */
    .survey-grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 980px){
      .survey-grid{grid-template-columns:1fr}
    }
    .survey-row-top,
    .survey-row-bottom{cursor:pointer}
    .survey-row-top td{border-bottom:none;padding-bottom:6px}
    .survey-row-bottom td{padding-top:0}
    .survey-row-top.on td,
    .survey-row-bottom.on td{background: rgba(168,230,207,.12)}
    .survey-main-name{
      font-weight:900;
      color: var(--navy);
    }
    .survey-subline{
      font-size:11px;
      color: var(--muted);
    }
    .survey-meta{
      font-size:11px;
      color: var(--muted);
      text-align:right;
      white-space:nowrap;
    }
    .survey-ai{
      font-size:12px;
      color:#0f172a;
      line-height:1.35;
    }
    .survey-card{
      height: calc(100vh - 220px);
      display:flex;
      flex-direction:column;
    }
    .survey-card .body{
      overflow:auto;
      flex:1;
      min-height:0;
    }
    .survey-card .table-wrap{
      flex:1;
      overflow:auto;
    }
    .survey-textarea{
      width:100%;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r16);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 14px;
      border-bottom:1px solid rgba(15,23,42,.06);
      display:flex;align-items:flex-end;justify-content:space-between;gap:10px;
    }
    .card .hd h2{margin:0;font-size:14px;color:var(--navy)}
    .hint{font-size:12px;color:var(--muted)}
    .card .body{padding:12px 14px}
    .table-wrap{border-radius:16px;border:1px solid rgba(13,59,102,.14);overflow:hidden;background:#fff;}
    table{width:100%;border-collapse:collapse;font-size:12px}
    thead{background: rgba(13,59,102,.05);}
    th,td{padding:10px 12px;text-align:left;vertical-align:middle}
    th{
      font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.09em;color:#475569;
      border-bottom:1px solid rgba(15,23,42,.08);
      white-space:nowrap;
    }
    tbody tr:nth-child(even){background:#f9fafb}
    tbody tr:hover{background:#eef2ff}
    td{border-bottom:1px solid rgba(15,23,42,.06)}
    tbody tr:last-child td{border-bottom:none}
    .pill{
      display:inline-flex;align-items:center;gap:8px;flex-wrap:wrap;
    }
    .tag{
      display:inline-flex;align-items:center;justify-content:center;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(13,59,102,.18);
      background:#fff;color:#334155;
      font-weight:800;font-size:11px;line-height:1;
      cursor:pointer;
      transition: border-color .15s ease, box-shadow .15s ease, background .15s ease, color .15s ease;
      user-select:none;
    }
    .tag:hover{border-color: rgba(168,230,207,.9); box-shadow: 0 0 0 3px rgba(168,230,207,.35);}
    .tag.on{
      border-color: rgba(168,230,207,.95);
      box-shadow: 0 10px 24px rgba(168,230,207,.18), 0 0 0 3px rgba(168,230,207,.45);
      background: rgba(168,230,207,.18);
      color: var(--navy);
    }
    .stack{display:flex;gap:10px;flex-wrap:wrap}
    .input, .select{
      width:100%;
      border:1px solid rgba(13,59,102,.18);
      border-radius:12px;
      padding:10px 10px;
      font-size:12px;
      outline:none;
      background:#fff;
    }
    .label{font-size:11px;color:var(--muted);margin-bottom:6px}
    .toast{
      margin-top:10px;
      font-size:12px;
      color:#0f172a;
    }
    .toast.ok{color:#065f46}
    .toast.err{color:#991b1b}
    .mini{
      font-size:11px;color:var(--muted);
    }
    
   /* --- NEW: left sidebar layout --- */
   .layout{
     display:grid;
     grid-template-columns: 220px 1fr;
     gap:14px;
     margin-top:14px;
   }
   .sidebar{
     background:var(--card);
     border:1px solid var(--line);
     border-radius:var(--r16);
     box-shadow: 0 1px 0 rgba(15,23,42,.03);
     padding:12px;
     height: calc(100vh - 120px);
     position: sticky;
     top: 18px;
     display:flex;
     flex-direction:column;
     gap:10px;
   }
   .navitem{
     display:flex;
     align-items:center;
     justify-content:space-between;
     gap:10px;
     padding:10px 12px;
     border-radius:12px;
     border:1px solid rgba(13,59,102,.14);
     cursor:pointer;
     font-weight:900;
     color: var(--navy);
     background:#fff;
   }
   .navitem.on{
     background: rgba(168,230,207,.18);
     border-color: rgba(168,230,207,.95);
     box-shadow: 0 0 0 3px rgba(168,230,207,.35);
   }
   .content{min-width:0}
   .panel{display:none}
   .panel.on{display:block}

   /* --- NEW: agency multi-select checklist --- */
   .checkwrap{
     border:1px solid rgba(13,59,102,.18);
     border-radius:12px;
     background:#fff;
     padding:10px;
   }
   .checksearch{
     width:100%;
     border:1px solid rgba(13,59,102,.18);
     border-radius:12px;
     padding:10px;
     font-size:12px;
     outline:none;
     margin-bottom:10px;
   }
   /* Agencies list inside Edit User modal */
   .checklist{
     max-height: 38vh;     /* gives it its own scroll area inside modal */
     overflow: auto;
     padding-right: 6px;
   }

   .checkrow{
     display:flex;
     align-items:flex-start;
     gap:10px;
     padding:8px 6px;
     border-radius:10px;

     font-size: 12px;      /* smaller overall font in agencies list */
     line-height: 1.25;
   }
   .checkrow:hover{background: rgba(77,168,218,08);}

   /* meta text shown next to name */
   .checkrow .agmeta{
     color: var(--muted);
     font-size: 11px;
     font-weight: 700;
   }

   /* --- Modals (full-screen lock + scroll) --- */
   .modal-backdrop{
     position:fixed;
     inset:0;
     background: rgba(0,0,0,.45);
     display:none;
     align-items:center;
     justify-content:center;
     padding:18px;
     z-index:9999;
   }
   .modal-backdrop.on{display:flex;}

   .modal{
     width:min(980px, 96vw);
     max-height:92vh;              /* locks to screen height */
     background:#fff;
     border-radius:18px;
     box-shadow: 0 18px 60px rgba(0,0,0,.30);
     overflow:hidden;              /* keeps header fixed visually */
     border: 1px solid rgba(13,59,102,18);
   }

   .modal-hd{
     display:flex;
     align-items:flex-start;
     justify-content:space-between;
     gap:12px;
     padding:14px 16px;
     border-bottom:1px solid rgba(13,59,102,12);
     background: rgba(250,250,252,1);
   }

   .modal-title{
     margin:0;
     font-size:18px;
     font-weight:900;
     color: var(--navy);
   }
   .modal-sub{
     margin-top:4px;
     color: var(--muted);
     font-size:12px;
   }

   .modal-body{
     padding:16px;
     max-height: calc(92vh - 64px); /* header height allowance */
     overflow:auto;                 /* scrollbars inside modal */
   }

   .iconbtn{
     width:40px;
     height:40px;
     border-radius:12px;
     border:1px solid rgba(13,59,102,.18);
     background:#fff;
     cursor:pointer;
     font-weight:900;
     font-size:20px;
     line-height:1;
     display:flex;
     align-items:center;
     justify-content:center;
     color: var(--navy);
   }
   .iconbtn svg{
     width:20px;
     height:20px;
     display:block;
   }
   .iconbtn:hover{ box-shadow: 0 0 0 3px rgba(77,168,218,18); }
   .upload-progress{
     height:10px;
     border-radius:999px;
     border:1px solid rgba(13,59,102,.18);
     background:#f8fafc;
     overflow:hidden;
   }
   .upload-progress .bar{
     height:100%;
     width:0%;
     background: linear-gradient(90deg, rgba(13,59,102,.85), rgba(77,168,218,.85));
     transition: width .25s ease;
   }

   /* Bulk upload modal */
   .dropzone{
     border:2px dashed rgba(13,59,102,25);
     border-radius:16px;
     padding:18px;
     background: rgba(250,250,252,1);
     display:flex;
     flex-direction:column;
     gap:10px;
     align-items:center;
     justify-content:center;
     text-align:center;
   }
   .dropzone.on{
     box-shadow: 0 0 0 3px rgba(77,168,218,18);
     border-color: rgba(77,168,218,60);
   }
   .smallhint{
     color: var(--muted);
     font-size:12px;
     line-height:1.35;
   }

   .xbtn{
     width:40px;
     height:40px;
     border-radius:12px;
     border:1px solid rgba(13,59,102,.18);
     background:#fff;
     cursor:pointer;
     font-weight:900;
     font-size:16px;
     line-height:1;
   }
   /* =========================
      Notes panel split layout
   ========================= */
   #panelNotes .content{ min-width:0; }

   .notes-split{
     height: calc(100vh - 180px); /* topbar + page padding allowance */
     display:flex;
     flex-direction:column;
     gap:14px;
   }

   .notes-card .hd{
     padding:12px 14px;
     border-bottom:1px solid rgba(15,23,42,.06);
     display:flex;
     align-items:flex-end;
     justify-content:space-between;
     gap:10px;
   }

   .notes-card .body{
     padding:12px 14px;
   }

   /* Top templates table: ~4 rows visible */
   .notes-templates-table{
     height: 220px;           /* tweak if you want slightly taller/shorter */
     overflow:auto;
   }

   /* Bottom questions table: fill remainder */
   .notes-questions-grow{
     flex:1;
     min-height: 240px;
     overflow:hidden;         /* keeps the card tidy */
   }
   .notes-questions-table{
     height: 100%;
     overflow:auto;
   }
   /* =========================
      Notes subtabs (internal)
   ========================= */
   .notes-tab{ display:none; }
   .notes-tab.on{ display:block; }

   /* --- NEW: User Notification Preferences --- */
   .notif-pref-wrap{
     border:1px solid rgba(13,59,102,.18);
     border-radius:12px;
     background:#fff;
     padding:10px;
   }
   .notif-pref-top{
     display:flex;
     gap:10px;
     align-items:center;
     justify-content:space-between;
     flex-wrap:wrap;
     margin-bottom:10px;
   }
   .notif-pref-addrow{
     display:flex;
     gap:10px;
     align-items:center;
     flex-wrap:wrap;
   }
   .notif-pref-list{
     max-height: 28vh;
     overflow:auto;
     border-top:1px solid rgba(15,23,42,.06);
     padding-top:10px;
   }
   .notif-item{
     display:flex;
     align-items:flex-start;
     justify-content:space-between;
     gap:10px;
     padding:8px 6px;
     border-radius:10px;
   }
   .notif-item:hover{background: rgba(77,168,218,08);}
   .notif-methods{
     display:flex;
     gap:8px;
     flex-wrap:wrap;
     align-items:center;
     color: var(--muted);
     font-size: 11px;
     font-weight: 800;
   }
   .notif-x{
     border:1px solid rgba(13,59,102,.18);
     background:#fff;
     border-radius:10px;
     padding:6px 10px;
     cursor:pointer;
     font-weight:900;
     font-size:12px;
     color: var(--navy);
   }
   .notif-x:hover{ box-shadow: 0 0 0 3px rgba(168,230,207,.35); border-color: rgba(168,230,207,.95); }

   .miniIconBtn{
     width: 30px;
     height: 30px;
     border-radius: 10px;
     border: 1px solid #e5e7eb;
     background: #ffffff;
     display: inline-flex;
     align-items: center;
     justify-content: center;
     cursor: pointer;
     color: #111827;
   }
   .miniIconBtn:hover{
     background: #f9fafb;
   }

  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="kicker">Sensys 3.0</div>
        <div class="title">Admin</div>
      </div>

      <div class="row">
        <div class="field">
          <label>ADMIN_TOKEN</label>
          <input id="token" placeholder="paste token here…" />
        </div>
        <button class="btn" id="saveToken">Save</button>
        <button class="btn primary" id="refresh">Refresh</button>
      </div>
    </div>

    <div class="layout">
      <!-- LEFT SIDEBAR -->
      <div class="sidebar">
        <div class="mini" style="font-weight:900;color:var(--muted);letter-spacing:.12em;text-transform:uppercase;">
          Sections
        </div>

        <div class="navitem on" id="tabUsers">Users</div>
        <div class="navitem" id="tabAgencies">Agencies</div>
        <div class="navitem" id="tabProviderLibrary">Provider Library</div>
        <div class="navitem" id="tabPatients">Patients</div>
        <div class="navitem" id="tabAdmissions">Admissions</div>
        <div class="navitem" id="tabClientSurveys">Client Surveys</div>

        <div style="height:10px"></div>
        <div class="mini" style="font-weight:900;color:var(--muted);letter-spacing:.12em;text-transform:uppercase;">
          Reference
        </div>
        <div class="navitem" id="tabServices">Services</div>
        <div class="navitem" id="tabCareTeam">Care Team</div>
        <div class="navitem" id="tabNotes">Notes</div>
        <div class="navitem" id="tabNotifications">Notifications</div>
      </div>

      <!-- USERS PANEL -->
      <div class="panel on" id="panelUsers">
        <!-- RIGHT CONTENT -->
        <div class="content">
          <div class="hd" style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px">
            <div>
              <h2 style="margin:0">Users</h2>
              <div class="hint">Click a row to edit. Roles + agencies are saved separately.</div>
            </div>

            <!-- Add New User (top-right icon) -->
            <div style="display:flex;gap:8px;align-items:center">
              <button class="iconbtn" id="bulkUsersIcon" title="Bulk upload users" aria-label="Bulk upload users">
                <svg viewBox="0 0 251.6 261.78" aria-hidden="true"><defs>
                  <style>
                    .cls-1 {
                      fill: none;
                      stroke: #121212;
                      stroke-linecap: round;
                      stroke-miterlimit: 10;
                      stroke-width: 5.5px;
                    }
                  </style>
                </defs>
                <g>
                  <g>
                    <path class="cls-1" d="M82.81,106.67v97.45c0,5.42,4.39,9.81,9.81,9.81h66.35c5.42,0,9.81-4.39,9.81-9.81v-97.45h45.05c5.55,0,8.32-6.7,4.4-10.63L129.81,4.41c-2.21-2.21-5.81-2.21-8.02,0L33.36,96.05c-3.92,3.92-1.14,10.63,4.4,10.63h45.05Z"/>
                    <path class="cls-1" d="M2.75,202.34v41.97c0,8.13,6.59,14.72,14.72,14.72h216.66c8.13,0,14.72-6.59,14.72-14.72v-41.97"/>
                  </g>
                </g></svg>
              </button>
              <button class="iconbtn" id="addUserIcon" title="Add new user" aria-label="Add new user">+</button>
            </div>
          </div>
          <div class="body">
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Login</th>
                    <th>Email</th>
                    <th>Name</th>
                    <th>Active</th>
                    <th>Roles</th>
                    <th>Last Login</th>
                    <th>Locked</th>
                  </tr>
                </thead>
                <tbody id="tbody"></tbody>
              </table>
            </div>
            <div id="listMsg" class="toast"></div>
          </div>
        </div>

        <!-- RIGHT: Editor removed (user editing is now a modal) -->
        <div class="card" style="display:none"></div>

      </div><!-- /panelUsers -->
      
      <!-- =========================
           AGENCIES PANEL
      ========================= -->
      <div class="panel" id="panelAgencies">
        <div class="content">
          <div class="hd" style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px">
            <div>
              <h2 style="margin:0">Agencies</h2>
              <div class="hint">List used for user admission linking and multi-agency access.</div>
            </div>

            <!-- Add New Agency (top-right icon) -->
            <div style="display:flex;gap:8px;align-items:center">
              <button class="iconbtn" id="bulkAgenciesIcon" title="Bulk upload agencies" aria-label="Bulk upload agencies">
                <svg viewBox="0 0 251.6 261.78" aria-hidden="true"><defs>
                  <style>
                    .cls-1 {
                      fill: none;
                      stroke: #121212;
                      stroke-linecap: round;
                      stroke-miterlimit: 10;
                      stroke-width: 5.5px;
                    }
                  </style>
                </defs>
                <g>
                  <g>
                    <path class="cls-1" d="M82.81,106.67v97.45c0,5.42,4.39,9.81,9.81,9.81h66.35c5.42,0,9.81-4.39,9.81-9.81v-97.45h45.05c5.55,0,8.32-6.7,4.4-10.63L129.81,4.41c-2.21-2.21-5.81-2.21-8.02,0L33.36,96.05c-3.92,3.92-1.14,10.63,4.4,10.63h45.05Z"/>
                    <path class="cls-1" d="M2.75,202.34v41.97c0,8.13,6.59,14.72,14.72,14.72h216.66c8.13,0,14.72-6.59,14.72-14.72v-41.97"/>
                  </g>
                </g></svg>
              </button>
              <button class="iconbtn" id="addAgencyIcon" title="Add new agency" aria-label="Add new agency">+</button>
            </div>
          </div>

          <div class="body">
            <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px">
              <input class="input" id="agencyListSearch" placeholder="Search agencies." />
            </div>

            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Evolv Client</th>
                    <th style="text-align:right;">Actions</th>
                  </tr>
                </thead>
                <tbody id="agencyTbody"></tbody>
              </table>
            </div>

            <div id="agencyListMsg" class="toast"></div>
          </div>
        </div>
      </div><!-- /panelAgencies -->  
      <!-- =========================
           PROVIDER LIBRARY PANEL
      ========================= -->
      <div class="panel" id="panelProviderLibrary">
        <div class="content">
          <div class="hd" style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px">
            <div>
              <h2 style="margin:0">Provider Library</h2>
              <div class="hint">Search CMS Home Health providers stored in Sensys. Copy the CCN into an Agency to link records.</div>
            </div>
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end;">
              <div id="plMeta" style="font-size:12px;color:#667085;">—</div>
              <button class="btn" id="plSyncBtn" style="font-weight:900;">Sync Now</button>
            </div>
          </div>

          <!-- Subtabs (libraries) -->
          <div id="plSubtabs" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;"></div>

          <!-- Search row -->
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px;">
            <input class="input" id="plQ" placeholder="Search by provider name, DBA, or CCN…" style="width:min(520px,100%);" />
            <button class="btn" id="plSearchBtn" style="font-weight:900;">Search</button>

            <!-- Pagination controls -->
            <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
              <div id="plPageInfo" style="font-size:12px;color:#667085;">—</div>
              <button class="btn" id="plPrevBtn" style="padding:8px 10px;">Prev</button>
              <button class="btn" id="plNextBtn" style="padding:8px 10px;">Next</button>
            </div>
          </div>

          <!-- Scrollable table (capped height) -->
          <div style="margin-top:12px;border:1px solid #eef0f5;border-radius:14px;overflow:hidden;">
            <div style="max-height:420px;overflow:auto;">
              <table style="width:100%;border-collapse:collapse;">
                <thead style="background:#f9fafb;position:sticky;top:0;z-index:2;">
                  <tr>
                    <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">Provider</th>
                    <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">CCN</th>
                    <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">Location</th>
                    <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">Phone/Fax</th>
                  </tr>
                </thead>
                <tbody id="plTbody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>      
      <!-- =========================
           PATIENTS PANEL
      ========================= -->
      <div class="panel" id="panelPatients">
        <div class="content">
          <div class="hd" style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px">
            <div>
              <h2 style="margin:0">Patients</h2>
              <div class="hint">Manual add/edit for sensys_patients.</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="iconbtn" id="bulkPatientsIcon" title="Bulk upload patients" aria-label="Bulk upload patients">
                <svg viewBox="0 0 251.6 261.78" aria-hidden="true"><defs>
                  <style>
                    .cls-1 {
                      fill: none;
                      stroke: #121212;
                      stroke-linecap: round;
                      stroke-miterlimit: 10;
                      stroke-width: 5.5px;
                    }
                  </style>
                </defs>
                <g>
                  <g>
                    <path class="cls-1" d="M82.81,106.67v97.45c0,5.42,4.39,9.81,9.81,9.81h66.35c5.42,0,9.81-4.39,9.81-9.81v-97.45h45.05c5.55,0,8.32-6.7,4.4-10.63L129.81,4.41c-2.21-2.21-5.81-2.21-8.02,0L33.36,96.05c-3.92,3.92-1.14,10.63,4.4,10.63h45.05Z"/>
                    <path class="cls-1" d="M2.75,202.34v41.97c0,8.13,6.59,14.72,14.72,14.72h216.66c8.13,0,14.72-6.59,14.72-14.72v-41.97"/>
                  </g>
                </g></svg>
              </button>
              <button class="iconbtn" id="addPatientIcon" title="Add new patient" aria-label="Add new patient">+</button>
            </div>
          </div>

          <div class="body">
            <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px">
              <input class="input" id="patientListSearch" placeholder="Search patients (name, DOB, phone, email)..." />
            </div>

            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Patient</th>
                    <th>DOB</th>
                    <th>Phone</th>
                    <th>Active</th>
                  </tr>
                </thead>
                <tbody id="patientTbody"></tbody>
              </table>
            </div>

            <div id="patientListMsg" class="toast"></div>
          </div>
        </div>
      </div><!-- /panelPatients -->


      <!-- =========================
           ADMISSIONS PANEL
      ========================= -->
      <div class="panel" id="panelAdmissions">
        <div class="content">
          <div class="hd" style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px">
            <div>
              <h2 style="margin:0">Admissions</h2>
              <div class="hint">Manual add/edit for sensys_admissions (patient + agency + dates).</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="iconbtn" id="bulkAdmissionsIcon" title="Bulk upload admissions" aria-label="Bulk upload admissions">
                <svg viewBox="0 0 251.6 261.78" aria-hidden="true"><defs>
                  <style>
                    .cls-1 {
                      fill: none;
                      stroke: #121212;
                      stroke-linecap: round;
                      stroke-miterlimit: 10;
                      stroke-width: 5.5px;
                    }
                  </style>
                </defs>
                <g>
                  <g>
                    <path class="cls-1" d="M82.81,106.67v97.45c0,5.42,4.39,9.81,9.81,9.81h66.35c5.42,0,9.81-4.39,9.81-9.81v-97.45h45.05c5.55,0,8.32-6.7,4.4-10.63L129.81,4.41c-2.21-2.21-5.81-2.21-8.02,0L33.36,96.05c-3.92,3.92-1.14,10.63,4.4,10.63h45.05Z"/>
                    <path class="cls-1" d="M2.75,202.34v41.97c0,8.13,6.59,14.72,14.72,14.72h216.66c8.13,0,14.72-6.59,14.72-14.72v-41.97"/>
                  </g>
                </g></svg>
              </button>
              <button class="iconbtn" id="addAdmissionIcon" title="Add new admission" aria-label="Add new admission">+</button>
            </div>
          </div>

          <div class="body">
            <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px">
              <input class="input" id="admissionListSearch" placeholder="Search admissions (patient, agency, dates)..." />
            </div>

            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Patient</th>
                    <th>Agency</th>
                    <th>Admit</th>
                    <th>DC</th>
                    <th>Active</th>
                  </tr>
                </thead>
                <tbody id="admissionTbody"></tbody>
              </table>
            </div>

            <div id="admissionListMsg" class="toast"></div>
          </div>
        </div>
      </div><!-- /panelAdmissions -->

      <!-- =========================
           CLIENT SURVEYS PANEL
      ========================= -->
      <div class="panel" id="panelClientSurveys">
        <div class="content">
          <div class="hd" style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px">
            <div>
              <h2 style="margin:0">Client Surveys</h2>
              <div class="hint">Review survey runs and results for clients.</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="iconbtn" id="clientSurveysUploadIcon" title="Upload client survey file" aria-label="Upload client survey file">
                <svg viewBox="0 0 251.6 261.78" aria-hidden="true"><defs>
                  <style>
                    .cls-1 {
                      fill: none;
                      stroke: #121212;
                      stroke-linecap: round;
                      stroke-miterlimit: 10;
                      stroke-width: 5.5px;
                    }
                  </style>
                </defs>
                <g>
                  <g>
                    <path class="cls-1" d="M82.81,106.67v97.45c0,5.42,4.39,9.81,9.81,9.81h66.35c5.42,0,9.81-4.39,9.81-9.81v-97.45h45.05c5.55,0,8.32-6.7,4.4-10.63L129.81,4.41c-2.21-2.21-5.81-2.21-8.02,0L33.36,96.05c-3.92,3.92-1.14,10.63,4.4,10.63h45.05Z"/>
                    <path class="cls-1" d="M2.75,202.34v41.97c0,8.13,6.59,14.72,14.72,14.72h216.66c8.13,0,14.72-6.59,14.72-14.72v-41.97"/>
                  </g>
                </g></svg>
              </button>
              <button class="iconbtn" id="clientSurveysSettingsIcon" title="Client survey settings" aria-label="Client survey settings">
                <svg viewBox="0 0 246.98 255.82" aria-hidden="true"><defs>
                  <style>
                    .cls-1 {
                      fill: none;
                      stroke: #121212;
                      stroke-linecap: round;
                      stroke-miterlimit: 10;
                      stroke-width: 5.5px;
                    }
                  </style>
                </defs>
                <g>
                  <g>
                    <g>
                      <line class="cls-1" x1="137.69" y1="127.91" x2="244.23" y2="127.91"/>
                      <line class="cls-1" x1="3.51" y1="127.91" x2="35.59" y2="127.91"/>
                      <circle class="cls-1" cx="73.29" cy="127.91" r="34.97" transform="translate(-9.78 6.12) rotate(-4.48)"/>
                    </g>
                    <g>
                      <line class="cls-1" x1="109.3" y1="37.72" x2="2.75" y2="37.72"/>
                      <line class="cls-1" x1="243.47" y1="37.72" x2="211.39" y2="37.72"/>
                      <path class="cls-1" d="M138.73,37.72c0,19.31,15.66,34.97,34.97,34.97s34.97-15.66,34.97-34.97S193.01,2.75,173.69,2.75s-34.97,15.66-34.97,34.97Z"/>
                    </g>
                    <g>
                      <line class="cls-1" x1="109.3" y1="218.1" x2="2.75" y2="218.1"/>
                      <line class="cls-1" x1="243.47" y1="218.1" x2="211.39" y2="218.1"/>
                      <circle class="cls-1" cx="173.69" cy="218.1" r="34.97" transform="translate(-34.55 32.7) rotate(-9.79)"/>
                    </g>
                  </g>
                </g></svg>
              </button>
            </div>
          </div>

          <div class="survey-grid" style="grid-template-columns:1fr;">
            <div class="card survey-card">
              <div class="hd">
                <div>
                  <h2 style="margin:0">Surveys</h2>
                  <div class="hint">Select a survey to view details.</div>
                </div>
                <div style="display:flex;gap:8px;align-items:center">
                  <input class="input" id="clientSurveySearch" placeholder="Search patient name." style="width:190px;max-width:190px;" />
                  <button class="iconbtn" id="clientSurveyFilterIcon" title="Survey filters" aria-label="Survey filters">
                    <svg viewBox="0 0 253.2 249.69" aria-hidden="true"><defs>
                      <style>
                        .cls-1 {
                          fill: none;
                          stroke: #121212;
                          stroke-linecap: round;
                          stroke-miterlimit: 10;
                          stroke-width: 5.5px;
                        }
                      </style>
                    </defs>
                    <g>
                      <g>
                        <path class="cls-1" d="M250.45,2.75v39.04c0,7.59-3.01,14.86-8.36,20.23l-78.27,78.52c-6.72,6.74-10.5,15.88-10.5,25.4v59.57c0,4.07-2.58,7.7-6.43,9.03l-34.32,11.86c-6.21,2.14-12.67-2.46-12.67-9.03v-71.55c0-9.5-3.76-18.62-10.45-25.36L11.08,61.6c-5.33-5.37-8.33-12.63-8.33-20.2V2.75"/>
                        <line class="cls-1" x1="28.56" y1="43.43" x2="222.5" y2="43.43"/>
                        <line class="cls-1" x1="26.93" y1="2.75" x2="224.14" y2="2.75"/>
                      </g>
                    </g></svg>
                  </button>
                  <button class="iconbtn" id="clientSurveyEmailIcon" title="Email surveys" aria-label="Email surveys">
                    <svg viewBox="0 0 256.63 204.3" aria-hidden="true"><defs>
                      <style>
                        .cls-1 {
                          fill: none;
                          stroke: #121212;
                          stroke-linecap: round;
                          stroke-miterlimit: 10;
                          stroke-width: 5.5px;
                        }
                      </style>
                    </defs>
                    <g>
                      <g>
                        <path class="cls-1" d="M253.87,26.22c0-12.96-10.51-23.47-23.47-23.47H26.22C13.26,2.75,2.75,13.26,2.75,26.22v23.02c0,3.6,1.97,6.9,5.13,8.62l115.75,62.92c2.92,1.59,6.45,1.59,9.37,0l115.75-62.92c3.16-1.72,5.13-5.03,5.13-8.62v-23.02Z"/>
                        <path class="cls-1" d="M253.87,85.27v92.81c0,12.96-10.51,23.47-23.47,23.47H26.22c-12.96,0-23.47-10.51-23.47-23.47v-92.81"/>
                      </g>
                    </g></svg>
                  </button>
                </div>
              </div>
              <div class="body">
                <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px;flex-wrap:wrap">
                  <label class="mini" style="display:flex;align-items:center;gap:8px;">
                    <input type="checkbox" id="clientSurveyMockToggle" checked />
                    Show mock row
                  </label>
                </div>
                <div class="table-wrap">
                  <table>
                    <thead>
                      <tr>
                        <th>Patient / Agency / Dates</th>
                        <th>Updated</th>
                        <th>Score</th>
                      </tr>
                    </thead>
                    <tbody id="clientSurveyTbody"></tbody>
                  </table>
                </div>
                <div id="clientSurveyListMsg" class="toast"></div>
              </div>
            </div>

          </div>
          <div class="mini" id="clientSurveyRowCount" style="margin-top:10px;color:#64748b;"></div>

        </div>
      </div><!-- /panelClientSurveys -->
        <!-- =========================
             SERVICES PANEL
        ========================= -->
        <div class="panel" id="panelServices">
        <div class="content">
          <div class="hd" style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px">
            <div>
              <h2 style="margin:0">Services</h2>
              <div class="hint">Reference list used for DC submissions (DME / HH) and E-Sign orders.</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="iconbtn" id="bulkServicesIcon" title="Bulk upload services" aria-label="Bulk upload services">
                <svg viewBox="0 0 251.6 261.78" aria-hidden="true"><defs>
                  <style>
                    .cls-1 {
                      fill: none;
                      stroke: #121212;
                      stroke-linecap: round;
                      stroke-miterlimit: 10;
                      stroke-width: 5.5px;
                    }
                  </style>
                </defs>
                <g>
                  <g>
                    <path class="cls-1" d="M82.81,106.67v97.45c0,5.42,4.39,9.81,9.81,9.81h66.35c5.42,0,9.81-4.39,9.81-9.81v-97.45h45.05c5.55,0,8.32-6.7,4.4-10.63L129.81,4.41c-2.21-2.21-5.81-2.21-8.02,0L33.36,96.05c-3.92,3.92-1.14,10.63,4.4,10.63h45.05Z"/>
                    <path class="cls-1" d="M2.75,202.34v41.97c0,8.13,6.59,14.72,14.72,14.72h216.66c8.13,0,14.72-6.59,14.72-14.72v-41.97"/>
                  </g>
                </g></svg>
              </button>
              <button class="iconbtn" id="addServiceIcon" title="Add new service" aria-label="Add new service">+</button>
              <button class="iconbtn" id="addServiceTypeIcon" title="Add new service type" aria-label="Add new service type" style="display:none;">＋T</button>
            </div>
          </div>

          <!-- Subtabs -->
          <div id="servicesSubtabs" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;"></div>

          <div class="body">

            <!-- =========================
                 SUBTAB: SERVICES
            ========================= -->
            <div id="servicesSubtabServices">
              <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px">
                <input class="input" id="servicesListSearch" placeholder="Search services (name/type)." />
              </div>

              <div class="table-wrap">
                <table>
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Type</th>
                      <th>Dropdown</th>
                    </tr>
                  </thead>
                  <tbody id="servicesTbody"></tbody>
                </table>
              </div>

              <div id="servicesListMsg" class="toast"></div>
            </div>

            <!-- =========================
                 SUBTAB: SERVICE TYPES
            ========================= -->
            <div id="servicesSubtabTypes" style="display:none;">
              <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px">
                <input class="input" id="serviceTypesSearch" placeholder="Search service types (name/code)." />
              </div>

              <div class="table-wrap">
                <table>
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Code</th>
                      <th>Active</th>
                    </tr>
                  </thead>
                  <tbody id="serviceTypesTbody"></tbody>
                </table>
              </div>

              <div id="serviceTypesMsg" class="toast"></div>
            </div>

          </div>
        </div>
      </div><!-- /panelServices -->

      <div id="panelNotes" class="panel">
        <div class="content">
          <!-- Match other panels: header -->
          <div class="hd" style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px">
            <div>
              <h2 style="margin:0">Notes</h2>
              <div class="hint">Create note templates and manage their questions/answer fields used on Admission Details.</div>
            </div>
          </div>

          <!-- Notes Subtabs (pills) -->
          <div id="notesSubtabs" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;"></div>

          <div class="body">

            <!-- =========================
                 NOTES TAB (Templates + Questions)
                 - DC templates REMOVED from here
                 - Questions grows taller automatically
            ========================= -->
            <div id="notesTabMain" class="notes-tab on">
              <div class="notes-split">

                <!-- TEMPLATES CARD (fixed height) -->
                <div class="card notes-card">
                  <div class="hd">
                    <div>
                      <h2 style="margin:0;font-size:14px;color:var(--navy)">Templates</h2>
                      <div class="hint">Select a template to manage its questions below.</div>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center">
                      <button class="btn primary" onclick="openNoteTemplateModal(null)">+ New Template</button>
                    </div>
                  </div>

                  <div class="body">
                    <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px">
                      <input class="input" id="notesListSearch" placeholder="Search templates..." />
                    </div>

                    <div class="table-wrap notes-templates-table">
                      <table>
                        <thead>
                          <tr>
                            <th>Template</th>
                            <th>Agency</th>
                            <th>Active</th>
                            <th style="text-align:right;">Actions</th>
                          </tr>
                        </thead>
                        <tbody id="notesTemplatesTbody"></tbody>
                      </table>
                    </div>

                    <div id="notesListMsg" class="toast"></div>
                  </div>
                </div>

                <!-- QUESTIONS CARD (fills remainder) -->
                <div class="card notes-card notes-questions-grow">
                  <div class="hd">
                    <div>
                      <h2 style="margin:0;font-size:14px;color:var(--navy)">Questions / Fields</h2>
                      <div class="hint">Questions for the selected template.</div>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center">
                      <button class="btn primary" onclick="openNoteFieldModal(null)" id="btnAddNoteField" disabled>+ Add Question</button>
                    </div>
                  </div>

                  <div class="body" style="height:100%;display:flex;flex-direction:column;">
                    <div class="table-wrap notes-questions-table" style="flex:1;">
                      <table>
                        <thead>
                          <tr>
                            <th>Key</th>
                            <th>Label</th>
                            <th>Type</th>
                            <th>Required</th>
                            <th>Order</th>
                            <th style="text-align:right;">Actions</th>
                          </tr>
                        </thead>
                        <tbody id="notesFieldsTbody"></tbody>
                      </table>
                    </div>
                  </div>
                </div>

              </div>
            </div><!-- /notesTabMain -->

            <!-- =========================
                 DC NOTE TAB (DC templates only)
            ========================= -->
            <div id="notesTabDc" class="notes-tab">
              <div class="card notes-card">
                <div class="hd">
                  <div>
                    <h2 style="margin:0;font-size:14px;color:var(--navy)">DC Discharge Note Templates</h2>
                    <div class="hint">Templates used to generate Social Service DC notes from DC Submissions + selected services.</div>
                  </div>
                  <div style="display:flex;gap:8px;align-items:center">
                    <button class="btn primary" onclick="openDcNoteTemplateModal(null)">+ New DC Template</button>
                  </div>
                </div>

                <div class="body">
                  <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px">
                    <input class="input" id="dcNotesListSearch" placeholder="Search DC note templates." />
                  </div>

                  <div class="table-wrap" style="max-height:calc(100vh - 310px);overflow:auto;">
                    <table>
                      <thead>
                        <tr>
                          <th>Template</th>
                          <th>Agency</th>
                          <th>Active</th>
                          <th style="text-align:right;">Actions</th>
                        </tr>
                      </thead>
                      <tbody id="dcNotesTemplatesTbody"></tbody>
                    </table>
                  </div>

                  <div id="dcNotesListMsg" class="toast"></div>
                </div>
              </div>
            </div><!-- /notesTabDc -->

          </div>
        </div>
      </div>
      <!-- =========================
           CARE TEAM PANEL
      ========================= -->
      <div class="panel" id="panelCareTeam">
        <div class="content">
          <div class="hd" style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px">
            <div>
              <h2 style="margin:0">Care Team</h2>
              <div class="hint">Reference list of providers/contacts used on admissions.</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="iconbtn" id="bulkCareTeamIcon" title="Bulk upload care team" aria-label="Bulk upload care team">
                <svg viewBox="0 0 251.6 261.78" aria-hidden="true"><defs>
                  <style>
                    .cls-1 {
                      fill: none;
                      stroke: #121212;
                      stroke-linecap: round;
                      stroke-miterlimit: 10;
                      stroke-width: 5.5px;
                    }
                  </style>
                </defs>
                <g>
                  <g>
                    <path class="cls-1" d="M82.81,106.67v97.45c0,5.42,4.39,9.81,9.81,9.81h66.35c5.42,0,9.81-4.39,9.81-9.81v-97.45h45.05c5.55,0,8.32-6.7,4.4-10.63L129.81,4.41c-2.21-2.21-5.81-2.21-8.02,0L33.36,96.05c-3.92,3.92-1.14,10.63,4.4,10.63h45.05Z"/>
                    <path class="cls-1" d="M2.75,202.34v41.97c0,8.13,6.59,14.72,14.72,14.72h216.66c8.13,0,14.72-6.59,14.72-14.72v-41.97"/>
                  </g>
                </g></svg>
              </button>
              <button class="iconbtn" id="addCareTeamIcon" title="Add new care team member" aria-label="Add new care team member">+</button>
            </div>
          </div>

          <div class="body">
            <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px">
              <input class="input" id="careTeamListSearch" placeholder="Search care team (name/type/npi)." />
            </div>

            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>NPI</th>
                    <th>Active</th>
                  </tr>
                </thead>
                <tbody id="careTeamTbody"></tbody>
              </table>
            </div>

            <div id="careTeamListMsg" class="toast"></div>
          </div>
        </div>
      </div><!-- /panelCareTeam -->
      <!-- =========================
           NOTIFICATIONS PANEL
      ========================= -->
      <div class="panel" id="panelNotifications">
        <div class="content">
          <div class="hd" style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px">
            <div>
              <h2 style="margin:0">Notifications</h2>
              <div class="hint">Manage notification templates (subject/body) used for email/SMS/dashboard.</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="iconbtn" id="addNotifIcon" title="Add notification template" aria-label="Add notification template">+</button>
            </div>
          </div>

          <div class="body">
            <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px">
              <input class="input" id="notifSearch" placeholder="Search notifications (key/name)..." />
            </div>

            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Key</th>
                    <th>Name</th>
                    <th>Active</th>
                    <th style="text-align:right;">Actions</th>
                  </tr>
                </thead>
                <tbody id="notifTbody"></tbody>
              </table>
            </div>

            <div id="notifMsg" class="toast"></div>
          </div>
        </div>
      </div><!-- /panelNotifications -->

    </div><!-- /layout -->
  </div>
<!-- =========================
     USER MODAL
========================= -->
<div class="modal-backdrop" id="userModalBackdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="userModalTitle">
    <div class="modal-hd">
      <div>
        <h3 class="modal-title" id="userModalTitle">Edit User</h3>
        <div class="modal-sub">user_id: <b id="selId">—</b></div>
      </div>
      <button class="xbtn" id="closeUserModal" aria-label="Close">✕</button>
    </div>

    <div class="modal-body">
      <div class="label">Email/Username</div>
      <input class="input" id="email" placeholder="user@email.com" />

      <div style="height:10px"></div>

      <div class="label">Display Name</div>
      <input class="input" id="display_name" placeholder="Full name" />

      <div style="height:10px"></div>

      <div class="label">Active</div>
      <select class="select" id="is_active">
        <option value="1">Yes (Active)</option>
        <option value="0">No (Inactive)</option>
      </select>

      <div style="height:14px"></div>

      <div class="label">Roles</div>
      <div class="pill" id="roles"></div>

      <div style="height:14px"></div>

      <!-- ✅ Provider-only fields -->
      <div id="providerFields" style="display:none;">
        <div class="label">NPI (Provider E-sign)</div>
        <input class="input" id="provider_npi" placeholder="NPI" />

        <div style="height:10px"></div>

        <div class="label">E-Sign Linking (Care Team)</div>
        <div class="checkwrap">
          <input class="checksearch" id="esignLinkSearch" placeholder="Search care team." />
          <div class="checklist" id="esignLinkChecklist"></div>
        </div>

        <div style="height:14px"></div>
      </div>

      <div class="label">Cell Phone</div>
      <input class="input" id="cell_phone" placeholder="(xxx) xxx-xxxx" />

      <div style="height:10px"></div>

      <div class="label">Password</div>
      <input class="input" id="password" type="password" placeholder="Leave blank to keep unchanged" />

      <div style="height:10px"></div>

      <div class="label">Account Locked</div>
      <select class="select" id="account_locked">
        <option value="0">No</option>
        <option value="1">Yes (Locked)</option>
      </select>

      <div style="height:14px"></div>

      <div class="label">Agencies (multi-select)</div>
      <div class="checkwrap">
        <input class="checksearch" id="agencySearch" placeholder="Search agencies." />
        <div class="checklist" id="agencyChecklist"></div>
      </div>

      <div style="height:14px"></div>

      <!-- ✅ NEW: Notification Preferences -->
      <div class="label">Notification Preferences</div>
      <div class="notif-pref-wrap">
        <div class="notif-pref-top">
          <div class="hint">Assign which notifications this user receives + delivery methods.</div>
          <div class="notif-pref-addrow">
            <select class="select" id="userNotifSelect" style="width:min(360px, 70vw);">
              <option value="">Loading notifications…</option>
            </select>

            <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:#334155;font-weight:800;">
              <input type="checkbox" id="userNotifEmail" /> Email
            </label>
            <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:#334155;font-weight:800;">
              <input type="checkbox" id="userNotifSms" /> SMS
            </label>
            <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:#334155;font-weight:800;">
              <input type="checkbox" id="userNotifDash" checked /> Dashboard
            </label>

            <button class="btn" id="addUserNotifBtn" style="padding:10px 12px;">+ Add</button>
          </div>
        </div>

        <div class="notif-pref-list" id="userNotifList"></div>
      </div>

      <div style="height:14px"></div>

      <div class="stack">
        <button class="btn primary" id="saveUser">Save User</button>
      </div>

      <div id="editMsg" class="toast"></div>
    </div>
  </div>
</div>

<!-- ✅ DC Note Template modal -->
<div id="dcNoteTplModalBackdrop" class="modal-backdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="dcNoteTplModalTitle">
    <div class="modal-hd">
      <div>
        <h3 class="modal-title" id="dcNoteTplModalTitle">DC Note Template</h3>
        <div class="modal-sub">Uses {{var}} and {{#if var}}...{{/if}} blocks.</div>
      </div>
      <button class="xbtn" id="closeDcNoteTplModal" aria-label="Close">✕</button>
    </div>

    <div class="modal-body" style="max-height:78vh; overflow:auto; padding-bottom:16px;">
      <div class="grid2">
        <div>
          <label>Template Name</label>
          <input id="dcNoteTplName" placeholder="e.g. Social Service DC Note" />
        </div>
        <div>
          <label>Agencies (optional)</label>
          <div class="checkwrap">
            <input id="dcNoteTplAgencySearch" class="checksearch" placeholder="Search agencies…" />
            <div id="dcNoteTplAgencyChecklist" class="checklist" style="max-height:220px; overflow:auto;"></div>
            <div class="muted" style="margin-top:6px;">Leave blank = Global (all agencies)</div>
          </div>
        </div>
      </div>

      <div class="grid2" style="margin-top:10px;">
        <div>
          <label>Active</label>
          <select id="dcNoteTplActive">
            <option value="1">Yes</option>
            <option value="0">No</option>
          </select>
        </div>
        <div></div>
      </div>

      <div style="margin-top:10px;">
        <label>Template Body</label>
        <textarea id="dcNoteTplBody" style="width:100%;min-height:260px;"></textarea>
        <div class="hint" style="margin-top:8px;">
          Variables: {{discharge_date}}, {{destination}}, {{dc_with}}, {{hh_services}}, {{hh_agency_name}}, {{dme_services}}, {{evolv_phone}}.
          <br/>Conditionals: {{#if has_hh}}...{{/if}}, {{#if has_hh_agency}}...{{/if}}, {{#if has_dme}}...{{/if}}.
        </div>
      </div>

      <div id="dcNoteTplMsg" class="msg ok" style="margin-top:10px;"></div>

      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px;padding-top:12px;border-top:1px solid rgba(15,23,42,.08);">
        <button class="btn2" onclick="closeDcNoteTemplateModal()">Cancel</button>
        <button class="btn" onclick="saveDcNoteTemplate()">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- =========================
     AGENCY MODAL
========================= -->
<div class="modal-backdrop" id="agencyModalBackdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="agencyModalTitle">
    <div class="modal-hd">
      <div>
        <h3 class="modal-title" id="agencyModalTitle">Edit Agency</h3>
        <div class="modal-sub">agency_id: <b id="selAgencyId">—</b></div>
      </div>
      <button class="xbtn" id="closeAgencyModal" aria-label="Close">✕</button>
    </div>

    <div class="modal-body">
      <div class="label">Agency Name</div>
      <input class="input" id="agency_name" placeholder="Agency name" />

      <div style="height:10px"></div>

      <div class="label">Agency Type</div>
      <select class="select" id="agency_type">
        <option value="Hospital">Hospital</option>
        <option value="SNF">SNF</option>
        <option value="Home Health">Home Health</option>
        <option value="IRF">IRF</option>
        <option value="LTACH">LTACH</option>
        <option value="Hospice">Hospice</option>
        <option value="Outpatient PT">Outpatient PT</option>
      </select>

      <div style="height:10px"></div>

      <div class="label">Aliases</div>
      <input class="input" id="aliases" placeholder="Comma-separated aliases (optional)" />

      <div style="height:10px"></div>

      <div class="label">Facility Code</div>
      <input class="input" id="facility_code" placeholder="Optional code" />

      <div style="height:10px"></div>

      <div class="label">Care Compare CCN (Home Health)</div>
      <input class="input" id="carecompare_ccn" placeholder="Example: 109999" />

      <div style="height:10px"></div>

      <div class="label">Address</div>
      <input class="input" id="address" placeholder="Street address" />

      <div style="height:10px"></div>

      <div class="label">City</div>
      <input class="input" id="city" placeholder="City" />

      <div style="height:10px"></div>

      <div class="label">State</div>
      <input class="input" id="state" placeholder="State" />

      <div style="height:10px"></div>

      <div class="label">Zip</div>
      <input class="input" id="zip" placeholder="Zip" />

      <div style="height:10px"></div>

      <div class="label">Phone 1</div>
      <input class="input" id="phone1" placeholder="Phone 1" />

      <div style="height:10px"></div>

      <div class="label">Phone 2</div>
      <input class="input" id="phone2" placeholder="Phone 2" />

      <div style="height:10px"></div>

      <div class="label">Email</div>
      <input class="input" id="email2" placeholder="Email" />

      <div style="height:10px"></div>

      <div class="label">Fax</div>
      <input class="input" id="fax" placeholder="Fax" />

      <div style="height:10px"></div>

      <div class="label">Notes</div>
      <input class="input" id="notes" placeholder="Notes" />

      <div style="height:10px"></div>

      <div class="label">Notes 2</div>
      <input class="input" id="notes2" placeholder="Notes 2" />

      <div style="height:10px"></div>

      <div class="label">Evolv Client</div>
      <select class="select" id="evolv_client">
        <option value="0">No</option>
        <option value="1">Yes</option>
      </select>

      <div style="height:14px"></div>

      <div class="label">Preferred Providers</div>
      <div class="checkwrap">
        <input class="checksearch" id="preferredProviderSearch" placeholder="Search agencies (Home Health)…" />
        <div class="checklist" id="preferredProvidersChecklist"></div>
      </div>

      <div style="height:14px"></div>

      <div class="stack">
        <button class="btn primary" id="saveAgency">Save Agency</button>
      </div>

      <div id="agencyEditMsg" class="toast"></div>
    </div>
  </div>
</div>
<!-- =========================
     PATIENT MODAL
========================= -->
<div class="modal-backdrop" id="patientModalBackdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="patientModalTitle">
    <div class="modal-hd">
      <div>
        <h3 class="modal-title" id="patientModalTitle">Edit Patient</h3>
        <div class="modal-sub">patient_id: <b id="selPatientId">—</b></div>
      </div>
      <button class="xbtn" id="closePatientModal" aria-label="Close">✕</button>
    </div>

    <div class="modal-body">
      <div class="label">First Name</div>
      <input class="input" id="p_first_name" />

      <div style="height:10px"></div>

      <div class="label">Last Name</div>
      <input class="input" id="p_last_name" />

      <div style="height:10px"></div>

      <div class="label">DOB</div>
      <input class="input" id="p_dob" placeholder="YYYY-MM-DD or MM/DD/YYYY" />

      <div style="height:10px"></div>

      <div class="label">Gender</div>
      <input class="input" id="p_gender" placeholder="M/F/Other" />

      <div style="height:10px"></div>

      <div class="label">Phone 1</div>
      <input class="input" id="p_phone1" />

      <div style="height:10px"></div>

      <div class="label">Email</div>
      <input class="input" id="p_email" />

      <div style="height:10px"></div>

      <div class="label">Active</div>
      <select class="select" id="p_active">
        <option value="1">Yes (Active)</option>
        <option value="0">No (Inactive)</option>
      </select>

      <div style="height:14px"></div>

      <div class="stack">
        <button class="btn primary" id="savePatient">Save Patient</button>
      </div>

      <div id="patientEditMsg" class="toast"></div>
    </div>
  </div>
</div>


<!-- =========================
     ADMISSION MODAL
========================= -->
<div class="modal-backdrop" id="admissionModalBackdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="admissionModalTitle">
    <div class="modal-hd">
      <div>
        <h3 class="modal-title" id="admissionModalTitle">Edit Admission</h3>
        <div class="modal-sub">admission_id: <b id="selAdmissionId">—</b></div>
      </div>
      <button class="xbtn" id="closeAdmissionModal" aria-label="Close">✕</button>
    </div>

    <div class="modal-body">
      <div class="label">Patient</div>
      <select class="select" id="a_patient_id"></select>

      <div style="height:10px"></div>

      <div class="label">Agency</div>
      <select class="select" id="a_agency_id"></select>

      <div style="height:10px"></div>

      <div class="label">MRN</div>
      <input class="input" id="a_mrn" placeholder="MRN" />

      <div style="height:10px"></div>

      <div class="label">Visit ID</div>
      <input class="input" id="a_visit_id" placeholder="Visit ID" />

      <div style="height:10px"></div>

      <div class="label">Facility Code</div>
      <input class="input" id="a_facility_code" placeholder="Facility code" />

      <div style="height:10px"></div>

      <div class="label">Admit Date</div>
      <input class="input" id="a_admit_date" placeholder="YYYY-MM-DD" />

      <div style="height:10px"></div>

      <div class="label">DC Date</div>
      <input class="input" id="a_dc_date" placeholder="YYYY-MM-DD" />

      <div style="height:10px"></div>

      <div class="label">Room</div>
      <input class="input" id="a_room" />

      <div style="height:10px"></div>

      <div class="label">Reason</div>
      <input class="input" id="a_reason" />

      <div style="height:10px"></div>

      <div class="label">Active</div>
      <select class="select" id="a_active">
        <option value="1">Yes (Active)</option>
        <option value="0">No (Inactive)</option>
      </select>

      <div style="height:14px"></div>

      <div class="stack">
        <button class="btn primary" id="saveAdmission">Save Admission</button>
      </div>

      <div id="admissionEditMsg" class="toast"></div>
    </div>
  </div>
</div>
  
  <!-- =========================
       CLIENT SURVEYS SETTINGS MODAL
  ========================= -->
  <div class="modal-backdrop" id="clientSurveysSettingsModalBackdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="clientSurveysSettingsModalTitle">
      <div class="modal-hd">
        <div>
          <h3 class="modal-title" id="clientSurveysSettingsModalTitle">Client Survey Settings</h3>
          <div class="modal-sub">Configuration defaults and survey settings.</div>
        </div>
                <button class="xbtn" id="closeClientSurveysSettingsModal" aria-label="Close">
          <svg viewBox="0 0 183.48 183.48" aria-hidden="true"><defs>
            <style>
              .cls-1 {
                fill: none;
                stroke: #121212;
                stroke-linecap: round;
                stroke-miterlimit: 10;
                stroke-width: 5.5px;
              }
            </style>
          </defs>
          <g>
            <g>
              <line class="cls-1" x1="180.73" y1="2.75" x2="2.75" y2="180.73"/>
              <line class="cls-1" x1="180.73" y1="180.73" x2="2.75" y2="2.75"/>
            </g>
          </g></svg>
        </button>
      </div>

      <div class="modal-body">
        <div class="label">AI Summary Prompt</div>
        <textarea class="input" id="clientSurveyPrompt" rows="8" placeholder="Enter prompt for AI summaries."></textarea>
        <div style="height:10px"></div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn primary" id="clientSurveyPromptSave">Save Prompt</button>
          <div class="mini" id="clientSurveyPromptMsg"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- =========================
       CLIENT SURVEYS UPLOAD MODAL
  ========================= -->
  <div class="modal-backdrop" id="clientSurveysUploadModalBackdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="clientSurveysUploadModalTitle">
      <div class="modal-hd">
        <div>
          <h3 class="modal-title" id="clientSurveysUploadModalTitle">Upload Client Survey File</h3>
          <div class="modal-sub">Drag a file into the dropzone or choose a file.</div>
        </div>
                <button class="xbtn" id="closeClientSurveysUploadModal" aria-label="Close">
          <svg viewBox="0 0 183.48 183.48" aria-hidden="true"><defs>
            <style>
              .cls-1 {
                fill: none;
                stroke: #121212;
                stroke-linecap: round;
                stroke-miterlimit: 10;
                stroke-width: 5.5px;
              }
            </style>
          </defs>
          <g>
            <g>
              <line class="cls-1" x1="180.73" y1="2.75" x2="2.75" y2="180.73"/>
              <line class="cls-1" x1="180.73" y1="180.73" x2="2.75" y2="2.75"/>
            </g>
          </g></svg>
        </button>
      </div>

      <div class="modal-body">
        <div class="dropzone" id="clientSurveysDropzone">
          <div style="font-weight:900;color:var(--navy);">Drop file here</div>
          <div class="smallhint">or click to choose a file</div>
          <button class="btn" id="clientSurveysChooseFileBtn" type="button">Choose File</button>
          <input id="clientSurveysUploadInput" type="file" accept=".csv,text/csv" style="display:none" />
        </div>
        <div class="smallhint" id="clientSurveysUploadStatus" style="margin-top:10px;">No file selected.</div>
        <div style="height:10px"></div>
        <button class="btn primary" id="clientSurveysUploadSubmit" disabled>Upload File</button>
        <div class="smallhint" id="clientSurveysUploadMsg" style="margin-top:8px;"></div>
        <div style="height:10px"></div>
        <div class="upload-progress" id="clientSurveysUploadProgress" style="display:none;">
          <div class="bar" id="clientSurveysUploadBar"></div>
        </div>
      </div>
    </div>
  </div>

    <!-- =========================
       CLIENT SURVEYS FILTER MODAL
  ========================= -->
  <div class="modal-backdrop" id="clientSurveysFilterModalBackdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="clientSurveysFilterModalTitle">
      <div class="modal-hd">
        <div>
          <h3 class="modal-title" id="clientSurveysFilterModalTitle">Survey Filters</h3>
          <div class="modal-sub">Filter by agency and discharge date range. Sort options included.</div>
        </div>
                <button class="xbtn" id="closeClientSurveysFilterModal" aria-label="Close">
          <svg viewBox="0 0 183.48 183.48" aria-hidden="true"><defs>
            <style>
              .cls-1 {
                fill: none;
                stroke: #121212;
                stroke-linecap: round;
                stroke-miterlimit: 10;
                stroke-width: 5.5px;
              }
            </style>
          </defs>
          <g>
            <g>
              <line class="cls-1" x1="180.73" y1="2.75" x2="2.75" y2="180.73"/>
              <line class="cls-1" x1="180.73" y1="180.73" x2="2.75" y2="2.75"/>
            </g>
          </g></svg>
        </button>
      </div>

      <div class="modal-body">
        <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;">
          <div>
            <div class="label">Agency Name</div>
            <select class="select" id="clientSurveyFilterAgency">
              <option value="">All agencies</option>
            </select>
          </div>
          <div>
            <div class="label">Sort By</div>
            <select class="select" id="clientSurveyFilterSort">
              <option value="patient_asc">Patient Name (A-Z)</option>
              <option value="discharge_desc">Discharge Date (Newest)</option>
              <option value="discharge_asc">Discharge Date (Oldest)</option>
            </select>
          </div>
          <div>
            <div class="label">Discharge Date From</div>
            <input class="input" id="clientSurveyFilterDischargeFrom" type="date" />
          </div>
          <div>
            <div class="label">Discharge Date To</div>
            <input class="input" id="clientSurveyFilterDischargeTo" type="date" />
          </div>
        </div>

        <div style="height:12px"></div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button class="btn primary" id="clientSurveyApplyFilters">Apply Filters</button>
          <button class="btn" id="clientSurveyClearFilters">Clear</button>
          <div class="mini" id="clientSurveyFilterMsg"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- =========================
       CLIENT SURVEYS EMAIL MODAL
  ========================= -->
  <div class="modal-backdrop" id="clientSurveysEmailModalBackdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="clientSurveysEmailModalTitle">
      <div class="modal-hd">
        <div>
          <h3 class="modal-title" id="clientSurveysEmailModalTitle">Email Client Surveys</h3>
          <div class="modal-sub">Send the filtered survey list to the selected facility contacts.</div>
        </div>
                <button class="xbtn" id="closeClientSurveysEmailModal" aria-label="Close">
          <svg viewBox="0 0 183.48 183.48" aria-hidden="true"><defs>
            <style>
              .cls-1 {
                fill: none;
                stroke: #121212;
                stroke-linecap: round;
                stroke-miterlimit: 10;
                stroke-width: 5.5px;
              }
            </style>
          </defs>
          <g>
            <g>
              <line class="cls-1" x1="180.73" y1="2.75" x2="2.75" y2="180.73"/>
              <line class="cls-1" x1="180.73" y1="180.73" x2="2.75" y2="2.75"/>
            </g>
          </g></svg>
        </button>
      </div>

      <div class="modal-body">
        <div class="label">Recipients</div>
        <textarea class="input" id="clientSurveyEmailRecipients" rows="4" placeholder="Enter email addresses separated by commas."></textarea>
        <div class="smallhint" style="margin-top:6px">Email uses the current filters and expires in 30 days.</div>

        <div style="height:12px"></div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn primary" id="clientSurveySendEmailBtn">Send Email</button>
          <div class="mini" id="clientSurveyEmailMsg"></div>
        </div>
      </div>
    </div>
  </div>
<!-- =========================
       CLIENT SURVEY DETAILS MODAL
  ========================= -->
  <div class="modal-backdrop" id="clientSurveyDetailsModalBackdrop">
    <div class="modal" style="max-width:980px;width:min(980px,96vw);" role="dialog" aria-modal="true" aria-labelledby="clientSurveyDetailsModalTitle">
      <div class="modal-hd">
        <div>
          <h3 class="modal-title" id="clientSurveyDetailsModalTitle">Survey Details</h3>
          <div class="modal-sub">Review the original comments and edit the AI summary.</div>
        </div>
                <button class="xbtn" id="closeClientSurveyDetailsModal" aria-label="Close">
          <svg viewBox="0 0 183.48 183.48" aria-hidden="true"><defs>
            <style>
              .cls-1 {
                fill: none;
                stroke: #121212;
                stroke-linecap: round;
                stroke-miterlimit: 10;
                stroke-width: 5.5px;
              }
            </style>
          </defs>
          <g>
            <g>
              <line class="cls-1" x1="180.73" y1="2.75" x2="2.75" y2="180.73"/>
              <line class="cls-1" x1="180.73" y1="180.73" x2="2.75" y2="2.75"/>
            </g>
          </g></svg>
        </button>
      </div>

      <div class="modal-body">
        <div class="stack" style="gap:12px">
          <div style="display:grid;grid-template-columns:repeat(6, minmax(0,1fr));gap:10px">
            <div>
              <div class="label">Patient</div>
              <div class="mini" id="clientSurveyPatient">—</div>
            </div>
            <div>
              <div class="label">Agency</div>
              <div class="mini" id="clientSurveyAgency">—</div>
            </div>
            <div>
              <div class="label">Admission Date</div>
              <div class="mini" id="clientSurveyAdmit">—</div>
            </div>
            <div>
              <div class="label">Discharge Date</div>
              <div class="mini" id="clientSurveyDischarge">—</div>
            </div>
            <div>
              <div class="label">Updated</div>
              <div class="mini" id="clientSurveyUpdated">—</div>
            </div>
            <div>
              <div class="label">Overall Score</div>
              <div class="mini" id="clientSurveyScore">—</div>
            </div>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div>
              <div class="label">Original General Comments</div>
              <textarea class="input survey-textarea" id="clientSurveyOriginalComments" rows="13" readonly></textarea>
            </div>
            <div>
              <div class="label">AI Summary (editable override)</div>
              <textarea class="input survey-textarea" id="clientSurveySummaryOverride" rows="13" placeholder="Edit summary override."></textarea>
            </div>
          </div>

          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn primary" id="clientSurveySaveSummary">Save Summary</button>
            <div class="mini" id="clientSurveyDetailMsg"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- =========================
       BULK UPLOAD MODAL (Reusable)
  ========================= -->
<div class="modal-backdrop" id="bulkModalBackdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="bulkModalTitle">
    <div class="modal-hd">
      <div>
        <h3 class="modal-title" id="bulkModalTitle">Bulk Upload</h3>
        <div class="modal-sub" id="bulkModalSub">Download a template, then upload your CSV.</div>
      </div>
      <button class="xbtn" id="closeBulkModal" aria-label="Close">✕</button>
    </div>

    <div class="modal-body">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <button class="btn" id="downloadTemplateBtn">Download CSV Template</button>
        <div class="smallhint" id="bulkEntityHint"></div>
      </div>

      <div style="height:12px"></div>

      <div class="dropzone" id="dropzone">
        <div style="font-weight:900;color:var(--navy)">Drag &amp; drop CSV here</div>
        <div class="smallhint">Or click to select a file. Headers must match the template.</div>

        <input type="file" id="bulkFileInput" accept=".csv,text/csv" style="display:none" />
        <button class="btn primary" id="chooseFileBtn">Choose CSV File</button>

        <div class="smallhint" id="bulkFileName" style="margin-top:6px;"></div>
      </div>

      <!-- explicit submit BELOW the dotted dropzone -->
      <div style="height:10px"></div>
      <button class="btn primary" id="bulkSubmitBtn" disabled>Process CSV</button>

      <div style="height:12px"></div>

      <div id="bulkMsg" class="toast"></div>
    </div>
  </div>
</div>
<!-- ✅ Service modal -->
<div id="serviceModalBackdrop" class="modal-backdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="serviceModalTitle">
    <div class="modal-hd">
      <div>
        <h3 class="modal-title" id="serviceModalTitle">Edit Service</h3>
        <div class="modal-sub">service_id: <b id="selServiceId">—</b></div>
      </div>
      <button class="xbtn" id="closeServiceModal" aria-label="Close">✕</button>
    </div>

    <div class="modal-body">
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <input id="svc_id" type="hidden" />
        <div style="flex:1;min-width:240px;">
          <div class="label">Name</div>
          <input id="svc_name" class="input" placeholder="Service name" />
        </div>
        <div style="width:180px;">
          <div class="label">Type</div>
          <select id="svc_type" class="input">
            <option value="">Loading…</option>
          </select>
        </div>
        <div style="width:160px;">
          <div class="label">Show in dropdown</div>
          <select id="svc_dropdown" class="input">
            <option value="1">Yes</option>
            <option value="0">No</option>
          </select>
        </div>
      </div>

      <div id="svcMsg" class="toast"></div>

      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px;">
        <button id="saveServiceBtn" class="btn primary">Save Service</button>
      </div>
    </div>
  </div>
</div>
<!-- ✅ Service Type modal -->
<div id="serviceTypeModalBackdrop" class="modal-backdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="serviceTypeModalTitle">
    <div class="modal-hd">
      <div>
        <h3 class="modal-title" id="serviceTypeModalTitle">Edit Service Type</h3>
        <div class="modal-sub">service_type_id: <b id="selServiceTypeId">—</b></div>
      </div>
      <button class="xbtn" id="closeServiceTypeModal" aria-label="Close">✕</button>
    </div>

    <div class="modal-body">
      <input id="st_id" type="hidden" />

      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <div style="flex:1;min-width:240px;">
          <div class="label">Name</div>
          <input id="st_name" class="input" placeholder="Example: Home Health" />
        </div>

        <div style="width:220px;">
          <div class="label">Code (short)</div>
          <input id="st_code" class="input" placeholder="Example: HH" />
        </div>

        <div style="width:160px;">
          <div class="label">Active</div>
          <select id="st_active" class="input">
            <option value="1">Yes</option>
            <option value="0">No</option>
          </select>
        </div>
      </div>

      <div id="stMsg" class="toast"></div>

      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px;">
        <button id="saveServiceTypeBtn" class="btn primary">Save Type</button>
      </div>
    </div>
  </div>
</div>

<!-- ✅ Care Team modal -->
<div id="careTeamModalBackdrop" class="modal-backdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="careTeamModalTitle">
    <div class="modal-hd">
      <div>
        <h3 class="modal-title" id="careTeamModalTitle">Edit Care Team</h3>
        <div class="modal-sub">care_team_id: <b id="selCareTeamId">—</b></div>
      </div>
      <button class="xbtn" id="closeCareTeamModal" aria-label="Close">✕</button>
    </div>

    <div class="modal-body">
      <input id="ct_id" type="hidden" />

      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <div style="flex:1;min-width:240px;">
          <div class="label">Name</div>
          <input id="ct_name" class="input" placeholder="Full name" />
        </div>
        <div style="width:220px;">
          <div class="label">Type</div>
          <input id="ct_type" class="input" placeholder="PT / OT / MD / SW..." />
        </div>
        <div style="width:180px;">
          <div class="label">NPI</div>
          <input id="ct_npi" class="input" placeholder="NPI" />
        </div>
        <div style="width:160px;">
          <div class="label">Active</div>
          <select id="ct_active" class="input">
            <option value="1">Yes</option>
            <option value="0">No</option>
          </select>
        </div>
      </div>

      <div id="ctMsg" class="toast"></div>

      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px;">
        <button id="saveCareTeamBtn" class="btn primary">Save Care Team</button>
      </div>
    </div>
  </div>
</div>
<!-----------------------Note Template modal------------------------------->
<div id="noteTplModalBackdrop" class="modal-backdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="noteTplModalTitle">
    <div class="modal-hd">
      <div>
        <h3 class="modal-title" id="noteTplModalTitle">Note Template</h3>
        <div class="modal-sub">Create/edit a note type.</div>
      </div>
      <button class="xbtn" id="closeNoteTplModal" aria-label="Close">✕</button>
    </div>

    <div class="modal-body" style="max-height:78vh; overflow:auto; padding-bottom:16px;">
      <!-- (keep your existing body contents exactly as-is) -->
      <div class="grid2">
        <div>
          <label>Template Name</label>
          <input id="noteTplName" placeholder="e.g., DC Planning Note" />
        </div>

        <div>
          <label>Agencies (optional)</label>
          <div class="checkwrap">
            <input id="noteTplAgencySearch" class="checksearch" placeholder="Search agencies…" />
            <div id="noteTplAgencyChecklist" class="checklist" style="max-height:220px; overflow:auto;"></div>
            <div class="muted" style="margin-top:6px;">Leave blank = Global (all agencies)</div>
          </div>
        </div>
      </div>

      <div style="margin-top:10px;">
        <label>User Roles (optional)</label>
        <div class="checkwrap">
          <input id="noteTplRoleSearch" class="checksearch" placeholder="Search roles…" />
          <div id="noteTplRoleChecklist" class="checklist" style="max-height:220px; overflow:auto;"></div>
          <div class="muted" style="margin-top:6px;">Leave blank = Global (all roles)</div>
        </div>
      </div>

      <!-- ✅ NEW: Share With Roles (controls Share With dropdown options) -->
      <div style="margin-top:10px;">
        <label>Share With Roles (optional)</label>
        <div class="checkwrap">
          <input id="noteTplShareRoleSearch" class="checksearch" placeholder="Search roles for Share With…" />
          <div id="noteTplShareRoleChecklist" class="checklist" style="max-height:220px; overflow:auto;"></div>
          <div class="muted" style="margin-top:6px;">
            Leave blank = nobody appears in “Share With” dropdown.
          </div>
        </div>
      </div>

      <div class="grid2" style="margin-top:10px;">
        <div>
          <label>Active</label>
          <select id="noteTplActive">
            <option value="1">Yes</option>
            <option value="0">No</option>
          </select>
        </div>
        <div></div>
      </div>

      <div id="noteTplMsg" class="msg ok" style="margin-top:10px;"></div>

      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px;padding-top:12px;border-top:1px solid rgba(15,23,42,.08);">
        <button class="btn2" onclick="closeNoteTemplateModal()">Cancel</button>
        <button class="btn" onclick="saveNoteTemplate()">Save</button>
      </div>
    </div>
  </div>
</div>
<div id="noteFieldModalBackdrop" class="modal-backdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="noteFieldModalTitle">
    <div class="modal-hd">
      <div>
        <h3 class="modal-title" id="noteFieldModalTitle">Question / Field</h3>
        <div class="modal-sub">Create/edit a question for the selected template.</div>
      </div>
      <button class="xbtn" id="closeNoteFieldModal" aria-label="Close">✕</button>
    </div>

    <div class="modal-body">
      <!-- (keep your existing body contents exactly as-is) -->
      <div class="grid2">
        <div>
          <label>Field Key</label>
          <input id="noteFieldKey" placeholder="e.g., dc_barrier" />
        </div>
        <div>
          <label>Field Label</label>
          <input id="noteFieldLabel" placeholder="e.g., Biggest barrier to DC?" />
        </div>
      </div>

      <div class="grid2" style="margin-top:10px;">
        <div>
          <label>Type</label>
          <select id="noteFieldType">
            <option value="text">text</option>
            <option value="textarea">textarea</option>
            <option value="number">number</option>
            <option value="date">date</option>
            <option value="boolean">boolean</option>
            <option value="select">select</option>
          </select>
        </div>
        <div>
          <label>Sort Order</label>
          <input id="noteFieldOrder" placeholder="0" />
        </div>
      </div>

      <div class="grid2" style="margin-top:10px;">
        <div>
          <label>Required</label>
          <select id="noteFieldRequired">
            <option value="0">No</option>
            <option value="1">Yes</option>
          </select>
        </div>
        <div>
          <label>Options JSON (select only)</label>
          <input id="noteFieldOptions" placeholder='["Yes","No","Maybe"]' />
        </div>
      </div>

      <div id="noteFieldMsg" class="msg ok" style="margin-top:10px;"></div>

      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px;">
        <button class="btn2" onclick="closeNoteFieldModal()">Cancel</button>
        <button class="btn" onclick="saveNoteField()">Save</button>
      </div>
    </div>
  </div>
</div>
<!-- ✅ Notification Template modal -->
<div id="notifModalBackdrop" class="modal-backdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="notifModalTitle">
    <div class="modal-hd">
      <div>
        <h3 class="modal-title" id="notifModalTitle">Notification Template</h3>
        <div class="modal-sub">Configure subject + body for email/SMS/dashboard.</div>
      </div>
      <button class="xbtn" id="closeNotifModal" aria-label="Close">✕</button>
    </div>

    <div class="modal-body">
      <input id="notif_id" type="hidden" />

      <div class="label">Key (internal)</div>
      <input class="input" id="notif_key" placeholder="e.g. new_discharge" />

      <div style="height:10px"></div>

      <div class="label">Name (label shown in UI)</div>
      <input class="input" id="notif_name" placeholder="e.g. New Discharge" />

      <div style="height:10px"></div>

      <div class="label">Active</div>
      <select class="select" id="notif_active">
        <option value="1">Yes</option>
        <option value="0">No</option>
      </select>

      <div style="height:14px"></div>

      <div class="label">Email Subject</div>
      <input class="input" id="notif_email_subject" placeholder="Subject line..." />

      <div style="height:10px"></div>

      <div class="label">Email Body (text or HTML)</div>
      <textarea class="input" id="notif_email_body" style="min-height:140px;"></textarea>

      <div style="height:10px"></div>

      <div class="label">Email HTML (optional)</div>
      <textarea class="input" id="notif_email_html" style="min-height:140px;" placeholder="Optional: if provided, email can use this HTML body."></textarea>

      <div style="height:10px"></div>

      <div class="label">SMS Body</div>
      <textarea class="input" id="notif_sms_body" style="min-height:90px;"></textarea>

      <div style="height:10px"></div>

      <div class="label">Dashboard Body</div>
      <textarea class="input" id="notif_dash_body" style="min-height:90px;"></textarea>

      <div id="notifModalMsg" class="toast"></div>

      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px;">
        <button class="btn" id="saveNotifBtn">Save</button>
      </div>
    </div>
  </div>
</div>
<!-- =========================
     PDW Prefs Modal (Agency)
========================= -->
<div class="modal-backdrop" id="pdwPrefsModalBackdrop">
  <div class="modal" style="max-width:820px;width:calc(100% - 28px);">
    <div class="modal-hd" style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px; padding:14px 16px 10px 16px;">
      <div>
        <div style="font-weight:1000;font-size:16px;">PDW Preferences</div>
        <div class="hint" id="pdwPrefsSub" style="margin-top:4px;">—</div>
      </div>
      <button class="iconbtn" onclick="closePdwPrefsModal()">✕</button>
    </div>

    <div class="modal-bd" style="padding:16px 16px 14px 16px;">
      <div class="grid" style="grid-template-columns: 1fr 1fr; gap:12px;">
        <div>
          <label class="lbl">Attempts Expected (default 2)</label>
          <input class="input" id="pdw_attempts_expected" type="number" min="1" step="1" />
          <div class="hint">Used to set “Attempts: x / y” on PDW work items.</div>
        </div>

        <div style="padding:10px;border:1px solid #eef0f5;border-radius:14px;background:#fafbff;">
          <div style="font-weight:900;font-size:12px;margin-bottom:8px;">Task Logic (per agency)</div>
          <label style="display:flex;gap:8px;align-items:center;font-size:12px;">
            <input type="checkbox" id="pdw_enable_48h" /> Enable 48hr Call
          </label>
          <label style="display:flex;gap:8px;align-items:center;font-size:12px;margin-top:6px;">
            <input type="checkbox" id="pdw_enable_15d" /> Enable 15 Day Call
          </label>
          <label style="display:flex;gap:8px;align-items:center;font-size:12px;margin-top:6px;">
            <input type="checkbox" id="pdw_enable_30d" /> Enable 30 Day Call
          </label>
          <div class="hint" style="margin-top:8px;">
            Example: 48h + 30d only → uncheck 15d, keep 30d checked.
          </div>
        </div>
      </div>

      <div style="margin-top:12px;">
        <label class="lbl">Agency Preference Details</label>
        <textarea class="input" id="pdw_pref_details" rows="5" placeholder="Multiline notes for this agency’s PDW preferences…"></textarea>
      </div>

      <div id="pdwPrefsMsg" class="toast" style="margin-top:10px;"></div>
    </div>

    <div class="modal-ft" style="display:flex;justify-content:flex-end;gap:10px; padding:0 16px 16px 16px; border-top:1px solid rgba(15,23,42,.06);">
      <button class="btn" onclick="closePdwPrefsModal()">Cancel</button>
      <button class="btn primary" id="savePdwPrefsBtn">Save PDW Prefs</button>
    </div>
  </div>
</div>

<script>
  const $ = (id) => document.getElementById(id);

  // ✅ Prevent browser from trying to open/save the file when dragged over the page
  document.addEventListener("dragover", (e) => e.preventDefault());
  document.addEventListener("drop", (e) => e.preventDefault());

  function openServiceModal(service){
    $("svc_id").value = service ? String(service.id || "") : "";
    $("selServiceId").textContent = service && service.id ? String(service.id) : "—";
    $("svc_name").value = service ? (service.name || "") : "";
    $("svc_type").value = service ? (service.service_type || "dme") : "dme";
    $("svc_dropdown").value = service ? String(service.dropdown ? 1 : 0) : "1";
    setMsg($("svcMsg"), "", true);
    $("serviceModalBackdrop").classList.add("on");
  }
  function closeServiceModal(){ $("serviceModalBackdrop").classList.remove("on"); }
  $("closeServiceModal").onclick = closeServiceModal;

  $("saveServiceBtn").onclick = async () => {
    try{
      const payload = {
        id: $("svc_id").value ? Number($("svc_id").value) : null,
        name: ($("svc_name").value || "").trim(),
        service_type_id: Number($("svc_type").value || 0),
        dropdown: Number($("svc_dropdown").value || 1)
      };
      await apiPost("/api/sensys/admin/services/upsert", payload);
      await refreshServicesList();
      setMsg($("servicesListMsg"), "Service saved.", true);
      closeServiceModal();
    }catch(e){
      setMsg($("svcMsg"), String(e.message || e), false);
    }
  };

  function $safe(id){
    return document.getElementById(id);
  }
  function onClickSafe(id, fn){
    const el = $safe(id);
    if(!el){
      console.warn("Missing element id:", id);
      return;
    }
    el.onclick = fn;
  }

  function openCareTeamModal(row){
    $("ct_id").value = row ? String(row.id || "") : "";
    $("selCareTeamId").textContent = row && row.id ? String(row.id) : "—";
    $("ct_name").value = row ? (row.name || "") : "";
    $("ct_type").value = row ? (row.type || "") : "";
    $("ct_npi").value = row ? (row.npi || "") : "";
    $("ct_active").value = row ? String(row.active ? 1 : 0) : "1";
    setMsg($("ctMsg"), "", true);
    $("careTeamModalBackdrop").classList.add("on");
  }
  function closeCareTeamModal(){ $("careTeamModalBackdrop").classList.remove("on"); }
  $("closeCareTeamModal").onclick = closeCareTeamModal;

  $("saveCareTeamBtn").onclick = async () => {
    try{
      const payload = {
        id: $("ct_id").value ? Number($("ct_id").value) : null,
        name: ($("ct_name").value || "").trim(),
        type: ($("ct_type").value || "").trim(),
        npi: ($("ct_npi").value || "").trim(),
        active: Number($("ct_active").value || 1)
      };
      await apiPost("/api/sensys/admin/care-team/upsert", payload);
      await refreshCareTeamList();
      closeCareTeamModal();
    }catch(e){
      setMsg($("ctMsg"), String(e.message || e), false);
    }
  };

  function openUserModal(){
    $("userModalBackdrop").classList.add("on");
  }
  function closeUserModal(){
    $("userModalBackdrop").classList.remove("on");
  }

  function openAgencyModal(){
    $("agencyModalBackdrop").classList.add("on");
  }
  function closeAgencyModal(){
    $("agencyModalBackdrop").classList.remove("on");
  }

  // Close when clicking the dark backdrop
  $("userModalBackdrop").addEventListener("click", (e) => {
    if(e.target.id === "userModalBackdrop") closeUserModal();
  });
  $("agencyModalBackdrop").addEventListener("click", (e) => {
    if(e.target.id === "agencyModalBackdrop") closeAgencyModal();
  });

  // ✅ ADD: close services + care team when clicking the dark backdrop
  $("serviceModalBackdrop").addEventListener("click", (e) => {
    if(e.target.id === "serviceModalBackdrop") closeServiceModal();
  });
  $("careTeamModalBackdrop").addEventListener("click", (e) => {
    if(e.target.id === "careTeamModalBackdrop") closeCareTeamModal();
  });

  // Close buttons
  $("closeUserModal").onclick = closeUserModal;
  $("closeAgencyModal").onclick = closeAgencyModal;

  // ESC key closes whichever modal is open
  document.addEventListener("keydown", (e) => {
    if(e.key !== "Escape") return;
    closeUserModal();
      closeAgencyModal();
      closePatientModal();
      closeAdmissionModal();
      closeClientSurveysSettingsModal();
      closeClientSurveysUploadModal();
      closeClientSurveysFilterModal();
      closeClientSurveyDetailsModal();
      closeServiceModal();
    closeCareTeamModal();
    closeBulkModal();
  });

  // -----------------------------
  // Agency PDW Prefs modal
  // -----------------------------
  let pdwPrefsAgencyId = null;

  function openPdwPrefsModal(agencyId){
    pdwPrefsAgencyId = Number(agencyId);

    const a = (agenciesCache || []).find(x => Number(x.id) === pdwPrefsAgencyId);
    $("pdwPrefsSub").textContent = a ? `${a.agency_name || "—"} (Agency #${a.id})` : `Agency #${pdwPrefsAgencyId}`;
    setMsg($("pdwPrefsMsg"), "", true);

    $("pdw_attempts_expected").value = String(a?.pdw_attempts_expected ?? 2);
    $("pdw_pref_details").value = a?.pdw_pref_details ?? "";

    $("pdw_enable_48h").checked = String(a?.pdw_enable_48h ?? 1) === "1";
    $("pdw_enable_15d").checked = String(a?.pdw_enable_15d ?? 1) === "1";
    $("pdw_enable_30d").checked = String(a?.pdw_enable_30d ?? 1) === "1";

    $("pdwPrefsModalBackdrop").classList.add("on");
  }

  function closePdwPrefsModal(){
    $("pdwPrefsModalBackdrop").classList.remove("on");
  }

  $("pdwPrefsModalBackdrop").addEventListener("click", (e) => {
    if(e.target.id === "pdwPrefsModalBackdrop") closePdwPrefsModal();
  });

  $("savePdwPrefsBtn").onclick = async () => {
    try{
      const a = (agenciesCache || []).find(x => Number(x.id) === Number(pdwPrefsAgencyId));
      if(!a) throw new Error("Agency not found in cache.");

      const attempts = parseInt(($("pdw_attempts_expected").value || "2"), 10) || 2;

      // ✅ send ONLY PDW fields + required agency fields; do NOT touch preferred providers
      const payload = {
        id: Number(a.id),
        agency_name: a.agency_name,
        agency_type: a.agency_type,
        aliases: a.aliases || "",
        facility_code: a.facility_code || "",
        carecompare_ccn: a.carecompare_ccn || "",
        address: a.address || "",
        city: a.city || "",
        state: a.state || "",
        zip: a.zip || "",
        phone1: a.phone1 || "",
        phone2: a.phone2 || "",
        email: a.email || "",
        fax: a.fax || "",
        notes: a.notes || "",
        notes2: a.notes2 || "",
        evolv_client: !!a.evolv_client,

        preferred_provider_ids: null, // ✅ critical: do not clear preferred providers

        pdw_attempts_expected: attempts,
        pdw_pref_details: ($("pdw_pref_details").value || ""),
        pdw_enable_48h: $("pdw_enable_48h").checked ? 1 : 0,
        pdw_enable_15d: $("pdw_enable_15d").checked ? 1 : 0,
        pdw_enable_30d: $("pdw_enable_30d").checked ? 1 : 0,
      };

      await apiPost("/api/sensys/admin/agencies/upsert", payload);

      setMsg($("pdwPrefsMsg"), "Saved.", true);
      await refreshAgenciesList();  // reload so the cache includes new prefs
      closePdwPrefsModal();

    }catch(e){
      setMsg($("pdwPrefsMsg"), String(e.message || e), false);
    }
  };

  function getToken(){
    // ✅ Back-compat: accept either key (some tabs/older pages used ADMIN_TOKEN)
    const live = ($("token") && $("token").value) ? $("token").value : "";
    const t = (live || localStorage.getItem("SENSYS_ADMIN_TOKEN") || localStorage.getItem("ADMIN_TOKEN") || "").trim();

    // ✅ If we found a token under the old key, normalize it so every tab works
    if(t){
      localStorage.setItem("SENSYS_ADMIN_TOKEN", t);
      localStorage.setItem("ADMIN_TOKEN", t);
      if($("token")) $("token").value = t;
    }
    return t;
  }

  function getTokenOrThrow(){
    const t = getToken();
    if(!t) throw new Error("Missing ADMIN_TOKEN (paste it top-right, click Save)");
    return t;
  }
  
  function setMsg(el, text, ok=true){
    el.className = "toast " + (ok ? "ok" : "err");
    el.textContent = text || "";
  }

  let rolesMaster = [];
  let usersCache = [];
  let selectedUserId = null;
  let selectedRoleKeys = new Set();
  
  let notificationsMaster = []; // admin-defined notification templates
  let selectedUserNotifPrefs = []; 

  let agenciesMaster = [];
  let selectedAgencyIds = new Set();

  let agenciesCache = [];
  let selectedAgencyId = null;
  
  let selectedEsignLinkIds = new Set();
  
  let selectedPreferredProviderIds = new Set();

  function renderAgencyChecklist(){
    const wrap = $("agencyChecklist");
    const q = ($("agencySearch").value || "").trim().toLowerCase();
    wrap.innerHTML = "";

    const items = (agenciesMaster || []).filter(a => {
      const hay = `${a.agency_name || ""} ${a.agency_type || ""} ${a.city || ""} ${a.state || ""}`.toLowerCase();
      return !q || hay.includes(q);
    });

    items.forEach(a => {
      const row = document.createElement("div");
      row.className = "checkrow";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = selectedAgencyIds.has(a.id);
      cb.onchange = () => {
        if(cb.checked) selectedAgencyIds.add(a.id);
        else selectedAgencyIds.delete(a.id);
      };

      const label = document.createElement("div");
      const locRaw =
        (a.city || a.state)
          ? (String(a.city || "") + (a.city && a.state ? ", " : "") + String(a.state || ""))
          : "";

      const evolvTag = a.evolv_client ? " (Evolv Client)" : "";
      const metaParts = [
        `${escapeHtml(a.agency_type || "")}${evolvTag}`,
        (locRaw ? escapeHtml(locRaw) : "")
      ].filter(Boolean);

      label.innerHTML = `
        <b>${escapeHtml(a.agency_name || "")}</b>
        <span class="agmeta"> — ${metaParts.join(" • ")}</span>
      `;

      row.appendChild(cb);
      row.appendChild(label);
      wrap.appendChild(row);
    });
  }

  function renderPreferredProvidersChecklist(){
    const wrap = $("preferredProvidersChecklist");
    if(!wrap) return;

    const q = ($("preferredProviderSearch").value || "").trim().toLowerCase();
    wrap.innerHTML = "";

    const items = (agenciesMaster || [])
      .filter(a => String(a.agency_type || "").toLowerCase() === "home health")
      .filter(a => !selectedAgencyId || Number(a.id) !== Number(selectedAgencyId))
      .filter(a => {
        const hay = `${a.agency_name || ""} ${a.city || ""} ${a.state || ""}`.toLowerCase();
        return !q || hay.includes(q);
      })
      .sort((a,b) => String(a.agency_name||"").localeCompare(String(b.agency_name||""), undefined, { sensitivity:"base" }));

    items.forEach(a => {
      const row = document.createElement("div");
      row.className = "checkrow";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = selectedPreferredProviderIds.has(a.id);
      cb.onchange = () => {
        if(cb.checked) selectedPreferredProviderIds.add(a.id);
        else selectedPreferredProviderIds.delete(a.id);
      };

      const label = document.createElement("div");
      const locRaw =
        (a.city || a.state)
          ? (String(a.city || "") + (a.city && a.state ? ", " : "") + String(a.state || ""))
          : "";

      label.innerHTML = `
        <b>${escapeHtml(a.agency_name || "")}</b>
        <span class="agmeta"> — ${escapeHtml(locRaw)}</span>
      `;

      row.appendChild(cb);
      row.appendChild(label);
      wrap.appendChild(row);
    });
  }

  async function loadPreferredProvidersForAgency(agencyId){
    selectedPreferredProviderIds = new Set();
    try{
      if(!agencyId) { renderPreferredProvidersChecklist(); return; }
      const resp = await apiGet(`/api/sensys/admin/agencies/${agencyId}/preferred-providers`);
      const ids = (resp && resp.provider_ids) || [];
      selectedPreferredProviderIds = new Set(ids.map(x => Number(x)));
    }catch(e){
      selectedPreferredProviderIds = new Set();
    }
    renderPreferredProvidersChecklist();
  }

  async function ensureNotificationsMasterLoaded(){
    if(Array.isArray(notificationsMaster) && notificationsMaster.length) return notificationsMaster;
    try{
      // BACKEND TO ADD IN SEGMENT 2:
      // GET /api/sensys/admin/notifications (or a non-admin endpoint if you prefer)
      const resp = await apiGet("/api/sensys/admin/notifications");
      notificationsMaster = (resp && resp.notifications) ? resp.notifications : [];
    }catch(e){
      notificationsMaster = [];
    }
    renderUserNotifSelectOptions();
    return notificationsMaster;
  }

  function renderUserNotifSelectOptions(){
    const sel = $("userNotifSelect");
    if(!sel) return;

    const opts = (notificationsMaster || []).filter(n => String(n.active||0)==="1");
    sel.innerHTML = ['<option value="">Select a notification…</option>']
      .concat(opts.map(n => `<option value="${escapeHtml(n.notif_key||"")}">${escapeHtml(n.name||n.notif_key||"")}</option>`))
      .join("");
  }

  function _prefLabelForKey(key){
    const n = (notificationsMaster || []).find(x => String(x.notif_key||"") === String(key||""));
    return (n && (n.name || n.notif_key)) ? (n.name || n.notif_key) : (key || "");
  }

  function renderUserNotifPrefs(){
    const host = $("userNotifList");
    if(!host) return;

    const prefs = (selectedUserNotifPrefs || []);
    if(!prefs.length){
      host.innerHTML = `<div class="hint">No notifications assigned.</div>`;
      return;
    }

    host.innerHTML = "";
    prefs.forEach((p, idx) => {
      const row = document.createElement("div");
      row.className = "notif-item";

      const left = document.createElement("div");
      left.innerHTML = `<b>${escapeHtml(_prefLabelForKey(p.notif_key))}</b><div class="mini">${escapeHtml(p.notif_key||"")}</div>`;

      const methods = [];
      if(Number(p.deliver_email||0)===1) methods.push("Email");
      if(Number(p.deliver_sms||0)===1) methods.push("SMS");
      if(Number(p.deliver_dashboard||0)===1) methods.push("Dashboard");

      const mid = document.createElement("div");
      mid.className = "notif-methods";
      mid.textContent = methods.length ? ("Methods: " + methods.join(" • ")) : "No methods";

      const x = document.createElement("button");
      x.className = "notif-x";
      x.textContent = "Remove";
      x.onclick = () => {
        selectedUserNotifPrefs = selectedUserNotifPrefs.filter((_, i) => i !== idx);
        renderUserNotifPrefs();
      };

      row.appendChild(left);
      row.appendChild(mid);
      row.appendChild(x);
      host.appendChild(row);
    });
  }

  $("addUserNotifBtn") && ($("addUserNotifBtn").onclick = (e) => {
    e.preventDefault();

    const key = ($("userNotifSelect").value || "").trim();
    if(!key) return;

    // ✅ store in backend-compatible shape
    const deliver_email = $("userNotifEmail").checked ? 1 : 0;
    const deliver_sms = $("userNotifSms").checked ? 1 : 0;
    const deliver_dashboard = $("userNotifDash").checked ? 1 : 0;

    const existingIdx = (selectedUserNotifPrefs || []).findIndex(x => String(x.notif_key) === String(key));
    const obj = { notif_key: key, deliver_email, deliver_sms, deliver_dashboard };

    if(existingIdx >= 0){
      selectedUserNotifPrefs[existingIdx] = obj;
    }else{
      selectedUserNotifPrefs = (selectedUserNotifPrefs || []).concat([obj]);
    }

    renderUserNotifPrefs();
  });

  function renderRolesPills(){
    const wrap = $("roles");
    wrap.innerHTML = "";
    rolesMaster.forEach(r => {
      const b = document.createElement("span");
      b.className = "tag " + (selectedRoleKeys.has(r.role_key) ? "on" : "");
      b.textContent = r.role_name;
      b.onclick = () => {
        if(selectedRoleKeys.has(r.role_key)) selectedRoleKeys.delete(r.role_key);
        else selectedRoleKeys.add(r.role_key);
        renderRolesPills();
        refreshProviderFieldsVisibility();
      };
      wrap.appendChild(b);
    });
  }

  function refreshProviderFieldsVisibility(){
    const on = selectedRoleKeys.has("provider");
    $("providerFields").style.display = on ? "" : "none";
  }

  function selectUser(u){
    selectedUserId = u.user_id;
    $("selId").textContent = String(u.user_id);
    $("email").value = u.email || "";
    $("display_name").value = u.display_name || "";
    $("is_active").value = String(u.is_active ?? 1);

    selectedRoleKeys = new Set(u.role_keys || []);
    renderRolesPills();

    $("cell_phone").value = u.cell_phone || "";
    $("password").value = ""; // never auto-fill password
    $("account_locked").value = String(u.account_locked ? 1 : 0);

    // ✅ Provider E-sign
    $("provider_npi").value = u.npi || "";
    selectedEsignLinkIds = new Set(u.esign_link_ids || []);

    // show immediate feedback while preloading
    const wrap = $("esignLinkChecklist");
    if(wrap) wrap.innerHTML = `<div class="hint">Loading care team…</div>`;

    // ✅ NEW: preload care team cache, then render checklist
    ensureCareTeamCacheLoaded().then(() => {
      renderEsignLinkChecklist();
    });

    refreshProviderFieldsVisibility();

    selectedAgencyIds = new Set(u.agency_ids || []);
    renderAgencyChecklist();

    setMsg($("editMsg"), "", true);

    // ✅ normalize server prefs into UI array using deliver_* keys
    selectedUserNotifPrefs = Array.isArray(u.notification_prefs) ? (u.notification_prefs || []).map(p => ({
      notif_key: p.notif_key,
      deliver_email: Number(p.deliver_email ?? p.email ?? 0),
      deliver_sms: Number(p.deliver_sms ?? p.sms ?? 0),
      deliver_dashboard: Number(p.deliver_dashboard ?? p.dashboard ?? 0),
    })) : [];
    ensureNotificationsMasterLoaded().then(() => {
      renderUserNotifSelectOptions();
      renderUserNotifPrefs();
    });

    // NEW: open modal
    openUserModal();
  }

  function renderEsignLinkChecklist(){
    const wrap = $("esignLinkChecklist");
    if(!wrap) return;

    const q = ($("esignLinkSearch").value || "").trim().toLowerCase();
    wrap.innerHTML = "";

    const items = (careTeamCache || []).filter(ct => {
      const hay = `${ct.name||""} ${ct.type||""} ${ct.npi||""}`.toLowerCase();
      return !q || hay.includes(q);
    });

    items.forEach(ct => {
      const row = document.createElement("div");
      row.className = "checkrow";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = selectedEsignLinkIds.has(ct.id);
      cb.onchange = () => {
        if(cb.checked) selectedEsignLinkIds.add(ct.id);
        else selectedEsignLinkIds.delete(ct.id);
      };

      const label = document.createElement("div");
      label.innerHTML = `<b>${escapeHtml(ct.name||"")}</b> <span class="agmeta">— ${escapeHtml(ct.type||"")}</span>`;

      row.appendChild(cb);
      row.appendChild(label);
      wrap.appendChild(row);
    });
  }

  async function loginAsUser(userId){
    try{
      const resp = await apiPost("/api/sensys/admin/users/login-as", { user_id: Number(userId) });
      if(!resp || !resp.ok) throw new Error((resp && resp.detail) ? resp.detail : "Login-as failed");

      const st = encodeURIComponent(resp.token || "");
      const r  = encodeURIComponent(resp.redirect_url || "/sensys/login");

      // Open a new tab that sets localStorage.sensys_token then redirects
      window.open(`/sensys/impersonate?st=${st}&r=${r}`, "_blank");
    }catch(e){
      alert(String(e.message || e));
    }
  }

  function renderUsersTable(){
    const tbody = $("tbody");
    tbody.innerHTML = "";

    usersCache.forEach(u => {
      const tr = document.createElement("tr");
      tr.style.cursor = "pointer";
      tr.onclick = () => selectUser(u);

      const roles = (u.role_keys || []).join(", ");

      const lastLogin = u.last_login_at
        ? new Date(u.last_login_at.replace(" ", "T") + "Z").toLocaleString()
        : "—";

      tr.innerHTML = `
        <td style="width:78px;">
          <button class="miniIconBtn"
                  title="Login as this user"
                  onclick="event.stopPropagation(); loginAsUser(${Number(u.user_id)})">
            🔑
          </button>
          <button class="miniIconBtn"
                  title="Copy this user"
                  onclick="event.stopPropagation(); startCopyUser(usersCache.find(x => Number(x.user_id)===${Number(u.user_id)}))">
            📄
          </button>
        </td>
        <td><b>${escapeHtml(u.email || "")}</b></td>
        <td>${escapeHtml(u.display_name || "")}</td>
        <td>${u.is_active ? "Yes" : "No"}</td>
        <td>${escapeHtml(roles)}</td>
        <td>${escapeHtml(lastLogin)}</td>
        <td>${u.account_locked ? "Yes" : "No"}</td>
      `;

      tbody.appendChild(tr);
    });
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  async function apiGet(path){
    const token = getToken();
    if(!token) throw new Error("Missing ADMIN_TOKEN (paste it top-right, click Save)");
    const url = path.includes("?") ? `${path}&token=${encodeURIComponent(token)}` : `${path}?token=${encodeURIComponent(token)}`;
    const res = await fetch(url);
    if(!res.ok) throw new Error(await res.text());
    return await res.json();
  }

  async function apiPost(path, payload){
    const token = getToken();
    if(!token) throw new Error("Missing ADMIN_TOKEN (paste it top-right, click Save)");
    const url = path.includes("?") ? `${path}&token=${encodeURIComponent(token)}` : `${path}?token=${encodeURIComponent(token)}`;
    const res = await fetch(url, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload || {})
    });
    if(!res.ok) throw new Error(await res.text());
    return await res.json();
  }

  async function apiUploadCsv(path, file){
    const token = getTokenOrThrow();
    const url = path.includes("?")
      ? `${path}&token=${encodeURIComponent(token)}` : `${path}?token=${encodeURIComponent(token)}`;

    const fd = new FormData();
    fd.append("file", file);

    const res = await fetch(url, { method:"POST", body: fd });
    if(!res.ok) throw new Error(await res.text());
    return await res.json();
  }

  async function refreshAll(){
    setMsg($("listMsg"), "Loading…", true);
    try{
      const rolesResp = await apiGet("/api/sensys/admin/roles");
      rolesMaster = rolesResp.roles || [];
      renderRolesPills();

      const agResp = await apiGet("/api/sensys/admin/agencies");
      agenciesMaster = agResp.agencies || [];
      renderAgencyChecklist();

      const usersResp = await apiGet("/api/sensys/admin/users");
      usersCache = usersResp.users || [];
      renderUsersTable();

      setMsg($("listMsg"), `Loaded ${usersCache.length} users.`, true);

    }catch(e){
      setMsg($("listMsg"), String(e.message || e), false);
    }
  }

  function startNewUser(){
    selectedUserId = null;
    $("selId").textContent = "—";
    $("email").value = "";
    $("display_name").value = "";
    $("is_active").value = "1";

    selectedRoleKeys = new Set();
    renderRolesPills();

    selectedAgencyIds = new Set();
    renderAgencyChecklist();

    $("cell_phone").value = "";
    $("password").value = "";
    $("account_locked").value = "0";

    // ✅ Provider E-sign
    $("provider_npi").value = "";
    selectedEsignLinkIds = new Set();
    renderEsignLinkChecklist();
    refreshProviderFieldsVisibility();

    setMsg($("editMsg"), "New user mode (Save User to create).", true);

    // ✅ NEW: notifications (new user starts empty)
    selectedUserNotifPrefs = [];
    ensureNotificationsMasterLoaded().then(() => {
      renderUserNotifSelectOptions();
      renderUserNotifPrefs();
    });

    openUserModal();
  }

  // ✅ NEW: copy an existing user into “new user” mode (blank email/name/phone)
  function startCopyUser(u){
    selectedUserId = null;
    $("selId").textContent = "—";

    // blank these 3 fields
    $("email").value = "";
    $("display_name").value = "";
    $("cell_phone").value = "";

    // keep active + locked the same as source
    $("is_active").value = String(u.is_active ? 1 : 0);
    $("account_locked").value = String(u.account_locked ? 1 : 0);

    // password always blank
    $("password").value = "";

    // copy roles
    selectedRoleKeys = new Set(u.role_keys || []);
    renderRolesPills();

    // copy agencies
    selectedAgencyIds = new Set(u.agency_ids || []);
    renderAgencyChecklist();

    // copy provider e-sign settings (keep NPI + link ids)
    $("provider_npi").value = u.npi || "";
    selectedEsignLinkIds = new Set(u.esign_link_ids || []);
    refreshProviderFieldsVisibility();

    // copy notifications
    selectedUserNotifPrefs = Array.isArray(u.notification_prefs)
      ? (u.notification_prefs || []).map(p => ({
          notif_key: p.notif_key,
          deliver_email: Number(p.deliver_email ?? p.email ?? 0),
          deliver_sms: Number(p.deliver_sms ?? p.sms ?? 0),
          deliver_dashboard: Number(p.deliver_dashboard ?? p.dashboard ?? 0),
        }))
      : [];

    // preload + render UI bits that depend on caches
    const wrap = $("esignLinkChecklist");
    if(wrap) wrap.innerHTML = `<div class="hint">Loading care team…</div>`;
    ensureCareTeamCacheLoaded().then(() => renderEsignLinkChecklist());

    ensureNotificationsMasterLoaded().then(() => {
      renderUserNotifSelectOptions();
      renderUserNotifPrefs();
    });

    setMsg($("editMsg"), "Copy mode: fill Email + Name (and optionally phone), then Save User.", true);
    openUserModal();
  }

  // NEW: top-right icon
  $("addUserIcon").onclick = startNewUser;

  $("bulkUsersIcon").onclick = () => openBulkModal("users");
  $("bulkAgenciesIcon").onclick = () => openBulkModal("agencies");
  $("bulkPatientsIcon").onclick = () => openBulkModal("patients");
  $("bulkAdmissionsIcon").onclick = () => openBulkModal("admissions");
  $("bulkServicesIcon").onclick = () => openBulkModal("services");
  $("bulkCareTeamIcon").onclick = () => openBulkModal("care-team");
  $("addServiceIcon").onclick = () => openServiceModal(null);
  $("addCareTeamIcon").onclick = () => openCareTeamModal(null);

  $("saveUser").onclick = async () => {
    try{
      setMsg($("editMsg"), "Saving…", true);

      // ✅ Single payload (includes notification_prefs so it persists)
      const payload = {
        user_id: selectedUserId,
        email: ($("email").value || "").trim(),
        display_name: ($("display_name").value || "").trim(),
        is_active: parseInt($("is_active").value, 10),

        cell_phone: ($("cell_phone").value || "").trim(),
        password: ($("password").value || "").trim(), // blank = keep unchanged (backend handles)
        account_locked: $("account_locked").value === "1",
        npi: ($("provider_npi").value || "").trim(),

        // ✅ persist notification prefs via /users/upsert
        notification_prefs: (selectedUserNotifPrefs || []).map(p => ({
          notif_key: p.notif_key,
          deliver_email: Number(p.deliver_email ?? p.email ?? 0),
          deliver_sms: Number(p.deliver_sms ?? p.sms ?? 0),
          deliver_dashboard: Number(p.deliver_dashboard ?? p.dashboard ?? 0),
        }))
      };

      // 1) Save core user (backend returns user_id)
      const upsertResp = await apiPost("/api/sensys/admin/users/upsert", payload);
      selectedUserId = upsertResp.user_id;
      $("selId").textContent = String(selectedUserId);

      // 2) Save roles
      await apiPost("/api/sensys/admin/users/set-roles", {
        user_id: selectedUserId,
        role_keys: Array.from(selectedRoleKeys)
      });

      // 3) Save agencies
      await apiPost("/api/sensys/admin/users/set-agencies", {
        user_id: selectedUserId,
        agency_ids: Array.from(selectedAgencyIds)
      });

      // 4) Provider E-sign links (only if Provider role selected)
      if(selectedRoleKeys.has("provider")){
        await apiPost("/api/sensys/admin/users/set-esign-links", {
          user_id: selectedUserId,
          care_team_ids: Array.from(selectedEsignLinkIds)
        });
      }

      setMsg($("editMsg"), "Saved.", true);

      // refresh the list so the table updates immediately
      await refreshAll();

      closeUserModal();
    }catch(e){
      setMsg($("editMsg"), String(e.message || e), false);
    }
  };

  $("saveToken").onclick = async () => {
    const t = ($("token").value || "").trim();
    if(!t){
      alert("Paste ADMIN_TOKEN first, then click Save.");
      return;
    }

    // ✅ Write both keys so every tab/page/version reads the same value
    localStorage.setItem("SENSYS_ADMIN_TOKEN", t);
    localStorage.setItem("ADMIN_TOKEN", t);
    $("token").value = t;

    // optional: give visual feedback in the existing Users list toast
    setMsg($("listMsg"), "Token saved. Refreshing…", true);

    try{
      await refreshAll();
    }catch(e){
      setMsg($("listMsg"), String(e.message || e), false);
    }
  };

  // Refresh button (top-right) — was missing, so it did nothing
  $("refresh").onclick = async () => {
    try{
      setMsg($("listMsg"), "Refreshing…", true);
      await refreshAll();
    }catch(e){
      setMsg($("listMsg"), String(e.message || e), false);
    }
  };

  // load saved token on open
  $("token").value = localStorage.getItem("SENSYS_ADMIN_TOKEN") || localStorage.getItem("ADMIN_TOKEN") || "";


  $("agencySearch").addEventListener("input", renderAgencyChecklist);
  $("preferredProviderSearch").addEventListener("input", renderPreferredProvidersChecklist);
  $("esignLinkSearch").addEventListener("input", renderEsignLinkChecklist);


  // -----------------------------
  // Notes Subtabs (Templates vs DC Note)
  // -----------------------------
  let notesSubtabKey = "notes"; // "notes" | "dc"

  function renderNotesSubtabs(){
    const wrap = $("notesSubtabs");
    if(!wrap) return;

    const tabs = [
      { key:"notes", label:"Notes" },
      { key:"dc", label:"DC Note" }
    ];

    wrap.innerHTML = "";
    tabs.forEach(t => {
      const pill = document.createElement("span");
      pill.className = "tag " + (notesSubtabKey === t.key ? "on" : "");
      pill.textContent = t.label;

      pill.onclick = () => {
        notesSubtabKey = t.key;
        renderNotesSubtabs();
        showNotesSubtab();
      };

      wrap.appendChild(pill);
    });
  }

  function showNotesSubtab(){
    // toggle internal panels
    const main = $("notesTabMain");
    const dc = $("notesTabDc");
    if(!main || !dc) return;

    main.classList.remove("on");
    dc.classList.remove("on");

    if(notesSubtabKey === "dc"){
      dc.classList.add("on");
      // ensure DC list is fresh when user flips to it
      refreshDcNoteTemplatesAdmin();
    }else{
      main.classList.add("on");
      // ensure Note templates/questions list is fresh when user flips back
      refreshNoteTemplatesAdmin();
    }
  }

  function showPanel(which){
    // nav highlighting
    $("tabUsers").className = "navitem " + (which==="users" ? "on" : "");
    $("tabAgencies").className = "navitem " + (which==="agencies" ? "on" : "");
      $("tabProviderLibrary").className = "navitem " + (which==="providerLibrary" ? "on" : "");
      $("tabPatients").className = "navitem " + (which==="patients" ? "on" : "");
      $("tabAdmissions").className = "navitem " + (which==="admissions" ? "on" : "");
      $("tabClientSurveys").className = "navitem " + (which==="clientSurveys" ? "on" : "");
      $("tabServices").className = "navitem " + (which==="services" ? "on" : "");
    $("tabCareTeam").className = "navitem " + (which==="careTeam" ? "on" : "");
    $("tabNotes").className = "navitem " + (which==="notes" ? "on" : "");
    $("tabNotifications").className = "navitem " + (which==="notifications" ? "on" : "");

    // hide all panels
    $("panelUsers").classList.remove("on");
    $("panelAgencies").classList.remove("on");
      $("panelProviderLibrary").classList.remove("on");
      $("panelPatients").classList.remove("on");
      $("panelAdmissions").classList.remove("on");
      $("panelClientSurveys").classList.remove("on");
      $("panelServices").classList.remove("on");
    $("panelCareTeam").classList.remove("on");
    $("panelNotes").classList.remove("on");
    $("panelNotifications").classList.remove("on");

    if(which==="users"){
      $("panelUsers").classList.add("on");
    }else if(which==="agencies"){
      $("panelAgencies").classList.add("on");
      refreshAgenciesList();
    }else if(which==="providerLibrary"){
      $("panelProviderLibrary").classList.add("on");
      loadProviderLibraryMeta();
      runProviderLibrarySearch(); // will load first 200 when blank
    }else if(which==="patients"){
      $("panelPatients").classList.add("on");
      refreshPatientsList();
      }else if(which==="admissions"){
        $("panelAdmissions").classList.add("on");
        refreshAdmissionsList();
    }else if(which==="clientSurveys"){
      $("panelClientSurveys").classList.add("on");
      refreshClientSurveysList();
    }else if(which==="services"){
        $("panelServices").classList.add("on");

      // ✅ ensure both lists are loaded
      refreshServiceTypes();   // fills serviceTypesCache + svc_type dropdown
      refreshServicesList();   // fills servicesCache

      // ✅ ensure subtabs state is applied (safe if already loaded)
      if(typeof renderServicesSubtabs === "function") renderServicesSubtabs();
      if(typeof syncServicesSubtabUI === "function") syncServicesSubtabUI();
    }else if(which==="careTeam"){
      $("panelCareTeam").classList.add("on");
      refreshCareTeamList();
    }else if(which==="notes"){
      $("panelNotes").classList.add("on");

      // init + show default Notes subtab
      renderNotesSubtabs();
      showNotesSubtab();

      // load both caches once so tab switching is instant
      refreshNoteTemplatesAdmin();
      refreshDcNoteTemplatesAdmin();
    }else if(which==="notifications"){
      $("panelNotifications").classList.add("on");
      refreshNotificationsAdmin();
    }else{
      $("panelUsers").classList.add("on");
    }


    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  onClickSafe("tabUsers", () => showPanel("users"));
  onClickSafe("tabAgencies", () => showPanel("agencies"));
    onClickSafe("tabProviderLibrary", () => showPanel("providerLibrary"));
    onClickSafe("tabPatients", () => showPanel("patients"));
    onClickSafe("tabAdmissions", () => showPanel("admissions"));
    onClickSafe("tabClientSurveys", () => showPanel("clientSurveys"));
    onClickSafe("tabServices", () => showPanel("services"));
  onClickSafe("tabCareTeam", () => showPanel("careTeam"));
  onClickSafe("tabNotes", () => showPanel("notes"));
  onClickSafe("tabNotifications", () => showPanel("notifications"));


  // --- Agencies page logic ---
  function renderAgenciesTable(){
    const tbody = $("agencyTbody");
    tbody.innerHTML = "";

    const q = ($("agencyListSearch").value || "").trim().toLowerCase();
    const items = (agenciesCache || []).filter(a => {
      const hay = `${a.agency_name||""} ${a.agency_type||""}`.toLowerCase();
      return !q || hay.includes(q);
    });

    items.forEach(a => {
      const tr = document.createElement("tr");
      tr.style.cursor = "pointer";
      tr.onclick = () => selectAgency(a);

      tr.innerHTML = `
        <td><b>${escapeHtml(a.agency_name||"")}</b></td>
        <td>${escapeHtml(a.agency_type||"")}</td>
        <td>${a.evolv_client ? "Yes" : "No"}</td>
        <td style="text-align:right;">
          <button class="mini"
                  onclick="event.stopPropagation(); openPdwPrefsModal(${Number(a.id)})">
            PDW Prefs
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function selectAgency(a){
    selectedAgencyId = a.id;
    $("selAgencyId").textContent = String(a.id);

    $("agency_name").value = a.agency_name || "";
    $("agency_type").value = a.agency_type || "Hospital";
    $("aliases").value = a.aliases || ""; // ✅ NEW
    $("facility_code").value = a.facility_code || "";
    $("carecompare_ccn").value = (a.carecompare_ccn || "");
    $("address").value = a.address || "";
    $("city").value = a.city || "";
    $("state").value = a.state || "";
    $("zip").value = a.zip || "";
    $("phone1").value = a.phone1 || "";
    $("phone2").value = a.phone2 || "";
    $("email2").value = a.email || "";
    $("fax").value = a.fax || "";
    $("notes").value = a.notes || "";
    $("notes2").value = a.notes2 || "";
    $("evolv_client").value = String(a.evolv_client ? 1 : 0);

    setMsg($("agencyEditMsg"), "", true);

    await loadPreferredProvidersForAgency(selectedAgencyId);

    openAgencyModal();
  }

  async function refreshAgenciesList(){
    setMsg($("agencyListMsg"), "Loading…", true);
    try{
      const agResp = await apiGet("/api/sensys/admin/agencies");
      agenciesCache = agResp.agencies || [];
      agenciesMaster = agenciesCache;       // keep master in sync for user checklist
      renderAgenciesTable();
      renderAgencyChecklist();

      setMsg($("agencyListMsg"), `Loaded ${agenciesCache.length} agencies.`, true);
      // Do NOT auto-open the first agency. Wait for row click or "Add new" button.

    }catch(e){
      setMsg($("agencyListMsg"), String(e.message || e), false);
    }
  }

  $("agencyListSearch").addEventListener("input", renderAgenciesTable);

  function startNewAgency(){
    selectedAgencyId = null;
    $("selAgencyId").textContent = "—";
    $("agency_name").value = "";
    $("agency_type").value = "Hospital";
    $("aliases").value = ""; 
    $("facility_code").value = "";
    $("carecompare_ccn").value = "";
    $("address").value = "";
    $("city").value = "";
    $("state").value = "";
    $("zip").value = "";
    $("phone1").value = "";
    $("phone2").value = "";
    $("email2").value = "";
    $("fax").value = "";
    $("notes").value = "";
    $("notes2").value = "";
    $("evolv_client").value = "0";

    selectedPreferredProviderIds = new Set();
    renderPreferredProvidersChecklist();

    setMsg($("agencyEditMsg"), "New agency mode (Save Agency to create).", true);

    openAgencyModal();
  }

  // NEW: top-right icon
  $("addAgencyIcon").onclick = startNewAgency;


  $("saveAgency").onclick = async () => {
    try{
      const payload = {
        id: selectedAgencyId,
        agency_name: ($("agency_name").value || "").trim(),
        agency_type: ($("agency_type").value || "").trim(),
        aliases: ($("aliases").value || "").trim(), // ✅ NEW
        facility_code: ($("facility_code").value || "").trim(),
        carecompare_ccn: ($("carecompare_ccn").value || "").trim(),
        address: ($("address").value || "").trim(),
        city: ($("city").value || "").trim(),
        state: ($("state").value || "").trim(),
        zip: ($("zip").value || "").trim(),
        phone1: ($("phone1").value || "").trim(),
        phone2: ($("phone2").value || "").trim(),
        email: ($("email2").value || "").trim(),
        fax: ($("fax").value || "").trim(),
        notes: ($("notes").value || "").trim(),
        notes2: ($("notes2").value || "").trim(),
        evolv_client: $("evolv_client").value === "1",
        preferred_provider_ids: Array.from(selectedPreferredProviderIds)
      };

      const resp = await apiPost("/api/sensys/admin/agencies/upsert", payload);
      if(resp && resp.id){
        selectedAgencyId = Number(resp.id);
        $("selAgencyId").textContent = String(selectedAgencyId);
      }
      setMsg($("agencyEditMsg"), "Agency saved.", true);
      await refreshAgenciesList();
    }catch(e){
      setMsg($("agencyEditMsg"), String(e.message || e), false);
    }
  };

  // Default panel: Users (no .panel needed). Agencies panel stays hidden until clicked.

  // initial load
  
  function openPatientModal(){ $("patientModalBackdrop").classList.add("on"); }
  function closePatientModal(){ $("patientModalBackdrop").classList.remove("on"); }

    function openAdmissionModal(){ $("admissionModalBackdrop").classList.add("on"); }
    function closeAdmissionModal(){ $("admissionModalBackdrop").classList.remove("on"); }

    async function openClientSurveysSettingsModal(){
      await loadClientSurveyPrompt();
      $("clientSurveysSettingsModalBackdrop").classList.add("on");
    }
    function closeClientSurveysSettingsModal(){ $("clientSurveysSettingsModalBackdrop").classList.remove("on"); }

    function openClientSurveysUploadModal(){ $("clientSurveysUploadModalBackdrop").classList.add("on"); }
    function closeClientSurveysUploadModal(){ $("clientSurveysUploadModalBackdrop").classList.remove("on"); }

    function openClientSurveysFilterModal(){ $("clientSurveysFilterModalBackdrop").classList.add("on"); }
    function closeClientSurveysFilterModal(){ $("clientSurveysFilterModalBackdrop").classList.remove("on"); }

    function openClientSurveysEmailModal(){ $("clientSurveysEmailModalBackdrop").classList.add("on"); }
    function closeClientSurveysEmailModal(){ $("clientSurveysEmailModalBackdrop").classList.remove("on"); }

    function openClientSurveyDetailsModal(){ $("clientSurveyDetailsModalBackdrop").classList.add("on"); }
    function closeClientSurveyDetailsModal(){ $("clientSurveyDetailsModalBackdrop").classList.remove("on"); }

    $("patientModalBackdrop").addEventListener("click", (e) => {
      if(e.target.id === "patientModalBackdrop") closePatientModal();
    });
    $("admissionModalBackdrop").addEventListener("click", (e) => {
      if(e.target.id === "admissionModalBackdrop") closeAdmissionModal();
    });
    $("clientSurveysSettingsModalBackdrop").addEventListener("click", (e) => {
      if(e.target.id === "clientSurveysSettingsModalBackdrop") closeClientSurveysSettingsModal();
    });
    $("clientSurveysUploadModalBackdrop").addEventListener("click", (e) => {
      if(e.target.id === "clientSurveysUploadModalBackdrop") closeClientSurveysUploadModal();
    });
    $("clientSurveysFilterModalBackdrop").addEventListener("click", (e) => {
      if(e.target.id === "clientSurveysFilterModalBackdrop") closeClientSurveysFilterModal();
    });
    $("clientSurveysEmailModalBackdrop").addEventListener("click", (e) => {
      if(e.target.id === "clientSurveysEmailModalBackdrop") closeClientSurveysEmailModal();
    });
    $("clientSurveyDetailsModalBackdrop").addEventListener("click", (e) => {
      if(e.target.id === "clientSurveyDetailsModalBackdrop") closeClientSurveyDetailsModal();
    });

    $("closePatientModal").onclick = closePatientModal;
    $("closeAdmissionModal").onclick = closeAdmissionModal;
    $("closeClientSurveysSettingsModal").onclick = closeClientSurveysSettingsModal;
    $("clientSurveysSettingsIcon").onclick = openClientSurveysSettingsModal;
    $("closeClientSurveysUploadModal").onclick = closeClientSurveysUploadModal;
    $("clientSurveysUploadIcon").onclick = openClientSurveysUploadModal;
    $("closeClientSurveysFilterModal").onclick = closeClientSurveysFilterModal;
    $("clientSurveyFilterIcon").onclick = openClientSurveysFilterModal;
    $("closeClientSurveysEmailModal").onclick = closeClientSurveysEmailModal;
    $("clientSurveyEmailIcon").onclick = openClientSurveysEmailModal;
    $("closeClientSurveyDetailsModal").onclick = closeClientSurveyDetailsModal;

    const clientSurveysDropzone = $("clientSurveysDropzone");
    const clientSurveysUploadInput = $("clientSurveysUploadInput");
    const clientSurveysChooseFileBtn = $("clientSurveysChooseFileBtn");
    const clientSurveysUploadStatus = $("clientSurveysUploadStatus");
    const clientSurveysUploadSubmit = $("clientSurveysUploadSubmit");
    const clientSurveysUploadMsg = $("clientSurveysUploadMsg");
    const clientSurveysUploadProgress = $("clientSurveysUploadProgress");
    const clientSurveysUploadBar = $("clientSurveysUploadBar");
    let clientSurveysSelectedFile = null;

    function setClientSurveysUploadStatus(text){
      if(clientSurveysUploadStatus) clientSurveysUploadStatus.textContent = text;
    }
    function setClientSurveysUploadMsg(text, ok){
      if(clientSurveysUploadMsg){
        clientSurveysUploadMsg.textContent = text || "";
        clientSurveysUploadMsg.style.color = ok ? "#065f46" : "#991b1b";
      }
    }
    function setClientSurveysUploadProgress(pct){
      if(clientSurveysUploadBar) clientSurveysUploadBar.style.width = `${pct}%`;
    }
    function showClientSurveysUploadProgress(isOn){
      if(clientSurveysUploadProgress) clientSurveysUploadProgress.style.display = isOn ? "" : "none";
    }
    function resetClientSurveysUpload(){
      clientSurveysSelectedFile = null;
      if(clientSurveysUploadInput) clientSurveysUploadInput.value = "";
      setClientSurveysUploadStatus("No file selected.");
      setClientSurveysUploadMsg("", true);
      setClientSurveysUploadProgress(0);
      showClientSurveysUploadProgress(false);
      clientSurveysUploadSubmit.disabled = true;
    }

    function handleClientSurveysFiles(files){
      if(!files || !files.length){
        setClientSurveysUploadStatus("No file selected.");
        clientSurveysSelectedFile = null;
        clientSurveysUploadSubmit.disabled = true;
        return;
      }
      clientSurveysSelectedFile = files[0];
      setClientSurveysUploadStatus(`Selected: ${clientSurveysSelectedFile.name}`);
      clientSurveysUploadSubmit.disabled = false;
      setClientSurveysUploadMsg("", true);
    }

    clientSurveysChooseFileBtn.onclick = () => clientSurveysUploadInput.click();
    clientSurveysDropzone.onclick = () => clientSurveysUploadInput.click();
    clientSurveysUploadInput.onchange = (e) => {
      handleClientSurveysFiles(e.target.files);
    };

    clientSurveysDropzone.addEventListener("dragover", (e) => {
      e.preventDefault();
      clientSurveysDropzone.classList.add("on");
    });
    clientSurveysDropzone.addEventListener("dragleave", () => {
      clientSurveysDropzone.classList.remove("on");
    });
    clientSurveysDropzone.addEventListener("drop", (e) => {
      e.preventDefault();
      clientSurveysDropzone.classList.remove("on");
      const files = e.dataTransfer && e.dataTransfer.files ? e.dataTransfer.files : [];
      handleClientSurveysFiles(files);
    });

    clientSurveysUploadSubmit.onclick = async () => {
      if(!clientSurveysSelectedFile){
        setClientSurveysUploadMsg("Choose a file first.", false);
        return;
      }
      clientSurveysUploadSubmit.disabled = true;
      setClientSurveysUploadMsg("Uploading.", true);
      showClientSurveysUploadProgress(true);
      setClientSurveysUploadProgress(20);
      try{
        setTimeout(() => setClientSurveysUploadProgress(60), 250);
        const resp = await apiUploadCsv("/api/sensys/admin/client-surveys/upload", clientSurveysSelectedFile);
        setClientSurveysUploadProgress(100);
        setClientSurveysUploadMsg(`Uploaded. Inserted: ${resp.inserted || 0}, Updated: ${resp.updated || 0}`, true);
        await refreshClientSurveysList();
        setTimeout(() => {
          closeClientSurveysUploadModal();
          resetClientSurveysUpload();
        }, 400);
      }catch(e){
        setClientSurveysUploadMsg(String(e.message || e), false);
        showClientSurveysUploadProgress(false);
      }finally{
        clientSurveysUploadSubmit.disabled = false;
      }
    };

    // -----------------------------
    // Client Surveys UI
    // -----------------------------
    let clientSurveysCache = [];
    let selectedClientSurveyId = null;

    const clientSurveyMockRow = {
      __mock: true,
      id: "mock",
      abv_name: "Doe, Jane",
      agency_name: "Luxe Rehab",
      admission_date: "12/01/2025",
      discharge_date: "12/20/2025",
      survey_updated_at: "01/16/2026 00:00",
      overall_score: 4,
      ai_summary: "Patient reported a positive stay with friendly staff and acceptable food.",
      general_comments: "Patient reported a positive stay with friendly staff and acceptable food.",
      ai_summary_override: ""
    };

    function getClientSurveyDefaultDischargeFrom(){
      const d = new Date();
      d.setDate(d.getDate() - 30);
      return d.toISOString().slice(0, 10);
    }

    const clientSurveyFilterState = {
      agency_name: "",
      discharge_from: getClientSurveyDefaultDischargeFrom(),
      discharge_to: "",
      sort_by: "patient_asc"
    };

    function formatSurveyDates(admit, dc){
      const a = (admit || "").trim();
      const d = (dc || "").trim();
      if(a && d) return `${a} - ${d}`;
      if(a) return a;
      if(d) return d;
      return "-";
    }

    function parseClientSurveyDate(value){
      const raw = (value || "").trim();
      if(!raw) return null;

      const iso = raw.split(" ")[0];
      if(/^\d{4}-\d{2}-\d{2}$/.test(iso)){
        const d = new Date(iso + "T00:00:00");
        return isNaN(d.getTime()) ? null : d;
      }

      const m = raw.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
      if(m){
        const mm = String(m[1]).padStart(2, "0");
        const dd = String(m[2]).padStart(2, "0");
        const yyyy = m[3];
        const d = new Date(`${yyyy}-${mm}-${dd}T00:00:00`);
        return isNaN(d.getTime()) ? null : d;
      }

      return null;
    }

    function getClientSurveyFilteredItems(){
      let items = (clientSurveysCache || []).slice();

      const agency = (clientSurveyFilterState.agency_name || "").trim().toLowerCase();
      if(agency){
        items = items.filter(s => String(s.agency_name || "").toLowerCase() === agency);
      }

      const from = clientSurveyFilterState.discharge_from ? new Date(clientSurveyFilterState.discharge_from + "T00:00:00") : null;
      const to = clientSurveyFilterState.discharge_to ? new Date(clientSurveyFilterState.discharge_to + "T23:59:59") : null;
      if(from || to){
        items = items.filter(s => {
          const d = parseClientSurveyDate(s.discharge_date || "");
          if(!d) return false;
          if(from && d < from) return false;
          if(to && d > to) return false;
          return true;
        });
      }

      const sortBy = clientSurveyFilterState.sort_by || "patient_asc";
      items.sort((a, b) => {
        if(sortBy === "patient_asc"){
          const an = String(a.abv_name || "").toLowerCase();
          const bn = String(b.abv_name || "").toLowerCase();
          return an.localeCompare(bn);
        }
        const ad = parseClientSurveyDate(a.discharge_date || "");
        const bd = parseClientSurveyDate(b.discharge_date || "");
        const av = ad ? ad.getTime() : 0;
        const bv = bd ? bd.getTime() : 0;
        return (sortBy === "discharge_asc") ? (av - bv) : (bv - av);
      });

      return items;
    }

    function renderClientSurveyFilterOptions(){
      const sel = $("clientSurveyFilterAgency");
      if(!sel) return;

      const agencies = Array.from(new Set((clientSurveysCache || []).map(r => String(r.agency_name || "").trim()).filter(Boolean)))
        .sort((a, b) => a.localeCompare(b));

      sel.innerHTML = `<option value="">All agencies</option>` + agencies.map(a => (
        `<option value="${escapeHtml(a)}">${escapeHtml(a)}</option>`
      )).join("");

      sel.value = clientSurveyFilterState.agency_name || "";
      $("clientSurveyFilterSort").value = clientSurveyFilterState.sort_by || "patient_asc";
      $("clientSurveyFilterDischargeFrom").value = clientSurveyFilterState.discharge_from || "";
      $("clientSurveyFilterDischargeTo").value = clientSurveyFilterState.discharge_to || "";
    }

    function renderClientSurveysTable(){
      const tbody = $("clientSurveyTbody");
      if(!tbody) return;

      const q = ($("clientSurveySearch").value || "").trim().toLowerCase();
      const countEl = $("clientSurveyRowCount");
      const totalCount = (clientSurveysCache || []).length;
      let filteredItems = getClientSurveyFilteredItems().filter(s => {
        const hay = String(s.abv_name || "").toLowerCase();
        return !q || hay.includes(q);
      });

      if(countEl){
        countEl.textContent = `${filteredItems.length} rows (from ${totalCount} total)`;
      }

      let items = filteredItems.slice();
      if($("clientSurveyMockToggle").checked){
        items = [clientSurveyMockRow].concat(items);
      }

      if(!items.length){
        tbody.innerHTML = `<tr><td colspan="3" style="padding:12px;color:#667085;font-size:12px;">No results</td></tr>`;
        return;
      }

      tbody.innerHTML = items.map(s => {
        const isMock = !!s.__mock;
        const rowId = isMock ? "mock" : String(s.id || "");
        const isSelected = !isMock && Number(s.id) === Number(selectedClientSurveyId);
        const summary = (s.ai_summary_override || s.ai_summary || "").trim() || "—";
        const dates = formatSurveyDates(s.admission_date, s.discharge_date);
        const updated = s.survey_updated_at || "-";
        const score = (s.overall_score !== null && s.overall_score !== undefined && s.overall_score !== "")
          ? String(s.overall_score)
          : "-";

        return `
          <tr class="survey-row-top ${isSelected ? "on" : ""}" data-id="${rowId}">
            <td>
              <div class="survey-main-name">${escapeHtml(s.abv_name || "—")}</div>
              <div class="survey-subline">${escapeHtml(s.agency_name || "—")} · ${escapeHtml(dates)}</div>
            </td>
            <td class="survey-meta">${escapeHtml(updated)}</td>
            <td class="survey-meta">${escapeHtml(score)}</td>
          </tr>
          <tr class="survey-row-bottom ${isSelected ? "on" : ""}" data-id="${rowId}">
            <td colspan="3">
              <div class="survey-ai">${escapeHtml(summary)}</div>
            </td>
          </tr>
        `;
      }).join("");
    }

    function selectClientSurveyById(id){
      const s = (clientSurveysCache || []).find(x => Number(x.id) === Number(id));
      if(!s) return;

      selectedClientSurveyId = Number(s.id);

      $("clientSurveyPatient").textContent = s.abv_name || "—";
      $("clientSurveyAgency").textContent = s.agency_name || "—";
      $("clientSurveyAdmit").textContent = s.admission_date || "—";
      $("clientSurveyDischarge").textContent = s.discharge_date || "—";
      $("clientSurveyUpdated").textContent = s.survey_updated_at || "—";
      $("clientSurveyScore").textContent = (s.overall_score !== null && s.overall_score !== undefined && s.overall_score !== "")
        ? String(s.overall_score)
        : "—";

      $("clientSurveyOriginalComments").value = s.general_comments || "";
      $("clientSurveySummaryOverride").value = (s.ai_summary_override || s.ai_summary || "").trim();
      $("clientSurveyDetailMsg").textContent = "";

      renderClientSurveysTable();
      openClientSurveyDetailsModal();
    }

    $("clientSurveyTbody").addEventListener("click", (e) => {
      const tr = e.target.closest("tr[data-id]");
      if(!tr) return;
      const id = parseInt(tr.getAttribute("data-id"), 10);
      if(!Number.isFinite(id)) return;
      selectClientSurveyById(id);
    });

    $("clientSurveySearch").addEventListener("input", renderClientSurveysTable);
    $("clientSurveyMockToggle").addEventListener("change", renderClientSurveysTable);

    $("clientSurveyApplyFilters").onclick = () => {
      const agency = ($("clientSurveyFilterAgency").value || "").trim();
      clientSurveyFilterState.agency_name = agency;
      clientSurveyFilterState.discharge_from = ($("clientSurveyFilterDischargeFrom").value || "").trim();
      clientSurveyFilterState.discharge_to = ($("clientSurveyFilterDischargeTo").value || "").trim();
      clientSurveyFilterState.sort_by = ($("clientSurveyFilterSort").value || "patient_asc").trim();
      $("clientSurveyFilterMsg").textContent = "Filters applied.";
      renderClientSurveysTable();
      closeClientSurveysFilterModal();
    };

    $("clientSurveyClearFilters").onclick = () => {
      clientSurveyFilterState.agency_name = "";
      clientSurveyFilterState.discharge_from = "";
      clientSurveyFilterState.discharge_to = "";
      clientSurveyFilterState.sort_by = "patient_asc";
      $("clientSurveyFilterMsg").textContent = "Filters cleared.";
      renderClientSurveyFilterOptions();
      renderClientSurveysTable();
    };

    $("clientSurveySendEmailBtn").onclick = async () => {
      const recipients = ($("clientSurveyEmailRecipients").value || "").trim();
      const agency = (clientSurveyFilterState.agency_name || "").trim();
      if(!agency){
        $("clientSurveyEmailMsg").textContent = "Select a single agency in filters before sending.";
        return;
      }
      if(!recipients){
        $("clientSurveyEmailMsg").textContent = "Enter at least one recipient email.";
        return;
      }

      $("clientSurveyEmailMsg").textContent = "Sending.";
      try{
        await apiPost("/api/sensys/admin/client-surveys/email-send", {
          recipients: recipients,
          filters: {
            agency_name: agency,
            discharge_from: clientSurveyFilterState.discharge_from || "",
            discharge_to: clientSurveyFilterState.discharge_to || "",
            sort_by: clientSurveyFilterState.sort_by || "patient_asc"
          }
        });
        $("clientSurveyEmailMsg").textContent = "Email sent.";
        closeClientSurveysEmailModal();
      }catch(e){
        $("clientSurveyEmailMsg").textContent = String(e.message || e);
      }
    };

    $("clientSurveySaveSummary").onclick = async () => {
      if(!selectedClientSurveyId){
        $("clientSurveyDetailMsg").textContent = "Select a survey first.";
        return;
      }
      $("clientSurveyDetailMsg").textContent = "Saving.";
      try{
        const overrideText = ($("clientSurveySummaryOverride").value || "").trim();
        await apiPost("/api/sensys/admin/client-surveys/summary-override", {
          id: Number(selectedClientSurveyId),
          ai_summary_override: overrideText
        });

        const row = (clientSurveysCache || []).find(x => Number(x.id) === Number(selectedClientSurveyId));
        if(row) row.ai_summary_override = overrideText;

        $("clientSurveyDetailMsg").textContent = "Saved.";
        renderClientSurveysTable();
      }catch(e){
        $("clientSurveyDetailMsg").textContent = String(e.message || e);
      }
    };

    async function refreshClientSurveysList(){
      setMsg($("clientSurveyListMsg"), "Loading.", true);
      try{
        const resp = await apiGet("/api/sensys/admin/client-surveys");
        clientSurveysCache = resp.surveys || [];
        renderClientSurveyFilterOptions();
        renderClientSurveysTable();
        setMsg($("clientSurveyListMsg"), `Loaded ${clientSurveysCache.length} surveys.`, true);
      }catch(e){
        setMsg($("clientSurveyListMsg"), String(e.message || e), false);
      }
    }

    async function loadClientSurveyPrompt(){
      try{
        const resp = await apiGet("/api/sensys/admin/client-surveys/prompt");
        $("clientSurveyPrompt").value = resp.prompt || "";
        $("clientSurveyPromptMsg").textContent = "";
      }catch(e){
        $("clientSurveyPromptMsg").textContent = String(e.message || e);
      }
    }

    $("clientSurveyPromptSave").onclick = async () => {
      $("clientSurveyPromptMsg").textContent = "Saving.";
      try{
        const promptVal = ($("clientSurveyPrompt").value || "").trim();
        await apiPost("/api/sensys/admin/client-surveys/prompt", { prompt: promptVal });
        $("clientSurveyPromptMsg").textContent = "Saved.";
      }catch(e){
        $("clientSurveyPromptMsg").textContent = String(e.message || e);
      }
    };

    let patientsCache = [];
  let selectedPatientId = null;

  let admissionsCache = [];
  let selectedAdmissionId = null;

  function renderPatientsTable(){
    const tbody = $("patientTbody");
    tbody.innerHTML = "";

    const q = ($("patientListSearch").value || "").trim().toLowerCase();
    const items = (patientsCache || []).filter(p => {
      const hay = `${p.last_name||""} ${p.first_name||""} ${p.dob||""} ${p.phone1||""} ${p.email||""}`.toLowerCase();
      return !q || hay.includes(q);
    });

    items.forEach(p => {
      const tr = document.createElement("tr");
      tr.style.cursor = "pointer";
      tr.onclick = () => selectPatient(p);
      tr.innerHTML = `
        <td><b>${escapeHtml((p.last_name||"") + ", " + (p.first_name||""))}</b></td>
        <td>${escapeHtml(p.dob||"")}</td>
        <td>${escapeHtml(p.phone1||"")}</td>
        <td>${p.active ? "Yes" : "No"}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function selectPatient(p){
    selectedPatientId = p.id;
    $("selPatientId").textContent = String(p.id);

    $("p_first_name").value = p.first_name || "";
    $("p_last_name").value = p.last_name || "";
    $("p_dob").value = p.dob || "";
    $("p_gender").value = p.gender || "";
    $("p_phone1").value = p.phone1 || "";
    $("p_email").value = p.email || "";
    $("p_active").value = String(p.active ? 1 : 0);

    setMsg($("patientEditMsg"), "", true);
    openPatientModal();
  }

  async function refreshPatientsList(){
    setMsg($("patientListMsg"), "Loading…", true);
    try{
      const resp = await apiGet("/api/sensys/admin/patients");
      patientsCache = resp.patients || [];
      renderPatientsTable();
      setMsg($("patientListMsg"), `Loaded ${patientsCache.length} patients.`, true);
    }catch(e){
      setMsg($("patientListMsg"), String(e.message || e), false);
    }
  }

  $("patientListSearch").addEventListener("input", renderPatientsTable);

  function startNewPatient(){
    selectedPatientId = null;
    $("selPatientId").textContent = "—";
    $("p_first_name").value = "";
    $("p_last_name").value = "";
    $("p_dob").value = "";
    $("p_gender").value = "";
    $("p_phone1").value = "";
    $("p_email").value = "";
    $("p_active").value = "1";
    setMsg($("patientEditMsg"), "New patient mode (Save Patient to create).", true);
    openPatientModal();
  }

  $("addPatientIcon").onclick = startNewPatient;

  $("savePatient").onclick = async () => {
    try{
      const payload = {
        id: selectedPatientId,
        first_name: ($("p_first_name").value || "").trim(),
        last_name: ($("p_last_name").value || "").trim(),
        dob: ($("p_dob").value || "").trim(),
        gender: ($("p_gender").value || "").trim(),
        phone1: ($("p_phone1").value || "").trim(),
        email: ($("p_email").value || "").trim(),
        active: parseInt($("p_active").value, 10)
      };
      await apiPost("/api/sensys/admin/patients/upsert", payload);
      setMsg($("patientEditMsg"), "Patient saved.", true);
      await refreshPatientsList();
    }catch(e){
      setMsg($("patientEditMsg"), String(e.message || e), false);
    }
  };


  function _fillSelect(el, options, valueKey, labelFn, selectedVal){
    el.innerHTML = "";
    options.forEach(o => {
      const opt = document.createElement("option");
      opt.value = String(o[valueKey]);
      opt.textContent = labelFn(o);
      if(selectedVal != null && String(selectedVal) === String(o[valueKey])) opt.selected = true;
      el.appendChild(opt);
    });
  }

  function renderAdmissionsTable(){
    const tbody = $("admissionTbody");
    tbody.innerHTML = "";

    const q = ($("admissionListSearch").value || "").trim().toLowerCase();
    const items = (admissionsCache || []).filter(a => {
      const hay = `${a.patient_name||""} ${a.agency_name||""} ${a.admit_date||""} ${a.dc_date||""}`.toLowerCase();
      return !q || hay.includes(q);
    });

    items.forEach(a => {
      const tr = document.createElement("tr");
      tr.style.cursor = "pointer";
      tr.onclick = () => selectAdmission(a);
      tr.innerHTML = `
        <td><b>${escapeHtml(a.patient_name||"")}</b></td>
        <td>${escapeHtml(a.agency_name||"")}</td>
        <td>${escapeHtml(a.admit_date||"")}</td>
        <td>${escapeHtml(a.dc_date||"")}</td>
        <td>${a.active ? "Yes" : "No"}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function refreshAdmissionsList(){
    setMsg($("admissionListMsg"), "Loading…", true);
    try{
      // ensure dropdown sources exist
      if(!patientsCache.length){
        const p = await apiGet("/api/sensys/admin/patients");
        patientsCache = p.patients || [];
      }
      if(!agenciesMaster.length){
        const ag = await apiGet("/api/sensys/admin/agencies");
        agenciesMaster = ag.agencies || [];
      }

      const resp = await apiGet("/api/sensys/admin/admissions");
      admissionsCache = resp.admissions || [];
      renderAdmissionsTable();

      setMsg($("admissionListMsg"), `Loaded ${admissionsCache.length} admissions.`, true);
    }catch(e){
      setMsg($("admissionListMsg"), String(e.message || e), false);
    }
  }

  $("admissionListSearch").addEventListener("input", renderAdmissionsTable);

  function selectAdmission(a){
    selectedAdmissionId = a.id;
    $("selAdmissionId").textContent = String(a.id);

    // dropdowns
    _fillSelect(
      $("a_patient_id"),
      patientsCache,
      "id",
      (p) => `${(p.last_name||"")}, ${(p.first_name||"")} (${p.dob||""})`,
      a.patient_id
    );

    _fillSelect(
      $("a_agency_id"),
      agenciesMaster,
      "id",
      (x) => `${x.agency_name||""} — ${x.agency_type||""}`,
      a.agency_id
    );

    $("a_mrn").value = a.mrn || "";                 // ✅ NEW
    $("a_visit_id").value = a.visit_id || "";       // ✅ NEW
    $("a_facility_code").value = a.facility_code || ""; // ✅ NEW

    $("a_admit_date").value = a.admit_date || "";
    $("a_dc_date").value = a.dc_date || "";
    $("a_room").value = a.room || "";
    $("a_reason").value = a.reason || "";
    $("a_active").value = String(a.active ? 1 : 0);

    setMsg($("admissionEditMsg"), "", true);
    openAdmissionModal();
  }

  function startNewAdmission(){
    selectedAdmissionId = null;
    $("selAdmissionId").textContent = "—";

    _fillSelect(
      $("a_patient_id"),
      patientsCache,
      "id",
      (p) => `${(p.last_name||"")}, ${(p.first_name||"")} (${p.dob||""})`,
      null
    );

    _fillSelect(
      $("a_agency_id"),
      agenciesMaster,
      "id",
      (x) => `${x.agency_name||""} — ${x.agency_type||""}`,
      null
    );

    $("a_mrn").value = "";           // ✅ NEW
    $("a_visit_id").value = "";      // ✅ NEW
    $("a_facility_code").value = ""; // ✅ NEW

    $("a_admit_date").value = "";
    $("a_dc_date").value = "";
    $("a_room").value = "";
    $("a_reason").value = "";
    $("a_active").value = "1";

    setMsg($("admissionEditMsg"), "New admission mode (Save Admission to create).", true);
    openAdmissionModal();
  }

  let bulkEntity = "users";

  const bulkConfig = {
    users: {
      label: "Users",
      endpoint: "/api/sensys/admin/users/bulk",
      filename: "sensys_users_template.csv",
      headers: ["user_id","email","display_name","is_active","password","cell_phone","account_locked","role_keys","agency_ids"]
    },
    agencies: {
      label: "Agencies",
      endpoint: "/api/sensys/admin/agencies/bulk",
      filename: "sensys_agencies_template.csv",
      headers: ["id","agency_name","agency_type","aliases","facility_code","address","city","state","zip","phone1","phone2","email","fax","notes","notes2","evolv_client"]
    },
    patients: {
      label: "Patients",
      endpoint: "/api/sensys/admin/patients/bulk",
      filename: "sensys_patients_template.csv",
      headers: ["id","first_name","last_name","dob","gender","phone1","phone2","email","email2","address1","address2","city","state","zip","insurance_name1","insurance_number1","insurance_name2","insurance_number2","active","notes1","notes2","source","external_patient_id","mrn"]
    },

    admissions: {
      label: "Admissions",
      endpoint: "/api/sensys/admin/admissions/bulk",
      filename: "sensys_admissions_template.csv",
      headers: [
        "id",

        // allow either patient_id OR patient demographics for auto-match/create
        "patient_id",
        "patient_first_name",
        "patient_last_name",
        "patient_dob",
        "patient_mrn",
        "patient_external_patient_id",

        "agency_id",

        // ✅ NEW admission identifiers
        "mrn",
        "visit_id",
        "facility_code",

        "admit_date","dc_date","room","referring_agency","reason","latest_pcp",
        "notes1","notes2","active","next_location","next_agency_id"
      ]
    },

    // ✅ ADD
    services: {
      label: "Services",
      endpoint: "/api/sensys/admin/services/bulk",
      filename: "sensys_services_template.csv",
      headers: ["id","name","service_type","dropdown"]
    },

    // ✅ ADD  (NOTE: this matches your icon call openBulkModal("care-team")【turn13:0†Sensys 3.0 - Admin - DEV.html†L75-L76】)
    "care-team": {
      label: "Care Team",
      endpoint: "/api/sensys/admin/care-team/bulk",
      filename: "sensys_care_team_template.csv",
      headers: ["id","name","type","npi","active","phone1","phone2","email1","email2"]
    }
  };
  // -----------------------------
  // Notifications (Admin) logic
  // -----------------------------
  let notifTemplatesCache = [];
  let editingNotifTemplate = null;

  function renderNotificationsAdminTable(){
    const tb = $("notifTbody");
    if(!tb) return;
    tb.innerHTML = "";

    const q = ($("notifSearch").value || "").trim().toLowerCase();
    const items = (notifTemplatesCache || []).filter(n => {
      const hay = `${n.notif_key||""} ${n.name||""}`.toLowerCase();
      return !q || hay.includes(q);
    });

    items.forEach(n => {
      const tr = document.createElement("tr");
      tr.style.cursor = "pointer";
      tr.onclick = () => openNotifModal(n);

      tr.innerHTML = `
        <td><b>${escapeHtml(n.notif_key||"")}</b></td>
        <td>${escapeHtml(n.name||"")}</td>
        <td>${String(n.active||0)==="1" ? "Yes" : "No"}</td>
        <td style="text-align:right;">
          <button class="mini" onclick="event.stopPropagation(); openNotifModal(${JSON.stringify(n)})">Edit</button>
        </td>
      `;
      tb.appendChild(tr);
    });
  }

  async function refreshNotificationsAdmin(){
    setMsg($("notifMsg"), "Loading…", true);
    try{
      // BACKEND TO ADD IN SEGMENT 2:
      // GET /api/sensys/admin/notifications
      const resp = await apiGet("/api/sensys/admin/notifications");
      notifTemplatesCache = (resp && resp.notifications) ? resp.notifications : [];
      renderNotificationsAdminTable();
      setMsg($("notifMsg"), `Loaded ${notifTemplatesCache.length} notifications.`, true);
    }catch(e){
      setMsg($("notifMsg"), String(e.message || e), false);
    }
  }

  $("notifSearch") && $("notifSearch").addEventListener("input", renderNotificationsAdminTable);

  function openNotifModal(n){
    editingNotifTemplate = n || null;
    setMsg($("notifModalMsg"), "", true);

    $("notif_id").value = (n && n.id) ? String(n.id) : "";
    $("notif_key").value = (n && n.notif_key) ? String(n.notif_key) : "";
    $("notif_name").value = (n && n.name) ? String(n.name) : "";
    $("notif_active").value = String((n && (n.active ?? 1)) ?? 1);

    $("notif_email_subject").value = (n && n.email_subject) ? String(n.email_subject) : "";
    $("notif_email_body").value = (n && n.email_body) ? String(n.email_body) : "";
    $("notif_email_html").value = (n && n.email_html) ? String(n.email_html) : "";
    $("notif_sms_body").value = (n && n.sms_body) ? String(n.sms_body) : "";
    $("notif_dash_body").value = (n && n.dashboard_body) ? String(n.dashboard_body) : "";

    $("notifModalBackdrop").classList.add("on");
  }

  function closeNotifModal(){
    $("notifModalBackdrop").classList.remove("on");
  }

  $("closeNotifModal") && ($("closeNotifModal").onclick = closeNotifModal);
  $("notifModalBackdrop") && $("notifModalBackdrop").addEventListener("click", (e) => {
    if(e.target.id === "notifModalBackdrop") closeNotifModal();
  });

  $("addNotifIcon") && ($("addNotifIcon").onclick = () => openNotifModal(null));

  $("saveNotifBtn") && ($("saveNotifBtn").onclick = async () => {
    try{
      setMsg($("notifModalMsg"), "Saving…", true);

      const payload = {
        id: $("notif_id").value ? Number($("notif_id").value) : null,
        notif_key: ($("notif_key").value || "").trim(),
        name: ($("notif_name").value || "").trim(),
        active: Number($("notif_active").value || "1"),
        email_subject: ($("notif_email_subject").value || "").trim(),
        email_body: ($("notif_email_body").value || ""),
        email_html: ($("notif_email_html").value || ""),
        sms_body: ($("notif_sms_body").value || ""),
        dashboard_body: ($("notif_dash_body").value || "")
      };

      if(!payload.notif_key) throw new Error("Key is required.");
      if(!payload.name) throw new Error("Name is required.");

      // BACKEND TO ADD IN SEGMENT 2:
      // POST /api/sensys/admin/notifications/upsert
      await apiPost("/api/sensys/admin/notifications/upsert", payload);

      setMsg($("notifModalMsg"), "Saved.", true);
      closeNotifModal();
      await refreshNotificationsAdmin();
    }catch(e){
      setMsg($("notifModalMsg"), String(e.message || e), false);
    }
  });

  let serviceTypesCache = [];

  async function refreshServiceTypes(){
    const resp = await apiGet("/api/sensys/admin/service-types");
    serviceTypesCache = resp.service_types || [];

    const sel = $("svc_type");
    if(sel){
      sel.innerHTML = ['<option value="">Select type…</option>']
        .concat(serviceTypesCache.map(t => {
          const label = `${escapeHtml(t.name || "")}` + (t.code ? ` (${escapeHtml(t.code)})` : "");
          return `<option value="${t.id}">${label}</option>`;
        }))
        .join('');
    }
  }

  // -----------------------------
  // Services page logic
  // -----------------------------
  let servicesCache = [];

  function renderServicesTable(){
    const tbody = $("servicesTbody");
    tbody.innerHTML = "";

    const q = ($("servicesListSearch").value || "").trim().toLowerCase();
    const items = (servicesCache || []).filter(s => {
      const typeLabel = (s.service_type_name || s.service_type_code || "").trim();
      const hay = `${s.name||""} ${typeLabel}`.toLowerCase();
      return !q || hay.includes(q);
    });

    items.forEach(s => {
      const tr = document.createElement("tr");
      tr.style.cursor = "pointer";
      tr.onclick = () => openServiceModal(s);

      const typeLabel = (s.service_type_name || s.service_type_code || "").trim();

      tr.innerHTML = `
        <td><b>${escapeHtml(s.name||"")}</b></td>
        <td>${escapeHtml(typeLabel)}</td>
        <td>${(String(s.dropdown||0)==="1") ? "Yes" : "No"}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function refreshServicesList(){
    setMsg($("servicesListMsg"), "Loading…", true);
    try{
      const resp = await apiGet("/api/sensys/admin/services");
      servicesCache = resp.services || [];
      renderServicesTable();
      setMsg($("servicesListMsg"), `Loaded ${servicesCache.length} services.`, true);
    }catch(e){
      setMsg($("servicesListMsg"), String(e.message || e), false);
    }
  }

  $("servicesListSearch").addEventListener("input", renderServicesTable);

  // -----------------------------
  // Services: subtabs (Services / Service Types)
  // -----------------------------
  let servicesActiveSubtab = "services"; // "services" | "types"

  function renderServicesSubtabs(){
    const host = $("servicesSubtabs");
    if(!host) return;

    const mkBtn = (key, label) => {
      const b = document.createElement("button");
      b.className = "btn";
      b.textContent = label;

      const active = (servicesActiveSubtab === key);
      b.style.fontWeight = active ? "900" : "800";
      b.style.borderColor = active ? "#7f56d9" : "#d0d5dd";
      b.style.background = active ? "rgba(127,86,217,.10)" : "#fff";

      b.onclick = () => {
        servicesActiveSubtab = key;
        syncServicesSubtabUI();
      };
      return b;
    };

    host.innerHTML = "";
    host.appendChild(mkBtn("services", "Services"));
    host.appendChild(mkBtn("types", "Service Types"));
  }

  function syncServicesSubtabUI(){
    renderServicesSubtabs();

    const showServices = (servicesActiveSubtab === "services");
    $("servicesSubtabServices").style.display = showServices ? "" : "none";
    $("servicesSubtabTypes").style.display = showServices ? "none" : "";

    // header buttons
    $("addServiceIcon").style.display = showServices ? "" : "none";
    $("bulkServicesIcon").style.display = showServices ? "" : "none";
    $("addServiceTypeIcon").style.display = showServices ? "none" : "";

    // ensure type list loaded when first opened
    if(!showServices){
      renderServiceTypesTable();
      setMsg($("serviceTypesMsg"), `Loaded ${serviceTypesCache.length} types.`, true);
    }
  }

  // -----------------------------
  // Service Types list UI
  // -----------------------------
  function renderServiceTypesTable(){
    const tb = $("serviceTypesTbody");
    if(!tb) return;
    tb.innerHTML = "";

    const q = ($("serviceTypesSearch").value || "").trim().toLowerCase();
    const items = (serviceTypesCache || []).filter(t => {
      const hay = `${t.name||""} ${t.code||""}`.toLowerCase();
      return !q || hay.includes(q);
    });

    items.forEach(t => {
      const tr = document.createElement("tr");
      tr.style.cursor = "pointer";
      tr.onclick = () => openServiceTypeModal(t);

      tr.innerHTML = `
        <td><b>${escapeHtml(t.name||"")}</b></td>
        <td>${escapeHtml(t.code||"")}</td>
        <td>${String(t.active||0)==="1" ? "Yes" : "No"}</td>
      `;
      tb.appendChild(tr);
    });
  }

  $("serviceTypesSearch").addEventListener("input", renderServiceTypesTable);

  // Reuse your existing refreshServiceTypes() to keep the Service modal dropdown populated.
  // We’ll extend it to also refresh the table view if we are on the “Service Types” subtab.
  const _refreshServiceTypesOriginal = refreshServiceTypes;
  refreshServiceTypes = async function(){
    await _refreshServiceTypesOriginal();
    if(servicesActiveSubtab === "types"){
      renderServiceTypesTable();
      setMsg($("serviceTypesMsg"), `Loaded ${serviceTypesCache.length} types.`, true);
    }
  };

  // -----------------------------
  // Service Type modal
  // -----------------------------
  function openServiceTypeModal(t){
    $("serviceTypeModalBackdrop").style.display = "flex";
    $("stMsg").textContent = "";
    $("serviceTypeModalTitle").textContent = (t && t.id) ? "Edit Service Type" : "Add Service Type";
    $("selServiceTypeId").textContent = (t && t.id) ? String(t.id) : "—";

    $("st_id").value = (t && t.id) ? String(t.id) : "";
    $("st_name").value = (t && t.name) ? t.name : "";
    $("st_code").value = (t && t.code) ? t.code : "";
    $("st_active").value = String((t && (t.active ?? 1)) ?? 1);
  }

  function closeServiceTypeModal(){
    $("serviceTypeModalBackdrop").style.display = "none";
  }

  $("closeServiceTypeModal").addEventListener("click", closeServiceTypeModal);
  $("serviceTypeModalBackdrop").addEventListener("click", (e) => {
    if(e.target === $("serviceTypeModalBackdrop")) closeServiceTypeModal();
  });

  $("addServiceTypeIcon").addEventListener("click", () => openServiceTypeModal(null));

  $("saveServiceTypeBtn").addEventListener("click", async () => {
    try{
      setMsg($("stMsg"), "Saving…", true);

      const payload = {
        id: $("st_id").value ? Number($("st_id").value) : null,
        name: ($("st_name").value || "").trim(),
        code: ($("st_code").value || "").trim() || null,
        active: Number($("st_active").value || "1")
      };

      if(!payload.name) throw new Error("Name is required.");

      await apiPost("/api/sensys/admin/service-types/upsert", payload);

      // refresh cache + dropdown + list
      await refreshServiceTypes();
      await refreshServicesList(); // so services list shows updated type labels

      setMsg($("stMsg"), "Saved.", true);
      closeServiceTypeModal();
    }catch(e){
      setMsg($("stMsg"), String(e.message || e), false);
    }
  });

  // Initialize subtabs once (do this after your page init code runs)
  renderServicesSubtabs();
  syncServicesSubtabUI();


  // -----------------------------
  // Care Team page logic
  // -----------------------------
  let careTeamCache = [];

  // ✅ NEW: lazy-load cache so User modal can render E-sign linking without opening Care Team tab first
  let careTeamCachePromise = null;

  async function ensureCareTeamCacheLoaded(){
    // already have data
    if(Array.isArray(careTeamCache) && careTeamCache.length) return careTeamCache;

    // in-flight request
    if(careTeamCachePromise) return careTeamCachePromise;

    // start request
    careTeamCachePromise = (async () => {
      try{
        const resp = await apiGet("/api/sensys/admin/care-team");
        careTeamCache = resp.care_team || [];
      }catch(e){
        console.warn("[ADMIN] Failed to preload care team for esign linking:", e);
        careTeamCache = [];
      }finally{
        // allow re-try later if it failed / returned empty
        careTeamCachePromise = null;
      }
      return careTeamCache;
    })();

    return careTeamCachePromise;
  }


  function renderCareTeamTable(){
    const tbody = $("careTeamTbody");
    tbody.innerHTML = "";

    const q = ($("careTeamListSearch").value || "").trim().toLowerCase();
    const items = (careTeamCache || []).filter(c => {
      const hay = `${c.name||""} ${c.type||""} ${c.npi||""}`.toLowerCase();
      return !q || hay.includes(q);
    });

    items.forEach(c => {
      const tr = document.createElement("tr");
      tr.style.cursor = "pointer";
      tr.onclick = () => openCareTeamModal(c);

      tr.innerHTML = `
        <td><b>${escapeHtml(c.name||"")}</b></td>
        <td>${escapeHtml(c.type||"")}</td>
        <td>${escapeHtml(c.npi||"")}</td>
        <td>${c.active ? "Yes" : "No"}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function refreshCareTeamList(){
    setMsg($("careTeamListMsg"), "Loading…", true);
    try{
      const resp = await apiGet("/api/sensys/admin/care-team");
      careTeamCache = resp.care_team || [];
      renderCareTeamTable();
      setMsg($("careTeamListMsg"), `Loaded ${careTeamCache.length} care team records.`, true);
    }catch(e){
      setMsg($("careTeamListMsg"), String(e.message || e), false);
    }
  }

  $("careTeamListSearch").addEventListener("input", renderCareTeamTable);

  function openBulkModal(entityKey){
    bulkEntity = entityKey;
    const cfg = bulkConfig[bulkEntity];

    $("bulkModalTitle").textContent = `Bulk Upload — ${cfg.label}`;
    $("bulkEntityHint").textContent = `Uploads to: ${cfg.endpoint}`;
    setMsg($("bulkMsg"), "", true);

    resetBulkSelection(); // NEW: clear previous file + re-enable same-file upload

    $("bulkModalBackdrop").classList.add("on");
  }

  function closeBulkModal(){
    $("bulkModalBackdrop").classList.remove("on");
  }

  $("bulkModalBackdrop").addEventListener("click", (e) => {
    if(e.target.id === "bulkModalBackdrop") closeBulkModal();
  });
  $("closeBulkModal").onclick = closeBulkModal;

  function downloadCsvTemplate(){
    const cfg = bulkConfig[bulkEntity];
    const headerLine = cfg.headers.join(",") + "\n";
    const blob = new Blob([headerLine], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = cfg.filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  $("downloadTemplateBtn").onclick = downloadCsvTemplate;

  // Prevent dropzone click from hijacking button clicks
  $("chooseFileBtn").addEventListener("click", (e) => {
    e.preventDefault();
    e.stopPropagation();
    $("bulkFileInput").click();
  });

  // Only open file picker if the user clicks the dropzone itself (not the buttons)
  $("dropzone").addEventListener("click", (e) => {
    const t = e.target;
    if (t && (t.id === "chooseFileBtn" || t.id === "bulkSubmitBtn")) return;
    $("bulkFileInput").click();
  });

  // Also ensure the submit button never bubbles up into the dropzone click
  $("bulkSubmitBtn").addEventListener("click", (e) => {
    e.stopPropagation();
  });

  // NEW: keep state so user can explicitly submit
  let bulkSelectedFile = null;

  function resetBulkSelection(){
    bulkSelectedFile = null;
    $("bulkFileInput").value = "";                 // allows re-selecting the same file
    $("bulkFileName").textContent = "";
    $("bulkSubmitBtn").disabled = true;
  }

  function setBulkSelectedFile(file){
    bulkSelectedFile = file;
    $("bulkFileName").textContent = file ? `Selected: ${file.name}` : "";
    $("bulkSubmitBtn").disabled = !file;
  }

  // ✅ Only ONE change handler (pick file does NOT upload immediately)
  $("bulkFileInput").addEventListener("change", (e) => {
    const f = e.target.files && e.target.files[0];
    if(f) handleBulkFilePicked(f);
  });

  // ✅ Drag & drop UX
  $("dropzone").addEventListener("dragover", (e) => {
    e.preventDefault();
    $("dropzone").classList.add("on");
  });

  $("dropzone").addEventListener("dragleave", () => {
    $("dropzone").classList.remove("on");
  });

  $("dropzone").addEventListener("drop", (e) => {
    e.preventDefault();
    $("dropzone").classList.remove("on");
    const f = e.dataTransfer.files && e.dataTransfer.files[0];
    if(f) handleBulkFilePicked(f);
  });

  // -----------------------------
  // Notes (Admin) page logic
  // -----------------------------
  let noteTemplatesAdminCache = [];
  let selectedNoteTemplateId = null;

  function renderNoteTemplatesAdminTable(){
    const tbody = $("notesTemplatesTbody");
    tbody.innerHTML = "";

    const q = ($("notesListSearch").value || "").trim().toLowerCase();
    const items = (noteTemplatesAdminCache || []).filter(t => {
      const hay = `${t.template_name||""} ${t.agency_id||""}`.toLowerCase();
      return !q || hay.includes(q);
    });

    items.forEach(t => {
      const tr = document.createElement("tr");
      tr.style.cursor = "pointer";
      tr.onclick = () => selectNoteTemplateRow(t);

      tr.innerHTML = `
        <td><b>${escapeHtml(t.template_name||"")}</b></td>
        <td>${t.agency_id ? escapeHtml(String(t.agency_id)) : "Global"}</td>
        <td>${(String(t.active||0)==="1") ? "Yes" : "No"}</td>
        <td style="text-align:right;">
          <button class="mini" onclick='event.stopPropagation(); openNoteTemplateModal(${JSON.stringify(t)})'>Edit</button>
          <button class="mini danger" onclick="event.stopPropagation(); deleteNoteTemplate(${t.id})">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function selectNoteTemplateRow(t){
    selectedNoteTemplateId = Number(t.id);
    $("btnAddNoteField").disabled = false;
    renderNoteFieldsAdminTable();
  }

  function renderNoteFieldsAdminTable(){
    const tbody = $("notesFieldsTbody");
    tbody.innerHTML = "";

    const tpl = (noteTemplatesAdminCache || []).find(x => Number(x.id) === Number(selectedNoteTemplateId));
    const fields = (tpl && tpl.fields) ? tpl.fields : [];

    fields.forEach(f => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(f.field_key||"")}</td>
        <td>${escapeHtml(f.field_label||"")}</td>
        <td>${escapeHtml(f.field_type||"")}</td>
        <td>${(String(f.required||0)==="1") ? "Yes" : "No"}</td>
        <td>${escapeHtml(String(f.sort_order||0))}</td>
        <td style="text-align:right;">
          <button class="mini" onclick='openNoteFieldModal(${JSON.stringify(f)})'>Edit</button>
          <button class="mini danger" onclick="deleteNoteField(${f.id})">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // -----------------------------
  // DC Note Templates (Admin)
  // -----------------------------
  let dcNoteTemplatesCache = [];
  let dcNoteTplSelectedAgencyIds = new Set();

  function _agencyNameById(id){
    const n = Number(id);
    const a = (agenciesMaster || []).find(x => Number(x.id) === n);
    return (a && (a.agency_name || a.name)) ? (a.agency_name || a.name) : ("Agency " + n);
  }

  function _agencyNamesForIds(ids){
    const arr = (ids || []).map(Number).filter(n => !Number.isNaN(n));
    if(arr.length === 0) return "Global";
    return arr.map(_agencyNameById).join(", ");
  }

  function renderDcNoteTemplatesAdminTable(){
    const tbody = $("dcNotesTemplatesTbody");
    if(!tbody) return;
    tbody.innerHTML = "";

    const q = ($("dcNotesListSearch").value || "").trim().toLowerCase();
    const items = (dcNoteTemplatesCache || []).filter(t => {
      const hay = `${t.template_name||""} ${t.agency_id||""}`.toLowerCase();
      return !q || hay.includes(q);
    });

    items.forEach(t => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><b>${escapeHtml(t.template_name||"")}</b></td>
        <td>${escapeHtml(_agencyNamesForIds(t.agency_ids || []))}</td>
        <td>${String(t.active||0)==="1" ? "Yes" : "No"}</td>
        <td style="text-align:right;">
          <button class="mini" onclick='openDcNoteTemplateModal(${JSON.stringify(t)})'>Edit</button>
          <button class="mini danger" onclick="deleteDcNoteTemplate(${t.id})">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderDcNoteTplAgencyChecklist(){
    const box = $("dcNoteTplAgencyChecklist");
    if(!box) return;

    const q = ($("dcNoteTplAgencySearch").value || "").trim().toLowerCase();
    const list = (agenciesMaster || []).filter(a => {
      const hay = `${a.agency_name||a.name||""} ${a.id||""}`.toLowerCase();
      return !q || hay.includes(q);
    });

    box.innerHTML = list.map(a => {
      const id = Number(a.id);
      const checked = dcNoteTplSelectedAgencyIds.has(id) ? "checked" : "";
      return `
        <label class="checkrow">
          <input type="checkbox" ${checked} onchange="toggleDcNoteTplAgency(${id}, this.checked)" />
          <span>${escapeHtml(a.agency_name || a.name || ("Agency " + id))}</span>
        </label>
      `;
    }).join("");
  }

  function toggleDcNoteTplAgency(id, isOn){
    const n = Number(id);
    if(isOn) dcNoteTplSelectedAgencyIds.add(n);
    else dcNoteTplSelectedAgencyIds.delete(n);
  }

  $("dcNoteTplAgencySearch") && $("dcNoteTplAgencySearch").addEventListener("input", renderDcNoteTplAgencyChecklist);


  async function refreshDcNoteTemplatesAdmin(){
    setMsg($("dcNotesListMsg"), "Loading…", true);
    try{
      const resp = await apiGet("/api/sensys/admin/dc-note-templates");
      dcNoteTemplatesCache = resp.templates || [];
      renderDcNoteTemplatesAdminTable();
      setMsg($("dcNotesListMsg"), `Loaded ${dcNoteTemplatesCache.length} DC templates.`, true);
    }catch(e){
      setMsg($("dcNotesListMsg"), String(e.message || e), false);
    }
  }

  $("dcNotesListSearch") && $("dcNotesListSearch").addEventListener("input", renderDcNoteTemplatesAdminTable);

  function openDcNoteTemplateModal(t){
    editingDcNoteTemplate = t || null;
    setMsg($("dcNoteTplMsg"), "", true);

    $("dcNoteTplName").value = (t && t.template_name) ? t.template_name : "";
    dcNoteTplSelectedAgencyIds = new Set((t && t.agency_ids) ? (t.agency_ids || []).map(Number) : []);
    $("dcNoteTplAgencySearch") && ($("dcNoteTplAgencySearch").value = "");
    renderDcNoteTplAgencyChecklist();
    $("dcNoteTplActive").value = (t && String(t.active||0)) ? String(t.active||0) : "1";
    $("dcNoteTplBody").value = (t && t.template_body) ? t.template_body : "";

    $("dcNoteTplModalBackdrop").classList.add("on");
  }
  function closeDcNoteTemplateModal(){
    $("dcNoteTplModalBackdrop").classList.remove("on");
  }

  $("dcNoteTplModalBackdrop") && $("dcNoteTplModalBackdrop").addEventListener("click", (e)=>{ if(e.target.id==="dcNoteTplModalBackdrop") closeDcNoteTemplateModal(); });
  $("closeDcNoteTplModal") && ($("closeDcNoteTplModal").onclick = closeDcNoteTemplateModal);

  async function saveDcNoteTemplate(){
    setMsg($("dcNoteTplMsg"), "Saving…", true);
    try{
      const payload = {
        id: editingDcNoteTemplate ? Number(editingDcNoteTemplate.id) : null,
        template_name: ($("dcNoteTplName").value || "").trim(),
        agency_ids: Array.from(dcNoteTplSelectedAgencyIds || []).map(Number),
        active: Number($("dcNoteTplActive").value || "1"),
        template_body: ($("dcNoteTplBody").value || "")
      };
      await apiPost("/api/sensys/admin/dc-note-templates/upsert", payload);
      setMsg($("dcNoteTplMsg"), "Saved.", true);
      closeDcNoteTemplateModal();
      await refreshDcNoteTemplatesAdmin();
    }catch(e){
      setMsg($("dcNoteTplMsg"), String(e.message || e), false);
    }
  }

  async function deleteDcNoteTemplate(id){
    if(!confirm("Delete this DC template?")) return;
    try{
      await apiPost("/api/sensys/admin/dc-note-templates/delete", { id: Number(id) });
      await refreshDcNoteTemplatesAdmin();
    }catch(e){
      alert(String(e.message || e));
    }
  }

  async function refreshNoteTemplatesAdmin(){
    setMsg($("notesListMsg"), "Loading…", true);
    try{
      const resp = await apiGet("/api/sensys/admin/note-templates");
      noteTemplatesAdminCache = resp.templates || [];
      selectedNoteTemplateId = null;
      $("btnAddNoteField").disabled = true;
      renderNoteTemplatesAdminTable();
      $("notesFieldsTbody").innerHTML = "";
      setMsg($("notesListMsg"), `Loaded ${noteTemplatesAdminCache.length} templates.`, true);
    }catch(e){
      setMsg($("notesListMsg"), String(e.message || e), false);
    }
  }

  $("notesListSearch").addEventListener("input", renderNoteTemplatesAdminTable);

  // ---- Template modal ----
  let editingNoteTemplate = null;

  // ✅ Multi-select state (Agencies + Roles)
  let noteTplSelectedAgencyIds = new Set();
  let noteTplSelectedRoleKeys = new Set();
  let noteTplSelectedShareRoleKeys = new Set();

  function renderNoteTplAgencyChecklist(){
    const box = $("noteTplAgencyChecklist");
    if(!box) return;

    const q = ($("noteTplAgencySearch").value || "").trim().toLowerCase();
    const list = (agenciesMaster || []).filter(a => {
      const hay = `${a.agency_name||a.name||""} ${a.id||""}`.toLowerCase();
      return !q || hay.includes(q);
    });

    box.innerHTML = list.map(a => {
      const id = Number(a.id);
      const checked = noteTplSelectedAgencyIds.has(id) ? "checked" : "";
      return `
        <label class="checkrow">
          <input type="checkbox" ${checked} onchange="toggleNoteTplAgency(${id}, this.checked)" />
          <span>${escapeHtml(a.agency_name || a.name || ("Agency " + id))}</span>
        </label>
      `;
    }).join("");
  }

  function toggleNoteTplAgency(id, isOn){
    const n = Number(id);
    if(isOn) noteTplSelectedAgencyIds.add(n);
    else noteTplSelectedAgencyIds.delete(n);
  }

  function renderNoteTplRoleChecklist(){
    const box = $("noteTplRoleChecklist");
    if(!box) return;

    const q = ($("noteTplRoleSearch").value || "").trim().toLowerCase();
    const list = (rolesMaster || []).filter(r => {
      const hay = `${r.role_name||""} ${r.role_key||""}`.toLowerCase();
      return !q || hay.includes(q);
    });

    box.innerHTML = list.map(r => {
      const key = String(r.role_key || "").trim();
      const checked = noteTplSelectedRoleKeys.has(key) ? "checked" : "";
      return `
        <label class="checkrow">
          <input type="checkbox" ${checked} onchange="toggleNoteTplRole('${escapeHtml(key)}', this.checked)" />
          <span>${escapeHtml(r.role_name || key)}</span>
        </label>
      `;
    }).join("");
  }

  function toggleNoteTplRole(roleKey, isOn){
    const k = String(roleKey || "").trim();
    if(!k) return;
    if(isOn) noteTplSelectedRoleKeys.add(k);
    else noteTplSelectedRoleKeys.delete(k);
  }

  // wire search inputs (safe if elements exist)
  $("noteTplAgencySearch") && $("noteTplAgencySearch").addEventListener("input", renderNoteTplAgencyChecklist);
  $("noteTplRoleSearch") && $("noteTplRoleSearch").addEventListener("input", renderNoteTplRoleChecklist);

  // ✅ Share With Roles checklist (uses rolesMaster)
  function renderNoteTplShareRoleChecklist(){
    const box = $("noteTplShareRoleChecklist");
    if(!box) return;

    const q = ($("noteTplShareRoleSearch").value || "").trim().toLowerCase();
    const list = (rolesMaster || []).filter(r => {
      const hay = `${r.role_name||""} ${r.role_key||""}`.toLowerCase();
      return !q || hay.includes(q);
    });

    box.innerHTML = list.map(r => {
      const key = String(r.role_key || "").trim();
      const checked = noteTplSelectedShareRoleKeys.has(key) ? "checked" : "";
      return `
        <label class="checkrow">
          <input type="checkbox" ${checked} onchange="toggleNoteTplShareRole('${escapeHtml(key)}', this.checked)" />
          <span>${escapeHtml(r.role_name || key)}</span>
        </label>
      `;
    }).join("");
  }

  function toggleNoteTplShareRole(roleKey, isOn){
    const k = String(roleKey || "").trim();
    if(!k) return;
    if(isOn) noteTplSelectedShareRoleKeys.add(k);
    else noteTplSelectedShareRoleKeys.delete(k);
  }

  $("noteTplShareRoleSearch") && $("noteTplShareRoleSearch").addEventListener("input", renderNoteTplShareRoleChecklist);


  function openNoteTemplateModal(t){
    editingNoteTemplate = t || null;
    setMsg($("noteTplMsg"), "", true);

    $("noteTplName").value = (t && t.template_name) ? t.template_name : "";
    $("noteTplActive").value = (t && String(t.active||0)) ? String(t.active||0) : "1";

    // ✅ initialize multi-selects from backend arrays
    noteTplSelectedAgencyIds = new Set((t && t.agency_ids) ? (t.agency_ids || []).map(Number) : []);
    noteTplSelectedRoleKeys = new Set((t && t.role_keys) ? (t.role_keys || []).map(x => String(x||"").trim()).filter(Boolean) : []);

    // ✅ NEW: Share With Roles (from backend array t.share_with_role_keys)
    noteTplSelectedShareRoleKeys = new Set(
      (t && t.share_with_role_keys)
        ? (t.share_with_role_keys || []).map(x => String(x||"").trim()).filter(Boolean)
        : []
    );

    // clear searches so full lists show on open
    $("noteTplAgencySearch") && ($("noteTplAgencySearch").value = "");
    $("noteTplRoleSearch") && ($("noteTplRoleSearch").value = "");
    $("noteTplShareRoleSearch") && ($("noteTplShareRoleSearch").value = "");

    renderNoteTplAgencyChecklist();
    renderNoteTplRoleChecklist();
    window.renderNoteTplShareRoleChecklist && renderNoteTplShareRoleChecklist();

    $("noteTplModalBackdrop").classList.add("on");
  }

  function closeNoteTemplateModal(){
    $("noteTplModalBackdrop").classList.remove("on");
  }

  $("noteTplModalBackdrop").addEventListener("click", (e)=>{ if(e.target.id==="noteTplModalBackdrop") closeNoteTemplateModal(); });
  $("closeNoteTplModal").onclick = closeNoteTemplateModal;

  async function saveNoteTemplate(){
    setMsg($("noteTplMsg"), "Saving…", true);
    try{
      const payload = {
        id: editingNoteTemplate ? Number(editingNoteTemplate.id) : null,
        template_name: ($("noteTplName").value || "").trim(),
        active: Number($("noteTplActive").value || "1"),

        // ✅ new targeting
        agency_ids: Array.from(noteTplSelectedAgencyIds || []).map(Number),
        role_keys: Array.from(noteTplSelectedRoleKeys || []).map(x => String(x||"").trim()).filter(Boolean),

        // ✅ NEW: Share With Roles (controls Share With dropdown options on notes)
        share_with_role_keys: Array.from(noteTplSelectedShareRoleKeys || []).map(x => String(x||"").trim()).filter(Boolean),
      };
      
      await apiPost("/api/sensys/admin/note-templates/upsert", payload);
      setMsg($("noteTplMsg"), "Saved.", true);
      closeNoteTemplateModal();
      await refreshNoteTemplatesAdmin();
    }catch(e){
      setMsg($("noteTplMsg"), String(e.message || e), false);
    }
  }

  async function deleteNoteTemplate(id){
    if(!confirm("Delete this template (and its fields)?")) return;
    try{
      await apiPost("/api/sensys/admin/note-templates/delete", { id: Number(id) });
      await refreshNoteTemplatesAdmin();
    }catch(e){
      alert(String(e.message || e));
    }
  }

  // ---- Field modal ----
  let editingNoteField = null;

  function openNoteFieldModal(f){
    if(!selectedNoteTemplateId){
      alert("Select a template first.");
      return;
    }
    editingNoteField = f || null;
    setMsg($("noteFieldMsg"), "", true);

    $("noteFieldKey").value = (f && f.field_key) ? f.field_key : "";
    $("noteFieldLabel").value = (f && f.field_label) ? f.field_label : "";
    $("noteFieldType").value = (f && f.field_type) ? String(f.field_type) : "text";
    $("noteFieldRequired").value = (f && String(f.required||0)) ? String(f.required||0) : "0";
    $("noteFieldOrder").value = (f && String(f.sort_order||0)) ? String(f.sort_order||0) : "0";
    $("noteFieldOptions").value = (f && f.options_json) ? String(f.options_json) : "";

    $("noteFieldModalBackdrop").classList.add("on");
  }
  function closeNoteFieldModal(){
    $("noteFieldModalBackdrop").classList.remove("on");
  }

  $("noteFieldModalBackdrop").addEventListener("click", (e)=>{ if(e.target.id==="noteFieldModalBackdrop") closeNoteFieldModal(); });
  $("closeNoteFieldModal").onclick = closeNoteFieldModal;

  async function saveNoteField(){
    setMsg($("noteFieldMsg"), "Saving…", true);
    try{
      const payload = {
        id: editingNoteField ? Number(editingNoteField.id) : null,
        template_id: Number(selectedNoteTemplateId),
        field_key: ($("noteFieldKey").value || "").trim(),
        field_label: ($("noteFieldLabel").value || "").trim(),
        field_type: ($("noteFieldType").value || "text").trim(),
        required: Number($("noteFieldRequired").value || "0"),
        sort_order: Number(($("noteFieldOrder").value || "0").trim() || "0"),
        options_json: ($("noteFieldOptions").value || "").trim() || null
      };
      await apiPost("/api/sensys/admin/note-template-fields/upsert", payload);
      setMsg($("noteFieldMsg"), "Saved.", true);
      closeNoteFieldModal();
      await refreshNoteTemplatesAdmin();
    }catch(e){
      setMsg($("noteFieldMsg"), String(e.message || e), false);
    }
  }

  async function deleteNoteField(id){
    if(!confirm("Delete this field?")) return;
    try{
      await apiPost("/api/sensys/admin/note-template-fields/delete", { id: Number(id) });
      await refreshNoteTemplatesAdmin();
    }catch(e){
      alert(String(e.message || e));
    }
  }

  async function loadProviderLibraryMeta(){
    try{
      const meta = await apiGet("/api/sensys/admin/provider-library/meta");
      if(meta){
        const last = meta.last_sync_at ? meta.last_sync_at : "Never";
        const rows = Number(meta.last_row_count || 0);
        const err = meta.last_error ? ` • Last error: ${meta.last_error}` : "";
        $("plMeta").textContent = `Last sync: ${last} • Rows: ${rows}${err}`;
      }
    }catch(e){
      $("plMeta").textContent = "Meta failed to load";
    }
  }

  // -----------------------------
  // Provider Library UI state
  // -----------------------------
  let plLibraryKey = "hha";      // future: hospice, snf, etc
  let plOffset = 0;
  let plLimit = 100;
  let plHasMore = false;

  function renderProviderLibrarySubtabs(){
    const wrap = $("plSubtabs");
    if(!wrap) return;

    const tabs = [
      { key:"hha", label:"Home Health" },
      { key:"hospice", label:"Hospice (soon)", disabled:true },
      { key:"snf", label:"SNF (soon)", disabled:true },
    ];

    wrap.innerHTML = "";
    tabs.forEach(t => {
      const pill = document.createElement("span");
      pill.className = "tag " + (plLibraryKey === t.key ? "on" : "");
      pill.style.cursor = t.disabled ? "not-allowed" : "pointer";
      pill.style.opacity = t.disabled ? "0.55" : "1";
      pill.textContent = t.label;

      pill.onclick = () => {
        if(t.disabled) return;
        plLibraryKey = t.key;
        plOffset = 0;
        $("plQ").value = "";
        renderProviderLibrarySubtabs();
        runProviderLibrarySearch({ resetPage:true });
      };

      wrap.appendChild(pill);
    });
  }

  function updateProviderLibraryPager(){
    const info = $("plPageInfo");
    const prev = $("plPrevBtn");
    const next = $("plNextBtn");
    if(!info || !prev || !next) return;

    const pageNum = Math.floor(plOffset / plLimit) + 1;
    info.textContent = `Page ${pageNum}`;

    prev.disabled = plOffset <= 0;
    next.disabled = !plHasMore;
  }

  $("plPrevBtn").onclick = () => {
    plOffset = Math.max(0, plOffset - plLimit);
    runProviderLibrarySearch({ resetPage:false });
  };

  $("plNextBtn").onclick = () => {
    if(!plHasMore) return;
    plOffset = plOffset + plLimit;
    runProviderLibrarySearch({ resetPage:false });
  };

  async function runProviderLibrarySearch(opts){
    const resetPage = (opts && opts.resetPage) ? true : false;
    if(resetPage) plOffset = 0;

    const q = ($("plQ").value || "").trim();
    const tb = $("plTbody");
    tb.innerHTML = `<tr><td colspan="4" style="padding:12px;color:#667085;font-size:12px;">Loading…</td></tr>`;

    // Only HHA is wired today
    let endpoint = "/api/sensys/admin/provider-library/hha-search";
    if(plLibraryKey !== "hha"){
      tb.innerHTML = `<tr><td colspan="4" style="padding:12px;color:#667085;font-size:12px;">This library is coming soon.</td></tr>`;
      plHasMore = false;
      updateProviderLibraryPager();
      return;
    }

    const url =
      `${endpoint}?q=${encodeURIComponent(q)}&limit=${encodeURIComponent(plLimit)}&offset=${encodeURIComponent(plOffset)}`;

    const resp = await apiGet(url);

    const rows = (resp && resp.results) ? resp.results : [];
    plHasMore = !!(resp && resp.has_more);

    if(!rows.length){
      tb.innerHTML = `<tr><td colspan="4" style="padding:12px;color:#667085;font-size:12px;">No results</td></tr>`;
      updateProviderLibraryPager();
      return;
    }

    tb.innerHTML = rows.map(r => {
      const provider = (r.dba ? `${r.dba} (DBA)` : (r.provider_name || "—"));
      const loc = [r.city, r.state, r.zip].filter(Boolean).join(", ");
      const phonefax = [r.phone ? `📞 ${r.phone}` : "", r.fax ? `📠 ${r.fax}` : ""].filter(Boolean).join("  ");
      return `
        <tr style="border-top:1px solid #eef0f4;">
          <td style="padding:10px;font-size:12px;color:#111827;font-weight:800;">${escapeHtml(provider)}</td>
          <td style="padding:10px;font-size:12px;color:#475467;">${escapeHtml(r.ccn || "")}</td>
          <td style="padding:10px;font-size:12px;color:#475467;">${escapeHtml(loc)}</td>
          <td style="padding:10px;font-size:12px;color:#475467;">${escapeHtml(phonefax)}</td>
        </tr>
      `;
    }).join("");

    updateProviderLibraryPager();
  }

  // init
  renderProviderLibrarySubtabs();
  updateProviderLibraryPager();



  $("plSearchBtn").onclick = runProviderLibrarySearch;
  $("plQ").addEventListener("keydown", (e)=>{ if(e.key==="Enter") runProviderLibrarySearch(); });

  $("plSyncBtn").onclick = async () => {
    $("plSyncBtn").disabled = true;
    $("plSyncBtn").textContent = "Syncing…";
    try{
      const resp = await apiPost("/api/sensys/admin/provider-library/sync", {});
      await loadProviderLibraryMeta();
      if(resp && resp.ok){
        const msg =
          `Sync complete.\n` +
          `Upserted: ${resp.upserted || 0}\n` +
          `Fetched: ${resp.fetched || 0}\n` +
          `Skipped (no CCN): ${resp.skipped_no_ccn || 0}\n` +
          `Debug: ${resp.debug ? JSON.stringify(resp.debug) : "—"}`;
        alert(msg);
      }else{
        alert(`Sync failed: ${(resp && resp.error) ? resp.error : "Unknown error"}`);
      }
    }catch(e){
      alert("Sync failed: " + String(e.message || e));
    }finally{
      $("plSyncBtn").disabled = false;
      $("plSyncBtn").textContent = "Sync Now";
    }
  };

  // picking a file no longer uploads immediately
  function handleBulkFilePicked(file){
    try{
      if(!String(file.name || "").toLowerCase().endsWith(".csv")){
        throw new Error("Please upload a .csv file.");
      }
      setBulkSelectedFile(file);
      setMsg($("bulkMsg"), "Ready to upload. Click “Upload CSV”.", true);
    }catch(err){
      setBulkSelectedFile(null);
      setMsg($("bulkMsg"), String(err.message || err), false);
    }
  }

  // explicit submit button
  $("bulkSubmitBtn").onclick = async () => {
    try{
      if(!bulkSelectedFile) throw new Error("Please choose a CSV file first.");

      setMsg($("bulkMsg"), `Uploading ${bulkSelectedFile.name}…`, true);

      const cfg = bulkConfig[bulkEntity];
      const resp = await apiUploadCsv(cfg.endpoint, bulkSelectedFile);

      const msg = `Done. Inserted: ${resp.inserted || 0}, Updated: ${resp.updated || 0}, Errors: ${resp.error_count || 0}`;
      setMsg($("bulkMsg"), msg, true);

      // Refresh the right list after upload
      if(bulkEntity === "users"){
        await refreshAll();
      }else if(bulkEntity === "agencies"){
        await refreshAgenciesList();
      }else if(bulkEntity === "patients"){
        await refreshPatientsList();
      }else if(bulkEntity === "admissions"){
        await refreshAdmissionsList();
      }else if(bulkEntity === "services"){
        await refreshServicesList();
      }else if(bulkEntity === "care-team"){
        await refreshCareTeamList();
      }

      resetBulkSelection();
    }catch(err){
      setMsg($("bulkMsg"), String(err.message || err), false);
    }
  };

  $("addAdmissionIcon").onclick = async () => {
    if(!patientsCache.length) await refreshPatientsList();
    if(!agenciesMaster.length){
      const ag = await apiGet("/api/sensys/admin/agencies");
      agenciesMaster = ag.agencies || [];
    }
    startNewAdmission();
  };

  $("saveAdmission").onclick = async () => {
    try{
      const payload = {
        id: selectedAdmissionId,
        patient_id: parseInt($("a_patient_id").value, 10),
        agency_id: parseInt($("a_agency_id").value, 10),

        // ✅ NEW
        mrn: ($("a_mrn").value || "").trim(),
        visit_id: ($("a_visit_id").value || "").trim(),
        facility_code: ($("a_facility_code").value || "").trim(),

        admit_date: ($("a_admit_date").value || "").trim(),
        dc_date: ($("a_dc_date").value || "").trim(),
        room: ($("a_room").value || "").trim(),
        reason: ($("a_reason").value || "").trim(),
        active: parseInt($("a_active").value, 10)
      }

      await apiPost("/api/sensys/admin/admissions/upsert", payload);
      setMsg($("admissionEditMsg"), "Admission saved.", true);
      await refreshAdmissionsList();
    }catch(e){
      setMsg($("admissionEditMsg"), String(e.message || e), false);
    }
  };
  
  refreshAll();
</script>
</body>
</html>
