<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Census</title>
  <style>
    :root{
      --navy:#0D3B66;
      --mint:#A8E6CF;
      --bg:#F5F7FA;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --card:#ffffff;
      --shadow:0 10px 28px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text)}
    .topbar{
      background:var(--navy);
      color:#fff;
      padding:14px 18px;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .topbar-btn{
      background:transparent;
      border:1px solid rgba(255,255,255,.28);
    }
    .topbar-btn svg{stroke:#fff}
    .topbar-btn:hover{
      border-color: rgba(168,230,207,.9);
      box-shadow: 0 0 0 4px rgba(168,230,207,.25);
    }
    .shell{max-width:1320px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow);overflow:hidden}
    .hdr{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted);font-weight:800}
    .ipt{height:38px;border-radius:12px;border:1px solid #d1d5db;padding:0 12px;background:#fff;min-width:260px}
    .btn{height:38px;border-radius:12px;border:1px solid #d1d5db;background:#fff;padding:0 12px;font-weight:900;cursor:pointer}
    .btn-primary{background:var(--navy);border-color:var(--navy);color:#fff}
    .pillrow{display:flex;gap:8px;align-items:center}
    .pill{border-radius:999px;border:1px solid #d1d5db;background:#fff;padding:8px 12px;font-weight:900;font-size:12px;cursor:pointer}
    .pill[aria-pressed="true"]{border-color:var(--mint);box-shadow:0 10px 18px rgba(168,230,207,.25)}
    .split{
      display:grid;
      grid-template-columns:420px 1fr;
      height:calc(100vh - 260px); /* locks panel height under header */
    }
    .list{
      border-right:1px solid var(--line);
      background:#fff;
      overflow-y:auto;      /* ✅ left side scrolls */
      overscroll-behavior: contain;
    }
    .item{padding:12px 14px;border-bottom:1px solid #f1f5f9;cursor:pointer}
    .item:hover{background:#f8fafc}
    .item.active{outline:2px solid var(--mint);box-shadow:0 10px 18px rgba(168,230,207,.25)}
    .list::after{
      content:"";
      display:block;
      height:12px;
    }
    .title{font-weight:900}
    .sub{font-size:12px;color:var(--muted);margin-top:3px}
    .detail{
      padding:14px 16px;
      overflow-y:hidden;   /* ✅ right side does NOT scroll */
    }
    .kv{display:grid;grid-template-columns:180px 1fr;gap:8px 12px;font-size:13px}
    .kv div:nth-child(odd){color:var(--muted);font-weight:900}
    .divider{height:1px;background:#eef2f7;margin:12px 0}
    .hint{font-size:12px;color:var(--muted)}

    /* ✅ Loading overlay */
    .loading-overlay{
      position:fixed; inset:0;
      background:rgba(245,247,250,.72);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
      backdrop-filter: blur(2px);
    }
    .loading-box{
      background:#fff;
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: var(--shadow);
      padding:16px 18px;
      display:flex;
      gap:12px;
      align-items:center;
      min-width: 320px;
    }
    .spinner{
      width:22px; height:22px;
      border-radius:999px;
      border:3px solid #d1d5db;
      border-top-color: var(--navy);
      animation: spin 0.9s linear infinite;
      flex:0 0 auto;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text{
      font-weight:900;
      color: var(--text);
      font-size:13px;
      line-height:1.2;
    }
    .loading-sub{
      margin-top:3px;
      font-size:12px;
      color: var(--muted);
      font-weight:800;
    }

    /* ✅ Icon button (matches Evolv template) */
    .icon-btn{
      display:inline-flex; align-items:center; justify-content:center;
      width:42px; height:38px;
      border-radius:12px;
      border:1px solid rgba(13,59,102,.22);
      background:#fff;
      cursor:pointer;
      transition: box-shadow .15s ease, border-color .15s ease, transform .15s ease;
    }
    .icon-btn svg{width:18px;height:18px;stroke:var(--navy);fill:none;stroke-width:1.6;stroke-linecap:round;stroke-linejoin:round}
    .icon-btn:hover{border-color: rgba(168,230,207,.9); box-shadow: 0 0 0 4px rgba(168,230,207,.35); transform: translateY(-1px);}
    .icon-btn:active{transform: translateY(0px)}

    /* ✅ Settings modal (matches Evolv template) */
    .modal-overlay{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(245,247,250,.72);
      backdrop-filter: blur(2px);
      z-index:10000;
      padding:16px;
    }
    .modal{
      width:min(720px, 100%);
      border-radius:18px;
      border:1px solid rgba(13,59,102,.14);
      background:#fff;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal-bar{
      background: var(--navy);
      color:#fff;
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-weight:900;
      letter-spacing:.2px;
    }
    .modal-body{padding:14px 16px}
    .modal-actions{
      padding:0 16px 16px;
      display:flex;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }
    .btn-ghost{background:transparent}
    .help{margin-top:6px;font-size:12px;color:var(--muted);font-weight:800}
  </style>
</head>
<body>
  <div class="topbar">
    <div>Census — Full / New Admissions / Discharges</div>

    <!-- moved settings button into top blue bar -->
    <button class="icon-btn topbar-btn" id="btnSettings" title="Settings" aria-label="Settings">
      <svg viewBox="0 0 24 24">
        <path d="M7 10V8a5 5 0 0 1 10 0v2"></path>
        <rect x="5" y="10" width="14" height="10" rx="2"></rect>
      </svg>
    </button>
  </div>
  <!-- ✅ Loading overlay -->
  <div class="loading-overlay" id="loadingOverlay" aria-live="polite" aria-busy="true">
    <div class="loading-box">
      <div class="spinner"></div>
      <div>
        <div class="loading-text" id="loadingText">Loading…</div>
        <div class="loading-sub" id="loadingSub">Please wait</div>
      </div>
    </div>
  </div>

  <!-- ✅ Settings modal -->
  <div class="modal-overlay" id="settingsOverlay" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div class="modal">
      <div class="modal-bar">
        <div id="settingsTitle">Settings</div>
        <button class="icon-btn" id="btnSettingsClose" title="Close" aria-label="Close">
          <svg viewBox="0 0 24 24">
            <path d="M6 6l12 12"></path>
            <path d="M18 6l-12 12"></path>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        <label>Admin Token</label>
        <input id="adminToken" class="ipt" placeholder="Paste ADMIN_TOKEN (saved in browser)" />
        <div class="help">Required for upload / view / export.</div>
      </div>

      <div class="modal-actions">
        <button class="btn btn-ghost" id="btnSettingsCancel" type="button">Cancel</button>
        <button class="btn btn-primary" id="btnSettingsSave" type="button">Save</button>
      </div>
    </div>
  </div>

  <!-- ✅ Upload PDFs modal (drag + drop, multi-file) -->
  <div class="modal-overlay" id="uploadOverlay" role="dialog" aria-modal="true" aria-labelledby="uploadTitle">
    <div class="modal">
      <div class="modal-bar">
        <div id="uploadTitle">Upload PDFs</div>
        <button class="icon-btn" id="btnUploadClose" type="button" title="Close" aria-label="Close">
          <svg viewBox="0 0 24 24">
            <path d="M6 6l12 12"></path>
            <path d="M18 6l-12 12"></path>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        <div id="dropzone" style="
          border:1px dashed rgba(13,59,102,.22);
          border-radius:16px;
          padding:14px;
          background: rgba(13,59,102,.03);
          font-weight:900;
          color: var(--navy);
          text-align:center;

          min-height:180px;
          display:flex;
          align-items:center;
          justify-content:center;
          flex-direction:column;
        ">
          Drag files here<br/>
          <span style="font-weight:800;color:var(--muted);font-size:12px;">or use Browse</span>
        </div>

        <input id="uploadFiles" type="file" accept="application/pdf" multiple style="display:none"/>

        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:12px;">
          <button class="btn" id="btnBrowse" type="button">Browse</button>
          <div class="hint" id="fileCount">No files selected.</div>
        </div>

        <div class="divider"></div>

        <div class="hint" id="uploadStatusText"></div>
        <div style="height:10px;border-radius:999px;border:1px solid rgba(13,59,102,.14);overflow:hidden;background:#fff;">
          <div id="uploadBar" style="height:100%;width:0%;background: var(--mint);"></div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn btn-ghost" id="btnUploadCancel" type="button">Cancel</button>
        <button class="btn btn-primary" id="btnUploadProcess" type="button">Process Upload</button>
      </div>
    </div>
  </div>

  <div class="shell">
    <div class="card">
      <div class="hdr">
        <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap">
        <div>
          <label>Facility</label><br/>
          <select id="facility" class="ipt">
            <option value="">Select facility…</option>
          </select>
        </div>

          <div class="pillrow" style="margin-bottom:2px">
            <button class="pill" id="vFull" aria-pressed="true">Full Census</button>
            <button class="pill" id="vNew" aria-pressed="false">New Admissions</button>
            <button class="pill" id="vDis" aria-pressed="false">Discharges</button>
          </div>

          <button class="btn" id="btnLoad">Load</button>
          <button class="btn btn-primary" id="btnExport">Export CSV</button>
        </div>

        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <button class="btn" id="btnOpenUpload" type="button">Upload PDFs</button>
        </div>
      </div>

      <div class="split">
        <div class="list" id="list"></div>
        <div class="detail" id="detail">
          <div class="hint">Select a patient to review details.</div>
        </div>
      </div>
    </div>
  </div>

<script>
  let currentView = "full";
  let rows = [];
  let selectedIndex = -1;

  function setLoading(isLoading, text, sub){
    const ov = document.getElementById("loadingOverlay");
    const t = document.getElementById("loadingText");
    const s = document.getElementById("loadingSub");

    if(t) t.textContent = text || "Loading…";
    if(s) s.textContent = sub || "Please wait";

    if(ov) ov.style.display = isLoading ? "flex" : "none";

    // Disable key buttons while loading (prevents double submits)
    const btnLoad = document.getElementById("btnLoad");
    const btnExport = document.getElementById("btnExport");
    const uploadOpenBtn = document.getElementById("btnOpenUpload");

    if(btnLoad) btnLoad.disabled = isLoading;
    if(btnExport) btnExport.disabled = isLoading;
    if(uploadOpenBtn) uploadOpenBtn.disabled = isLoading;
  }

  function openSettings(){
    const ov = document.getElementById("settingsOverlay");
    if(ov) ov.style.display = "flex";
    const inp = document.getElementById("adminToken");
    if(inp){
      inp.value = getAdminToken();
      setTimeout(() => inp.focus(), 0);
    }
  }

  function closeSettings(){
    const ov = document.getElementById("settingsOverlay");
    if(ov) ov.style.display = "none";
  }

  function getAdminToken(){
    return (localStorage.getItem("census_admin_token") || "").trim();
  }

  function setAdminToken(v){
    localStorage.setItem("census_admin_token", (v || "").trim());
  }

  async function adminFetch(url, opts){
    const token = getAdminToken();
    if(!token){
      openSettings();
      throw new Error("Missing admin token");
    }
    const headers = Object.assign({}, (opts && opts.headers) ? opts.headers : {}, {
      "x-admin-token": token
    });
    return fetch(url, Object.assign({}, opts || {}, { headers }));
  }

  function initTokenUI(){
    const el = document.getElementById("adminToken");
    if(el) el.value = getAdminToken();

    const btnOpen = document.getElementById("btnSettings");
    const btnClose = document.getElementById("btnSettingsClose");
    const btnCancel = document.getElementById("btnSettingsCancel");
    const btnSave = document.getElementById("btnSettingsSave");
    const overlay = document.getElementById("settingsOverlay");

    if(btnOpen) btnOpen.addEventListener("click", openSettings);
    if(btnClose) btnClose.addEventListener("click", closeSettings);
    if(btnCancel) btnCancel.addEventListener("click", closeSettings);

    if(btnSave) btnSave.addEventListener("click", () => {
      const v = (el ? el.value : "").trim();
      setAdminToken(v);
      closeSettings();
    });

    // click outside modal closes
    if(overlay){
      overlay.addEventListener("click", (e) => {
        if(e.target === overlay) closeSettings();
      });
    }

    // ESC closes
    document.addEventListener("keydown", (e) => {
      if(e.key === "Escape") closeSettings();
    });
  }

  function setView(v){
    currentView = v;
    document.getElementById("vFull").setAttribute("aria-pressed", v==="full");
    document.getElementById("vNew").setAttribute("aria-pressed", v==="new");
    document.getElementById("vDis").setAttribute("aria-pressed", v==="discharged");
  }

  async function refreshFacilityDropdown(keepValue){
    const sel = document.getElementById("facility");
    if(!sel) return;

    const prev = (keepValue !== undefined) ? keepValue : sel.value;

    const res = await adminFetch(`/admin/census/facilities`);
    const data = await res.json();

    const facilities = (data.facilities || []).filter(Boolean);

    sel.innerHTML = `<option value="">Select facility…</option>` +
      facilities.map(f => `<option value="${escapeHtml(f)}">${escapeHtml(f)}</option>`).join("");

    if(prev && facilities.includes(prev)){
      sel.value = prev;
    }
  }

  async function load(){
    const facility = (document.getElementById("facility").value || "").trim();
    if(!facility){ alert("Select a facility."); return; }

    const res = await adminFetch(`/admin/census/view?facility_name=${encodeURIComponent(facility)}&view=${encodeURIComponent(currentView)}`);
    const data = await res.json();
    rows = (data.rows || []);
    selectedIndex = -1;
    renderList();
    renderDetail();
  }

  function renderList(){
    const el = document.getElementById("list");
    el.innerHTML = "";
    if(rows.length === 0){
      el.innerHTML = `<div class="item"><div class="title">No rows</div><div class="sub">Upload PDFs, then Load.</div></div>`;
      return;
    }
    rows.forEach((r, idx) => {
      const name = `${r.last_name||""}, ${r.first_name||""}`.replace(/^,\s*/,"").trim() || "(No name)";
      const sub = [
        r.room_number ? `Room ${r.room_number}` : "",
        r.admission_date ? `Adm ${r.admission_date}` : "",
        r.dob ? `DOB ${r.dob}` : ""
      ].filter(Boolean).join(" • ");

      const div = document.createElement("div");
      div.className = "item" + (idx===selectedIndex ? " active":"");
      div.innerHTML = `<div class="title">${escapeHtml(name)}</div><div class="sub">${escapeHtml(sub)}</div>`;
      div.onclick = () => { selectedIndex = idx; renderList(); renderDetail(); };
      el.appendChild(div);
    });
  }

  function renderDetail(){
    const el = document.getElementById("detail");
    if(selectedIndex < 0 || !rows[selectedIndex]){
      el.innerHTML = `<div class="hint">Select a patient to review details.</div>`;
      return;
    }
    const r = rows[selectedIndex];
    el.innerHTML = `
      <div class="title" style="font-size:18px">${escapeHtml((r.first_name||"") + " " + (r.last_name||""))}</div>
      <div class="sub">${escapeHtml(r.facility_name||"")}</div>
      <div class="divider"></div>
      <div class="kv">
        <div>DOB</div><div>${escapeHtml(r.dob||"")}</div>
        <div>Phone</div><div>${escapeHtml(r.home_phone||"")}</div>
        <div>Address</div><div>${escapeHtml([r.address,r.city,r.state,r.zip].filter(Boolean).join(", "))}</div>
        <div>Room</div><div>${escapeHtml(r.room_number||"")}</div>
        <div>Admission</div><div>${escapeHtml(r.admission_date||"")}</div>
        <div>Discharge</div><div>${escapeHtml(r.discharge_date||"")}</div>
        <div>Insurance</div><div>${escapeHtml(r.primary_ins||"")} ${escapeHtml(r.primary_number||"")}</div>
        <div>PCP</div><div>${escapeHtml(r.primary_care_phys||"")}</div>
        <div>Attending</div><div>${escapeHtml(r.attending_phys||"")}</div>
        <div>Reason</div><div>${escapeHtml(r.reason_admission||"")}</div>
      </div>
    `;
  }

  async function exportCsv(){
    const facility = document.getElementById("facility").value.trim();
    if(!facility){ alert("Enter a facility name."); return; }

    const url = `/admin/census/export.csv?facility_name=${encodeURIComponent(facility)}&view=${encodeURIComponent(currentView)}`;
    const res = await adminFetch(url, { method: "GET" });

    if(!res.ok){
      const txt = await res.text().catch(()=> "");
      alert(`Export failed (${res.status}). ${txt}`);
      return;
    }

    const blob = await res.blob();
    const a = document.createElement("a");
    const objUrl = URL.createObjectURL(blob);
    a.href = objUrl;
    a.download = `census_${facility.replace(/\s+/g,"_")}_${currentView}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(objUrl);
  }

  document.getElementById("vFull").onclick = () => { setView("full"); load(); };
  document.getElementById("vNew").onclick  = () => { setView("new"); load(); };
  document.getElementById("vDis").onclick  = () => { setView("discharged"); load(); };
  document.getElementById("btnLoad").onclick = load;
  document.getElementById("btnExport").onclick = () => exportCsv();

  let selectedUploadFiles = [];

  function resetUploadState(){
    // clear the in-memory list
    selectedUploadFiles = [];

    // clear the hidden file input so browser doesn't keep "3 files selected"
    const fileInput = document.getElementById("uploadFiles");
    if(fileInput) fileInput.value = "";

    // reset UI
    renderUploadCount();
    setUploadProgress("", 0);
  }

  function openUpload(){
    resetUploadState(); // ✅ always start fresh when opening
    const ov = document.getElementById("uploadOverlay");
    if(ov) ov.style.display = "flex";
  }

  function closeUpload(){
    resetUploadState(); // ✅ cancel/close resets too
    const ov = document.getElementById("uploadOverlay");
    if(ov) ov.style.display = "none";
  }

  function renderUploadCount(){
    const el = document.getElementById("fileCount");
    if(!el) return;
    const n = selectedUploadFiles.length;
    el.textContent = n ? `${n} file(s) selected.` : "No files selected.";
  }

  function setUploadProgress(text, pct){
    const t = document.getElementById("uploadStatusText");
    const bar = document.getElementById("uploadBar");
    if(t) t.textContent = text || "";
    if(bar) bar.style.width = `${Math.max(0, Math.min(100, pct || 0))}%`;
  }

  function initUploadModal(){
    const btnOpen = document.getElementById("btnOpenUpload");
    const btnClose = document.getElementById("btnUploadClose");
    const btnCancel = document.getElementById("btnUploadCancel");
    const btnBrowse = document.getElementById("btnBrowse");
    const btnProcess = document.getElementById("btnUploadProcess");
    const overlay = document.getElementById("uploadOverlay");
    const fileInput = document.getElementById("uploadFiles");
    const drop = document.getElementById("dropzone");

    if(btnOpen) btnOpen.addEventListener("click", openUpload);
    if(btnClose) btnClose.addEventListener("click", closeUpload);
    if(btnCancel) btnCancel.addEventListener("click", closeUpload);

    if(overlay){
      overlay.addEventListener("click", (e) => {
        if(e.target === overlay) closeUpload();
      });
    }

    if(btnBrowse && fileInput){
      btnBrowse.addEventListener("click", () => fileInput.click());
    }

    if(fileInput){
      fileInput.addEventListener("change", () => {
        selectedUploadFiles = Array.from(fileInput.files || []);
        renderUploadCount();
      });
    }

    if(drop){
      drop.addEventListener("dragover", (e) => {
        e.preventDefault();
        drop.style.boxShadow = "0 0 0 4px rgba(168,230,207,.35)";
      });
      drop.addEventListener("dragleave", () => {
        drop.style.boxShadow = "";
      });
      drop.addEventListener("drop", (e) => {
        e.preventDefault();
        drop.style.boxShadow = "";
        const files = Array.from(e.dataTransfer.files || []).filter(f => f.type === "application/pdf");
        selectedUploadFiles = files;
        if(fileInput){
          // keep the input consistent for the user
          // (can't programmatically set FileList reliably across all browsers, so we track in selectedUploadFiles)
        }
        renderUploadCount();
      });
    }

    if(btnProcess){
      btnProcess.addEventListener("click", async () => {
        if(!selectedUploadFiles.length){
          alert("Select one or more PDFs.");
          return;
        }

        setLoading(true, "Uploading PDFs…", "Processing and updating census runs");

        try{
          setUploadProgress("Starting upload…", 2);

          const fd = new FormData();
          for(const f of selectedUploadFiles) fd.append("files", f);

          const res = await adminFetch("/admin/census/upload", { method:"POST", body: fd });
          const data = await res.json().catch(() => null);

          if(!res.ok || !data || !data.ok || !data.job_id){
            alert(`Upload failed (${res.status}). ${(data && (data.detail || data.message)) ? (data.detail || data.message) : ""}`);
            return;
          }

          // Poll job status
          const jobId = data.job_id;
          setUploadProgress("Processing…", 5);

          const started = Date.now();
          let finalStatus = null;

          while(true){
            const stRes = await adminFetch(`/admin/census/upload-status?job_id=${encodeURIComponent(jobId)}`);
            const st = await stRes.json();
            finalStatus = st;

            const job = st.job || {};
            const total = Number(job.total_files || 0);
            const done = Number(job.processed_files || 0);
            const pct = total ? Math.round((done / total) * 100) : 0;

            setUploadProgress(job.message || job.status || "Working…", Math.max(5, pct));

            if(job.status === "done"){
              setUploadProgress("Complete.", 100);
              break;
            }
            if(job.status === "error"){
              alert(`Upload job error: ${job.message || "Unknown error"}`);
              break;
            }

            await new Promise(r => setTimeout(r, 900));
            if(Date.now() - started > 15 * 60 * 1000) break;
          }

          // warn about scanned PDFs we skipped
          try{
            const files = (finalStatus && finalStatus.files) ? finalStatus.files : [];
            const scannedSkipped = files.filter(f =>
              (f.status === "skipped") && String(f.detail || "").toLowerCase().includes("no extractable text")
            );

            if(scannedSkipped.length){
              const names = scannedSkipped.map(f => `• ${f.filename}`).join("\n");
              alert(
                `Some PDFs appear to be scanned/image-only and were skipped:\n\n${names}\n\n` +
                `Tip: Re-export from the EMR as a text PDF if possible.`
              );
            }
          }catch(e){
            // don't block UX if alert formatting fails
          }

          // ✅ refresh facility dropdown (new facility names may have been added by this upload)
          await refreshFacilityDropdown(true);

          // ✅ close modal
          closeUpload();

        }catch(e){
          alert(`Upload failed: ${e && e.message ? e.message : e}`);
        }finally{
          setLoading(false);
        }
      });
    }
  }

  function escapeHtml(str){
    return (str||"").replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }
  
document.addEventListener("DOMContentLoaded", () => {
  // Settings modal (Admin token)
  initTokenUI();

  // Upload PDFs modal (drag/drop + browse + process)
  initUploadModal();

  // Populate facility dropdown on first load
  refreshFacilityDropdown();
});

</script>
</body>
</html>
