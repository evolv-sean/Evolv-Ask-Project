<!doctype html>
<html lang="en">
  <head>
    <style>
      .orders-grid{display:grid;grid-template-columns: repeat(2, minmax(0,1fr));gap:12px;}
      .orders-grid .field{min-width:0;}
      .orders-grid .field.full{grid-column:1 / -1;}
      .orders-actions{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;align-items:center;}
      .orders-table-actions{display:flex;gap:6px;align-items:center;}    .orders-header-actions{display:flex;gap:8px;align-items:center}    .orders-table-wrap{margin-top:-6px}    .orders-stack{display:flex;flex-direction:column;gap:4px}    .orders-stack-title{font-size:12px;font-weight:900;color:var(--navy)}    .orders-stack-sub{font-size:11px;font-weight:800;color:var(--muted);line-height:1.2}    .orders-table-actions .btn-icon{width:30px;height:30px;border-radius:8px}    .doc-modal-backdrop{position:fixed;inset:0;background:rgba(15,23,42,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}    .doc-modal{width:min(860px,96vw);background:#fff;border-radius:16px;border:1px solid #e6e8ef;box-shadow:0 18px 60px rgba(0,0,0,.25);overflow:hidden}    .doc-modal-head{padding:14px 16px;border-bottom:1px solid #eef0f4;display:flex;align-items:flex-start;justify-content:space-between;gap:10px}    .doc-modal-title{font-size:14px;font-weight:900;color:#111827}    .doc-modal-sub{margin-top:2px;font-size:12px;color:#667085}    .doc-modal-body{padding:14px 16px}    .doc-modal-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}    .doc-modal-footer{padding:12px 16px;border-top:1px solid #eef0f4;display:flex;justify-content:flex-end;gap:10px}    .doc-modal-close{padding:10px 12px;border-radius:12px;border:1px solid #d0d5dd;background:#fff;cursor:pointer;font-size:12px;font-weight:800} .checkwrap{border:1px solid rgba(13,59,102,.18);border-radius:12px;background:#fff;padding:10px} .checksearch{width:100%;border:1px solid rgba(13,59,102,.18);border-radius:12px;padding:10px;font-size:12px;outline:none;margin-bottom:10px} .checklist{max-height:190px;overflow:auto;padding-right:6px} .checkrow{display:flex;align-items:flex-start;gap:10px;padding:8px 6px;border-radius:10px;font-size:12px;line-height:1.25} .checkrow:hover{background: rgba(77,168,218,.08);} .checkrow .agmeta{color: var(--muted);font-size:11px;font-weight:700}
      .orders-status{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid rgba(13,59,102,.16);background:rgba(13,59,102,.04);font-weight:900;font-size:10px;color: rgba(13,59,102,.88);text-transform:capitalize;}
      .orders-status[data-status="signed"], .orders-status[data-status="emr signed"], .orders-status[data-status="emr-signed"]{border-color: rgba(47,122,90,.45);background: rgba(168,230,207,.22);color:#0f4d3b;}
      .orders-status[data-status="declined"]{border-color: rgba(199,107,107,.5);background: rgba(199,107,107,.12);color:#7a2f2f;}
      .orders-status[data-status="pending"]{border-color: rgba(77,168,218,.4);background: rgba(77,168,218,.12);color:#254b63;}
    </style>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Coordinator Workspace</title>
      <style>    :root{      --navy:#0D3B66;      --mint:#A8E6CF;      --mint-2: rgba(168,230,207,.35);      --sky:#4DA8DA;      --cool:#F5F7FA;      --neg:#C76B6B;      --plum:#7C6D8A;      --slate:#7A8699;      --bg: var(--cool);      --surface:#ffffff;      --text:#0f172a;      --muted:#55657f;      --muted2:#6b7280;      --line: rgba(13,59,102,.14);      --line-strong: rgba(13,59,102,.22);      --shadow: 0 10px 28px rgba(0,0,0,.08);      --shadow-soft: 0 8px 18px rgba(13,59,102,.12);      --r-xl:18px;      --r-lg:16px;      --r-md:12px;      --r-sm:10px;      --ring: 0 0 0 3px rgba(168,230,207,.50);      --ring2: 0 0 0 4px rgba(168,230,207,.35);    }    *{box-sizing:border-box}    html,body{height:100%;overflow:hidden}    body{      margin:0;      background: #f5f7fa;      background-repeat:no-repeat;      color:var(--text);      font-family:"Manrope","Segoe UI",system-ui,-apple-system,Arial,sans-serif;      overflow:hidden;    }    /* Design library components */    .card{      border:1px solid var(--line);      background:rgba(255,255,255,.92);      backdrop-filter: blur(4px);      border-radius:var(--r-xl);      box-shadow: var(--shadow);      overflow:hidden;    }    .btn{      display:inline-flex; align-items:center; justify-content:center; gap:8px;      border-radius:12px; padding:10px 14px;      border:1px solid var(--line-strong);      background:#fff; color:var(--navy);      font-weight:900; font-size:13px;      cursor:pointer;      transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease, background .15s ease, color .15s ease;    }    .btn:hover{border-color: rgba(168,230,207,.9); box-shadow: var(--ring2); transform: translateY(-1px);}    .btn:active{transform: translateY(0px)}    .btn-primary{background: var(--navy); border-color: rgba(13,59,102,.95); color:#fff; box-shadow: var(--shadow-soft);}    .btn-primary:hover{background:#0b3357; border-color:#0b3357; box-shadow: 0 10px 26px rgba(13,59,102,.18);}    .btn-ghost{background: transparent;}    .btn-small{padding:8px 12px;border-radius:10px;font-size:12px}    .btn[disabled]{opacity:.55; cursor:not-allowed; box-shadow:none; transform:none;}    label{display:block;font-size:12px;color:#374151;margin:0 0 6px;font-weight:800}    .ipt, select, textarea{      width:100%; max-width:100%;      padding:12px 12px;      border-radius:12px;      border:1px solid rgba(13,59,102,.18);      background:#fff; font-size:14px; outline:none;      transition: box-shadow .15s ease, border-color .15s ease;    }    .ipt:focus, select:focus, textarea:focus{border-color: rgba(168,230,207,.95); box-shadow: var(--ring);}    .pill{      display:inline-flex; align-items:center; justify-content:center;      padding:6px 10px; border-radius:999px;      border:1px solid rgba(13,59,102,.18);      background:#fff; color:#334155;      font-weight:800; font-size:12px; line-height:1;      cursor:pointer;      transition: border-color .15s ease, box-shadow .15s ease, background .15s ease, color .15s ease;    }    .pill:hover{border-color: rgba(168,230,207,.9); box-shadow: 0 0 0 3px rgba(168,230,207,.35);}    .pill[aria-pressed="true"]{      border-color: rgba(168,230,207,.95);      box-shadow: 0 10px 24px rgba(168,230,207,.18), 0 0 0 3px rgba(168,230,207,.45);      background: rgba(168,230,207,.18);      color: var(--navy);    }    .table-wrap{      border-radius:16px;      border:1px solid rgba(13,59,102,.14);      overflow:auto;      background:#fff;      max-height: clamp(360px, calc(60vh + 70px), 710px);    }    table{width:100%; border-collapse:collapse; font-size:12px}    thead{background: rgba(13,59,102,.05)}    th, td{padding:10px 14px; text-align:left}    th{font-size:10px;font-weight:900;text-transform:uppercase;letter-spacing:.09em;color:#4b5563;border-bottom:1px solid rgba(13,59,102,.12);white-space:nowrap;}    td{border-bottom:1px solid rgba(13,59,102,.10);color:#111827;vertical-align:middle;}    tbody tr:nth-child(even){background: rgba(13,59,102,.02)}    tbody tr:hover{background: rgba(168,230,207,.18)}    tbody tr:last-child td{border-bottom:none}    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid rgba(13,59,102,.16);background: rgba(13,59,102,.04);font-weight:900;font-size:10px;color: rgba(13,59,102,.88);letter-spacing:.02em;line-height:1;}    .badge .dot{width:6px;height:6px;border-radius:999px;background:rgba(77,168,218,.85)}    .dl-modal-overlay{      position:fixed; inset:0;      display:none;      align-items:center;      justify-content:center;      background:rgba(15,23,42,.55);      backdrop-filter: blur(2px);      z-index:10000;      padding:16px;    }    #patientEditModal{background:rgba(13,59,102,.12);}    #patientEditModal .dl-modal-bar .btn{color:#fff;border-color: rgba(255,255,255,.35);}    #patientEditModal .dl-modal-bar .btn:hover{border-color:#fff; box-shadow: 0 0 0 3px rgba(255,255,255,.25);}    #dcDetailsModal{background:rgba(13,59,102,.12);}    #dcDetailsModal .dl-modal{max-height:92vh;display:flex;flex-direction:column}    #dcDetailsModal .dl-modal-body{overflow:auto;flex:1}    #pcpApptModal{background:rgba(13,59,102,.12);}    #pcpApptModal .dl-modal{max-height:92vh;display:flex;flex-direction:column}    #pcpApptModal .dl-modal-body{overflow:auto;flex:1}    .dl-modal{      width:min(720px, 100%);      border-radius:16px;      border:1px solid #e6e8ef;      background:#fff;      box-shadow:0 18px 60px rgba(0,0,0,.25);      overflow:hidden;    }    .dl-modal-bar{      background:#fff;      color:#111827;      padding:14px 16px;      display:flex;      align-items:center;      justify-content:space-between;      font-weight:900;      letter-spacing:.2px;      border-bottom:1px solid #eef0f4;    }    .dl-modal-body{padding:14px 16px}    .dl-modal-actions{      padding:0 16px 16px;      display:flex;      justify-content:flex-end;      gap:10px;      flex-wrap:wrap;      align-items:center;    }    .dl-modal .btn{      border:1px solid #d0d5dd;      background:#fff;      color:#111827;      font-weight:800;      font-size:12px;      border-radius:12px;      padding:10px 12px;    }    .dl-modal .btn-primary{      background:#111827;      border-color:#111827;      color:#fff;      box-shadow:none;    }    .dl-modal .btn-primary:hover{background:#0b1220;border-color:#0b1220;}    .dl-modal .btn-ghost{background:#fff;}    .fax-modal-table{      margin-top:12px;      border:1px solid #eef0f4;      border-radius:14px;      overflow:hidden;    }    .fax-modal-table table{width:100%;border-collapse:collapse;}    .fax-modal-table thead tr{background:#f8fafc;}    .fax-modal-table th{      text-align:left;      padding:10px;      font-size:12px;      color:#475467;    }    .fax-modal-table td{      padding:10px;      font-size:13px;      color:#111827;      border-bottom:1px solid #eef0f5;      vertical-align:middle;    }    .fax-modal-table tbody tr:last-child td{border-bottom:0;}    .fax-status{      display:inline-flex;      align-items:center;      gap:6px;      padding:4px 8px;      border-radius:999px;      border:1px solid #d0d5dd;      background:#fff;      font-size:11px;      font-weight:800;      color:#344054;      text-transform:capitalize;    }    .fax-status.error{border-color: rgba(199,107,107,.6); color:#9b3d3d; background:rgba(199,107,107,.08);}    .fax-status.queued{border-color: rgba(77,168,218,.35); color:#254b63; background:rgba(77,168,218,.08);}    .fax-status.sent{border-color: rgba(47,122,90,.35); color:#2f7a5a; background:rgba(168,230,207,.16);}    .link-inline{      color:#2563eb;      font-weight:800;      text-decoration:none;      cursor:pointer;    }.link-inline:hover{text-decoration:underline;}    .note-list-table td .icon-plain{margin-left:10px;}    .doc-input{      box-sizing:border-box;      padding:10px;      border:1px solid #d0d5dd;      border-radius:12px;      font-size:13px;      outline:none;      background:#fff;    }    .doc-input.error{      border-color: rgba(199,107,107,.8);      box-shadow:0 0 0 2px rgba(199,107,107,.15);    }    .doc-iconbtn{      width:40px;      height:40px;      border-radius:12px;      border:1px solid #d0d5dd;      background:#fff;      cursor:pointer;      display:flex;      align-items:center;      justify-content:center;      font-weight:900;      color:#0d3b66;      transition:border-color .15s ease, box-shadow .15s ease, transform .15s ease;    }    .doc-iconbtn:hover{      border-color: rgba(168,230,207,.9);      box-shadow:0 10px 18px rgba(13,59,102,.10);      transform: translateY(-1px);    }    .doc-iconbtn svg{      width:18px;      height:18px;    }    .doc-iconbtn .cls-1{      stroke:currentColor;      fill:none;      stroke-linecap:round;      stroke-linejoin:round;      stroke-width:5px;    }    .doc-msg{      display:none;      margin-top:10px;      padding:10px;      border-radius:12px;      background:rgba(239,68,68,.08);      border:1px solid rgba(239,68,68,.25);      color:#991b1b;      font-size:12px;    }    .appt-modal-row{      display:flex;      gap:10px;      flex-wrap:wrap;      align-items:center;    }    .appt-section{      margin-top:12px;      padding:12px;      border:1px solid #eef0f4;      border-radius:14px;      background:#f9fafb;    }    .appt-section-title{      font-size:12px;      font-weight:800;      color:#475467;      margin-bottom:8px;      text-transform:uppercase;      letter-spacing:.08em;    }    .appt-edit-meta{      margin-top:8px;      font-size:12px;      color:#475467;      display:flex;      gap:10px;      align-items:center;      flex-wrap:wrap;    }    .appt-edit-meta button{      background:none;      border:0;      padding:0;      color:#0d3b66;      font-weight:800;      cursor:pointer;    }    .appt-modal-table{      margin-top:12px;      border:1px solid #eef0f4;      border-radius:14px;      overflow:hidden;    }    .appt-modal-table table{      width:100%;      border-collapse:collapse;    }    .appt-modal-table thead tr{      background:#f8fafc;    }    .appt-modal-table th{      text-align:left;      padding:10px;      font-size:12px;      color:#475467;    }    .appt-modal-table td{      padding:10px;      font-size:13px;      color:#111827;      border-bottom:1px solid #eef0f5;    }    .appt-modal-table tbody tr:last-child td{      border-bottom:0;    }    .dl-toast{      position:fixed;      left:16px;      right:auto;      bottom:16px;      width:min(420px, calc(100vw - 32px));      background:#fff;      border:1px solid rgba(13,59,102,.14);      border-radius:18px;      box-shadow: var(--shadow);      z-index:11000;      display:none;      transform: translateY(8px);      opacity:0;      transition: opacity .18s ease, transform .18s ease;      overflow:hidden;      --toast-accent: var(--sky);    }    .dl-toast[data-variant="success"]{--toast-accent:#4fb99f;}    .dl-toast[data-variant="error"]{--toast-accent:var(--neg);}    .dl-toast[data-variant="info"]{--toast-accent:var(--sky);}    .dl-toast[data-variant="warning"]{--toast-accent:var(--plum);}    .dl-toast.show{display:flex;opacity:1;transform: translateY(0)}    .dl-toast-accent{width:6px;background:var(--toast-accent);}    .dl-toast-content{flex:1;padding:12px 14px;display:flex;flex-direction:column;gap:8px}    .dl-toast-top{display:flex;align-items:flex-start;gap:10px;}    .dl-toast-icon{width:34px;height:34px;border-radius:999px;background:var(--toast-accent);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:16px;flex:0 0 auto;}    .dl-toast[data-variant="success"] .dl-toast-icon::before{content:"\2713";}    .dl-toast[data-variant="error"] .dl-toast-icon::before{content:"\00d7";}    .dl-toast[data-variant="info"] .dl-toast-icon::before{content:"i";}    .dl-toast[data-variant="warning"] .dl-toast-icon::before{content:"!";}    .dl-toast-text{flex:1;min-width:0;}    .dl-toast-title{font-weight:900;color: var(--navy);font-size:13px;}    .dl-toast-sub{margin-top:2px;font-size:12px;color: var(--muted);font-weight:800;line-height:1.35;}    .dl-toast-close{border:none;background:transparent;cursor:pointer;padding:6px;border-radius:10px;color:#64748b;font-weight:900;}    .dl-toast-close:hover{background: rgba(13,59,102,.06)}    .dl-toast-actions{margin-top:2px;display:none;gap:8px;justify-content:flex-end;}    /* Layout */    .layout{display:flex;min-height:100vh}    .sidebar{      width:240px;      background:#fff;      border-right:1px solid rgba(13,59,102,.08);      padding:18px 16px;      display:flex;      flex-direction:column;      gap:16px;    }    .brand{      display:flex;      flex-direction:column;      gap:6px;    }    .brand-title{font-weight:900;color:var(--navy);font-size:16px;letter-spacing:.02em}    .brand-sub{font-size:12px;color:var(--muted);font-weight:800}    .queue-list{display:flex;flex-direction:column;gap:8px}    .queue-item{      display:flex;align-items:center;justify-content:space-between;gap:8px;      padding:10px 12px;border-radius:12px;border:1px solid rgba(13,59,102,.10);      background:rgba(13,59,102,.03);cursor:pointer;font-size:13px;font-weight:800;color:var(--navy);      transition: background .15s ease, border-color .15s ease, transform .15s ease;    }    .queue-item.urgent{      border-color: rgba(199,107,107,.65);      background:rgba(13,59,102,.03);    }    .queue-item.urgent.active{      border-color: rgba(199,107,107,.75);      background:rgba(168,230,207,.28);      box-shadow: 0 10px 24px rgba(199,107,107,.18);    }    .queue-sep{      margin:10px 4px 6px;      height:1px;      background:rgba(13,59,102,.12);      position:relative;    }    .queue-item:hover{border-color: rgba(168,230,207,.95); transform: translateY(-1px);}    .queue-item.active{      background:rgba(168,230,207,.28);      border-color: rgba(168,230,207,.95);      box-shadow: 0 10px 24px rgba(168,230,207,.18);    }    .queue-count{      background:rgba(13,59,102,.08);      color:var(--navy);      border-radius:999px;      padding:4px 8px;      font-size:11px;      font-weight:900;    }    .main{flex:1;display:flex;flex-direction:column;min-width:0}    .header{      padding:18px 22px;      display:flex;      align-items:center;      justify-content:space-between;      gap:16px;      border-bottom:1px solid rgba(13,59,102,.08);      background:rgba(255,255,255,.9);      position:sticky; top:0; z-index:5;    }    .header-left{display:flex;flex-direction:column;gap:6px}    .header-title{font-size:20px;font-weight:900;color:var(--navy)}    .header-sub{font-size:12px;color:var(--muted);font-weight:800}    .header-actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap}    .search-wrap{min-width:280px;flex:1}    .toggle{      display:flex;align-items:center;gap:8px;      padding:8px 12px;border-radius:999px;border:1px solid rgba(13,59,102,.18);      background:#fff;font-size:12px;font-weight:800;color:var(--navy);    }    .toggle input{width:16px;height:16px}    .content{padding:18px 22px 30px;display:flex;flex-direction:column;gap:14px}    .filters{display:grid;grid-template-columns: 1.1fr 1fr 1.2fr auto;gap:12px;align-items:end}    .filters .field{min-width:0}    .filters .toggle{justify-content:center}    .summary{      display:grid;      grid-template-columns: repeat(3, 1fr);      gap:12px;      padding:12px 16px;      border-bottom:1px solid rgba(13,59,102,.08);      background:rgba(13,59,102,.02);    }    .summary-item{display:flex;flex-direction:column;gap:4px}    .summary-item span{font-size:11px;color:var(--muted);font-weight:800;text-transform:uppercase;letter-spacing:.08em}    .summary-item strong{font-size:18px;color:var(--navy)}    .task-chips{display:flex;gap:6px;flex-wrap:wrap}    .task-chip{      padding:4px 8px;border-radius:999px;border:1px solid rgba(13,59,102,.15);      font-size:10px;font-weight:900;color:var(--navy);background:rgba(13,59,102,.04);    }    .task-chip.urgent{      border-color: rgba(199,107,107,.6);      background: rgba(199,107,107,.14);      color:#7a2f2f;    }    .service-lines{display:flex;flex-direction:column;gap:6px}    .service-line{display:flex;flex-wrap:wrap;gap:6px;align-items:center}    .service-label{font-size:10px;font-weight:900;color:var(--muted);letter-spacing:.06em;text-transform:uppercase}    .service-pill{      padding:4px 8px;border-radius:999px;border:1px solid rgba(13,59,102,.18);      font-size:10px;font-weight:900;color:var(--navy);background:#fff;    }    .service-pill.danger{      border-color: rgba(199,107,107,.65);      background: rgba(199,107,107,.12);      color:#7a2f2f;    }    .risk-red{border-color: rgba(199,107,107,.55); background: rgba(199,107,107,.12); color:#7a2f2f;}    .risk-red .dot{background:var(--neg)}    .risk-yellow{border-color: rgba(77,168,218,.35); background: rgba(77,168,218,.12); color:#254b63;}    .risk-yellow .dot{background:var(--sky)}    .risk-green{border-color: rgba(168,230,207,.6); background: rgba(168,230,207,.2); color:#0f4d3b;}    .risk-green .dot{background:#4fb99f}    .row-actions{display:flex;gap:8px;align-items:center}    .row-actions.split{justify-content:space-between}    .row-actions-left,.row-actions-right{display:flex;gap:8px;align-items:center}    .row-actions .btn{white-space:nowrap}    .contact-meta-grid{display:grid;grid-template-columns: repeat(3, minmax(0,1fr));gap:12px;align-items:start}    .contact-meta-col{display:flex;flex-direction:column;align-items:center;text-align:center;gap:6px}    .contact-meta-col.left{align-items:flex-start;text-align:left}    .contact-meta-col.center{align-items:center;text-align:center}    .contact-meta-col.right{align-items:flex-end;text-align:right}    .contact-meta-label{font-size:11px;color:var(--muted);font-weight:800}    .contact-meta-value{font-size:11px;color:var(--muted);font-weight:800}    .contact-meta-actions{display:flex;gap:8px;align-items:center;justify-content:center}    /* Drawer */    .drawer-overlay{      position:fixed; inset:0; background:rgba(13,59,102,.3);      opacity:0; pointer-events:none; transition: opacity .18s ease; z-index:9000;    }    .drawer{      position:fixed; right:0; top:0; height:100%;      width:min(520px, 100%);      background:#fff; box-shadow:none;      transform: translateX(100%); transition: transform .2s ease; z-index:9100;      display:flex;flex-direction:column;    }    .drawer.open{transform: translateX(0);box-shadow: -10px 0 24px rgba(13,59,102,.12);}    .drawer-overlay.show{opacity:1; pointer-events:auto}    .drawer-header{      padding:12px 18px 10px;      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;    }    .drawer-title{font-size:18px;font-weight:900;color:var(--navy)}    .drawer-sub{font-size:12px;color:var(--muted);font-weight:800}    .drawer-body{padding:10px 18px 24px; overflow:auto; display:flex; flex-direction:column; gap:12px; min-height:0}    .drawer-body > .card{flex:0 0 auto}    .status-strip{display:grid;grid-template-columns: repeat(5, 1fr); gap:8px}    .drawer-divider{height:1px;background:rgba(13,59,102,.08);margin-top:10px}    .status-pill{padding:8px 10px;border-radius:12px;border:1px solid rgba(13,59,102,.12);background:rgba(13,59,102,.03);font-size:11px;font-weight:900;color:var(--navy);text-align:center}    .status-pill.done{background:rgba(168,230,207,.25); border-color: rgba(168,230,207,.7);}    .status-pill.block{background:rgba(199,107,107,.12); border-color: rgba(199,107,107,.4); color:#7a2f2f;}    .card-section{padding:12px 14px}    .card-header{display:flex;justify-content:space-between;align-items:center;gap:10px}    .card-title{font-size:14px;font-weight:900;color:var(--navy)}    .card-meta{font-size:11px;color:var(--muted);font-weight:800}    .orders-attending-list{display:flex;flex-direction:column;gap:6px}    .orders-attending-line{display:flex;align-items:center;gap:8px;flex-wrap:wrap}    .orders-esign-pill{display:inline-flex;align-items:center;justify-content:center;padding:4px 8px;border-radius:999px;border:1px solid rgba(168,230,207,.8);background:rgba(168,230,207,.22);color:#0f4d3b;font-size:10px;font-weight:900;line-height:1}    .card-body{margin-top:10px;display:flex;flex-direction:column;gap:8px}    .chip-row{display:flex;flex-wrap:wrap;gap:8px}    .chip-toggle{      display:inline-flex;align-items:center;justify-content:center;      padding:6px 10px;border-radius:999px;border:1px solid rgba(13,59,102,.18);      background:#fff;color:#334155;font-weight:900;font-size:11px;cursor:pointer;      transition: border-color .15s ease, box-shadow .15s ease, background .15s ease, color .15s ease;    }    .chip-toggle:hover{      border-color: rgba(168,230,207,.9);      background: rgba(168,230,207,.12);      box-shadow: 0 0 0 3px rgba(168,230,207,.18);    }    .chip-toggle.is-active{      border-color: rgba(168,230,207,.95);      background: rgba(168,230,207,.22);      color: var(--navy);    }    .activity-log{display:flex;flex-direction:column;gap:6px;max-height:160px;overflow:auto}    .activity-item{      padding:8px 10px;border-radius:12px;border:1px solid rgba(13,59,102,.10);      background:rgba(13,59,102,.03);font-size:11px;color:#1f2937;font-weight:700;    }    .activity-item.note-row{      display:flex;      align-items:center;      justify-content:space-between;      gap:8px;      cursor:pointer;    }    .activity-item.note-row:hover{      background: rgba(168,230,207,.12);      border-color: rgba(168,230,207,.45);    }    .note-text{flex:1;min-width:0}    .icon-plain.trash{color:#9aa6b2;}    .icon-plain.trash:hover{color:#6b7280;}    .btn-icon.is-selected{      box-shadow: var(--ring2);      background: rgba(168,230,207,.22);      border-color: rgba(168,230,207,.95);    }    .btn-icon.danger.is-selected{      box-shadow: 0 0 0 3px rgba(199,107,107,.25);      background: rgba(199,107,107,.16);      border-color: rgba(199,107,107,.6);    }    .info-grid{display:grid;grid-template-columns: repeat(2, minmax(0,1fr));gap:12px}    .info-section{display:flex;flex-direction:column;gap:10px}    .info-row{display:flex;flex-wrap:wrap;gap:10px}    .info-block{      border:1px solid rgba(13,59,102,.12);      background:rgba(13,59,102,.03);      border-radius:12px;      padding:8px 10px;    }    .patient-card{position:relative; padding-right:36px}    .patient-edit-btn{position:absolute; top:8px; right:8px}    .info-label{font-size:10px;font-weight:900;color:var(--muted);letter-spacing:.08em;text-transform:uppercase}    .info-value{margin-top:3px;font-size:12px;font-weight:800;color:var(--navy)}    .info-note{font-size:12px;font-weight:700;color:#1f2937;line-height:1.35}    .info-compact{display:grid;grid-template-columns: repeat(3, minmax(0,1fr));gap:10px}    .info-compact .info-block{padding:8px 10px}    .info-icons{display:flex;align-items:center;gap:8px;margin-top:6px}    .info-icon{display:inline-flex;align-items:center;justify-content:center}    .info-icon svg{width:16px;height:16px;overflow:visible}    .info-icon.confirmed{color:#2f7a5a}    .info-icon.pending{color:#9aa6b2}    .info-icon.alert{color:var(--neg)}    .info-divider{height:1px;background:rgba(13,59,102,.12);margin:10px 0}    .contact-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:6px}    .btn-icon.down{color:var(--neg);border-color: rgba(199,107,107,.45);}    .btn-icon.down svg{transform: scaleY(-1);}    .icon-plain{      border:none;background:transparent;color:var(--navy);      display:inline-flex;align-items:center;justify-content:center;      padding:4px;border-radius:8px;cursor:pointer;      transition: background .15s ease, transform .15s ease;    }    .icon-plain:hover{background: rgba(13,59,102,.06); transform: translateY(-1px);}    .icon-plain svg{width:16px;height:16px;overflow:visible}    .icon-plain svg :where(path, line, polyline, polygon, rect, circle, ellipse){      stroke: currentColor !important; fill:none !important; stroke-width: 6.5px;    }    .patient-card{position:relative}    .patient-card .patient-edit-btn{position:absolute;top:8px;right:8px}    .edit-grid{display:grid;grid-template-columns: repeat(2, minmax(0,1fr));gap:12px}    .edit-grid .full{grid-column:1 / -1}    #patientEditModal .dl-modal{max-height:92vh;display:flex;flex-direction:column}    #patientEditModal .dl-modal-body{overflow:auto;flex:1}    #infoDrawer .drawer-body{overflow:auto;flex:1}    #contactDrawer .drawer-body{overflow:auto;flex:1}    .empty{padding:24px;text-align:center;color:var(--muted);font-weight:800}    .icon-btn{      width:42px;height:42px;border-radius:12px;border:1px solid var(--line-strong);      background:#fff;color:var(--navy);display:inline-flex;align-items:center;justify-content:center;      cursor:pointer;transition: box-shadow .15s ease, border-color .15s ease, transform .15s ease;    }    .icon-btn:hover{border-color: rgba(168,230,207,.9); box-shadow: var(--ring2); transform: translateY(-1px);}    .icon-btn svg{width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:6.5px;stroke-linecap:round;stroke-linejoin:round}    .icon-btn svg :where(path, line, polyline, polygon, rect, circle, ellipse){      stroke: currentColor !important; fill:none !important; stroke-width: 6.5px;    }    .btn-icon{      width:34px;height:34px;border-radius:10px;border:1px solid var(--line-strong);      background:#fff;color:var(--navy);display:inline-flex;align-items:center;justify-content:center;      cursor:pointer;transition: box-shadow .15s ease, border-color .15s ease, transform .15s ease;    }    .btn-icon:hover{border-color: rgba(168,230,207,.9); box-shadow: var(--ring2); transform: translateY(-1px);}    .btn-icon svg{width:18px;height:18px;overflow:visible}    .btn-icon svg :where(path, line, polyline, polygon, rect, circle, ellipse){      stroke: currentColor !important; fill:none !important; stroke-width: 6.5px;    }    .btn-icon.asset-icon svg{width:18px;height:18px;overflow:visible}    .btn-icon.asset-icon svg :where(path, line, polyline, polygon, rect, circle, ellipse){      stroke: currentColor !important; fill:none !important; stroke-width:2.6px;      stroke-linecap:round; stroke-linejoin:round;    }    .btn-icon[disabled]{opacity:.78; cursor:not-allowed; box-shadow:none; transform:none;}    .btn-icon.is-selected[disabled]{opacity:1; cursor:default;}    .btn-icon.reached{color:#2f7a5a;border-color: rgba(47,122,90,.35);}    .btn-icon.vm{color:var(--neg);border-color: rgba(199,107,107,.45);}    .btn-icon.vm svg{transform: none;}    .btn-icon.danger{color:var(--neg);border-color: rgba(199,107,107,.45);}    .btn-icon.thumb-down svg{transform: scaleY(-1) scaleX(-1);}    .fab-wrap{      position:fixed;      top:18px;      right:18px;      display:flex;      flex-direction:column;      align-items:flex-end;      gap:10px;      z-index:9200;      transition: right .2s ease;    }    .drawer-open .fab-wrap{right:540px;}    .fab-btn{      width:44px;height:44px;border-radius:50%;      border:1px solid rgba(168,230,207,.9);      background: #fff;      color: var(--navy);      display:inline-flex;align-items:center;justify-content:center;      cursor:pointer;      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease, background .18s ease, opacity .18s ease;      transform-origin: center;      --fab-translate: 0px;      transform: translateY(var(--fab-translate));    }    .fab-btn:hover{      border-color: rgba(168,230,207,.95);      box-shadow: var(--ring2);      background: #fff;      transform: translateY(-1px) !important;    }    .fab-btn.n-icon svg{width:20px;height:20px;overflow:visible}    .fab-btn.n-icon svg :where(path, line, polyline, polygon, rect, circle, ellipse){      stroke: currentColor !important; fill:none !important; stroke-width:15px;      stroke-linecap:round; stroke-linejoin:round;    }    .fab-btn.asset-icon svg{width:22px;height:22px;overflow:visible}    .fab-btn.asset-icon svg :where(path, line, polyline, polygon, rect, circle, ellipse){      stroke: currentColor !important; fill:none !important; stroke-width:3.6px;      stroke-linecap:round; stroke-linejoin:round;    }    .fab-menu{      display:flex;      flex-direction:column;      gap:10px;      transform: translateY(-6px);      opacity:0;      pointer-events:none;      transition: opacity .2s ease, transform .2s ease;    }    .fab-wrap.open .fab-menu{      opacity:1;      pointer-events:auto;      transform: translateY(0);    }    .fab-menu .fab-btn{--fab-translate: -6px; opacity:0;}    .fab-wrap.open .fab-menu .fab-btn{--fab-translate: 0px; opacity:1;}    .fab-wrap.open .fab-menu .fab-btn:nth-child(1){transition-delay:.02s;}    .fab-wrap.open .fab-menu .fab-btn:nth-child(2){transition-delay:.05s;}    .fab-wrap.open .fab-menu .fab-btn:nth-child(3){transition-delay:.08s;}    .fab-wrap.open .fab-menu .fab-btn:nth-child(4){transition-delay:.11s;}    .fab-wrap.open .fab-menu .fab-btn:nth-child(5){transition-delay:.14s;}    .btn-icon.info{color:var(--neg);border-color: rgba(199,107,107,.45);}    .card-expand{display:flex;justify-content:flex-end;gap:8px;margin-top:8px}    @media (max-width: 1100px){      .filters{grid-template-columns: 1fr 1fr; }      .sidebar{display:none}    }    @media (max-width: 860px){      .header{flex-direction:column; align-items:flex-start}      .header-actions{width:100%}    }  </style>
      </head>
      <body>
        <div class="layout">
          <aside class="sidebar">
            <div class="brand">
              <div class="brand-title">Coordinator Workspace</div>
                <div class="brand-sub">Test Coordinator</div>
                </div>
                <div class="queue-list" id="queueList">
                </div>
              </aside>
              <main class="main">
                <section class="content">
                  <div class="card">
                    <div class="summary" id="summaryStrip">
                    </div>
                    <div class="card-section">
                      <div class="filters">
                        <div class="field">
                          <label>Facility</label>
                            <select id="facilityFilter">
                            </select>
                          </div>
                          <div class="field">
                            <label>Discharge window</label>
                              <select id="dateFilter">
                                <option value="all">All</option>
                                  <option value="today">Today</option>
                                    <option value="24">Next 24h</option>
                                      <option value="72">Next 72h</option>
                                      </select>
                                    </div>
                                    <div class="field">
                                      <label>Patient search</label>
                                        <input class="ipt" id="searchInput" placeholder="Search patient or facility" />
                                      </div>
                                      <button class="icon-btn" id="openFilters" aria-label="Open filters">
                                        <svg viewBox="0 0 246.98 255.82" aria-hidden="true">
                                          <line x1="137.69" y1="127.91" x2="244.23" y2="127.91"/>
                                          <line x1="3.51" y1="127.91" x2="35.59" y2="127.91"/>
                                          <circle cx="73.29" cy="127.91" r="34.97" transform="translate(-9.78 6.12) rotate(-4.48)"/>
                                          <line x1="109.3" y1="37.72" x2="2.75" y2="37.72"/>
                                          <line x1="243.47" y1="37.72" x2="211.39" y2="37.72"/>
                                          <path d="M138.73,37.72c0,19.31,15.66,34.97,34.97,34.97s34.97-15.66,34.97-34.97S193.01,2.75,173.69,2.75s-34.97,15.66-34.97,34.97Z"/>
                                          <line x1="109.3" y1="218.1" x2="2.75" y2="218.1"/>
                                          <line x1="243.47" y1="218.1" x2="211.39" y2="218.1"/>
                                          <circle cx="173.69" cy="218.1" r="34.97" transform="translate(-34.55 32.7) rotate(-9.79)"/>
                                        </svg>
                                      </button>
                                    </div>
                                  </div>
                                </div>
                                <div class="card">
                                  <div class="card-section">
                                    <div class="table-wrap">
                                      <table>
                                        <thead id="queueHead">
                                        </thead>
                                        <tbody id="queueTable">
                                        </tbody>
                                      </table>
                                      <div class="empty" id="emptyState" style="display:none">No patients match this queue + filter view.</div>
                                      </div>
                                    </div>
                                  </div>
                                </section>
                              </main>
                            </div>
                            <div class="fab-wrap" id="fabWrap">
                              <div class="fab-menu" id="fabMenu">
                                <button class="fab-btn asset-icon" title="Add Note" aria-label="Add Note">
                                  <svg viewBox="0 0 83.92 75.06" aria-hidden="true">
                                    <path d="M72.39,10.9l-35.5,35.5-3.11,11.52,11.52-3.11,35.5-35.5c2.32-2.32,2.32-6.09,0-8.41h0c-2.32-2.32-6.09-2.32-8.41,0Z"/>
                                    <path d="M76.73,23.71l2.11,2.11c1.49,1.49,1.49,3.91,0,5.4l-10.06,10.06"/>
                                    <line x1="33.77" y1="57.93" x2="30.75" y2="60.95"/>
                                    <polyline points="60.87 46.97 60.87 73.67 1.39 73.67 1.39 18.52 19.51 1.39 60.87 1.39 60.87 15.15"/>
                                    <line x1="14.38" y1="34.58" x2="39.07" y2="34.58"/>
                                    <line x1="14.38" y1="47.32" x2="29.52" y2="47.32"/>
                                    <line x1="14.38" y1="60.06" x2="25.2" y2="60.06"/>
                                    <polyline points="7.59 20.48 21.52 20.48 21.52 7.59"/>
                                    <line x1="64.14" y1="36.3" x2="55.54" y2="27.7"/>
                                  </svg>
                                </button>
                                <button class="fab-btn asset-icon" title="Send Message" aria-label="Send Message">
                                  <svg viewBox="0 0 78.61 75.44" aria-hidden="true">
                                    <path d="M49.81,50.75h-18.46c-5.19,0-9.39-4.23-9.39-9.44V10.83c0-5.22,4.2-9.44,9.39-9.44h36.47c5.19,0,9.39,4.23,9.39,9.44v30.47c0,5.22-4.2,9.44-9.39,9.44h-3.38v12.83h-.96l-13.67-12.83Z"/>
                                    <path d="M16.9,23.18h-7.83c-4.24,0-7.68,3.46-7.68,7.73v24.93c0,4.27,3.44,7.73,7.68,7.73h2.77v10.5h.48l11.89-10.5h12.11c4.24,0,7.68-3.46,7.68-7.73"/>
                                    <path d="M50.67,25.63c0,.6-.48,1.08-1.08,1.08s-1.08-.48-1.08-1.08.48-1.08,1.08-1.08,1.08.48,1.08,1.08Z"/>
                                    <path d="M37.87,25.63c0,.6-.48,1.08-1.08,1.08s-1.08-.48-1.08-1.08.48-1.08,1.08-1.08,1.08.48,1.08,1.08Z"/>
                                    <path d="M61.31,25.63c0,.6.48,1.08,1.08,1.08s1.08-.48,1.08-1.08-.48-1.08-1.08-1.08-1.08.48-1.08,1.08Z"/>
                                  </svg>
                                </button>
                                <button class="fab-btn asset-icon" title="Add Task" aria-label="Add Task">
                                  <svg viewBox="0 0 66.61 85.63" aria-hidden="true">
                                    <polyline points="51.08 15.78 65.22 15.78 65.22 84.25 1.39 84.25 1.39 15.78 15.53 15.78"/>
                                    <polyline points="25.06 36.76 18.86 42.95 14.82 38.91"/>
                                    <polyline points="25.06 49.89 18.86 56.09 14.82 52.05"/>
                                    <polyline points="25.06 63.03 18.86 69.23 14.82 65.18"/>
                                    <line x1="30.85" y1="40.39" x2="51.79" y2="40.39"/>
                                    <line x1="30.85" y1="53.53" x2="51.79" y2="53.53"/>
                                    <line x1="30.85" y1="66.66" x2="51.79" y2="66.66"/>
                                    <path d="M26.13,8.56v1.85h-6.13c-2.47,0-4.47,2-4.47,4.47v8.93h35.55v-8.93c0-2.47-2-4.47-4.47-4.47h-6.13v-1.85c0-3.96-3.21-7.17-7.17-7.17h0c-3.96,0-7.17,3.21-7.17,7.17Z"/>
                                    <line x1="33.3" y1="8.95" x2="33.3" y2="11.95"/>
                                  </svg>
                                </button>
                                <button class="fab-btn asset-icon" title="Care Team" aria-label="Care Team">
                                  <svg viewBox="0 0 81.27 77.16" aria-hidden="true">
                                    <path d="M49.7,34.62c0,17.78.06,27.65-1.86,41.15h-14.41c-1.92-13.5-1.86-23.37-1.86-41.15"/>
                                    <path d="M31.56,50.44h0s-2.42,0-2.42,0c-2.58,0-4.66-2.09-4.66-4.66v-18.08h0s5.34-4.56,16.16-4.56,16.1,4.51,16.16,4.56v18.08c0,2.58-2.09,4.66-4.66,4.66h-2.42"/>
                                    <line x1="40.63" y1="75.42" x2="40.63" y2="53.23"/>
                                    <path d="M47.77,8.92c0,4.78-3.15,8.53-7.03,8.53s-7.03-3.75-7.03-8.53,3.15-7.53,7.03-7.53,7.03,2.76,7.03,7.53Z"/>
                                    <path d="M24.38,54.85c0,7.83-.53,13-1.63,20.69h-13.18c-1.76-12.35-1.7-21.37-1.7-37.63"/>
                                    <path d="M7.87,52.37h0s-2.22,0-2.22,0c-2.36,0-4.27-1.91-4.27-4.27v-16.53h0s4.88-4.17,14.77-4.17h2.77"/>
                                    <line x1="16.16" y1="75.26" x2="16.16" y2="54.93"/>
                                    <path d="M22.69,13.91c0,4.37-2.88,7.8-6.43,7.8s-6.43-3.43-6.43-7.8,2.88-6.89,6.43-6.89,6.43,2.52,6.43,6.89Z"/>
                                    <path d="M56.89,54.85c0,7.83.53,13,1.63,20.69h13.18c1.76-12.35,1.7-21.37,1.7-37.63"/>
                                    <path d="M73.4,52.37h0s2.22,0,2.22,0c2.36,0,4.27-1.91,4.27-4.27v-16.53h0s-4.88-4.17-14.77-4.17h-2.89"/>
                                    <line x1="65.1" y1="75.26" x2="65.1" y2="54.93"/>
                                    <path d="M58.58,13.91c0,4.37,2.88,7.8,6.43,7.8s6.43-3.43,6.43-7.8-2.88-6.89-6.43-6.89-6.43,2.52-6.43,6.89Z"/>
                                  </svg>
                                </button>
                                <button class="fab-btn asset-icon" id="btnFaxLog" title="Fax Log" aria-label="Fax Log">
                                  <svg viewBox="0 0 73.17 77.01" aria-hidden="true">
                                    <path d="M16.18,61.52H1.39v-30.43c0-2.96,2.4-5.37,5.37-5.37h59.66c2.96,0,5.37,2.4,5.37,5.37v30.43h-14.8"/>
                                    <polyline points="16.18 25.73 16.18 1.39 44.31 1.39 56.99 14.52 56.99 25.73"/>
                                    <polyline points="56.99 43.62 56.99 75.63 16.18 75.63 16.18 43.62"/>
                                    <line x1="10.02" y1="43.39" x2="63.92" y2="43.39"/>
                                    <line x1="27.43" y1="53.95" x2="45.89" y2="53.95"/>
                                    <line x1="27.43" y1="65.03" x2="45.89" y2="65.03"/>
                                  </svg>
                                </button>
                              </div>
                            </div>
                            <div class="drawer-overlay" id="drawerOverlay">
                            </div>
                            <aside class="drawer" id="patientDrawer">
                            </aside>
                            <aside class="drawer" id="infoDrawer">
                            </aside>
                            <aside class="drawer" id="contactDrawer">
                            </aside>
                            <aside class="drawer" id="docsDrawer">
                            </aside>
                            <aside class="drawer" id="notesDrawer">
                            </aside>
                            <aside class="drawer" id="activityDrawer">
                            </aside>
                            <aside class="drawer" id="ordersDrawer">
                            </aside>
                            <input id="docsUploadInput" type="file" accept="application/pdf" style="display:none;" />
                            <div class="dl-modal-overlay" id="warningModal">
                              <div class="dl-modal">
                                <div class="dl-modal-bar">
                                  <span>Patient Not Reached</span>
                                      <button class="btn btn-ghost btn-small" data-close="warningModal">Close</button>
                                      </div>
                                <div class="dl-modal-body">
                                      <p style="margin:0 0 10px;font-weight:800;color:var(--navy)">Patient has not been reached. Continue sending referral?</p>
                                        <label>Reason (mock)</label>
                                          <select id="warningReason">
                                            <option>Discharge imminent</option>
                                              <option>Facility request</option>
                                                <option>Orders pending but need head start</option>
                                                  <option>Other</option>
                                                  </select>
                                                </div>
                                                <div class="dl-modal-actions">
                                                  <button class="btn" data-close="warningModal">Cancel</button>
                                                    <button class="btn btn-primary" id="warningContinue">Continue</button>
                              </div>
                            </div>
                            <div class="dl-modal-overlay" id="messagePhysicianModal">
                              <div class="dl-modal">
                                <div class="dl-modal-bar">
                                  <span>Message Physician</span>
                                  <button class="btn btn-ghost btn-small" data-close="messagePhysicianModal">Close</button>
                                </div>
                                <div class="dl-modal-body">
                                  <div class="info-label">Recipient</div>
                                  <select class="doc-input" id="messageRecipient"></select>
                                  <div class="card-meta" id="messageRecipientMeta" style="margin-top:6px;"></div>
                                  <div style="height:12px;"></div>
                                  <div class="info-label">Send Via</div>
                                  <div class="chip-row" style="margin-top:8px;">
                                    <button class="chip-toggle" id="messageChannelEmail" aria-pressed="false" type="button">Email</button>
                                    <button class="chip-toggle" id="messageChannelPhone" aria-pressed="false" type="button">Phone</button>
                                  </div>
                                </div>
                                <div class="dl-modal-actions">
                                  <button class="btn btn-ghost btn-small" data-close="messagePhysicianModal">Close</button>
                                </div>
                              </div>
                            </div>
                                                </div>
                                                <div class="dl-modal-overlay" id="faxModal">
                                                  <div class="dl-modal">
                                                    <div class="dl-modal-bar">
                                                      <span id="faxModalTitle">Send Referral</span>
                                                        <button class="btn btn-ghost btn-small" data-close="faxModal">Close</button>
                                                        </div>
                                                        <div class="dl-modal-body" id="faxModalBody">
                                                        </div>
                                                        <div class="dl-modal-actions">
                                                          <label style="margin-right:auto;font-size:12px;font-weight:800;color:var(--muted)">
                                                            <input type="checkbox" id="simulateFail" /> Simulate failure        </label>
                                                            <button class="btn" data-close="faxModal">Cancel</button>
                                                              <button class="btn btn-primary" id="faxConfirm">Confirm</button>
                                                              </div>
                                                            </div>
                                                          </div>
                                                          <div class="dl-modal-overlay" id="docsModal">
                                                            <div class="dl-modal">
                                                              <div class="dl-modal-bar">
                                                                <span>Docs Checklist Incomplete</span>
                                                                  <button class="btn btn-ghost btn-small" data-close="docsModal">Close</button>
                                                                  </div>
                                                                  <div class="dl-modal-body" id="docsModalBody">
                                                                  </div>
                                                                  <div class="dl-modal-actions">
                                                                    <button class="btn btn-primary" data-close="docsModal">Got it</button>
                                                                    </div>
                                                                  </div>
                                                                </div>
                                                                <div class="dl-modal-overlay" id="patientEditModal">
                                                                  <div class="dl-modal" style="width:min(820px, 100%)">
                                                                    <div class="dl-modal-bar">
                                                                      <span>Edit Patient Details</span>
                                                                        <button class="btn btn-ghost btn-small" data-close="patientEditModal">Close</button>
                                                                        </div>
                                                                        <div class="dl-modal-body">
                                                                          <div class="edit-grid">
                                                                            <div>
                                                                              <label>First Name</label>
                                                                                <input class="ipt" id="ep_first_name" />
                                                                              </div>
                                                                              <div>
                                                                                <label>Last Name</label>
                                                                                  <input class="ipt" id="ep_last_name" />
                                                                                </div>
                                                                                <div>
                                                                                  <label>DOB</label>
                                                                                    <input class="ipt" id="ep_dob" placeholder="YYYY-MM-DD or MM/DD/YYYY" />
                                                                                  </div>
                                                                                  <div>
                                                                                    <label>Gender</label>
                                                                                      <input class="ipt" id="ep_gender" placeholder="M/F/Other" />
                                                                                    </div>
                                                                                    <div>
                                                                                      <label>Phone 1</label>
                                                                                        <input class="ipt" id="ep_phone1" />
                                                                                      </div>
                                                                                      <div>
                                                                                        <label>Phone 2</label>
                                                                                          <input class="ipt" id="ep_phone2" />
                                                                                        </div>
                                                                                        <div>
                                                                                          <label>Email</label>
                                                                                            <input class="ipt" id="ep_email" />
                                                                                          </div>
                                                                                          <div>
                                                                                            <label>Email 2</label>
                                                                                              <input class="ipt" id="ep_email2" />
                                                                                            </div>
                                                                                            <div>
                                                                                              <label>Address 1</label>
                                                                                                <input class="ipt" id="ep_address1" />
                                                                                              </div>
                                                                                              <div>
                                                                                                <label>Address 2</label>
                                                                                                  <input class="ipt" id="ep_address2" />
                                                                                                </div>
                                                                                                <div>
                                                                                                  <label>City</label>
                                                                                                    <input class="ipt" id="ep_city" />
                                                                                                  </div>
                                                                                                  <div>
                                                                                                    <label>State</label>
                                                                                                      <input class="ipt" id="ep_state" />
                                                                                                    </div>
                                                                                                    <div>
                                                                                                      <label>Zip</label>
                                                                                                        <input class="ipt" id="ep_zip" />
                                                                                                      </div>
                                                                                                      <div>
                                                                                                        <label>Insurance Name 1</label>
                                                                                                          <input class="ipt" id="ep_insurance_name1" />
                                                                                                        </div>
                                                                                                        <div>
                                                                                                          <label>Insurance Number 1</label>
                                                                                                            <input class="ipt" id="ep_insurance_number1" />
                                                                                                          </div>
                                                                                                          <div>
                                                                                                            <label>Insurance Name 2</label>
                                                                                                              <input class="ipt" id="ep_insurance_name2" />
                                                                                                            </div>
                                                                                                            <div>
                                                                                                              <label>Insurance Number 2</label>
                                                                                                                <input class="ipt" id="ep_insurance_number2" />
                                                                                                              </div>
                                                                                                              <div class="full">
                                                                                                                <label>Notes 1</label>
                                                                                                                  <textarea class="ipt" id="ep_notes1" rows="3">
                                                                                                                  </textarea>
                                                                                                                </div>
                                                                                                                <div class="full">
                                                                                                                  <label>Notes 2</label>
                                                                                                                    <textarea class="ipt" id="ep_notes2" rows="3">
                                                                                                                    </textarea>
                                                                                                                  </div>
                                                                                                                  <div>
                                                                                                                    <label>External Patient ID</label>
                                                                                                                      <input class="ipt" id="ep_external_patient_id" />
                                                                                                                    </div>
                                                                                                                    <div>
                                                                                                                      <label>MRN</label>
                                                                                                                        <input class="ipt" id="ep_mrn" />
                                                                                                                      </div>
                                                                                                                      <div>
                                                                                                                        <label>Source</label>
                                                                                                                          <input class="ipt" id="ep_source" placeholder="manual" />
                                                                                                                        </div>
                                                                                                                        <div>
                                                                                                                          <label>Active</label>
                                                                                                                            <select class="ipt" id="ep_active">
                                                                                                                              <option value="1">Yes (Active)</option>
                                                                                                                                <option value="0">No (Inactive)</option>
                                                                                                                                </select>
                                                                                                                              </div>
                                                                                                                            </div>
                                                                                                                          </div>
                                                                                                                          <div class="dl-modal-actions">
                                                                                                                            <button class="btn btn-primary" id="ep_save">Save Patient</button>
                                                                                                                            </div>
                                                                                                                          </div>
                                                                                                                        </div>
                                                                                                                        <div class="dl-modal-overlay" id="dcDetailsModal">
                                                                                                                          <div class="dl-modal" style="width:min(860px, 100%)">
                                                                                                                            <div class="dl-modal-bar">
                                                                                                                              <span>Discharge Details</span>
                                                                                                                                <button class="btn btn-ghost btn-small" data-close="dcDetailsModal">Close</button>
                                                                                                                                </div>
                                                                                                                                <div class="dl-modal-body" id="dcDetailsBody">
                                                                                                                                </div>
                                                                                                                                <div class="dl-modal-actions">
                                                                                                                                  <button class="btn btn-primary" data-close="dcDetailsModal">Done</button>
                                                                                                                                  </div>
                                                                                                                                </div>
                                                                                                                              </div>
                                                                                                                              <div class="dl-modal-overlay" id="pcpApptModal">
                                                                                                                                <div class="dl-modal">
                                                                                                                                  <div class="dl-modal-bar">
                                                                                                                                    <span>PCP Appointment</span>
                                                                                                                                      <button class="btn btn-ghost btn-small" data-close="pcpApptModal">Close</button>
                                                                                                                                      </div>
                                                                                                                                      <div class="dl-modal-body">
                                                                                                                                        <div class="info-section">
                                                                                                                                          <label>Appointment Date/Time</label>
                                                                                                                                            <input class="ipt" id="pcpApptDate" type="datetime-local" />
                                                                                                                                          </div>
                                                                                                                                          <div class="info-section">
                                                                                                                                            <label>Appointment Comments</label>
                                                                                                                                              <textarea class="ipt" id="pcpApptComments" rows="4" placeholder="Add comments">
                                                                                                                                              </textarea>
                                                                                                                                            </div>
                                                                                                                                          </div>
                                                                                                                                          <div class="dl-modal-actions">
                                                                                                                                            <button class="btn btn-ghost" data-close="pcpApptModal">Cancel</button>
                                                                                                                                              <button class="btn btn-primary" id="pcpApptSave">Save</button>
                                                                                                                                              </div>
                                                                                                                                            </div>
                                                                                                                                          </div>
                                                                                                                                          <div class="dl-modal-overlay" id="faxLogModal">
                                                                                                                                            <div class="dl-modal" style="width:min(920px, 96vw)">
                                                                                                                                              <div class="dl-modal-bar">
                                                                                                                                                <span>Fax Log</span>
                                                                                                                                                </div>
                                                                                                                                                <div class="dl-modal-body">
                                                                                                                                                  <div class="fax-modal-table">
                                                                                                                                                    <table>
                                                                                                                                                      <thead>
                                                                                                                                                        <tr>
                                                                                                                                                          <th>Sent</th>
                                                                                                                                                            <th>Source</th>
                                                                                                                                                              <th>To</th>
                                                                                                                                                                <th>Details</th>
                                                                                                                                                                  <th>Status</th>
                                                                                                                                                                    <th style="text-align:right;">Action</th>
                                                                                                                                                                    </tr>
                                                                                                                                                                  </thead>
                                                                                                                                                                  <tbody id="faxLogTbody">
                                                                                                                                                                  </tbody>
                                                                                                                                                                </table>
                                                                                                                                                              </div>
                                                                                                                                                            </div>
                                                                                                                                                            <div class="dl-modal-actions">
                                                                                                                                                              <button class="btn" data-close="faxLogModal">Close</button>
                                                                                                                                                              </div>
                                                                                                                                                            </div>
                                                                                                                                                          </div>
                                                                                                                                                          <div class="dl-modal-overlay" id="careTeamEditModal">
                                                                                                                                                            <div class="dl-modal" style="width:min(920px, 96vw)">
                                                                                                                                                              <div class="dl-modal-bar">
                                                                                                                                                                <span>Edit Care Team</span>
                                                                                                                                                                  <button class="btn btn-ghost btn-small" data-close="careTeamEditModal">Close</button>
                                                                                                                                                                  </div>
                                                                                                                                                                  <div class="dl-modal-body">
                                                                                                                                                                    <input type="hidden" id="ctEditId" />
                                                                                                                                                                    <div style="display:flex;gap:10px;flex-wrap:wrap;">
                                                                                                                                                                      <div style="flex:1;min-width:240px;">
                                                                                                                                                                        <label>Name</label>
                                                                                                                                                                          <input class="ipt" id="ctEditName" />
                                                                                                                                                                        </div>
                                                                                                                                                                        <div style="width:220px;">
                                                                                                                                                                          <label>Type</label>
                                                                                                                                                                            <input class="ipt" id="ctEditType" />
                                                                                                                                                                          </div>
                                                                                                                                                                          <div style="width:180px;">
                                                                                                                                                                            <label>NPI</label>
                                                                                                                                                                              <input class="ipt" id="ctEditNpi" />
                                                                                                                                                                            </div>
                                                                                                                                                                            <div style="width:160px;">
                                                                                                                                                                              <label>Active</label>
                                                                                                                                                                                <select class="ipt" id="ctEditActive">
                                                                                                                                                                                  <option value="1">Yes</option>
                                                                                                                                                                                    <option value="0">No</option>
                                                                                                                                                                                    </select>
                                                                                                                                                                                  </div>
                                                                                                                                                                                </div>
                                                                                                                                                                                <div style="height:10px">
                                                                                                                                                                                </div>
                                                                                                                                                                                <div style="display:flex;gap:10px;flex-wrap:wrap;">
                                                                                                                                                                                  <div style="flex:1;min-width:220px;">
                                                                                                                                                                                    <label>Aliases</label>
                                                                                                                                                                                      <input class="ipt" id="ctEditAliases" />
                                                                                                                                                                                    </div>
                                                                                                                                                                                    <div style="flex:1;min-width:220px;">
                                                                                                                                                                                      <label>Practice Name</label>
                                                                                                                                                                                        <input class="ipt" id="ctEditPractice" />
                                                                                                                                                                                      </div>
                                                                                                                                                                                    </div>
                                                                                                                                                                                    <div style="height:10px">
                                                                                                                                                                                    </div>
                                                                                                                                                                                    <div style="display:flex;gap:10px;flex-wrap:wrap;">
                                                                                                                                                                                      <div style="flex:1;min-width:220px;">
                                                                                                                                                                                        <label>Address 1</label>
                                                                                                                                                                                          <input class="ipt" id="ctEditAddress1" />
                                                                                                                                                                                        </div>
                                                                                                                                                                                        <div style="flex:1;min-width:220px;">
                                                                                                                                                                                          <label>Address 2</label>
                                                                                                                                                                                            <input class="ipt" id="ctEditAddress2" />
                                                                                                                                                                                          </div>
                                                                                                                                                                                        </div>
                                                                                                                                                                                        <div style="height:10px">
                                                                                                                                                                                        </div>
                                                                                                                                                                                        <div style="display:flex;gap:10px;flex-wrap:wrap;">
                                                                                                                                                                                          <div style="width:180px;">
                                                                                                                                                                                            <label>City</label>
                                                                                                                                                                                              <input class="ipt" id="ctEditCity" />
                                                                                                                                                                                            </div>
                                                                                                                                                                                            <div style="width:120px;">
                                                                                                                                                                                              <label>State</label>
                                                                                                                                                                                                <input class="ipt" id="ctEditState" />
                                                                                                                                                                                              </div>
                                                                                                                                                                                              <div style="width:140px;">
                                                                                                                                                                                                <label>Zip</label>
                                                                                                                                                                                                  <input class="ipt" id="ctEditZip" />
                                                                                                                                                                                                </div>
                                                                                                                                                                                              </div>
                                                                                                                                                                                              <div style="height:10px">
                                                                                                                                                                                              </div>
                                                                                                                                                                                              <div style="display:flex;gap:10px;flex-wrap:wrap;">
                                                                                                                                                                                                <div style="width:180px;">
                                                                                                                                                                                                  <label>Phone 1</label>
                                                                                                                                                                                                    <input class="ipt" id="ctEditPhone1" />
                                                                                                                                                                                                  </div>
                                                                                                                                                                                                  <div style="width:180px;">
                                                                                                                                                                                                    <label>Phone 2</label>
                                                                                                                                                                                                      <input class="ipt" id="ctEditPhone2" />
                                                                                                                                                                                                    </div>
                                                                                                                                                                                                    <div style="width:200px;">
                                                                                                                                                                                                      <label>Email 1</label>
                                                                                                                                                                                                        <input class="ipt" id="ctEditEmail1" />
                                                                                                                                                                                                      </div>
                                                                                                                                                                                                      <div style="width:200px;">
                                                                                                                                                                                                        <label>Email 2</label>
                                                                                                                                                                                                          <input class="ipt" id="ctEditEmail2" />
                                                                                                                                                                                                        </div>
                                                                                                                                                                                                        <div style="width:160px;">
                                                                                                                                                                                                          <label>Fax</label>
                                                                                                                                                                                                            <input class="ipt" id="ctEditFax" />
                                                                                                                                                                                                          </div>
                                                                                                                                                                                                        </div>
                                                                                                                                                                                                      </div>
                                                                                                                                                                                                      <div class="dl-modal-actions">
                                                                                                                                                                                                        <button class="btn btn-ghost" data-close="careTeamEditModal">Cancel</button>
                                                                                                                                                                                                          <button class="btn btn-primary" id="ctEditSave">Save Care Team</button>
                                                                                                                                                                                                          </div>
                                                                                                                                                                                                        </div>
                                                                                                                                                                                                      </div>
                                                                                                                                                                                                      <div class="dl-modal-overlay" id="filtersModal">
                                                                                                                                                                                                        <div class="dl-modal">
                                                                                                                                                                                                          <div class="dl-modal-bar">
                                                                                                                                                                                                            <span>Filters & Sorting</span>
                                                                                                                                                                                                              <button class="btn btn-ghost btn-small" data-close="filtersModal">Close</button>
                                                                                                                                                                                                              </div>
                                                                                                                                                                                                              <div class="dl-modal-body">
                                                                                                                                                                                                                <div class="field" style="margin-bottom:12px">
                                                                                                                                                                                                                  <label>Sort</label>
                                                                                                                                                                                                                    <select id="sortFilter">
                                                                                                                                                                                                                      <option value="discharge">Earliest discharge</option>
                                                                                                                                                                                                                        <option value="risk">Risk (red > yellow > green)</option>
                                                                                                                                                                                                                        </select>
                                                                                                                                                                                                                      </div>
                                                                                                                                                                                                                      <label class="toggle" style="width:max-content">
                                                                                                                                                                                                                        <input type="checkbox" id="toggleOffPortal" />          Only Off-Portal Work        </label>
                                                                                                                                                                                                                        <label class="toggle" style="width:max-content;margin-top:10px">
                                                                                                                                                                                                                          <input type="checkbox" id="toggleAtRisk" />          Show only At Risk        </label>
                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                        <div class="dl-modal-actions">
                                                                                                                                                                                                                          <button class="btn btn-primary" data-close="filtersModal">Done</button>
                                                                                                                                                                                                                          </div>
                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                      </div>
                                                                                                                                                                                                                      <div class="dl-modal-overlay" id="noteDetailsModal">
                                                                                                                                                                                                                        <div class="dl-modal">
                                                                                                                                                                                                                          <div class="dl-modal-bar">
                                                                                                                                                                                                                            <span id="noteDetailsTitle">Complete Note</span>
                                                                                                                                                                                                                              <button class="btn btn-ghost btn-small" data-close="noteDetailsModal">Close</button>
                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                              <div class="dl-modal-body" id="noteDetailsBody">
                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                              <div class="dl-modal-actions">
                                                                                                                                                                                                                                <button class="btn btn-ghost" data-close="noteDetailsModal">Cancel</button>
                                                                                                                                                                                                                                  <button class="btn btn-primary" id="noteDetailsSave">Save</button>
                                                                                                                                                                                                                                  </div>
                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                              <div class="dl-toast" id="toast" data-variant="info">
                                                                                                                                                                                                                                <div class="dl-toast-accent">
                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                <div class="dl-toast-content">
                                                                                                                                                                                                                                  <div class="dl-toast-top">
                                                                                                                                                                                                                                    <div class="dl-toast-icon" aria-hidden="true">
                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                    <div class="dl-toast-text">
                                                                                                                                                                                                                                      <div class="dl-toast-title" id="toastTitle">Toast</div>
                                                                                                                                                                                                                                        <div class="dl-toast-sub" id="toastSub">Details</div>
                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                        <button class="dl-toast-close" id="toastClose">x</button>
                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                        <div class="dl-toast-actions" id="toastActions">
                                                                                                                                                                                                                                          <button class="btn btn-small" id="toastActionBtn">Complete details</button>
                                                                                                                                                                                                                                          </div>
                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                      </div>
                                                                                                                                                                                                                                      <script>    const now = new Date();    const hoursFromNow = (h) => new Date(now.getTime() + h * 3600 * 1000).toISOString();    const daysFromNow = (d) => new Date(now.getTime() + d * 24 * 3600 * 1000).toISOString();    const withInfo = (p) => {      const [firstName = "", ...rest] = (p.name || "").split(" ");      const lastName = rest.join(" ");      return ({      dob: "1947-05-12",      phoneNumbers: {        mobile: "(555) 238-4471",        home: "(555) 204-1182",        caregiver: "(555) 390-2215"      },      address: {        line1: "2214 W Grove St",        line2: "Apt 3B",        city: "Hillside",        state: "OH",        zip: "44118"      },      dcSubmission: {        dcDate: "2026-02-01",        dcTime: "14:30",        dcConfirmed: true,        dcUrgent: false,        urgentComments: "",        disposition: "Home",        destinationComments: "",        dcWith: "spouse",        hhServices: ["RN","PT","SW"],        hhOtherServices: [],        hhComments: "Family prefers morning SOC visit.",        hhAgency: "Harmony Home Health",        hhAgencyComments: "",        dmeServices: ["RW","Commode","O2"],        dmeOtherServices: [],        dmeComments: "O2 delivery required before discharge.",        pcpName: "Dr. Karen Liu",        coordinateCaregiver: true,        caregiverName: "Maya Hart",        caregiverNumber: "(555) 390-2215",        appealingDc: false,        appealComments: ""      },      patientDetails: {        firstName,        lastName,        dob: "1947-05-12",        gender: "",        phone1: "(555) 238-4471",        phone2: "(555) 204-1182",        email: "",        email2: "",        address1: "2214 W Grove St",        address2: "Apt 3B",        city: "Hillside",        state: "OH",        zip: "44118",        insuranceName1: "",        insuranceNumber1: "",        insuranceName2: "",        insuranceNumber2: "",        notes1: "",        notes2: "",        externalPatientId: "",        mrn: p.mrn || "",        source: "manual",        active: "1"      },      ...p,      phoneNumbers: { ...{        mobile: "(555) 238-4471",        home: "(555) 204-1182",        caregiver: "(555) 390-2215"      }, ...(p.phoneNumbers || {}) },      address: { ...{        line1: "2214 W Grove St",        line2: "Apt 3B",        city: "Hillside",        state: "OH",        zip: "44118"      }, ...(p.address || {}) },      dcSubmission: { ...{        dcDate: "2026-02-01",        dcTime: "14:30",        dcConfirmed: true,        dcUrgent: false,        urgentComments: "",        disposition: "Home",        destinationComments: "",        dcWith: "spouse",        hhServices: ["RN","PT","SW"],        hhOtherServices: [],        hhComments: "Family prefers morning SOC visit.",        hhAgency: "Harmony Home Health",        hhAgencyComments: "",        dmeServices: ["RW","Commode","O2"],        dmeOtherServices: [],        dmeComments: "O2 delivery required before discharge.",        pcpName: "Dr. Karen Liu",        coordinateCaregiver: true,        caregiverName: "Maya Hart",        caregiverNumber: "(555) 390-2215",        appealingDc: false,        appealComments: ""      }, ...(p.dcSubmission || {}) },      patientDetails: { ...{        firstName,        lastName,        dob: "1947-05-12",        gender: "",        phone1: "(555) 238-4471",        phone2: "(555) 204-1182",        email: "",        email2: "",        address1: "2214 W Grove St",        address2: "Apt 3B",        city: "Hillside",        state: "OH",        zip: "44118",        insuranceName1: "",        insuranceNumber1: "",        insuranceName2: "",        insuranceNumber2: "",        notes1: "",        notes2: "",        externalPatientId: "",        mrn: p.mrn || "",        source: "manual",        active: "1"      }, ...(p.patientDetails || {}) }    });    };    const rawPatients = [      {        id:"P-1001", mrn:"MRN-20415", name:"Lena Hart", age:78, facilityName:"Riverbend SNF",        dischargeDateTime: hoursFromNow(4),        servicesNeeded:{homeHealth:true, dme:false},        portalEligibility:{homeHealthOnPortal:true, dmeOnPortal:false, physicianOnEsign:true},        contactStatus:"attempted_vm", contactAttempts:1, lastContactAttemptAt: hoursFromNow(-3), nextContactDueAt: hoursFromNow(2),        docsStatus:"in_progress", docsChecklist:{faceSheet:true, orders:false, clinicals:false}, packetGenerated:false,        referrals:{homeHealth:{referralStatus:"not_sent", lastSentAt:null, faxStatus:"n/a"}, dme:{referralStatus:"not_required"}},        pcpApptNeeded:true,        ordersStatus:"pending", ordersLastNudgeAt: hoursFromNow(-26), ordersNudgeCount:2,        lockStatus:"not_ready", startOfCareDate:null,        activityLog:["01/29 2:10pm - Left VM (Attempt 1)","01/29 2:25pm - Docs uploaded: Face sheet"]      },      {        id:"P-1002", mrn:"MRN-38742", name:"Marcos Reed", age:66, facilityName:"Summit Rehab",        dischargeDateTime: hoursFromNow(30),        servicesNeeded:{homeHealth:true, dme:true},        portalEligibility:{homeHealthOnPortal:false, dmeOnPortal:false, physicianOnEsign:false},        contactStatus:"not_attempted", contactAttempts:0, lastContactAttemptAt:null, nextContactDueAt:null,        docsStatus:"not_started", docsChecklist:{faceSheet:false, orders:false, clinicals:false}, packetGenerated:false,        referrals:{homeHealth:{referralStatus:"not_sent", lastSentAt:null, faxStatus:"n/a"}, dme:{referralStatus:"not_sent", lastSentAt:null, faxStatus:"n/a"}},        pcpApptNeeded:false,        ordersStatus:"not_required", ordersLastNudgeAt:null, ordersNudgeCount:0,        lockStatus:"not_ready", startOfCareDate:null,        activityLog:["01/29 9:05am - Intake created"]      },      {        id:"P-1003", mrn:"MRN-55401", name:"Raj Shah", age:72, facilityName:"Northlake Post Acute",        dischargeDateTime: hoursFromNow(10),        servicesNeeded:{homeHealth:true, dme:false},        portalEligibility:{homeHealthOnPortal:false, dmeOnPortal:false, physicianOnEsign:true},        contactStatus:"attempted_vm", contactAttempts:1, lastContactAttemptAt: hoursFromNow(-5), nextContactDueAt: hoursFromNow(1),        docsStatus:"complete", docsChecklist:{faceSheet:true, orders:true, clinicals:true}, packetGenerated:true,        referrals:{homeHealth:{referralStatus:"not_sent", lastSentAt:null, faxStatus:"n/a"}, dme:{referralStatus:"not_required"}},        pcpApptNeeded:true,        ordersStatus:"pending", ordersLastNudgeAt: hoursFromNow(-3), ordersNudgeCount:1,        lockStatus:"not_ready", startOfCareDate:null,        activityLog:["01/29 1:10pm - Docs marked complete"]      },      {        id:"P-1004", mrn:"MRN-19203", name:"Walter King", age:83, facilityName:"Cedar Grove SNF",        dischargeDateTime: hoursFromNow(60),        servicesNeeded:{homeHealth:false, dme:true},        portalEligibility:{homeHealthOnPortal:false, dmeOnPortal:true, physicianOnEsign:true},        contactStatus:"reached", contactAttempts:1, lastContactAttemptAt: hoursFromNow(-7), nextContactDueAt:null,        docsStatus:"in_progress", docsChecklist:{faceSheet:true, orders:true, clinicals:false}, packetGenerated:false,        referrals:{homeHealth:{referralStatus:"not_required"}, dme:{referralStatus:"not_sent", lastSentAt:null, faxStatus:"n/a"}},        pcpApptNeeded:false,        ordersStatus:"not_required", ordersLastNudgeAt:null, ordersNudgeCount:0,        lockStatus:"not_ready", startOfCareDate:null,        activityLog:["01/28 4:20pm - Patient reached"]      },      {        id:"P-1005", mrn:"MRN-77102", name:"Dana Ortiz", age:70, facilityName:"Pinecrest Medical",        dischargeDateTime: hoursFromNow(8),        servicesNeeded:{homeHealth:true, dme:false},        portalEligibility:{homeHealthOnPortal:true, dmeOnPortal:false, physicianOnEsign:true},        contactStatus:"reached", contactAttempts:1, lastContactAttemptAt: hoursFromNow(-6), nextContactDueAt:null,        docsStatus:"complete", docsChecklist:{faceSheet:true, orders:true, clinicals:true}, packetGenerated:true,        referrals:{homeHealth:{referralStatus:"not_sent", lastSentAt:null, faxStatus:"n/a"}, dme:{referralStatus:"not_required"}},        pcpApptNeeded:true,        ordersStatus:"signed", ordersLastNudgeAt:null, ordersNudgeCount:0,        lockStatus:"not_ready", startOfCareDate: daysFromNow(2),        activityLog:["01/29 10:12am - Docs marked complete"]      },      {        id:"P-1006", mrn:"MRN-82910", name:"Simone Clarke", age:61, facilityName:"Riverbend SNF",        dischargeDateTime: hoursFromNow(6),        servicesNeeded:{homeHealth:true, dme:false},        portalEligibility:{homeHealthOnPortal:true, dmeOnPortal:false, physicianOnEsign:true},        contactStatus:"reached", contactAttempts:1, lastContactAttemptAt: hoursFromNow(-9), nextContactDueAt:null,        docsStatus:"complete", docsChecklist:{faceSheet:true, orders:true, clinicals:true}, packetGenerated:true,        referrals:{homeHealth:{referralStatus:"sent", lastSentAt: hoursFromNow(-12), faxStatus:"n/a"}, dme:{referralStatus:"not_required"}},        pcpApptNeeded:false,        ordersStatus:"pending", ordersLastNudgeAt: hoursFromNow(-5), ordersNudgeCount:1,        lockStatus:"not_ready", startOfCareDate:null,        activityLog:["01/29 8:40am - Portal referral sent to Bright HH"]      },      {        id:"P-1007", mrn:"MRN-45519", name:"Paul Young", age:75, facilityName:"Oak Valley SNF",        dischargeDateTime: hoursFromNow(20),        servicesNeeded:{homeHealth:true, dme:false},        portalEligibility:{homeHealthOnPortal:false, dmeOnPortal:false, physicianOnEsign:false},        contactStatus:"reached", contactAttempts:1, lastContactAttemptAt: hoursFromNow(-12), nextContactDueAt:null,        docsStatus:"complete", docsChecklist:{faceSheet:true, orders:true, clinicals:true}, packetGenerated:true,        referrals:{homeHealth:{referralStatus:"sent", lastSentAt: hoursFromNow(-4), faxStatus:"failed"}, dme:{referralStatus:"not_required"}},        pcpApptNeeded:true,        ordersStatus:"pending", ordersLastNudgeAt: hoursFromNow(-2), ordersNudgeCount:1,        lockStatus:"not_ready", startOfCareDate:null,        activityLog:["01/29 12:55pm - Fax failed to ABC Home Health"]      },      {        id:"P-1008", mrn:"MRN-90412", name:"Mei Chen", age:82, facilityName:"Summit Rehab",        dischargeDateTime: hoursFromNow(2),        servicesNeeded:{homeHealth:true, dme:false},        portalEligibility:{homeHealthOnPortal:false, dmeOnPortal:false, physicianOnEsign:true},        contactStatus:"not_reachable_final", contactAttempts:2, lastContactAttemptAt: hoursFromNow(-2), nextContactDueAt:null,        docsStatus:"in_progress", docsChecklist:{faceSheet:true, orders:false, clinicals:false}, packetGenerated:false,        referrals:{homeHealth:{referralStatus:"not_sent", lastSentAt:null, faxStatus:"n/a"}, dme:{referralStatus:"not_required"}},        pcpApptNeeded:false,        ordersStatus:"pending", ordersLastNudgeAt: hoursFromNow(-6), ordersNudgeCount:1,        lockStatus:"not_ready", startOfCareDate:null,        activityLog:["01/29 3:30pm - Left VM (Attempt 2)"]      },      {        id:"P-1009", mrn:"MRN-66320", name:"Isaac Patel", age:59, facilityName:"Lakeside SNF",        dischargeDateTime: hoursFromNow(48),        servicesNeeded:{homeHealth:true, dme:false},        portalEligibility:{homeHealthOnPortal:true, dmeOnPortal:false, physicianOnEsign:true},        contactStatus:"reached", contactAttempts:1, lastContactAttemptAt: hoursFromNow(-20), nextContactDueAt:null,        docsStatus:"complete", docsChecklist:{faceSheet:true, orders:true, clinicals:true}, packetGenerated:true,        referrals:{homeHealth:{referralStatus:"accepted", lastSentAt: hoursFromNow(-18), faxStatus:"n/a"}, dme:{referralStatus:"not_required"}},        pcpApptNeeded:false,        ordersStatus:"signed", ordersLastNudgeAt: null, ordersNudgeCount:0,        lockStatus:"ready", startOfCareDate: daysFromNow(3),        activityLog:["01/28 5:10pm - Referral accepted by Harmony HH"]      },      {        id:"P-1010", mrn:"MRN-21844", name:"Nora Blake", age:67, facilityName:"Northlake Post Acute",        dischargeDateTime: hoursFromNow(-5),        servicesNeeded:{homeHealth:false, dme:false},        portalEligibility:{homeHealthOnPortal:false, dmeOnPortal:false, physicianOnEsign:true},        contactStatus:"reached", contactAttempts:1, lastContactAttemptAt: hoursFromNow(-30), nextContactDueAt:null,        docsStatus:"complete", docsChecklist:{faceSheet:true, orders:true, clinicals:true}, packetGenerated:true,        referrals:{homeHealth:{referralStatus:"not_required"}, dme:{referralStatus:"not_required"}},        pcpApptNeeded:false,        ordersStatus:"signed", ordersLastNudgeAt:null, ordersNudgeCount:0,        lockStatus:"complete", startOfCareDate:null,        activityLog:["01/28 10:20am - Marked complete"]      },      {        id:"P-1011", mrn:"MRN-11893", name:"Jorge Alvarez", age:71, facilityName:"Cedar Grove SNF",        dischargeDateTime: hoursFromNow(12),        servicesNeeded:{homeHealth:false, dme:true},        portalEligibility:{homeHealthOnPortal:false, dmeOnPortal:false, physicianOnEsign:true},        contactStatus:"reached", contactAttempts:1, lastContactAttemptAt: hoursFromNow(-7), nextContactDueAt:null,        docsStatus:"complete", docsChecklist:{faceSheet:true, orders:true, clinicals:true}, packetGenerated:true,        referrals:{homeHealth:{referralStatus:"not_required"}, dme:{referralStatus:"not_sent", lastSentAt:null, faxStatus:"n/a"}},        pcpApptNeeded:true,        ordersStatus:"signed", ordersLastNudgeAt:null, ordersNudgeCount:0,        lockStatus:"not_ready", startOfCareDate:null,        activityLog:["01/29 9:40am - DME referral queued"]      },      {        id:"P-1012", mrn:"MRN-77993", name:"Tessa Gray", age:63, facilityName:"Pinecrest Medical",        dischargeDateTime: hoursFromNow(72),        servicesNeeded:{homeHealth:true, dme:false},        portalEligibility:{homeHealthOnPortal:true, dmeOnPortal:false, physicianOnEsign:true},        contactStatus:"reached", contactAttempts:1, lastContactAttemptAt: hoursFromNow(-10), nextContactDueAt:null,        docsStatus:"complete", docsChecklist:{faceSheet:true, orders:true, clinicals:true}, packetGenerated:true,        referrals:{homeHealth:{referralStatus:"sent", lastSentAt: hoursFromNow(-30), faxStatus:"n/a"}, dme:{referralStatus:"not_required"}},        pcpApptNeeded:false,        ordersStatus:"pending", ordersLastNudgeAt: hoursFromNow(-20), ordersNudgeCount:1,        lockStatus:"not_ready", startOfCareDate:null,        activityLog:["01/28 2:10pm - Portal referral sent to Northside HH"]      },      {        id:"P-1013", mrn:"MRN-99410", name:"Omar Nassar", age:69, facilityName:"Riverbend SNF",        dischargeDateTime: hoursFromNow(18),        servicesNeeded:{homeHealth:true, dme:false},        portalEligibility:{homeHealthOnPortal:true, dmeOnPortal:false, physicianOnEsign:true},        contactStatus:"reached", contactAttempts:1, lastContactAttemptAt: hoursFromNow(-14), nextContactDueAt:null,        docsStatus:"complete", docsChecklist:{faceSheet:true, orders:true, clinicals:true}, packetGenerated:true,        referrals:{homeHealth:{referralStatus:"accepted", lastSentAt: hoursFromNow(-16), faxStatus:"n/a"}, dme:{referralStatus:"not_required"}},        pcpApptNeeded:true,        ordersStatus:"pending", ordersLastNudgeAt: hoursFromNow(-30), ordersNudgeCount:2,        lockStatus:"not_ready", startOfCareDate: daysFromNow(2),        activityLog:["01/28 3:55pm - Referral accepted by Hometown HH"]      },      {        id:"P-1014", mrn:"MRN-44750", name:"Elise Brooks", age:74, facilityName:"Summit Rehab",        dischargeDateTime: hoursFromNow(26),        servicesNeeded:{homeHealth:true, dme:false},        portalEligibility:{homeHealthOnPortal:false, dmeOnPortal:false, physicianOnEsign:true},        contactStatus:"attempted_vm", contactAttempts:1, lastContactAttemptAt: hoursFromNow(-2), nextContactDueAt: hoursFromNow(1),        docsStatus:"not_started", docsChecklist:{faceSheet:false, orders:false, clinicals:false}, packetGenerated:false,        referrals:{homeHealth:{referralStatus:"not_sent", lastSentAt:null, faxStatus:"n/a"}, dme:{referralStatus:"not_required"}},        pcpApptNeeded:false,        ordersStatus:"not_required", ordersLastNudgeAt:null, ordersNudgeCount:0,        lockStatus:"not_ready", startOfCareDate:null,        activityLog:["01/29 1:40pm - Left VM (Attempt 1)"]      },      {        id:"P-1015", mrn:"MRN-55238", name:"Henry Soto", age:65, facilityName:"Lakeside SNF",        dischargeDateTime: hoursFromNow(6),        servicesNeeded:{homeHealth:true, dme:false},        portalEligibility:{homeHealthOnPortal:true, dmeOnPortal:false, physicianOnEsign:false},        contactStatus:"reached", contactAttempts:1, lastContactAttemptAt: hoursFromNow(-9), nextContactDueAt:null,        docsStatus:"complete", docsChecklist:{faceSheet:true, orders:true, clinicals:true}, packetGenerated:true,        referrals:{homeHealth:{referralStatus:"accepted", lastSentAt: hoursFromNow(-12), faxStatus:"n/a"}, dme:{referralStatus:"not_required"}},        pcpApptNeeded:true,        ordersStatus:"exception_off_portal", ordersLastNudgeAt:null, ordersNudgeCount:0,        lockStatus:"ready", startOfCareDate: daysFromNow(1),        activityLog:["01/29 8:05am - Exception documented (off-portal)"]      }    ];    let patients = rawPatients.map(withInfo);    let SERVICES = [];    let SERVICE_TYPES = [];    let serviceCatalogLoaded = false;    const queues = [      { id:"intake", label:"New / Intake" },      { id:"docs", label:"Prep & Docs" },      { id:"referrals", label:"Referrals to Send" },      { id:"awaiting", label:"Awaiting Orders" },      { id:"pcp", label:"PCP Appts" },      { id:"ready", label:"Ready / Complete" },      { id:"urgent", label:"Urgent / Needs Attention" },      { id:"allTransitions", label:"All Transitions" }    ];    let activeQueue = "intake";    let selectedPatientId = null;    let pendingReferral = null;    let editingPatientId = null;    const queueListEl = document.getElementById("queueList");    const queueHeadEl = document.getElementById("queueHead");    const queueTableEl = document.getElementById("queueTable");    const summaryStripEl = document.getElementById("summaryStrip");    const emptyStateEl = document.getElementById("emptyState");    const searchInputEl = document.getElementById("searchInput");    const facilityFilterEl = document.getElementById("facilityFilter");    const dateFilterEl = document.getElementById("dateFilter");    const sortFilterEl = document.getElementById("sortFilter");    const toggleAtRiskEl = document.getElementById("toggleAtRisk");    const toggleOffPortalEl = document.getElementById("toggleOffPortal");    const openFiltersEl = document.getElementById("openFilters");    const filtersModalEl = document.getElementById("filtersModal");    const infoDrawerEl = document.getElementById("infoDrawer");    const contactDrawerEl = document.getElementById("contactDrawer");    const patientEditModalEl = document.getElementById("patientEditModal");    const messagePhysicianModalEl = document.getElementById("messagePhysicianModal");    const messageRecipientEl = document.getElementById("messageRecipient");    const messageRecipientMetaEl = document.getElementById("messageRecipientMeta");    const messageChannelEmailEl = document.getElementById("messageChannelEmail");    const messageChannelPhoneEl = document.getElementById("messageChannelPhone");    const epFirstNameEl = document.getElementById("ep_first_name");    const epLastNameEl = document.getElementById("ep_last_name");    const epDobEl = document.getElementById("ep_dob");    const epGenderEl = document.getElementById("ep_gender");    const epPhone1El = document.getElementById("ep_phone1");    const epPhone2El = document.getElementById("ep_phone2");    const epEmailEl = document.getElementById("ep_email");    const epEmail2El = document.getElementById("ep_email2");    const epAddress1El = document.getElementById("ep_address1");    const epAddress2El = document.getElementById("ep_address2");    const epCityEl = document.getElementById("ep_city");    const epStateEl = document.getElementById("ep_state");    const epZipEl = document.getElementById("ep_zip");    const epInsuranceName1El = document.getElementById("ep_insurance_name1");    const epInsuranceNumber1El = document.getElementById("ep_insurance_number1");    const epInsuranceName2El = document.getElementById("ep_insurance_name2");    const epInsuranceNumber2El = document.getElementById("ep_insurance_number2");    const epNotes1El = document.getElementById("ep_notes1");    const epNotes2El = document.getElementById("ep_notes2");    const epExternalPatientIdEl = document.getElementById("ep_external_patient_id");    const epMrnEl = document.getElementById("ep_mrn");    const epSourceEl = document.getElementById("ep_source");    const epActiveEl = document.getElementById("ep_active");    const epSaveEl = document.getElementById("ep_save");    const dcDetailsModalEl = document.getElementById("dcDetailsModal");    const dcDetailsBodyEl = document.getElementById("dcDetailsBody");    const pcpApptModalEl = document.getElementById("pcpApptModal");    const pcpApptDateEl = document.getElementById("pcpApptDate");    const pcpApptCommentsEl = document.getElementById("pcpApptComments");    const pcpApptSaveEl = document.getElementById("pcpApptSave");    const faxLogModalEl = document.getElementById("faxLogModal");    const faxLogTbodyEl = document.getElementById("faxLogTbody");    const careTeamEditModalEl = document.getElementById("careTeamEditModal");    const ctEditSaveEl = document.getElementById("ctEditSave");    const ctEditPhone1El = document.getElementById("ctEditPhone1");    const ctEditPhone2El = document.getElementById("ctEditPhone2");    const ctEditFaxEl = document.getElementById("ctEditFax");    const drawerEl = document.getElementById("patientDrawer");    const drawerOverlayEl = document.getElementById("drawerOverlay");    const fabWrapEl = document.getElementById("fabWrap");    const activityDrawerEl = document.getElementById("activityDrawer");    const ordersDrawerEl = document.getElementById("ordersDrawer");    const notesDrawerEl = document.getElementById("notesDrawer");    const warningModalEl = document.getElementById("warningModal");    const warningContinueEl = document.getElementById("warningContinue");    const warningReasonEl = document.getElementById("warningReason");    const faxModalEl = document.getElementById("faxModal");    const faxModalTitleEl = document.getElementById("faxModalTitle");    const faxModalBodyEl = document.getElementById("faxModalBody");    const faxConfirmEl = document.getElementById("faxConfirm");    const simulateFailEl = document.getElementById("simulateFail");    const docsModalEl = document.getElementById("docsModal");    const docsModalBodyEl = document.getElementById("docsModalBody");    const toastEl = document.getElementById("toast");    const toastTitleEl = document.getElementById("toastTitle");    const toastSubEl = document.getElementById("toastSub");    const toastCloseEl = document.getElementById("toastClose");    const toastActionsEl = document.getElementById("toastActions");    const toastActionBtnEl = document.getElementById("toastActionBtn");    const noteDetailsModalEl = document.getElementById("noteDetailsModal");    const noteDetailsTitleEl = document.getElementById("noteDetailsTitle");    const noteDetailsBodyEl = document.getElementById("noteDetailsBody");    const noteDetailsSaveEl = document.getElementById("noteDetailsSave");    const docsDrawerEl = document.getElementById("docsDrawer");    const docsUploadInputEl = document.getElementById("docsUploadInput");    const token = () => (localStorage.getItem("sensys_token") || "").trim();    const authHeaders = () => ({ "Authorization": "Bearer " + token() });    const WORKSPACE_KEY = "evolv_snf";    const ATTEMPT_TEMPLATE_ID = 2;    const ATTEMPT_NOTE_NAME = "Log Call Attempts";    const REACHED_TEMPLATE_ID = 3;    const REACHED_NOTE_NAME = "Evolv SNF - Initial Call Default";    const REACHED_FIELD_KEY = "patient_contact_default";    const REACHED_ANSWER = "Spoke to patient and educated on next steps in discharge planning process.";    const CALL_VM_ANSWER = "Left VM";    const CALL_NO_VM_ANSWER = "Unable to leave VM";    const ATTEMPT_ANSWERS = new Set([CALL_VM_ANSWER, CALL_NO_VM_ANSWER]);    const CCM_TEMPLATE_ID = 4;    const CCM_NOTE_NAME = "Evolv SNF - CCM Status";    const CCM_FIELD_KEY = "ccm_status_default";    const CCM_ACCEPTED_ANSWER = "CCM introduction completed with patient. Patient did not decline CCM services.";    const CCM_DECLINED_ANSWER = "Patient Declined CCM Services";    const DOC_LABELS = {      faceSheet: "Facesheet",      orders: "DC Summary",      clinicals: "Physicians Added"    };    let pendingDocUpload = null;    let pcpApptContext = null;    let activityApptEditId = null;    const formatDateTime = (iso) => new Intl.DateTimeFormat("en-US", {      month:"short", day:"numeric", hour:"numeric", minute:"2-digit"    }).format(new Date(iso));    const formatDate = (iso) => new Intl.DateTimeFormat("en-US", {      month:"short", day:"numeric"    }).format(new Date(iso));    const formatDob = (iso) => new Intl.DateTimeFormat("en-US", {      month:"2-digit", day:"2-digit", year:"numeric"    }).format(new Date(iso));    const formatDateShort = (iso) => new Intl.DateTimeFormat("en-US", {      month:"2-digit", day:"2-digit", year:"2-digit"    }).format(new Date(iso));    const normalizeE164 = (num) => {      const raw = (num || "").toString().trim();      if (!raw) return "";      if (raw.startsWith("+")) return raw;      const digits = raw.replace(/\D/g, "");      if (digits.length === 10) return `+1${digits}`;      if (digits.length === 11 && digits.startsWith("1")) return `+${digits}`;      return raw;    };    const formatPhoneDisplay = (num) => {      const raw = (num || "").toString().trim();      if (!raw) return "";      const digits = raw.replace(/\D/g, "");      const ten = (digits.length === 11 && digits.startsWith("1")) ? digits.slice(1) : digits;      if (ten.length !== 10) return raw;      return `(${ten.slice(0,3)}) ${ten.slice(3,6)}-${ten.slice(6)}`;    };    const formatPhoneInput = (value) => {      const raw = (value || "").toString();      const digitsRaw = raw.replace(/\D/g, "");      const digits = (digitsRaw.length === 11 && digitsRaw.startsWith("1")) ? digitsRaw.slice(1) : digitsRaw.slice(0, 10);      if (!digits) return "";      if (digits.length < 4) return `(${digits}`;      if (digits.length < 7) return `(${digits.slice(0,3)}) ${digits.slice(3)}`;      return `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;    };    const applyPhoneMask = (el) => {      if (!el) return;      const handle = () => {        const next = formatPhoneInput(el.value);        if (el.value !== next) el.value = next;      };      el.addEventListener("input", handle);      el.addEventListener("blur", handle);      handle();    };    applyPhoneMask(ctEditPhone1El);    applyPhoneMask(ctEditPhone2El);    applyPhoneMask(ctEditFaxEl);    const toLocalInputValue = (iso) => {      if (!iso) return "";      const d = new Date(iso);      if (Number.isNaN(d.getTime())) return "";      const pad = (n) => String(n).padStart(2, "0");      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;    };    const formatStamp = (date) => new Intl.DateTimeFormat("en-US", {      month:"2-digit", day:"2-digit", hour:"numeric", minute:"2-digit"    }).format(date).replace(",", "");    const formatDischargeDisplay = (iso) => {      const date = new Date(iso);      const dayLabel = new Intl.DateTimeFormat("en-US", {        weekday:"short", month:"numeric", day:"numeric"      }).format(date);      const diffDays = Math.ceil((date.getTime() - Date.now()) / 86400000);      const suffix = diffDays < 0 ? "overdue" : diffDays === 0 ? "today" : diffDays === 1 ? "1 day" : `${diffDays} days`;      return `${dayLabel} (${suffix})`;    };    const formatDcDay = (iso) => {      const date = new Date(iso);      const dayLabel = new Intl.DateTimeFormat("en-US", { weekday:"short" }).format(date);      const diffMs = date.getTime() - Date.now();      const diffDays = diffMs >= 0 ? Math.ceil(diffMs / 86400000) : Math.floor(diffMs / 86400000);      const suffix = diffDays === 0 ? "0" : `${diffDays}`;      return `${dayLabel} (${suffix})`;    };    const riskRank = (level) => ({ red:0, yellow:1, green:2 }[level] ?? 2);    const isDischarged = (p) => new Date(p.dischargeDateTime) < new Date();    const hoursUntilDischarge = (p) => (new Date(p.dischargeDateTime).getTime() - Date.now()) / 3600000;    const splitNames = (value) => (value || "")      .split(",")      .map(s => s.trim())      .filter(Boolean);    const mapAdmissionRow = (row) => {      const hhServices = splitNames(row.dc_sub_hh_service_names);      const dmeServices = splitNames(row.dc_sub_dme_service_names);      const docsChecklist = {        faceSheet: Boolean(row.docs_facesheet),        orders: Boolean(row.docs_dc_summary),        clinicals: Boolean(row.docs_physicians_added)      };      const docsAny = Object.values(docsChecklist).some(Boolean);      const docsStatus = (row.docs_status || (docsAny ? "in_progress" : "not_started")).toLowerCase();      return withInfo({        id: String(row.id),        mrn: row.patient_mrn || "",        name: row.patient_name || `${row.patient_last_name || ""}, ${row.patient_first_name || ""}`.trim(),        age: row.patient_dob ? Math.max(0, Math.floor((Date.now() - new Date(row.patient_dob).getTime()) / 31557600000)) : "",        facilityName: row.agency_name || "?",        dischargeDateTime: row.dc_sub_dc_date || row.dc_date || "",        servicesNeeded: { homeHealth: hhServices.length > 0, dme: dmeServices.length > 0 },        portalEligibility: { homeHealthOnPortal: false, dmeOnPortal: false, physicianOnEsign: false },        contactStatus: "not_attempted",        contactAttempts: 0,        lastContactAttemptAt: null,        nextContactDueAt: null,        docsStatus,        docsChecklist,        packetGenerated: Boolean(row.docs_packet_generated),        referrals: { homeHealth:{referralStatus:"not_sent", lastSentAt:null, faxStatus:"n/a"}, dme:{referralStatus:"not_sent", lastSentAt:null, faxStatus:"n/a"} },        pcpApptNeeded: false,        ordersStatus: "not_required",        ordersLastNudgeAt: null,        ordersNudgeCount: 0,        lockStatus: "not_ready",        startOfCareDate: null,        activityLog: [],          localActivityLog: [],          pdfs: [],          pdfsLoaded: false,          careTeam: [],          appointments: [],          faxLogs: [],          detailsLoaded: false,          esigns: [],          faxLoaded: false,          pcpFaxed: false,          hhServiceNames: hhServices,          dmeServiceNames: dmeServices,          agencyCcm: {            medrina: Boolean(row.agency_medrina_ccm),            evolv: Boolean(row.agency_evolv_ccm)        }      });    };    const loadAdmissions = async () => {      if (!token()) {        const demoPatient = withInfo({          id:"DEMO-001",          mrn:"DEMO-44721",          name:"Maya Collins",          age:74,          facilityName:"Demo SNF",          dischargeDateTime: hoursFromNow(18),          servicesNeeded:{homeHealth:true, dme:true},          portalEligibility:{homeHealthOnPortal:false, dmeOnPortal:false, physicianOnEsign:false},          contactStatus:"not_attempted",          contactAttempts:0,          lastContactAttemptAt:null,          nextContactDueAt:null,          docsStatus:"in_progress",          docsChecklist:{faceSheet:true, orders:false, clinicals:false},          packetGenerated:false,          referrals:{            homeHealth:{referralStatus:"not_sent", lastSentAt:null, faxStatus:"n/a"},            dme:{referralStatus:"not_sent", lastSentAt:null, faxStatus:"n/a"}          },          pcpApptNeeded:true,          ordersStatus:"pending",          ordersLastNudgeAt: hoursFromNow(-6),          ordersNudgeCount:1,          lockStatus:"not_ready",          startOfCareDate:null,            activityLog:["01/29 9:10am - Intake created"],            hhServiceNames:["RN","PT"],            dmeServiceNames:["RW","O2"],            agencyCcm:{ medrina:false, evolv:true },            careTeam:[{ care_team_id: 901, name:"Dr. Karen Liu", type:"PCP", phone1:"555-889-2201", fax:"555-889-2209" }],            appointments:[],            faxLogs:[],            pcpFaxed:false          });        patients = [demoPatient];        populateFacilityFilter();        render();        return;      }      try {        const res = await fetch("/api/sensys/my-admissions?admitted_only=0", { headers: authHeaders() });        if (!res.ok) throw new Error("Failed to load admissions");        const data = await res.json();        patients = (data.admissions || []).map(mapAdmissionRow);        await loadAdmissionNotes(patients.map(p => p.id));        populateFacilityFilter();        render();      } catch (err) {        console.warn("[Evolv SNF] admissions fetch failed:", err);        render();      }    };    const loadAdmissionNotes = async (admissionIds) => {      if (!token() || !admissionIds?.length) return;      try {        const params = new URLSearchParams({          admission_ids: admissionIds.join(","),          workspace_key: WORKSPACE_KEY,          include_answers: "1"        });        const res = await fetch(`/api/sensys/admission-notes?${params.toString()}`, { headers: authHeaders() });        if (!res.ok) throw new Error("Failed to load notes");        const data = await res.json();        const notesByAdmission = {};        (data.notes || []).forEach(n => {          const id = String(n.admission_id || "");          if (!id) return;          if (!notesByAdmission[id]) notesByAdmission[id] = [];          notesByAdmission[id].push(n);        });        const idSet = new Set(admissionIds.map(id => String(id)));        patients.forEach(p => {          if (!idSet.has(String(p.id))) return;          p.admissionNotes = notesByAdmission[p.id] || [];          applyAttemptNotes(p);          p.activityLog = buildActivityLog(p);        });      } catch (err) {        console.warn("[Evolv SNF] notes fetch failed:", err);      }    };    const getDeliveryMethod = (p, service) => {      if (service === "homeHealth") return p.portalEligibility.homeHealthOnPortal ? "portal" : "fax";      if (service === "dme") return p.portalEligibility.dmeOnPortal ? "portal" : "fax";      return "fax";    };    const recomputeDerived = (p) => {      const atRisk = computeAtRisk(p);      if (atRisk) p.riskLevel = "red";      else if (hoursUntilDischarge(p) <= 48) p.riskLevel = "yellow";      else p.riskLevel = "green";      p.readyCriteriaMet = computeReadyCriteria(p);      if (p.readyCriteriaMet && p.lockStatus === "not_ready") p.lockStatus = "ready";      if (!p.readyCriteriaMet && p.lockStatus === "ready") p.lockStatus = "not_ready";    };    const computeReadyCriteria = (p) => {      const hhNeeded = p.servicesNeeded.homeHealth;      const dmeNeeded = p.servicesNeeded.dme;      const hhOk = !hhNeeded || p.referrals.homeHealth.referralStatus === "accepted";      const dmeOk = !dmeNeeded || p.referrals.dme.referralStatus === "accepted";      const ordersOk = ["signed","exception_off_portal","not_required"].includes(p.ordersStatus);      const packetOk = p.packetGenerated || p.docsStatus === "complete";      const socOk = !hhNeeded || Boolean(p.startOfCareDate);      return hhOk && dmeOk && ordersOk && packetOk && socOk;    };    const computeAtRisk = (p) => {      const dischargeSoon = hoursUntilDischarge(p) <= 24;      const faxFailed = ["homeHealth","dme"].some(s => p.referrals[s] && p.referrals[s].faxStatus === "failed");      const referralRejected = ["homeHealth","dme"].some(s => p.referrals[s] && p.referrals[s].referralStatus === "rejected");      const referralStale = ["homeHealth","dme"].some(s => {        const ref = p.referrals[s];        if (!ref || ref.referralStatus !== "sent" || !ref.lastSentAt) return false;        const hours = (Date.now() - new Date(ref.lastSentAt).getTime()) / 3600000;        return hours > 18;      });      const ordersStale = p.ordersStatus === "pending" && (p.ordersNudgeCount >= 2 || hoursSince(p.ordersLastNudgeAt) > 24);      const unreachableSoon = p.contactStatus === "not_reachable_final" && dischargeSoon;      const notReadySoon = dischargeSoon && p.lockStatus !== "ready" && p.lockStatus !== "complete";      return faxFailed || referralRejected || referralStale || ordersStale || unreachableSoon || notReadySoon;    };    const isContactComplete = (p) => {      return p.contactStatus === "reached" || p.contactStatus === "not_reachable_final" || p.contactAttempts >= 2;    };    const hoursSince = (iso) => {      if (!iso) return 0;      return (Date.now() - new Date(iso).getTime()) / 3600000;    };    const inQueue = (p, queueId) => {      if (queueId === "intake") {        return !isContactComplete(p) && p.contactAttempts < 2 && !isDischarged(p);      }      if (queueId === "docs") {        return p.docsStatus !== "complete" && !isDischarged(p);      }      if (queueId === "referrals") {        if (p.docsStatus !== "complete") return false;        const needsHH = p.servicesNeeded.homeHealth && p.referrals.homeHealth.referralStatus === "not_sent";        const needsDME = p.servicesNeeded.dme && p.referrals.dme.referralStatus === "not_sent";        return (needsHH || needsDME) && !isDischarged(p);      }      if (queueId === "awaiting") {        const awaitingRef = ["homeHealth","dme"].some(s => {          const ref = p.referrals[s];          return ref && ["sent","needs_info"].includes(ref.referralStatus);        });        const ordersPending = p.ordersStatus === "pending";        return (awaitingRef || ordersPending) && !isDischarged(p);      }      if (queueId === "pcp") {        return p.pcpApptNeeded && !isDischarged(p);      }      if (queueId === "urgent") {        return computeAtRisk(p);      }      if (queueId === "allTransitions") {        const notReadyOrComplete = !["ready","complete"].includes(p.lockStatus);        const dischargeDate = p.dischargeDateTime ? new Date(p.dischargeDateTime) : null;        const notPastDischarge = !dischargeDate || Number.isNaN(dischargeDate.getTime()) || new Date() <= dischargeDate;        return (notReadyOrComplete || notPastDischarge);      }      if (queueId === "ready") {        return p.lockStatus === "ready" || p.lockStatus === "complete";      }      return false;    };    const matchesFilters = (p) => {      const search = searchInputEl.value.trim().toLowerCase();      if (search) {        const hay = `${p.name} ${p.mrn} ${p.facilityName}`.toLowerCase();        if (!hay.includes(search)) return false;      }      if (facilityFilterEl.value !== "all" && p.facilityName !== facilityFilterEl.value) return false;      const range = dateFilterEl.value;      if (range !== "all") {        const hours = parseInt(range, 10);        const until = hoursUntilDischarge(p);        if (range === "today") {          const today = new Date();          const discharge = new Date(p.dischargeDateTime);          if (today.toDateString() !== discharge.toDateString()) return false;        } else if (until < 0 || until > hours) {          return false;        }      }      if (toggleAtRiskEl.checked && !computeAtRisk(p)) return false;      if (toggleOffPortalEl.checked) {        const offPortalRef = ["homeHealth","dme"].some(s => p.servicesNeeded[s] && getDeliveryMethod(p, s) === "fax");        const offPortalPhysician = !p.portalEligibility.physicianOnEsign;        if (!offPortalRef && !offPortalPhysician) return false;      }      return true;    };    const sortPatients = (list) => {      const sort = sortFilterEl.value;      return list.sort((a,b) => {        const dateDiff = new Date(a.dischargeDateTime) - new Date(b.dischargeDateTime);        if (sort === "risk") {          const riskDiff = riskRank(a.riskLevel) - riskRank(b.riskLevel);          return riskDiff !== 0 ? riskDiff : dateDiff;        }        if (dateDiff !== 0) return dateDiff;        return riskRank(a.riskLevel) - riskRank(b.riskLevel);      });    };    let toastActionHandler = null;    const showToast = (title, sub, action, opts = {}) => {      toastTitleEl.textContent = title;      toastSubEl.textContent = sub;      const variant = (opts && opts.variant) ? opts.variant : "info";      toastEl.setAttribute("data-variant", variant);      if (action && action.label && typeof action.onClick === "function") {        toastActionsEl.style.display = "flex";        toastActionBtnEl.textContent = action.label;        toastActionHandler = action.onClick;      } else {        toastActionsEl.style.display = "none";        toastActionHandler = null;      }      toastEl.classList.add("show");      clearTimeout(window.toastTimer);      const duration = action ? 6000 : 2600;      window.toastTimer = setTimeout(() => toastEl.classList.remove("show"), duration);    };    toastCloseEl.addEventListener("click", () => toastEl.classList.remove("show"));    toastActionBtnEl.addEventListener("click", () => {      if (toastActionHandler) toastActionHandler();      toastEl.classList.remove("show");    });    const getNoteAnswerValue = (n, fieldKey) => {      const direct = (n.response1 || "").trim();      if (direct) return direct;      const ans = (n.answers || []).find(a => a.field_key === fieldKey);      return (ans && ans.value_text) ? String(ans.value_text) : "";    };    const getCallResultNotes = (p) => (p.admissionNotes || [])      .filter(n => Number(n.template_id) === REACHED_TEMPLATE_ID && (n.workspace_key || "") === WORKSPACE_KEY);    const getAttemptNotes = (p) => getCallResultNotes(p)      .filter(n => ATTEMPT_ANSWERS.has(getNoteAnswerValue(n, REACHED_FIELD_KEY)));    const getReachedNotes = (p) => getCallResultNotes(p)      .filter(n => getNoteAnswerValue(n, REACHED_FIELD_KEY) === REACHED_ANSWER);    const getCcmNotes = (p) => (p.admissionNotes || [])      .filter(n => Number(n.template_id) === CCM_TEMPLATE_ID && (n.workspace_key || "") === WORKSPACE_KEY);    const applyAttemptNotes = (p) => {      const attemptNotes = getAttemptNotes(p);      const reachedNotes = getReachedNotes(p);      const allContactNotes = [...attemptNotes, ...reachedNotes].filter(n => n.created_at);      const sorted = allContactNotes.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));      const attempts = attemptNotes.length;      p.contactAttempts = attempts;      p.lastContactAttemptAt = sorted[0]?.created_at || null;      if (reachedNotes.length) {        p.contactStatus = "reached";      } else if (attempts >= 2) {        p.contactStatus = "not_reachable_final";      } else if (attempts >= 1) {        p.contactStatus = "attempted_vm";      } else {        p.contactStatus = "not_attempted";      }    };      const buildActivityLog = (p) => {        const entries = (p.localActivityLog || []).map(item => {          if (typeof item === "string") return { text: item };          return item;        });        const attemptNotes = getAttemptNotes(p);        const reachedNotes = getReachedNotes(p);        const ccmNotes = getCcmNotes(p);      attemptNotes.forEach(n => {        const stamp = n.created_at ? formatStamp(new Date(n.created_at)) : formatStamp(new Date());        const detail = getNoteAnswerValue(n, REACHED_FIELD_KEY) || CALL_VM_ANSWER;        entries.unshift({          text: `${stamp} - ${detail}`,          noteId: n.id,          templateId: REACHED_TEMPLATE_ID,          createdAt: n.created_at || ""        });      });      reachedNotes.forEach(n => {        const stamp = n.created_at ? formatStamp(new Date(n.created_at)) : formatStamp(new Date());        const detail = (getNoteAnswerValue(n, REACHED_FIELD_KEY) || REACHED_ANSWER || "Reached patient").trim();        const prefix = "Reached patient";        const suffix = detail && detail !== prefix ? ` - ${detail}` : "";        entries.unshift({          text: `${stamp} - ${prefix}${suffix}`,          noteId: n.id,          templateId: REACHED_TEMPLATE_ID,          createdAt: n.created_at || ""        });      });        ccmNotes.forEach(n => {          const stamp = n.created_at ? formatStamp(new Date(n.created_at)) : formatStamp(new Date());          const detail = (getNoteAnswerValue(n, CCM_FIELD_KEY) || n.response1 || "").trim();          const isDeclined = detail.toLowerCase().includes("declined");          const prefix = isDeclined ? "CCM Declined" : "CCM Accepted";          const suffix = detail ? ` - ${detail}` : "";          entries.unshift({            text: `${stamp} - ${prefix}${suffix}`,            noteId: n.id,            templateId: CCM_TEMPLATE_ID,            createdAt: n.created_at || ""          });        });        const pcpCareTeam = getPcpCareTeam(p);        const pcpAppt = getPcpAppointment(p, pcpCareTeam);        if (pcpAppt) {          const stamp = pcpAppt.created_at            ? formatStamp(new Date(pcpAppt.created_at))            : pcpAppt.appt_datetime              ? formatStamp(new Date(pcpAppt.appt_datetime))              : formatStamp(new Date());          entries.unshift({            text: `${stamp} - PCP Appt created`,            createdAt: pcpAppt.created_at || pcpAppt.appt_datetime || ""          });        }        const allFaxLogs = (p.faxLogs || []).slice();        allFaxLogs.forEach(log => {          const stamp = log.created_at ? formatStamp(new Date(log.created_at)) : formatStamp(new Date());          const status = (log.status || "unknown").toString();          const toFax = formatPhoneDisplay(log.to_fax || "");          const source = isPcpFaxLog(log, pcpCareTeam && pcpCareTeam.fax) ? "PCP" : "Fax";          entries.unshift({            text: `${stamp} - ${source} Fax ${status} - ${toFax}`,            createdAt: log.created_at || ""          });        });        return entries;      };    let noteTemplatesCache = null;    const loadNoteTemplates = async () => {      if (noteTemplatesCache) return noteTemplatesCache;      if (!token()) return [];      const res = await fetch("/api/sensys/note-templates", { headers: authHeaders() });      if (!res.ok) throw new Error("Failed to load note templates");      const data = await res.json();      noteTemplatesCache = data.templates || [];      return noteTemplatesCache;    };    const getLatestWorkspaceNote = (p, templateId) => {      const notes = (p.admissionNotes || [])        .filter(n => (n.workspace_key || "") === WORKSPACE_KEY && Number(n.template_id) === Number(templateId) && n.created_at);      if (!notes.length) return null;      notes.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));      return notes[0];    };    let noteDetailsContext = null;    const openNoteDetailsModal = async (p, templateId, defaultAnswer, noteOverride) => {      if (!token()) return;      try {        const templates = await loadNoteTemplates();        const tpl = templates.find(t => Number(t.id) === Number(templateId));        if (!tpl) {          showToast("Note template missing", p.name);          return;        }        const note = noteOverride || getLatestWorkspaceNote(p, templateId);        const answers = (note && note.answers) ? note.answers : [];        const answerMap = {};        answers.forEach(a => {          const key = a.field_key;          if (!key) return;          if (a.value_text != null && a.value_text !== "") answerMap[key] = a.value_text;          else if (a.value_num != null) answerMap[key] = String(a.value_num);          else if (a.value_date) answerMap[key] = a.value_date;          else if (a.value_bool != null) answerMap[key] = String(a.value_bool);        });        if (templateId === REACHED_TEMPLATE_ID && !answerMap[REACHED_FIELD_KEY]) {          const fallback = (note && note.response1) || defaultAnswer || "";          if (fallback) answerMap[REACHED_FIELD_KEY] = fallback;        }        if (templateId === CCM_TEMPLATE_ID && !answerMap[CCM_FIELD_KEY]) {          const fallback = (note && note.response1) || defaultAnswer || "";          if (fallback) answerMap[CCM_FIELD_KEY] = fallback;        }        noteDetailsTitleEl.textContent = `${tpl.template_name || "Note"} - ${p.name}`;        noteDetailsBodyEl.innerHTML = (tpl.fields || []).map(f => {          const key = f.field_key || "";          const label = f.field_label || key;          const type = (f.field_type || "text").toLowerCase();          const required = String(f.required || 0) === "1";          const value = answerMap[key] || "";          const base = `data-field-key="${key}" data-field-type="${type}"`;          if (type === "textarea") {            return `              <div style="margin-bottom:12px;">
                                                                                                                                                                                                                                        <label>${label}${required ? " *" : ""}</label>
                                                                                                                                                                                                                                          <textarea class="ipt" rows="3" ${base}>${value}</textarea>
                                                                                                                                                                                                                                          </div>            `;          }          if (type === "boolean") {            return `              <div style="margin-bottom:12px;">
                                                                                                                                                                                                                                          <label>${label}${required ? " *" : ""}</label>
                                                                                                                                                                                                                                            <select class="ipt" ${base}>
                                                                                                                                                                                                                                              <option value="">Select</option>
                                                                                                                                                                                                                                                <option value="1" ${value === "1" ? "selected" : ""}>Yes</option>
                                                                                                                                                                                                                                                  <option value="0" ${value === "0" ? "selected" : ""}>No</option>
                                                                                                                                                                                                                                                  </select>
                                                                                                                                                                                                                                                </div>            `;          }          if (type === "select") {            let opts = [];            try {              const parsed = JSON.parse(f.options_json || "[]");              opts = Array.isArray(parsed) ? parsed : [];            } catch (e) {              opts = String(f.options_json || "")                .split(/[\\n,]/)                .map(s => s.trim())                .filter(Boolean);            }            return `              <div style="margin-bottom:12px;">
                                                                                                                                                                                                                                                <label>${label}${required ? " *" : ""}</label>
                                                                                                                                                                                                                                                  <select class="ipt" ${base}>
                                                                                                                                                                                                                                                    <option value="">Select</option>                  ${opts.map(opt => `<option value="${String(opt)}" ${String(opt) === value ? "selected" : ""}>${String(opt)}</option>`).join("")}                </select>
                                                                                                                                                                                                                                                    </div>            `;          }          const inputType = type === "number" ? "number" : type === "date" ? "date" : "text";          return `            <div style="margin-bottom:12px;">
                                                                                                                                                                                                                                                    <label>${label}${required ? " *" : ""}</label>
                                                                                                                                                                                                                                                      <input class="ipt" type="${inputType}" value="${value}" ${base} />
                                                                                                                                                                                                                                                    </div>          `;        }).join("");        let noteName = REACHED_NOTE_NAME;        let noteResponse1 = note ? (note.response1 || "") : (templateId === REACHED_TEMPLATE_ID ? (defaultAnswer || REACHED_ANSWER) : "");        if (templateId === ATTEMPT_TEMPLATE_ID) {          noteName = ATTEMPT_NOTE_NAME;          noteResponse1 = note ? (note.response1 || "") : "";        }        if (templateId === CCM_TEMPLATE_ID) {          noteName = CCM_NOTE_NAME;          noteResponse1 = note ? (note.response1 || "") : (defaultAnswer || "");        }        noteDetailsContext = {          patientId: p.id,          templateId: Number(templateId),          noteId: note ? Number(note.id) : null,          noteName,          noteResponse1        };        openModal(noteDetailsModalEl);      } catch (err) {        console.warn("[Evolv SNF] note modal failed:", err);        showToast("Note modal failed", p.name);      }    };    const openNoteDetailsModalForNote = (p, noteId) => {      if (!token()) return;      const note = (p.admissionNotes || []).find(n => Number(n.id) === Number(noteId));      if (!note) return;      openNoteDetailsModal(p, Number(note.template_id), null, note);    };    const addActivity = (p, text) => {      p.localActivityLog = p.localActivityLog || [];      p.localActivityLog.unshift({        text: `${formatStamp(new Date())} - ${text}`,        createdAt: new Date().toISOString()      });      p.activityLog = buildActivityLog(p);    };    const getPcpCareTeam = (p) => {      const list = p.careTeam || [];      return list.find(ct => {        const t = (ct.type || "").toLowerCase();        const n = (ct.name || "").toLowerCase();        return t.includes("pcp") || t.includes("primary") || n.includes("pcp");      }) || null;    };    const getSnfAttendingCareTeam = (p) => {      const list = p.careTeam || [];      return list.filter(ct => {        const t = (ct.type || "").toLowerCase();        return t.includes("snf attending") || t.includes("snf physician");      });    };    const isEsignSigned = (esign) => {      const status = (esign && esign.status ? esign.status : "").toString().toLowerCase();      return status === "signed" || status === "emr signed" || Boolean(esign && esign.signed_at);    };    const getEsignCounts = (p) => {      const esigns = (p && p.esigns) ? p.esigns : [];      const total = esigns.length;      const signed = esigns.filter(isEsignSigned).length;      return { total, signed, unsigned: Math.max(0, total - signed) };    };    formatOrdersStatus = (p) => {      const counts = getEsignCounts(p);      if (!counts.total) return "No Orders";      return `${counts.signed} of ${counts.total} Signed`;    };          const formatCareTeamMissingText = (ct) => {      const phoneMissing = !(ct && (ct.phone1 || "").trim());      const emailMissing = !(ct && (ct.email1 || "").trim());      if (!phoneMissing && !emailMissing) return "";      if (phoneMissing && emailMissing) return " - Missing phone and email!";      if (phoneMissing) return " - Missing Phone!";      return " - Missing Email!";    };    const renderOrdersCareTeam = (p) => {      const list = getSnfAttendingCareTeam(p);      if (!list.length) return `<div class="card-meta orders-attending-line">No SNF Attending on file.</div>`;      return list.map(ct => {        const esign = Number(ct.esign_link_count || 0) > 0;        const esignPill = esign ? ` <span class="orders-esign-pill">E-Sign</span>` : "";        const missing = formatCareTeamMissingText(ct);        return `<div class="card-meta orders-attending-line">${ct.name || "Unknown"}${esignPill}${missing}</div>`;      }).join("");    };    const getLatestSnfPhysician = (p) => {      const list = (p && p.careTeam ? p.careTeam : []).filter(ct => ((ct.type || ct.care_team_type || "").toString().toLowerCase().includes("snf physician")));      if (!list.length) return null;      return list.reduce((best, item) => {        const a = Number(best && (best.link_id || best.care_team_id || best.id) || 0);        const b = Number(item && (item.link_id || item.care_team_id || item.id) || 0);        return b >= a ? item : best;      }, list[0]);    };    const getCareTeamLabel = (ct) => {      if (!ct) return "Unassigned";      const name = (ct.name || [ct.first_name, ct.last_name].filter(Boolean).join(" ").trim() || "Care Team");      const role = (ct.type || ct.care_team_type || ct.role || "").toString().trim();      return role ? `${name} - ${role}` : name;    };    const getServiceTypeGroup = (raw) => {      const key = (raw || "").toString().toLowerCase();      if (!key) return "";      if (key.includes("home") || key.includes("hh")) return "home_health";      if (key.includes("dme") || key.includes("durable") || key.includes("equipment")) return "dme";      return "";    };    const getServiceTypeGroupFor = (obj) => {      if (!obj) return "";      return getServiceTypeGroup(obj.code || obj.service_type_code || obj.service_type || obj.name || obj.service_type_name || "");    };    const ensureServiceCatalogLoaded = async () => {      if (serviceCatalogLoaded || !token()) return;      try {        const [typesRes, servicesRes] = await Promise.all([          fetch("/api/sensys/service-types", { headers: authHeaders() }),          fetch("/api/sensys/services", { headers: authHeaders() })        ]);        if (typesRes.ok) {          const data = await typesRes.json();          SERVICE_TYPES = data.service_types || [];        }        if (servicesRes.ok) {          const data = await servicesRes.json();          SERVICES = data.services || [];        }      } catch (err) {        console.warn("[Evolv SNF] service catalog load failed:", err);      }      serviceCatalogLoaded = true;    };    const getPcpAppointment = (p, pcpCareTeam) => {      const list = (p.appointments || []).slice();      if (!list.length) return null;      const pcpId = pcpCareTeam ? String(pcpCareTeam.care_team_id || pcpCareTeam.id || "") : "";      const filtered = list.filter(appt => {        const t = (appt.care_team_type || "").toLowerCase();        const id = String(appt.care_team_id || "");        return (pcpId && id === pcpId) || t.includes("pcp") || t.includes("primary");      });      const pool = filtered.length ? filtered : list;      pool.sort((a, b) => {        const aTs = Date.parse(a.appt_datetime || a.created_at || "");        const bTs = Date.parse(b.appt_datetime || b.created_at || "");        if (!Number.isNaN(aTs) && !Number.isNaN(bTs)) return bTs - aTs;        return 0;      });      return pool[0] || null;    };    const isPcpFaxLog = (log, fax) => {      const cover = (log.cover_text || "").toLowerCase();      const toFax = (log.to_fax || "").replace(/\D/g, "");      const cmpFax = (fax || "").replace(/\D/g, "");      if (cover.includes("pcp")) return true;      if (cmpFax && toFax && toFax === cmpFax) return true;      return false;    };    const updatePcpFaxed = (p) => {      const pcp = getPcpCareTeam(p);      const fax = (pcp && pcp.fax) ? String(pcp.fax) : "";      const logs = p.faxLogs || [];      p.pcpFaxed = logs.some(log => isPcpFaxLog(log, fax));    };    const loadAdmissionPdfs = async (p) => {      if (!token()) {        p.pdfs = p.pdfs || [];        return p.pdfs;      }      const res = await fetch(`/api/sensys/admissions/${p.id}/pdfs`, { headers: authHeaders() });      if (!res.ok) throw new Error("Failed to load documents");      const data = await res.json();      p.pdfs = data.pdfs || [];      return p.pdfs;    };    const loadAdmissionDetails = async (p) => {      if (!token()) return null;      const res = await fetch(`/api/sensys/admission-details/${p.id}`, { headers: authHeaders() });      if (!res.ok) throw new Error("Failed to load admission details");      const data = await res.json();      p.careTeam = data.care_team || [];      p.esigns = data.esigns || [];      p.appointments = data.appointments || [];      p.pcpApptNeeded = !getPcpAppointment(p, getPcpCareTeam(p));      p.activityLog = buildActivityLog(p);      return data;    };    const loadAdmissionFaxLogs = async (p) => {      if (!token()) {        p.faxLogs = p.faxLogs || [];        return p.faxLogs;      }      const res = await fetch(`/api/sensys/admission-fax/${p.id}`, { headers: authHeaders() });      if (!res.ok) throw new Error("Failed to load fax logs");      const data = await res.json();      p.faxLogs = data.fax || [];      updatePcpFaxed(p);      p.activityLog = buildActivityLog(p);      return p.faxLogs;    };    const triggerDocUpload = (p, docKey, docTypeOverride) => {      if (!docsUploadInputEl) return;      pendingDocUpload = {        patientId: p.id,        docKey,        docType: docTypeOverride || DOC_LABELS[docKey] || docKey      };      docsUploadInputEl.value = "";      docsUploadInputEl.click();    };    const uploadDocForAdmission = async (p, docKey, docType, file) => {      if (!file) return;      if (!token()) {        showToast("Upload requires login", p.name);        return;      }      const fd = new FormData();      fd.append("doc_type", docType);      fd.append("file", file);      const res = await fetch(`/api/sensys/admissions/${p.id}/pdfs/upload`, {        method: "POST",        headers: authHeaders(),        body: fd      });      if (!res.ok) {        showToast("Upload failed", p.name);        return;      }      let effectiveKey = docKey;      if (!effectiveKey) {        effectiveKey = Object.keys(DOC_LABELS).find(k => DOC_LABELS[k] === docType) || null;      }      if (effectiveKey) {        p.docsChecklist[effectiveKey] = true;        if (p.docsStatus !== "complete") p.docsStatus = "in_progress";        const keyMap = {          faceSheet: "docs_facesheet",          orders: "docs_dc_summary",          clinicals: "docs_physicians_added"        };        try {          await saveDocsUpdate(p, {            [keyMap[effectiveKey]]: 1,            docs_status: p.docsStatus          });        } catch (err) {          console.warn("[Evolv SNF] docs update failed:", err);        }      }      await loadAdmissionPdfs(p);      renderDrawer();      refreshOpenDrawers(p);    };    const openPcpApptModal = (p) => {      if (!pcpApptModalEl) return;      if (!token()) {        showToast("Login required", p.name);        return;      }      const pcpCareTeam = getPcpCareTeam(p);      if (!pcpCareTeam) {        showToast("No Sensys PCP", p.name);        return;      }      const appt = getPcpAppointment(p, pcpCareTeam);      pcpApptContext = { patientId: p.id, apptId: appt ? appt.id : null };      pcpApptDateEl.value = toLocalInputValue(appt && appt.appt_datetime ? appt.appt_datetime : "");      pcpApptCommentsEl.value = (appt && appt.appt_comments) ? String(appt.appt_comments) : "";      openModal(pcpApptModalEl);      setTimeout(() => {        if (pcpApptDateEl && typeof pcpApptDateEl.showPicker === "function") {          pcpApptDateEl.showPicker();        } else {          pcpApptDateEl && pcpApptDateEl.focus();        }      }, 80);    };    const openCareTeamEditModal = (p) => {      const ct = getPcpCareTeam(p);      if (!ct) {        showToast("No Sensys PCP", p.name);        return;      }      const $ = (id) => document.getElementById(id);      $("ctEditId").value = ct.care_team_id || ct.id || "";      $("ctEditName").value = ct.name || "";      $("ctEditType").value = ct.type || "";      $("ctEditNpi").value = ct.npi || "";      $("ctEditActive").value = (ct.active === 0 || ct.active === "0") ? "0" : "1";      $("ctEditAliases").value = ct.aliases || "";      $("ctEditPractice").value = ct.practice_name || "";      $("ctEditAddress1").value = ct.address1 || "";      $("ctEditAddress2").value = ct.address2 || "";      $("ctEditCity").value = ct.city || "";      $("ctEditState").value = ct.state || "";      $("ctEditZip").value = ct.zip || "";      $("ctEditPhone1").value = ct.phone1 || "";      $("ctEditPhone2").value = ct.phone2 || "";      $("ctEditEmail1").value = ct.email1 || "";      $("ctEditEmail2").value = ct.email2 || "";      $("ctEditFax").value = ct.fax || "";      openModal(careTeamEditModalEl);    };    const saveCareTeamEdit = async () => {      if (!token()) return;      const ctId = document.getElementById("ctEditId").value;      if (!ctId) return;      const p = patients.find(pt => String(pt.id) === String(selectedPatientId));      if (!p) return;      const payload = {        admission_id: Number(p.id),        care_team_id: Number(ctId),        name: document.getElementById("ctEditName").value.trim(),        type: document.getElementById("ctEditType").value.trim(),        npi: document.getElementById("ctEditNpi").value.trim(),        active: Number(document.getElementById("ctEditActive").value || 1),        aliases: document.getElementById("ctEditAliases").value.trim(),        practice_name: document.getElementById("ctEditPractice").value.trim(),        address1: document.getElementById("ctEditAddress1").value.trim(),        address2: document.getElementById("ctEditAddress2").value.trim(),        city: document.getElementById("ctEditCity").value.trim(),        state: document.getElementById("ctEditState").value.trim(),        zip: document.getElementById("ctEditZip").value.trim(),        phone1: document.getElementById("ctEditPhone1").value.trim(),        phone2: document.getElementById("ctEditPhone2").value.trim(),        email1: document.getElementById("ctEditEmail1").value.trim(),        email2: document.getElementById("ctEditEmail2").value.trim(),        fax: document.getElementById("ctEditFax").value.trim()      };      try {        const res = await fetch("/api/sensys/care-team/update", {          method: "POST",          headers: { ...authHeaders(), "Content-Type": "application/json" },          body: JSON.stringify(payload)        });        if (!res.ok) throw new Error("Care team update failed");        await loadAdmissionDetails(p);        renderDrawer();        refreshOpenDrawers(p);        closeModal(careTeamEditModalEl);        showToast("Care team updated", p.name);      } catch (err) {        showToast("Care team update failed", p.name);      }    };    const savePcpAppt = async () => {      if (!pcpApptContext || !token()) return;      const p = patients.find(pt => String(pt.id) === String(pcpApptContext.patientId));      if (!p) return;      const pcpCareTeam = getPcpCareTeam(p);      if (!pcpCareTeam) {        showToast("No Sensys PCP", p.name);        return;      }      const apptLocal = (pcpApptDateEl.value || "").trim();      if (!apptLocal) {        showToast("Please add appointment date/time", p.name);        return;      }      const apptIso = new Date(apptLocal).toISOString();      const payload = {        id: pcpApptContext.apptId,        admission_id: Number(p.id),        appt_datetime: apptIso,        care_team_id: Number(pcpCareTeam.care_team_id || pcpCareTeam.id),        appt_status: "New",        appt_comments: (pcpApptCommentsEl.value || "").trim()      };      try {        const res = await fetch("/api/sensys/admission-appointments/upsert", {          method: "POST",          headers: { ...authHeaders(), "Content-Type": "application/json" },          body: JSON.stringify(payload)        });        if (!res.ok) throw new Error("Appointment save failed");        await loadAdmissionDetails(p);        const appt = getPcpAppointment(p, getPcpCareTeam(p));        const apptWhen = appt && appt.appt_datetime ? formatDateTime(appt.appt_datetime) : "?";        addActivity(p, `PCP Appt created - Appt ${apptWhen}`);        p.activityLog = buildActivityLog(p);        renderDrawer();        refreshOpenDrawers(p);        showToast("PCP Appt created", p.name);        closeModal(pcpApptModalEl);        pcpApptContext = null;      } catch (err) {        showToast("PCP Appt failed", p.name);      }    };    const faxPcpRecords = async (p) => {      if (!token()) {        showToast("Login required", p.name);        return;      }      const pcpCareTeam = getPcpCareTeam(p);      const fax = (pcpCareTeam && pcpCareTeam.fax) ? normalizeE164(String(pcpCareTeam.fax).trim()) : "";      if (!pcpCareTeam) {        showToast("No Sensys PCP", p.name);        return;      }      if (!fax) {        showToast("Missing PCP fax number", p.name);        return;      }      await loadAdmissionPdfs(p);      const facesheet = (p.pdfs || []).find(r => r && r.doc_type === DOC_LABELS.faceSheet);      const dcSummary = (p.pdfs || []).find(r => r && r.doc_type === DOC_LABELS.orders);      const missing = [];      if (!facesheet) missing.push("Facesheet");      if (!dcSummary) missing.push("DC Summary");      if (missing.length) {        showToast(`Missing ${missing.join(" & ")} PDF`, p.name);        return;      }        try {          const payload = {            admission_id: Number(p.id),            to_fax: fax,            pdf_ids: [Number(facesheet.id), Number(dcSummary.id)],            cover_text: "PCP Records - Facesheet + DC Summary",            fax_resolution: "High"          };          const res = await fetch("/api/sensys/admission-fax/send-merged", {            method: "POST",            headers: { ...authHeaders(), "Content-Type": "application/json" },            body: JSON.stringify(payload)          });          if (!res.ok) throw new Error("Fax failed");          await loadAdmissionFaxLogs(p);          p.activityLog = buildActivityLog(p);          renderDrawer();        refreshOpenDrawers(p);        showToast("Faxed records to PCP", p.name);      } catch (err) {        showToast("Fax failed", p.name);      }    };    const renderFaxLogRows = (p) => {      const rows = (p.faxLogs || []).slice();      if (!faxLogTbodyEl) return;      if (!rows.length) {        faxLogTbodyEl.innerHTML = `<tr>
                                                                                                                                                                                                                                                    <td colspan="6" style="padding:12px;color:#667085;">No faxes found.</td>
                                                                                                                                                                                                                                                    </tr>`;        return;      }      const statusClass = (s) => {        const v = String(s || "").toLowerCase();        if (v.includes("error") || v.includes("failed")) return "error";        if (v.includes("queued") || v.includes("sending") || v.includes("submitted")) return "queued";        if (v.includes("sent") || v.includes("delivered")) return "sent";        return "";      };      const fmtFax = (v) => formatPhoneDisplay(v || "");      const fmtDate = (v) => v ? formatStamp(new Date(v)) : "?";      const pcp = getPcpCareTeam(p);      const pcpName = pcp ? (pcp.name || "") : "";      const pcpFax = pcp ? formatPhoneDisplay(pcp.fax || "") : "";      faxLogTbodyEl.innerHTML = rows.map(r => {        const isPcp = isPcpFaxLog(r, pcp && pcp.fax);        const source = isPcp ? "PCP" : "Other";        const detail = isPcp          ? `<div>${pcpName || "PCP"}</div>
                                                                                                                                                                                                                                                    <div style="color:#667085;font-size:12px;">${pcpFax || formatPhoneDisplay(r.to_fax || "")}</div>`          : `<div>${(r.cover_text || "?")}</div>
                                                                                                                                                                                                                                                      <div style="color:#667085;font-size:12px;">${formatPhoneDisplay(r.to_fax || "")}</div>`;        return `        <tr>
                                                                                                                                                                                                                                                        <td>${fmtDate(r.created_at)}</td>
                                                                                                                                                                                                                                                          <td>${source}</td>
                                                                                                                                                                                                                                                            <td>${fmtFax(r.to_fax)}</td>
                                                                                                                                                                                                                                                              <td>${detail}</td>
                                                                                                                                                                                                                                                                <td>
                                                                                                                                                                                                                                                                  <span class="fax-status ${statusClass(r.status)}">${(r.status || "unknown")}</span>
                                                                                                                                                                                                                                                                  </td>
                                                                                                                                                                                                                                                                  <td style="text-align:right;">
                                                                                                                                                                                                                                                                    <button class="btn btn-small" data-fax-resend="${r.id}" ${["error","failed"].includes(String(r.status || "").toLowerCase()) ? "" : "disabled"}>Resend</button>
                                                                                                                                                                                                                                                                    </td>
                                                                                                                                                                                                                                                                  </tr>      `;      }).join("");    };    const openFaxLogModal = async (p) => {      if (!token()) {        showToast("Login required", p.name);        return;      }      try {        await fetch(`/api/sensys/admission-fax/refresh-recent/${p.id}`, {          method: "POST",          headers: { ...authHeaders(), "Content-Type": "application/json" },          body: JSON.stringify({ max_age_minutes: 240 })        });      } catch (err) {        /* ignore refresh errors, still show current list */      }      try {        await loadAdmissionFaxLogs(p);        renderFaxLogRows(p);        openModal(faxLogModalEl);        faxLogModalEl.querySelectorAll("[data-fax-resend]").forEach(btn => {          btn.addEventListener("click", async () => {            const id = btn.dataset.faxResend;            const row = (p.faxLogs || []).find(r => String(r.id) === String(id));            if (!row) return;            if (!row.to_fax || !row.pdf_id) {              showToast("Missing fax details", p.name);              return;            }            try {              const payload = {                admission_id: Number(p.id),                to_fax: row.to_fax,                pdf_id: Number(row.pdf_id),                cover_text: row.cover_text || "Resent fax"              };              const res = await fetch("/api/sensys/admission-fax/send", {                method: "POST",                headers: { ...authHeaders(), "Content-Type": "application/json" },                body: JSON.stringify(payload)              });              if (!res.ok) throw new Error("Resend failed");              await loadAdmissionFaxLogs(p);              renderFaxLogRows(p);              showToast("Fax resend queued", p.name);            } catch (err) {              showToast("Fax resend failed", p.name);            }          });        });      } catch (err) {        showToast("Fax log failed", p.name);      }    };    const buildActivityItems = (p) => {      const activity = (p.activityLog || []).map(item => ({        text: item.text || item,        createdAt: item && item.createdAt ? item.createdAt : null,        noteId: item && item.noteId ? item.noteId : null,        templateId: item && item.templateId ? item.templateId : null,        status: item && item.status ? item.status : ""      }));      const docItems = (p.pdfs || [])        .filter(r => r && r.doc_type && Object.values(DOC_LABELS).includes(r.doc_type))        .map(r => {          const stamp = r.created_at ? formatStamp(new Date(r.created_at)) : formatStamp(new Date());          const name = r.original_filename || r.filename || "Document";          return {            text: `${stamp} - ${r.doc_type} - ${name}`,            createdAt: r.created_at || null,            noteId: null,            templateId: null,            status: ""          };        });      const items = activity.concat(docItems);      items.sort((a, b) => {        const aTs = a && a.createdAt ? Date.parse(a.createdAt) : NaN;        const bTs = b && b.createdAt ? Date.parse(b.createdAt) : NaN;        if (!Number.isNaN(aTs) && !Number.isNaN(bTs)) return bTs - aTs;        return 0;      });      return items;    };     const openOrdersDrawer = async (p) => {      if (!token()) {        showToast("Login required", p.name);        return;      }      await loadAdmissionDetails(p);      await ensureServiceCatalogLoaded();      const esigns = (p.esigns || []);      const latestSnf = getLatestSnfPhysician(p);      const defaultCareTeamId = latestSnf ? (latestSnf.care_team_id || latestSnf.id || "") : "";      const buildServiceTypeOptions = () => {        const types = (SERVICE_TYPES || []).filter(st => getServiceTypeGroupFor(st));        const options = types.map(st => ({ id: st.id, label: st.name || st.code || st.service_type || "Service Type" }));        const existing = esigns.map(e => ({ id: e.service_type_id, label: e.service_type_name || e.service_type_code || "Service Type" }));        existing.forEach(opt => {          if (opt.id && !options.some(o => String(o.id) === String(opt.id))) options.push(opt);        });        if (!options.length) {          const fallback = (SERVICES || []).map(s => ({ id: s.service_type_id, label: s.service_type_name || s.service_type_code || s.service_type || "Service Type", group: getServiceTypeGroupFor(s) }))            .filter(o => o.id && o.group)            .reduce((acc, cur) => {              if (!acc.some(a => String(a.id) === String(cur.id))) acc.push({ id: cur.id, label: cur.label });              return acc;            }, []);          return fallback;        }        return options;      };      const getServiceTypeLabel = (typeId) => {        const type = (SERVICE_TYPES || []).find(st => String(st.id) === String(typeId));        if (type) return type.name || type.code || type.service_type || "Service Type";        const match = esigns.find(e => String(e.service_type_id) === String(typeId));        return match ? (match.service_type_name || match.service_type_code || "Service Type") : "Service Type";      };      const getServicesForType = (typeId) => {        if (!typeId) return [];        let list = (SERVICES || []).filter(s => String(s.service_type_id) === String(typeId));        if (!list.length) {          const type = (SERVICE_TYPES || []).find(st => String(st.id) === String(typeId));          const group = getServiceTypeGroupFor(type) || getServiceTypeGroupFor({ service_type_id: typeId });          if (group) list = (SERVICES || []).filter(s => getServiceTypeGroupFor(s) === group);        }        return list;      };      const getStatusLabel = (status) => {        const key = (status || "Pending").toString().toLowerCase();        if (key === "emr signed") return "EMR Signed";        if (key === "signed") return "Signed";        if (key === "declined") return "Declined";        return "Pending";      };      const ICON_PLUS = `<svg class="zip-svg" viewBox="0 0 218.13 218.13" aria-hidden="true"><line x1="109.07" y1="2.75" x2="109.07" y2="215.38"/><line x1="215.38" y1="109.07" x2="2.75" y2="109.07"/></svg>`;      const ICON_PENCIL = `<svg class="zip-svg" viewBox="0 0 237.85 237.86" aria-hidden="true"><line x1="34.25" y1="178.82" x2="57.97" y2="202.54"/><path d="M68.74,219.9c-3.65,3.65-8.34,6.09-13.43,6.97l-47.25,8.18c-3.09.53-5.78-2.15-5.24-5.24l8.17-47.25c.88-5.09,3.31-9.78,6.97-13.44L173.79,13.27c14.02-14.02,36.76-14.03,50.78,0h0c14.02,14.02,14.03,36.76,0,50.79L68.74,219.9Z"/></svg>`;      const ICON_TRASH = `<svg class="zip-svg" viewBox="0 0 224.65 262.72" aria-hidden="true"><path d="M205.74,105.45v128.84c0,14.18-11.49,25.67-25.67,25.67H43.59c-14.18,0-25.67-11.49-25.67-25.67V105.45"/><path d="M24.99,41.02h174.66c12.28,0,22.24,9.97,22.24,22.24v13.37c0,5.42-4.4,9.81-9.81,9.81H12.56c-5.42,0-9.81-4.4-9.81-9.81v-13.37c0-12.28,9.97-22.24,22.24-22.24Z"/><path d="M63.83,39.75v-23.26c0-7.58,6.15-13.73,13.73-13.73h68.53c7.58,0,13.73,6.15,13.73,13.73v23.26"/><line x1="80.17" y1="125.24" x2="80.17" y2="217.29"/><line x1="144.48" y1="125.24" x2="144.48" y2="217.29"/></svg>`;      let editingOrder = null;      const renderOrdersDrawer = () => {        const typeOptions = buildServiceTypeOptions();        const careTeamOptions = (p.careTeam || []).map(ct => ({ id: ct.care_team_id || ct.id, label: getCareTeamLabel(ct) }));        const selectedTypeId = editingOrder ? String(editingOrder.service_type_id || "") : (typeOptions[0] ? String(typeOptions[0].id) : "");        const selectedCareTeamId = editingOrder ? String(editingOrder.care_team_id || "") : String(defaultCareTeamId || "");        const selectedStatus = editingOrder ? getStatusLabel(editingOrder.status) : "Pending";        const selectedServices = editingOrder ? (editingOrder.services || []).map(s => String(s.id)) : [];        const servicesForType = getServicesForType(selectedTypeId);        const servicesOptions = servicesForType.map(s => ({ id: s.id, label: s.name || s.service_name || "Service" }));        (editingOrder && editingOrder.services || []).forEach(s => {          if (s.id && !servicesOptions.some(opt => String(opt.id) === String(s.id))) servicesOptions.push({ id: s.id, label: s.service_name || "Service" });        });        const ordersTable = esigns.length ? esigns.map(e => {          const statusKey = (e.status || "Pending").toString().toLowerCase().replace(/\\s+/g, "-");          const statusLabel = getStatusLabel(e.status);          const servicesText = (e.services || []).map(s => s.service_name).filter(Boolean).join(", ") || "-";          const careTeamName = e.care_team_name || "Unassigned";          const stamp = e.signed_at ? `Signed ${formatDateTime(e.signed_at)}` : (e.updated_at ? `Updated ${formatDateTime(e.updated_at)}` : (e.created_at ? `Created ${formatDateTime(e.created_at)}` : "-"));          const orderLabel = e.id ? `Order #${e.id}` : "Order";          return `            <tr>              <td>                <div class="orders-stack">                  <div class="orders-stack-title">${orderLabel}</div>                  <div class="orders-stack-sub"><span class="orders-status ${statusKey}" data-status="${statusKey}">${statusLabel}</span></div>                </div>              </td>              <td>                <div class="orders-stack">                  <div class="orders-stack-title">${getServiceTypeLabel(e.service_type_id)}</div>                  <div class="orders-stack-sub">${servicesText}</div>                </div>              </td>              <td>                <div class="orders-stack">                  <div class="orders-stack-title">${careTeamName}</div>                  <div class="orders-stack-sub">${stamp}</div>                </div>              </td>              <td class="orders-table-actions">                <button class="btn-icon" data-order-edit="${e.id}" aria-label="Edit" title="Edit">${ICON_PENCIL}</button>                <button class="btn-icon danger" data-order-delete="${e.id}" aria-label="Delete" title="Delete">${ICON_TRASH}</button>              </td>            </tr>          `;        }).join("") : `          <tr>            <td colspan="4">No orders created yet.</td>          </tr>        `;        ordersDrawerEl.innerHTML = `          <div class="drawer-header">            <div>              <div class="drawer-title">Physician Orders</div>              <div class="drawer-sub">${p.name} - ${p.facilityName}</div>            </div>            <div class="orders-header-actions">              <button class="btn-icon" id="ordersAddBtn" aria-label="Add E-Sign" title="Add E-Sign">${ICON_PLUS}</button>              <button class="btn btn-primary btn-small" id="btnOrdersDone">Done</button>            </div>          </div>          <div class="drawer-body">            <div class="info-section">              <div class="info-label">Orders</div>              <div class="orders-table-wrap" style="overflow:auto;">                <table class="table table-small">                  <thead>                    <tr>                      <th>Order</th>                      <th>Service</th>                      <th>Care Team</th>                      <th>Actions</th>                    </tr>                  </thead>                  <tbody>                    ${ordersTable}                  </tbody>                </table>              </div>            </div>          </div>        `;        const ensureOrdersModal = () => {        let backdrop = document.getElementById("ordersModalBackdrop");        if (!backdrop) {          document.body.insertAdjacentHTML("beforeend", `            <div id="ordersModalBackdrop" class="doc-modal-backdrop" aria-live="polite">              <div class="doc-modal">                <div class="doc-modal-head">                  <div>                    <div class="doc-modal-title" id="ordersModalTitle">Add E-Sign Order</div>                    <div class="doc-modal-sub" id="ordersModalSub"></div>                  </div>                </div>                <div class="doc-modal-body">                  <div class="doc-modal-row">                    <div style="flex:1;min-width:220px;">                      <div class="info-label">Service Type</div>                      <select class="doc-input" id="ordersServiceTypeModal"></select>                    </div>                    <div style="flex:1;min-width:220px;">                      <div class="info-label">Care Team</div>                      <select class="doc-input" id="ordersCareTeamModal"></select>                    </div>                  </div>                  <div class="doc-modal-row" style="margin-top:10px;">                    <div style="flex:1;min-width:220px;">                      <div class="info-label">Status</div>                      <select class="doc-input" id="ordersStatusModal">                        <option>Pending</option>                        <option>EMR Signed</option>                        <option>Declined</option>                      </select>                    </div>                  </div>                  <div class="doc-modal-row" style="margin-top:10px;">                    <div style="flex:1;min-width:260px;">                      <div class="info-label">Services</div>                      <div class="checkwrap">                        <input class="checksearch" id="ordersServicesSearch" placeholder="Search services." />                        <div class="checklist" id="ordersServicesChecklist"></div>                      </div>                    </div>                  </div>                  <div class="doc-modal-row" style="margin-top:10px;">                    <div style="flex:1;min-width:260px;">                      <div class="info-label">Comments</div>                      <textarea class="doc-input" id="ordersCommentsModal" rows="3" placeholder="Notes for this order"></textarea>                    </div>                  </div>                </div>                <div class="doc-modal-footer">                  <button class="doc-modal-close" id="ordersModalCancel">Cancel</button>                  <button class="btn btn-primary btn-small" id="ordersModalSave">Save Order</button>                </div>              </div>            </div>          `);          backdrop = document.getElementById("ordersModalBackdrop");          backdrop.addEventListener("click", (e) => {            if (e.target === backdrop) closeOrdersModal();          });        }        return backdrop;      };      const closeOrdersModal = () => {        const backdrop = document.getElementById("ordersModalBackdrop");        if (backdrop) backdrop.style.display = "none";      };      const openOrdersModal = (order) => {        const backdrop = ensureOrdersModal();        const titleEl = backdrop.querySelector("#ordersModalTitle");        const subEl = backdrop.querySelector("#ordersModalSub");        const serviceTypeEl = backdrop.querySelector("#ordersServiceTypeModal");        const careTeamEl = backdrop.querySelector("#ordersCareTeamModal");        const statusEl = backdrop.querySelector("#ordersStatusModal");        const servicesSearchEl = backdrop.querySelector("#ordersServicesSearch");        const servicesChecklistEl = backdrop.querySelector("#ordersServicesChecklist");        const commentsEl = backdrop.querySelector("#ordersCommentsModal");        editingOrder = order || null;        const typeOptions = buildServiceTypeOptions();        const careTeamOptions = (p.careTeam || []).map(ct => ({ id: ct.care_team_id || ct.id, label: getCareTeamLabel(ct) }));        const selectedTypeId = editingOrder ? String(editingOrder.service_type_id || "") : (typeOptions[0] ? String(typeOptions[0].id) : "");        const selectedCareTeamId = editingOrder ? String(editingOrder.care_team_id || "") : String(defaultCareTeamId || "");        const selectedStatus = editingOrder ? getStatusLabel(editingOrder.status) : "Pending";        const selectedServices = editingOrder ? (editingOrder.services || []).map(s => String(s.id)) : [];        const selectedServicesSet = new Set(selectedServices);        titleEl.textContent = editingOrder ? "Edit E-Sign Order" : "Add E-Sign Order";        subEl.textContent = `${p.name} - ${p.facilityName}`;        serviceTypeEl.innerHTML = typeOptions.map(opt => `<option value="${opt.id}">${opt.label}</option>`).join("");        careTeamEl.innerHTML = `<option value="">Unassigned</option>` + careTeamOptions.map(opt => `<option value="${opt.id}">${opt.label}</option>`).join("");        if (serviceTypeEl && selectedTypeId) serviceTypeEl.value = selectedTypeId;        if (careTeamEl) careTeamEl.value = selectedCareTeamId;        if (statusEl) statusEl.value = selectedStatus;        if (commentsEl) commentsEl.value = editingOrder ? (editingOrder.comments || "") : "";        const updateServices = () => {          const typeId = serviceTypeEl ? serviceTypeEl.value : "";          const services = getServicesForType(typeId);          const options = services.map(s => ({ id: s.id, label: s.name || s.service_name || "Service" }));          if (editingOrder && editingOrder.services) {            editingOrder.services.forEach(s => {              if (s.id && !options.some(o => String(o.id) === String(s.id))) options.push({ id: s.id, label: s.service_name || "Service" });            });          }          const query = (servicesSearchEl && servicesSearchEl.value || "").trim().toLowerCase();          const filtered = query ? options.filter(opt => (opt.label || "").toLowerCase().includes(query)) : options;          if (servicesChecklistEl) {            servicesChecklistEl.innerHTML = filtered.length ? filtered.map(opt => `              <label class="checkrow">                <input type="checkbox" value="${opt.id}" ${selectedServicesSet.has(String(opt.id)) ? "checked" : ""} />                <div>                  <div>${opt.label}</div>                </div>              </label>            `).join("") : `<div class="empty">No services found.</div>`;            servicesChecklistEl.querySelectorAll("input[type=\"checkbox\"]").forEach(cb => {              cb.addEventListener("change", () => {                if (cb.checked) {                  selectedServicesSet.add(String(cb.value));                } else {                  selectedServicesSet.delete(String(cb.value));                }              });            });          }        };        if (servicesSearchEl) servicesSearchEl.value = "";        updateServices();        servicesSearchEl?.addEventListener("input", updateServices);        serviceTypeEl?.addEventListener("change", updateServices);        backdrop.querySelector("#ordersModalCancel")?.addEventListener("click", closeOrdersModal);        backdrop.querySelector("#ordersModalSave")?.addEventListener("click", async () => {          const serviceTypeId = serviceTypeEl ? serviceTypeEl.value : "";          if (!serviceTypeId) {            showToast("Select a service type", p.name, null, { variant: "warning" });            return;          }          const servicesSelected = Array.from(selectedServicesSet).map(v => Number(v));          const payload = {            id: editingOrder ? Number(editingOrder.id) : null,            admission_id: Number(p.id),            care_team_id: careTeamEl && careTeamEl.value ? Number(careTeamEl.value) : null,            service_type_id: Number(serviceTypeId),            comments: commentsEl ? commentsEl.value.trim() : "",            status: statusEl ? statusEl.value : "Pending"          };          try {            const res = await fetch("/api/sensys/admission-esigns/upsert", {              method: "POST",              headers: { ...authHeaders(), "Content-Type": "application/json" },              body: JSON.stringify(payload)            });            if (!res.ok) throw new Error("Save failed");            const data = await res.json().catch(() => ({}));            const esignId = editingOrder ? Number(editingOrder.id) : (data.id || data.esign_id || data.esignId);            if (esignId) {              await fetch("/api/sensys/esign-services/set", {                method: "POST",                headers: { ...authHeaders(), "Content-Type": "application/json" },                body: JSON.stringify({ esign_id: Number(esignId), services_ids: servicesSelected })              });            }            await loadAdmissionDetails(p);            renderDrawer();            editingOrder = null;            closeOrdersModal();            openOrdersDrawer(p);          } catch (err) {            console.warn("[Evolv SNF] order save failed:", err);            showToast("Order save failed", p.name);          }        });        backdrop.style.display = "flex";      };      ordersDrawerEl.querySelector("#btnOrdersDone")?.addEventListener("click", () => {        ordersDrawerEl.classList.remove("open");        if (selectedPatientId) drawerEl.classList.add("open");        updateFabState();      });      ordersDrawerEl.querySelector("#ordersAddBtn")?.addEventListener("click", () => openOrdersModal(null));      ordersDrawerEl.querySelectorAll("[data-order-edit]").forEach(btn => {        btn.addEventListener("click", () => {          const id = btn.dataset.orderEdit;          const order = esigns.find(e => String(e.id) === String(id));          if (!order) return;          if (isEsignSigned(order)) {            showToast("Order already signed", p.name);            return;          }          openOrdersModal(order);        });      });      ordersDrawerEl.querySelectorAll("[data-order-delete]").forEach(btn => {        btn.addEventListener("click", async () => {          const id = btn.dataset.orderDelete;          if (!id) return;          if (!confirm("Delete this order?")) return;          try {            const res = await fetch("/api/sensys/admission-esigns/delete", {              method: "POST",              headers: { ...authHeaders(), "Content-Type": "application/json" },              body: JSON.stringify({ id: Number(id) })            });            if (!res.ok) throw new Error("Delete failed");            await loadAdmissionDetails(p);            renderDrawer();            editingOrder = null;            openOrdersDrawer(p);          } catch (err) {            showToast("Order delete failed", p.name);          }        });      });      };      ordersDrawerEl.innerHTML = "";      drawerEl.classList.remove("open");      infoDrawerEl.classList.remove("open");      contactDrawerEl.classList.remove("open");      docsDrawerEl.classList.remove("open");      activityDrawerEl.classList.remove("open");      notesDrawerEl.classList.remove("open");      ordersDrawerEl.classList.add("open");      drawerOverlayEl.classList.add("show");      fabAutoOpen = true;      updateFabState();      renderOrdersDrawer();    };
const openNotesDrawer = async (p) => {      if (!token()) {        showToast("Login required", p.name);        return;      }      await Promise.all([        loadAdmissionNotes([p.id]),        loadAdmissionPdfs(p)      ]);      const items = buildActivityItems(p);      const notesBody = `        <div class="info-section">
                                                                                                                                                                                                                                                                  <div class="info-label" style="margin-bottom:6px;">Notes / Activity Log</div>
                                                                                                                                                                                                                                                                    <div class="activity-log" style="max-height:none">            ${items.length ? items.map(item => `              <div class="activity-item ${item.noteId ? "note-row" : ""}" ${item.noteId ? `data-note-id="${item.noteId}" data-template-id="${item.templateId || ""}"` : ""}>
                                                                                                                                                                                                                                                                      <span class="note-text">${item.text || ""}</span>                ${item.noteId ? `                  <button class="icon-plain trash" data-note-delete="${item.noteId}" title="Delete" aria-label="Delete">
                                                                                                                                                                                                                                                                        <svg viewBox="0 0 224.65 262.72" aria-hidden="true">
                                                                                                                                                                                                                                                                          <path d="M205.74,105.45v128.84c0,14.18-11.49,25.67-25.67,25.67H43.59c-14.18,0-25.67-11.49-25.67-25.67V105.45"/>
                                                                                                                                                                                                                                                                          <path d="M24.99,41.02h174.66c12.28,0,22.24,9.97,22.24,22.24v13.37c0,5.42-4.4,9.81-9.81,9.81H12.56c-5.42,0-9.81-4.4-9.81-9.81v-13.37c0-12.28,9.97-22.24,22.24-22.24Z"/>
                                                                                                                                                                                                                                                                          <path d="M63.83,39.75v-23.26c0-7.58,6.15-13.73,13.73-13.73h68.53c7.58,0,13.73,6.15,13.73,13.73v23.26"/>
                                                                                                                                                                                                                                                                          <line x1="80.17" y1="125.24" x2="80.17" y2="217.29"/>
                                                                                                                                                                                                                                                                          <line x1="144.48" y1="125.24" x2="144.48" y2="217.29"/>
                                                                                                                                                                                                                                                                        </svg>
                                                                                                                                                                                                                                                                      </button>                ` : ""}              </div>            `).join("") : `<div class="activity-item">No notes or activity yet.</div>`}          </div>
                                                                                                                                                                                                                                                                    </div>      `;      notesDrawerEl.innerHTML = `        <div class="drawer-header">
                                                                                                                                                                                                                                                                    <div>
                                                                                                                                                                                                                                                                      <div class="drawer-title">Notes / Activity Log</div>
                                                                                                                                                                                                                                                                        <div class="drawer-sub">${p.name} - ${p.facilityName}</div>
                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                        <button class="btn btn-primary btn-small" id="btnNotesDone">Done</button>
                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                        <div class="drawer-body">${notesBody}</div>      `;      drawerEl.classList.remove("open");      infoDrawerEl.classList.remove("open");      contactDrawerEl.classList.remove("open");      docsDrawerEl.classList.remove("open");      activityDrawerEl.classList.remove("open");      notesDrawerEl.classList.add("open");      drawerOverlayEl.classList.add("show");      fabAutoOpen = true;      updateFabState();      notesDrawerEl.querySelector("#btnNotesDone")?.addEventListener("click", () => {        notesDrawerEl.classList.remove("open");        if (selectedPatientId) drawerEl.classList.add("open");        updateFabState();      });      notesDrawerEl.querySelector(".activity-log")?.addEventListener("click", (event) => {        const deleteBtn = event.target.closest("[data-note-delete]");        if (deleteBtn) {          event.stopPropagation();          deleteAdmissionNote(p, deleteBtn.dataset.noteDelete);          return;        }        const row = event.target.closest(".activity-item.note-row");        if (!row) return;        const noteId = row.dataset.noteId;        if (!noteId) return;        openNoteDetailsModalForNote(p, noteId);      });    };   const openActivityDrawer = async (p) => {      if (!token()) {        showToast("Login required", p.name);        return;      }      await Promise.all([        loadAdmissionNotes([p.id]),        loadAdmissionFaxLogs(p),        loadAdmissionDetails(p)      ]);      activityApptEditId = null;      const careTeam = (p.careTeam || []);      const appointments = (p.appointments || []).slice();      const careOptions = ['<option value="">Select care team?</option>']        .concat(careTeam.map(c => {          const label = `${c.name || ""}${c.type ? " ? " + c.type : ""}`;          const id = c.care_team_id || c.id;          return `<option value="${id}">${label}</option>`;        }));      const activityBody = `        <div class="info-section">
                                                                                                                                                                                                                                                                          <div class="info-label">Appointments</div>
                                                                                                                                                                                                                                                                            <div class="appt-section">
                                                                                                                                                                                                                                                                              <div class="appt-section-title">Add Appointment</div>
                                                                                                                                                                                                                                                                                <div class="appt-modal-row">
                                                                                                                                                                                                                                                                                  <select id="activityApptsCareTeamSelect" class="doc-input" style="flex:1 1 240px;min-width:200px;">                ${careOptions.join("")}              </select>
                                                                                                                                                                                                                                                                                    <input id="activityApptsDatetime" type="datetime-local" class="doc-input" style="width:220px;min-width:200px;" />
                                                                                                                                                                                                                                                                                    <select id="activityApptsStatus" class="doc-input" style="width:180px;">
                                                                                                                                                                                                                                                                                      <option>New</option>
                                                                                                                                                                                                                                                                                        <option>Attended</option>
                                                                                                                                                                                                                                                                                          <option>Missed</option>
                                                                                                                                                                                                                                                                                            <option>Rescheduled</option>
                                                                                                                                                                                                                                                                                            </select>
                                                                                                                                                                                                                                                                                            <button id="activityApptsAddBtn" class="doc-iconbtn" title="Add appointment">
                                                                                                                                                                                                                                                                                              <svg viewBox="0 0 218.13 218.13" aria-hidden="true">
                                                                                                                                                                                                                                                                                                <g>
                                                                                                                                                                                                                                                                                                  <line class="cls-1" x1="109.07" y1="2.75" x2="109.07" y2="215.38"/>
                                                                                                                                                                                                                                                                                                  <line class="cls-1" x1="215.38" y1="109.07" x2="2.75" y2="109.07"/>
                                                                                                                                                                                                                                                                                                </g>
                                                                                                                                                                                                                                                                                              </svg>
                                                                                                                                                                                                                                                                                            </button>
                                                                                                                                                                                                                                                                                          </div>
                                                                                                                                                                                                                                                                                          <div id="activityApptsEditMeta" class="appt-edit-meta" style="display:none;">
                                                                                                                                                                                                                                                                                            <span>Editing appointment</span>
                                                                                                                                                                                                                                                                                              <button type="button" id="activityApptsCancel">Cancel edit</button>
                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                              <div id="activityApptsMsg" class="doc-msg">
                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                            <div class="appt-modal-table">
                                                                                                                                                                                                                                                                                              <div style="max-height:360px;overflow:auto;">
                                                                                                                                                                                                                                                                                                <table>
                                                                                                                                                                                                                                                                                                  <thead>
                                                                                                                                                                                                                                                                                                    <tr>
                                                                                                                                                                                                                                                                                                      <th style="width:28%;">Date/Time</th>
                                                                                                                                                                                                                                                                                                        <th>Care Team</th>
                                                                                                                                                                                                                                                                                                          <th style="width:18%;">Status</th>
                                                                                                                                                                                                                                                                                                            <th style="width:120px;text-align:right;">Actions</th>
                                                                                                                                                                                                                                                                                                            </tr>
                                                                                                                                                                                                                                                                                                          </thead>
                                                                                                                                                                                                                                                                                                          <tbody id="activityApptsTbody">
                                                                                                                                                                                                                                                                                                          </tbody>
                                                                                                                                                                                                                                                                                                        </table>
                                                                                                                                                                                                                                                                                                      </div>
                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                  </div>      `;      activityDrawerEl.innerHTML = `        <div class="drawer-header">
                                                                                                                                                                                                                                                                                                  <div>
                                                                                                                                                                                                                                                                                                    <div class="drawer-title">Appointments</div>
                                                                                                                                                                                                                                                                                                      <div class="drawer-sub">${p.name} - ${p.facilityName}</div>
                                                                                                                                                                                                                                                                                                      </div>
                                                                                                                                                                                                                                                                                                      <button class="btn btn-primary btn-small" id="btnActivityDone">Done</button>
                                                                                                                                                                                                                                                                                                      </div>
                                                                                                                                                                                                                                                                                                      <div class="drawer-body">${activityBody}</div>      `;      drawerEl.classList.remove("open");      infoDrawerEl.classList.remove("open");      contactDrawerEl.classList.remove("open");      docsDrawerEl.classList.remove("open");      activityDrawerEl.classList.add("open");      drawerOverlayEl.classList.add("show");      fabAutoOpen = true;      updateFabState();      const apptsMsg = activityDrawerEl.querySelector("#activityApptsMsg");      const apptsCareTeamSelect = activityDrawerEl.querySelector("#activityApptsCareTeamSelect");      const apptsDatetime = activityDrawerEl.querySelector("#activityApptsDatetime");      const apptsStatus = activityDrawerEl.querySelector("#activityApptsStatus");      const apptsAddBtn = activityDrawerEl.querySelector("#activityApptsAddBtn");      const apptsTbody = activityDrawerEl.querySelector("#activityApptsTbody");      const apptsEditMeta = activityDrawerEl.querySelector("#activityApptsEditMeta");      const apptsCancel = activityDrawerEl.querySelector("#activityApptsCancel");      const showApptMsg = (text) => {        if (!apptsMsg) return;        if (!text) {          apptsMsg.style.display = "none";          apptsMsg.textContent = "";          return;        }        apptsMsg.style.display = "block";        apptsMsg.textContent = text;      };      const getCareTeamLabel = (appt) => {        const id = String(appt.care_team_id || "");        const match = careTeam.find(ct => String(ct.care_team_id || ct.id || "") === id);        if (match) return `${match.name || ""}${match.type ? " ? " + match.type : ""}`.trim();        return appt.care_team_name || appt.care_team_type || "";      };      const renderApptRows = () => {        if (!apptsTbody) return;        const rows = appointments.slice();        if (!rows.length) {          apptsTbody.innerHTML = `<tr>
                                                                                                                                                                                                                                                                                                        <td colspan="4" style="padding:12px;font-size:12px;color:#667085;">No appointments found.</td>
                                                                                                                                                                                                                                                                                                        </tr>`;          return;        }        apptsTbody.innerHTML = rows.map(r => {          return `            <tr>
                                                                                                                                                                                                                                                                                                        <td>${r.appt_datetime ? formatDateTime(r.appt_datetime) : "-"}</td>
                                                                                                                                                                                                                                                                                                          <td>${getCareTeamLabel(r) || "?"}</td>
                                                                                                                                                                                                                                                                                                            <td>${r.appt_status || ""}</td>
                                                                                                                                                                                                                                                                                                              <td style="text-align:right;">
                                                                                                                                                                                                                                                                                                                <button class="icon-plain" data-appt-edit="${r.id}" title="Edit appointment" aria-label="Edit appointment">
                                                                                                                                                                                                                                                                                                                  <svg viewBox="0 0 237.85 237.86" aria-hidden="true">
                                                                                                                                                                                                                                                                                                                    <line x1="34.25" y1="178.82" x2="57.97" y2="202.54"/>
                                                                                                                                                                                                                                                                                                                    <path d="M68.74,219.9c-3.65,3.65-8.34,6.09-13.43,6.97l-47.25,8.18c-3.09.53-5.78-2.15-5.24-5.24l8.17-47.25c.88-5.09,3.31-9.78,6.97-13.44L173.79,13.27c14.02-14.02,36.76-14.03,50.78,0h0c14.02,14.02,14.03,36.76,0,50.79L68.74,219.9Z"/>
                                                                                                                                                                                                                                                                                                                  </svg>
                                                                                                                                                                                                                                                                                                                </button>
                                                                                                                                                                                                                                                                                                                <button class="icon-plain trash" data-appt-del="${r.id}" title="Delete appointment" aria-label="Delete appointment">
                                                                                                                                                                                                                                                                                                                  <svg viewBox="0 0 224.65 262.72" aria-hidden="true">
                                                                                                                                                                                                                                                                                                                    <path d="M205.74,105.45v128.84c0,14.18-11.49,25.67-25.67,25.67H43.59c-14.18,0-25.67-11.49-25.67-25.67V105.45"/>
                                                                                                                                                                                                                                                                                                                    <path d="M24.99,41.02h174.66c12.28,0,22.24,9.97,22.24,22.24v13.37c0,5.42-4.4,9.81-9.81,9.81H12.56c-5.42,0-9.81-4.4-9.81-9.81v-13.37c0-12.28,9.97-22.24,22.24-22.24Z"/>
                                                                                                                                                                                                                                                                                                                    <path d="M63.83,39.75v-23.26c0-7.58,6.15-13.73,13.73-13.73h68.53c7.58,0,13.73,6.15,13.73,13.73v23.26"/>
                                                                                                                                                                                                                                                                                                                    <line x1="80.17" y1="125.24" x2="80.17" y2="217.29"/>
                                                                                                                                                                                                                                                                                                                    <line x1="144.48" y1="125.24" x2="144.48" y2="217.29"/>
                                                                                                                                                                                                                                                                                                                  </svg>
                                                                                                                                                                                                                                                                                                                </button>
                                                                                                                                                                                                                                                                                                              </td>
                                                                                                                                                                                                                                                                                                            </tr>          `;        }).join("");      };      const clearEdit = () => {        activityApptEditId = null;        if (apptsCareTeamSelect) apptsCareTeamSelect.value = "";        if (apptsDatetime) apptsDatetime.value = "";        if (apptsStatus) apptsStatus.value = "New";        if (apptsEditMeta) apptsEditMeta.style.display = "none";      };      const beginEdit = (appt) => {        activityApptEditId = appt.id;        if (apptsCareTeamSelect) apptsCareTeamSelect.value = String(appt.care_team_id || "");        if (apptsDatetime) apptsDatetime.value = toLocalInputValue(appt.appt_datetime || "");        if (apptsStatus) apptsStatus.value = appt.appt_status || "New";        if (apptsEditMeta) apptsEditMeta.style.display = "flex";      };      apptsAddBtn?.addEventListener("click", async () => {        try {          showApptMsg("");          const apptLocal = apptsDatetime && apptsDatetime.value ? apptsDatetime.value.trim() : "";          if (!apptLocal) throw new Error("Select a date/time.");          const apptIso = new Date(apptLocal).toISOString();          const payload = {            id: activityApptEditId,            admission_id: Number(p.id),            care_team_id: Number(apptsCareTeamSelect && apptsCareTeamSelect.value || 0) || null,            appt_datetime: apptIso,            appt_status: (apptsStatus && apptsStatus.value || "New").trim() || "New"          };          const res = await fetch("/api/sensys/admission-appointments/upsert", {            method: "POST",            headers: { "Content-Type":"application/json", ...authHeaders() },            body: JSON.stringify(payload)          });          if (!res.ok) throw new Error("Appointment not saved.");          await loadAdmissionDetails(p);          clearEdit();          openActivityDrawer(p);        } catch (err) {          showApptMsg(err.message || "Appointment not saved.");        }      });      renderApptRows();      apptsTbody?.querySelectorAll("[data-appt-edit]").forEach(btn => {        btn.addEventListener("click", () => {          const id = Number(btn.getAttribute("data-appt-edit"));          const appt = appointments.find(a => Number(a.id) === id);          if (appt) beginEdit(appt);        });      });      apptsTbody?.querySelectorAll("[data-appt-del]").forEach(btn => {        btn.addEventListener("click", async () => {          const id = Number(btn.getAttribute("data-appt-del"));          try {            showApptMsg("");            await fetch("/api/sensys/admission-appointments/delete", {              method:"POST",              headers: { "Content-Type":"application/json", ...authHeaders() },              body: JSON.stringify({ id })            });            await loadAdmissionDetails(p);            openActivityDrawer(p);          } catch (err) {            showApptMsg(err.message || "Delete failed.");          }        });      });      apptsCancel?.addEventListener("click", () => {        clearEdit();      });      activityDrawerEl.querySelector("#btnActivityDone")?.addEventListener("click", () => {        activityDrawerEl.classList.remove("open");        if (selectedPatientId) drawerEl.classList.add("open");        updateFabState();      });    };const renderQueues = () => {      queueListEl.innerHTML = "";      queues.forEach(queue => {        if (queue.id === "urgent") {          const sep = document.createElement("div");          sep.className = "queue-sep";          queueListEl.appendChild(sep);        }        const count = patients.filter(p => inQueue(p, queue.id)).length;        const item = document.createElement("div");        item.className = `queue-item ${queue.id === "urgent" ? "urgent" : ""} ${activeQueue === queue.id ? "active" : ""}`;        item.innerHTML = `<span>${queue.label}</span>
                                                                                                                                                                                                                                                                                                            <span class="queue-count">${count}</span>`;        item.addEventListener("click", () => {          activeQueue = queue.id;          render();        });        queueListEl.appendChild(item);      });    };    const renderSummary = (list) => {      const total = list.length;      const dueToday = list.filter(p => {        const discharge = new Date(p.dischargeDateTime);        return new Date().toDateString() === discharge.toDateString();      }).length;      const overdue = list.filter(p => new Date(p.dischargeDateTime) < new Date()).length;      summaryStripEl.innerHTML = `        <div class="summary-item">
                                                                                                                                                                                                                                                                                                              <span>In Queue</span>
                                                                                                                                                                                                                                                                                                                <strong>${total}</strong>
                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                <div class="summary-item">
                                                                                                                                                                                                                                                                                                                  <span>Due Today</span>
                                                                                                                                                                                                                                                                                                                    <strong>${dueToday}</strong>
                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                    <div class="summary-item">
                                                                                                                                                                                                                                                                                                                      <span>Overdue</span>
                                                                                                                                                                                                                                                                                                                        <strong>${overdue}</strong>
                                                                                                                                                                                                                                                                                                                        </div>      `;    };    const renderHead = () => {      const hasAttempts = activeQueue === "intake";      if (activeQueue === "allTransitions") {        queueHeadEl.innerHTML = `          <tr>
                                                                                                                                                                                                                                                                                                                        <th>Patient</th>
                                                                                                                                                                                                                                                                                                                          <th style="width:96px;">DC Day</th>
                                                                                                                                                                                                                                                                                                                            <th>Services</th>
                                                                                                                                                                                                                                                                                                                              <th>Tasks</th>
                                                                                                                                                                                                                                                                                                                              </tr>        `;        return;      }      queueHeadEl.innerHTML = `          <tr>
                                                                                                                                                                                                                                                                                                                              <th>Patient</th>
                                                                                                                                                                                                                                                                                                                                <th>DC Day</th>
                                                                                                                                                                                                                                                                                                                                  <th>Services</th>
                                                                                                                                                                                                                                                                                                                                    <th>Tasks</th>            ${activeQueue === "intake" ? "" : "<th>Actions</th>"}            ${hasAttempts ? "<th>Attempts</th>" : ""}          </tr>        `;    };    const taskChips = (p) => {      const chips = [];      if (!isContactComplete(p)) chips.push(`Contact`);      if (p.docsStatus !== "complete") chips.push(`Docs`);      if (p.servicesNeeded.homeHealth && p.referrals.homeHealth.referralStatus === "not_sent") chips.push(`Referral`);      if (p.ordersStatus === "pending") chips.push(`Orders`);      if (chips.length === 0) chips.push("Ready");      return chips.map(c => `<span class="task-chip ${isTaskUrgent(p, c) ? "urgent" : ""}">${c}</span>`).join("");    };    const isTaskUrgent = (p, task) => {      if (task === "Contact" && computeAtRisk(p) && !isContactComplete(p)) return true;      if (task === "Referral") {        const failed = ["homeHealth","dme"].some(s => p.referrals[s] && p.referrals[s].faxStatus === "failed");        const rejected = ["homeHealth","dme"].some(s => p.referrals[s] && p.referrals[s].referralStatus === "rejected");        return failed || rejected;      }      if (task === "Orders" && p.ordersStatus === "pending" && p.ordersNudgeCount >= 2) return true;      if (task === "Docs" && hoursUntilDischarge(p) <= 24) return true;      return false;    };    const getServiceLines = (p) => {      const lines = [];      if (p.hhServiceNames?.length) {        lines.push({ label:"HH", items:p.hhServiceNames });      }      if (p.dmeServiceNames?.length) {        lines.push({ label:"DME", items:p.dmeServiceNames });      }      return lines;    };    const nextActionLabel = (queueId, p) => {      if (queueId === "intake") return "Call patient";      if (queueId === "docs") return "Open docs";      if (queueId === "referrals") return "Send referral";      if (queueId === "awaiting") return p.ordersStatus === "pending" ? "Nudge physician" : "Message agency";      if (queueId === "urgent") return "Review urgent";      if (queueId === "pcp") return "Schedule PCP";      if (queueId === "allTransitions") return p.lockStatus === "ready" ? "Mark complete" : "View";      if (queueId === "ready") return p.lockStatus === "ready" ? "Mark complete" : "View";      return "Open";    };    const renderTable = (list) => {      queueTableEl.innerHTML = "";      emptyStateEl.style.display = list.length ? "none" : "block";      const showAttempts = activeQueue === "intake";      list.forEach(p => {        const serviceLines = getServiceLines(p);        const servicesHtml = serviceLines.length          ? `<div class="service-lines">${serviceLines.map(line => `              <div class="service-line">
                                                                                                                                                                                                                                                                                                                                      <span class="service-label">${line.label}:</span>                ${line.items.map(item => `<span class="service-pill ${item === "O2" ? "danger" : ""}">${item}</span>`).join("")}              </div>            `).join("")}</div>`          : `<div style="font-size:11px;color:var(--muted);font-weight:800">?</div>`;        if (activeQueue === "allTransitions") {          const tr = document.createElement("tr");          const dcDateText = p.dischargeDateTime ? formatDateShort(p.dischargeDateTime) : "?";          const dcDayText = p.dischargeDateTime ? formatDcDay(p.dischargeDateTime) : "?";          tr.innerHTML = `            <td>
                                                                                                                                                                                                                                                                                                                                        <div style="font-weight:900;color:var(--navy)">${p.name}</div>
                                                                                                                                                                                                                                                                                                                                          <div style="font-size:11px;color:var(--muted);font-weight:800">${p.facilityName}</div>
                                                                                                                                                                                                                                                                                                                                            <div style="font-size:11px;color:var(--muted);font-weight:800">DC: ${dcDateText}</div>
                                                                                                                                                                                                                                                                                                                                            </td>
                                                                                                                                                                                                                                                                                                                                            <td>${dcDayText}</td>
                                                                                                                                                                                                                                                                                                                                              <td>${servicesHtml}</td>
                                                                                                                                                                                                                                                                                                                                                <td>
                                                                                                                                                                                                                                                                                                                                                  <div class="task-chips">${taskChips(p)}</div>
                                                                                                                                                                                                                                                                                                                                                  </td>          `;          queueTableEl.appendChild(tr);          tr.addEventListener("click", () => openDrawer(p.id));          return;        }        const actionsHtml = activeQueue === "intake"          ? ""          : `            <div class="row-actions">
                                                                                                                                                                                                                                                                                                                                                  <button class="btn btn-primary btn-small" data-action="next">${nextActionLabel(activeQueue, p)}</button>
                                                                                                                                                                                                                                                                                                                                                  </div>          `;        const attemptsHtml = `          <div style="font-size:11px;color:var(--muted);font-weight:800">            Attempts: ${p.contactAttempts}/2          </div>
                                                                                                                                                                                                                                                                                                                                                  <div style="font-size:11px;color:var(--muted);font-weight:800">            Last Attempt: ${p.lastContactAttemptAt ? formatDateTime(p.lastContactAttemptAt) : "-"}          </div>        `;        const tr = document.createElement("tr");        tr.innerHTML = `          <td>
                                                                                                                                                                                                                                                                                                                                                    <div style="font-weight:900;color:var(--navy)">${p.name}</div>
                                                                                                                                                                                                                                                                                                                                                      <div style="font-size:11px;color:var(--muted);font-weight:800">${p.facilityName}</div>
                                                                                                                                                                                                                                                                                                                                                        <div style="font-size:11px;color:var(--muted);font-weight:800">DC: ${formatDateShort(p.dischargeDateTime)}</div>
                                                                                                                                                                                                                                                                                                                                                        </td>
                                                                                                                                                                                                                                                                                                                                                        <td>${formatDcDay(p.dischargeDateTime)}</td>
                                                                                                                                                                                                                                                                                                                                                          <td>${servicesHtml}</td>
                                                                                                                                                                                                                                                                                                                                                            <td>
                                                                                                                                                                                                                                                                                                                                                              <div class="task-chips">${taskChips(p)}</div>
                                                                                                                                                                                                                                                                                                                                                              </td>          ${activeQueue === "intake" ? "" : `<td>${actionsHtml}</td>`}          ${showAttempts ? `<td>${attemptsHtml}</td>` : ""}        `;        tr.querySelector('[data-action="next"]')?.addEventListener("click", (e) => {          e.stopPropagation();          handleNextAction(activeQueue, p);        });        tr.querySelector('[data-action="vm"]')?.addEventListener("click", (e) => {          e.stopPropagation();          logVm(p);        });        tr.querySelector('[data-action="reached"]')?.addEventListener("click", (e) => {          e.stopPropagation();          markReached(p);        });        tr.addEventListener("click", () => openDrawer(p.id));        queueTableEl.appendChild(tr);      });    };    const handleNextAction = (queueId, p) => {      if (queueId === "intake") {        addActivity(p, "Call initiated");        showToast("Call started", `${p.name} queued for outreach`);        openDrawer(p.id);        return;      }      if (queueId === "docs") {        openDrawer(p.id, "docs");        return;      }      if (queueId === "referrals") {        const service = p.servicesNeeded.homeHealth && p.referrals.homeHealth.referralStatus === "not_sent" ? "homeHealth" : "dme";        requestSendReferral(p.id, service);        return;      }      if (queueId === "awaiting") {        if (p.ordersStatus === "pending") {          nudgePhysician(p);        } else {          messageAgency(p);        }        return;      }      if (queueId === "urgent") {        openDrawer(p.id, "risk");        return;      }      if (queueId === "allTransitions") {        if (p.lockStatus === "ready") {          p.lockStatus = "complete";          addActivity(p, "Marked complete");          showToast("Patient completed", `${p.name} moved to complete`);          render();        } else {          openDrawer(p.id);        }        return;      }      if (queueId === "pcp") {        addActivity(p, "PCP appointment scheduled (mock)");        p.pcpApptNeeded = false;        showToast("PCP scheduled", p.name);        render();        return;      }      if (queueId === "ready") {        if (p.lockStatus === "ready") {          p.lockStatus = "complete";          addActivity(p, "Marked complete");          showToast("Patient completed", `${p.name} moved to complete`);          render();        } else {          openDrawer(p.id);        }      }    };    let fabAutoOpen = false;    const updateFabState = () => {      const anyOpen = drawerEl.classList.contains("open")        || infoDrawerEl.classList.contains("open")        || contactDrawerEl.classList.contains("open")        || docsDrawerEl.classList.contains("open")        || activityDrawerEl.classList.contains("open")        || ordersDrawerEl.classList.contains("open")        || notesDrawerEl.classList.contains("open");      document.body.classList.toggle("drawer-open", anyOpen);      if (fabWrapEl) {        fabWrapEl.classList.toggle("open", anyOpen && fabAutoOpen);      }    };    const openDrawer = (patientId, focus) => {      selectedPatientId = patientId;      drawerOverlayEl.classList.add("show");      drawerEl.classList.add("open");      renderDrawer(focus);      fabAutoOpen = true;      updateFabState();    };    const closeDrawer = () => {      selectedPatientId = null;      drawerOverlayEl.classList.remove("show");      drawerEl.classList.remove("open");      infoDrawerEl.classList.remove("open");      contactDrawerEl.classList.remove("open");      docsDrawerEl.classList.remove("open");      activityDrawerEl.classList.remove("open");      ordersDrawerEl.classList.remove("open");      notesDrawerEl.classList.remove("open");      fabAutoOpen = false;      updateFabState();    };    drawerOverlayEl.addEventListener("click", closeDrawer);    const renderDrawer = (focus) => {      const p = patients.find(pt => pt.id === selectedPatientId);      if (!p) return;      if (token() && !p.pdfsLoaded) {        p.pdfsLoaded = true;        loadAdmissionPdfs(p).then(() => {          renderDrawer(focus);        }).catch(() => {});      }      if (token() && !p.detailsLoaded) {        p.detailsLoaded = true;        loadAdmissionDetails(p).then(() => {          renderDrawer(focus);        }).catch(() => {});      }      if (token() && !p.faxLoaded) {        p.faxLoaded = true;        loadAdmissionFaxLogs(p).then(() => {          renderDrawer(focus);        }).catch(() => {});      }      const hhMethod = getDeliveryMethod(p, "homeHealth");      const dmeMethod = getDeliveryMethod(p, "dme");      const contactLabel = {        not_attempted:"Not attempted",        attempted_vm:`VM Left (${p.contactAttempts}/2)`,        reached:"Reached",        not_reachable_final:"VM Left (2/2)"      }[p.contactStatus] || "Unknown";      const contactMeta = `${contactLabel}${p.lastContactAttemptAt ? ` - ${formatDateTime(p.lastContactAttemptAt)}` : ""}`;      const showCcm = Boolean(p.agencyCcm?.medrina || p.agencyCcm?.evolv);      const ccmLabel = p.agencyCcm?.medrina ? "Medrina CCM" : "CCM Accepted";      const attemptCount = getAttemptNotes(p).length;      const hasReached = getReachedNotes(p).length > 0;      const vmSelected = !hasReached && attemptCount >= 2;      const reachedSelected = hasReached;      const vmDisabled = hasReached || attemptCount >= 2;      const reachedDisabled = !hasReached && attemptCount >= 2;      const pcpCareTeam = getPcpCareTeam(p);      const pcpAppt = getPcpAppointment(p, pcpCareTeam);      const pcpFaxed = Boolean(p.pcpFaxed);      const pcpStatus = pcpAppt        ? (pcpFaxed ? "PCP appt made and Faxed" : "PCP appt made but not faxed")        : "No appt or fax";      const pcpMeta = (() => {        if (!pcpCareTeam) return "No Sensys PCP";        const phoneRaw = (pcpCareTeam.phone1 || "").trim();        const faxRaw = (pcpCareTeam.fax || "").trim();        const phone = phoneRaw ? formatPhoneDisplay(phoneRaw) : "?";        const fax = faxRaw ? formatPhoneDisplay(faxRaw) : "";        const phoneHtml = phoneRaw ? phone : `<a class="link-inline pcp-edit-link" data-ct-edit="phone">[Add #]</a>`;        const faxHtml = faxRaw ? fax : `<a class="link-inline pcp-edit-link" data-ct-edit="fax">[Add #]</a>`;        return `${pcpCareTeam.name} - P:${phoneHtml}  F:${faxHtml}`;      })();      const pcpHasCareTeam = Boolean(pcpCareTeam);      const pcpHasFax = Boolean(pcpCareTeam && (pcpCareTeam.fax || "").trim());      const statusPills = `        <div class="status-pill ${isContactComplete(p) ? "done" : ""}">Contact</div>
                                                                                                                                                                                                                                                                                                                                                              <div class="status-pill ${p.docsStatus === "complete" ? "done" : ""}">Docs</div>
                                                                                                                                                                                                                                                                                                                                                                <div class="status-pill ${["accepted","not_required"].includes(p.referrals.homeHealth.referralStatus) && ["accepted","not_required"].includes(p.referrals.dme.referralStatus) ? "done" : ""}">Referrals</div>
                                                                                                                                                                                                                                                                                                                                                                  <div class="status-pill ${["signed","exception_off_portal","not_required"].includes(p.ordersStatus) ? "done" : p.ordersStatus === "pending" ? "block" : ""}">Orders</div>
                                                                                                                                                                                                                                                                                                                                                                    <div class="status-pill ${p.lockStatus === "ready" || p.lockStatus === "complete" ? "done" : ""}">Ready</div>      `;      drawerEl.innerHTML = `        <div class="drawer-header">
                                                                                                                                                                                                                                                                                                                                                                      <div style="min-width:0">
                                                                                                                                                                                                                                                                                                                                                                        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                                                                                                                                                                                                                                                                                                                                                                          <div class="drawer-title">${p.name}</div>
                                                                                                                                                                                                                                                                                                                                                                            <span class="badge risk-${p.riskLevel}">
                                                                                                                                                                                                                                                                                                                                                                              <span class="dot">
                                                                                                                                                                                                                                                                                                                                                                              </span>${p.riskLevel.toUpperCase()}              </span>
                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                            <div class="drawer-sub">${p.facilityName} - Discharge ${formatDateTime(p.dischargeDateTime)}</div>
                                                                                                                                                                                                                                                                                                                                                                              <div class="status-strip" style="margin-top:8px">${statusPills}</div>
                                                                                                                                                                                                                                                                                                                                                                                <div class="drawer-divider">
                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                                                                                                              <button class="btn-icon" id="btnInfo" aria-label="More Info" title="More Info">
                                                                                                                                                                                                                                                                                                                                                                                <svg viewBox="0 0 262.56 262.56" aria-hidden="true">
                                                                                                                                                                                                                                                                                                                                                                                  <circle cx="131.28" cy="131.28" r="128.53" transform="translate(-54.38 131.28) rotate(-45)"/>
                                                                                                                                                                                                                                                                                                                                                                                  <path d="M98.51,110.75h46.18c6.1,0,10.72,5.5,9.67,11.5l-11.92,68.11c-.31,1.78,1.06,3.41,2.86,3.41h0c6.11,0,11.07,4.95,11.07,11.07h0c0,4.27-2.51,8.18-6.43,9.87-18.31,7.9-50.7,7.58-46.11-29.91l9.71-54.51"/>
                                                                                                                                                                                                                                                                                                                                                                                  <path d="M162.02,65.13c0,12.94-10.43,23.42-23.29,23.42s-23.29-10.49-23.29-23.42,10.43-23.42,23.29-23.42,23.29,10.49,23.29,23.42Z"/>
                                                                                                                                                                                                                                                                                                                                                                                </svg>
                                                                                                                                                                                                                                                                                                                                                                              </button>
                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                            <div class="drawer-body">
                                                                                                                                                                                                                                                                                                                                                                              <div class="card" data-skip-download="true">
                                                                                                                                                                                                                                                                                                                                                                                <div class="card-section">
                                                                                                                                                                                                                                                                                                                                                                                  <div class="card-header">
                                                                                                                                                                                                                                                                                                                                                                                    <div class="card-title">Patient Contact</div>
                                                                                                                                                                                                                                                                                                                                                                                      <div class="card-meta">${contactMeta}</div>
                                                                                                                                                                                                                                                                                                                                                                                      </div>
                                                                                                                                                                                                                                                                                                                                                                                      <div class="card-body">
                                                                                                                                                                                                                                                                                                                                                                                        <div class="contact-meta-grid" style="grid-template-columns: repeat(${showCcm ? 3 : 2}, minmax(0,1fr));">
                                                                                                                                                                                                                                                                                                                                                                                          <div class="contact-meta-col left">
                                                                                                                                                                                                                                                                                                                                                                                            <div class="contact-meta-label">Intro Call</div>
                                                                                                                                                                                                                                                                                                                                                                                              <div class="contact-meta-actions">
                                                                                                                                                                                                                                                                                                                                                                                                <button class="btn-icon vm thumb-down ${vmSelected ? "is-selected" : ""}" id="btnVm" ${vmDisabled ? "disabled" : ""} aria-label="Log Attempt" title="Log Attempt">
                                                                                                                                                                                                                                                                                                                                                                                                  <svg viewBox="0 0 233.12 234.63" aria-hidden="true">
                                                                                                                                                                                                                                                                                                                                                                                                    <path d="M52.97,218.37H12.19c-5.21,0-9.44-4.23-9.44-9.44v-108.68c0-5.21,4.23-9.44,9.44-9.44h38.63c6.97-.01,13.73-2.63,18.73-7.49C90.09,63.36,113.34,16.95,122.19,7.1c3.98-4.7,9.44-4.71,13.07-4.03.07.02.13.03.2.05,25.27,5.85,14.83,46.22,5.35,66.57h0c-3.97,7.7,1.62,16.88,10.28,16.88h54.46c17.1,0,29.06,16.89,23.39,33.02l-33.11,94.15c-3.82,10.87-14.09,18.14-25.61,18.14h-64.57c-11.22,0-22.34-2.03-32.83-6l-19.86-7.51v-126.87"/>
                                                                                                                                                                                                                                                                                                                                                                                                  </svg>
                                                                                                                                                                                                                                                                                                                                                                                                </button>
                                                                                                                                                                                                                                                                                                                                                                                                <button class="btn-icon reached ${reachedSelected ? "is-selected" : ""}" id="btnReached" ${reachedDisabled ? "disabled" : ""} aria-label="Reached">
                                                                                                                                                                                                                                                                                                                                                                                                  <svg viewBox="0 0 233.12 234.63" aria-hidden="true">
                                                                                                                                                                                                                                                                                                                                                                                                    <path d="M52.97,218.37H12.19c-5.21,0-9.44-4.23-9.44-9.44v-108.68c0-5.21,4.23-9.44,9.44-9.44h38.63c6.97-.01,13.73-2.63,18.73-7.49C90.09,63.36,113.34,16.95,122.19,7.1c3.98-4.7,9.44-4.71,13.07-4.03.07.02.13.03.2.05,25.27,5.85,14.83,46.22,5.35,66.57h0c-3.97,7.7,1.62,16.88,10.28,16.88h54.46c17.1,0,29.06,16.89,23.39,33.02l-33.11,94.15c-3.82,10.87-14.09,18.14-25.61,18.14h-64.57c-11.22,0-22.34-2.03-32.83-6l-19.86-7.51v-126.87"/>
                                                                                                                                                                                                                                                                                                                                                                                                  </svg>
                                                                                                                                                                                                                                                                                                                                                                                                </button>
                                                                                                                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                                                                                                                            </div>                  ${showCcm ? `                  <div class="contact-meta-col center">
                                                                                                                                                                                                                                                                                                                                                                                            <div class="contact-meta-label">${ccmLabel}</div>
                                                                                                                                                                                                                                                                                                                                                                                              <div class="contact-meta-actions">
                                                                                                                                                                                                                                                                                                                                                                                                <button class="btn-icon reached" id="btnCcmYes" aria-label="${ccmLabel}" title="${ccmLabel}">
                                                                                                                                                                                                                                                                                                                                                                                                  <svg viewBox="0 0 233.12 234.63" aria-hidden="true">
                                                                                                                                                                                                                                                                                                                                                                                                    <path d="M52.97,218.37H12.19c-5.21,0-9.44-4.23-9.44-9.44v-108.68c0-5.21,4.23-9.44,9.44-9.44h38.63c6.97-.01,13.73-2.63,18.73-7.49C90.09,63.36,113.34,16.95,122.19,7.1c3.98-4.7,9.44-4.71,13.07-4.03.07.02.13.03.2.05,25.27,5.85,14.83,46.22,5.35,66.57h0c-3.97,7.7,1.62,16.88,10.28,16.88h54.46c17.1,0,29.06,16.89,23.39,33.02l-33.11,94.15c-3.82,10.87-14.09,18.14-25.61,18.14h-64.57c-11.22,0-22.34-2.03-32.83-6l-19.86-7.51v-126.87"/>
                                                                                                                                                                                                                                                                                                                                                                                                  </svg>
                                                                                                                                                                                                                                                                                                                                                                                                </button>
                                                                                                                                                                                                                                                                                                                                                                                                <button class="btn-icon danger thumb-down" id="btnCcmNo" aria-label="${ccmLabel} Not Accepted" title="${ccmLabel} Not Accepted">
                                                                                                                                                                                                                                                                                                                                                                                                  <svg viewBox="0 0 233.12 234.63" aria-hidden="true">
                                                                                                                                                                                                                                                                                                                                                                                                    <path d="M52.97,218.37H12.19c-5.21,0-9.44-4.23-9.44-9.44v-108.68c0-5.21,4.23-9.44,9.44-9.44h38.63c6.97-.01,13.73-2.63,18.73-7.49C90.09,63.36,113.34,16.95,122.19,7.1c3.98-4.7,9.44-4.71,13.07-4.03.07.02.13.03.2.05,25.27,5.85,14.83,46.22,5.35,66.57h0c-3.97,7.7,1.62,16.88,10.28,16.88h54.46c17.1,0,29.06,16.89,23.39,33.02l-33.11,94.15c-3.82,10.87-14.09,18.14-25.61,18.14h-64.57c-11.22,0-22.34-2.03-32.83-6l-19.86-7.51v-126.87"/>
                                                                                                                                                                                                                                                                                                                                                                                                  </svg>
                                                                                                                                                                                                                                                                                                                                                                                                </button>
                                                                                                                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                                                                                                                            </div>                  ` : ""}                  <div class="contact-meta-col right">
                                                                                                                                                                                                                                                                                                                                                                                            <div class="contact-meta-label">Open</div>
                                                                                                                                                                                                                                                                                                                                                                                              <div class="contact-meta-actions">
                                                                                                                                                                                                                                                                                                                                                                                                <button class="btn-icon" id="btnContactOpen" aria-label="Open" title="Open">
                                                                                                                                                                                                                                                                                                                                                                                                  <svg viewBox="0 0 251.6 261.78" aria-hidden="true" style="transform: rotate(-90deg);">
                                                                                                                                                                                                                                                                                                                                                                                                    <path d="M168.79,110.02V12.56c0-5.42-4.39-9.81-9.81-9.81h-66.35c-5.42,0-9.81,4.39-9.81,9.81v97.45h-45.05c-5.55,0-8.32,6.7-4.4,10.63l88.43,91.63c2.21,2.21,5.81,2.21,8.02,0l88.43-91.63c3.92-3.92,1.14-10.63-4.4-10.63h-45.05Z"/>
                                                                                                                                                                                                                                                                                                                                                                                                    <path d="M2.75,202.34v41.97c0,8.13,6.59,14.72,14.72,14.72h216.66c8.13,0,14.72-6.59,14.72-14.72v-41.97"/>
                                                                                                                                                                                                                                                                                                                                                                                                  </svg>
                                                                                                                                                                                                                                                                                                                                                                                                </button>
                                                                                                                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                                          </div>
                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                      </div>
                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                    <div class="card" ${focus === "docs" ? "style=\"box-shadow: 0 0 0 3px rgba(168,230,207,.45);\"" : ""}>
                                                                                                                                                                                                                                                                                                                                                                                      <div class="card-section">
                                                                                                                                                                                                                                                                                                                                                                                        <div class="card-header">
                                                                                                                                                                                                                                                                                                                                                                                          <div class="card-title">Documents & Chart Review</div>
                                                                                                                                                                                                                                                                                                                                                                                            <div class="card-meta">${p.docsStatus.replace("_"," ")}</div>
                                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                                            <div class="card-body">
                                                                                                                                                                                                                                                                                                                                                                                              <div class="chip-row">                  ${Object.keys(p.docsChecklist).map(key => {                    const labelMap = DOC_LABELS;                    return `                    <button class="chip-toggle ${p.docsChecklist[key] ? "is-active" : ""}" type="button" data-doc="${key}">                      ${labelMap[key] || key.replace(/([A-Z])/g, " $1")}                    </button>                  `;                  }).join("")}                </div>
                                                                                                                                                                                                                                                                                                                                                                                                <div class="row-actions split">
                                                                                                                                                                                                                                                                                                                                                                                                  <div class="row-actions-left">
                                                                                                                                                                                                                                                                                                                                                                                                    <button class="btn-icon reached" id="btnDocsComplete" aria-label="Mark Complete" title="Mark Complete">
                                                                                                                                                                                                                                                                                                                                                                                                      <svg viewBox="0 0 233.12 234.63" aria-hidden="true">
                                                                                                                                                                                                                                                                                                                                                                                                        <path d="M52.97,218.37H12.19c-5.21,0-9.44-4.23-9.44-9.44v-108.68c0-5.21,4.23-9.44,9.44-9.44h38.63c6.97-.01,13.73-2.63,18.73-7.49C90.09,63.36,113.34,16.95,122.19,7.1c3.98-4.7,9.44-4.71,13.07-4.03.07.02.13.03.2.05,25.27,5.85,14.83,46.22,5.35,66.57h0c-3.97,7.7,1.62,16.88,10.28,16.88h54.46c17.1,0,29.06,16.89,23.39,33.02l-33.11,94.15c-3.82,10.87-14.09,18.14-25.61,18.14h-64.57c-11.22,0-22.34-2.03-32.83-6l-19.86-7.51v-126.87"/>
                                                                                                                                                                                                                                                                                                                                                                                                      </svg>
                                                                                                                                                                                                                                                                                                                                                                                                    </button>
                                                                                                                                                                                                                                                                                                                                                                                                  </div>
                                                                                                                                                                                                                                                                                                                                                                                                  <div class="row-actions-right">
                                                                                                                                                                                                                                                                                                                                                                                                    <button class="btn-icon" id="btnDocsOpen" aria-label="Open" title="Open">
                                                                                                                                                                                                                                                                                                                                                                                                      <svg viewBox="0 0 251.6 261.78" aria-hidden="true" style="transform: rotate(-90deg);">
                                                                                                                                                                                                                                                                                                                                                                                                        <path d="M168.79,110.02V12.56c0-5.42-4.39-9.81-9.81-9.81h-66.35c-5.42,0-9.81,4.39-9.81,9.81v97.45h-45.05c-5.55,0-8.32,6.7-4.4,10.63l88.43,91.63c2.21,2.21,5.81,2.21,8.02,0l88.43-91.63c3.92-3.92,1.14-10.63-4.4-10.63h-45.05Z"/>
                                                                                                                                                                                                                                                                                                                                                                                                        <path d="M2.75,202.34v41.97c0,8.13,6.59,14.72,14.72,14.72h216.66c8.13,0,14.72-6.59,14.72-14.72v-41.97"/>
                                                                                                                                                                                                                                                                                                                                                                                                      </svg>
                                                                                                                                                                                                                                                                                                                                                                                                    </button>
                                                                                                                                                                                                                                                                                                                                                                                                  </div>
                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                                          </div>          ${p.servicesNeeded.homeHealth ? `          <div class="card">
                                                                                                                                                                                                                                                                                                                                                                                          <div class="card-section">
                                                                                                                                                                                                                                                                                                                                                                                            <div class="card-header">
                                                                                                                                                                                                                                                                                                                                                                                              <div class="card-title">Home Health Referral</div>
                                                                                                                                                                                                                                                                                                                                                                                                <div class="card-meta">${p.referrals.homeHealth.referralStatus.replace("_"," ")}</div>
                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                <div class="card-body">
                                                                                                                                                                                                                                                                                                                                                                                                  <div class="card-meta">Delivery: ${hhMethod.toUpperCase()} - Fax: ${p.referrals.homeHealth.faxStatus || "n/a"}</div>
                                                                                                                                                                                                                                                                                                                                                                                                    <div class="row-actions">
                                                                                                                                                                                                                                                                                                                                                                                                      <button class="btn-icon" id="btnSendHH" ${p.referrals.homeHealth.referralStatus !== "not_sent" ? "disabled" : ""} aria-label="Create/Confirm Portal Referral">
                                                                                                                                                                                                                                                                                                                                                                                                        <svg viewBox="0 0 261.49 261.49" aria-hidden="true">
                                                                                                                                                                                                                                                                                                                                                                                                          <line x1="130.74" y1="66.56" x2="130.74" y2="194.92"/>
                                                                                                                                                                                                                                                                                                                                                                                                          <line x1="194.93" y1="130.74" x2="66.56" y2="130.74"/>
                                                                                                                                                                                                                                                                                                                                                                                                          <circle cx="130.74" cy="130.74" r="127.99" transform="translate(-54.16 130.74) rotate(-45)"/>
                                                                                                                                                                                                                                                                                                                                                                                                        </svg>
                                                                                                                                                                                                                                                                                                                                                                                                      </button>
                                                                                                                                                                                                                                                                                                                                                                                                      <button class="btn-icon reached" id="btnAcceptHH" ${p.referrals.homeHealth.referralStatus === "sent" ? "" : "disabled"} aria-label="Mark Accepted">
                                                                                                                                                                                                                                                                                                                                                                                                        <svg viewBox="0 0 233.12 234.63" aria-hidden="true">
                                                                                                                                                                                                                                                                                                                                                                                                          <path d="M52.97,218.37H12.19c-5.21,0-9.44-4.23-9.44-9.44v-108.68c0-5.21,4.23-9.44,9.44-9.44h38.63c6.97-.01,13.73-2.63,18.73-7.49C90.09,63.36,113.34,16.95,122.19,7.1c3.98-4.7,9.44-4.71,13.07-4.03.07.02.13.03.2.05,25.27,5.85,14.83,46.22,5.35,66.57h0c-3.97,7.7,1.62,16.88,10.28,16.88h54.46c17.1,0,29.06,16.89,23.39,33.02l-33.11,94.15c-3.82,10.87-14.09,18.14-25.61,18.14h-64.57c-11.22,0-22.34-2.03-32.83-6l-19.86-7.51v-126.87"/>
                                                                                                                                                                                                                                                                                                                                                                                                        </svg>
                                                                                                                                                                                                                                                                                                                                                                                                      </button>
                                                                                                                                                                                                                                                                                                                                                                                                      <button class="btn-icon info" id="btnNeedsHH" ${p.referrals.homeHealth.referralStatus === "sent" ? "" : "disabled"} aria-label="Needs Info">
                                                                                                                                                                                                                                                                                                                                                                                                        <svg viewBox="0 0 262.56 262.56" aria-hidden="true">
                                                                                                                                                                                                                                                                                                                                                                                                          <circle cx="131.28" cy="131.28" r="128.53" transform="translate(-54.38 131.28) rotate(-45)"/>
                                                                                                                                                                                                                                                                                                                                                                                                          <path d="M98.51,110.75h46.18c6.1,0,10.72,5.5,9.67,11.5l-11.92,68.11c-.31,1.78,1.06,3.41,2.86,3.41h0c6.11,0,11.07,4.95,11.07,11.07h0c0,4.27-2.51,8.18-6.43,9.87-18.31,7.9-50.7,7.58-46.11-29.91l9.71-54.51"/>
                                                                                                                                                                                                                                                                                                                                                                                                          <path d="M162.02,65.13c0,12.94-10.43,23.42-23.29,23.42s-23.29-10.49-23.29-23.42,10.43-23.42,23.29-23.42,23.29,10.49,23.29,23.42Z"/>
                                                                                                                                                                                                                                                                                                                                                                                                        </svg>
                                                                                                                                                                                                                                                                                                                                                                                                      </button>
                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                    <div class="card-expand">
                                                                                                                                                                                                                                                                                                                                                                                                      <button class="btn-icon" aria-label="Open" title="Open" data-download="true">
                                                                                                                                                                                                                                                                                                                                                                                                        <svg viewBox="0 0 251.6 261.78" aria-hidden="true" style="transform: rotate(-90deg);">
                                                                                                                                                                                                                                                                                                                                                                                                          <path d="M168.79,110.02V12.56c0-5.42-4.39-9.81-9.81-9.81h-66.35c-5.42,0-9.81,4.39-9.81,9.81v97.45h-45.05c-5.55,0-8.32,6.7-4.4,10.63l88.43,91.63c2.21,2.21,5.81,2.21,8.02,0l88.43-91.63c3.92-3.92,1.14-10.63-4.4-10.63h-45.05Z"/>
                                                                                                                                                                                                                                                                                                                                                                                                          <path d="M2.75,202.34v41.97c0,8.13,6.59,14.72,14.72,14.72h216.66c8.13,0,14.72-6.59,14.72-14.72v-41.97"/>
                                                                                                                                                                                                                                                                                                                                                                                                        </svg>
                                                                                                                                                                                                                                                                                                                                                                                                      </button>
                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                  </div>
                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                              </div>` : ""}          ${p.servicesNeeded.dme ? `          <div class="card">
                                                                                                                                                                                                                                                                                                                                                                                              <div class="card-section">
                                                                                                                                                                                                                                                                                                                                                                                                <div class="card-header">
                                                                                                                                                                                                                                                                                                                                                                                                  <div class="card-title">DME Referral</div>
                                                                                                                                                                                                                                                                                                                                                                                                    <div class="card-meta">${p.referrals.dme.referralStatus.replace("_"," ")}</div>
                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                    <div class="card-body">
                                                                                                                                                                                                                                                                                                                                                                                                      <div class="card-meta">Delivery: ${dmeMethod.toUpperCase()} - Fax: ${p.referrals.dme.faxStatus || "n/a"}</div>
                                                                                                                                                                                                                                                                                                                                                                                                        <div class="row-actions">
                                                                                                                                                                                                                                                                                                                                                                                                          <button class="btn btn-small" id="btnSendDME" ${p.referrals.dme.referralStatus !== "not_sent" ? "disabled" : ""}>${dmeMethod === "fax" ? "Send Fax" : "Create/Confirm Portal Referral"}</button>
                                                                                                                                                                                                                                                                                                                                                                                                            <button class="btn btn-ghost btn-small" id="btnAcceptDME" ${p.referrals.dme.referralStatus === "sent" ? "" : "disabled"}>Mark Accepted</button>
                                                                                                                                                                                                                                                                                                                                                                                                              <button class="btn btn-ghost btn-small" id="btnNeedsDME" ${p.referrals.dme.referralStatus === "sent" ? "" : "disabled"}>Needs Info</button>
                                                                                                                                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                                                                                                                                              <div class="card-expand">
                                                                                                                                                                                                                                                                                                                                                                                                                <button class="btn-icon" aria-label="Open" title="Open" data-download="true">
                                                                                                                                                                                                                                                                                                                                                                                                                  <svg viewBox="0 0 251.6 261.78" aria-hidden="true" style="transform: rotate(-90deg);">
                                                                                                                                                                                                                                                                                                                                                                                                                    <path d="M168.79,110.02V12.56c0-5.42-4.39-9.81-9.81-9.81h-66.35c-5.42,0-9.81,4.39-9.81,9.81v97.45h-45.05c-5.55,0-8.32,6.7-4.4,10.63l88.43,91.63c2.21,2.21,5.81,2.21,8.02,0l88.43-91.63c3.92-3.92,1.14-10.63-4.4-10.63h-45.05Z"/>
                                                                                                                                                                                                                                                                                                                                                                                                                    <path d="M2.75,202.34v41.97c0,8.13,6.59,14.72,14.72,14.72h216.66c8.13,0,14.72-6.59,14.72-14.72v-41.97"/>
                                                                                                                                                                                                                                                                                                                                                                                                                  </svg>
                                                                                                                                                                                                                                                                                                                                                                                                                </button>
                                                                                                                                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                                                          </div>
                                                                                                                                                                                                                                                                                                                                                                                                        </div>` : ""}          <div class="card">
                                                                                                                                                                                                                                                                                                                                                                                                        <div class="card-section">
                                                                                                                                                                                                                                                                                                                                                                                                          <div class="card-header">
                                                                                                                                                                                                                                                                                                                                                                                                            <div class="card-title">PCP Appointments</div>
                                                                                                                                                                                                                                                                                                                                                                                                              <div class="card-meta">${pcpStatus}</div>
                                                                                                                                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                                                                                                                                              <div class="card-body">
                                                                                                                                                                                                                                                                                                                                                                                                                <div class="card-meta">${pcpMeta}</div>
                                                                                                                                                                                                                                                                                                                                                                                                                  <div class="row-actions">
                                                                                                                                                                                                                                                                                                                                                                                                                    <button class="btn-icon asset-icon reached" id="btnPcpAppt" aria-label="Complete Appt" title="Complete Appt" ${pcpHasCareTeam ? "" : "disabled"}>
                                                                                                                                                                                                                                                                                                                                                                                                                      <svg viewBox="0 0 74.16 76.04" aria-hidden="true">
                                                                                                                                                                                                                                                                                                                                                                                                                        <line x1="26.55" y1="10.08" x2="52.53" y2="10.08" />
                                                                                                                                                                                                                                                                                                                                                                                                                        <path d="M66.54,10.08h2.08c2.3,0,4.16,1.86,4.16,4.16v56.27c0,2.3-1.86,4.16-4.16,4.16H5.54c-2.3,0-4.16-1.86-4.16-4.16V14.23c0-2.3,1.86-4.16,4.16-4.16h7.14" />
                                                                                                                                                                                                                                                                                                                                                                                                                        <line x1="1.39" y1="26.73" x2="72.78" y2="26.73" />
                                                                                                                                                                                                                                                                                                                                                                                                                        <line x1="32.51" y1="50.58" x2="41.55" y2="50.58" />
                                                                                                                                                                                                                                                                                                                                                                                                                        <line x1="32.51" y1="63.68" x2="41.55" y2="63.68" />
                                                                                                                                                                                                                                                                                                                                                                                                                        <line x1="12.09" y1="63.68" x2="21.13" y2="63.68" />
                                                                                                                                                                                                                                                                                                                                                                                                                        <line x1="52.93" y1="37.47" x2="61.97" y2="37.47" />
                                                                                                                                                                                                                                                                                                                                                                                                                        <line x1="32.51" y1="37.47" x2="41.55" y2="37.47" />
                                                                                                                                                                                                                                                                                                                                                                                                                        <line x1="12.09" y1="37.47" x2="21.13" y2="37.47" />
                                                                                                                                                                                                                                                                                                                                                                                                                        <line x1="52.93" y1="50.58" x2="61.97" y2="50.58" />
                                                                                                                                                                                                                                                                                                                                                                                                                        <line x1="12.09" y1="50.58" x2="21.13" y2="50.58" />
                                                                                                                                                                                                                                                                                                                                                                                                                        <rect x="13.22" y="1.39" width="7.89" height="17.38" rx="3.94" ry="3.94" />
                                                                                                                                                                                                                                                                                                                                                                                                                        <path d="M57,18.77h0c-2.18,0-3.94-1.77-3.94-3.94V5.33c0-2.18,1.77-3.94,3.94-3.94h0c2.18,0,3.94,1.77,3.94,3.94v9.5c0,2.18-1.77,3.94-3.94,3.94Z" />
                                                                                                                                                                                                                                                                                                                                                                                                                      </svg>
                                                                                                                                                                                                                                                                                                                                                                                                                    </button>
                                                                                                                                                                                                                                                                                                                                                                                                                    <button class="btn-icon asset-icon reached" id="btnPcpFax" aria-label="Fax PCP" title="Fax PCP" ${pcpHasFax ? "" : "disabled"}>
                                                                                                                                                                                                                                                                                                                                                                                                                      <svg viewBox="0 0 73.17 77.01" aria-hidden="true">
                                                                                                                                                                                                                                                                                                                                                                                                                        <path d="M16.18,61.52H1.39v-30.43c0-2.96,2.4-5.37,5.37-5.37h59.66c2.96,0,5.37,2.4,5.37,5.37v30.43h-14.8" />
                                                                                                                                                                                                                                                                                                                                                                                                                        <polyline points="16.18 25.73 16.18 1.39 44.31 1.39 56.99 14.52 56.99 25.73" />
                                                                                                                                                                                                                                                                                                                                                                                                                        <polyline points="56.99 43.62 56.99 75.63 16.18 75.63 16.18 43.62" />
                                                                                                                                                                                                                                                                                                                                                                                                                        <line x1="10.02" y1="43.39" x2="63.92" y2="43.39" />
                                                                                                                                                                                                                                                                                                                                                                                                                        <line x1="27.43" y1="53.95" x2="45.89" y2="53.95" />
                                                                                                                                                                                                                                                                                                                                                                                                                        <line x1="27.43" y1="65.03" x2="45.89" y2="65.03" />
                                                                                                                                                                                                                                                                                                                                                                                                                      </svg>
                                                                                                                                                                                                                                                                                                                                                                                                                    </button>
                                                                                                                                                                                                                                                                                                                                                                                                                  </div>
                                                                                                                                                                                                                                                                                                                                                                                                                  <div class="card-expand">
                                                                                                                                                                                                                                                                                                                                                                                                                    <button class="btn-icon" id="btnPcpApptOpen" aria-label="Open" title="Open" data-download="true">
                                                                                                                                                                                                                                                                                                                                                                                                                      <svg viewBox="0 0 251.6 261.78" aria-hidden="true" style="transform: rotate(-90deg);">
                                                                                                                                                                                                                                                                                                                                                                                                                        <path d="M168.79,110.02V12.56c0-5.42-4.39-9.81-9.81-9.81h-66.35c-5.42,0-9.81,4.39-9.81,9.81v97.45h-45.05c-5.55,0-8.32,6.7-4.4,10.63l88.43,91.63c2.21,2.21,5.81,2.21,8.02,0l88.43-91.63c3.92-3.92,1.14-10.63-4.4-10.63h-45.05Z"/>
                                                                                                                                                                                                                                                                                                                                                                                                                        <path d="M2.75,202.34v41.97c0,8.13,6.59,14.72,14.72,14.72h216.66c8.13,0,14.72-6.59,14.72-14.72v-41.97"/>
                                                                                                                                                                                                                                                                                                                                                                                                                      </svg>
                                                                                                                                                                                                                                                                                                                                                                                                                    </button>
                                                                                                                                                                                                                                                                                                                                                                                                                  </div>
                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                                                            <div class="card">
                                                                                                                                                                                                                                                                                                                                                                                                              <div class="card-section">
                                                                                                                                                                                                                                                                                                                                                                                                                <div class="card-header">
                                                                                                                                                                                                                                                                                                                                                                                                                  <div class="card-title">Physician Orders</div>
                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="card-meta">${formatOrdersStatus(p)}</div>
                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="card-body">
                                                                                                                                                                                                                                                                                                                                                                                                                      <div class="orders-attending-list">${renderOrdersCareTeam(p)}</div>
                                                                                                                                                                                                                                                                                                                                                                                                                        <div class="card-meta">Last nudge: ${p.ordersLastNudgeAt ? formatDateTime(p.ordersLastNudgeAt) : "-"} - Nudge count: ${p.ordersNudgeCount}</div>
                                                                                                                                                                                                                                                                                                                                                                                                                          <div class="row-actions">
                                                                                                                                                                                                                                                                                                                                                                                                                            <button class="btn-icon" id="btnNudge" aria-label="Nudge Physician" title="Nudge Physician">
                                                                                                                                                                                                                                                                                                                                                                                                                              <svg viewBox="0 0 261.34 256.24" aria-hidden="true">
                                                                                                                                                                                                                                                                                                                                                                                                                                <path d="M130.67,2.75C60.02,2.75,2.75,57.94,2.75,126.03c0,28.22,9.86,54.21,26.42,74.98,1.76,2.21,2.46,5.09,1.93,7.87l-6.2,32.97c-1.44,7.67,6.22,13.88,13.43,10.87l33.21-13.87c2.41-1.01,5.14-1.03,7.54,0,15.78,6.72,33.22,10.47,51.58,10.47,70.65,0,127.92-55.19,127.92-123.28S201.32,2.75,130.67,2.75Z"/>
                                                                                                                                                                                                                                                                                                                                                                                                                                <circle cx="130.67" cy="126.38" r="15.48" transform="translate(-22.35 224.52) rotate(-76.72)"/>
                                                                                                                                                                                                                                                                                                                                                                                                                                <circle cx="71.83" cy="126.38" r="15.48" transform="translate(-64.42 177.03) rotate(-80.78)"/>
                                                                                                                                                                                                                                                                                                                                                                                                                                <circle cx="189.52" cy="126.38" r="15.48" transform="translate(-23.97 46.92) rotate(-13.28)"/>
                                                                                                                                                                                                                                                                                                                                                                                                                              </svg>
                                                                                                                                                                                                                                                                                                                                                                                                                            </button>
                                                                                                                                                                                                                                                                                                                                                                                                                            <button class="btn-icon reached" id="btnSigned" aria-label="Mark Complete" title="Mark Complete">                              <svg viewBox="0 0 233.12 234.63" aria-hidden="true">                                <path d="M52.97,218.37H12.19c-5.21,0-9.44-4.23-9.44-9.44v-108.68c0-5.21,4.23-9.44,9.44-9.44h38.63c6.97-.01,13.73-2.63,18.73-7.49C90.09,63.36,113.34,16.95,122.19,7.1c3.98-4.7,9.44-4.71,13.07-4.03.07.02.13.03.2.05,25.27,5.85,14.83,46.22,5.35,66.57h0c-3.97,7.7,1.62,16.88,10.28,16.88h54.46c17.1,0,29.06,16.89,23.39,33.02l-33.11,94.15c-3.82,10.87-14.09,18.14-25.61,18.14h-64.57c-11.22,0-22.34-2.03-32.83-6l-19.86-7.51v-126.87"/>                              </svg>                            </button>
                                                                                                                                                                                                                                                                                                                                                                                                                          </div>
                                                                                                                                                                                                                                                                                                                                                                                                                          <div class="card-expand"><button class="btn-icon" id="btnOrdersOpen" aria-label="Open" title="Open" data-download="true">                              <svg viewBox="0 0 251.6 261.78" aria-hidden="true" style="transform: rotate(-90deg);">                                <path d="M168.79,110.02V12.56c0-5.42-4.39-9.81-9.81-9.81h-66.35c-5.42,0-9.81,4.39-9.81,9.81v97.45h-45.05c-5.55,0-8.32,6.7-4.4,10.63l88.43,91.63c2.21,2.21,5.81,2.21,8.02,0l88.43-91.63c3.92-3.92,1.14-10.63-4.4-10.63h-45.05Z"/>                                <path d="M2.75,202.34v41.97c0,8.13,6.59,14.72,14.72,14.72h216.66c8.13,0,14.72-6.59,14.72-14.72v-41.97"/>                              </svg>                            </button></div>
                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                      </div>
                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="card">
                                                                                                                                                                                                                                                                                                                                                                                                                      <div class="card-section">
                                                                                                                                                                                                                                                                                                                                                                                                                        <div class="card-header">
                                                                                                                                                                                                                                                                                                                                                                                                                          <div class="card-title">Notes / Activity Log <span style="font-size:11px;color:var(--muted);font-weight:800">(${(() => {                  const docItems = (p.pdfs || [])                    .filter(r => r && r.doc_type && Object.values(DOC_LABELS).includes(r.doc_type))                    .length;                  return (p.activityLog || []).length + docItems;                })()})</span>
                                                                                                                                                                                                                                                                                                                                                                                                                          </div>
                                                                                                                                                                                                                                                                                                                                                                                                                          <button class="btn-icon" id="btnActivityOpen" aria-label="Open" title="Open" data-download="true">
                                                                                                                                                                                                                                                                                                                                                                                                                            <svg viewBox="0 0 251.6 261.78" aria-hidden="true" style="transform: rotate(-90deg);">
                                                                                                                                                                                                                                                                                                                                                                                                                              <path d="M168.79,110.02V12.56c0-5.42-4.39-9.81-9.81-9.81h-66.35c-5.42,0-9.81,4.39-9.81,9.81v97.45h-45.05c-5.55,0-8.32,6.7-4.4,10.63l88.43,91.63c2.21,2.21,5.81,2.21,8.02,0l88.43-91.63c3.92-3.92,1.14-10.63-4.4-10.63h-45.05Z"/>
                                                                                                                                                                                                                                                                                                                                                                                                                              <path d="M2.75,202.34v41.97c0,8.13,6.59,14.72,14.72,14.72h216.66c8.13,0,14.72-6.59,14.72-14.72v-41.97"/>
                                                                                                                                                                                                                                                                                                                                                                                                                            </svg>
                                                                                                                                                                                                                                                                                                                                                                                                                          </button>
                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                        <div class="card-body">
                                                                                                                                                                                                                                                                                                                                                                                                                          <div class="activity-log">                  ${(() => {                    const activity = (p.activityLog || []).map(item => ({                      text: item.text || item,                      createdAt: item && item.createdAt ? item.createdAt : null,                      noteId: item && item.noteId ? item.noteId : null,                      templateId: item && item.templateId ? item.templateId : null                    }));                    const docItems = (p.pdfs || [])                      .filter(r => r && r.doc_type && Object.values(DOC_LABELS).includes(r.doc_type))                      .map(r => {                        const stamp = r.created_at ? formatStamp(new Date(r.created_at)) : formatStamp(new Date());                        const name = r.original_filename || r.filename || "Document";                        return {                          text: `${stamp} - ${r.doc_type} - ${name}`,                          createdAt: r.created_at || null,                          noteId: null,                          templateId: null                        };                      });                    const items = activity.concat(docItems);                    items.sort((a, b) => {                      const aTs = a && a.createdAt ? Date.parse(a.createdAt) : NaN;                      const bTs = b && b.createdAt ? Date.parse(b.createdAt) : NaN;                      if (!Number.isNaN(aTs) && !Number.isNaN(bTs)) return bTs - aTs;                      if (!Number.isNaN(aTs) && Number.isNaN(bTs)) return -1;                      if (Number.isNaN(aTs) && !Number.isNaN(bTs)) return 1;                      return 0;                    });                    return items.slice(0,4).map(item => `                    <div class="activity-item ${item.noteId ? "note-row" : ""}" ${item.noteId ? `data-note-id="${item.noteId}" data-template-id="${item.templateId}"` : ""}>
                                                                                                                                                                                                                                                                                                                                                                                                                            <span class="note-text">${item.text || ""}</span>
                                                                                                                                                                                                                                                                                                                                                                                                                            </div>                  `).join("");                  })()}                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                          </div>
                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                      </div>
                                                                                                                                                                                                                                                                                                                                                                                                                    </div>      `;      bindQuickNoteButton(        drawerEl.querySelector("#btnVm"),        () => logVm(p),        () => logVm(p, { openDetails: true, showToastAction: false })      );      bindQuickNoteButton(        drawerEl.querySelector("#btnReached"),        () => markReached(p),        () => markReached(p, { openDetails: true, showToastAction: false })      );      bindQuickNoteButton(        drawerEl.querySelector("#btnCcmYes"),        () => logCcmStatus(p, true),        () => logCcmStatus(p, true, { openDetails: true, showToastAction: false })      );      bindQuickNoteButton(        drawerEl.querySelector("#btnCcmNo"),        () => logCcmStatus(p, false),        () => logCcmStatus(p, false, { openDetails: true, showToastAction: false })      );      drawerEl.querySelectorAll('[data-doc]').forEach(el => {        el.addEventListener("click", (e) => {          const key = e.currentTarget.dataset.doc;          triggerDocUpload(p, key);        });      });        drawerEl.querySelector("#btnDocsComplete")?.addEventListener("click", () => markDocsComplete(p));        drawerEl.querySelector("#btnDocsOpen")?.addEventListener("click", () => openDocsDrawer(p));        drawerEl.querySelector("#btnActivityOpen")?.addEventListener("click", () => openNotesDrawer(p));        drawerEl.querySelector("#btnPcpApptOpen")?.addEventListener("click", () => openActivityDrawer(p));        drawerEl.querySelector("#btnPcpAppt")?.addEventListener("click", () => openPcpApptModal(p));        drawerEl.querySelector("#btnPcpFax")?.addEventListener("click", () => faxPcpRecords(p));        drawerEl.querySelector("#btnSendHH")?.addEventListener("click", () => requestSendReferral(p.id, "homeHealth"));      drawerEl.querySelector("#btnSendDME")?.addEventListener("click", () => requestSendReferral(p.id, "dme"));      drawerEl.querySelector("#btnAcceptHH")?.addEventListener("click", () => markReferral(p, "homeHealth", "accepted"));      drawerEl.querySelector("#btnNeedsHH")?.addEventListener("click", () => markReferral(p, "homeHealth", "needs_info"));      drawerEl.querySelector("#btnAcceptDME")?.addEventListener("click", () => markReferral(p, "dme", "accepted"));      drawerEl.querySelector("#btnNeedsDME")?.addEventListener("click", () => markReferral(p, "dme", "needs_info"));            drawerEl.querySelector("#btnOrdersOpen")?.addEventListener("click", () => openOrdersDrawer(p));      drawerEl.querySelector("#btnInfo")?.addEventListener("click", () => openInfoDrawer(p));      drawerEl.querySelector("#btnContactOpen")?.addEventListener("click", () => openContactDrawer(p));        drawerEl.querySelector(".activity-log")?.addEventListener("click", (event) => {          const row = event.target.closest(".activity-item.note-row");          if (!row) return;          const noteId = row.dataset.noteId;          if (!noteId) return;          openNoteDetailsModalForNote(p, noteId);        });        drawerEl.querySelectorAll(".pcp-edit-link").forEach(link => {          link.addEventListener("click", (e) => {            e.preventDefault();            openCareTeamEditModal(p);          });        });      const downloadBtnHtml = `        <button class="btn-icon" aria-label="Open" title="Open" data-download="true">
                                                                                                                                                                                                                                                                                                                                                                                                                    <svg viewBox="0 0 251.6 261.78" aria-hidden="true" style="transform: rotate(-90deg);">
                                                                                                                                                                                                                                                                                                                                                                                                                      <path d="M168.79,110.02V12.56c0-5.42-4.39-9.81-9.81-9.81h-66.35c-5.42,0-9.81,4.39-9.81,9.81v97.45h-45.05c-5.55,0-8.32,6.7-4.4,10.63l88.43,91.63c2.21,2.21,5.81,2.21,8.02,0l88.43-91.63c3.92-3.92,1.14-10.63-4.4-10.63h-45.05Z"/>
                                                                                                                                                                                                                                                                                                                                                                                                                      <path d="M2.75,202.34v41.97c0,8.13,6.59,14.72,14.72,14.72h216.66c8.13,0,14.72-6.59,14.72-14.72v-41.97"/>
                                                                                                                                                                                                                                                                                                                                                                                                                    </svg>
                                                                                                                                                                                                                                                                                                                                                                                                                  </button>      `;      drawerEl.querySelectorAll(".card-expand").forEach(el => {        if (el.closest(".card")?.dataset.skipDownload === "true") return;        if (!el.querySelector("[data-download]")) {          el.insertAdjacentHTML("beforeend", downloadBtnHtml);        }      });      drawerEl.querySelectorAll(".card-body").forEach(body => {        const row = body.querySelector(".row-actions");        const expand = body.querySelector(".card-expand");        if (!row || !expand) return;        if (row.querySelector(".row-actions-left")) return;        row.classList.add("split");        const left = document.createElement("div");        left.className = "row-actions-left";        while (row.firstChild) left.appendChild(row.firstChild);        const right = document.createElement("div");        right.className = "row-actions-right";        while (expand.firstChild) right.appendChild(expand.firstChild);        row.appendChild(left);        row.appendChild(right);        expand.remove();      });    };    const docsMinimumComplete = (p) => p.docsChecklist.faceSheet && p.docsChecklist.orders;    const logVm = async (p, opts = {}) => {      const { openDetails = false, showToastAction = true } = opts;      if (p.contactAttempts >= 2 || p.contactStatus === "reached") return;      const nowIso = new Date().toISOString();      if (!token()) {        p.contactAttempts += 1;        p.contactStatus = p.contactAttempts >= 2 ? "not_reachable_final" : "attempted_vm";        p.lastContactAttemptAt = nowIso;        p.nextContactDueAt = null;        addActivity(p, `Left voicemail (Attempt ${p.contactAttempts})`);        showToast("VM logged", `Attempt ${p.contactAttempts} for ${p.name}`);        render();        return;      }      try {        const payload = {          admission_id: Number(p.id),          note_name: REACHED_NOTE_NAME,          template_id: REACHED_TEMPLATE_ID,          workspace_key: WORKSPACE_KEY,          response1: CALL_VM_ANSWER,          answer_field_key: REACHED_FIELD_KEY,          answer_value_text: CALL_VM_ANSWER        };        const res = await fetch("/api/sensys/admission-notes/upsert", {          method: "POST",          headers: { ...authHeaders(), "Content-Type": "application/json" },          body: JSON.stringify(payload)        });        if (!res.ok) throw new Error("Failed to log attempt");        await loadAdmissionNotes([p.id]);        if (openDetails) {          openNoteDetailsModal(p, REACHED_TEMPLATE_ID, CALL_VM_ANSWER);        } else if (showToastAction) {          showToast("VM logged", `Attempt ${p.contactAttempts} for ${p.name}`, {            label: "Complete details",            onClick: () => openNoteDetailsModal(p, REACHED_TEMPLATE_ID, CALL_VM_ANSWER)          });        } else {          showToast("VM logged", `Attempt ${p.contactAttempts} for ${p.name}`);        }        render();        refreshOpenDrawers(p);      } catch (err) {        console.warn("[Evolv SNF] attempt log failed:", err);        showToast("Attempt failed", p.name);      }    };    const markReached = async (p, opts = {}) => {      const { openDetails = false, showToastAction = true } = opts;      const nowIso = new Date().toISOString();      if (p.contactStatus === "reached") return;      if (!token()) {        p.contactStatus = "reached";        p.lastContactAttemptAt = nowIso;        p.nextContactDueAt = null;        addActivity(p, `Reached patient ? ${REACHED_ANSWER}`);        showToast("Patient reached", p.name);        render();        return;      }      try {        const payload = {          admission_id: Number(p.id),          note_name: REACHED_NOTE_NAME,          template_id: REACHED_TEMPLATE_ID,          workspace_key: WORKSPACE_KEY,          response1: REACHED_ANSWER,          answer_field_key: REACHED_FIELD_KEY,          answer_value_text: REACHED_ANSWER        };        const res = await fetch("/api/sensys/admission-notes/upsert", {          method: "POST",          headers: { ...authHeaders(), "Content-Type": "application/json" },          body: JSON.stringify(payload)        });        if (!res.ok) throw new Error("Failed to log reached note");        await loadAdmissionNotes([p.id]);        if (openDetails) {          openNoteDetailsModal(p, REACHED_TEMPLATE_ID, REACHED_ANSWER);        } else if (showToastAction) {          showToast("Patient reached", p.name, {            label: "Complete details",            onClick: () => openNoteDetailsModal(p, REACHED_TEMPLATE_ID, REACHED_ANSWER)          });        } else {          showToast("Patient reached", p.name);        }        render();        refreshOpenDrawers(p);      } catch (err) {        console.warn("[Evolv SNF] reached log failed:", err);        showToast("Reached log failed", p.name);      }    };    const logCcmStatus = async (p, accepted, opts = {}) => {      const { openDetails = false, showToastAction = true } = opts;      const answer = accepted ? CCM_ACCEPTED_ANSWER : CCM_DECLINED_ANSWER;      if (!token()) {        addActivity(p, `CCM ${accepted ? "accepted" : "declined"} ? ${answer}`);        showToast(`CCM ${accepted ? "accepted" : "declined"}`, p.name);        render();        return;      }      try {        const payload = {          admission_id: Number(p.id),          note_name: CCM_NOTE_NAME,          template_id: CCM_TEMPLATE_ID,          workspace_key: WORKSPACE_KEY,          response1: answer,          answer_field_key: CCM_FIELD_KEY,          answer_value_text: answer        };        const res = await fetch("/api/sensys/admission-notes/upsert", {          method: "POST",          headers: { ...authHeaders(), "Content-Type": "application/json" },          body: JSON.stringify(payload)        });        if (!res.ok) throw new Error("Failed to log CCM status");        await loadAdmissionNotes([p.id]);        if (openDetails) {          openNoteDetailsModal(p, CCM_TEMPLATE_ID, answer);        } else if (showToastAction) {          showToast(`CCM ${accepted ? "accepted" : "declined"}`, p.name, {            label: "Complete details",            onClick: () => openNoteDetailsModal(p, CCM_TEMPLATE_ID, answer)          });        } else {          showToast(`CCM ${accepted ? "accepted" : "declined"}`, p.name);        }        render();        refreshOpenDrawers(p);      } catch (err) {        console.warn("[Evolv SNF] CCM log failed:", err);        showToast("CCM log failed", p.name);      }    };    const deleteAdmissionNote = async (p, noteId) => {      if (!noteId) return;      if (!token()) {        p.admissionNotes = (p.admissionNotes || []).filter(n => Number(n.id) !== Number(noteId));        applyAttemptNotes(p);        p.activityLog = buildActivityLog(p);        showToast("Note removed", p.name);        render();        refreshOpenDrawers(p);        return;      }      try {        const res = await fetch("/api/sensys/admission-notes/delete", {          method: "POST",          headers: { ...authHeaders(), "Content-Type": "application/json" },          body: JSON.stringify({ id: Number(noteId) })        });        if (!res.ok) throw new Error("Failed to delete note");        await loadAdmissionNotes([p.id]);        showToast("Note removed", p.name);        render();        refreshOpenDrawers(p);      } catch (err) {        console.warn("[Evolv SNF] note delete failed:", err);        showToast("Note delete failed", p.name);      }    };    const resetContact = (p) => {      p.contactStatus = "not_attempted";      p.contactAttempts = 0;      p.lastContactAttemptAt = null;      p.nextContactDueAt = null;      addActivity(p, "Contact reset");      showToast("Contact reset", p.name);      render();    };    const saveDocsUpdate = async (p, patch) => {      if (!token()) return;      const payload = { admission_id: Number(p.id), ...patch };      const res = await fetch("/api/sensys/admission-docs/update", {        method: "POST",        headers: { ...authHeaders(), "Content-Type": "application/json" },        body: JSON.stringify(payload)      });      if (!res.ok) throw new Error("Failed to update docs");    };    const computeDocsStatus = (p) => {      const anyChecked = Object.values(p.docsChecklist || {}).some(Boolean);      if (p.docsStatus === "complete" && !anyChecked) return "not_started";      if (p.docsStatus === "complete" && anyChecked) return "in_progress";      return anyChecked ? "in_progress" : "not_started";    };    const toggleDoc = async (p, docKey) => {      p.docsChecklist[docKey] = !p.docsChecklist[docKey];      if (p.docsStatus === "complete") p.docsStatus = "in_progress";      else p.docsStatus = computeDocsStatus(p);      const keyMap = {        faceSheet: "docs_facesheet",        orders: "docs_dc_summary",        clinicals: "docs_physicians_added"      };      try {        if (token()) {          await saveDocsUpdate(p, {            [keyMap[docKey]]: p.docsChecklist[docKey] ? 1 : 0,            docs_status: p.docsStatus          });        }        addActivity(p, `Docs updated: ${docKey}`);      } catch (err) {        console.warn("[Evolv SNF] docs update failed:", err);        showToast("Docs update failed", p.name);      }      renderDrawer();    };    const generatePacket = (p) => {      if (!docsMinimumComplete(p)) return;      p.packetGenerated = true;      addActivity(p, "Packet generated");      showToast("Packet generated", p.name);      render();    };    const markDocsComplete = async (p) => {      const missing = Object.keys(p.docsChecklist).filter(key => !p.docsChecklist[key]);      if (missing.length) {        docsModalBodyEl.innerHTML = `          <p style="margin:0 0 10px;font-weight:800;color:var(--navy)">Complete these items first:</p>
                                                                                                                                                                                                                                                                                                                                                                                                                  <ul style="margin:0 0 10px 18px;font-size:12px;color:#1f2937;font-weight:700">            ${missing.map(item => `<li>${item}</li>`).join("")}          </ul>        `;        openModal(docsModalEl);        return;      }      p.docsStatus = "complete";      p.packetGenerated = true;      try {        if (token()) {          await saveDocsUpdate(p, {            docs_status: "complete",            docs_packet_generated: 1          });        }        addActivity(p, "Docs marked complete");        showToast("Docs marked complete", p.name);      } catch (err) {        console.warn("[Evolv SNF] docs complete failed:", err);        showToast("Docs complete failed", p.name);      }      render();    };    const requestSendReferral = (patientId, service) => {      const p = patients.find(pt => pt.id === patientId);      if (!p) return;      pendingReferral = { patientId, service };      if (p.contactStatus !== "reached") {        openModal(warningModalEl);      } else {        openSendModal(p, service);      }    };    const openSendModal = (p, service) => {      const method = getDeliveryMethod(p, service);      const serviceName = service === "homeHealth" ? "Home Health" : "DME";      simulateFailEl.checked = false;      faxModalTitleEl.textContent = `${method === "fax" ? "Send Fax" : "Confirm Portal Referral"} ? ${serviceName}`;      faxModalBodyEl.innerHTML = `        <p style="margin:0 0 10px;font-weight:800;color:var(--navy)">          ${method === "fax" ? "Confirm sending discharge packet + orders." : "Confirm portal referral submission."}        </p>
                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="card-meta" style="font-size:12px;color:var(--muted);font-weight:800">          Patient: ${p.name} - ${p.facilityName}        </div>      `;      if (method !== "fax") simulateFailEl.parentElement.style.display = "none";      else simulateFailEl.parentElement.style.display = "block";      openModal(faxModalEl);    };    const openPatientEditModal = (p) => {      const details = p.patientDetails || {};      editingPatientId = p.id;      epFirstNameEl.value = details.firstName || "";      epLastNameEl.value = details.lastName || "";      epDobEl.value = details.dob || p.dob || "";      epGenderEl.value = details.gender || "";      epPhone1El.value = details.phone1 || p.phoneNumbers?.mobile || "";      epPhone2El.value = details.phone2 || p.phoneNumbers?.home || "";      epEmailEl.value = details.email || "";      epEmail2El.value = details.email2 || "";      epAddress1El.value = details.address1 || p.address?.line1 || "";      epAddress2El.value = details.address2 || p.address?.line2 || "";      epCityEl.value = details.city || p.address?.city || "";      epStateEl.value = details.state || p.address?.state || "";      epZipEl.value = details.zip || p.address?.zip || "";      epInsuranceName1El.value = details.insuranceName1 || "";      epInsuranceNumber1El.value = details.insuranceNumber1 || "";      epInsuranceName2El.value = details.insuranceName2 || "";      epInsuranceNumber2El.value = details.insuranceNumber2 || "";      epNotes1El.value = details.notes1 || "";      epNotes2El.value = details.notes2 || "";      epExternalPatientIdEl.value = details.externalPatientId || "";      epMrnEl.value = details.mrn || p.mrn || "";      epSourceEl.value = details.source || "manual";      epActiveEl.value = details.active || "1";      openModal(patientEditModalEl);    };    const completeReferralSend = (p, service) => {      const method = getDeliveryMethod(p, service);      const ref = p.referrals[service];      ref.lastSentAt = new Date().toISOString();      ref.referralStatus = "sent";      if (method === "fax") {        if (simulateFailEl.checked) {          ref.faxStatus = "failed";          addActivity(p, `Fax failed (${service})`);          showToast("Fax failed ? moved to At Risk", p.name);        } else {          ref.faxStatus = "sent";          addActivity(p, `Fax sent (${service})`);          showToast("Fax sent successfully", p.name);        }      } else {        ref.faxStatus = "n/a";        addActivity(p, `Portal referral created (${service})`);        showToast("Portal referral sent", p.name);      }      render();    };    const markReferral = (p, service, status) => {      const ref = p.referrals[service];      ref.referralStatus = status;      addActivity(p, `${service} referral ${status.replace("_"," ")}`);      showToast("Referral updated", `${p.name} ? ${service}`);      render();    };    const nudgePhysician = (p) => {      p.ordersLastNudgeAt = new Date().toISOString();      p.ordersNudgeCount += 1;      addActivity(p, p.portalEligibility.physicianOnEsign ? "Nudge physician via portal" : "Text physician off-portal");      showToast("Physician nudged", p.name);      render();    };    const messageAgency = (p) => {      addActivity(p, p.portalEligibility.homeHealthOnPortal ? "Message agency via portal" : "Call agency off-portal");      showToast("Agency messaged", p.name);      render();    };    const markOrdersSigned = (p) => {      p.ordersStatus = "signed";      addActivity(p, "Orders signed");      showToast("Orders signed", p.name);      render();    };    const markOrdersException = (p) => {      p.ordersStatus = "exception_off_portal";      addActivity(p, "Orders exception documented");      showToast("Orders exception", p.name);      render();    };    const openDcDetailsModal = (p) => {      const dc = p.dcSubmission || {};      const rows = [        ["DC Date", dc.dcDate ? formatDate(dc.dcDate) : "?"],        ["DC Confirmed", typeof dc.dcConfirmed === "boolean" ? (dc.dcConfirmed ? "Yes" : "No") : "?"],        ["Urgent Request", typeof dc.dcUrgent === "boolean" ? (dc.dcUrgent ? "Yes" : "No") : "?"],        ["Urgent Details", dc.urgentComments || "?"],        ["Disposition", dc.disposition || "?"],        ["Destination Details", dc.destinationComments || "?"],        ["Discharge With", dc.dcWith || "?"],        ["Home Health Services", (dc.hhServices || []).join(", ") || "?"],        ["Other HH Services", (dc.hhOtherServices || []).join(", ") || "?"],        ["HH Details", dc.hhComments || "?"],        ["Preferred HH Agency", dc.hhAgency || "?"],        ["HH Agency Details", dc.hhAgencyComments || "?"],        ["DME Services", (dc.dmeServices || []).join(", ") || "?"],        ["Other DME Services", (dc.dmeOtherServices || []).join(", ") || "?"],        ["DME Details", dc.dmeComments || "?"],        ["PCP Name", dc.pcpName || "?"],        ["Coordinate Caregiver", typeof dc.coordinateCaregiver === "boolean" ? (dc.coordinateCaregiver ? "Yes" : "No") : "?"],        ["Caregiver Name", dc.caregiverName || "?"],        ["Caregiver Contact", dc.caregiverNumber || "?"],        ["Appealing Discharge", typeof dc.appealingDc === "boolean" ? (dc.appealingDc ? "Yes" : "No") : "?"],        ["Appeal Details", dc.appealComments || "?"]      ];      dcDetailsBodyEl.innerHTML = `        <div class="info-section">
                                                                                                                                                                                                                                                                                                                                                                                                                      <div class="info-grid">            ${rows.map(([label, value]) => `              <div class="info-block">
                                                                                                                                                                                                                                                                                                                                                                                                                        <div class="info-label">${label}</div>
                                                                                                                                                                                                                                                                                                                                                                                                                          <div class="info-value">${value}</div>
                                                                                                                                                                                                                                                                                                                                                                                                                          </div>            `).join("")}          </div>
                                                                                                                                                                                                                                                                                                                                                                                                                        </div>      `;      openModal(dcDetailsModalEl);    };    const openInfoDrawer = (p) => {      const phones = p.phoneNumbers || {};      const address = p.address || {};      const dc = p.dcSubmission || {};      const addressParts = [        address.line1,        address.line2,        [address.city, address.state].filter(Boolean).join(", "),        address.zip      ].filter(Boolean);      const hasValue = (val) => {        if (Array.isArray(val)) return val.length > 0;        if (typeof val === "boolean") return true;        return val !== null && val !== undefined && String(val).trim() !== "";      };      const buildField = (label, value) => {        if (!hasValue(value)) return "";        const display = Array.isArray(value) ? value.join(", ") : (typeof value === "boolean" ? (value ? "Yes" : "No") : value);        return `          <div class="info-block">
                                                                                                                                                                                                                                                                                                                                                                                                                        <div class="info-label">${label}</div>
                                                                                                                                                                                                                                                                                                                                                                                                                          <div class="info-value">${display}</div>
                                                                                                                                                                                                                                                                                                                                                                                                                          </div>        `;      };      const buildChipBlock = (label, items, dangerItems = []) => {        if (!hasValue(items)) return "";        return `          <div class="info-block">
                                                                                                                                                                                                                                                                                                                                                                                                                          <div class="info-label">${label}</div>
                                                                                                                                                                                                                                                                                                                                                                                                                            <div class="info-row" style="margin-top:6px">              ${items.map(item => `<span class="service-pill ${dangerItems.includes(item) ? "danger" : ""}">${item}</span>`).join("")}            </div>
                                                                                                                                                                                                                                                                                                                                                                                                                            </div>        `;      };      const dcDateBlock = hasValue(dc.dcDate) ? `        <div class="info-block">
                                                                                                                                                                                                                                                                                                                                                                                                                            <div class="info-label">DC Date</div>
                                                                                                                                                                                                                                                                                                                                                                                                                              <div class="info-value">${formatDate(dc.dcDate)}</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                <div class="info-icons">
                                                                                                                                                                                                                                                                                                                                                                                                                                  <span class="info-icon ${dc.dcConfirmed ? "confirmed" : "pending"}" title="${dc.dcConfirmed ? "Confirmed" : "Not Confirmed"}" aria-hidden="true">
                                                                                                                                                                                                                                                                                                                                                                                                                                    <svg viewBox="0 0 236.3 236.3">
                                                                                                                                                                                                                                                                                                                                                                                                                                      <circle cx="118.15" cy="118.15" r="114.4" fill="none" stroke="currentColor"/>
                                                                                                                                                                                                                                                                                                                                                                                                                                      <polyline points="55.46 123.18 100.15 167.87 181.34 86.68" fill="none" stroke="currentColor"/>
                                                                                                                                                                                                                                                                                                                                                                                                                                    </svg>
                                                                                                                                                                                                                                                                                                                                                                                                                                  </span>            ${dc.dcUrgent ? `              <span class="info-icon alert" title="Urgent" aria-hidden="true">
                                                                                                                                                                                                                                                                                                                                                                                                                                  <svg viewBox="0 0 236.3 236.3">
                                                                                                                                                                                                                                                                                                                                                                                                                                    <path d="M118.15,16.75l106.4,184.3c4.2,7.28-1.05,16.38-9.45,16.38H21.2c-8.4,0-13.65-9.1-9.45-16.38L118.15,16.75Z" fill="none" stroke="currentColor"/>
                                                                                                                                                                                                                                                                                                                                                                                                                                    <line x1="118.15" y1="78.6" x2="118.15" y2="136.86" fill="none" stroke="currentColor"/>
                                                                                                                                                                                                                                                                                                                                                                                                                                    <circle cx="118.15" cy="167.87" r="6.5" fill="none" stroke="currentColor"/>
                                                                                                                                                                                                                                                                                                                                                                                                                                  </svg>
                                                                                                                                                                                                                                                                                                                                                                                                                                </span>` : ""}          </div>
                                                                                                                                                                                                                                                                                                                                                                                                                              </div>      ` : "";      const caregiverCombined = [        dc.caregiverName ? dc.caregiverName.trim() : "",        dc.caregiverNumber ? dc.caregiverNumber.trim() : ""      ].filter(Boolean).join(" - ");      const dispositionCombined = [dc.disposition, dc.dcWith].filter(Boolean).join(" - ");      const dcFields = [        dcDateBlock,        buildField("Urgent Details", dc.urgentComments),        buildField("Disposition", dispositionCombined),        buildField("Destination Details", dc.destinationComments),        buildChipBlock("Home Health Services", dc.hhServices || []),        buildChipBlock("Other HH Services", dc.hhOtherServices || []),        buildField("HH Details", dc.hhComments),        buildField("Preferred HH Agency", dc.hhAgency),        buildField("HH Agency Details", dc.hhAgencyComments),        buildChipBlock("DME Services", dc.dmeServices || [], ["O2"]),        buildChipBlock("Other DME Services", dc.dmeOtherServices || []),        buildField("DME Details", dc.dmeComments),        buildField("Coordinate Caregiver", typeof dc.coordinateCaregiver === "boolean" ? dc.coordinateCaregiver : null),        buildField("Caregiver", caregiverCombined),        buildField("Appealing Discharge", typeof dc.appealingDc === "boolean" ? dc.appealingDc : null),        buildField("Appeal Details", dc.appealComments)      ].filter(Boolean).join("");      const infoBody = `        <div class="info-section">
                                                                                                                                                                                                                                                                                                                                                                                                                              <div class="info-row">
                                                                                                                                                                                                                                                                                                                                                                                                                                <div class="info-block patient-card" style="flex:1;min-width:220px">
                                                                                                                                                                                                                                                                                                                                                                                                                                  <button class="icon-plain patient-edit-btn" id="btnInfoEdit" type="button" aria-label="Edit patient details" title="Edit patient details">
                                                                                                                                                                                                                                                                                                                                                                                                                                    <svg viewBox="0 0 237.85 237.86" aria-hidden="true">
                                                                                                                                                                                                                                                                                                                                                                                                                                      <line x1="34.25" y1="178.82" x2="57.97" y2="202.54"/>
                                                                                                                                                                                                                                                                                                                                                                                                                                      <path d="M68.74,219.9c-3.65,3.65-8.34,6.09-13.43,6.97l-47.25,8.18c-3.09.53-5.78-2.15-5.24-5.24l8.17-47.25c.88-5.09,3.31-9.78,6.97-13.44L173.79,13.27c14.02-14.02,36.76-14.03,50.78,0h0c14.02,14.02,14.03,36.76,0,50.79L68.74,219.9Z"/>
                                                                                                                                                                                                                                                                                                                                                                                                                                    </svg>
                                                                                                                                                                                                                                                                                                                                                                                                                                  </button>
                                                                                                                                                                                                                                                                                                                                                                                                                                  <div class="info-label">Patient</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="info-value">${p.name}${p.dob ? " (" + formatDob(p.dob) + ")" : ""}</div>              ${addressParts.length ? "<div class=\"info-note\" style=\"margin-top:4px\">" + addressParts.join(" - ") + "</div>" : ""}            </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="info-row" style="margin-top:8px">            ${buildField("Mobile", phones.mobile)}            ${buildField("Home", phones.home)}            ${buildField("Caregiver", phones.caregiver)}          </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>        ${dcFields ? `        <div class="info-section" style="margin-top:10px">
                                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="info-label">DC Submission</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                      <div class="info-grid">            ${dcDateBlock}            ${buildField("Urgent Details", dc.urgentComments)}            ${buildField("Disposition", dispositionCombined)}            ${buildField("Destination Details", dc.destinationComments)}          </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                        <div class="info-divider">
                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                        <div class="info-grid">            ${buildChipBlock("Home Health Services", dc.hhServices || [])}            ${buildChipBlock("Other HH Services", dc.hhOtherServices || [])}            ${buildField("HH Details", dc.hhComments)}            ${buildField("Preferred HH Agency", dc.hhAgency)}            ${buildField("HH Agency Details", dc.hhAgencyComments)}          </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                          <div class="info-divider">
                                                                                                                                                                                                                                                                                                                                                                                                                                          </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                          <div class="info-grid">            ${buildChipBlock("DME Services", dc.dmeServices || [], ["O2"])}            ${buildChipBlock("Other DME Services", dc.dmeOtherServices || [])}            ${buildField("DME Details", dc.dmeComments)}          </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <div class="info-divider">
                                                                                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <div class="info-grid">            ${buildField("Coordinate Caregiver", typeof dc.coordinateCaregiver === "boolean" ? dc.coordinateCaregiver : null)}            ${buildField("Caregiver", caregiverCombined)}            ${buildField("Appealing Discharge", typeof dc.appealingDc === "boolean" ? dc.appealingDc : null)}            ${buildField("Appeal Details", dc.appealComments)}          </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                            </div>` : ""}      `;      infoDrawerEl.innerHTML = `        <div class="drawer-header">
                                                                                                                                                                                                                                                                                                                                                                                                                                            <div>
                                                                                                                                                                                                                                                                                                                                                                                                                                              <div class="drawer-title">Patient Details</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                <div class="drawer-sub">${p.facilityName} - Discharge ${formatDateTime(p.dischargeDateTime)}</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                <button class="btn btn-primary btn-small" id="btnInfoDone">Done</button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                <div class="drawer-body">${infoBody}</div>      `;      drawerEl.classList.remove("open");      infoDrawerEl.classList.add("open");      drawerOverlayEl.classList.add("show");      fabAutoOpen = true;      updateFabState();      infoDrawerEl.querySelector("#btnInfoDone")?.addEventListener("click", () => {        infoDrawerEl.classList.remove("open");        if (selectedPatientId) drawerEl.classList.add("open");        fabAutoOpen = true;        updateFabState();      });      infoDrawerEl.querySelector("#btnInfoEdit")?.addEventListener("click", (e) => {        e.stopPropagation();        openPatientEditModal(p);      });    };    const openContactDrawer = (p) => {      const phones = p.phoneNumbers || {};      const address = p.address || {};      const addressParts = [        address.line1,        address.line2,        [address.city, address.state].filter(Boolean).join(", "),        address.zip      ].filter(Boolean);      const attemptCount = getAttemptNotes(p).length;      const hasReached = getReachedNotes(p).length > 0;      const vmSelected = !hasReached && attemptCount >= 2;      const reachedSelected = hasReached;      const vmDisabled = hasReached || attemptCount >= 2;      const reachedDisabled = !hasReached && attemptCount >= 2;      const contactNotes = [        ...getAttemptNotes(p).map(n => ({          created_at: n.created_at,          text: getNoteAnswerValue(n, REACHED_FIELD_KEY) || CALL_VM_ANSWER,          noteId: n.id,          templateId: REACHED_TEMPLATE_ID        })),        ...getReachedNotes(p).map(n => ({          created_at: n.created_at,          text: `Reached patient${(getNoteAnswerValue(n, REACHED_FIELD_KEY) || REACHED_ANSWER || "").trim() ? ` ? ${(getNoteAnswerValue(n, REACHED_FIELD_KEY) || REACHED_ANSWER || "").trim()}` : ""}`,          noteId: n.id,          templateId: REACHED_TEMPLATE_ID        })),        ...getCcmNotes(p).map(n => {          const detail = (getNoteAnswerValue(n, CCM_FIELD_KEY) || n.response1 || "").trim();          const isDeclined = detail.toLowerCase().includes("declined");          return {            created_at: n.created_at,            text: `${isDeclined ? "CCM Declined" : "CCM Accepted"}${detail ? ` - ${detail}` : ""}`,            noteId: n.id,            templateId: CCM_TEMPLATE_ID          };        })      ].filter(n => n.created_at)        .sort((a,b) => new Date(b.created_at) - new Date(a.created_at))        .map(n => ({          ...n,          display: `${formatStamp(new Date(n.created_at))} - ${n.text}`        }));      const contactBody = `        <div class="info-section">
                                                                                                                                                                                                                                                                                                                                                                                                                                                  <div class="info-row">
                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="info-block patient-card" style="flex:1;min-width:220px">
                                                                                                                                                                                                                                                                                                                                                                                                                                                      <div class="info-label">Patient</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div class="info-value">${p.name}${p.dob ? " (" + formatDob(p.dob) + ")" : ""}</div>              ${addressParts.length ? "<div class=\"info-note\" style=\"margin-top:4px\">" + addressParts.join(" - ") + "</div>" : ""}              <div class="info-row" style="margin-top:6px">                ${phones.mobile ? `<span class="service-pill">M: ${phones.mobile}</span>` : ""}                ${phones.home ? `<span class="service-pill">H: ${phones.home}</span>` : ""}                ${phones.caregiver ? `<span class="service-pill">C: ${phones.caregiver}</span>` : ""}              </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                      </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="info-section" style="margin-top:8px">
                                                                                                                                                                                                                                                                                                                                                                                                                                                      <div class="info-block">
                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div class="info-label">Instructions</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                          <div class="info-note">
                                                                                                                                                                                                                                                                                                                                                                                                                                                            <strong>Patient Script:</strong> Hi there, this is the care team calling to review your discharge plan and answer any questions you may have.</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                              <div class="info-note" style="margin-top:6px">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                <strong>Additional Details:</strong> Medrina CCM</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <div style="margin-top:10px">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <button class="btn btn-small" id="btnDcDetails">Discharge Details</button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div class="info-divider">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div class="info-section">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <div class="row-actions split">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="row-actions-left">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <div class="info-label">Contact Notes & Attempts (${p.contactAttempts}/2)</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <div class="row-actions-right">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <button class="btn-icon down ${vmSelected ? "is-selected" : ""}" id="btnContactAttempt" ${vmDisabled ? "disabled" : ""} aria-label="Left VM" title="Left VM">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <svg viewBox="0 0 233.12 234.63" aria-hidden="true">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <path d="M52.97,218.37H12.19c-5.21,0-9.44-4.23-9.44-9.44v-108.68c0-5.21,4.23-9.44,9.44-9.44h38.63c6.97-.01,13.73-2.63,18.73-7.49C90.09,63.36,113.34,16.95,122.19,7.1c3.98-4.7,9.44-4.71,13.07-4.03.07.02.13.03.2.05,25.27,5.85,14.83,46.22,5.35,66.57h0c-3.97,7.7,1.62,16.88,10.28,16.88h54.46c17.1,0,29.06,16.89,23.39,33.02l-33.11,94.15c-3.82,10.87-14.09,18.14-25.61,18.14h-64.57c-11.22,0-22.34-2.03-32.83-6l-19.86-7.51v-126.87"/>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </svg>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <button class="btn-icon reached ${reachedSelected ? "is-selected" : ""}" id="btnContactReached" ${reachedDisabled ? "disabled" : ""} aria-label="Reached" title="Reached">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <svg viewBox="0 0 233.12 234.63" aria-hidden="true">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <path d="M52.97,218.37H12.19c-5.21,0-9.44-4.23-9.44-9.44v-108.68c0-5.21,4.23-9.44,9.44-9.44h38.63c6.97-.01,13.73-2.63,18.73-7.49C90.09,63.36,113.34,16.95,122.19,7.1c3.98-4.7,9.44-4.71,13.07-4.03.07.02.13.03.2.05,25.27,5.85,14.83,46.22,5.35,66.57h0c-3.97,7.7,1.62,16.88,10.28,16.88h54.46c17.1,0,29.06,16.89,23.39,33.02l-33.11,94.15c-3.82,10.87-14.09,18.14-25.61,18.14h-64.57c-11.22,0-22.34-2.03-32.83-6l-19.86-7.51v-126.87"/>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </svg>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="activity-log" style="max-height:none">            ${(contactNotes.length ? contactNotes : [{ text:"No contact notes yet." }]).map(item => `              <div class="activity-item ${item.noteId ? "note-row" : ""}" ${item.noteId ? `data-note-id="${item.noteId}" data-template-id="${item.templateId}"` : ""}>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <span class="note-text">${item.display || item.text}</span>                ${item.noteId ? `                  <button class="icon-plain trash" data-note-delete="${item.noteId}" title="Delete" aria-label="Delete">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <svg viewBox="0 0 224.65 262.72" aria-hidden="true">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <path d="M205.74,105.45v128.84c0,14.18-11.49,25.67-25.67,25.67H43.59c-14.18,0-25.67-11.49-25.67-25.67V105.45"/>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <path d="M24.99,41.02h174.66c12.28,0,22.24,9.97,22.24,22.24v13.37c0,5.42-4.4,9.81-9.81,9.81H12.56c-5.42,0-9.81-4.4-9.81-9.81v-13.37c0-12.28,9.97-22.24,22.24-22.24Z"/>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <path d="M63.83,39.75v-23.26c0-7.58,6.15-13.73,13.73-13.73h68.53c7.58,0,13.73,6.15,13.73,13.73v23.26"/>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <line x1="80.17" y1="125.24" x2="80.17" y2="217.29"/>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <line x1="144.48" y1="125.24" x2="144.48" y2="217.29"/>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </svg>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </button>                ` : ""}              </div>            `).join("")}          </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>      `;      contactDrawerEl.innerHTML = `        <div class="drawer-header">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <div class="drawer-title">Patient Contact</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div class="drawer-sub">${p.name} - ${p.facilityName}</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <button class="btn btn-primary btn-small" id="btnContactDone">Done</button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div class="drawer-body">${contactBody}</div>      `;      drawerEl.classList.remove("open");      infoDrawerEl.classList.remove("open");      contactDrawerEl.classList.add("open");      drawerOverlayEl.classList.add("show");      fabAutoOpen = true;      updateFabState();      contactDrawerEl.querySelector("#btnContactDone")?.addEventListener("click", () => {        contactDrawerEl.classList.remove("open");        if (selectedPatientId) drawerEl.classList.add("open");        fabAutoOpen = true;        updateFabState();      });      bindQuickNoteButton(        contactDrawerEl.querySelector("#btnContactAttempt"),        () => logVm(p),        () => logVm(p, { openDetails: true, showToastAction: false })      );      bindQuickNoteButton(        contactDrawerEl.querySelector("#btnContactReached"),        () => markReached(p),        () => markReached(p, { openDetails: true, showToastAction: false })      );      bindQuickNoteButton(        contactDrawerEl.querySelector("#btnCcmYes"),        () => logCcmStatus(p, true),        () => logCcmStatus(p, true, { openDetails: true, showToastAction: false })      );      bindQuickNoteButton(        contactDrawerEl.querySelector("#btnCcmNo"),        () => logCcmStatus(p, false),        () => logCcmStatus(p, false, { openDetails: true, showToastAction: false })      );      contactDrawerEl.querySelector(".activity-log")?.addEventListener("click", (event) => {        const deleteBtn = event.target.closest("[data-note-delete]");        if (deleteBtn) {          event.stopPropagation();          deleteAdmissionNote(p, deleteBtn.dataset.noteDelete);          return;        }        const row = event.target.closest(".activity-item.note-row");        if (!row) return;        const noteId = row.dataset.noteId;        if (!noteId) return;        openNoteDetailsModalForNote(p, noteId);      });      contactDrawerEl.querySelector("#btnDcDetails")?.addEventListener("click", () => openDcDetailsModal(p));    };    const openDocsDrawer = async (p) => {      await loadAdmissionPdfs(p);      const rows = (p.pdfs || []);      const docsBody = `        <div class="info-section">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <div class="info-row" style="align-items:flex-end; gap:12px;">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div style="flex:1;min-width:180px;">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <div class="info-label">Document Type</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <input class="ipt" id="docsDrawerType" placeholder="e.g., Facesheet" />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <button class="btn" id="docsDrawerUploadBtn">Upload</button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div class="info-section">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <div class="info-label" style="margin-bottom:6px;">Uploaded Documents</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div class="activity-log" style="max-height:none">            ${rows.length ? rows.map(r => {              const stamp = r.created_at ? formatStamp(new Date(r.created_at)) : "?";              const name = r.original_filename || r.filename || "Document";              return `                <div class="activity-item note-row" data-doc-id="${r.id}">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <span class="note-text">${stamp} - ${r.doc_type || "Document"} ? ${name}</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <button class="icon-plain trash" data-doc-delete="${r.id}" title="Delete" aria-label="Delete">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <svg viewBox="0 0 224.65 262.72" aria-hidden="true">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <path d="M205.74,105.45v128.84c0,14.18-11.49,25.67-25.67,25.67H43.59c-14.18,0-25.67-11.49-25.67-25.67V105.45"/>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <path d="M24.99,41.02h174.66c12.28,0,22.24,9.97,22.24,22.24v13.37c0,5.42-4.4,9.81-9.81,9.81H12.56c-5.42,0-9.81-4.4-9.81-9.81v-13.37c0-12.28,9.97-22.24,22.24-22.24Z"/>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <path d="M63.83,39.75v-23.26c0-7.58,6.15-13.73,13.73-13.73h68.53c7.58,0,13.73,6.15,13.73,13.73v23.26"/>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <line x1="80.17" y1="125.24" x2="80.17" y2="217.29"/>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <line x1="144.48" y1="125.24" x2="144.48" y2="217.29"/>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </svg>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </div>              `;            }).join("") : `<div class="activity-item">No documents uploaded yet.</div>`}          </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>      `;      docsDrawerEl.innerHTML = `        <div class="drawer-header">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <div class="drawer-title">Documents</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="drawer-sub">${p.name} - ${p.facilityName}</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <button class="btn btn-primary btn-small" id="btnDocsDone">Done</button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="drawer-body">${docsBody}</div>      `;      drawerEl.classList.remove("open");      infoDrawerEl.classList.remove("open");      contactDrawerEl.classList.remove("open");      activityDrawerEl.classList.remove("open");      docsDrawerEl.classList.add("open");      drawerOverlayEl.classList.add("show");      fabAutoOpen = true;      updateFabState();      docsDrawerEl.querySelector("#btnDocsDone")?.addEventListener("click", () => {        docsDrawerEl.classList.remove("open");        if (selectedPatientId) drawerEl.classList.add("open");        updateFabState();      });      docsDrawerEl.querySelector("#docsDrawerUploadBtn")?.addEventListener("click", () => {        const input = docsDrawerEl.querySelector("#docsDrawerType");        const docType = (input && input.value || "").trim();        if (!docType) {          showToast("Please ddd Document Type before proceeding.", "", null, { variant: "warning" });          return;        }        pendingDocUpload = { patientId: p.id, docKey: null, docType };        docsUploadInputEl.value = "";        docsUploadInputEl.click();      });      docsDrawerEl.querySelectorAll("[data-doc-delete]").forEach(btn => {        btn.addEventListener("click", async (e) => {          e.stopPropagation();          const id = btn.dataset.docDelete;          if (!id) return;          if (!token()) return;          try {            const res = await fetch(`/api/sensys/pdfs/${id}/delete`, {              method: "POST",              headers: { ...authHeaders(), "Content-Type": "application/json" }            });            if (!res.ok) throw new Error("Delete failed");            await loadAdmissionPdfs(p);            openDocsDrawer(p);          } catch (err) {            showToast("Delete failed", p.name);          }        });      });    };    const refreshOpenDrawers = (p) => {      if (!p) return;      if (contactDrawerEl.classList.contains("open")) {        openContactDrawer(p);      }      if (docsDrawerEl.classList.contains("open")) {        openDocsDrawer(p);      }      if (activityDrawerEl.classList.contains("open")) {        openActivityDrawer(p);      }      if (ordersDrawerEl.classList.contains("open")) {        openOrdersDrawer(p);      }      if (notesDrawerEl.classList.contains("open")) {        openNotesDrawer(p);      }    };        const loadMessageRecipients = async (p) => {
      if (!token() || !p || !p.id) return [];
      const cached = p.messageRecipients || null;
      const ageMs = p.messageRecipientsLoadedAt ? (Date.now() - p.messageRecipientsLoadedAt) : 9999999;
      if (cached && ageMs < 120000) return cached;
      try {
        const res = await fetch(`/api/sensys/admissions/${p.id}/esign-recipients`, { headers: authHeaders() });
        if (!res.ok) throw new Error("Failed to load recipients");
        const data = await res.json();
        const list = data.recipients || [];
        p.messageRecipients = list;
        p.messageRecipientsLoadedAt = Date.now();
        return list;
      } catch (err) {
        return [];
      }
    };
    const setMessageChip = (el, pressed) => {
      if (!el) return;
      el.setAttribute("aria-pressed", pressed ? "true" : "false");
      el.classList.toggle("is-active", Boolean(pressed));
    };
    const updateMessageRecipientMeta = () => {
      if (!messageRecipientEl || !messageRecipientMetaEl) return;
      const opt = messageRecipientEl.selectedOptions && messageRecipientEl.selectedOptions[0];
      if (!opt) return;
      const email = opt.dataset.email || "";
      const phone = opt.dataset.phone || "";
      const bits = [];
      if (email) bits.push(`Email: ${email}`);
      if (phone) bits.push(`Phone: ${formatPhoneDisplay(phone)}`);
      messageRecipientMetaEl.textContent = bits.length ? bits.join(" | ") : "No contact methods on file.";
      if (messageChannelEmailEl) {
        messageChannelEmailEl.disabled = !email;
        if (!email) setMessageChip(messageChannelEmailEl, false);
      }
      if (messageChannelPhoneEl) {
        messageChannelPhoneEl.disabled = !phone;
        if (!phone) setMessageChip(messageChannelPhoneEl, false);
      }
    };
    const openMessagePhysicianModal = async (p) => {
      if (!messagePhysicianModalEl || !messageRecipientEl) return;
      messageRecipientEl.innerHTML = `<option value="">Loading recipients...</option>`;
      setMessageChip(messageChannelEmailEl, false);
      setMessageChip(messageChannelPhoneEl, false);
      updateMessageRecipientMeta();
      openModal(messagePhysicianModalEl);
      const recipients = await loadMessageRecipients(p);
      if (!messageRecipientEl) return;
      if (!recipients.length) {
        messageRecipientEl.innerHTML = `<option value="">No recipients available</option>`;
      } else {
        messageRecipientEl.innerHTML = recipients.map(r => (
          `<option value="${r.id}" data-email="${r.email || ""}" data-phone="${r.phone || ""}" data-type="${r.type || ""}">${r.label}</option>`
        )).join("");
      }
      updateMessageRecipientMeta();
    };const openModal = (el) => { el.style.display = "flex"; };    const closeModal = (el) => { el.style.display = "none"; };    document.querySelectorAll("[data-close]").forEach(btn => {      btn.addEventListener("click", () => closeModal(document.getElementById(btn.dataset.close)));    });    messageRecipientEl?.addEventListener("change", updateMessageRecipientMeta);    messageChannelEmailEl?.addEventListener("click", () => {      if (messageChannelEmailEl.disabled) return;      const pressed = messageChannelEmailEl.getAttribute("aria-pressed") === "true";      setMessageChip(messageChannelEmailEl, !pressed);    });    messageChannelPhoneEl?.addEventListener("click", () => {      if (messageChannelPhoneEl.disabled) return;      const pressed = messageChannelPhoneEl.getAttribute("aria-pressed") === "true";      setMessageChip(messageChannelPhoneEl, !pressed);    });    openFiltersEl.addEventListener("click", () => openModal(filtersModalEl));    pcpApptSaveEl?.addEventListener("click", savePcpAppt);    ctEditSaveEl?.addEventListener("click", saveCareTeamEdit);    document.getElementById("btnFaxLog")?.addEventListener("click", () => {      const p = patients.find(pt => pt.id === selectedPatientId);      if (p) openFaxLogModal(p);    });    docsUploadInputEl?.addEventListener("change", async (e) => {      const file = e.target.files && e.target.files[0];      if (!file || !pendingDocUpload) return;      const p = patients.find(pt => String(pt.id) === String(pendingDocUpload.patientId));      if (!p) return;      await uploadDocForAdmission(p, pendingDocUpload.docKey, pendingDocUpload.docType, file);      pendingDocUpload = null;    });    const bindQuickNoteButton = (el, onClick, onHold) => {      if (!el) return;      let holdTimer = null;      let held = false;      const clearHold = () => {        if (holdTimer) clearTimeout(holdTimer);        holdTimer = null;      };      const startHold = () => {        held = false;        clearHold();        holdTimer = setTimeout(() => {          held = true;          onHold && onHold();        }, 450);      };      el.addEventListener("pointerdown", startHold);      el.addEventListener("pointerup", clearHold);      el.addEventListener("pointerleave", clearHold);      el.addEventListener("pointercancel", clearHold);      el.addEventListener("mousedown", startHold);      el.addEventListener("mouseup", clearHold);      el.addEventListener("mouseleave", clearHold);      el.addEventListener("touchstart", startHold, { passive: true });      el.addEventListener("touchend", clearHold);      el.addEventListener("touchcancel", clearHold);      el.addEventListener("click", (e) => {        if (held) {          held = false;          e.preventDefault();          e.stopPropagation();          return;        }        onClick && onClick();      });    };    let nudgeHoldBound = false;    let nudgeHoldTimer = null;    let nudgeHeld = false;    const bindNudgeHoldDelegation = () => {      if (nudgeHoldBound || !drawerEl) return;      nudgeHoldBound = true;      const clearHold = () => {        if (nudgeHoldTimer) clearTimeout(nudgeHoldTimer);        nudgeHoldTimer = null;      };      const getNudgePatient = () => {        if (!selectedPatientId) return null;        return patients.find(pt => String(pt.id) === String(selectedPatientId));      };      const startHold = (e) => {        const btn = e.target.closest("#btnNudge");        if (!btn) return;        nudgeHeld = false;        clearHold();        nudgeHoldTimer = setTimeout(() => {          nudgeHeld = true;          const p = getNudgePatient();          if (p) openMessagePhysicianModal(p);        }, 450);      };      const endHold = (e) => {        if (!e.target.closest || !e.target.closest("#btnNudge")) return;        clearHold();      };      drawerEl.addEventListener("pointerdown", startHold);      drawerEl.addEventListener("pointerup", endHold);      drawerEl.addEventListener("pointerleave", endHold);      drawerEl.addEventListener("pointercancel", endHold);      drawerEl.addEventListener("mousedown", startHold);      drawerEl.addEventListener("mouseup", endHold);      drawerEl.addEventListener("mouseleave", endHold);      drawerEl.addEventListener("touchstart", startHold, { passive: true });      drawerEl.addEventListener("touchend", endHold);      drawerEl.addEventListener("touchcancel", endHold);      drawerEl.addEventListener("click", (e) => {        const btn = e.target.closest("#btnNudge");        if (!btn) return;        if (nudgeHeld) {          nudgeHeld = false;          e.preventDefault();          e.stopPropagation();          return;        }        const p = getNudgePatient();        if (p) nudgePhysician(p);      });    };    bindNudgeHoldDelegation();    noteDetailsSaveEl.addEventListener("click", async () => {      if (!noteDetailsContext || !token()) return;      const p = patients.find(pt => String(pt.id) === String(noteDetailsContext.patientId));      if (!p) return;      const answers = [];      noteDetailsBodyEl.querySelectorAll("[data-field-key]").forEach(el => {        const key = el.dataset.fieldKey || "";        const type = (el.dataset.fieldType || "text").toLowerCase();        if (!key) return;        const raw = (el.value || "").trim();        if (raw === "") return;        if (type === "number") {          const num = Number(raw);          if (!Number.isNaN(num)) answers.push({ field_key: key, value_num: num });          return;        }        if (type === "date") {          answers.push({ field_key: key, value_date: raw });          return;        }        if (type === "boolean") {          if (raw === "1" || raw === "0") answers.push({ field_key: key, value_bool: Number(raw) });          return;        }        answers.push({ field_key: key, value_text: raw });      });      try {        let response1 = noteDetailsContext.noteResponse1 || "";        if (noteDetailsContext.templateId === REACHED_TEMPLATE_ID) {          const ans = answers.find(a => a.field_key === REACHED_FIELD_KEY);          if (ans && ans.value_text) response1 = ans.value_text;        }        if (noteDetailsContext.templateId === CCM_TEMPLATE_ID) {          const ans = answers.find(a => a.field_key === CCM_FIELD_KEY);          if (ans && ans.value_text) response1 = ans.value_text;        }        const payload = {          id: noteDetailsContext.noteId || null,          admission_id: Number(p.id),          note_name: noteDetailsContext.noteName,          template_id: noteDetailsContext.templateId,          workspace_key: WORKSPACE_KEY,          response1,          answers        };        const res = await fetch("/api/sensys/admission-notes/upsert", {          method: "POST",          headers: { ...authHeaders(), "Content-Type": "application/json" },          body: JSON.stringify(payload)        });        if (!res.ok) throw new Error("Failed to save note details");        await loadAdmissionNotes([p.id]);        closeModal(noteDetailsModalEl);        showToast("Note updated", p.name);        render();        refreshOpenDrawers(p);      } catch (err) {        console.warn("[Evolv SNF] note save failed:", err);        showToast("Note save failed", p.name);      }    });    contactDrawerEl.addEventListener("click", (event) => {      const btn = event.target.closest("#btnContactEdit");      if (!btn) return;      const patientId = btn.dataset.patientId;      const p = patients.find(pt => pt.id === patientId);      if (p) openPatientEditModal(p);    });    warningContinueEl.addEventListener("click", () => {      const p = patients.find(pt => pt.id === pendingReferral?.patientId);      if (p) {        addActivity(p, `Proceed referral before contact (${warningReasonEl.value})`);        showToast("Proceeding before reach", p.name);        closeModal(warningModalEl);        openSendModal(p, pendingReferral.service);      }    });    faxConfirmEl.addEventListener("click", () => {      const p = patients.find(pt => pt.id === pendingReferral?.patientId);      if (p) {        closeModal(faxModalEl);        completeReferralSend(p, pendingReferral.service);        pendingReferral = null;      }    });    epSaveEl.addEventListener("click", () => {      const p = patients.find(pt => pt.id === editingPatientId);      if (!p) return;      const details = {        firstName: epFirstNameEl.value.trim(),        lastName: epLastNameEl.value.trim(),        dob: epDobEl.value.trim(),        gender: epGenderEl.value.trim(),        phone1: epPhone1El.value.trim(),        phone2: epPhone2El.value.trim(),        email: epEmailEl.value.trim(),        email2: epEmail2El.value.trim(),        address1: epAddress1El.value.trim(),        address2: epAddress2El.value.trim(),        city: epCityEl.value.trim(),        state: epStateEl.value.trim(),        zip: epZipEl.value.trim(),        insuranceName1: epInsuranceName1El.value.trim(),        insuranceNumber1: epInsuranceNumber1El.value.trim(),        insuranceName2: epInsuranceName2El.value.trim(),        insuranceNumber2: epInsuranceNumber2El.value.trim(),        notes1: epNotes1El.value.trim(),        notes2: epNotes2El.value.trim(),        externalPatientId: epExternalPatientIdEl.value.trim(),        mrn: epMrnEl.value.trim(),        source: epSourceEl.value.trim(),        active: epActiveEl.value      };      p.patientDetails = { ...(p.patientDetails || {}), ...details };      const fullName = [details.firstName, details.lastName].filter(Boolean).join(" ").trim();      if (fullName) p.name = fullName;      if (details.dob) p.dob = details.dob;      if (details.mrn) p.mrn = details.mrn;      p.phoneNumbers = {        ...(p.phoneNumbers || {}),        mobile: details.phone1 || p.phoneNumbers?.mobile || "",        home: details.phone2 || p.phoneNumbers?.home || ""      };      p.address = {        ...(p.address || {}),        line1: details.address1 || "",        line2: details.address2 || "",        city: details.city || "",        state: details.state || "",        zip: details.zip || ""      };      closeModal(patientEditModalEl);      showToast("Patient updated", p.name);      render();    });    const populateFacilityFilter = () => {      const facilities = [...new Set(patients.map(p => p.facilityName))];      facilityFilterEl.innerHTML = `<option value="all">All</option>` + facilities.map(f => `<option>${f}</option>`).join("");    };    const render = () => {      patients.forEach(recomputeDerived);      renderQueues();      renderHead();      const queuePatients = patients.filter(p => inQueue(p, activeQueue) && matchesFilters(p));      const sorted = sortPatients(queuePatients);      renderSummary(queuePatients);      renderTable(sorted);      if (selectedPatientId) renderDrawer();    };    [searchInputEl, facilityFilterEl, dateFilterEl, sortFilterEl, toggleAtRiskEl, toggleOffPortalEl]      .forEach(el => el.addEventListener("input", render));    loadAdmissions();  </script>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </body>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </html>













