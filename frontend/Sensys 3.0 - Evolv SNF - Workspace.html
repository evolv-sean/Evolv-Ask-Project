<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Coordinator Workspace</title>
  <style>
    :root{
      --navy:#0D3B66;
      --mint:#A8E6CF;
      --mint-2: rgba(168,230,207,.35);
      --sky:#4DA8DA;
      --cool:#F5F7FA;
      --neg:#C76B6B;
      --plum:#7C6D8A;
      --slate:#7A8699;
      --bg: var(--cool);
      --surface:#ffffff;
      --text:#0f172a;
      --muted:#55657f;
      --muted2:#6b7280;
      --line: rgba(13,59,102,.14);
      --line-strong: rgba(13,59,102,.22);
      --shadow: 0 10px 28px rgba(0,0,0,.08);
      --shadow-soft: 0 8px 18px rgba(13,59,102,.12);
      --r-xl:18px;
      --r-lg:16px;
      --r-md:12px;
      --r-sm:10px;
      --ring: 0 0 0 3px rgba(168,230,207,.50);
      --ring2: 0 0 0 4px rgba(168,230,207,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(900px 320px at 50% 1%, rgba(15,23,42,.035), rgba(255,255,255,0) 80%),
        linear-gradient(180deg, #ffffff 0%, #f5f7fa 100%);
      background-repeat:no-repeat;
      background-attachment:fixed;
      color:var(--text);
      font-family:"Manrope","Segoe UI",system-ui,-apple-system,Arial,sans-serif;
    }

    /* Design library components */
    .card{
      border:1px solid var(--line);
      background:rgba(255,255,255,.92);
      backdrop-filter: blur(4px);
      border-radius:var(--r-xl);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      border-radius:12px; padding:10px 14px;
      border:1px solid var(--line-strong);
      background:#fff; color:var(--navy);
      font-weight:900; font-size:13px;
      cursor:pointer;
      transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease, background .15s ease, color .15s ease;
    }
    .btn:hover{border-color: rgba(168,230,207,.9); box-shadow: var(--ring2); transform: translateY(-1px);}
    .btn:active{transform: translateY(0px)}
    .btn-primary{background: var(--navy); border-color: rgba(13,59,102,.95); color:#fff; box-shadow: var(--shadow-soft);}
    .btn-primary:hover{background:#0b3357; border-color:#0b3357; box-shadow: 0 10px 26px rgba(13,59,102,.18);}
    .btn-ghost{background: transparent;}
    .btn-small{padding:8px 12px;border-radius:10px;font-size:12px}
    .btn[disabled]{opacity:.55; cursor:not-allowed; box-shadow:none; transform:none;}

    label{display:block;font-size:12px;color:#374151;margin:0 0 6px;font-weight:800}
    .ipt, select, textarea{
      width:100%; max-width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(13,59,102,.18);
      background:#fff; font-size:14px; outline:none;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    .ipt:focus, select:focus, textarea:focus{border-color: rgba(168,230,207,.95); box-shadow: var(--ring);}

    .pill{
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(13,59,102,.18);
      background:#fff; color:#334155;
      font-weight:800; font-size:12px; line-height:1;
      cursor:pointer;
      transition: border-color .15s ease, box-shadow .15s ease, background .15s ease, color .15s ease;
    }
    .pill:hover{border-color: rgba(168,230,207,.9); box-shadow: 0 0 0 3px rgba(168,230,207,.35);}
    .pill[aria-pressed="true"]{
      border-color: rgba(168,230,207,.95);
      box-shadow: 0 10px 24px rgba(168,230,207,.18), 0 0 0 3px rgba(168,230,207,.45);
      background: rgba(168,230,207,.18);
      color: var(--navy);
    }

    .table-wrap{
      border-radius:16px;
      border:1px solid rgba(13,59,102,.14);
      overflow:auto;
      background:#fff;
      max-height: clamp(360px, calc(60vh + 70px), 710px);
    }
    table{width:100%; border-collapse:collapse; font-size:12px}
    thead{background: rgba(13,59,102,.05)}
    th, td{padding:10px 14px; text-align:left}
    th{font-size:10px;font-weight:900;text-transform:uppercase;letter-spacing:.09em;color:#4b5563;border-bottom:1px solid rgba(13,59,102,.12);white-space:nowrap;}
    td{border-bottom:1px solid rgba(13,59,102,.10);color:#111827;vertical-align:middle;}
    tbody tr:nth-child(even){background: rgba(13,59,102,.02)}
    tbody tr:hover{background: rgba(168,230,207,.18)}
    tbody tr:last-child td{border-bottom:none}

    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid rgba(13,59,102,.16);background: rgba(13,59,102,.04);font-weight:900;font-size:10px;color: rgba(13,59,102,.88);letter-spacing:.02em;line-height:1;}
    .badge .dot{width:6px;height:6px;border-radius:999px;background:rgba(77,168,218,.85)}

    .dl-modal-overlay{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(245,247,250,72);
      backdrop-filter: blur(2px);
      z-index:10000;
      padding:16px;
    }
    #patientEditModal{background:rgba(13,59,102,.12);}
    #patientEditModal .dl-modal-bar .btn{color:#fff;border-color: rgba(255,255,255,.35);}
    #patientEditModal .dl-modal-bar .btn:hover{border-color:#fff; box-shadow: 0 0 0 3px rgba(255,255,255,.25);}
    #dcDetailsModal{background:rgba(13,59,102,.12);}
    #dcDetailsModal .dl-modal{max-height:92vh;display:flex;flex-direction:column}
    #dcDetailsModal .dl-modal-body{overflow:auto;flex:1}
    .dl-modal{
      width:min(720px, 100%);
      border-radius:18px;
      border:1px solid rgba(13,59,102,14);
      background:#fff;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .dl-modal-bar{
      background: var(--navy);
      color:#fff;
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-weight:900;
      letter-spacing:.2px;
    }
    .dl-modal-body{padding:14px 16px}
    .dl-modal-actions{
      padding:0 16px 16px;
      display:flex;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .dl-toast{
      position:fixed;
      right:16px;
      bottom:16px;
      width:min(420px, calc(100vw - 32px));
      background:#fff;
      border:1px solid rgba(13,59,102,14);
      border-radius:18px;
      box-shadow: var(--shadow);
      padding:12px 12px;
      z-index:11000;
      display:none;
      transform: translateY(8px);
      opacity:0;
      transition: opacity .18s ease, transform .18s ease;
    }
    .dl-toast.show{display:block;opacity:1;transform: translateY(0)}
    .dl-toast-top{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;}
    .dl-toast-title{font-weight:900;color: var(--navy);font-size:13px;}
    .dl-toast-sub{margin-top:2px;font-size:12px;color: var(--muted);font-weight:800;line-height:1.35;}
    .dl-toast-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid rgba(168,230,207,70);background: rgba(168,230,207,18);color: var(--navy);font-weight:900;font-size:12px;line-height:1;}
    .dl-toast-dot{width:8px;height:8px;border-radius:999px;background: rgba(168,230,207,95);}
    .dl-toast-close{border:none;background:transparent;cursor:pointer;padding:6px;border-radius:10px;}
    .dl-toast-close:hover{background: rgba(13,59,102,.06)}
    .dl-toast-actions{margin-top:10px;display:none;gap:8px;justify-content:flex-end;}

    /* Layout */
    .layout{display:flex;min-height:100vh}
    .sidebar{
      width:240px;
      background:#fff;
      border-right:1px solid rgba(13,59,102,.08);
      padding:18px 16px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .brand-title{font-weight:900;color:var(--navy);font-size:16px;letter-spacing:.02em}
    .brand-sub{font-size:12px;color:var(--muted);font-weight:800}
    .queue-list{display:flex;flex-direction:column;gap:8px}
    .queue-item{
      display:flex;align-items:center;justify-content:space-between;gap:8px;
      padding:10px 12px;border-radius:12px;border:1px solid rgba(13,59,102,.10);
      background:rgba(13,59,102,.03);cursor:pointer;font-size:13px;font-weight:800;color:var(--navy);
      transition: background .15s ease, border-color .15s ease, transform .15s ease;
    }
    .queue-item.urgent{
      border-color: rgba(199,107,107,.65);
      background:rgba(13,59,102,.03);
    }
    .queue-item.urgent.active{
      border-color: rgba(199,107,107,.75);
      background:rgba(168,230,207,.28);
      box-shadow: 0 10px 24px rgba(199,107,107,.18);
    }
    .queue-sep{
      margin:10px 4px 6px;
      height:1px;
      background:rgba(13,59,102,.12);
      position:relative;
    }
    .queue-item:hover{border-color: rgba(168,230,207,.95); transform: translateY(-1px);}
    .queue-item.active{
      background:rgba(168,230,207,.28);
      border-color: rgba(168,230,207,.95);
      box-shadow: 0 10px 24px rgba(168,230,207,.18);
    }
    .queue-count{
      background:rgba(13,59,102,.08);
      color:var(--navy);
      border-radius:999px;
      padding:4px 8px;
      font-size:11px;
      font-weight:900;
    }

    .main{flex:1;display:flex;flex-direction:column;min-width:0}
    .header{
      padding:18px 22px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      border-bottom:1px solid rgba(13,59,102,.08);
      background:rgba(255,255,255,.9);
      position:sticky; top:0; z-index:5;
    }
    .header-left{display:flex;flex-direction:column;gap:6px}
    .header-title{font-size:20px;font-weight:900;color:var(--navy)}
    .header-sub{font-size:12px;color:var(--muted);font-weight:800}
    .header-actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .search-wrap{min-width:280px;flex:1}
    .toggle{
      display:flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;border:1px solid rgba(13,59,102,.18);
      background:#fff;font-size:12px;font-weight:800;color:var(--navy);
    }
    .toggle input{width:16px;height:16px}

    .content{padding:18px 22px 30px;display:flex;flex-direction:column;gap:14px}
    .filters{display:grid;grid-template-columns: 1.1fr 1fr 1.2fr auto;gap:12px;align-items:end}
    .filters .field{min-width:0}
    .filters .toggle{justify-content:center}

    .summary{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
      padding:12px 16px;
      border-bottom:1px solid rgba(13,59,102,.08);
      background:rgba(13,59,102,.02);
    }
    .summary-item{display:flex;flex-direction:column;gap:4px}
    .summary-item span{font-size:11px;color:var(--muted);font-weight:800;text-transform:uppercase;letter-spacing:.08em}
    .summary-item strong{font-size:18px;color:var(--navy)}

    .task-chips{display:flex;gap:6px;flex-wrap:wrap}
    .task-chip{
      padding:4px 8px;border-radius:999px;border:1px solid rgba(13,59,102,.15);
      font-size:10px;font-weight:900;color:var(--navy);background:rgba(13,59,102,.04);
    }
    .task-chip.urgent{
      border-color: rgba(199,107,107,.6);
      background: rgba(199,107,107,.14);
      color:#7a2f2f;
    }
    .service-lines{display:flex;flex-direction:column;gap:6px}
    .service-line{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
    .service-label{font-size:10px;font-weight:900;color:var(--muted);letter-spacing:.06em;text-transform:uppercase}
    .service-pill{
      padding:4px 8px;border-radius:999px;border:1px solid rgba(13,59,102,.18);
      font-size:10px;font-weight:900;color:var(--navy);background:#fff;
    }
    .service-pill.danger{
      border-color: rgba(199,107,107,.65);
      background: rgba(199,107,107,.12);
      color:#7a2f2f;
    }
    .risk-red{border-color: rgba(199,107,107,.55); background: rgba(199,107,107,.12); color:#7a2f2f;}
    .risk-red .dot{background:var(--neg)}
    .risk-yellow{border-color: rgba(77,168,218,.35); background: rgba(77,168,218,.12); color:#254b63;}
    .risk-yellow .dot{background:var(--sky)}
    .risk-green{border-color: rgba(168,230,207,.6); background: rgba(168,230,207,.2); color:#0f4d3b;}
    .risk-green .dot{background:#4fb99f}

    .row-actions{display:flex;gap:8px;align-items:center}
    .row-actions.split{justify-content:space-between}
    .row-actions-left,.row-actions-right{display:flex;gap:8px;align-items:center}
    .row-actions .btn{white-space:nowrap}
    .contact-meta-grid{display:grid;grid-template-columns: repeat(3, minmax(0,1fr));gap:12px;align-items:start}
    .contact-meta-col{display:flex;flex-direction:column;align-items:center;text-align:center;gap:6px}
    .contact-meta-col.left{align-items:flex-start;text-align:left}
    .contact-meta-col.center{align-items:center;text-align:center}
    .contact-meta-col.right{align-items:flex-end;text-align:right}
    .contact-meta-label{font-size:11px;color:var(--muted);font-weight:800}
    .contact-meta-value{font-size:11px;color:var(--muted);font-weight:800}
    .contact-meta-actions{display:flex;gap:8px;align-items:center;justify-content:center}

    /* Drawer */
    .drawer-overlay{
      position:fixed; inset:0; background:rgba(13,59,102,.12);
      opacity:0; pointer-events:none; transition: opacity .18s ease; z-index:9000;
    }
    .drawer{
      position:fixed; right:0; top:0; height:100%;
      width:min(520px, 100%);
      background:#fff; box-shadow: -10px 0 24px rgba(13,59,102,.12);
      transform: translateX(100%); transition: transform .2s ease; z-index:9100;
      display:flex;flex-direction:column;
    }
    .drawer.open{transform: translateX(0)}
    .drawer-overlay.show{opacity:1; pointer-events:auto}
    .drawer-header{
      padding:12px 18px 10px;
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
    }
    .drawer-title{font-size:18px;font-weight:900;color:var(--navy)}
    .drawer-sub{font-size:12px;color:var(--muted);font-weight:800}
    .drawer-body{padding:10px 18px 24px; overflow:auto; display:flex; flex-direction:column; gap:12px; min-height:0}
    .drawer-body > .card{flex:0 0 auto}
    .status-strip{display:grid;grid-template-columns: repeat(5, 1fr); gap:8px}
    .drawer-divider{height:1px;background:rgba(13,59,102,.08);margin-top:10px}
    .status-pill{padding:8px 10px;border-radius:12px;border:1px solid rgba(13,59,102,.12);background:rgba(13,59,102,.03);font-size:11px;font-weight:900;color:var(--navy);text-align:center}
    .status-pill.done{background:rgba(168,230,207,.25); border-color: rgba(168,230,207,.7);}
    .status-pill.block{background:rgba(199,107,107,.12); border-color: rgba(199,107,107,.4); color:#7a2f2f;}

    .card-section{padding:12px 14px}
    .card-header{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .card-title{font-size:14px;font-weight:900;color:var(--navy)}
    .card-meta{font-size:11px;color:var(--muted);font-weight:800}
    .card-body{margin-top:10px;display:flex;flex-direction:column;gap:8px}
    .chip-row{display:flex;flex-wrap:wrap;gap:8px}
    .chip-toggle{
      display:inline-flex;align-items:center;justify-content:center;
      padding:6px 10px;border-radius:999px;border:1px solid rgba(13,59,102,.18);
      background:#fff;color:#334155;font-weight:900;font-size:11px;cursor:pointer;
      transition: border-color .15s ease, box-shadow .15s ease, background .15s ease, color .15s ease;
    }
    .chip-toggle.is-active{
      border-color: rgba(168,230,207,.95);
      box-shadow: 0 0 0 3px rgba(168,230,207,.35);
      background: rgba(168,230,207,.22);
      color: var(--navy);
    }

    .activity-log{display:flex;flex-direction:column;gap:6px;max-height:160px;overflow:auto}
    .activity-item{
      padding:8px 10px;border-radius:12px;border:1px solid rgba(13,59,102,.10);
      background:rgba(13,59,102,.03);font-size:11px;color:#1f2937;font-weight:700;
    }
    .info-grid{display:grid;grid-template-columns: repeat(2, minmax(0,1fr));gap:12px}
    .info-section{display:flex;flex-direction:column;gap:10px}
    .info-row{display:flex;flex-wrap:wrap;gap:10px}
    .info-block{
      border:1px solid rgba(13,59,102,.12);
      background:rgba(13,59,102,.03);
      border-radius:12px;
      padding:8px 10px;
    }
    .patient-card{position:relative; padding-right:36px}
    .patient-edit-btn{position:absolute; top:8px; right:8px}
    .info-label{font-size:10px;font-weight:900;color:var(--muted);letter-spacing:.08em;text-transform:uppercase}
    .info-value{margin-top:3px;font-size:12px;font-weight:800;color:var(--navy)}
    .info-note{font-size:12px;font-weight:700;color:#1f2937;line-height:1.35}
    .info-compact{display:grid;grid-template-columns: repeat(3, minmax(0,1fr));gap:10px}
    .info-compact .info-block{padding:8px 10px}
    .info-icons{display:flex;align-items:center;gap:8px;margin-top:6px}
    .info-icon{display:inline-flex;align-items:center;justify-content:center}
    .info-icon svg{width:16px;height:16px;overflow:visible}
    .info-icon.confirmed{color:#2f7a5a}
    .info-icon.pending{color:#9aa6b2}
    .info-icon.alert{color:var(--neg)}
    .info-divider{height:1px;background:rgba(13,59,102,.12);margin:10px 0}
    .contact-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:6px}
    .btn-icon.down{color:var(--neg);border-color: rgba(199,107,107,.45);}
    .btn-icon.down svg{transform: scaleY(-1);}
    .icon-plain{
      border:none;background:transparent;color:var(--navy);
      display:inline-flex;align-items:center;justify-content:center;
      padding:4px;border-radius:8px;cursor:pointer;
      transition: background .15s ease, transform .15s ease;
    }
    .icon-plain:hover{background: rgba(13,59,102,.06); transform: translateY(-1px);}
    .icon-plain svg{width:16px;height:16px;overflow:visible}
    .icon-plain svg :where(path, line, polyline, polygon, rect, circle, ellipse){
      stroke: currentColor !important; fill:none !important; stroke-width: 6.5px;
    }
    .patient-card{position:relative}
    .patient-card .patient-edit-btn{position:absolute;top:8px;right:8px}
    .edit-grid{display:grid;grid-template-columns: repeat(2, minmax(0,1fr));gap:12px}
    .edit-grid .full{grid-column:1 / -1}
    #patientEditModal .dl-modal{max-height:92vh;display:flex;flex-direction:column}
    #patientEditModal .dl-modal-body{overflow:auto;flex:1}
    #infoDrawer .drawer-body{overflow:auto;flex:1}
    #contactDrawer .drawer-body{overflow:auto;flex:1}

    .empty{padding:24px;text-align:center;color:var(--muted);font-weight:800}

    .icon-btn{
      width:42px;height:42px;border-radius:12px;border:1px solid var(--line-strong);
      background:#fff;color:var(--navy);display:inline-flex;align-items:center;justify-content:center;
      cursor:pointer;transition: box-shadow .15s ease, border-color .15s ease, transform .15s ease;
    }
    .icon-btn:hover{border-color: rgba(168,230,207,.9); box-shadow: var(--ring2); transform: translateY(-1px);}
    .icon-btn svg{width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:6.5px;stroke-linecap:round;stroke-linejoin:round}
    .icon-btn svg :where(path, line, polyline, polygon, rect, circle, ellipse){
      stroke: currentColor !important; fill:none !important; stroke-width: 6.5px;
    }
    .btn-icon{
      width:34px;height:34px;border-radius:10px;border:1px solid var(--line-strong);
      background:#fff;color:var(--navy);display:inline-flex;align-items:center;justify-content:center;
      cursor:pointer;transition: box-shadow .15s ease, border-color .15s ease, transform .15s ease;
    }
    .btn-icon:hover{border-color: rgba(168,230,207,.9); box-shadow: var(--ring2); transform: translateY(-1px);}
    .btn-icon svg{width:18px;height:18px;overflow:visible}
    .btn-icon svg :where(path, line, polyline, polygon, rect, circle, ellipse){
      stroke: currentColor !important; fill:none !important; stroke-width: 6.5px;
    }
    .btn-icon[disabled]{opacity:.78; cursor:not-allowed; box-shadow:none; transform:none;}
    .btn-icon.reached{color:#2f7a5a;border-color: rgba(47,122,90,.35);}
    .btn-icon.vm{color:var(--neg);border-color: rgba(199,107,107,.45);}
    .btn-icon.vm svg{transform: none;}
    .btn-icon.danger{color:var(--neg);border-color: rgba(199,107,107,.45);}
    .btn-icon.thumb-down svg{transform: scaleY(-1) scaleX(-1);}

    .fab-wrap{
      position:fixed;
      top:18px;
      right:18px;
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:10px;
      z-index:9200;
      transition: right .2s ease;
    }
    .drawer-open .fab-wrap{right:540px;}
    .fab-btn{
      width:44px;height:44px;border-radius:12px;
      border:1px solid rgba(124,109,138,.45);
      background:#fff;
      color:#5b4b69;
      display:inline-flex;align-items:center;justify-content:center;
      cursor:pointer;
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease, opacity .18s ease;
    }
    .fab-btn:hover{
      border-color:rgba(124,109,138,.8);
      box-shadow:0 10px 18px rgba(124,109,138,.16);
      transform: translateY(-1px);
    }
    .fab-btn.n-icon svg{width:20px;height:20px;overflow:visible}
    .fab-btn.n-icon svg :where(path, line, polyline, polygon, rect, circle, ellipse){
      stroke: currentColor !important; fill:none !important; stroke-width:6.5px;
      stroke-linecap:round; stroke-linejoin:round;
    }
    .fab-btn.asset-icon svg{width:22px;height:22px;overflow:visible}
    .fab-btn.asset-icon svg :where(path, line, polyline, polygon, rect, circle, ellipse){
      stroke: currentColor !important; fill:none !important; stroke-width:5.5px;
      stroke-linecap:round; stroke-linejoin:round;
    }
    .fab-menu{
      display:flex;
      flex-direction:column;
      gap:10px;
      transform: translateY(-6px);
      opacity:0;
      pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
    }
    .fab-wrap.open .fab-menu{
      opacity:1;
      pointer-events:auto;
      transform: translateY(0);
    }
    .fab-menu .fab-btn{transform: translateY(-6px); opacity:0;}
    .fab-wrap.open .fab-menu .fab-btn{transform: translateY(0); opacity:1;}
    .fab-wrap.open .fab-menu .fab-btn:nth-child(1){transition-delay:.02s;}
    .fab-wrap.open .fab-menu .fab-btn:nth-child(2){transition-delay:.05s;}
    .fab-wrap.open .fab-menu .fab-btn:nth-child(3){transition-delay:.08s;}
    .fab-wrap.open .fab-menu .fab-btn:nth-child(4){transition-delay:.11s;}
    .btn-icon.info{color:var(--neg);border-color: rgba(199,107,107,.45);}
    .card-expand{display:flex;justify-content:flex-end;gap:8px;margin-top:8px}

    @media (max-width: 1100px){
      .filters{grid-template-columns: 1fr 1fr; }
      .sidebar{display:none}
    }
    @media (max-width: 860px){
      .header{flex-direction:column; align-items:flex-start}
      .header-actions{width:100%}
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">
        <div class="brand-title">Coordinator Workspace</div>
        <div class="brand-sub">Test Coordinator</div>
      </div>
      <div class="queue-list" id="queueList"></div>
    </aside>

    <main class="main">

      <section class="content">
        <div class="card">
          <div class="summary" id="summaryStrip"></div>
          <div class="card-section">
            <div class="filters">
              <div class="field">
                <label>Facility</label>
                <select id="facilityFilter"></select>
              </div>
              <div class="field">
                <label>Discharge window</label>
                <select id="dateFilter">
                  <option value="all">All</option>
                  <option value="today">Today</option>
                  <option value="24">Next 24h</option>
                  <option value="72">Next 72h</option>
                </select>
              </div>
              <div class="field">
                <label>Patient search</label>
                <input class="ipt" id="searchInput" placeholder="Search patient or facility" />
              </div>
              <button class="icon-btn" id="openFilters" aria-label="Open filters">
                <svg viewBox="0 0 246.98 255.82" aria-hidden="true">
                  <line x1="137.69" y1="127.91" x2="244.23" y2="127.91"/>
                  <line x1="3.51" y1="127.91" x2="35.59" y2="127.91"/>
                  <circle cx="73.29" cy="127.91" r="34.97" transform="translate(-9.78 6.12) rotate(-4.48)"/>
                  <line x1="109.3" y1="37.72" x2="2.75" y2="37.72"/>
                  <line x1="243.47" y1="37.72" x2="211.39" y2="37.72"/>
                  <path d="M138.73,37.72c0,19.31,15.66,34.97,34.97,34.97s34.97-15.66,34.97-34.97S193.01,2.75,173.69,2.75s-34.97,15.66-34.97,34.97Z"/>
                  <line x1="109.3" y1="218.1" x2="2.75" y2="218.1"/>
                  <line x1="243.47" y1="218.1" x2="211.39" y2="218.1"/>
                  <circle cx="173.69" cy="218.1" r="34.97" transform="translate(-34.55 32.7) rotate(-9.79)"/>
                </svg>
              </button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-section">
            <div class="table-wrap">
              <table>
                <thead id="queueHead"></thead>
                <tbody id="queueTable"></tbody>
              </table>
              <div class="empty" id="emptyState" style="display:none">No patients match this queue + filter view.</div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div class="fab-wrap" id="fabWrap">
    <button class="fab-btn n-icon" id="fabToggle" aria-label="Open quick actions" title="Open quick actions">
      <svg viewBox="0 0 258.44 261.61" aria-hidden="true">
        <rect x="2.75" y="2.75" width="61.81" height="61.81" rx="10.11" ry="10.11"/>
        <rect x="98.32" y="2.75" width="61.81" height="61.81" rx="10.11" ry="10.11"/>
        <rect x="2.75" y="99.9" width="61.81" height="61.81" rx="10.11" ry="10.11"/>
        <rect x="98.32" y="99.9" width="61.81" height="61.81" rx="10.11" ry="10.11"/>
        <rect x="2.75" y="197.04" width="61.81" height="61.81" rx="10.11" ry="10.11"/>
        <rect x="193.88" y="2.75" width="61.81" height="61.81" rx="10.11" ry="10.11" transform="translate(449.57 67.31) rotate(180)"/>
        <rect x="193.88" y="99.9" width="61.81" height="61.81" rx="10.11" ry="10.11" transform="translate(449.57 261.61) rotate(180)"/>
        <rect x="193.88" y="197.04" width="61.81" height="61.81" rx="10.11" ry="10.11" transform="translate(449.57 455.9) rotate(180)"/>
        <rect x="98.32" y="197.04" width="61.81" height="61.81" rx="10.11" ry="10.11"/>
      </svg>
    </button>
    <div class="fab-menu" id="fabMenu">
      <button class="fab-btn asset-icon" title="Add Note" aria-label="Add Note">
        <svg viewBox="0 0 83.92 75.06" aria-hidden="true">
          <path d="M72.39,10.9l-35.5,35.5-3.11,11.52,11.52-3.11,35.5-35.5c2.32-2.32,2.32-6.09,0-8.41h0c-2.32-2.32-6.09-2.32-8.41,0Z"/>
          <path d="M76.73,23.71l2.11,2.11c1.49,1.49,1.49,3.91,0,5.4l-10.06,10.06"/>
          <line x1="33.77" y1="57.93" x2="30.75" y2="60.95"/>
          <polyline points="60.87 46.97 60.87 73.67 1.39 73.67 1.39 18.52 19.51 1.39 60.87 1.39 60.87 15.15"/>
          <line x1="14.38" y1="34.58" x2="39.07" y2="34.58"/>
          <line x1="14.38" y1="47.32" x2="29.52" y2="47.32"/>
          <line x1="14.38" y1="60.06" x2="25.2" y2="60.06"/>
          <polyline points="7.59 20.48 21.52 20.48 21.52 7.59"/>
          <line x1="64.14" y1="36.3" x2="55.54" y2="27.7"/>
        </svg>
      </button>
      <button class="fab-btn asset-icon" title="Send Message" aria-label="Send Message">
        <svg viewBox="0 0 78.61 75.44" aria-hidden="true">
          <path d="M49.81,50.75h-18.46c-5.19,0-9.39-4.23-9.39-9.44V10.83c0-5.22,4.2-9.44,9.39-9.44h36.47c5.19,0,9.39,4.23,9.39,9.44v30.47c0,5.22-4.2,9.44-9.39,9.44h-3.38v12.83h-.96l-13.67-12.83Z"/>
          <path d="M16.9,23.18h-7.83c-4.24,0-7.68,3.46-7.68,7.73v24.93c0,4.27,3.44,7.73,7.68,7.73h2.77v10.5h.48l11.89-10.5h12.11c4.24,0,7.68-3.46,7.68-7.73"/>
          <path d="M50.67,25.63c0,.6-.48,1.08-1.08,1.08s-1.08-.48-1.08-1.08.48-1.08,1.08-1.08,1.08.48,1.08,1.08Z"/>
          <path d="M37.87,25.63c0,.6-.48,1.08-1.08,1.08s-1.08-.48-1.08-1.08.48-1.08,1.08-1.08,1.08.48,1.08,1.08Z"/>
          <path d="M61.31,25.63c0,.6.48,1.08,1.08,1.08s1.08-.48,1.08-1.08-.48-1.08-1.08-1.08-1.08.48-1.08,1.08Z"/>
        </svg>
      </button>
      <button class="fab-btn asset-icon" title="Add Task" aria-label="Add Task">
        <svg viewBox="0 0 66.61 85.63" aria-hidden="true">
          <polyline points="51.08 15.78 65.22 15.78 65.22 84.25 1.39 84.25 1.39 15.78 15.53 15.78"/>
          <polyline points="25.06 36.76 18.86 42.95 14.82 38.91"/>
          <polyline points="25.06 49.89 18.86 56.09 14.82 52.05"/>
          <polyline points="25.06 63.03 18.86 69.23 14.82 65.18"/>
          <line x1="30.85" y1="40.39" x2="51.79" y2="40.39"/>
          <line x1="30.85" y1="53.53" x2="51.79" y2="53.53"/>
          <line x1="30.85" y1="66.66" x2="51.79" y2="66.66"/>
          <path d="M26.13,8.56v1.85h-6.13c-2.47,0-4.47,2-4.47,4.47v8.93h35.55v-8.93c0-2.47-2-4.47-4.47-4.47h-6.13v-1.85c0-3.96-3.21-7.17-7.17-7.17h0c-3.96,0-7.17,3.21-7.17,7.17Z"/>
          <line x1="33.3" y1="8.95" x2="33.3" y2="11.95"/>
        </svg>
      </button>
      <button class="fab-btn asset-icon" title="Care Team" aria-label="Care Team">
        <svg viewBox="0 0 81.27 77.16" aria-hidden="true">
          <path d="M49.7,34.62c0,17.78.06,27.65-1.86,41.15h-14.41c-1.92-13.5-1.86-23.37-1.86-41.15"/>
          <path d="M31.56,50.44h0s-2.42,0-2.42,0c-2.58,0-4.66-2.09-4.66-4.66v-18.08h0s5.34-4.56,16.16-4.56,16.1,4.51,16.16,4.56v18.08c0,2.58-2.09,4.66-4.66,4.66h-2.42"/>
          <line x1="40.63" y1="75.42" x2="40.63" y2="53.23"/>
          <path d="M47.77,8.92c0,4.78-3.15,8.53-7.03,8.53s-7.03-3.75-7.03-8.53,3.15-7.53,7.03-7.53,7.03,2.76,7.03,7.53Z"/>
          <path d="M24.38,54.85c0,7.83-.53,13-1.63,20.69h-13.18c-1.76-12.35-1.7-21.37-1.7-37.63"/>
          <path d="M7.87,52.37h0s-2.22,0-2.22,0c-2.36,0-4.27-1.91-4.27-4.27v-16.53h0s4.88-4.17,14.77-4.17h2.77"/>
          <line x1="16.16" y1="75.26" x2="16.16" y2="54.93"/>
          <path d="M22.69,13.91c0,4.37-2.88,7.8-6.43,7.8s-6.43-3.43-6.43-7.8,2.88-6.89,6.43-6.89,6.43,2.52,6.43,6.89Z"/>
          <path d="M56.89,54.85c0,7.83.53,13,1.63,20.69h13.18c1.76-12.35,1.7-21.37,1.7-37.63"/>
          <path d="M73.4,52.37h0s2.22,0,2.22,0c2.36,0,4.27-1.91,4.27-4.27v-16.53h0s-4.88-4.17-14.77-4.17h-2.89"/>
          <line x1="65.1" y1="75.26" x2="65.1" y2="54.93"/>
          <path d="M58.58,13.91c0,4.37,2.88,7.8,6.43,7.8s6.43-3.43,6.43-7.8-2.88-6.89-6.43-6.89-6.43,2.52-6.43,6.89Z"/>
        </svg>
      </button>
    </div>
  </div>

  <div class="drawer-overlay" id="drawerOverlay"></div>
  <aside class="drawer" id="patientDrawer"></aside>
  <aside class="drawer" id="infoDrawer"></aside>
  <aside class="drawer" id="contactDrawer"></aside>

  <div class="dl-modal-overlay" id="warningModal">
    <div class="dl-modal">
      <div class="dl-modal-bar">
        <span>Patient Not Reached</span>
        <button class="btn btn-ghost btn-small" data-close="warningModal">Close</button>
      </div>
      <div class="dl-modal-body">
        <p style="margin:0 0 10px;font-weight:800;color:var(--navy)">Patient has not been reached. Continue sending referral?</p>
        <label>Reason (mock)</label>
        <select id="warningReason">
          <option>Discharge imminent</option>
          <option>Facility request</option>
          <option>Orders pending but need head start</option>
          <option>Other</option>
        </select>
      </div>
      <div class="dl-modal-actions">
        <button class="btn" data-close="warningModal">Cancel</button>
        <button class="btn btn-primary" id="warningContinue">Continue</button>
      </div>
    </div>
  </div>

  <div class="dl-modal-overlay" id="faxModal">
    <div class="dl-modal">
      <div class="dl-modal-bar">
        <span id="faxModalTitle">Send Referral</span>
        <button class="btn btn-ghost btn-small" data-close="faxModal">Close</button>
      </div>
      <div class="dl-modal-body" id="faxModalBody"></div>
      <div class="dl-modal-actions">
        <label style="margin-right:auto;font-size:12px;font-weight:800;color:var(--muted)">
          <input type="checkbox" id="simulateFail" /> Simulate failure
        </label>
        <button class="btn" data-close="faxModal">Cancel</button>
        <button class="btn btn-primary" id="faxConfirm">Confirm</button>
      </div>
    </div>
  </div>

  <div class="dl-modal-overlay" id="docsModal">
    <div class="dl-modal">
      <div class="dl-modal-bar">
        <span>Docs Checklist Incomplete</span>
        <button class="btn btn-ghost btn-small" data-close="docsModal">Close</button>
      </div>
      <div class="dl-modal-body" id="docsModalBody"></div>
      <div class="dl-modal-actions">
        <button class="btn btn-primary" data-close="docsModal">Got it</button>
      </div>
    </div>
  </div>

  <div class="dl-modal-overlay" id="patientEditModal">
    <div class="dl-modal" style="width:min(820px, 100%)">
      <div class="dl-modal-bar">
        <span>Edit Patient Details</span>
        <button class="btn btn-ghost btn-small" data-close="patientEditModal">Close</button>
      </div>
      <div class="dl-modal-body">
        <div class="edit-grid">
          <div>
            <label>First Name</label>
            <input class="ipt" id="ep_first_name" />
          </div>
          <div>
            <label>Last Name</label>
            <input class="ipt" id="ep_last_name" />
          </div>
          <div>
            <label>DOB</label>
            <input class="ipt" id="ep_dob" placeholder="YYYY-MM-DD or MM/DD/YYYY" />
          </div>
          <div>
            <label>Gender</label>
            <input class="ipt" id="ep_gender" placeholder="M/F/Other" />
          </div>
          <div>
            <label>Phone 1</label>
            <input class="ipt" id="ep_phone1" />
          </div>
          <div>
            <label>Phone 2</label>
            <input class="ipt" id="ep_phone2" />
          </div>
          <div>
            <label>Email</label>
            <input class="ipt" id="ep_email" />
          </div>
          <div>
            <label>Email 2</label>
            <input class="ipt" id="ep_email2" />
          </div>
          <div>
            <label>Address 1</label>
            <input class="ipt" id="ep_address1" />
          </div>
          <div>
            <label>Address 2</label>
            <input class="ipt" id="ep_address2" />
          </div>
          <div>
            <label>City</label>
            <input class="ipt" id="ep_city" />
          </div>
          <div>
            <label>State</label>
            <input class="ipt" id="ep_state" />
          </div>
          <div>
            <label>Zip</label>
            <input class="ipt" id="ep_zip" />
          </div>
          <div>
            <label>Insurance Name 1</label>
            <input class="ipt" id="ep_insurance_name1" />
          </div>
          <div>
            <label>Insurance Number 1</label>
            <input class="ipt" id="ep_insurance_number1" />
          </div>
          <div>
            <label>Insurance Name 2</label>
            <input class="ipt" id="ep_insurance_name2" />
          </div>
          <div>
            <label>Insurance Number 2</label>
            <input class="ipt" id="ep_insurance_number2" />
          </div>
          <div class="full">
            <label>Notes 1</label>
            <textarea class="ipt" id="ep_notes1" rows="3"></textarea>
          </div>
          <div class="full">
            <label>Notes 2</label>
            <textarea class="ipt" id="ep_notes2" rows="3"></textarea>
          </div>
          <div>
            <label>External Patient ID</label>
            <input class="ipt" id="ep_external_patient_id" />
          </div>
          <div>
            <label>MRN</label>
            <input class="ipt" id="ep_mrn" />
          </div>
          <div>
            <label>Source</label>
            <input class="ipt" id="ep_source" placeholder="manual" />
          </div>
          <div>
            <label>Active</label>
            <select class="ipt" id="ep_active">
              <option value="1">Yes (Active)</option>
              <option value="0">No (Inactive)</option>
            </select>
          </div>
        </div>
      </div>
      <div class="dl-modal-actions">
        <button class="btn btn-primary" id="ep_save">Save Patient</button>
      </div>
    </div>
  </div>

  <div class="dl-modal-overlay" id="dcDetailsModal">
    <div class="dl-modal" style="width:min(860px, 100%)">
      <div class="dl-modal-bar">
        <span>Discharge Details</span>
        <button class="btn btn-ghost btn-small" data-close="dcDetailsModal">Close</button>
      </div>
      <div class="dl-modal-body" id="dcDetailsBody"></div>
      <div class="dl-modal-actions">
        <button class="btn btn-primary" data-close="dcDetailsModal">Done</button>
      </div>
    </div>
  </div>

  <div class="dl-modal-overlay" id="filtersModal">
    <div class="dl-modal">
      <div class="dl-modal-bar">
        <span>Filters & Sorting</span>
        <button class="btn btn-ghost btn-small" data-close="filtersModal">Close</button>
      </div>
      <div class="dl-modal-body">
        <div class="field" style="margin-bottom:12px">
          <label>Sort</label>
          <select id="sortFilter">
            <option value="discharge">Earliest discharge</option>
            <option value="risk">Risk (red > yellow > green)</option>
          </select>
        </div>
        <label class="toggle" style="width:max-content">
          <input type="checkbox" id="toggleOffPortal" />
          Only Off-Portal Work
        </label>
        <label class="toggle" style="width:max-content;margin-top:10px">
          <input type="checkbox" id="toggleAtRisk" />
          Show only At Risk
        </label>
      </div>
      <div class="dl-modal-actions">
        <button class="btn btn-primary" data-close="filtersModal">Done</button>
      </div>
    </div>
  </div>

  <div class="dl-modal-overlay" id="noteDetailsModal">
    <div class="dl-modal">
      <div class="dl-modal-bar">
        <span id="noteDetailsTitle">Complete Note</span>
        <button class="btn btn-ghost btn-small" data-close="noteDetailsModal">Close</button>
      </div>
      <div class="dl-modal-body" id="noteDetailsBody"></div>
      <div class="dl-modal-actions">
        <button class="btn btn-ghost" data-close="noteDetailsModal">Cancel</button>
        <button class="btn btn-primary" id="noteDetailsSave">Save</button>
      </div>
    </div>
  </div>

  <div class="dl-toast" id="toast">
    <div class="dl-toast-top">
      <div>
        <div class="dl-toast-title" id="toastTitle">Toast</div>
        <div class="dl-toast-sub" id="toastSub">Details</div>
      </div>
      <button class="dl-toast-close" id="toastClose">âœ•</button>
    </div>
    <div class="dl-toast-actions" id="toastActions">
      <button class="btn btn-small" id="toastActionBtn">Complete details</button>
    </div>
  </div>
  <script>
    const now = new Date();
    const hoursFromNow = (h) => new Date(now.getTime() + h * 3600 * 1000).toISOString();
    const daysFromNow = (d) => new Date(now.getTime() + d * 24 * 3600 * 1000).toISOString();

    const withInfo = (p) => {
      const [firstName = "", ...rest] = (p.name || "").split(" ");
      const lastName = rest.join(" ");
      return ({
      dob: "1947-05-12",
      phoneNumbers: {
        mobile: "(555) 238-4471",
        home: "(555) 204-1182",
        caregiver: "(555) 390-2215"
      },
      address: {
        line1: "2214 W Grove St",
        line2: "Apt 3B",
        city: "Hillside",
        state: "OH",
        zip: "44118"
      },
      dcSubmission: {
        dcDate: "2026-02-01",
        dcTime: "14:30",
        dcConfirmed: true,
        dcUrgent: false,
        urgentComments: "",
        disposition: "Home",
        destinationComments: "",
        dcWith: "spouse",
        hhServices: ["RN","PT","SW"],
        hhOtherServices: [],
        hhComments: "Family prefers morning SOC visit.",
        hhAgency: "Harmony Home Health",
        hhAgencyComments: "",
        dmeServices: ["RW","Commode","O2"],
        dmeOtherServices: [],
        dmeComments: "O2 delivery required before discharge.",
        pcpName: "Dr. Karen Liu",
        coordinateCaregiver: true,
        caregiverName: "Maya Hart",
        caregiverNumber: "(555) 390-2215",
        appealingDc: false,
        appealComments: ""
      },
      patientDetails: {
        firstName,
        lastName,
        dob: "1947-05-12",
        gender: "",
        phone1: "(555) 238-4471",
        phone2: "(555) 204-1182",
        email: "",
        email2: "",
        address1: "2214 W Grove St",
        address2: "Apt 3B",
        city: "Hillside",
        state: "OH",
        zip: "44118",
        insuranceName1: "",
        insuranceNumber1: "",
        insuranceName2: "",
        insuranceNumber2: "",
        notes1: "",
        notes2: "",
        externalPatientId: "",
        mrn: p.mrn || "",
        source: "manual",
        active: "1"
      },
      ...p,
      phoneNumbers: { ...{
        mobile: "(555) 238-4471",
        home: "(555) 204-1182",
        caregiver: "(555) 390-2215"
      }, ...(p.phoneNumbers || {}) },
      address: { ...{
        line1: "2214 W Grove St",
        line2: "Apt 3B",
        city: "Hillside",
        state: "OH",
        zip: "44118"
      }, ...(p.address || {}) },
      dcSubmission: { ...{
        dcDate: "2026-02-01",
        dcTime: "14:30",
        dcConfirmed: true,
        dcUrgent: false,
        urgentComments: "",
        disposition: "Home",
        destinationComments: "",
        dcWith: "spouse",
        hhServices: ["RN","PT","SW"],
        hhOtherServices: [],
        hhComments: "Family prefers morning SOC visit.",
        hhAgency: "Harmony Home Health",
        hhAgencyComments: "",
        dmeServices: ["RW","Commode","O2"],
        dmeOtherServices: [],
        dmeComments: "O2 delivery required before discharge.",
        pcpName: "Dr. Karen Liu",
        coordinateCaregiver: true,
        caregiverName: "Maya Hart",
        caregiverNumber: "(555) 390-2215",
        appealingDc: false,
        appealComments: ""
      }, ...(p.dcSubmission || {}) },
      patientDetails: { ...{
        firstName,
        lastName,
        dob: "1947-05-12",
        gender: "",
        phone1: "(555) 238-4471",
        phone2: "(555) 204-1182",
        email: "",
        email2: "",
        address1: "2214 W Grove St",
        address2: "Apt 3B",
        city: "Hillside",
        state: "OH",
        zip: "44118",
        insuranceName1: "",
        insuranceNumber1: "",
        insuranceName2: "",
        insuranceNumber2: "",
        notes1: "",
        notes2: "",
        externalPatientId: "",
        mrn: p.mrn || "",
        source: "manual",
        active: "1"
      }, ...(p.patientDetails || {}) }
    });
    };

    const rawPatients = [
      {
        id:"P-1001", mrn:"MRN-20415", name:"Lena Hart", age:78, facilityName:"Riverbend SNF",
        dischargeDateTime: hoursFromNow(4),
        servicesNeeded:{homeHealth:true, dme:false},
        portalEligibility:{homeHealthOnPortal:true, dmeOnPortal:false, physicianOnEsign:true},
        contactStatus:"attempted_vm", contactAttempts:1, lastContactAttemptAt: hoursFromNow(-3), nextContactDueAt: hoursFromNow(2),
        docsStatus:"in_progress", docsChecklist:{faceSheet:true, orders:false, clinicals:false}, packetGenerated:false,
        referrals:{homeHealth:{referralStatus:"not_sent", lastSentAt:null, faxStatus:"n/a"}, dme:{referralStatus:"not_required"}},
        pcpApptNeeded:true,
        ordersStatus:"pending", ordersLastNudgeAt: hoursFromNow(-26), ordersNudgeCount:2,
        lockStatus:"not_ready", startOfCareDate:null,
        activityLog:["01/29 2:10pm - Left VM (Attempt 1)","01/29 2:25pm - Docs uploaded: Face sheet"]
      },
      {
        id:"P-1002", mrn:"MRN-38742", name:"Marcos Reed", age:66, facilityName:"Summit Rehab",
        dischargeDateTime: hoursFromNow(30),
        servicesNeeded:{homeHealth:true, dme:true},
        portalEligibility:{homeHealthOnPortal:false, dmeOnPortal:false, physicianOnEsign:false},
        contactStatus:"not_attempted", contactAttempts:0, lastContactAttemptAt:null, nextContactDueAt:null,
        docsStatus:"not_started", docsChecklist:{faceSheet:false, orders:false, clinicals:false}, packetGenerated:false,
        referrals:{homeHealth:{referralStatus:"not_sent", lastSentAt:null, faxStatus:"n/a"}, dme:{referralStatus:"not_sent", lastSentAt:null, faxStatus:"n/a"}},
        pcpApptNeeded:false,
        ordersStatus:"not_required", ordersLastNudgeAt:null, ordersNudgeCount:0,
        lockStatus:"not_ready", startOfCareDate:null,
        activityLog:["01/29 9:05am - Intake created"]
      },
      {
        id:"P-1003", mrn:"MRN-55401", name:"Raj Shah", age:72, facilityName:"Northlake Post Acute",
        dischargeDateTime: hoursFromNow(10),
        servicesNeeded:{homeHealth:true, dme:false},
        portalEligibility:{homeHealthOnPortal:false, dmeOnPortal:false, physicianOnEsign:true},
        contactStatus:"attempted_vm", contactAttempts:1, lastContactAttemptAt: hoursFromNow(-5), nextContactDueAt: hoursFromNow(1),
        docsStatus:"complete", docsChecklist:{faceSheet:true, orders:true, clinicals:true}, packetGenerated:true,
        referrals:{homeHealth:{referralStatus:"not_sent", lastSentAt:null, faxStatus:"n/a"}, dme:{referralStatus:"not_required"}},
        pcpApptNeeded:true,
        ordersStatus:"pending", ordersLastNudgeAt: hoursFromNow(-3), ordersNudgeCount:1,
        lockStatus:"not_ready", startOfCareDate:null,
        activityLog:["01/29 1:10pm - Docs marked complete"]
      },
      {
        id:"P-1004", mrn:"MRN-19203", name:"Walter King", age:83, facilityName:"Cedar Grove SNF",
        dischargeDateTime: hoursFromNow(60),
        servicesNeeded:{homeHealth:false, dme:true},
        portalEligibility:{homeHealthOnPortal:false, dmeOnPortal:true, physicianOnEsign:true},
        contactStatus:"reached", contactAttempts:1, lastContactAttemptAt: hoursFromNow(-7), nextContactDueAt:null,
        docsStatus:"in_progress", docsChecklist:{faceSheet:true, orders:true, clinicals:false}, packetGenerated:false,
        referrals:{homeHealth:{referralStatus:"not_required"}, dme:{referralStatus:"not_sent", lastSentAt:null, faxStatus:"n/a"}},
        pcpApptNeeded:false,
        ordersStatus:"not_required", ordersLastNudgeAt:null, ordersNudgeCount:0,
        lockStatus:"not_ready", startOfCareDate:null,
        activityLog:["01/28 4:20pm - Patient reached"]
      },
      {
        id:"P-1005", mrn:"MRN-77102", name:"Dana Ortiz", age:70, facilityName:"Pinecrest Medical",
        dischargeDateTime: hoursFromNow(8),
        servicesNeeded:{homeHealth:true, dme:false},
        portalEligibility:{homeHealthOnPortal:true, dmeOnPortal:false, physicianOnEsign:true},
        contactStatus:"reached", contactAttempts:1, lastContactAttemptAt: hoursFromNow(-6), nextContactDueAt:null,
        docsStatus:"complete", docsChecklist:{faceSheet:true, orders:true, clinicals:true}, packetGenerated:true,
        referrals:{homeHealth:{referralStatus:"not_sent", lastSentAt:null, faxStatus:"n/a"}, dme:{referralStatus:"not_required"}},
        pcpApptNeeded:true,
        ordersStatus:"signed", ordersLastNudgeAt:null, ordersNudgeCount:0,
        lockStatus:"not_ready", startOfCareDate: daysFromNow(2),
        activityLog:["01/29 10:12am - Docs marked complete"]
      },
      {
        id:"P-1006", mrn:"MRN-82910", name:"Simone Clarke", age:61, facilityName:"Riverbend SNF",
        dischargeDateTime: hoursFromNow(6),
        servicesNeeded:{homeHealth:true, dme:false},
        portalEligibility:{homeHealthOnPortal:true, dmeOnPortal:false, physicianOnEsign:true},
        contactStatus:"reached", contactAttempts:1, lastContactAttemptAt: hoursFromNow(-9), nextContactDueAt:null,
        docsStatus:"complete", docsChecklist:{faceSheet:true, orders:true, clinicals:true}, packetGenerated:true,
        referrals:{homeHealth:{referralStatus:"sent", lastSentAt: hoursFromNow(-12), faxStatus:"n/a"}, dme:{referralStatus:"not_required"}},
        pcpApptNeeded:false,
        ordersStatus:"pending", ordersLastNudgeAt: hoursFromNow(-5), ordersNudgeCount:1,
        lockStatus:"not_ready", startOfCareDate:null,
        activityLog:["01/29 8:40am - Portal referral sent to Bright HH"]
      },
      {
        id:"P-1007", mrn:"MRN-45519", name:"Paul Young", age:75, facilityName:"Oak Valley SNF",
        dischargeDateTime: hoursFromNow(20),
        servicesNeeded:{homeHealth:true, dme:false},
        portalEligibility:{homeHealthOnPortal:false, dmeOnPortal:false, physicianOnEsign:false},
        contactStatus:"reached", contactAttempts:1, lastContactAttemptAt: hoursFromNow(-12), nextContactDueAt:null,
        docsStatus:"complete", docsChecklist:{faceSheet:true, orders:true, clinicals:true}, packetGenerated:true,
        referrals:{homeHealth:{referralStatus:"sent", lastSentAt: hoursFromNow(-4), faxStatus:"failed"}, dme:{referralStatus:"not_required"}},
        pcpApptNeeded:true,
        ordersStatus:"pending", ordersLastNudgeAt: hoursFromNow(-2), ordersNudgeCount:1,
        lockStatus:"not_ready", startOfCareDate:null,
        activityLog:["01/29 12:55pm - Fax failed to ABC Home Health"]
      },
      {
        id:"P-1008", mrn:"MRN-90412", name:"Mei Chen", age:82, facilityName:"Summit Rehab",
        dischargeDateTime: hoursFromNow(2),
        servicesNeeded:{homeHealth:true, dme:false},
        portalEligibility:{homeHealthOnPortal:false, dmeOnPortal:false, physicianOnEsign:true},
        contactStatus:"not_reachable_final", contactAttempts:2, lastContactAttemptAt: hoursFromNow(-2), nextContactDueAt:null,
        docsStatus:"in_progress", docsChecklist:{faceSheet:true, orders:false, clinicals:false}, packetGenerated:false,
        referrals:{homeHealth:{referralStatus:"not_sent", lastSentAt:null, faxStatus:"n/a"}, dme:{referralStatus:"not_required"}},
        pcpApptNeeded:false,
        ordersStatus:"pending", ordersLastNudgeAt: hoursFromNow(-6), ordersNudgeCount:1,
        lockStatus:"not_ready", startOfCareDate:null,
        activityLog:["01/29 3:30pm - Left VM (Attempt 2)"]
      },
      {
        id:"P-1009", mrn:"MRN-66320", name:"Isaac Patel", age:59, facilityName:"Lakeside SNF",
        dischargeDateTime: hoursFromNow(48),
        servicesNeeded:{homeHealth:true, dme:false},
        portalEligibility:{homeHealthOnPortal:true, dmeOnPortal:false, physicianOnEsign:true},
        contactStatus:"reached", contactAttempts:1, lastContactAttemptAt: hoursFromNow(-20), nextContactDueAt:null,
        docsStatus:"complete", docsChecklist:{faceSheet:true, orders:true, clinicals:true}, packetGenerated:true,
        referrals:{homeHealth:{referralStatus:"accepted", lastSentAt: hoursFromNow(-18), faxStatus:"n/a"}, dme:{referralStatus:"not_required"}},
        pcpApptNeeded:false,
        ordersStatus:"signed", ordersLastNudgeAt: null, ordersNudgeCount:0,
        lockStatus:"ready", startOfCareDate: daysFromNow(3),
        activityLog:["01/28 5:10pm - Referral accepted by Harmony HH"]
      },
      {
        id:"P-1010", mrn:"MRN-21844", name:"Nora Blake", age:67, facilityName:"Northlake Post Acute",
        dischargeDateTime: hoursFromNow(-5),
        servicesNeeded:{homeHealth:false, dme:false},
        portalEligibility:{homeHealthOnPortal:false, dmeOnPortal:false, physicianOnEsign:true},
        contactStatus:"reached", contactAttempts:1, lastContactAttemptAt: hoursFromNow(-30), nextContactDueAt:null,
        docsStatus:"complete", docsChecklist:{faceSheet:true, orders:true, clinicals:true}, packetGenerated:true,
        referrals:{homeHealth:{referralStatus:"not_required"}, dme:{referralStatus:"not_required"}},
        pcpApptNeeded:false,
        ordersStatus:"signed", ordersLastNudgeAt:null, ordersNudgeCount:0,
        lockStatus:"complete", startOfCareDate:null,
        activityLog:["01/28 10:20am - Marked complete"]
      },
      {
        id:"P-1011", mrn:"MRN-11893", name:"Jorge Alvarez", age:71, facilityName:"Cedar Grove SNF",
        dischargeDateTime: hoursFromNow(12),
        servicesNeeded:{homeHealth:false, dme:true},
        portalEligibility:{homeHealthOnPortal:false, dmeOnPortal:false, physicianOnEsign:true},
        contactStatus:"reached", contactAttempts:1, lastContactAttemptAt: hoursFromNow(-7), nextContactDueAt:null,
        docsStatus:"complete", docsChecklist:{faceSheet:true, orders:true, clinicals:true}, packetGenerated:true,
        referrals:{homeHealth:{referralStatus:"not_required"}, dme:{referralStatus:"not_sent", lastSentAt:null, faxStatus:"n/a"}},
        pcpApptNeeded:true,
        ordersStatus:"signed", ordersLastNudgeAt:null, ordersNudgeCount:0,
        lockStatus:"not_ready", startOfCareDate:null,
        activityLog:["01/29 9:40am - DME referral queued"]
      },
      {
        id:"P-1012", mrn:"MRN-77993", name:"Tessa Gray", age:63, facilityName:"Pinecrest Medical",
        dischargeDateTime: hoursFromNow(72),
        servicesNeeded:{homeHealth:true, dme:false},
        portalEligibility:{homeHealthOnPortal:true, dmeOnPortal:false, physicianOnEsign:true},
        contactStatus:"reached", contactAttempts:1, lastContactAttemptAt: hoursFromNow(-10), nextContactDueAt:null,
        docsStatus:"complete", docsChecklist:{faceSheet:true, orders:true, clinicals:true}, packetGenerated:true,
        referrals:{homeHealth:{referralStatus:"sent", lastSentAt: hoursFromNow(-30), faxStatus:"n/a"}, dme:{referralStatus:"not_required"}},
        pcpApptNeeded:false,
        ordersStatus:"pending", ordersLastNudgeAt: hoursFromNow(-20), ordersNudgeCount:1,
        lockStatus:"not_ready", startOfCareDate:null,
        activityLog:["01/28 2:10pm - Portal referral sent to Northside HH"]
      },
      {
        id:"P-1013", mrn:"MRN-99410", name:"Omar Nassar", age:69, facilityName:"Riverbend SNF",
        dischargeDateTime: hoursFromNow(18),
        servicesNeeded:{homeHealth:true, dme:false},
        portalEligibility:{homeHealthOnPortal:true, dmeOnPortal:false, physicianOnEsign:true},
        contactStatus:"reached", contactAttempts:1, lastContactAttemptAt: hoursFromNow(-14), nextContactDueAt:null,
        docsStatus:"complete", docsChecklist:{faceSheet:true, orders:true, clinicals:true}, packetGenerated:true,
        referrals:{homeHealth:{referralStatus:"accepted", lastSentAt: hoursFromNow(-16), faxStatus:"n/a"}, dme:{referralStatus:"not_required"}},
        pcpApptNeeded:true,
        ordersStatus:"pending", ordersLastNudgeAt: hoursFromNow(-30), ordersNudgeCount:2,
        lockStatus:"not_ready", startOfCareDate: daysFromNow(2),
        activityLog:["01/28 3:55pm - Referral accepted by Hometown HH"]
      },
      {
        id:"P-1014", mrn:"MRN-44750", name:"Elise Brooks", age:74, facilityName:"Summit Rehab",
        dischargeDateTime: hoursFromNow(26),
        servicesNeeded:{homeHealth:true, dme:false},
        portalEligibility:{homeHealthOnPortal:false, dmeOnPortal:false, physicianOnEsign:true},
        contactStatus:"attempted_vm", contactAttempts:1, lastContactAttemptAt: hoursFromNow(-2), nextContactDueAt: hoursFromNow(1),
        docsStatus:"not_started", docsChecklist:{faceSheet:false, orders:false, clinicals:false}, packetGenerated:false,
        referrals:{homeHealth:{referralStatus:"not_sent", lastSentAt:null, faxStatus:"n/a"}, dme:{referralStatus:"not_required"}},
        pcpApptNeeded:false,
        ordersStatus:"not_required", ordersLastNudgeAt:null, ordersNudgeCount:0,
        lockStatus:"not_ready", startOfCareDate:null,
        activityLog:["01/29 1:40pm - Left VM (Attempt 1)"]
      },
      {
        id:"P-1015", mrn:"MRN-55238", name:"Henry Soto", age:65, facilityName:"Lakeside SNF",
        dischargeDateTime: hoursFromNow(6),
        servicesNeeded:{homeHealth:true, dme:false},
        portalEligibility:{homeHealthOnPortal:true, dmeOnPortal:false, physicianOnEsign:false},
        contactStatus:"reached", contactAttempts:1, lastContactAttemptAt: hoursFromNow(-9), nextContactDueAt:null,
        docsStatus:"complete", docsChecklist:{faceSheet:true, orders:true, clinicals:true}, packetGenerated:true,
        referrals:{homeHealth:{referralStatus:"accepted", lastSentAt: hoursFromNow(-12), faxStatus:"n/a"}, dme:{referralStatus:"not_required"}},
        pcpApptNeeded:true,
        ordersStatus:"exception_off_portal", ordersLastNudgeAt:null, ordersNudgeCount:0,
        lockStatus:"ready", startOfCareDate: daysFromNow(1),
        activityLog:["01/29 8:05am - Exception documented (off-portal)"]
      }
    ];
    let patients = rawPatients.map(withInfo);

    const queues = [
      { id:"intake", label:"New / Intake" },
      { id:"docs", label:"Prep & Docs" },
      { id:"referrals", label:"Referrals to Send" },
      { id:"awaiting", label:"Awaiting Orders" },
      { id:"pcp", label:"PCP Appts" },
      { id:"ready", label:"Ready / Complete" },
      { id:"urgent", label:"Urgent / Needs Attention" },
      { id:"allTransitions", label:"All Transitions" }
    ];

    let activeQueue = "intake";
    let selectedPatientId = null;
    let pendingReferral = null;
    let editingPatientId = null;

    const queueListEl = document.getElementById("queueList");
    const queueHeadEl = document.getElementById("queueHead");
    const queueTableEl = document.getElementById("queueTable");
    const summaryStripEl = document.getElementById("summaryStrip");
    const emptyStateEl = document.getElementById("emptyState");
    const searchInputEl = document.getElementById("searchInput");
    const facilityFilterEl = document.getElementById("facilityFilter");
    const dateFilterEl = document.getElementById("dateFilter");
    const sortFilterEl = document.getElementById("sortFilter");
    const toggleAtRiskEl = document.getElementById("toggleAtRisk");
    const toggleOffPortalEl = document.getElementById("toggleOffPortal");
    const openFiltersEl = document.getElementById("openFilters");
    const filtersModalEl = document.getElementById("filtersModal");
    const infoDrawerEl = document.getElementById("infoDrawer");
    const contactDrawerEl = document.getElementById("contactDrawer");
    const patientEditModalEl = document.getElementById("patientEditModal");
    const epFirstNameEl = document.getElementById("ep_first_name");
    const epLastNameEl = document.getElementById("ep_last_name");
    const epDobEl = document.getElementById("ep_dob");
    const epGenderEl = document.getElementById("ep_gender");
    const epPhone1El = document.getElementById("ep_phone1");
    const epPhone2El = document.getElementById("ep_phone2");
    const epEmailEl = document.getElementById("ep_email");
    const epEmail2El = document.getElementById("ep_email2");
    const epAddress1El = document.getElementById("ep_address1");
    const epAddress2El = document.getElementById("ep_address2");
    const epCityEl = document.getElementById("ep_city");
    const epStateEl = document.getElementById("ep_state");
    const epZipEl = document.getElementById("ep_zip");
    const epInsuranceName1El = document.getElementById("ep_insurance_name1");
    const epInsuranceNumber1El = document.getElementById("ep_insurance_number1");
    const epInsuranceName2El = document.getElementById("ep_insurance_name2");
    const epInsuranceNumber2El = document.getElementById("ep_insurance_number2");
    const epNotes1El = document.getElementById("ep_notes1");
    const epNotes2El = document.getElementById("ep_notes2");
    const epExternalPatientIdEl = document.getElementById("ep_external_patient_id");
    const epMrnEl = document.getElementById("ep_mrn");
    const epSourceEl = document.getElementById("ep_source");
    const epActiveEl = document.getElementById("ep_active");
    const epSaveEl = document.getElementById("ep_save");
    const dcDetailsModalEl = document.getElementById("dcDetailsModal");
    const dcDetailsBodyEl = document.getElementById("dcDetailsBody");

    const drawerEl = document.getElementById("patientDrawer");
    const drawerOverlayEl = document.getElementById("drawerOverlay");
    const fabWrapEl = document.getElementById("fabWrap");
    const fabToggleEl = document.getElementById("fabToggle");

    const warningModalEl = document.getElementById("warningModal");
    const warningContinueEl = document.getElementById("warningContinue");
    const warningReasonEl = document.getElementById("warningReason");

    const faxModalEl = document.getElementById("faxModal");
    const faxModalTitleEl = document.getElementById("faxModalTitle");
    const faxModalBodyEl = document.getElementById("faxModalBody");
    const faxConfirmEl = document.getElementById("faxConfirm");
    const simulateFailEl = document.getElementById("simulateFail");

    const docsModalEl = document.getElementById("docsModal");
    const docsModalBodyEl = document.getElementById("docsModalBody");

    const toastEl = document.getElementById("toast");
    const toastTitleEl = document.getElementById("toastTitle");
    const toastSubEl = document.getElementById("toastSub");
    const toastCloseEl = document.getElementById("toastClose");
    const toastActionsEl = document.getElementById("toastActions");
    const toastActionBtnEl = document.getElementById("toastActionBtn");
    const noteDetailsModalEl = document.getElementById("noteDetailsModal");
    const noteDetailsTitleEl = document.getElementById("noteDetailsTitle");
    const noteDetailsBodyEl = document.getElementById("noteDetailsBody");
    const noteDetailsSaveEl = document.getElementById("noteDetailsSave");

    const token = () => (localStorage.getItem("sensys_token") || "").trim();
    const authHeaders = () => ({ "Authorization": "Bearer " + token() });
    const WORKSPACE_KEY = "evolv_snf";
    const ATTEMPT_TEMPLATE_ID = 2;
    const ATTEMPT_NOTE_NAME = "Log Call Attempts";
    const REACHED_TEMPLATE_ID = 3;
    const REACHED_NOTE_NAME = "Evolv SNF - Initial Call Default";
    const REACHED_FIELD_KEY = "patient_contact_default";
    const REACHED_ANSWER = "Spoke to patient and educated on next steps in discharge planning process.";

    const formatDateTime = (iso) => new Intl.DateTimeFormat("en-US", {
      month:"short", day:"numeric", hour:"numeric", minute:"2-digit"
    }).format(new Date(iso));
    const formatDate = (iso) => new Intl.DateTimeFormat("en-US", {
      month:"short", day:"numeric"
    }).format(new Date(iso));
    const formatDob = (iso) => new Intl.DateTimeFormat("en-US", {
      month:"2-digit", day:"2-digit", year:"numeric"
    }).format(new Date(iso));
    const formatDateShort = (iso) => new Intl.DateTimeFormat("en-US", {
      month:"2-digit", day:"2-digit", year:"2-digit"
    }).format(new Date(iso));
    const formatStamp = (date) => new Intl.DateTimeFormat("en-US", {
      month:"2-digit", day:"2-digit", hour:"numeric", minute:"2-digit"
    }).format(date).replace(",", "");
    const formatDischargeDisplay = (iso) => {
      const date = new Date(iso);
      const dayLabel = new Intl.DateTimeFormat("en-US", {
        weekday:"short", month:"numeric", day:"numeric"
      }).format(date);
      const diffDays = Math.ceil((date.getTime() - Date.now()) / 86400000);
      const suffix = diffDays < 0 ? "overdue" : diffDays === 0 ? "today" : diffDays === 1 ? "1 day" : `${diffDays} days`;
      return `${dayLabel} (${suffix})`;
    };
    const formatDcDay = (iso) => {
      const date = new Date(iso);
      const dayLabel = new Intl.DateTimeFormat("en-US", { weekday:"short" }).format(date);
      const diffMs = date.getTime() - Date.now();
      const diffDays = diffMs >= 0 ? Math.ceil(diffMs / 86400000) : Math.floor(diffMs / 86400000);
      const suffix = diffDays === 0 ? "0" : `${diffDays}`;
      return `${dayLabel} (${suffix})`;
    };

    const riskRank = (level) => ({ red:0, yellow:1, green:2 }[level] ?? 2);
    const isDischarged = (p) => new Date(p.dischargeDateTime) < new Date();
    const hoursUntilDischarge = (p) => (new Date(p.dischargeDateTime).getTime() - Date.now()) / 3600000;

    const splitNames = (value) => (value || "")
      .split(",")
      .map(s => s.trim())
      .filter(Boolean);

    const mapAdmissionRow = (row) => {
      const hhServices = splitNames(row.dc_sub_hh_service_names);
      const dmeServices = splitNames(row.dc_sub_dme_service_names);
      return withInfo({
        id: String(row.id),
        mrn: row.patient_mrn || "",
        name: row.patient_name || `${row.patient_last_name || ""}, ${row.patient_first_name || ""}`.trim(),
        age: row.patient_dob ? Math.max(0, Math.floor((Date.now() - new Date(row.patient_dob).getTime()) / 31557600000)) : "",
        facilityName: row.agency_name || "â€”",
        dischargeDateTime: row.dc_sub_dc_date || row.dc_date || "",
        servicesNeeded: { homeHealth: hhServices.length > 0, dme: dmeServices.length > 0 },
        portalEligibility: { homeHealthOnPortal: false, dmeOnPortal: false, physicianOnEsign: false },
        contactStatus: "not_attempted",
        contactAttempts: 0,
        lastContactAttemptAt: null,
        nextContactDueAt: null,
        docsStatus: "not_started",
        docsChecklist: { faceSheet:false, orders:false, clinicals:false },
        packetGenerated: false,
        referrals: { homeHealth:{referralStatus:"not_sent", lastSentAt:null, faxStatus:"n/a"}, dme:{referralStatus:"not_sent", lastSentAt:null, faxStatus:"n/a"} },
        pcpApptNeeded: false,
        ordersStatus: "not_required",
        ordersLastNudgeAt: null,
        ordersNudgeCount: 0,
        lockStatus: "not_ready",
        startOfCareDate: null,
        activityLog: [],
        localActivityLog: [],
        hhServiceNames: hhServices,
        dmeServiceNames: dmeServices,
        agencyCcm: {
          medrina: Boolean(row.agency_medrina_ccm),
          evolv: Boolean(row.agency_evolv_ccm)
        }
      });
    };

    const loadAdmissions = async () => {
      if (!token()) {
        render();
        return;
      }
      try {
        const res = await fetch("/api/sensys/my-admissions?admitted_only=0", { headers: authHeaders() });
        if (!res.ok) throw new Error("Failed to load admissions");
        const data = await res.json();
        patients = (data.admissions || []).map(mapAdmissionRow);
        await loadAdmissionNotes(patients.map(p => p.id));
        populateFacilityFilter();
        render();
      } catch (err) {
        console.warn("[Evolv SNF] admissions fetch failed:", err);
        render();
      }
    };

    const loadAdmissionNotes = async (admissionIds) => {
      if (!token() || !admissionIds?.length) return;
      try {
        const params = new URLSearchParams({
          admission_ids: admissionIds.join(","),
          workspace_key: WORKSPACE_KEY,
          include_answers: "1"
        });
        const res = await fetch(`/api/sensys/admission-notes?${params.toString()}`, { headers: authHeaders() });
        if (!res.ok) throw new Error("Failed to load notes");
        const data = await res.json();
        const notesByAdmission = {};
        (data.notes || []).forEach(n => {
          const id = String(n.admission_id || "");
          if (!id) return;
          if (!notesByAdmission[id]) notesByAdmission[id] = [];
          notesByAdmission[id].push(n);
        });
        const idSet = new Set(admissionIds.map(id => String(id)));
        patients.forEach(p => {
          if (!idSet.has(String(p.id))) return;
          p.admissionNotes = notesByAdmission[p.id] || [];
          applyAttemptNotes(p);
          p.activityLog = buildActivityLog(p);
        });
      } catch (err) {
        console.warn("[Evolv SNF] notes fetch failed:", err);
      }
    };

    const getDeliveryMethod = (p, service) => {
      if (service === "homeHealth") return p.portalEligibility.homeHealthOnPortal ? "portal" : "fax";
      if (service === "dme") return p.portalEligibility.dmeOnPortal ? "portal" : "fax";
      return "fax";
    };

    const recomputeDerived = (p) => {
      const atRisk = computeAtRisk(p);
      if (atRisk) p.riskLevel = "red";
      else if (hoursUntilDischarge(p) <= 48) p.riskLevel = "yellow";
      else p.riskLevel = "green";
      p.readyCriteriaMet = computeReadyCriteria(p);
      if (p.readyCriteriaMet && p.lockStatus === "not_ready") p.lockStatus = "ready";
      if (!p.readyCriteriaMet && p.lockStatus === "ready") p.lockStatus = "not_ready";
    };

    const computeReadyCriteria = (p) => {
      const hhNeeded = p.servicesNeeded.homeHealth;
      const dmeNeeded = p.servicesNeeded.dme;
      const hhOk = !hhNeeded || p.referrals.homeHealth.referralStatus === "accepted";
      const dmeOk = !dmeNeeded || p.referrals.dme.referralStatus === "accepted";
      const ordersOk = ["signed","exception_off_portal","not_required"].includes(p.ordersStatus);
      const packetOk = p.packetGenerated || p.docsStatus === "complete";
      const socOk = !hhNeeded || Boolean(p.startOfCareDate);
      return hhOk && dmeOk && ordersOk && packetOk && socOk;
    };

    const computeAtRisk = (p) => {
      const dischargeSoon = hoursUntilDischarge(p) <= 24;
      const faxFailed = ["homeHealth","dme"].some(s => p.referrals[s] && p.referrals[s].faxStatus === "failed");
      const referralRejected = ["homeHealth","dme"].some(s => p.referrals[s] && p.referrals[s].referralStatus === "rejected");
      const referralStale = ["homeHealth","dme"].some(s => {
        const ref = p.referrals[s];
        if (!ref || ref.referralStatus !== "sent" || !ref.lastSentAt) return false;
        const hours = (Date.now() - new Date(ref.lastSentAt).getTime()) / 3600000;
        return hours > 18;
      });
      const ordersStale = p.ordersStatus === "pending" && (p.ordersNudgeCount >= 2 || hoursSince(p.ordersLastNudgeAt) > 24);
      const unreachableSoon = p.contactStatus === "not_reachable_final" && dischargeSoon;
      const notReadySoon = dischargeSoon && p.lockStatus !== "ready" && p.lockStatus !== "complete";
      return faxFailed || referralRejected || referralStale || ordersStale || unreachableSoon || notReadySoon;
    };

    const isContactComplete = (p) => {
      return p.contactStatus === "reached" || p.contactStatus === "not_reachable_final" || p.contactAttempts >= 2;
    };

    const hoursSince = (iso) => {
      if (!iso) return 0;
      return (Date.now() - new Date(iso).getTime()) / 3600000;
    };

    const inQueue = (p, queueId) => {
      if (queueId === "intake") {
        return !isContactComplete(p) && p.contactAttempts < 2 && !isDischarged(p);
      }
      if (queueId === "docs") {
        return p.docsStatus !== "complete" && !isDischarged(p);
      }
      if (queueId === "referrals") {
        if (p.docsStatus !== "complete") return false;
        const needsHH = p.servicesNeeded.homeHealth && p.referrals.homeHealth.referralStatus === "not_sent";
        const needsDME = p.servicesNeeded.dme && p.referrals.dme.referralStatus === "not_sent";
        return (needsHH || needsDME) && !isDischarged(p);
      }
      if (queueId === "awaiting") {
        const awaitingRef = ["homeHealth","dme"].some(s => {
          const ref = p.referrals[s];
          return ref && ["sent","needs_info"].includes(ref.referralStatus);
        });
        const ordersPending = p.ordersStatus === "pending";
        return (awaitingRef || ordersPending) && !isDischarged(p);
      }
      if (queueId === "pcp") {
        return p.pcpApptNeeded && !isDischarged(p);
      }
      if (queueId === "urgent") {
        return computeAtRisk(p);
      }
      if (queueId === "allTransitions") {
        const notReadyOrComplete = !["ready","complete"].includes(p.lockStatus);
        const dischargeDate = p.dischargeDateTime ? new Date(p.dischargeDateTime) : null;
        const notPastDischarge = !dischargeDate || Number.isNaN(dischargeDate.getTime()) || new Date() <= dischargeDate;
        return (notReadyOrComplete || notPastDischarge);
      }
      if (queueId === "ready") {
        return p.lockStatus === "ready" || p.lockStatus === "complete";
      }
      return false;
    };

    const matchesFilters = (p) => {
      const search = searchInputEl.value.trim().toLowerCase();
      if (search) {
        const hay = `${p.name} ${p.mrn} ${p.facilityName}`.toLowerCase();
        if (!hay.includes(search)) return false;
      }
      if (facilityFilterEl.value !== "all" && p.facilityName !== facilityFilterEl.value) return false;
      const range = dateFilterEl.value;
      if (range !== "all") {
        const hours = parseInt(range, 10);
        const until = hoursUntilDischarge(p);
        if (range === "today") {
          const today = new Date();
          const discharge = new Date(p.dischargeDateTime);
          if (today.toDateString() !== discharge.toDateString()) return false;
        } else if (until < 0 || until > hours) {
          return false;
        }
      }
      if (toggleAtRiskEl.checked && !computeAtRisk(p)) return false;
      if (toggleOffPortalEl.checked) {
        const offPortalRef = ["homeHealth","dme"].some(s => p.servicesNeeded[s] && getDeliveryMethod(p, s) === "fax");
        const offPortalPhysician = !p.portalEligibility.physicianOnEsign;
        if (!offPortalRef && !offPortalPhysician) return false;
      }
      return true;
    };

    const sortPatients = (list) => {
      const sort = sortFilterEl.value;
      return list.sort((a,b) => {
        const dateDiff = new Date(a.dischargeDateTime) - new Date(b.dischargeDateTime);
        if (sort === "risk") {
          const riskDiff = riskRank(a.riskLevel) - riskRank(b.riskLevel);
          return riskDiff !== 0 ? riskDiff : dateDiff;
        }
        if (dateDiff !== 0) return dateDiff;
        return riskRank(a.riskLevel) - riskRank(b.riskLevel);
      });
    };

    let toastActionHandler = null;
    const showToast = (title, sub, action) => {
      toastTitleEl.textContent = title;
      toastSubEl.textContent = sub;
      if (action && action.label && typeof action.onClick === "function") {
        toastActionsEl.style.display = "flex";
        toastActionBtnEl.textContent = action.label;
        toastActionHandler = action.onClick;
      } else {
        toastActionsEl.style.display = "none";
        toastActionHandler = null;
      }
      toastEl.classList.add("show");
      clearTimeout(window.toastTimer);
      const duration = action ? 6000 : 2600;
      window.toastTimer = setTimeout(() => toastEl.classList.remove("show"), duration);
    };
    toastCloseEl.addEventListener("click", () => toastEl.classList.remove("show"));
    toastActionBtnEl.addEventListener("click", () => {
      if (toastActionHandler) toastActionHandler();
      toastEl.classList.remove("show");
    });

    const getAttemptNotes = (p) => (p.admissionNotes || [])
      .filter(n => Number(n.template_id) === ATTEMPT_TEMPLATE_ID && (n.workspace_key || "") === WORKSPACE_KEY);

    const getReachedNotes = (p) => (p.admissionNotes || [])
      .filter(n => Number(n.template_id) === REACHED_TEMPLATE_ID && (n.workspace_key || "") === WORKSPACE_KEY);

    const applyAttemptNotes = (p) => {
      const attemptNotes = getAttemptNotes(p);
      const reachedNotes = getReachedNotes(p);
      const allContactNotes = [...attemptNotes, ...reachedNotes].filter(n => n.created_at);
      const sorted = allContactNotes.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
      const attempts = attemptNotes.length;
      p.contactAttempts = attempts;
      p.lastContactAttemptAt = sorted[0]?.created_at || null;
      if (reachedNotes.length) {
        p.contactStatus = "reached";
      } else if (attempts >= 2) {
        p.contactStatus = "not_reachable_final";
      } else if (attempts >= 1) {
        p.contactStatus = "attempted_vm";
      } else {
        p.contactStatus = "not_attempted";
      }
    };

    const buildActivityLog = (p) => {
      const entries = [...(p.localActivityLog || [])];
      const attemptNotes = getAttemptNotes(p);
      const reachedNotes = getReachedNotes(p);
      attemptNotes.forEach(n => {
        const stamp = n.created_at ? formatStamp(new Date(n.created_at)) : formatStamp(new Date());
        const detail = n.attempt_detail || "Left voicemail";
        const comments = (n.attempt_comments || "").trim();
        const suffix = comments ? ` â€” ${comments}` : "";
        entries.unshift(`${stamp} - ${detail}${suffix}`);
      });
      reachedNotes.forEach(n => {
        const stamp = n.created_at ? formatStamp(new Date(n.created_at)) : formatStamp(new Date());
        const detail = (n.response1 || REACHED_ANSWER || "Reached patient").trim();
        const prefix = "Reached patient";
        const suffix = detail && detail !== prefix ? ` â€” ${detail}` : "";
        entries.unshift(`${stamp} - ${prefix}${suffix}`);
      });
      return entries;
    };

    let noteTemplatesCache = null;
    const loadNoteTemplates = async () => {
      if (noteTemplatesCache) return noteTemplatesCache;
      if (!token()) return [];
      const res = await fetch("/api/sensys/note-templates", { headers: authHeaders() });
      if (!res.ok) throw new Error("Failed to load note templates");
      const data = await res.json();
      noteTemplatesCache = data.templates || [];
      return noteTemplatesCache;
    };

    const getLatestWorkspaceNote = (p, templateId) => {
      const notes = (p.admissionNotes || [])
        .filter(n => (n.workspace_key || "") === WORKSPACE_KEY && Number(n.template_id) === Number(templateId) && n.created_at);
      if (!notes.length) return null;
      notes.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
      return notes[0];
    };

    let noteDetailsContext = null;
    const openNoteDetailsModal = async (p, templateId) => {
      if (!token()) return;
      try {
        const templates = await loadNoteTemplates();
        const tpl = templates.find(t => Number(t.id) === Number(templateId));
        if (!tpl) {
          showToast("Note template missing", p.name);
          return;
        }
        const note = getLatestWorkspaceNote(p, templateId);
        const answers = (note && note.answers) ? note.answers : [];
        const answerMap = {};
        answers.forEach(a => {
          const key = a.field_key;
          if (!key) return;
          if (a.value_text != null && a.value_text !== "") answerMap[key] = a.value_text;
          else if (a.value_num != null) answerMap[key] = String(a.value_num);
          else if (a.value_date) answerMap[key] = a.value_date;
          else if (a.value_bool != null) answerMap[key] = String(a.value_bool);
        });

        if (templateId === REACHED_TEMPLATE_ID && !answerMap[REACHED_FIELD_KEY]) {
          answerMap[REACHED_FIELD_KEY] = REACHED_ANSWER;
        }

        noteDetailsTitleEl.textContent = `${tpl.template_name || "Note"} â€” ${p.name}`;
        noteDetailsBodyEl.innerHTML = (tpl.fields || []).map(f => {
          const key = f.field_key || "";
          const label = f.field_label || key;
          const type = (f.field_type || "text").toLowerCase();
          const required = String(f.required || 0) === "1";
          const value = answerMap[key] || "";
          const base = `data-field-key="${key}" data-field-type="${type}"`;

          if (type === "textarea") {
            return `
              <div style="margin-bottom:12px;">
                <label>${label}${required ? " *" : ""}</label>
                <textarea class="ipt" rows="3" ${base}>${value}</textarea>
              </div>
            `;
          }
          if (type === "boolean") {
            return `
              <div style="margin-bottom:12px;">
                <label>${label}${required ? " *" : ""}</label>
                <select class="ipt" ${base}>
                  <option value="">Select</option>
                  <option value="1" ${value === "1" ? "selected" : ""}>Yes</option>
                  <option value="0" ${value === "0" ? "selected" : ""}>No</option>
                </select>
              </div>
            `;
          }
          if (type === "select") {
            let opts = [];
            try {
              const parsed = JSON.parse(f.options_json || "[]");
              opts = Array.isArray(parsed) ? parsed : [];
            } catch (e) {
              opts = String(f.options_json || "")
                .split(/[\\n,]/)
                .map(s => s.trim())
                .filter(Boolean);
            }
            return `
              <div style="margin-bottom:12px;">
                <label>${label}${required ? " *" : ""}</label>
                <select class="ipt" ${base}>
                  <option value="">Select</option>
                  ${opts.map(opt => `<option value="${String(opt)}" ${String(opt) === value ? "selected" : ""}>${String(opt)}</option>`).join("")}
                </select>
              </div>
            `;
          }
          const inputType = type === "number" ? "number" : type === "date" ? "date" : "text";
          return `
            <div style="margin-bottom:12px;">
              <label>${label}${required ? " *" : ""}</label>
              <input class="ipt" type="${inputType}" value="${value}" ${base} />
            </div>
          `;
        }).join("");

        noteDetailsContext = {
          patientId: p.id,
          templateId: Number(templateId),
          noteId: note ? Number(note.id) : null,
          noteName: templateId === ATTEMPT_TEMPLATE_ID ? ATTEMPT_NOTE_NAME : REACHED_NOTE_NAME,
          noteResponse1: note ? (note.response1 || "") : (templateId === REACHED_TEMPLATE_ID ? REACHED_ANSWER : "")
        };
        openModal(noteDetailsModalEl);
      } catch (err) {
        console.warn("[Evolv SNF] note modal failed:", err);
        showToast("Note modal failed", p.name);
      }
    };

    const addActivity = (p, text) => {
      p.localActivityLog = p.localActivityLog || [];
      p.localActivityLog.unshift(`${formatStamp(new Date())} - ${text}`);
      p.activityLog = buildActivityLog(p);
    };

    const renderQueues = () => {
      queueListEl.innerHTML = "";
      queues.forEach(queue => {
        if (queue.id === "urgent") {
          const sep = document.createElement("div");
          sep.className = "queue-sep";
          queueListEl.appendChild(sep);
        }
        const count = patients.filter(p => inQueue(p, queue.id)).length;
        const item = document.createElement("div");
        item.className = `queue-item ${queue.id === "urgent" ? "urgent" : ""} ${activeQueue === queue.id ? "active" : ""}`;
        item.innerHTML = `<span>${queue.label}</span><span class="queue-count">${count}</span>`;
        item.addEventListener("click", () => {
          activeQueue = queue.id;
          render();
        });
        queueListEl.appendChild(item);
      });
    };

    const renderSummary = (list) => {
      const total = list.length;
      const dueToday = list.filter(p => {
        const discharge = new Date(p.dischargeDateTime);
        return new Date().toDateString() === discharge.toDateString();
      }).length;
      const overdue = list.filter(p => new Date(p.dischargeDateTime) < new Date()).length;
      summaryStripEl.innerHTML = `
        <div class="summary-item"><span>In Queue</span><strong>${total}</strong></div>
        <div class="summary-item"><span>Due Today</span><strong>${dueToday}</strong></div>
        <div class="summary-item"><span>Overdue</span><strong>${overdue}</strong></div>
      `;
    };

    const renderHead = () => {
      const hasAttempts = activeQueue === "intake";
      if (activeQueue === "allTransitions") {
        queueHeadEl.innerHTML = `
          <tr>
            <th>Patient</th>
            <th style="width:96px;">DC Day</th>
            <th>Services</th>
            <th>Tasks</th>
          </tr>
        `;
        return;
      }
      queueHeadEl.innerHTML = `
          <tr>
            <th>Patient</th>
            <th>DC Day</th>
            <th>Services</th>
            <th>Tasks</th>
            ${activeQueue === "intake" ? "" : "<th>Actions</th>"}
            ${hasAttempts ? "<th>Attempts</th>" : ""}
          </tr>
        `;
    };

    const taskChips = (p) => {
      const chips = [];
      if (!isContactComplete(p)) chips.push(`Contact`);
      if (p.docsStatus !== "complete") chips.push(`Docs`);
      if (p.servicesNeeded.homeHealth && p.referrals.homeHealth.referralStatus === "not_sent") chips.push(`Referral`);
      if (p.ordersStatus === "pending") chips.push(`Orders`);
      if (chips.length === 0) chips.push("Ready");
      return chips.map(c => `<span class="task-chip ${isTaskUrgent(p, c) ? "urgent" : ""}">${c}</span>`).join("");
    };

    const isTaskUrgent = (p, task) => {
      if (task === "Contact" && computeAtRisk(p) && !isContactComplete(p)) return true;
      if (task === "Referral") {
        const failed = ["homeHealth","dme"].some(s => p.referrals[s] && p.referrals[s].faxStatus === "failed");
        const rejected = ["homeHealth","dme"].some(s => p.referrals[s] && p.referrals[s].referralStatus === "rejected");
        return failed || rejected;
      }
      if (task === "Orders" && p.ordersStatus === "pending" && p.ordersNudgeCount >= 2) return true;
      if (task === "Docs" && hoursUntilDischarge(p) <= 24) return true;
      return false;
    };

    const getServiceLines = (p) => {
      const lines = [];
      if (p.hhServiceNames?.length) {
        lines.push({ label:"HH", items:p.hhServiceNames });
      }
      if (p.dmeServiceNames?.length) {
        lines.push({ label:"DME", items:p.dmeServiceNames });
      }
      return lines;
    };

    const nextActionLabel = (queueId, p) => {
      if (queueId === "intake") return "Call patient";
      if (queueId === "docs") return "Open docs";
      if (queueId === "referrals") return "Send referral";
      if (queueId === "awaiting") return p.ordersStatus === "pending" ? "Nudge physician" : "Message agency";
      if (queueId === "urgent") return "Review urgent";
      if (queueId === "pcp") return "Schedule PCP";
      if (queueId === "allTransitions") return p.lockStatus === "ready" ? "Mark complete" : "View";
      if (queueId === "ready") return p.lockStatus === "ready" ? "Mark complete" : "View";
      return "Open";
    };

    const renderTable = (list) => {
      queueTableEl.innerHTML = "";
      emptyStateEl.style.display = list.length ? "none" : "block";
      const showAttempts = activeQueue === "intake";
      list.forEach(p => {
        const serviceLines = getServiceLines(p);
        const servicesHtml = serviceLines.length
          ? `<div class="service-lines">${serviceLines.map(line => `
              <div class="service-line">
                <span class="service-label">${line.label}:</span>
                ${line.items.map(item => `<span class="service-pill ${item === "O2" ? "danger" : ""}">${item}</span>`).join("")}
              </div>
            `).join("")}</div>`
          : `<div style="font-size:11px;color:var(--muted);font-weight:800">â€”</div>`;

        if (activeQueue === "allTransitions") {
          const tr = document.createElement("tr");
          const dcDateText = p.dischargeDateTime ? formatDateShort(p.dischargeDateTime) : "Ã¢â‚¬â€";
          const dcDayText = p.dischargeDateTime ? formatDcDay(p.dischargeDateTime) : "Ã¢â‚¬â€";
          tr.innerHTML = `
            <td>
              <div style="font-weight:900;color:var(--navy)">${p.name}</div>
              <div style="font-size:11px;color:var(--muted);font-weight:800">${p.facilityName}</div>
              <div style="font-size:11px;color:var(--muted);font-weight:800">DC: ${dcDateText}</div>
            </td>
            <td>${dcDayText}</td>
            <td>${servicesHtml}</td>
            <td><div class="task-chips">${taskChips(p)}</div></td>
          `;
          queueTableEl.appendChild(tr);
          tr.addEventListener("click", () => openDrawer(p.id));
          return;
        }

        const actionsHtml = activeQueue === "intake"
          ? ""
          : `
            <div class="row-actions">
              <button class="btn btn-primary btn-small" data-action="next">${nextActionLabel(activeQueue, p)}</button>
            </div>
          `;

        const attemptsHtml = `
          <div style="font-size:11px;color:var(--muted);font-weight:800">
            Attempts: ${p.contactAttempts}/2
          </div>
          <div style="font-size:11px;color:var(--muted);font-weight:800">
            Last Attempt: ${p.lastContactAttemptAt ? formatDateTime(p.lastContactAttemptAt) : "â€”"}
          </div>
        `;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>
            <div style="font-weight:900;color:var(--navy)">${p.name}</div>
            <div style="font-size:11px;color:var(--muted);font-weight:800">${p.facilityName}</div>
            <div style="font-size:11px;color:var(--muted);font-weight:800">DC: ${formatDateShort(p.dischargeDateTime)}</div>
          </td>
          <td>${formatDcDay(p.dischargeDateTime)}</td>
          <td>${servicesHtml}</td>
          <td><div class="task-chips">${taskChips(p)}</div></td>
          ${activeQueue === "intake" ? "" : `<td>${actionsHtml}</td>`}
          ${showAttempts ? `<td>${attemptsHtml}</td>` : ""}
        `;
        tr.querySelector('[data-action="next"]')?.addEventListener("click", (e) => {
          e.stopPropagation();
          handleNextAction(activeQueue, p);
        });
        tr.querySelector('[data-action="vm"]')?.addEventListener("click", (e) => {
          e.stopPropagation();
          logVm(p);
        });
        tr.querySelector('[data-action="reached"]')?.addEventListener("click", (e) => {
          e.stopPropagation();
          markReached(p);
        });
        tr.addEventListener("click", () => openDrawer(p.id));
        queueTableEl.appendChild(tr);
      });
    };

    const handleNextAction = (queueId, p) => {
      if (queueId === "intake") {
        addActivity(p, "Call initiated");
        showToast("Call started", `${p.name} queued for outreach`);
        openDrawer(p.id);
        return;
      }
      if (queueId === "docs") {
        openDrawer(p.id, "docs");
        return;
      }
      if (queueId === "referrals") {
        const service = p.servicesNeeded.homeHealth && p.referrals.homeHealth.referralStatus === "not_sent" ? "homeHealth" : "dme";
        requestSendReferral(p.id, service);
        return;
      }
      if (queueId === "awaiting") {
        if (p.ordersStatus === "pending") {
          nudgePhysician(p);
        } else {
          messageAgency(p);
        }
        return;
      }
      if (queueId === "urgent") {
        openDrawer(p.id, "risk");
        return;
      }
      if (queueId === "allTransitions") {
        if (p.lockStatus === "ready") {
          p.lockStatus = "complete";
          addActivity(p, "Marked complete");
          showToast("Patient completed", `${p.name} moved to complete`);
          render();
        } else {
          openDrawer(p.id);
        }
        return;
      }
      if (queueId === "pcp") {
        addActivity(p, "PCP appointment scheduled (mock)");
        p.pcpApptNeeded = false;
        showToast("PCP scheduled", p.name);
        render();
        return;
      }
      if (queueId === "ready") {
        if (p.lockStatus === "ready") {
          p.lockStatus = "complete";
          addActivity(p, "Marked complete");
          showToast("Patient completed", `${p.name} moved to complete`);
          render();
        } else {
          openDrawer(p.id);
        }
      }
    };

    let fabUserOpen = false;
    const updateFabState = () => {
      const anyOpen = drawerEl.classList.contains("open")
        || infoDrawerEl.classList.contains("open")
        || contactDrawerEl.classList.contains("open");
      document.body.classList.toggle("drawer-open", anyOpen);
      if (fabWrapEl) {
        fabWrapEl.classList.toggle("open", anyOpen || fabUserOpen);
      }
    };

    const openDrawer = (patientId, focus) => {
      selectedPatientId = patientId;
      drawerOverlayEl.classList.add("show");
      drawerEl.classList.add("open");
      renderDrawer(focus);
      updateFabState();
    };
    const closeDrawer = () => {
      selectedPatientId = null;
      drawerOverlayEl.classList.remove("show");
      drawerEl.classList.remove("open");
      infoDrawerEl.classList.remove("open");
      contactDrawerEl.classList.remove("open");
      updateFabState();
    };
    drawerOverlayEl.addEventListener("click", closeDrawer);

    const renderDrawer = (focus) => {
      const p = patients.find(pt => pt.id === selectedPatientId);
      if (!p) return;
      const hhMethod = getDeliveryMethod(p, "homeHealth");
      const dmeMethod = getDeliveryMethod(p, "dme");
      const contactLabel = {
        not_attempted:"Not attempted",
        attempted_vm:`VM Left (${p.contactAttempts}/2)`,
        reached:"Reached",
        not_reachable_final:"VM Left (2/2)"
      }[p.contactStatus] || "Unknown";
      const contactMeta = `${contactLabel}${p.lastContactAttemptAt ? ` - ${formatDateTime(p.lastContactAttemptAt)}` : ""}`;
      const showCcm = Boolean(p.agencyCcm?.medrina || p.agencyCcm?.evolv);
      const ccmLabel = p.agencyCcm?.medrina ? "Medrina CCM" : "CCM Accepted";
      const pcpStatus = p.pcpApptNeeded ? "Not set" : "Appt set";
      const pcpMeta = p.pcpApptNeeded ? "No appointment on file" : "Appointment scheduled";

      const statusPills = `
        <div class="status-pill ${isContactComplete(p) ? "done" : ""}">Contact</div>
        <div class="status-pill ${p.docsStatus === "complete" ? "done" : ""}">Docs</div>
        <div class="status-pill ${["accepted","not_required"].includes(p.referrals.homeHealth.referralStatus) && ["accepted","not_required"].includes(p.referrals.dme.referralStatus) ? "done" : ""}">Referrals</div>
        <div class="status-pill ${["signed","exception_off_portal","not_required"].includes(p.ordersStatus) ? "done" : p.ordersStatus === "pending" ? "block" : ""}">Orders</div>
        <div class="status-pill ${p.lockStatus === "ready" || p.lockStatus === "complete" ? "done" : ""}">Ready</div>
      `;

      drawerEl.innerHTML = `
        <div class="drawer-header">
          <div style="min-width:0">
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
              <div class="drawer-title">${p.name}</div>
              <span class="badge risk-${p.riskLevel}">
                <span class="dot"></span>${p.riskLevel.toUpperCase()}
              </span>
            </div>
            <div class="drawer-sub">${p.facilityName} â€¢ Discharge ${formatDateTime(p.dischargeDateTime)}</div>
            <div class="status-strip" style="margin-top:8px">${statusPills}</div>
            <div class="drawer-divider"></div>
          </div>
          <button class="btn-icon" id="btnInfo" aria-label="More Info" title="More Info">
            <svg viewBox="0 0 262.56 262.56" aria-hidden="true">
              <circle cx="131.28" cy="131.28" r="128.53" transform="translate(-54.38 131.28) rotate(-45)"/>
              <path d="M98.51,110.75h46.18c6.1,0,10.72,5.5,9.67,11.5l-11.92,68.11c-.31,1.78,1.06,3.41,2.86,3.41h0c6.11,0,11.07,4.95,11.07,11.07h0c0,4.27-2.51,8.18-6.43,9.87-18.31,7.9-50.7,7.58-46.11-29.91l9.71-54.51"/>
              <path d="M162.02,65.13c0,12.94-10.43,23.42-23.29,23.42s-23.29-10.49-23.29-23.42,10.43-23.42,23.29-23.42,23.29,10.49,23.29,23.42Z"/>
            </svg>
          </button>
        </div>
        <div class="drawer-body">
          <div class="card" data-skip-download="true">
            <div class="card-section">
              <div class="card-header">
                <div class="card-title">Patient Contact</div>
                <div class="card-meta">${contactMeta}</div>
              </div>
              <div class="card-body">
                <div class="contact-meta-grid" style="grid-template-columns: repeat(${showCcm ? 3 : 2}, minmax(0,1fr));">
                  <div class="contact-meta-col left">
                    <div class="contact-meta-label">Call Result</div>
                    <div class="contact-meta-actions">
                      <button class="btn-icon vm thumb-down" id="btnVm" ${p.contactAttempts >= 2 ? "disabled" : ""} aria-label="Log Attempt" title="Log Attempt">
                        <svg viewBox="0 0 233.12 234.63" aria-hidden="true">
                          <path d="M52.97,218.37H12.19c-5.21,0-9.44-4.23-9.44-9.44v-108.68c0-5.21,4.23-9.44,9.44-9.44h38.63c6.97-.01,13.73-2.63,18.73-7.49C90.09,63.36,113.34,16.95,122.19,7.1c3.98-4.7,9.44-4.71,13.07-4.03.07.02.13.03.2.05,25.27,5.85,14.83,46.22,5.35,66.57h0c-3.97,7.7,1.62,16.88,10.28,16.88h54.46c17.1,0,29.06,16.89,23.39,33.02l-33.11,94.15c-3.82,10.87-14.09,18.14-25.61,18.14h-64.57c-11.22,0-22.34-2.03-32.83-6l-19.86-7.51v-126.87"/>
                        </svg>
                      </button>
                      <button class="btn-icon reached" id="btnReached" aria-label="Reached">
                        <svg viewBox="0 0 233.12 234.63" aria-hidden="true">
                          <path d="M52.97,218.37H12.19c-5.21,0-9.44-4.23-9.44-9.44v-108.68c0-5.21,4.23-9.44,9.44-9.44h38.63c6.97-.01,13.73-2.63,18.73-7.49C90.09,63.36,113.34,16.95,122.19,7.1c3.98-4.7,9.44-4.71,13.07-4.03.07.02.13.03.2.05,25.27,5.85,14.83,46.22,5.35,66.57h0c-3.97,7.7,1.62,16.88,10.28,16.88h54.46c17.1,0,29.06,16.89,23.39,33.02l-33.11,94.15c-3.82,10.87-14.09,18.14-25.61,18.14h-64.57c-11.22,0-22.34-2.03-32.83-6l-19.86-7.51v-126.87"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                  ${showCcm ? `
                  <div class="contact-meta-col center">
                    <div class="contact-meta-label">${ccmLabel}</div>
                    <div class="contact-meta-actions">
                      <button class="btn-icon reached" aria-label="${ccmLabel}" title="${ccmLabel}">
                        <svg viewBox="0 0 233.12 234.63" aria-hidden="true">
                          <path d="M52.97,218.37H12.19c-5.21,0-9.44-4.23-9.44-9.44v-108.68c0-5.21,4.23-9.44,9.44-9.44h38.63c6.97-.01,13.73-2.63,18.73-7.49C90.09,63.36,113.34,16.95,122.19,7.1c3.98-4.7,9.44-4.71,13.07-4.03.07.02.13.03.2.05,25.27,5.85,14.83,46.22,5.35,66.57h0c-3.97,7.7,1.62,16.88,10.28,16.88h54.46c17.1,0,29.06,16.89,23.39,33.02l-33.11,94.15c-3.82,10.87-14.09,18.14-25.61,18.14h-64.57c-11.22,0-22.34-2.03-32.83-6l-19.86-7.51v-126.87"/>
                        </svg>
                      </button>
                      <button class="btn-icon danger thumb-down" aria-label="${ccmLabel} Not Accepted" title="${ccmLabel} Not Accepted">
                        <svg viewBox="0 0 233.12 234.63" aria-hidden="true">
                          <path d="M52.97,218.37H12.19c-5.21,0-9.44-4.23-9.44-9.44v-108.68c0-5.21,4.23-9.44,9.44-9.44h38.63c6.97-.01,13.73-2.63,18.73-7.49C90.09,63.36,113.34,16.95,122.19,7.1c3.98-4.7,9.44-4.71,13.07-4.03.07.02.13.03.2.05,25.27,5.85,14.83,46.22,5.35,66.57h0c-3.97,7.7,1.62,16.88,10.28,16.88h54.46c17.1,0,29.06,16.89,23.39,33.02l-33.11,94.15c-3.82,10.87-14.09,18.14-25.61,18.14h-64.57c-11.22,0-22.34-2.03-32.83-6l-19.86-7.51v-126.87"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                  ` : ""}
                  <div class="contact-meta-col right">
                    <div class="contact-meta-label">Open</div>
                    <div class="contact-meta-actions">
                      <button class="btn-icon" id="btnContactOpen" aria-label="Open" title="Open">
                        <svg viewBox="0 0 251.6 261.78" aria-hidden="true" style="transform: rotate(-90deg);">
                          <path d="M168.79,110.02V12.56c0-5.42-4.39-9.81-9.81-9.81h-66.35c-5.42,0-9.81,4.39-9.81,9.81v97.45h-45.05c-5.55,0-8.32,6.7-4.4,10.63l88.43,91.63c2.21,2.21,5.81,2.21,8.02,0l88.43-91.63c3.92-3.92,1.14-10.63-4.4-10.63h-45.05Z"/>
                          <path d="M2.75,202.34v41.97c0,8.13,6.59,14.72,14.72,14.72h216.66c8.13,0,14.72-6.59,14.72-14.72v-41.97"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="card" ${focus === "docs" ? "style=\"box-shadow: 0 0 0 3px rgba(168,230,207,.45);\"" : ""}>
            <div class="card-section">
              <div class="card-header">
                <div class="card-title">Documents & Chart Review</div>
                <div class="card-meta">${p.docsStatus.replace("_"," ")}</div>
              </div>
                <div class="card-body">
                <div class="chip-row">
                  ${Object.keys(p.docsChecklist).map(key => {
                    const labelMap = { faceSheet:"Facesheet", orders:"DC Summary", clinicals:"Physicians Added" };
                    return `
                    <button class="chip-toggle ${p.docsChecklist[key] ? "is-active" : ""}" type="button" data-doc="${key}">
                      ${labelMap[key] || key.replace(/([A-Z])/g, " $1")}
                    </button>
                  `;
                  }).join("")}
                </div>
                <div class="row-actions split">
                  <div class="row-actions-left">
                    <button class="btn-icon" id="btnPacket" ${docsMinimumComplete(p) ? "" : "disabled"} aria-label="Upload" title="Upload">
                      <svg viewBox="0 0 251.6 261.78" aria-hidden="true">
                        <path d="M82.81,106.67v97.45c0,5.42,4.39,9.81,9.81,9.81h66.35c5.42,0,9.81-4.39,9.81-9.81v-97.45h45.05c5.55,0,8.32-6.7,4.4-10.63L129.81,4.41c-2.21-2.21-5.81-2.21-8.02,0L33.36,96.05c-3.92,3.92-1.14,10.63,4.4,10.63h45.05Z"/>
                        <path d="M2.75,202.34v41.97c0,8.13,6.59,14.72,14.72,14.72h216.66c8.13,0,14.72-6.59,14.72-14.72v-41.97"/>
                      </svg>
                    </button>
                    <button class="btn-icon reached" id="btnDocsComplete" aria-label="Mark Complete" title="Mark Complete">
                      <svg viewBox="0 0 233.12 234.63" aria-hidden="true">
                        <path d="M52.97,218.37H12.19c-5.21,0-9.44-4.23-9.44-9.44v-108.68c0-5.21,4.23-9.44,9.44-9.44h38.63c6.97-.01,13.73-2.63,18.73-7.49C90.09,63.36,113.34,16.95,122.19,7.1c3.98-4.7,9.44-4.71,13.07-4.03.07.02.13.03.2.05,25.27,5.85,14.83,46.22,5.35,66.57h0c-3.97,7.7,1.62,16.88,10.28,16.88h54.46c17.1,0,29.06,16.89,23.39,33.02l-33.11,94.15c-3.82,10.87-14.09,18.14-25.61,18.14h-64.57c-11.22,0-22.34-2.03-32.83-6l-19.86-7.51v-126.87"/>
                      </svg>
                    </button>
                  </div>
                  <div class="row-actions-right">
                    <button class="btn-icon" aria-label="Open" title="Open" data-download="true">
                      <svg viewBox="0 0 251.6 261.78" aria-hidden="true" style="transform: rotate(-90deg);">
                        <path d="M168.79,110.02V12.56c0-5.42-4.39-9.81-9.81-9.81h-66.35c-5.42,0-9.81,4.39-9.81,9.81v97.45h-45.05c-5.55,0-8.32,6.7-4.4,10.63l88.43,91.63c2.21,2.21,5.81,2.21,8.02,0l88.43-91.63c3.92-3.92,1.14-10.63-4.4-10.63h-45.05Z"/>
                        <path d="M2.75,202.34v41.97c0,8.13,6.59,14.72,14.72,14.72h216.66c8.13,0,14.72-6.59,14.72-14.72v-41.97"/>
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          ${p.servicesNeeded.homeHealth ? `
          <div class="card">
            <div class="card-section">
              <div class="card-header">
                <div class="card-title">Home Health Referral</div>
                <div class="card-meta">${p.referrals.homeHealth.referralStatus.replace("_"," ")}</div>
              </div>
              <div class="card-body">
                <div class="card-meta">Delivery: ${hhMethod.toUpperCase()} â€¢ Fax: ${p.referrals.homeHealth.faxStatus || "n/a"}</div>
                <div class="row-actions">
                  <button class="btn-icon" id="btnSendHH" ${p.referrals.homeHealth.referralStatus !== "not_sent" ? "disabled" : ""} aria-label="Create/Confirm Portal Referral">
                    <svg viewBox="0 0 261.49 261.49" aria-hidden="true">
                      <line x1="130.74" y1="66.56" x2="130.74" y2="194.92"/>
                      <line x1="194.93" y1="130.74" x2="66.56" y2="130.74"/>
                      <circle cx="130.74" cy="130.74" r="127.99" transform="translate(-54.16 130.74) rotate(-45)"/>
                    </svg>
                  </button>
                  <button class="btn-icon reached" id="btnAcceptHH" ${p.referrals.homeHealth.referralStatus === "sent" ? "" : "disabled"} aria-label="Mark Accepted">
                    <svg viewBox="0 0 233.12 234.63" aria-hidden="true">
                      <path d="M52.97,218.37H12.19c-5.21,0-9.44-4.23-9.44-9.44v-108.68c0-5.21,4.23-9.44,9.44-9.44h38.63c6.97-.01,13.73-2.63,18.73-7.49C90.09,63.36,113.34,16.95,122.19,7.1c3.98-4.7,9.44-4.71,13.07-4.03.07.02.13.03.2.05,25.27,5.85,14.83,46.22,5.35,66.57h0c-3.97,7.7,1.62,16.88,10.28,16.88h54.46c17.1,0,29.06,16.89,23.39,33.02l-33.11,94.15c-3.82,10.87-14.09,18.14-25.61,18.14h-64.57c-11.22,0-22.34-2.03-32.83-6l-19.86-7.51v-126.87"/>
                    </svg>
                  </button>
                  <button class="btn-icon info" id="btnNeedsHH" ${p.referrals.homeHealth.referralStatus === "sent" ? "" : "disabled"} aria-label="Needs Info">
                    <svg viewBox="0 0 262.56 262.56" aria-hidden="true">
                      <circle cx="131.28" cy="131.28" r="128.53" transform="translate(-54.38 131.28) rotate(-45)"/>
                      <path d="M98.51,110.75h46.18c6.1,0,10.72,5.5,9.67,11.5l-11.92,68.11c-.31,1.78,1.06,3.41,2.86,3.41h0c6.11,0,11.07,4.95,11.07,11.07h0c0,4.27-2.51,8.18-6.43,9.87-18.31,7.9-50.7,7.58-46.11-29.91l9.71-54.51"/>
                      <path d="M162.02,65.13c0,12.94-10.43,23.42-23.29,23.42s-23.29-10.49-23.29-23.42,10.43-23.42,23.29-23.42,23.29,10.49,23.29,23.42Z"/>
                    </svg>
                  </button>
                </div>
                <div class="card-expand">
                    <button class="btn-icon" aria-label="Open" title="Open" data-download="true">
                      <svg viewBox="0 0 251.6 261.78" aria-hidden="true" style="transform: rotate(-90deg);">
                        <path d="M168.79,110.02V12.56c0-5.42-4.39-9.81-9.81-9.81h-66.35c-5.42,0-9.81,4.39-9.81,9.81v97.45h-45.05c-5.55,0-8.32,6.7-4.4,10.63l88.43,91.63c2.21,2.21,5.81,2.21,8.02,0l88.43-91.63c3.92-3.92,1.14-10.63-4.4-10.63h-45.05Z"/>
                        <path d="M2.75,202.34v41.97c0,8.13,6.59,14.72,14.72,14.72h216.66c8.13,0,14.72-6.59,14.72-14.72v-41.97"/>
                      </svg>
                    </button>
                </div>
              </div>
            </div>
          </div>` : ""}

          ${p.servicesNeeded.dme ? `
          <div class="card">
            <div class="card-section">
              <div class="card-header">
                <div class="card-title">DME Referral</div>
                <div class="card-meta">${p.referrals.dme.referralStatus.replace("_"," ")}</div>
              </div>
              <div class="card-body">
                <div class="card-meta">Delivery: ${dmeMethod.toUpperCase()} â€¢ Fax: ${p.referrals.dme.faxStatus || "n/a"}</div>
                <div class="row-actions">
                  <button class="btn btn-small" id="btnSendDME" ${p.referrals.dme.referralStatus !== "not_sent" ? "disabled" : ""}>${dmeMethod === "fax" ? "Send Fax" : "Create/Confirm Portal Referral"}</button>
                  <button class="btn btn-ghost btn-small" id="btnAcceptDME" ${p.referrals.dme.referralStatus === "sent" ? "" : "disabled"}>Mark Accepted</button>
                  <button class="btn btn-ghost btn-small" id="btnNeedsDME" ${p.referrals.dme.referralStatus === "sent" ? "" : "disabled"}>Needs Info</button>
                </div>
                <div class="card-expand">
                    <button class="btn-icon" aria-label="Open" title="Open" data-download="true">
                      <svg viewBox="0 0 251.6 261.78" aria-hidden="true" style="transform: rotate(-90deg);">
                        <path d="M168.79,110.02V12.56c0-5.42-4.39-9.81-9.81-9.81h-66.35c-5.42,0-9.81,4.39-9.81,9.81v97.45h-45.05c-5.55,0-8.32,6.7-4.4,10.63l88.43,91.63c2.21,2.21,5.81,2.21,8.02,0l88.43-91.63c3.92-3.92,1.14-10.63-4.4-10.63h-45.05Z"/>
                        <path d="M2.75,202.34v41.97c0,8.13,6.59,14.72,14.72,14.72h216.66c8.13,0,14.72-6.59,14.72-14.72v-41.97"/>
                      </svg>
                    </button>
                </div>
              </div>
            </div>
          </div>` : ""}

          <div class="card">
            <div class="card-section">
              <div class="card-header">
                <div class="card-title">PCP Appointments</div>
                <div class="card-meta">${pcpStatus}</div>
              </div>
              <div class="card-body">
                <div class="card-meta">${pcpMeta}</div>
                <div class="row-actions">
                  <button class="btn-icon reached" aria-label="Appt set" title="Appt set">
                    <svg viewBox="0 0 233.12 234.63" aria-hidden="true">
                      <path d="M52.97,218.37H12.19c-5.21,0-9.44-4.23-9.44-9.44v-108.68c0-5.21,4.23-9.44,9.44-9.44h38.63c6.97-.01,13.73-2.63,18.73-7.49C90.09,63.36,113.34,16.95,122.19,7.1c3.98-4.7,9.44-4.71,13.07-4.03.07.02.13.03.2.05,25.27,5.85,14.83,46.22,5.35,66.57h0c-3.97,7.7,1.62,16.88,10.28,16.88h54.46c17.1,0,29.06,16.89,23.39,33.02l-33.11,94.15c-3.82,10.87-14.09,18.14-25.61,18.14h-64.57c-11.22,0-22.34-2.03-32.83-6l-19.86-7.51v-126.87"/>
                    </svg>
                  </button>
                </div>
                <div class="card-expand"></div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-section">
              <div class="card-header">
                <div class="card-title">Physician Orders</div>
                <div class="card-meta">${p.ordersStatus.replace("_"," ")}</div>
              </div>
              <div class="card-body">
                <div class="card-meta">Last nudge: ${p.ordersLastNudgeAt ? formatDateTime(p.ordersLastNudgeAt) : "â€”"} â€¢ Nudge count: ${p.ordersNudgeCount}</div>
                <div class="row-actions">
                  <button class="btn-icon" id="btnNudge" aria-label="Nudge Physician" title="Nudge Physician">
                    <svg viewBox="0 0 261.34 256.24" aria-hidden="true">
                      <path d="M130.67,2.75C60.02,2.75,2.75,57.94,2.75,126.03c0,28.22,9.86,54.21,26.42,74.98,1.76,2.21,2.46,5.09,1.93,7.87l-6.2,32.97c-1.44,7.67,6.22,13.88,13.43,10.87l33.21-13.87c2.41-1.01,5.14-1.03,7.54,0,15.78,6.72,33.22,10.47,51.58,10.47,70.65,0,127.92-55.19,127.92-123.28S201.32,2.75,130.67,2.75Z"/>
                      <circle cx="130.67" cy="126.38" r="15.48" transform="translate(-22.35 224.52) rotate(-76.72)"/>
                      <circle cx="71.83" cy="126.38" r="15.48" transform="translate(-64.42 177.03) rotate(-80.78)"/>
                      <circle cx="189.52" cy="126.38" r="15.48" transform="translate(-23.97 46.92) rotate(-13.28)"/>
                    </svg>
                  </button>
                  <button class="btn-icon reached" id="btnSigned" aria-label="Mark Signed" title="Mark Signed">
                    <svg viewBox="0 0 233.12 234.63" aria-hidden="true">
                      <path d="M52.97,218.37H12.19c-5.21,0-9.44-4.23-9.44-9.44v-108.68c0-5.21,4.23-9.44,9.44-9.44h38.63c6.97-.01,13.73-2.63,18.73-7.49C90.09,63.36,113.34,16.95,122.19,7.1c3.98-4.7,9.44-4.71,13.07-4.03.07.02.13.03.2.05,25.27,5.85,14.83,46.22,5.35,66.57h0c-3.97,7.7,1.62,16.88,10.28,16.88h54.46c17.1,0,29.06,16.89,23.39,33.02l-33.11,94.15c-3.82,10.87-14.09,18.14-25.61,18.14h-64.57c-11.22,0-22.34-2.03-32.83-6l-19.86-7.51v-126.87"/>
                    </svg>
                  </button>
                </div>
                <div class="card-expand">
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-section">
              <div class="card-header">
                <div class="card-title">Notes / Activity Log <span style="font-size:11px;color:var(--muted);font-weight:800">(${p.activityLog.length})</span></div>
                <button class="btn-icon" aria-label="Open" title="Open" data-download="true">
                  <svg viewBox="0 0 251.6 261.78" aria-hidden="true" style="transform: rotate(-90deg);">
                    <path d="M168.79,110.02V12.56c0-5.42-4.39-9.81-9.81-9.81h-66.35c-5.42,0-9.81,4.39-9.81,9.81v97.45h-45.05c-5.55,0-8.32,6.7-4.4,10.63l88.43,91.63c2.21,2.21,5.81,2.21,8.02,0l88.43-91.63c3.92-3.92,1.14-10.63-4.4-10.63h-45.05Z"/>
                    <path d="M2.75,202.34v41.97c0,8.13,6.59,14.72,14.72,14.72h216.66c8.13,0,14.72-6.59,14.72-14.72v-41.97"/>
                  </svg>
                </button>
              </div>
              <div class="card-body">
                <div class="activity-log">
                  ${p.activityLog.slice(0,4).map(item => `<div class="activity-item">${item}</div>`).join("")}
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      bindQuickNoteButton(
        drawerEl.querySelector("#btnVm"),
        () => logVm(p),
        () => logVm(p, { openDetails: true, showToastAction: false })
      );
      bindQuickNoteButton(
        drawerEl.querySelector("#btnReached"),
        () => markReached(p),
        () => markReached(p, { openDetails: true, showToastAction: false })
      );
      drawerEl.querySelectorAll('[data-doc]').forEach(el => {
        el.addEventListener("click", (e) => toggleDoc(p, e.target.dataset.doc));
      });
      drawerEl.querySelector("#btnPacket")?.addEventListener("click", () => generatePacket(p));
      drawerEl.querySelector("#btnDocsComplete")?.addEventListener("click", () => markDocsComplete(p));
      drawerEl.querySelector("#btnSendHH")?.addEventListener("click", () => requestSendReferral(p.id, "homeHealth"));
      drawerEl.querySelector("#btnSendDME")?.addEventListener("click", () => requestSendReferral(p.id, "dme"));
      drawerEl.querySelector("#btnAcceptHH")?.addEventListener("click", () => markReferral(p, "homeHealth", "accepted"));
      drawerEl.querySelector("#btnNeedsHH")?.addEventListener("click", () => markReferral(p, "homeHealth", "needs_info"));
      drawerEl.querySelector("#btnAcceptDME")?.addEventListener("click", () => markReferral(p, "dme", "accepted"));
      drawerEl.querySelector("#btnNeedsDME")?.addEventListener("click", () => markReferral(p, "dme", "needs_info"));
      drawerEl.querySelector("#btnNudge")?.addEventListener("click", () => nudgePhysician(p));
      drawerEl.querySelector("#btnSigned")?.addEventListener("click", () => markOrdersSigned(p));
      drawerEl.querySelector("#btnInfo")?.addEventListener("click", () => openInfoDrawer(p));
      drawerEl.querySelector("#btnContactOpen")?.addEventListener("click", () => openContactDrawer(p));

      const downloadBtnHtml = `
        <button class="btn-icon" aria-label="Open" title="Open" data-download="true">
          <svg viewBox="0 0 251.6 261.78" aria-hidden="true" style="transform: rotate(-90deg);">
            <path d="M168.79,110.02V12.56c0-5.42-4.39-9.81-9.81-9.81h-66.35c-5.42,0-9.81,4.39-9.81,9.81v97.45h-45.05c-5.55,0-8.32,6.7-4.4,10.63l88.43,91.63c2.21,2.21,5.81,2.21,8.02,0l88.43-91.63c3.92-3.92,1.14-10.63-4.4-10.63h-45.05Z"/>
            <path d="M2.75,202.34v41.97c0,8.13,6.59,14.72,14.72,14.72h216.66c8.13,0,14.72-6.59,14.72-14.72v-41.97"/>
          </svg>
        </button>
      `;
      drawerEl.querySelectorAll(".card-expand").forEach(el => {
        if (el.closest(".card")?.dataset.skipDownload === "true") return;
        if (!el.querySelector("[data-download]")) {
          el.insertAdjacentHTML("beforeend", downloadBtnHtml);
        }
      });

      drawerEl.querySelectorAll(".card-body").forEach(body => {
        const row = body.querySelector(".row-actions");
        const expand = body.querySelector(".card-expand");
        if (!row || !expand) return;
        if (row.querySelector(".row-actions-left")) return;
        row.classList.add("split");
        const left = document.createElement("div");
        left.className = "row-actions-left";
        while (row.firstChild) left.appendChild(row.firstChild);
        const right = document.createElement("div");
        right.className = "row-actions-right";
        while (expand.firstChild) right.appendChild(expand.firstChild);
        row.appendChild(left);
        row.appendChild(right);
        expand.remove();
      });
    };

    const docsMinimumComplete = (p) => p.docsChecklist.faceSheet && p.docsChecklist.orders;

    const logVm = async (p, opts = {}) => {
      const { openDetails = false, showToastAction = true } = opts;
      if (p.contactAttempts >= 2) return;
      const nowIso = new Date().toISOString();
      if (!token()) {
        p.contactAttempts += 1;
        p.contactStatus = p.contactAttempts >= 2 ? "not_reachable_final" : "attempted_vm";
        p.lastContactAttemptAt = nowIso;
        p.nextContactDueAt = null;
        addActivity(p, `Left voicemail (Attempt ${p.contactAttempts})`);
        showToast("VM logged", `Attempt ${p.contactAttempts} for ${p.name}`);
        render();
        return;
      }

      try {
        const payload = {
          admission_id: Number(p.id),
          note_name: ATTEMPT_NOTE_NAME,
          template_id: ATTEMPT_TEMPLATE_ID,
          workspace_key: WORKSPACE_KEY,
          attempt_detail: "Left voicemail",
          attempt_comments: ""
        };
        const res = await fetch("/api/sensys/admission-notes/upsert", {
          method: "POST",
          headers: { ...authHeaders(), "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error("Failed to log attempt");
        await loadAdmissionNotes([p.id]);
        if (openDetails) {
          openNoteDetailsModal(p, ATTEMPT_TEMPLATE_ID);
        } else if (showToastAction) {
          showToast("VM logged", `Attempt ${p.contactAttempts} for ${p.name}`, {
            label: "Complete details",
            onClick: () => openNoteDetailsModal(p, ATTEMPT_TEMPLATE_ID)
          });
        } else {
          showToast("VM logged", `Attempt ${p.contactAttempts} for ${p.name}`);
        }
        render();
      } catch (err) {
        console.warn("[Evolv SNF] attempt log failed:", err);
        showToast("Attempt failed", p.name);
      }
    };

    const markReached = async (p, opts = {}) => {
      const { openDetails = false, showToastAction = true } = opts;
      const nowIso = new Date().toISOString();
      if (!token()) {
        p.contactStatus = "reached";
        p.lastContactAttemptAt = nowIso;
        p.nextContactDueAt = null;
        addActivity(p, `Reached patient â€” ${REACHED_ANSWER}`);
        showToast("Patient reached", p.name);
        render();
        return;
      }

      try {
        const payload = {
          admission_id: Number(p.id),
          note_name: REACHED_NOTE_NAME,
          template_id: REACHED_TEMPLATE_ID,
          workspace_key: WORKSPACE_KEY,
          response1: REACHED_ANSWER,
          answer_field_key: REACHED_FIELD_KEY,
          answer_value_text: REACHED_ANSWER
        };
        const res = await fetch("/api/sensys/admission-notes/upsert", {
          method: "POST",
          headers: { ...authHeaders(), "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error("Failed to log reached note");
        await loadAdmissionNotes([p.id]);
        if (openDetails) {
          openNoteDetailsModal(p, REACHED_TEMPLATE_ID);
        } else if (showToastAction) {
          showToast("Patient reached", p.name, {
            label: "Complete details",
            onClick: () => openNoteDetailsModal(p, REACHED_TEMPLATE_ID)
          });
        } else {
          showToast("Patient reached", p.name);
        }
        render();
      } catch (err) {
        console.warn("[Evolv SNF] reached log failed:", err);
        showToast("Reached log failed", p.name);
      }
    };

    const resetContact = (p) => {
      p.contactStatus = "not_attempted";
      p.contactAttempts = 0;
      p.lastContactAttemptAt = null;
      p.nextContactDueAt = null;
      addActivity(p, "Contact reset");
      showToast("Contact reset", p.name);
      render();
    };

    const toggleDoc = (p, docKey) => {
      p.docsChecklist[docKey] = !p.docsChecklist[docKey];
      addActivity(p, `Docs updated: ${docKey}`);
      renderDrawer();
    };

    const generatePacket = (p) => {
      if (!docsMinimumComplete(p)) return;
      p.packetGenerated = true;
      addActivity(p, "Packet generated");
      showToast("Packet generated", p.name);
      render();
    };

    const markDocsComplete = (p) => {
      const missing = Object.keys(p.docsChecklist).filter(key => !p.docsChecklist[key]);
      if (missing.length) {
        docsModalBodyEl.innerHTML = `
          <p style="margin:0 0 10px;font-weight:800;color:var(--navy)">Complete these items first:</p>
          <ul style="margin:0 0 10px 18px;font-size:12px;color:#1f2937;font-weight:700">
            ${missing.map(item => `<li>${item}</li>`).join("")}
          </ul>
        `;
        openModal(docsModalEl);
        return;
      }
      p.docsStatus = "complete";
      p.packetGenerated = true;
      addActivity(p, "Docs marked complete");
      showToast("Docs marked complete", p.name);
      render();
    };

    const requestSendReferral = (patientId, service) => {
      const p = patients.find(pt => pt.id === patientId);
      if (!p) return;
      pendingReferral = { patientId, service };
      if (p.contactStatus !== "reached") {
        openModal(warningModalEl);
      } else {
        openSendModal(p, service);
      }
    };

    const openSendModal = (p, service) => {
      const method = getDeliveryMethod(p, service);
      const serviceName = service === "homeHealth" ? "Home Health" : "DME";
      simulateFailEl.checked = false;
      faxModalTitleEl.textContent = `${method === "fax" ? "Send Fax" : "Confirm Portal Referral"} â€¢ ${serviceName}`;
      faxModalBodyEl.innerHTML = `
        <p style="margin:0 0 10px;font-weight:800;color:var(--navy)">
          ${method === "fax" ? "Confirm sending discharge packet + orders." : "Confirm portal referral submission."}
        </p>
        <div class="card-meta" style="font-size:12px;color:var(--muted);font-weight:800">
          Patient: ${p.name} â€¢ ${p.facilityName}
        </div>
      `;
      if (method !== "fax") simulateFailEl.parentElement.style.display = "none";
      else simulateFailEl.parentElement.style.display = "block";
      openModal(faxModalEl);
    };

    const openPatientEditModal = (p) => {
      const details = p.patientDetails || {};
      editingPatientId = p.id;
      epFirstNameEl.value = details.firstName || "";
      epLastNameEl.value = details.lastName || "";
      epDobEl.value = details.dob || p.dob || "";
      epGenderEl.value = details.gender || "";
      epPhone1El.value = details.phone1 || p.phoneNumbers?.mobile || "";
      epPhone2El.value = details.phone2 || p.phoneNumbers?.home || "";
      epEmailEl.value = details.email || "";
      epEmail2El.value = details.email2 || "";
      epAddress1El.value = details.address1 || p.address?.line1 || "";
      epAddress2El.value = details.address2 || p.address?.line2 || "";
      epCityEl.value = details.city || p.address?.city || "";
      epStateEl.value = details.state || p.address?.state || "";
      epZipEl.value = details.zip || p.address?.zip || "";
      epInsuranceName1El.value = details.insuranceName1 || "";
      epInsuranceNumber1El.value = details.insuranceNumber1 || "";
      epInsuranceName2El.value = details.insuranceName2 || "";
      epInsuranceNumber2El.value = details.insuranceNumber2 || "";
      epNotes1El.value = details.notes1 || "";
      epNotes2El.value = details.notes2 || "";
      epExternalPatientIdEl.value = details.externalPatientId || "";
      epMrnEl.value = details.mrn || p.mrn || "";
      epSourceEl.value = details.source || "manual";
      epActiveEl.value = details.active || "1";
      openModal(patientEditModalEl);
    };

    const completeReferralSend = (p, service) => {
      const method = getDeliveryMethod(p, service);
      const ref = p.referrals[service];
      ref.lastSentAt = new Date().toISOString();
      ref.referralStatus = "sent";
      if (method === "fax") {
        if (simulateFailEl.checked) {
          ref.faxStatus = "failed";
          addActivity(p, `Fax failed (${service})`);
          showToast("Fax failed â€” moved to At Risk", p.name);
        } else {
          ref.faxStatus = "sent";
          addActivity(p, `Fax sent (${service})`);
          showToast("Fax sent successfully", p.name);
        }
      } else {
        ref.faxStatus = "n/a";
        addActivity(p, `Portal referral created (${service})`);
        showToast("Portal referral sent", p.name);
      }
      render();
    };

    const markReferral = (p, service, status) => {
      const ref = p.referrals[service];
      ref.referralStatus = status;
      addActivity(p, `${service} referral ${status.replace("_"," ")}`);
      showToast("Referral updated", `${p.name} â€¢ ${service}`);
      render();
    };

    const nudgePhysician = (p) => {
      p.ordersLastNudgeAt = new Date().toISOString();
      p.ordersNudgeCount += 1;
      addActivity(p, p.portalEligibility.physicianOnEsign ? "Nudge physician via portal" : "Text physician off-portal");
      showToast("Physician nudged", p.name);
      render();
    };

    const messageAgency = (p) => {
      addActivity(p, p.portalEligibility.homeHealthOnPortal ? "Message agency via portal" : "Call agency off-portal");
      showToast("Agency messaged", p.name);
      render();
    };

    const markOrdersSigned = (p) => {
      p.ordersStatus = "signed";
      addActivity(p, "Orders signed");
      showToast("Orders signed", p.name);
      render();
    };

    const markOrdersException = (p) => {
      p.ordersStatus = "exception_off_portal";
      addActivity(p, "Orders exception documented");
      showToast("Orders exception", p.name);
      render();
    };

    const openDcDetailsModal = (p) => {
      const dc = p.dcSubmission || {};
      const rows = [
        ["DC Date", dc.dcDate ? formatDate(dc.dcDate) : "â€”"],
        ["DC Confirmed", typeof dc.dcConfirmed === "boolean" ? (dc.dcConfirmed ? "Yes" : "No") : "â€”"],
        ["Urgent Request", typeof dc.dcUrgent === "boolean" ? (dc.dcUrgent ? "Yes" : "No") : "â€”"],
        ["Urgent Details", dc.urgentComments || "â€”"],
        ["Disposition", dc.disposition || "â€”"],
        ["Destination Details", dc.destinationComments || "â€”"],
        ["Discharge With", dc.dcWith || "â€”"],
        ["Home Health Services", (dc.hhServices || []).join(", ") || "â€”"],
        ["Other HH Services", (dc.hhOtherServices || []).join(", ") || "â€”"],
        ["HH Details", dc.hhComments || "â€”"],
        ["Preferred HH Agency", dc.hhAgency || "â€”"],
        ["HH Agency Details", dc.hhAgencyComments || "â€”"],
        ["DME Services", (dc.dmeServices || []).join(", ") || "â€”"],
        ["Other DME Services", (dc.dmeOtherServices || []).join(", ") || "â€”"],
        ["DME Details", dc.dmeComments || "â€”"],
        ["PCP Name", dc.pcpName || "â€”"],
        ["Coordinate Caregiver", typeof dc.coordinateCaregiver === "boolean" ? (dc.coordinateCaregiver ? "Yes" : "No") : "â€”"],
        ["Caregiver Name", dc.caregiverName || "â€”"],
        ["Caregiver Contact", dc.caregiverNumber || "â€”"],
        ["Appealing Discharge", typeof dc.appealingDc === "boolean" ? (dc.appealingDc ? "Yes" : "No") : "â€”"],
        ["Appeal Details", dc.appealComments || "â€”"]
      ];

      dcDetailsBodyEl.innerHTML = `
        <div class="info-section">
          <div class="info-grid">
            ${rows.map(([label, value]) => `
              <div class="info-block">
                <div class="info-label">${label}</div>
                <div class="info-value">${value}</div>
              </div>
            `).join("")}
          </div>
        </div>
      `;
      openModal(dcDetailsModalEl);
    };

    const openInfoDrawer = (p) => {
      const phones = p.phoneNumbers || {};
      const address = p.address || {};
      const dc = p.dcSubmission || {};
      const addressParts = [
        address.line1,
        address.line2,
        [address.city, address.state].filter(Boolean).join(", "),
        address.zip
      ].filter(Boolean);

      const hasValue = (val) => {
        if (Array.isArray(val)) return val.length > 0;
        if (typeof val === "boolean") return true;
        return val !== null && val !== undefined && String(val).trim() !== "";
      };

      const buildField = (label, value) => {
        if (!hasValue(value)) return "";
        const display = Array.isArray(value) ? value.join(", ") : (typeof value === "boolean" ? (value ? "Yes" : "No") : value);
        return `
          <div class="info-block">
            <div class="info-label">${label}</div>
            <div class="info-value">${display}</div>
          </div>
        `;
      };

      const buildChipBlock = (label, items, dangerItems = []) => {
        if (!hasValue(items)) return "";
        return `
          <div class="info-block">
            <div class="info-label">${label}</div>
            <div class="info-row" style="margin-top:6px">
              ${items.map(item => `<span class="service-pill ${dangerItems.includes(item) ? "danger" : ""}">${item}</span>`).join("")}
            </div>
          </div>
        `;
      };

      const dcDateBlock = hasValue(dc.dcDate) ? `
        <div class="info-block">
          <div class="info-label">DC Date</div>
          <div class="info-value">${formatDate(dc.dcDate)}</div>
          <div class="info-icons">
            <span class="info-icon ${dc.dcConfirmed ? "confirmed" : "pending"}" title="${dc.dcConfirmed ? "Confirmed" : "Not Confirmed"}" aria-hidden="true">
              <svg viewBox="0 0 236.3 236.3">
                <circle cx="118.15" cy="118.15" r="114.4" fill="none" stroke="currentColor"/>
                <polyline points="55.46 123.18 100.15 167.87 181.34 86.68" fill="none" stroke="currentColor"/>
              </svg>
            </span>
            ${dc.dcUrgent ? `
              <span class="info-icon alert" title="Urgent" aria-hidden="true">
                <svg viewBox="0 0 236.3 236.3">
                  <path d="M118.15,16.75l106.4,184.3c4.2,7.28-1.05,16.38-9.45,16.38H21.2c-8.4,0-13.65-9.1-9.45-16.38L118.15,16.75Z" fill="none" stroke="currentColor"/>
                  <line x1="118.15" y1="78.6" x2="118.15" y2="136.86" fill="none" stroke="currentColor"/>
                  <circle cx="118.15" cy="167.87" r="6.5" fill="none" stroke="currentColor"/>
                </svg>
              </span>` : ""}
          </div>
        </div>
      ` : "";

      const caregiverCombined = [
        dc.caregiverName ? dc.caregiverName.trim() : "",
        dc.caregiverNumber ? dc.caregiverNumber.trim() : ""
      ].filter(Boolean).join(" â€¢ ");

      const dispositionCombined = [dc.disposition, dc.dcWith].filter(Boolean).join(" - ");
      const dcFields = [
        dcDateBlock,
        buildField("Urgent Details", dc.urgentComments),
        buildField("Disposition", dispositionCombined),
        buildField("Destination Details", dc.destinationComments),
        buildChipBlock("Home Health Services", dc.hhServices || []),
        buildChipBlock("Other HH Services", dc.hhOtherServices || []),
        buildField("HH Details", dc.hhComments),
        buildField("Preferred HH Agency", dc.hhAgency),
        buildField("HH Agency Details", dc.hhAgencyComments),
        buildChipBlock("DME Services", dc.dmeServices || [], ["O2"]),
        buildChipBlock("Other DME Services", dc.dmeOtherServices || []),
        buildField("DME Details", dc.dmeComments),
        buildField("Coordinate Caregiver", typeof dc.coordinateCaregiver === "boolean" ? dc.coordinateCaregiver : null),
        buildField("Caregiver", caregiverCombined),
        buildField("Appealing Discharge", typeof dc.appealingDc === "boolean" ? dc.appealingDc : null),
        buildField("Appeal Details", dc.appealComments)
      ].filter(Boolean).join("");

      const infoBody = `
        <div class="info-section">
          <div class="info-row">
            <div class="info-block patient-card" style="flex:1;min-width:220px">
              <button class="icon-plain patient-edit-btn" id="btnInfoEdit" type="button" aria-label="Edit patient details" title="Edit patient details">
                <svg viewBox="0 0 237.85 237.86" aria-hidden="true">
                  <line x1="34.25" y1="178.82" x2="57.97" y2="202.54"/>
                  <path d="M68.74,219.9c-3.65,3.65-8.34,6.09-13.43,6.97l-47.25,8.18c-3.09.53-5.78-2.15-5.24-5.24l8.17-47.25c.88-5.09,3.31-9.78,6.97-13.44L173.79,13.27c14.02-14.02,36.76-14.03,50.78,0h0c14.02,14.02,14.03,36.76,0,50.79L68.74,219.9Z"/>
                </svg>
              </button>
              <div class="info-label">Patient</div>
              <div class="info-value">${p.name}${p.dob ? ` (${formatDob(p.dob)})` : ""}</div>
              ${addressParts.length ? `<div class="info-note" style="margin-top:4px">${addressParts.join(" â€¢ ")}</div>` : ""}
            </div>
          </div>
          <div class="info-row" style="margin-top:8px">
            ${buildField("Mobile", phones.mobile)}
            ${buildField("Home", phones.home)}
            ${buildField("Caregiver", phones.caregiver)}
          </div>
        </div>
        ${dcFields ? `
        <div class="info-section" style="margin-top:10px">
          <div class="info-label">DC Submission</div>
          <div class="info-grid">
            ${dcDateBlock}
            ${buildField("Urgent Details", dc.urgentComments)}
            ${buildField("Disposition", dispositionCombined)}
            ${buildField("Destination Details", dc.destinationComments)}
          </div>
          <div class="info-divider"></div>
          <div class="info-grid">
            ${buildChipBlock("Home Health Services", dc.hhServices || [])}
            ${buildChipBlock("Other HH Services", dc.hhOtherServices || [])}
            ${buildField("HH Details", dc.hhComments)}
            ${buildField("Preferred HH Agency", dc.hhAgency)}
            ${buildField("HH Agency Details", dc.hhAgencyComments)}
          </div>
          <div class="info-divider"></div>
          <div class="info-grid">
            ${buildChipBlock("DME Services", dc.dmeServices || [], ["O2"])}
            ${buildChipBlock("Other DME Services", dc.dmeOtherServices || [])}
            ${buildField("DME Details", dc.dmeComments)}
          </div>
          <div class="info-divider"></div>
          <div class="info-grid">
            ${buildField("Coordinate Caregiver", typeof dc.coordinateCaregiver === "boolean" ? dc.coordinateCaregiver : null)}
            ${buildField("Caregiver", caregiverCombined)}
            ${buildField("Appealing Discharge", typeof dc.appealingDc === "boolean" ? dc.appealingDc : null)}
            ${buildField("Appeal Details", dc.appealComments)}
          </div>
        </div>` : ""}
      `;

      infoDrawerEl.innerHTML = `
        <div class="drawer-header">
          <div>
            <div class="drawer-title">Patient Details</div>
            <div class="drawer-sub">${p.facilityName} â€¢ Discharge ${formatDateTime(p.dischargeDateTime)}</div>
          </div>
          <button class="btn btn-primary btn-small" id="btnInfoDone">Done</button>
        </div>
        <div class="drawer-body">${infoBody}</div>
      `;
      drawerEl.classList.remove("open");
      infoDrawerEl.classList.add("open");
      drawerOverlayEl.classList.add("show");
      updateFabState();
      infoDrawerEl.querySelector("#btnInfoDone")?.addEventListener("click", () => {
        infoDrawerEl.classList.remove("open");
        if (selectedPatientId) drawerEl.classList.add("open");
        updateFabState();
      });
      infoDrawerEl.querySelector("#btnInfoEdit")?.addEventListener("click", (e) => {
        e.stopPropagation();
        openPatientEditModal(p);
      });
    };

    const openContactDrawer = (p) => {
      const phones = p.phoneNumbers || {};
      const address = p.address || {};
      const addressParts = [
        address.line1,
        address.line2,
        [address.city, address.state].filter(Boolean).join(", "),
        address.zip
      ].filter(Boolean);
      const contactNotes = [
        ...getAttemptNotes(p).map(n => ({
          created_at: n.created_at,
          text: `Left voicemail${(n.attempt_comments || "").trim() ? ` â€” ${(n.attempt_comments || "").trim()}` : ""}`
        })),
        ...getReachedNotes(p).map(n => ({
          created_at: n.created_at,
          text: `Reached patient${(n.response1 || REACHED_ANSWER || "").trim() ? ` â€” ${(n.response1 || REACHED_ANSWER || "").trim()}` : ""}`
        }))
      ].filter(n => n.created_at)
        .sort((a,b) => new Date(b.created_at) - new Date(a.created_at))
        .map(n => `${formatStamp(new Date(n.created_at))} - ${n.text}`);

      const contactBody = `
        <div class="info-section">
          <div class="info-row">
            <div class="info-block patient-card" style="flex:1;min-width:220px">
              <div class="info-label">Patient</div>
              <div class="info-value">${p.name}${p.dob ? ` (${formatDob(p.dob)})` : ""}</div>
              ${addressParts.length ? `<div class="info-note" style="margin-top:4px">${addressParts.join(" â€¢ ")}</div>` : ""}
              <div class="info-row" style="margin-top:6px">
                ${phones.mobile ? `<span class="service-pill">M: ${phones.mobile}</span>` : ""}
                ${phones.home ? `<span class="service-pill">H: ${phones.home}</span>` : ""}
                ${phones.caregiver ? `<span class="service-pill">C: ${phones.caregiver}</span>` : ""}
              </div>
            </div>
          </div>
        </div>
        <div class="info-section" style="margin-top:8px">
          <div class="info-block">
            <div class="info-label">Instructions</div>
            <div class="info-note"><strong>Patient Script:</strong> Hi there, this is the care team calling to review your discharge plan and answer any questions you may have.</div>
            <div class="info-note" style="margin-top:6px"><strong>Additional Details:</strong> Medrina CCM</div>
            <div style="margin-top:10px">
              <button class="btn btn-small" id="btnDcDetails">Discharge Details</button>
            </div>
          </div>
        </div>
        <div class="info-divider"></div>
        <div class="info-section">
          <div class="row-actions split">
            <div class="row-actions-left">
              <div class="info-label">Contact Notes & Attempts (${p.contactAttempts}/2)</div>
            </div>
            <div class="row-actions-right">
              <button class="btn-icon down" id="btnContactAttempt" aria-label="Left VM" title="Left VM">
                <svg viewBox="0 0 233.12 234.63" aria-hidden="true">
                  <path d="M52.97,218.37H12.19c-5.21,0-9.44-4.23-9.44-9.44v-108.68c0-5.21,4.23-9.44,9.44-9.44h38.63c6.97-.01,13.73-2.63,18.73-7.49C90.09,63.36,113.34,16.95,122.19,7.1c3.98-4.7,9.44-4.71,13.07-4.03.07.02.13.03.2.05,25.27,5.85,14.83,46.22,5.35,66.57h0c-3.97,7.7,1.62,16.88,10.28,16.88h54.46c17.1,0,29.06,16.89,23.39,33.02l-33.11,94.15c-3.82,10.87-14.09,18.14-25.61,18.14h-64.57c-11.22,0-22.34-2.03-32.83-6l-19.86-7.51v-126.87"/>
                </svg>
              </button>
              <button class="btn-icon reached" id="btnContactReached" aria-label="Reached" title="Reached">
                <svg viewBox="0 0 233.12 234.63" aria-hidden="true">
                  <path d="M52.97,218.37H12.19c-5.21,0-9.44-4.23-9.44-9.44v-108.68c0-5.21,4.23-9.44,9.44-9.44h38.63c6.97-.01,13.73-2.63,18.73-7.49C90.09,63.36,113.34,16.95,122.19,7.1c3.98-4.7,9.44-4.71,13.07-4.03.07.02.13.03.2.05,25.27,5.85,14.83,46.22,5.35,66.57h0c-3.97,7.7,1.62,16.88,10.28,16.88h54.46c17.1,0,29.06,16.89,23.39,33.02l-33.11,94.15c-3.82,10.87-14.09,18.14-25.61,18.14h-64.57c-11.22,0-22.34-2.03-32.83-6l-19.86-7.51v-126.87"/>
                </svg>
              </button>
            </div>
          </div>
          <div class="activity-log" style="max-height:none">
            ${(contactNotes.length ? contactNotes : ["No contact notes yet."]).map(item => `<div class="activity-item">${item}</div>`).join("")}
          </div>
        </div>
      `;

      contactDrawerEl.innerHTML = `
        <div class="drawer-header">
          <div>
            <div class="drawer-title">Patient Contact</div>
            <div class="drawer-sub">${p.name} â€¢ ${p.facilityName}</div>
          </div>
          <button class="btn btn-primary btn-small" id="btnContactDone">Done</button>
        </div>
        <div class="drawer-body">${contactBody}</div>
      `;
      drawerEl.classList.remove("open");
      infoDrawerEl.classList.remove("open");
      contactDrawerEl.classList.add("open");
      drawerOverlayEl.classList.add("show");
      updateFabState();
      contactDrawerEl.querySelector("#btnContactDone")?.addEventListener("click", () => {
        contactDrawerEl.classList.remove("open");
        if (selectedPatientId) drawerEl.classList.add("open");
        updateFabState();
      });
      bindQuickNoteButton(
        contactDrawerEl.querySelector("#btnContactAttempt"),
        () => logVm(p),
        () => logVm(p, { openDetails: true, showToastAction: false })
      );
      bindQuickNoteButton(
        contactDrawerEl.querySelector("#btnContactReached"),
        () => markReached(p),
        () => markReached(p, { openDetails: true, showToastAction: false })
      );
      contactDrawerEl.querySelector("#btnDcDetails")?.addEventListener("click", () => openDcDetailsModal(p));
    };

    const openModal = (el) => { el.style.display = "flex"; };
    const closeModal = (el) => { el.style.display = "none"; };
    document.querySelectorAll("[data-close]").forEach(btn => {
      btn.addEventListener("click", () => closeModal(document.getElementById(btn.dataset.close)));
    });
    openFiltersEl.addEventListener("click", () => openModal(filtersModalEl));
    fabToggleEl?.addEventListener("click", () => {
      const anyOpen = drawerEl.classList.contains("open")
        || infoDrawerEl.classList.contains("open")
        || contactDrawerEl.classList.contains("open");
      if (anyOpen) return;
      fabUserOpen = !fabUserOpen;
      updateFabState();
    });

    const bindQuickNoteButton = (el, onClick, onHold) => {
      if (!el) return;
      let holdTimer = null;
      let held = false;

      const clearHold = () => {
        if (holdTimer) clearTimeout(holdTimer);
        holdTimer = null;
      };

      el.addEventListener("pointerdown", (e) => {
        if (e.pointerType !== "mouse") return;
        held = false;
        clearHold();
        holdTimer = setTimeout(() => {
          held = true;
          onHold && onHold();
        }, 450);
      });
      el.addEventListener("pointerup", () => clearHold());
      el.addEventListener("pointerleave", () => clearHold());
      el.addEventListener("click", (e) => {
        if (held) {
          held = false;
          e.preventDefault();
          return;
        }
        onClick && onClick();
      });
    };

    noteDetailsSaveEl.addEventListener("click", async () => {
      if (!noteDetailsContext || !token()) return;
      const p = patients.find(pt => String(pt.id) === String(noteDetailsContext.patientId));
      if (!p) return;

      const answers = [];
      noteDetailsBodyEl.querySelectorAll("[data-field-key]").forEach(el => {
        const key = el.dataset.fieldKey || "";
        const type = (el.dataset.fieldType || "text").toLowerCase();
        if (!key) return;
        const raw = (el.value || "").trim();
        if (raw === "") return;
        if (type === "number") {
          const num = Number(raw);
          if (!Number.isNaN(num)) answers.push({ field_key: key, value_num: num });
          return;
        }
        if (type === "date") {
          answers.push({ field_key: key, value_date: raw });
          return;
        }
        if (type === "boolean") {
          if (raw === "1" || raw === "0") answers.push({ field_key: key, value_bool: Number(raw) });
          return;
        }
        answers.push({ field_key: key, value_text: raw });
      });

      try {
        const payload = {
          id: noteDetailsContext.noteId || null,
          admission_id: Number(p.id),
          note_name: noteDetailsContext.noteName,
          template_id: noteDetailsContext.templateId,
          workspace_key: WORKSPACE_KEY,
          response1: noteDetailsContext.noteResponse1 || "",
          answers
        };
        const res = await fetch("/api/sensys/admission-notes/upsert", {
          method: "POST",
          headers: { ...authHeaders(), "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error("Failed to save note details");
        await loadAdmissionNotes([p.id]);
        closeModal(noteDetailsModalEl);
        showToast("Note updated", p.name);
        render();
      } catch (err) {
        console.warn("[Evolv SNF] note save failed:", err);
        showToast("Note save failed", p.name);
      }
    });

    contactDrawerEl.addEventListener("click", (event) => {
      const btn = event.target.closest("#btnContactEdit");
      if (!btn) return;
      const patientId = btn.dataset.patientId;
      const p = patients.find(pt => pt.id === patientId);
      if (p) openPatientEditModal(p);
    });

    warningContinueEl.addEventListener("click", () => {
      const p = patients.find(pt => pt.id === pendingReferral?.patientId);
      if (p) {
        addActivity(p, `Proceed referral before contact (${warningReasonEl.value})`);
        showToast("Proceeding before reach", p.name);
        closeModal(warningModalEl);
        openSendModal(p, pendingReferral.service);
      }
    });

    faxConfirmEl.addEventListener("click", () => {
      const p = patients.find(pt => pt.id === pendingReferral?.patientId);
      if (p) {
        closeModal(faxModalEl);
        completeReferralSend(p, pendingReferral.service);
        pendingReferral = null;
      }
    });

    epSaveEl.addEventListener("click", () => {
      const p = patients.find(pt => pt.id === editingPatientId);
      if (!p) return;
      const details = {
        firstName: epFirstNameEl.value.trim(),
        lastName: epLastNameEl.value.trim(),
        dob: epDobEl.value.trim(),
        gender: epGenderEl.value.trim(),
        phone1: epPhone1El.value.trim(),
        phone2: epPhone2El.value.trim(),
        email: epEmailEl.value.trim(),
        email2: epEmail2El.value.trim(),
        address1: epAddress1El.value.trim(),
        address2: epAddress2El.value.trim(),
        city: epCityEl.value.trim(),
        state: epStateEl.value.trim(),
        zip: epZipEl.value.trim(),
        insuranceName1: epInsuranceName1El.value.trim(),
        insuranceNumber1: epInsuranceNumber1El.value.trim(),
        insuranceName2: epInsuranceName2El.value.trim(),
        insuranceNumber2: epInsuranceNumber2El.value.trim(),
        notes1: epNotes1El.value.trim(),
        notes2: epNotes2El.value.trim(),
        externalPatientId: epExternalPatientIdEl.value.trim(),
        mrn: epMrnEl.value.trim(),
        source: epSourceEl.value.trim(),
        active: epActiveEl.value
      };

      p.patientDetails = { ...(p.patientDetails || {}), ...details };
      const fullName = [details.firstName, details.lastName].filter(Boolean).join(" ").trim();
      if (fullName) p.name = fullName;
      if (details.dob) p.dob = details.dob;
      if (details.mrn) p.mrn = details.mrn;
      p.phoneNumbers = {
        ...(p.phoneNumbers || {}),
        mobile: details.phone1 || p.phoneNumbers?.mobile || "",
        home: details.phone2 || p.phoneNumbers?.home || ""
      };
      p.address = {
        ...(p.address || {}),
        line1: details.address1 || "",
        line2: details.address2 || "",
        city: details.city || "",
        state: details.state || "",
        zip: details.zip || ""
      };
      closeModal(patientEditModalEl);
      showToast("Patient updated", p.name);
      render();
    });

    const populateFacilityFilter = () => {
      const facilities = [...new Set(patients.map(p => p.facilityName))];
      facilityFilterEl.innerHTML = `<option value="all">All</option>` + facilities.map(f => `<option>${f}</option>`).join("");
    };

    const render = () => {
      patients.forEach(recomputeDerived);
      renderQueues();
      renderHead();
      const queuePatients = patients.filter(p => inQueue(p, activeQueue) && matchesFilters(p));
      const sorted = sortPatients(queuePatients);
      renderSummary(queuePatients);
      renderTable(sorted);
      if (selectedPatientId) renderDrawer();
    };

    [searchInputEl, facilityFilterEl, dateFilterEl, sortFilterEl, toggleAtRiskEl, toggleOffPortalEl]
      .forEach(el => el.addEventListener("input", render));

    loadAdmissions();
  </script>
</body>
</html>
