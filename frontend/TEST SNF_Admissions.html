<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SNF Admissions – Audit & Notifications</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f5f7;
      color: #111827;
      line-height: 1.5;
    }

    header {
      padding: 10px 18px;
      background: #111827;
      color: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.35);
    }

    header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.03em;
    }

    header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.03em;
    }

    /* Header right-side group: status chips + buttons */
    .header-right{
      display:flex;
      align-items:center;
      gap:10px;
    }

    /* Small status chips (right side, not behind buttons) */
    .header-status{
      font-size:12px;
      color:#e5e7eb;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(229,231,235,0.22);
      background:rgba(255,255,255,0.06);
      white-space:nowrap;
    }

    /* Icon links: NO absolute positioning anymore */
    .admin-link,
    .email-link{
      width:34px;
      height:34px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:12px;
      color:#e5e7eb;
      text-decoration:none;
      border:1px solid rgba(229,231,235,0.22);
      background:rgba(255,255,255,0.06);
      transition:transform .08s ease, background .15s ease, border-color .15s ease, color .15s ease;
    }

    .email-link:hover{
      background:rgba(255,255,255,0.12);
      border-color:rgba(168,230,207,0.55);
      color:#ffffff;
    }
    .email-link:active{
      transform:scale(0.96);
    }

    /* NEW: Email Log modal layout */
    .email-log-wrap{
      display:grid;
      grid-template-columns: 1.05fr 1fr;
      gap:12px;
      height: min(70vh, 620px);   /* not too tall; fits screen */
      min-height: 360px;
    }
    .email-log-card{
      border:1px solid #e5e7eb;
      border-radius:14px;
      background:#fafafa;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .email-log-card-head{
      padding:10px 12px;
      border-bottom:1px solid #e5e7eb;
      background:#ffffff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .email-log-card-title{
      font-weight:800;
      color:#111827;
      font-size:13px;
    }
    .email-log-scroll{
      padding:10px 12px;
      overflow:auto;
      min-height:0;
    }

    .email-item{
      border:1px solid #e5e7eb;
      background:#ffffff;
      border-radius:12px;
      padding:10px 10px;
      margin-bottom:10px;
      cursor:pointer;
      transition: border-color .15s ease, box-shadow .15s ease, transform .08s ease;
    }
    .email-item:hover{
      border-color: rgba(168,230,207,0.75);
      box-shadow: 0 10px 24px rgba(15,23,42,0.10);
    }
    .email-item:active{ transform: scale(0.99); }
    .email-item.active{
      border-color:#A8E6CF;
      box-shadow: 0 0 0 3px rgba(168,230,207,0.30);
    }
    .email-item-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .email-fac{
      font-weight:800;
      font-size:13px;
      color:#111827;
      line-height:1.2;
    }
    .email-meta{
      font-size:11px;
      color:#6b7280;
      margin-top:6px;
      line-height:1.35;
      word-break:break-word;
    }
    .pdf-btn{
      border:1px solid #e5e7eb;
      background:#ffffff;
      border-radius:10px;
      width:30px;
      height:30px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      flex:0 0 auto;
    }
    .pdf-btn:hover{
      border-color: rgba(168,230,207,0.85);
    }
    .pdf-btn svg{ width:16px; height:16px; color:#0D3B66; }

    .open-row{
      border:1px solid #e5e7eb;
      background:#ffffff;
      border-radius:12px;
      padding:10px 10px;
      margin-bottom:10px;
    }
    .open-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .pin-pill{
      font-size:11px;
      font-weight:800;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      color:#111827;
      text-transform:uppercase;
      letter-spacing:0.03em;
    }
    .pin-pill.facility{ border-color:#A8E6CF; }
    .pin-pill.universal{ border-color:#93c5fd; }
    .pin-pill.default{ border-color:#fca5a5; }

    .open-sub{
      font-size:11px;
      color:#6b7280;
      margin-top:6px;
      word-break:break-word;
    }
    
    .admin-link:hover{
      background:rgba(255,255,255,0.12);
      border-color:rgba(168,230,207,0.55);
      color:#ffffff;
    }
    .admin-link:active{
      transform:scale(0.96);
    }

    main {
      display: grid;
      grid-template-columns: 2fr 1.3fr;
      gap: 16px;
      padding: 24px 24px 32px;
      box-sizing: border-box;
    }

    .panel {
      background: #ffffff;
      border-radius: 20px;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.12);
      display: flex;
      flex-direction: column;
      border: 1px solid #e5e7eb;
      overflow: hidden;
    }

    .panel-header {
      padding: 12px 16px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      background: #f9fafb;
    }

    .panel-header h2 {
      margin: 0;
      font-size: 15px;
      font-weight: 700;
      color: #111827;
    }


    /* Make the two panels fill the viewport under the header */
    main {
      height: calc(100vh - 70px); /* adjust 70px if your header height changes */
    }

    /* Critical for nested flex scroll areas */
    .panel,
    .table-wrapper,
    #note-panel {
      min-height: 0;
    }

    /* Left table already scrolls via .table-wrapper { overflow:auto; } */

    /* Right panel: ONLY the note text area scrolls */
    #note-text {
      overflow: auto;
      flex: 1;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: flex-end;
      font-size: 12px;
    }

    label {
      font-size: 11px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.09em;
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    select,
    textarea {
      padding: 5px 8px;
      font-size: 12px;
      border: 1px solid #d1d5db;
      border-radius: 999px;
      background: #ffffff;
      box-sizing: border-box;
    }

    button {
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 4px;
      border: 1px solid #4b5563;
      background: #f9fafb;
      cursor: pointer;
    }
    button.primary {
      background: #2563eb;
      border-color: #2563eb;
      color: #f9fafb;
    }
    button.small {
      font-size: 11px;
      padding: 2px 6px;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .token-box {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
    }
    .token-box input {
      width: 180px;
    }
    .table-wrapper {
      flex: 1;
      overflow: auto;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead {
      position: sticky;
      top: 0;
      background: #f3f4ff;
      z-index: 1;
    }

    th,
    td {
      border-bottom: 1px solid #e5e7eb;
      padding: 8px 10px;
      vertical-align: middle;
      text-align: left;
    }

    th {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: #4b5563;
      white-space: nowrap;
    }

    tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    tbody tr:hover {
      background: #eef2ff;
    }

    td {
      color: #111827;
    }

    /* Status rows: no fill colors — keep zebra (white + cool grey) */
    tr.pending,
    tr.projected,
    tr.confirmed,
    tr.corrected,
    tr.rejected,
    tr.removed{
      background: transparent;
    }

    tr.selected {
      outline: 2px solid #2563eb;
    }
    .status-pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 500;
      text-transform: capitalize;
      border: 1px solid transparent;
    }

    .status-pill.pending {
      background: #fffbeb;
      color: #92400e;
      border-color: #fed7aa;
    }

    /* New = no color */
    .status-pill.new{
      background: transparent;
      color:#374151;
      border:1px solid #e5e7eb;
    }

    /* Dispo + Agency = same muted yellow as Pending */
    .status-pill.dispo,
    .status-pill.agency{
      background:#fffbeb;
      color:#92400e;
      border:1px solid #fbbf24;
    }

    .status-pill.confirmed {
      background: #ecfdf3;
      color: #166534;
      border-color: #bbf7d0;
    }

    .status-pill.corrected {
      background: #e0f2fe;
      color: #075985;
      border-color: #bae6fd;
    }

    .status-pill.rejected {
      background: #fef2f2;
      color: #991b1b;
      border-color: #fecaca;
    }

    .status-pill.removed {
      background: #e5e7eb;
      color: #374151;
      border-color: #d1d5db;
    }

    .note-body {
      flex: 1;
      padding: 12px 16px;
      overflow: auto;
      background: #ffffff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      font-size: 12px;
    }
    .note-entry {
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px dashed #e5e7eb;
    }
    .note-entry:last-child {
      border-bottom: none;
    }
    .note-entry-header {
      font-weight: 600;
      margin-bottom: 4px;
      color: #111827;
    }
    .note-entry-body {
      color: #4b5563;
    }
    
    /* NEW: note header row with created_at + delete */
    .note-entry-header-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .note-entry-header-left{
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .note-entry-header-right{
      display:inline-flex;
      align-items:center;
      gap:8px;
      flex: 0 0 auto;
    }
    .note-created-at{
      font-size:11px;
      color:#6b7280;
      font-weight:600;
      white-space:nowrap;
    }
    /* NOTE delete icon — no button box, icon-only */
    .note-mini-btn{
      border:none;
      background:transparent;
      width:auto;
      height:auto;
      padding:0;
      margin:0;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }

    .note-mini-btn:hover{
      opacity:0.65;   /* subtle hover, no box */
    }

    .note-mini-btn svg{
      width:16px;
      height:16px;
      color: rgba(13,59,102,0.78);
    }

    /* NEW: keyword highlight */
    .kw-hl {
      background: #A8E6CF;
      padding: 0 2px;
      border-radius: 4px;
    }

    /* NEW: bell icon button in note card header */
    .note-tools {
      margin-left: auto;
      display: inline-flex;
      gap: 8px;
      align-items: center;
    }
    .icon-btn {
      width: 40px;                 /* ← change me */
      height: 40px;                /* ← change me */
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
      overflow: hidden;            /* keeps it clean if icon is large */
    }
    .icon-btn:hover { background: #f9fafb; }

    .icon-btn.on {
      border-color: #A8E6CF;
      box-shadow: 0 0 0 3px rgba(168, 230, 207, 0.28);
    }

    .icon-btn .bell {
      width: 50%;                  /* ← change me (icon size inside box) */
      height: 50%;                 /* ← change me */
      display: block;
      color: #9ca3af;
    }
    .icon-btn.on .bell {
      color: #A8E6CF;      /* mint when checked */
    }

    .icon-btn .sparkles {
      width: 55%;
      height: 55%;
      display: block;
      color: #9ca3af;
    }

    /* NEW: user-check icon sizing to match bell */
    .icon-btn .usercheck{
      width: 56%;
      height: 56%;
      display: block;
      color: #9ca3af;
    }
    .icon-btn.on .usercheck{
      color: #A8E6CF;
    }

    :root{
      --mint-accent: #A8E6CF;
      --danger-muted: #C76B6B;
    }
    .fac-subrow{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:10.5px;
      color:#6b7280;
      margin-top:2px;
      line-height:1.15;
    }
    .assign-dot{
      width:8px;
      height:8px;
      border-radius:999px;
      display:inline-block;
      box-shadow: 0 0 0 3px rgba(168,230,207,0.18);
      flex: 0 0 auto;
    }
    .assign-dot.mint-accent{ background: var(--mint-accent); }
    .assign-dot.neg-accent{
      background: var(--danger-muted);
      box-shadow: 0 0 0 3px rgba(199,107,107,0.18);
    }

    /* NEW: subtle list icon */
    .notif-dot {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
      margin-left: 6px;
    }
    .notif-dot svg { width: 12px; height: 12px; color: #A8E6CF; }

    .note-meta {
      padding: 10px 16px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 12px;
      background: #f9fafb;
      color: #4b5563;
    }
    .note-meta div:first-child {
      font-weight: 600;
      color: #111827;
    }
    .note-meta div {
      margin-bottom: 2px;
    }

    /* New: emailed badge styling */
    .email-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 500;
      border: 1px solid #d1d5db;
    }
    .email-badge.sent {
      background: #ecfdf3;
      color: #166534;
      border-color: #bbf7d0;
    }
    .email-badge.not-sent {
      background: #fef2f2;
      color: #991b1b;
      border-color: #fecaca;
    }

    .note-footer {
      padding: 8px 12px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      gap: 4px;
      background: #ffffff;
    }

    .note-footer textarea {
      width: 100%;
      min-height: 40px;
      resize: vertical;
    }
    .flex-row {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .message {
      font-size: 11px;
      color: #4b5563;
    }
    .message strong {
      color: #111827;
    }

    /* ===============================
       Facility hover tooltip (Attendings)
       =============================== */
    .fac-hover{
      position:relative;
      display:inline-block;
      cursor:help;
    }

    .fac-tip{
      position:absolute;
      left:0;
      top:100%;
      margin-top:8px;
      width:max-content;
      max-width:320px;

      background:#ffffff;
      border:1px solid rgba(13,59,102,18);
      border-radius:14px;
      box-shadow: 0 10px 22px rgba(13,59,102,14);
      padding:10px 12px;

      z-index:50;
      display:none;
    }

    .fac-hover:hover .fac-tip{
      display:block;
    }

    .fac-tip .fac-tip-title{
      font-size:11px;
      font-weight:900;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:rgba(13,59,102,85);
      margin-bottom:6px;
    }

    .fac-tip .fac-tip-body{
      font-size:12px;
      font-weight:800;
      color:#0f172a;
      line-height:1.25;
      white-space:pre-line; /* allows newline formatting */
    }

    .fac-tip .fac-tip-empty{
      font-size:12px;
      font-weight:800;
      color:#55657f;
    }

    /* =========================================================
       EVOLV — Palette A (Main Page Overhaul)
       NOTE: Scoped to header/main/panels/table only.
             Modals keep their existing styling.
       ========================================================= */

    :root{
      --navy:#0D3B66;
      --mint:#A8E6CF;
      --sky:#4DA8DA; /* micro accent only */
      --cool:#F5F7FA;

      --surface:#ffffff;
      --text:#0f172a;
      --muted:#55657f;

      --line: rgba(13,59,102,.14);
      --line-strong: rgba(13,59,102,.22);

      --shadow: 0 10px 28px rgba(0,0,0,.08);
      --shadow-soft: 0 8px 18px rgba(13,59,102,.12);

      --r-xl:18px;
      --r-lg:16px;
      --r-md:12px;
      --r-sm:10px;

      --ring: 0 0 0 3px rgba(168,230,207,.50);
      --ring2: 0 0 0 4px rgba(168,230,207,.35);
    }

    /* Page background */
    body{
      background:
        radial-gradient(900px 520px at 10% 0%, rgba(77,168,218,.10), transparent 55%),
        radial-gradient(900px 520px at 95% 12%, rgba(168,230,207,.10), transparent 55%),
        var(--cool);
      color: var(--text);
    }

    /* Header becomes Evolv “glass card” (keep your same markup + JS) */
    header{
      position: sticky;
      top: 12px;
      z-index: 50;
      margin: 12px 16px 0;
      padding: 14px 16px;
      border-radius: var(--r-xl);
      border: 1px solid var(--line);
      background: rgba(255,255,255,.78);
      backdrop-filter: blur(6px);
      box-shadow: var(--shadow);
      color: var(--text);
    }

    header h1{
      color: var(--navy);
      font-size: 18px;
      font-weight: 900;
      letter-spacing: .2px;
    }

    /* Right side chips */
    .header-status{
      font-size: 12px;
      font-weight: 900;
      color: rgba(13,59,102,.90);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line-strong);
      background: rgba(13,59,102,.04);
      white-space: nowrap;
    }

    /* Icon buttons (Email Log / Settings) */
    .icon-btn{
      display:inline-flex; align-items:center; justify-content:center;
      width:42px; height:38px;
      border-radius:12px;
      border:1px solid var(--line-strong);
      background:#fff;
      cursor:pointer;
      transition: box-shadow .15s ease, border-color .15s ease, transform .15s ease;
      color: var(--navy);
    }
    .icon-btn:hover{
      border-color: rgba(168,230,207,.9);
      box-shadow: var(--ring2);
      transform: translateY(-1px);
    }
    .icon-btn:active{ transform: translateY(0px); }

    /* Make your header <a> links look like icon buttons */
    /* Keep header links as links, but allow icon-btn to control the box */
    a.email-link, a.admin-link{
      color:inherit;
      text-decoration:none;
    }

    /* Layout: keep your grid, but use Evolv spacing */
    main{
      padding: 16px;
      gap: 16px;
      height: calc(100vh - 110px); /* header is taller now */
    }

    /* Panels become Evolv cards */
    .panel{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.84);
      backdrop-filter: blur(4px);
      border-radius: var(--r-xl);
      box-shadow: var(--shadow);
    }

    .panel-header{
      border-bottom: 1px solid rgba(13,59,102,.10);
      background: linear-gradient(180deg, rgba(13,59,102,.06), rgba(255,255,255,0));
      padding: 12px 14px;
    }

    .panel-header h2{
      margin: 0;
      color: var(--navy);
      font-size: 15px;
      font-weight: 900;
      letter-spacing: .2px;
    }

    /* Filters + labels */
    .filters{
      gap: 12px;
      align-items: end;
      font-size: 12px;
    }
    .filters label,
    .note-footer label,
    .panel-header label{
      display:block;
      font-size:12px;
      color:#374151;
      margin:0 0 2px; /* tighter */
      font-weight:900;
      text-transform:none;
      letter-spacing:0;
    }

    /* remove the extra line-gap created by the <br /> after labels in filters */
    .filters br{ display:none; }

    /* Evolv inputs/selects for MAIN page (modals override later anyway) */
    input[type="text"],
    input[type="date"],
    input[type="number"],
    input[type="datetime-local"],
    select,
    textarea{
      padding: 10px 12px;
      font-size: 14px;
      border-radius: 12px;
      border: 1px solid rgba(13,59,102,.18);
      background:#fff;
      outline:none;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(168,230,207,.95);
      box-shadow: var(--ring);
    }

    /* Buttons (MAIN page only) — use these classes in the HTML edits below */
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      border-radius:12px; padding:10px 14px;
      border:1px solid var(--line-strong);
      background:#fff; color:var(--navy);
      font-weight:900; font-size:13px;
      cursor:pointer;
      transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease, background .15s ease, color .15s ease;
    }
    .btn:hover{ border-color: rgba(168,230,207,.9); box-shadow: var(--ring2); transform: translateY(-1px); }
    .btn:active{ transform: translateY(0px); }
    .btn-primary{ background: var(--navy); border-color: rgba(13,59,102,.95); color:#fff; box-shadow: var(--shadow-soft); }
    .btn-primary:hover{ background:#0b3357; border-color:#0b3357; box-shadow: 0 10px 26px rgba(13,59,102,.18); }
    .btn-small{ padding:8px 12px; border-radius:10px; font-size:12px; }

    /* Message text */
    .message{ color: var(--muted); font-size: 12px; font-weight: 800; }

    /* Table wrapper becomes Evolv */
    .table-wrapper{
      border-radius: 16px;
      border: 1px solid rgba(13,59,102,.14);
      background:#fff;
      overflow:auto;
    }
    thead{
      background: rgba(13,59,102,.05);
    }
    th{
      font-size:10px;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:.09em;
      color:#4b5563;
      border-bottom:1px solid rgba(13,59,102,.12);
      white-space:nowrap;
    }
    td{
      border-bottom:1px solid rgba(13,59,102,.10);
      color:#111827;
      vertical-align:middle;
    }
    tbody tr:nth-child(even){ background: rgba(13,59,102,.02); }
    tbody tr:hover{ background: rgba(168,230,207,.18); }

    /* Status pill becomes subtle + navy-first */
    .status-pill{
      display:inline-flex;
      align-items:center;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 900;
      border: 1px solid rgba(13,59,102,.16);
      background: rgba(13,59,102,.04);
      color: rgba(13,59,102,.92);
      text-transform: capitalize;
      letter-spacing: .02em;
    }

    /* Selected row uses mint outline (instead of bright blue) */
    tr.selected{
      outline: 2px solid rgba(168,230,207,.95);
    }

    /* Status rows: do NOT tint rows (keep zebra only) */
    tr.new,
    tr.dispo,
    tr.agency,
    tr.pending,
    tr.projected,
    tr.confirmed,
    tr.corrected,
    tr.rejected,
    tr.removed{
      background: transparent !important;
    }

    /* Note panel area */
    .note-body{ background:#fff; }

    /* Keep your notif dot, but make it micro-accent (sky) */
    .notif-dot svg{ color: var(--sky); }

  </style>
</head>
<body>
  <header>
    <h1>SNF Admissions – Audit & Notifications</h1>

    <div class="header-right">
      <div id="universal-pin-status-top" class="header-status">Universal PIN: …</div>
      <div id="last-processed-status-top" class="header-status">Last API: …</div>
      <div id="admin-token-status-top" class="header-status">Admin Token: …</div>
      
      <!-- NEW: Add Patient / Manual CM Note (matches icon-btn sizing) -->
      <a href="#"
         class="email-link icon-btn"
         onclick="openManualCmNoteModal(); return false;"
         aria-label="Add patient (manual CM note)"
         title="Add patient (manual CM note)">
        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" fill="none">
          <circle cx="10" cy="8" r="4" stroke="currentColor" stroke-width="1.8"></circle>
          <path d="M4 20c1-3 3.8-5.5 6-5.5s5 2 6 5.5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"></path>
          <path d="M18 8v8" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"></path>
          <path d="M15 11h8" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"></path>
        </svg>
      </a>

      <!-- Email log link -->
      <a href="#"
         class="email-link icon-btn"
         aria-label="Open Email Log"
         title="Email Log"
         onclick="openEmailLogModal(); return false;">
        <!-- mail icon (SVG) -->
        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
          <path d="M4 6h16v12H4V6z" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
          <path d="M4 7l8 6 8-6" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
        </svg>
      </a>

      <!-- Reports link -->
      <a href="#"
         class="email-link icon-btn"
         aria-label="Open Reports"
         title="Reports"
         onclick="openReportsModal(); return false;">
        <!-- bar chart icon (SVG) -->
        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" fill="none">
          <path d="M4 19V5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
          <path d="M4 19h16" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
          <path d="M7 19v-7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
          <path d="M12 19v-11" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
          <path d="M17 19v-4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
        </svg>
      </a>

      <!-- Settings link -->
      <a href="#"
         class="admin-link icon-btn"
         aria-label="Open Settings"
         title="Settings"
         onclick="openSettingsModal(); return false;">
        <!-- lock icon (SVG) -->
        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
          <path d="M7 10V8a5 5 0 0 1 10 0v2m-9 0h8a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2v-6a2 2 0 0 1 2-2z"
                fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </a>
    </div>
  </header>

  <main>
    <!-- Left panel: admissions list -->
    <section class="panel">
      <div class="panel-header">
        <h2>Upcoming SNF admissions</h2>
        <div class="filters" style="display:none;"></div>
      </div>
      <div class="panel-header" style="border-top:1px solid #e5e7eb; justify-content:space-between;">
        <div class="flex-row" style="flex:1;">
          <button class="btn btn-primary btn-small" onclick="sendEmails(false)">Send Email</button>
          <button class="btn btn-small" onclick="sendEmails(true)">Test email</button>
          <input id="test-email-to" type="text" placeholder="test@example.com (for test only)" style="width:180px;" />
        </div>

        <div class="flex-row" style="gap:8px;">
          <!-- Live search (patient name + visit_id) -->
          <input
            id="snf-search"
            type="text"
            placeholder="Search patient or visit…"
            style="width:220px;"
            oninput="onSnfSearchInput()"
          />

          <!-- Load (icon button) -->
          <button class="icon-btn" title="Load" aria-label="Load" onclick="loadAdmissions()">
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
              <path d="M21 12a9 9 0 1 1-2.6-6.4" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
              <path d="M21 3v6h-6" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>

          <!-- Filter (icon button) -->
          <button class="icon-btn" title="Filters" aria-label="Filters" onclick="openFiltersModal()">
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
              <path d="M4 6h16" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
              <path d="M7 12h10" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
              <path d="M10 18h4" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
      </div>

      <div class="panel-header" style="border-top:0; padding-top:6px;">
        <div id="list-message" class="message"></div>
      </div>
      <div class="table-wrapper">
        <table id="snf-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Patient</th>
              <th>From (Hospital)</th>
              <th>Facility (AI)</th>
              <th>Effective date</th>
              <th>AI conf</th>
              <th>Status</th>
              <th>Emailed</th>
              <th>Last Updated</th>
            </tr>
          </thead>
          <tbody id="snf-body">
            <!-- rows injected via JS -->
          </tbody>
        </table>
      </div>
    </section>

    <!-- Right panel: note viewer + edit form -->
    <section class="panel" id="note-panel">
      <div class="panel-header">
        <h2>Case Management Note</h2>

        <div class="note-tools">
          <button type="button" class="icon-btn" id="notif-btn" title="Notification details" onclick="openNotifModal()">
            <!-- bell icon (SVG) -->
            <svg class="bell" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 22a2 2 0 0 0 2-2H10a2 2 0 0 0 2 2Z" stroke="currentColor" stroke-width="2"/>
              <path d="M18 16v-5a6 6 0 1 0-12 0v5l-2 2h16l-2-2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            </svg>
          </button>

          <!-- SNF Physician Assignment -->
          <button type="button" class="icon-btn" id="phys-assign-btn" title="SNF Physician Assignment" onclick="openPhysAssignModal()">
            <svg class="usercheck" viewBox="0 0 24 24" aria-hidden="true" fill="none">
              <circle cx="10" cy="8" r="3.4" stroke="currentColor" stroke-width="2"></circle>
              <path d="M3.8 19.2c.9-3.6 3.7-5.6 6.2-5.6s5.3 2 6.2 5.6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
              <path d="M13.2 15.2l2.2 2.2 4.8-4.8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
          </button>

          <!-- NEW: AI Summarize (sparkles) -->
          <button type="button" class="icon-btn" id="ai-sum-btn" title="AI Summary" onclick="openAiSummaryModal()">
            <!-- sparkles/glimmer icon -->
            <svg class="sparkles" viewBox="0 0 24 24" aria-hidden="true" fill="none">
              <path d="M12 2l1.2 4.2L17.4 7.4l-4.2 1.2L12 12.8l-1.2-4.2L6.6 7.4l4.2-1.2L12 2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
              <path d="M19 10l.8 2.8L22.6 13.6l-2.8.8L19 17.2l-.8-2.8-2.8-.8 2.8-.8L19 10Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
              <path d="M4.8 12.5l.7 2.4 2.4.7-2.4.7-.7 2.4-.7-2.4-2.4-.7 2.4-.7.7-2.4Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            </svg>
          </button>

          <div id="note-header-summary" class="message"></div>
        </div>
      </div>
      <div class="note-meta" id="note-meta">
        <div>Select a row to load the note.</div>
      </div>
      <div class="note-body" id="note-text">
        <!-- Raw note text -->
      </div>
      <div class="note-footer">
        <div class="flex-row">
          <label for="edit-status">Status</label>
          <select id="edit-status">
            <option value="new">New</option>
            <option value="dispo">Dispo</option>
            <option value="agency">Agency</option>          
            <option value="pending">Pending</option>
            <option value="projected">Projected</option>
            <option value="confirmed">Confirmed</option>
            <option value="corrected">Corrected</option>
            <option value="rejected">Rejected</option>
            <option value="removed">Removed</option>
          </select>

          <label for="edit-disposition">Disposition</label>
          <select id="edit-disposition">
            <option value="">(none)</option>
            <option value="SNF">SNF</option>
            <option value="LTC">LTC</option>
            <option value="Home Health">Home Health</option>
            <option value="Home Self-care">Home Self-care</option>
            <option value="IRF">IRF</option>
            <option value="LTACH">LTACH</option>
            <option value="Other">Other</option>
            <option value="Unknown">Unknown</option>
          </select>

          <label for="edit-date">DC Date</label>
          <input id="edit-date" type="date" />
        </div>
        <div>
          <label for="edit-facility-select">Facility</label>
          <select id="edit-facility-select" style="width:100%;">
            <option value="">(none)</option>
          </select>
        </div>
        <div>
          <label for="edit-comments">Review comments</label>
          <textarea id="edit-comments" placeholder="Notes on why SNF / corrections, etc."></textarea>
        </div>
        <div class="flex-row">
          <button class="btn btn-primary btn-small" onclick="saveCurrent()">Save</button>
          <span id="note-message" class="message"></span>
        </div>
      </div>
    </section>
      <!-- Settings modal (styled like Facility modal) -->
      <div id="settings-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="settings-modal-title">
        <div class="modal-card" style="max-height: calc(100vh - 120px); display:flex; flex-direction:column;">
          <div class="modal-head">

            <div>
              <div id="settings-modal-title" class="modal-title">Settings</div>
              <div class="modal-sub">Admin token, universal PIN, and keyword highlighting.</div>
            </div>
            <button class="modal-x" onclick="closeSettingsModal()" aria-label="Close">✕</button>
          </div>

          <div class="modal-body" style="flex:1; overflow:auto;">
            <!-- Admin token -->
            <div style="border:1px solid #e5e7eb; border-radius:14px; padding:12px; background:#fafafa;">
              <div style="font-weight:800; color:#111827; margin-bottom:8px;">Admin token</div>
              <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                <input id="admin-token-input" type="password" placeholder="Paste ADMIN_TOKEN" style="width:320px;" />
                <button class="small" onclick="saveAdminToken()">Save</button>
                <span id="token-status" class="message"></span>
              </div>
            </div>

            <!-- PAD Flow email notifications -->
            <div style="border:1px solid #e5e7eb; border-radius:14px; padding:12px; background:#fafafa; margin-top:12px;">
              <div style="font-weight:800; color:#111827; margin-bottom:6px;">PAD flow email notifications</div>
              <div style="font-size:12px; color:#6b7280; margin-bottom:10px;">
                Recipients get an email on PAD flow <strong>start</strong>, <strong>stop</strong>, and <strong>error</strong>.
              </div>

              <label for="pad-email-recipients" style="margin-top:0;">Recipients (comma or new-line separated)</label>
              <textarea id="pad-email-recipients" rows="3" placeholder="ops@…&#10;you@…"
                        style="resize:vertical;"></textarea>

              <div class="flex-row" style="margin-top:10px;">
                <button class="btn-primary btn-small" onclick="savePadEmailRecipients()">Save recipients</button>
                <button class="btn-lite btn-small" onclick="loadPadEmailRecipients()">Refresh</button>
                <span id="pad-email-status" class="message"></span>
              </div>
            </div>

            <!-- Last processed API -->
            <div style="border:1px solid #e5e7eb; border-radius:14px; padding:12px; background:#fafafa; margin-top:12px;">
              <div style="font-weight:800; color:#111827;">Last processed API</div>
              <div id="last-processed-status-modal" style="font-size:12px; color:#6b7280; margin-top:2px;">Last API: …</div>
            </div>

            <!-- Universal PIN -->
            <div style="border:1px solid #e5e7eb; border-radius:14px; padding:12px; background:#fafafa; margin-top:12px;">
              <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                <div>
                  <div style="font-weight:800; color:#111827;">Universal PIN (fallback)</div>
                  <div id="universal-pin-status-modal" style="font-size:12px; color:#6b7280; margin-top:2px;">Universal PIN: …</div>
                </div>
                <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                  <input id="universal-pin" type="password" placeholder="Set universal PIN" style="width:220px;" />
                  <button class="small" onclick="saveUniversalPin()">Save</button>
                  <button class="small" onclick="clearUniversalPin()">Clear</button>
                </div>
              </div>
            </div>

            <!-- Highlight Keywords -->
            <div style="border:1px solid #e5e7eb; border-radius:14px; padding:12px; background:#fafafa; margin-top:12px;">
              <div style="font-weight:800; color:#111827; margin-bottom:6px;">Highlighted keywords</div>
              <div style="font-size:12px; color:#6b7280; margin-bottom:8px;">
                One per line. These will be highlighted in Case Management Notes with mint.
              </div>
              <textarea id="kw-list" style="width:100%; min-height:90px;"
                        placeholder="denied&#10;appeal&#10;peer to peer&#10;auth"></textarea>
              <div style="display:flex; gap:8px; margin-top:8px; align-items:center;">
                <button class="small" onclick="saveKeywords()">Save keywords</button>
                <span id="kw-status" class="message"></span>
              </div>
            </div>

            <!-- Global recompute -->
            <div style="border:1px solid #e5e7eb; border-radius:14px; padding:12px; background:#fafafa; margin-top:12px;">
              <div style="font-weight:800; color:#111827; margin-bottom:6px;">Global recompute</div>
              <div style="font-size:12px; color:#6b7280; margin-bottom:10px;">
                Re-runs SNF AI using only non-ignored notes. Use this after removing notes if you want every row refreshed.
              </div>
              <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                <button class="btn btn-primary btn-small" onclick="globalRecomputeSnfAi()">Recompute SNF AI (All)</button>

                <!-- NEW: Global rehash (updates all hash columns in-place) -->
                <button class="btn btn-small" onclick="globalRehashAll()">Rehash All (Hashes)</button>

                <span id="global-recompute-status" class="message"></span>
              </div>
            </div>

            <!-- Facilities -->
            <div style="border:1px solid #e5e7eb; border-radius:14px; padding:12px; background:#fafafa; margin-top:12px;">
              <div style="font-weight:800; color:#111827; margin-bottom:8px;">SNF facilities</div>

              <label for="settings-facility-select" style="margin-top:0;">Facility</label>
              <select id="settings-facility-select">
                <option value="">(Select a facility to edit)</option>
              </select>

              <div style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;">
                <button class="small" onclick="openFacilityModal('add')">Add facility</button>
                <button class="small" onclick="openFacilityModal('edit')">Edit selected</button>
              </div>

              <div style="font-size:12px; color:#6b7280; margin-top:8px;">
                Tip: choose a facility here, then click <strong>Edit selected</strong>.
              </div>
            </div>
          </div>

          <div class="modal-foot">
            <button class="btn-lite" onclick="closeSettingsModal()">Close</button>
          </div>
        </div>
      </div>

      <!-- =========================================================
           NEW: Manual CM Note Add Modal (writes to cm_notes_raw)
           ========================================================= -->
      <div id="manual-cm-note-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="manual-cm-note-modal-title">
        <div class="modal-card" style="width:min(900px,100%); max-height: calc(100vh - 120px); display:flex; flex-direction:column;">
          <div class="modal-head">
            <div>
              <div id="manual-cm-note-modal-title" class="modal-title">Add Patient / Manual CM Note</div>
              <div class="modal-sub">Manually add a CM note. Scroll to reach all fields and actions.</div>
            </div>
            <button class="modal-x" onclick="closeManualCmNoteModal()" aria-label="Close">✕</button>
          </div>

          <!-- SCROLLING BODY -->
          <div class="modal-body" style="flex:1; overflow:auto;">
            <div class="email-log-card" style="margin:0;">
              <div class="email-log-card-head">
                <div class="email-log-card-title">Patient + Note Details</div>
                <span id="mcn-msg" class="message"></span>
              </div>

              <div style="padding:12px;">
                <div class="grid" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                  <div>
                    <label>Patient MRN <span style="color:#991b1b;">*</span></label>
                    <input id="mcn-patient-mrn" type="text" placeholder="MRN" />
                  </div>

                  <div>
                    <label>Patient Name</label>
                    <input id="mcn-patient-name" type="text" placeholder="Last, First" />
                  </div>

                  <div>
                    <label>DOB</label>
                    <input id="mcn-dob" type="text" placeholder="MM/DD/YYYY" />
                  </div>

                  <div>
                    <label>Visit ID <span style="color:#991b1b;">*</span></label>
                    <input id="mcn-visit-id" type="text" placeholder="Visit ID" />
                  </div>

                  <div>
                    <label>Hospital Name</label>
                    <select id="mcn-hospital-name">
                      <option value="">(select)</option>
                    </select>
                  </div>

                  <div>
                    <label>Admit Date</label>
                    <input id="mcn-admit-date" type="text" placeholder="YYYY-MM-DD (or your format)" />
                  </div>

                  <div>
                    <label>Attending</label>
                    <input id="mcn-attending" type="text" placeholder="Attending" />
                  </div>

                  <div>
                    <label>Note Date/Time <span style="color:#991b1b;">*</span></label>
                    <input id="mcn-note-datetime" type="text" placeholder="YYYY-MM-DD HH:MM (or your format)" />
                  </div>

                  <div>
                    <label>Note Type</label>
                    <input id="mcn-note-type" type="text" value="Case Management" />
                  </div>

                  <div>
                    <label>Source System</label>
                    <input id="mcn-source-system" type="text" value="EMR" />
                  </div>
                </div>

                <div style="margin-top:12px;">
                  <label>Note Text <span style="color:#991b1b;">*</span></label>
                  <textarea id="mcn-note-text" rows="10" placeholder="Paste the CM note text here."></textarea>
                </div>
              </div>
            </div>
          </div>

          <!-- STICKY FOOTER ACTIONS -->
          <div class="modal-foot">
            <button class="btn-lite" onclick="closeManualCmNoteModal()">Cancel</button>
            <button class="btn btn-primary" onclick="submitManualCmNote()">Add Note</button>
          </div>
        </div>
      </div>

      <!-- Email Log modal (styled like Settings modal) -->
      <div id="email-log-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="email-log-modal-title">
        <div class="modal-card" style="width:min(980px,100%);">
          <div class="modal-head">
            <div>
              <div id="email-log-modal-title" class="modal-title">Email Log</div>
              <div class="modal-sub">Sent emails + access/open log (facility vs universal PIN).</div>
            </div>
            <button class="modal-x" onclick="closeEmailLogModal()" aria-label="Close">✕</button>
          </div>

          <div class="modal-body" style="overflow:hidden;">
            <div class="email-log-wrap">
              <!-- Left: emails -->
              <div class="email-log-card">
                <div class="email-log-card-head">
                  <div class="email-log-card-title">Sent emails</div>
                  <span id="email-log-left-status" class="message"></span>
                </div>
                <div id="email-log-list" class="email-log-scroll"></div>
              </div>

              <!-- Right: opens -->
              <div class="email-log-card">
                <div class="email-log-card-head">
                  <div class="email-log-card-title">Opens / Access log</div>
                  <span id="email-log-right-status" class="message"></span>
                </div>
                <div id="email-log-opens" class="email-log-scroll">
                  <div class="message">Select an email on the left.</div>
                </div>
              </div>
            </div>
          </div>

          <div class="modal-foot">
            <button class="btn-lite" onclick="closeEmailLogModal()">Close</button>
          </div>
        </div>
      </div>

      <!-- Reports Modal -->
      <div id="reports-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="reports-modal-title">
        <div class="modal-card" style="width:min(980px,100%);">
          <div class="modal-head">
            <div>
              <div id="reports-modal-title" class="modal-title">Reports</div>
              <div class="modal-sub">SNF Admissions projections + Hospital Discharges actuals (joined by visit_id).</div>
            </div>
            <button class="modal-x" onclick="closeReportsModal()" aria-label="Close">✕</button>
          </div>

          <div class="modal-body">
            <div class="grid2">
              <div>
                <label for="report-select">Report</label>
                <select id="report-select">
                  <option value="snf_admission_summary" selected>SNF Admission Summary</option>
                </select>
              </div>
              <div>
                <label for="report-dc-from">DC Date From (Hospital Discharges)</label>
                <input id="report-dc-from" type="date" />
              </div>
              <div>
                <label for="report-dc-to">DC Date To (Hospital Discharges)</label>
                <input id="report-dc-to" type="date" />
              </div>
            </div>

            <div id="reports-msg" class="message" style="margin-top:12px; display:none;"></div>

            <div id="reports-output" style="margin-top:12px;">
              <div class="message">Choose dates and click <strong>Run Report</strong>.</div>
            </div>
          </div>

          <div class="modal-foot">
            <button class="btn-lite" onclick="closeReportsModal()">Close</button>
            <button class="btn-primary" onclick="runSelectedReport()">Run Report</button>
          </div>
        </div>
      </div>

      <!-- Filters modal -->
      <div id="filters-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="filters-modal-title">
        <div class="modal-card" style="width:min(860px,100%);">
          <div class="modal-head">
            <div>
              <div id="filters-modal-title" class="modal-title">Filters</div>
              <div class="modal-sub">Adjust filters for the SNF Admissions table.</div>
            </div>
            <button class="modal-x" onclick="closeFiltersModal()" aria-label="Close">✕</button>
          </div>

          <div class="modal-body">
            <div class="grid2">
              <div>
                <label for="filter-date">Active Date</label>
                <input id="filter-date" type="date" />
              </div>

              <div>
                <label for="filter-days">Days ahead</label>
                <input id="filter-days" type="number" value="0" min="0" max="30" />
              </div>
            </div>

            <div class="grid2" style="margin-top:10px;">
              <div>
                <label for="filter-status">Status</label>
                <select id="filter-status">
                  <option value="new">New</option>
                  <option value="dispo">Dispo</option>
                  <option value="agency">Agency</option>                
                  <option value="pending">Pending</option>
                  <option value="projected">Projected</option>
                  <option value="confirmed">Confirmed</option>
                  <option value="corrected">Corrected</option>
                  <option value="rejected">Rejected</option>
                  <option value="removed">Removed</option>
                  <option value="all">All</option>
                </select>
              </div>

              <div>
                <label for="filter-facility">SNF facility</label>
                <select id="filter-facility">
                  <option value="">(All facilities)</option>
                </select>
              </div>
            </div>

            <div class="grid2" style="margin-top:10px;">
              <div>
                <label for="sort-by">Sort by</label>
                <select id="sort-by">
                  <option value="">(none)</option>
                  <option value="patient">Patient</option>
                  <option value="facility">Facility</option>
                </select>
              </div>

              <div>
                <label for="sort-dir">Direction</label>
                <select id="sort-dir">
                  <option value="asc">A → Z</option>
                  <option value="desc">Z → A</option>
                </select>
              </div>
            </div>
            
            <div class="grid2" style="margin-top:10px;">
              <div>
                <label for="filter-email-at">Emailed on</label>
                <input id="filter-email-at" type="date" />
              </div>

              <div>
                <label for="filter-email-days">Emailed On Days Ahead</label>
                <input id="filter-email-days" type="number" min="0" max="30" value="0" />
              </div>
            </div>

            <div style="margin-top:10px;">
              <label for="filter-notified">Notified</label>
              <select id="filter-notified">
                <option value="">All</option>
                <option value="1">Notified only</option>
              </select>
            </div>
          </div> <!-- ✅ CLOSE modal-body -->

          <div class="modal-foot" style="justify-content:center;">
            <button class="btn-lite" onclick="closeFiltersModal()">Cancel</button>
            <button class="btn-primary" onclick="applyFiltersAndLoad()">Apply &amp; Load</button>
          </div>
        </div> <!-- ✅ CLOSE modal-card -->
      </div> <!-- ✅ CLOSE filters-modal -->

      <!-- Notification modal (styled like Facility modal) -->
      <div id="notif-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="notif-modal-title">
        <div class="modal-card" style="width:min(780px,100%);">
          <div class="modal-head">
            <div>
              <div id="notif-modal-title" class="modal-title">Notification</div>
              <div class="modal-sub">Capture hospital notification details for this admission.</div>
            </div>
            <button class="modal-x" onclick="closeNotifModal()" aria-label="Close">✕</button>
          </div>

          <div class="modal-body">
            <div class="nm-toggle-row" style="margin-top:0;">
              <!-- keep the checkbox in the DOM (hidden) so your existing saveNotif() logic still works -->
              <input id="nm-checked" type="checkbox" onchange="onNotifCheckedChanged()" style="display:none;" />

              <button id="nm-checked-btn"
                      type="button"
                      class="toggle-pill"
                      aria-pressed="false"
                      onclick="toggleNmChecked()">
                Notified by Hospital
              </button>
            </div>

            <div class="grid2" style="margin-top:10px;">
              <div>
                <label for="nm-by">Notified by</label>
                <input id="nm-by" type="text" placeholder="Name / dept (optional)" />
              </div>

              <div>
                <label for="nm-dt">Notification date/time</label>
                <input id="nm-dt" type="datetime-local" />
              </div>
            </div>

            <label for="nm-fac">Hospital reported Facility</label>
            <input id="nm-fac" type="text" placeholder="Facility name as hospital stated" />

            <label for="nm-details">Notification details</label>
            <textarea id="nm-details" rows="4"
                      placeholder="Any details you want saved with this admission..."></textarea>

            <div class="flex-row" style="margin-top:10px;">
              <button class="btn-primary" onclick="saveNotif()">Save notification</button>
              <span id="nm-status" class="message"></span>
            </div>
          </div>
        </div>
      </div>
  <!-- SNF Physician Assignment modal (NEW) -->
  <div id="phys-assign-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="phys-assign-modal-title">
    <div class="modal-card" style="width:min(780px,100%);">
      <div class="modal-head">
        <div>
          <div id="phys-assign-modal-title" class="modal-title">SNF Physician Assignment</div>
          <div class="modal-sub">Track assignment confirmation and billing confirmation for this admission.</div>
        </div>
        <button class="modal-x" onclick="closePhysAssignModal()" aria-label="Close">✕</button>
      </div>

      <div class="modal-body">
        <div class="grid2" style="margin-top:0;">
          <div>
            <label for="pa-confirmation">Assignment Confirmation</label>
            <select id="pa-confirmation" onchange="onPhysAssignChanged()">
              <option value="Unknown">Unknown</option>
              <option value="Assigned">Assigned</option>
              <option value="Assigned Out">Assigned Out</option>
              <option value="Assigned Out (LTC)">Assigned Out (LTC)</option>
            </select>
          </div>

          <div style="display:flex; flex-direction:column;">
            <label style="visibility:hidden;">Spacer</label>
            <input id="pa-billing-confirmed" type="checkbox" onchange="onPhysAssignChanged()" style="display:none;" />
            <button id="pa-billing-btn"
                    type="button"
                    class="toggle-pill"
                    aria-pressed="false"
                    onclick="togglePaBilling()"
                    style="align-self:flex-start;">
              Billing Confirmed
            </button>
          </div>
        </div>

        <div class="grid2" style="margin-top:10px;">
          <div>
            <label for="pa-call-dt">Confirmation Call Date</label>
            <input id="pa-call-dt" type="datetime-local" />
          </div>

          <div>
            <label for="pa-staff">SNF Staff Name</label>
            <input id="pa-staff" type="text" placeholder="Staff name (optional)" />
          </div>
        </div>

        <label for="pa-physician">Physician Assigned</label>
        <input id="pa-physician" type="text" placeholder="Physician name (optional)" />

        <label for="pa-notes">Assignment Notes</label>
        <textarea id="pa-notes" rows="4" placeholder="Notes…"></textarea>

        <div class="flex-row" style="margin-top:10px;">
          <button class="btn-primary" onclick="savePhysAssign()">Save assignment</button>
          <span id="pa-status" class="message"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- AI Summary modal (NEW) -->
  <div id="ai-summary-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="ai-summary-modal-title">
    <div class="modal-card" style="width:min(980px,100%);">
      <div class="modal-head">
        <div>
          <div id="ai-summary-modal-title" class="modal-title">AI Summary</div>
          <div class="modal-sub">Runs on demand for the selected patient (latest 3–4 CM notes).</div>
        </div>
        <button class="modal-x" onclick="closeAiSummaryModal()" aria-label="Close">✕</button>
      </div>

      <div class="modal-body">
        <div class="grid2" style="margin-top:0;">
          <div>
            <label>Notes to include</label>
            <select id="ai-sum-notes-limit">
              <option value="3">3 notes</option>
              <option value="4" selected>4 notes</option>
            </select>
          </div>
          <div style="display:flex; align-items:flex-end; gap:10px;">
            <label style="display:flex; gap:8px; align-items:center; margin:0;">
              <input id="ai-sum-force" type="checkbox" />
              Refresh (ignore cache)
            </label>
            <button class="btn-primary" onclick="runAiSummary()">Run summary</button>
          </div>
        </div>

        <div id="ai-sum-msg" class="modal-msg info" style="margin-top:10px; display:none;"></div>

        <div class="card" style="margin-top:12px;">
          <div class="sec-hd" style="display:flex; align-items:center; justify-content:space-between;">
            <div>
              <div style="font-weight:700;">Result</div>
              <div class="hint" id="ai-sum-meta" style="margin-top:2px;"></div>
            </div>
            <button class="btn-lite" onclick="applyAiSuggestionsToFixPanel()">Apply to Fix Panel</button>
          </div>
          <div class="body" style="padding:12px;">
            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
              <div class="pill" id="ai-sum-signal-pill">Signal: —</div>
              <div class="pill" id="ai-sum-confidence-pill">Confidence: —</div>
            </div>

            <div style="margin-top:6px;">
              <div style="font-weight:700; margin-bottom:6px;">Summary</div>
              <div id="ai-sum-summary" class="message" style="white-space:pre-wrap;"></div>
            </div>

            <div class="grid2" style="margin-top:12px;">
              <div>
                <div style="font-weight:700; margin-bottom:6px;">Agency names</div>
                <div id="ai-sum-agencies" class="message" style="white-space:pre-wrap;"></div>
              </div>
              <div>
                <div style="font-weight:700; margin-bottom:6px;">Competing plan / indecision</div>
                <div id="ai-sum-competing" class="message" style="white-space:pre-wrap;"></div>
              </div>
            </div>

            <div style="margin-top:12px;">
              <div style="font-weight:700; margin-bottom:6px;">Reasons / Evidence</div>
              <div id="ai-sum-reasons" class="message" style="white-space:pre-wrap;"></div>
            </div>

            <div style="margin-top:12px;">
              <div style="font-weight:700; margin-bottom:6px;">Next steps</div>
              <div id="ai-sum-next" class="message" style="white-space:pre-wrap;"></div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <div class="sec-hd">
            <div>
              <div style="font-weight:700;">Prompt instructions (stored)</div>
              <div class="hint">You can tune what the AI focuses on (SNF vs other placement, agencies, etc.).</div>
            </div>
          </div>
          <div class="body" style="padding:12px;">
            <textarea id="ai-sum-prompt" rows="8" style="width:100%;"></textarea>
            <div style="display:flex; gap:10px; margin-top:10px;">
              <button class="btn-lite" onclick="reloadAiSummaryPrompt()">Reload</button>
              <button class="btn-primary" onclick="saveAiSummaryPrompt()">Save prompt</button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-foot" style="justify-content:center;">
        <button class="btn-lite" onclick="closeAiSummaryModal()">Close</button>
      </div>
    </div>
  </div>

  </main>

  <script>
    let admissions = [];
    let selectedId = null;

    let snfFacilities = [];
    let currentRows = [];

    let highlightKeywords = []; // loaded from backend

    function escapeHtml(s) {
      return String(s || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function splitKeywords(raw) {
      return String(raw || "")
        .split(/\r?\n/)
        .map(x => x.trim())
        .filter(Boolean);
    }

    /**
     * Auto-keywords: all system facility names + aliases (NOT shown in the textarea).
     * Uses the already-loaded snfFacilities array from /admin/snf-facilities/list.
     */
    function getAutoFacilityHighlightKeywords() {
      const out = [];
      for (const f of (snfFacilities || [])) {
        const name = (f.facility_name || "").trim();
        if (name) out.push(name);

        // reuse your existing alias splitter
        splitAliases(f.aliases).forEach(a => {
          const aa = (a || "").trim();
          if (aa) out.push(aa);
        });
      }
      return out;
    }

    /**
     * Combine user-entered highlightKeywords + auto facility keywords
     * without crowding the UI field. Dedup case-insensitively.
     */
    function getEffectiveHighlightKeywords() {
      const user = Array.isArray(highlightKeywords) ? highlightKeywords : [];
      const auto = getAutoFacilityHighlightKeywords();

      const seen = new Set();
      const merged = [];

      // Keep longer tokens; skip ultra-short tokens to avoid noise
      const add = (k) => {
        const kk = String(k || "").trim();
        if (!kk) return;
        if (kk.length < 3) return; // safety: prevents highlighting "St", "of", etc.
        const key = kk.toLowerCase();
        if (seen.has(key)) return;
        seen.add(key);
        merged.push(kk);
      };

      user.forEach(add);
      auto.forEach(add);

      return merged;
    }

    function highlightText(rawText, keywords) {
      const safe = escapeHtml(rawText);

      const list = Array.isArray(keywords) ? keywords : [];
      if (!list.length) return safe;

      // longest-first prevents partial masking of longer phrases
      const sorted = [...list].sort((a, b) => b.length - a.length);

      // build a single alternation regex
      const escaped = sorted.map(k => String(k).replace(/[.*+?^${}()|[\]\\]/g, "\\$&"));

      const re = new RegExp("(" + escaped.join("|") + ")", "gi");
      return safe.replace(re, `<span class="kw-hl">$1</span>`);
    }

    function getAdminToken() {
      // Source of truth: localStorage
      return (localStorage.getItem("evolv_admin_token") || "").trim();
    }

    function updateAdminTokenStatus() {
      const hasToken = !!getAdminToken();

      const top = document.getElementById("admin-token-status-top");
      if (top) top.textContent = hasToken ? "Admin Token: Set" : "Admin Token: Not set";

      const modalStatus = document.getElementById("token-status");
      // (modalStatus is your small “Saved.” message area; we won’t overwrite it here)
    }

    async function loadPadEmailRecipients() {
      const status = document.getElementById("pad-email-status");
      if (status) status.textContent = "Loading…";

      const token = getAdminToken();
      if (!token) {
        if (status) status.textContent = "Paste ADMIN_TOKEN in Settings first.";
        return;
      }

      try {
        const resp = await fetch("/admin/pad/flow-email/recipients", {
          headers: { "X-Admin-Token": token }
        });

        const data = await resp.json().catch(() => ({}));
        if (!resp.ok) throw new Error(data?.detail || ("HTTP " + resp.status));

        const emails = (data.recipients || [])
          .filter(r => r.active)
          .map(r => (r.email || "").trim())
          .filter(Boolean);

        const ta = document.getElementById("pad-email-recipients");
        if (ta) ta.value = emails.join("\n");

        if (status) status.textContent = `Loaded ${emails.length} recipient(s).`;
        setTimeout(() => { if (status) status.textContent = ""; }, 2000);
      } catch (e) {
        if (status) status.textContent = "Load failed: " + (e?.message || e);
      }
    }

    async function savePadEmailRecipients() {
      const status = document.getElementById("pad-email-status");
      if (status) status.textContent = "Saving…";

      const token = getAdminToken();
      if (!token) {
        if (status) status.textContent = "Paste ADMIN_TOKEN in Settings first.";
        return;
      }

      const raw = (document.getElementById("pad-email-recipients")?.value || "").trim();
      const emails = raw
        .split(/[\n,]+/g)
        .map(s => s.trim().toLowerCase())
        .filter(Boolean);

      try {
        const resp = await fetch("/admin/pad/flow-email/recipients/set", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Admin-Token": token
          },
          body: JSON.stringify({ emails })
        });

        const data = await resp.json().catch(() => ({}));
        if (!resp.ok) throw new Error(data?.detail || ("HTTP " + resp.status));

        if (status) status.textContent = `Saved ${data.count ?? emails.length} recipient(s).`;
        setTimeout(() => { if (status) status.textContent = ""; }, 2000);
      } catch (e) {
        if (status) status.textContent = "Save failed: " + (e?.message || e);
      }
    }

    async function loadLastProcessedStatus() {
      const token = getAdminToken();

      const top = document.getElementById("last-processed-status-top");
      const modal = document.getElementById("last-processed-status-modal");
      if (!token) {
        if (top) top.textContent = "Last API: (token required)";
        if (modal) modal.textContent = "Last API: (paste ADMIN_TOKEN above)";
        return;
      }

      try {
        const resp = await fetch("/admin/snf/last-processed", {
          headers: { "X-Admin-Token": token }
        });
        let data = null;
        try { data = await resp.json(); } catch (e) {}
        if (!resp.ok || (data && data.ok === false)) throw new Error("HTTP " + resp.status);

        const ts = (data && (data.last_processed_et || data.last_processed))
          ? (data.last_processed_et || data.last_processed)
          : "(none yet)";
        if (top) top.textContent = "Last API: " + ts + " ET";
        if (modal) modal.textContent = "Last API: " + ts + " ET";
      } catch (e) {
        console.error("loadLastProcessedStatus error", e);
        if (top) top.textContent = "Last API: (error)";
        if (modal) modal.textContent = "Last API: (error)";
      }
    }

    function saveAdminToken() {
      const input = document.getElementById("admin-token-input");
      const token = (input?.value || "").trim();

      if (token) {
        localStorage.setItem("evolv_admin_token", token);
        document.getElementById("token-status").textContent = "Saved.";
      } else {
        localStorage.removeItem("evolv_admin_token");
        document.getElementById("token-status").textContent = "Cleared.";
      }

      // Keep UI in sync everywhere
      updateAdminTokenStatus();
      loadLastProcessedStatus();

      // Refresh SNF facility dropdowns using the new/cleared token
      loadSnfFacilities();

      setTimeout(() => {
        document.getElementById("token-status").textContent = "";
      }, 2000);
    }

    function initToken() {
      const saved = localStorage.getItem("evolv_admin_token") || "";

      // Populate ONLY the Settings modal field
      const input = document.getElementById("admin-token-input");
      if (input) input.value = saved;

      // Update top-bar status text
      updateAdminTokenStatus();
      loadLastProcessedStatus();
    }

    // ===============================
    // Settings modal (open/close)
    // ===============================
    function openSettingsModal() {
      const m = document.getElementById("settings-modal");
      if (m) m.classList.add("open");

      // NEW: ensure modal shows the current saved token
      const input = document.getElementById("admin-token-input");
      if (input) input.value = localStorage.getItem("evolv_admin_token") || "";

      updateAdminTokenStatus();
      loadLastProcessedStatus();
      loadPadEmailRecipients();

      // load keywords into textarea whenever opened
      loadKeywords();
    }

    function closeSettingsModal() {
      const m = document.getElementById("settings-modal");
      if (m) m.classList.remove("open");
    }

    function openAiSummaryModal() {
      const modal = document.getElementById("ai-summary-modal");
      if (!modal) return;

      if (selectedId == null) {
        showToast("Select a SNF admission row first.", "error");
        return;
      }

      modal.classList.add("open");
      reloadAiSummaryPrompt();

      // Optional: auto-run immediately so it “processes at click time”
      runAiSummary();
    }

    function closeAiSummaryModal() {
      const modal = document.getElementById("ai-summary-modal");
      if (!modal) return;
      modal.classList.remove("open");
    }

    function setAiSumMsg(text, type) {
      const el = document.getElementById("ai-sum-msg");
      if (!el) return;
      if (!text) {
        el.style.display = "none";
        el.textContent = "";
        return;
      }
      el.style.display = "block";
      el.textContent = text;
      el.className = "modal-msg " + (type || "info");
    }

    async function reloadAiSummaryPrompt() {
      const token = getAdminToken();
      if (!token) return;

      try {
        const resp = await fetch("/admin/snf/ai-summary/prompt/get", {
          headers: { "X-Admin-Token": token }
        });
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();
        if (!data.ok) throw new Error(data.detail || "ok=false");

        const ta = document.getElementById("ai-sum-prompt");
        if (ta) ta.value = data.prompt || "";
      } catch (e) {
        console.warn("reloadAiSummaryPrompt failed:", e);
      }
    }

    async function saveAiSummaryPrompt() {
      const token = getAdminToken();
      if (!token) {
        showToast("Please paste your ADMIN_TOKEN first.", "error");
        return;
      }

      const ta = document.getElementById("ai-sum-prompt");
      const prompt = (ta && ta.value) ? ta.value : "";

      try {
        const resp = await fetch("/admin/snf/ai-summary/prompt/set", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Admin-Token": token
          },
          body: JSON.stringify({ prompt })
        });
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok || !data.ok) throw new Error(data.detail || ("HTTP " + resp.status));
        showToast("AI prompt saved.", "success");
      } catch (e) {
        console.error("saveAiSummaryPrompt failed:", e);
        showToast("Error saving prompt: " + (e?.message || e), "error");
      }
    }

    function prettyList(v) {
      if (!v) return "";
      if (Array.isArray(v)) return v.filter(Boolean).join("\n");
      return String(v);
    }

    async function runAiSummary() {
      const token = getAdminToken();
      if (!token) {
        showToast("Please paste your ADMIN_TOKEN first.", "error");
        return;
      }

      if (selectedId == null) {
        showToast("Select a SNF admission row first.", "error");
        return;
      }

      const force = !!(document.getElementById("ai-sum-force") || {}).checked;
      const notesLimit = parseInt(((document.getElementById("ai-sum-notes-limit") || {}).value || "4"), 10) || 4;

      setAiSumMsg("", "");
      const meta = document.getElementById("ai-sum-meta");
      if (meta) meta.textContent = "Running…";

      try {
        const resp = await fetch("/admin/snf/ai-summary/run", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Admin-Token": token
          },
          body: JSON.stringify({
            snf_id: selectedId,
            force: force,
            notes_limit: notesLimit
          })
        });

        const data = await resp.json().catch(() => ({}));
        if (!resp.ok || !data.ok) throw new Error(data.detail || ("HTTP " + resp.status));

        const s = data.summary || {};
        const cached = !!data.cached;

        if (meta) {
          const when = data.created_at ? (" • " + data.created_at) : "";
          meta.textContent = (cached ? "Cached" : "Fresh") + (data.model ? (" • " + data.model) : "") + when;
        }

        // Pills
        const signal = (s.placement_signal || "—");
        const conf = (s.confidence != null) ? String(s.confidence) : "—";
        const pill1 = document.getElementById("ai-sum-signal-pill");
        const pill2 = document.getElementById("ai-sum-confidence-pill");
        if (pill1) pill1.textContent = "Signal: " + signal;
        if (pill2) pill2.textContent = "Confidence: " + conf;

        // Main blocks
        const summaryEl = document.getElementById("ai-sum-summary");
        const agenciesEl = document.getElementById("ai-sum-agencies");
        const competingEl = document.getElementById("ai-sum-competing");
        const reasonsEl = document.getElementById("ai-sum-reasons");
        const nextEl = document.getElementById("ai-sum-next");

        if (summaryEl) summaryEl.textContent = prettyList(s.summary);
        if (agenciesEl) agenciesEl.textContent = prettyList(s.agency_names);
        if (competingEl) competingEl.textContent = prettyList(s.competing_plan);
        if (reasonsEl) reasonsEl.textContent = prettyList(s.reasons);
        if (nextEl) nextEl.textContent = prettyList(s.next_steps);

        // store last summary globally for "apply" button
        window.__lastAiSummary = s;

      } catch (e) {
        console.error("runAiSummary failed:", e);
        if (meta) meta.textContent = "";
        setAiSumMsg("Error: " + (e?.message || e), "error");
      }
    }

    function applyAiSuggestionsToFixPanel() {
      // Minimal “apply”: we don’t auto-change your fields without you wanting it.
      // This button just scrolls to the fix panel and highlights it; you can extend later.
      const el = document.getElementById("edit-status");
      if (el) el.scrollIntoView({ behavior: "smooth", block: "center" });
      showToast("Fix Panel ready. Review and save if needed.", "info");
    }

    // ===============================
    // Highlight keywords (load/save)
    // ===============================
    async function loadKeywords() {
      const token = getAdminToken();
      const status = document.getElementById("kw-status");
      if (status) status.textContent = "";

      // ✅ Don’t even call the API if the token is missing
      if (!token) {
        if (status) status.textContent = "Paste ADMIN_TOKEN above, then reopen Settings.";
        return;
      }

      try {
        const resp = await fetch("/admin/snf/highlight-keywords/get", {
          headers: { "X-Admin-Token": token }
        });

        if (!resp.ok) throw new Error("Failed to load keywords");
        const data = await resp.json();

        // API returns keywords as a single string; convert to list for the UI
        const list = splitKeywords(data.keywords || "");
        highlightKeywords = list;

        const ta = document.getElementById("kw-list");
        if (ta) ta.value = (list || []).join("\n");

        // refresh note body if one is selected so highlights apply immediately
        // (but don’t mark keyword LOAD as failed if only the UI refresh fails)
        try {
          if (selectedId != null) {
            const adm = admissions.find(x => x.id === selectedId);
            if (adm) renderSelectedAdmission(adm);
          }
        } catch (uiErr) {
          console.error("Post-load UI refresh error (keywords):", uiErr);
          // keep status blank because keywords DID load
        }
      } catch (e) {
        if (status) status.textContent = "Could not load keywords.";
        console.error(e);
      }
    }

    async function saveKeywords() {
      const token = getAdminToken();
      const status = document.getElementById("kw-status");
      if (status) status.textContent = "Saving…";

      // ✅ Don’t call the API if the token is missing
      if (!token) {
        if (status) status.textContent = "Paste ADMIN_TOKEN above, then try again.";
        return;
      }

      try {
        const raw = (document.getElementById("kw-list")?.value || "");
        const list = splitKeywords(raw);

        // API expects keywords as ONE string blob (newline separated)
        const keywordsBlob = list.join("\n");

        const resp = await fetch("/admin/snf/highlight-keywords/set", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Admin-Token": token
          },
          body: JSON.stringify({ keywords: keywordsBlob })
        });

        let data = null;
        try { data = await resp.json(); } catch (e) {}

        if (!resp.ok) {
          const detail = data && (data.detail || data.message);
          throw new Error("HTTP " + resp.status + (detail ? " – " + detail : ""));
        }
        if (data && data.ok === false) throw new Error(data.detail || "ok=false");

        // ✅ Save succeeded — set UI/state now
        highlightKeywords = list;
        if (status) status.textContent = "Saved.";

        // ✅ If the UI refresh fails, don’t lie and say “Save failed.”
        try {
          if (selectedId != null) {
            const adm = admissions.find(x => x.id === selectedId);
            if (adm) renderSelectedAdmission(adm);
          }
        } catch (uiErr) {
          console.error("Post-save UI refresh error (keywords):", uiErr);
        }

        setTimeout(() => { if (status) status.textContent = ""; }, 2000);
      } catch (e) {
        console.error(e);
        if (status) status.textContent = "Save failed: " + e;
      }
    }

    // ===============================
    // Global recompute SNF AI (admin)
    // ===============================
    async function globalRecomputeSnfAi() {
      const token = getAdminToken();
      const statusEl = document.getElementById("global-recompute-status");

      if (!token) {
        if (statusEl) statusEl.textContent = "Paste ADMIN_TOKEN above first.";
        return;
      }

      const ok = confirm(
        "This will recompute SNF AI for ALL admissions using only non-ignored notes.\n\nContinue?"
      );
      if (!ok) return;

      if (statusEl) statusEl.textContent = "Recomputing…";

      try {
        const resp = await fetch("/admin/snf/recompute-all", {
          method: "POST",
          headers: { "X-Admin-Token": token }
        });

        let data = null;
        try { data = await resp.json(); } catch (e) {}

        if (!resp.ok) {
          const detail = data && (data.detail || data.message);
          throw new Error("HTTP " + resp.status + (detail ? " – " + detail : ""));
        }
        if (data && data.ok === false) throw new Error(data.detail || "ok=false");

        const msg =
          `Done. Groups=${data.total_groups}, OK=${data.recomputed_ok}, Failed=${data.recomputed_failed}`;
        if (statusEl) statusEl.textContent = msg;

        // Refresh the table so Facility(AI) updates immediately
        try { await loadAdmissions(); } catch (e2) {}

        // Re-select row if user had one open
        if (selectedId != null) {
          try { await selectRow(selectedId); } catch (e3) {}
        }

        setTimeout(() => { if (statusEl) statusEl.textContent = ""; }, 4000);
      } catch (e) {
        console.error("globalRecomputeSnfAi error", e);
        if (statusEl) statusEl.textContent = "Recompute failed: " + e;
      }
    }

    // ===============================
    // Global rehash ALL hashes (admin)
    // ===============================
    async function globalRehashAll() {
      const token = getAdminToken();
      const statusEl = document.getElementById("global-recompute-status");

      if (!token) {
        if (statusEl) statusEl.textContent = "Paste ADMIN_TOKEN above first.";
        return;
      }

      const ok = confirm(
        "This will REHASH all stored hashes (cm_notes_raw.note_hash + hospital_documents.document_hash).\n" +
        "Use this after historical normalization/data changes so dedupe matches current logic.\n\n" +
        "Continue?"
      );
      if (!ok) return;

      if (statusEl) statusEl.textContent = "Rehashing…";

      try {
        const resp = await fetch("/admin/rehash-all", {
          method: "POST",
          headers: { "X-Admin-Token": token }
        });

        let data = null;
        try { data = await resp.json(); } catch (e) {}

        if (!resp.ok) {
          const detail = data && (data.detail || data.message);
          throw new Error("HTTP " + resp.status + (detail ? " – " + detail : ""));
        }
        if (data && data.ok === false) throw new Error(data.detail || "ok=false");

        const msg =
          `Rehash done. Notes updated=${data.notes_updated}/${data.notes_total}, ` +
          `Docs updated=${data.docs_updated}/${data.docs_total}`;
        if (statusEl) statusEl.textContent = msg;

        // Optional refresh (safe): reload list + reselect current row
        try { await loadAdmissions(); } catch (e2) {}
        if (selectedId != null) {
          try { await selectRow(selectedId); } catch (e3) {}
        }

        setTimeout(() => { if (statusEl) statusEl.textContent = ""; }, 5000);
      } catch (e) {
        console.error("globalRehashAll error", e);
        if (statusEl) statusEl.textContent = "Rehash failed: " + (e?.message || e);
      }
    }


    // ===============================
    // Filters modal (open/close/apply)
    // ===============================

    function openFiltersModal() {
      const m = document.getElementById("filters-modal");
      if (m) m.classList.add("open");
    }

    function closeFiltersModal() {
      const m = document.getElementById("filters-modal");
      if (m) m.classList.remove("open");
    }

    function applyFiltersAndLoad() {
      closeFiltersModal();
      loadAdmissions();
    }

    // ===============================
    // Notification modal (open/close/save)
    // ===============================
    function openNotifModal() {
      const m = document.getElementById("notif-modal");
      if (!m) return;

      // FORCE show modal even if CSS is not applying
      m.classList.add("open");
      m.style.display = "flex";

      // load current selected admission fields into modal (if a row is selected)
      const adm = admissions.find(x => x.id === selectedId);
      if (!adm) return;

      const elChecked = document.getElementById("nm-checked");
      const elBy      = document.getElementById("nm-by");
      const elDt      = document.getElementById("nm-dt");
      const elFac     = document.getElementById("nm-fac");
      const elDetails = document.getElementById("nm-details");

      if (elChecked) elChecked.checked = !!adm.notified_by_hospital;
      if (elBy)      elBy.value = adm.notified_by || "";
      if (elDt)      elDt.value = adm.notification_dt || "";
      if (elFac)     elFac.value = adm.hospital_reported_facility || "";
      if (elDetails) elDetails.value = adm.notification_details || "";

      if (typeof onNotifCheckedChanged === "function") onNotifCheckedChanged();
    }

    function closeNotifModal() {
      const m = document.getElementById("notif-modal");
      if (!m) return;
      m.classList.remove("open");
      m.style.display = "none";
    }

    function toggleNmChecked() {
      const cb = document.getElementById("nm-checked");
      if (!cb) return;

      cb.checked = !cb.checked;
      onNotifCheckedChanged();
    }

    function onNotifCheckedChanged() {
      const checked = document.getElementById("nm-checked").checked;

      // existing bell highlight behavior
      const btn = document.getElementById("notif-btn");
      if (btn) {
        if (checked) btn.classList.add("on");
        else btn.classList.remove("on");
      }

      // NEW: update the modal toggle button style/state
      const tbtn = document.getElementById("nm-checked-btn");
      if (tbtn) {
        tbtn.classList.toggle("active", checked);
        tbtn.setAttribute("aria-pressed", checked ? "true" : "false");
      }
    }

    async function saveNotif() {
      const status = document.getElementById("nm-status");
      if (status) status.textContent = "Saving…";

      const adm = admissions.find(x => x.id === selectedId);
      if (!adm) {
        if (status) status.textContent = "No admission selected.";
        return;
      }

      const token = getAdminToken();
      if (!token) {
        if (status) status.textContent = "Paste ADMIN_TOKEN in Settings first.";
        return;
      }
      const payload = {
        notified_by_hospital: document.getElementById("nm-checked").checked,
        notified_by: document.getElementById("nm-by").value || "",
        notification_dt: document.getElementById("nm-dt").value || "",
        hospital_reported_facility: document.getElementById("nm-fac").value || "",
        notification_details: document.getElementById("nm-details").value || ""
      };

      try {
        // IMPORTANT: the backend save endpoint is /admin/snf/update
        // and it requires status + the normal edit fields too.
        const statusVal = (document.getElementById("edit-status")?.value || adm.status || "new");
        const dispositionVal = (document.getElementById("edit-disposition")?.value || adm.disposition || "");
        const dateVal = (document.getElementById("edit-date")?.value || adm.final_expected_transfer_date || (adm.ai_expected_transfer_date || "") || "");

        const facilitySelect = document.getElementById("edit-facility-select");
        const facilityLabel =
          facilitySelect && facilitySelect.value
            ? facilitySelect.options[facilitySelect.selectedIndex].text
            : "";

        const commentsVal = (document.getElementById("edit-comments")?.value || adm.review_comments || "");

        const resp = await fetch(`/admin/snf/update`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Admin-Token": token
          },
          body: JSON.stringify({
            // required base fields
            id: adm.id,
            status: statusVal,
            disposition: dispositionVal,
            final_expected_transfer_date: dateVal || null,
            facility_free_text: facilityLabel || "",
            review_comments: commentsVal || "",

            // notification modal fields
            notified_by_hospital: payload.notified_by_hospital,
            notified_by: payload.notified_by,
            notification_dt: payload.notification_dt,
            hospital_reported_facility: payload.hospital_reported_facility,
            notification_details: payload.notification_details
          })
        });

        let data = null;
        try { data = await resp.json(); } catch (e) {}

        if (!resp.ok) {
          const detail = data && (data.detail || data.message);
          throw new Error("HTTP " + resp.status + (detail ? " – " + detail : ""));
        }
        if (data && data.ok === false) throw new Error(data.detail || "ok=false");


        // Update local copy so the list + bell update immediately
        adm.notified_by_hospital = payload.notified_by_hospital ? 1 : 0;
        adm.notified_by = payload.notified_by;
        adm.notification_dt = payload.notification_dt;
        adm.hospital_reported_facility = payload.hospital_reported_facility;
        adm.notification_details = payload.notification_details;

        onNotifCheckedChanged();
        if (status) status.textContent = "Saved.";

        // re-render list to show subtle icon
        try {
          renderTable(currentRows);
        } catch (uiErr) {
          console.error("Post-save UI refresh error (notif):", uiErr);
          // Keep "Saved." — backend update already happened
        }

        // Auto-close modal after a beat so user sees "Saved."
        setTimeout(() => closeNotifModal(), 450);

        setTimeout(() => { if (status) status.textContent = ""; }, 2000);
      } catch (e) {
        console.error(e);
        if (status) status.textContent = "Save failed.";
      }
    }
    // ===============================
    // SNF Physician Assignment modal (NEW)
    // ===============================
    function openPhysAssignModal() {
      const m = document.getElementById("phys-assign-modal");
      if (!m) return;

      // FORCE show modal even if CSS is not applying
      m.classList.add("open");
      m.style.display = "flex";

      const adm = admissions.find(x => x.id === selectedId);
      if (!adm) return;

      const elConf  = document.getElementById("pa-confirmation");
      const elBill  = document.getElementById("pa-billing-confirmed");
      const elCall  = document.getElementById("pa-call-dt");
      const elStaff = document.getElementById("pa-staff");
      const elPhys  = document.getElementById("pa-physician");
      const elNotes = document.getElementById("pa-notes");

      if (elConf)  elConf.value = adm.assignment_confirmation || "Unknown";
      if (elBill)  elBill.checked = !!adm.billing_confirmed;
      if (elCall)  elCall.value = adm.confirmation_call_dt || "";
      if (elStaff) elStaff.value = adm.snf_staff_name || "";
      if (elPhys)  elPhys.value = adm.physician_assigned || "";
      if (elNotes) elNotes.value = adm.assignment_notes || "";

      if (typeof onPhysAssignChanged === "function") onPhysAssignChanged();
    }

    function closePhysAssignModal() {
      const m = document.getElementById("phys-assign-modal");
      if (!m) return;
      m.classList.remove("open");
      m.style.display = "none";
    }

    function togglePaBilling() {
      const cb = document.getElementById("pa-billing-confirmed");
      if (!cb) return;
      cb.checked = !cb.checked;
      onPhysAssignChanged();
    }

    function onPhysAssignChanged() {
      const adm = admissions.find(x => x.id === selectedId);
      const conf = (document.getElementById("pa-confirmation")?.value || adm?.assignment_confirmation || "Unknown");
      const billing = !!document.getElementById("pa-billing-confirmed")?.checked;

      // Toggle-pill styling
      const tbtn = document.getElementById("pa-billing-btn");
      if (tbtn) {
        tbtn.classList.toggle("active", billing);
        tbtn.setAttribute("aria-pressed", billing ? "true" : "false");
      }

      // Icon button highlight if anything meaningful is set
      const btn = document.getElementById("phys-assign-btn");
      if (btn) {
        const hasData = billing || (conf && conf !== "Unknown");
        btn.classList.toggle("on", !!hasData);
      }
    }

    async function savePhysAssign() {
      const status = document.getElementById("pa-status");
      if (status) status.textContent = "Saving…";

      const adm = admissions.find(x => x.id === selectedId);
      if (!adm) {
        if (status) status.textContent = "No admission selected.";
        return;
      }

      const token = getAdminToken();
      if (!token) {
        if (status) status.textContent = "Paste ADMIN_TOKEN in Settings first.";
        return;
      }

      const payload = {
        assignment_confirmation: document.getElementById("pa-confirmation").value || "Unknown",
        billing_confirmed: document.getElementById("pa-billing-confirmed").checked,
        confirmation_call_dt: document.getElementById("pa-call-dt").value || "",
        snf_staff_name: document.getElementById("pa-staff").value || "",
        physician_assigned: document.getElementById("pa-physician").value || "",
        assignment_notes: document.getElementById("pa-notes").value || ""
      };

      try {
        // backend endpoint requires base fields too (same pattern as saveNotif)
        const statusVal = (document.getElementById("edit-status")?.value || adm.status || "new");
        const dispositionVal = (document.getElementById("edit-disposition")?.value || adm.disposition || "");
        const dateVal = (document.getElementById("edit-date")?.value || adm.final_expected_transfer_date || (adm.ai_expected_transfer_date || "") || "");

        const facilitySelect = document.getElementById("edit-facility-select");
        const facilityLabel =
          facilitySelect && facilitySelect.value
            ? facilitySelect.options[facilitySelect.selectedIndex].text
            : "";

        const commentsVal = (document.getElementById("edit-comments")?.value || adm.review_comments || "");

        const resp = await fetch(`/admin/snf/update`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Admin-Token": token
          },
          body: JSON.stringify({
            // required base fields
            id: adm.id,
            status: statusVal,
            disposition: dispositionVal,
            final_expected_transfer_date: dateVal || null,
            facility_free_text: facilityLabel || "",
            review_comments: commentsVal || "",

            // NEW: physician assignment fields
            assignment_confirmation: payload.assignment_confirmation,
            billing_confirmed: payload.billing_confirmed,
            confirmation_call_dt: payload.confirmation_call_dt,
            snf_staff_name: payload.snf_staff_name,
            physician_assigned: payload.physician_assigned,
            assignment_notes: payload.assignment_notes
          })
        });

        let data = null;
        try { data = await resp.json(); } catch (e) {}

        if (!resp.ok) {
          const detail = data && (data.detail || data.message);
          throw new Error("HTTP " + resp.status + (detail ? " – " + detail : ""));
        }
        if (data && data.ok === false) throw new Error(data.detail || "ok=false");

        // Update local copy so icon highlight stays correct
        adm.assignment_confirmation = payload.assignment_confirmation;
        adm.billing_confirmed = payload.billing_confirmed ? 1 : 0;
        adm.confirmation_call_dt = payload.confirmation_call_dt;
        adm.snf_staff_name = payload.snf_staff_name;
        adm.physician_assigned = payload.physician_assigned;
        adm.assignment_notes = payload.assignment_notes;

        onPhysAssignChanged();
        if (status) status.textContent = "Saved.";

        // optional: refresh list rendering
        try { renderTable(currentRows); } catch (e2) {}

        // Auto-close modal after a beat so user sees "Saved."
        setTimeout(() => closePhysAssignModal(), 450);

        setTimeout(() => { if (status) status.textContent = ""; }, 2000);
      } catch (e) {
        console.error(e);
        if (status) status.textContent = "Save failed.";
      }
    }

    function initDate() {
      // Default to no date selected so the backend returns all dates
      const input = document.getElementById("filter-date");
      if (input) {
        input.value = "";
      }
    }

    function getFacilityLabel(r) {
      // Use whatever you already display in the “Facility” column first (AI name or chosen facility)
      return String(r.facility_free_text || r.snf_facility_name || r.facility_ai || "").trim();
    }

    async function loadSnfFacilities() {
      const token = localStorage.getItem("evolv_admin_token") || getAdminToken();
      if (!token) {
        // No token yet; user will paste it and we can reload facilities afterward.
        return;
      }
      try {
        const resp = await fetch("/admin/snf-facilities/list", {
          headers: { "X-Admin-Token": token }
        });
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();
        if (!data.ok) throw new Error(data.detail || "ok=false");

        snfFacilities = data.items || [];

        const filterSelect = document.getElementById("filter-facility");
        if (filterSelect) {
          filterSelect.innerHTML = '<option value="">(All facilities)</option>';

          // NEW: special filter option for starred facilities
          const starredOpt = document.createElement("option");
          starredOpt.value = "__starred__";
          starredOpt.textContent = "(All Starred ★)";
          filterSelect.appendChild(starredOpt);

          const withAttending = (snfFacilities || []).filter(f => (f.attending || "").trim());
          const withoutAttending = (snfFacilities || []).filter(f => !(f.attending || "").trim());

          // Put “attending” facilities first + star them
          [...withAttending, ...withoutAttending].forEach(f => {
            const opt = document.createElement("option");
            opt.value = String(f.id);

            const name = f.facility_name || "(no name)";
            const star = (f.attending || "").trim() ? "★ " : "";
            opt.textContent = star + name;

            filterSelect.appendChild(opt);
          });
        }

        const settingsSelect = document.getElementById("settings-facility-select");
        if (settingsSelect) {
          settingsSelect.innerHTML = '<option value="">(Select a facility to edit)</option>';
          snfFacilities.forEach(f => {
            const opt = document.createElement("option");
            opt.value = String(f.id);

            let label = f.facility_name || "(no name)";

            settingsSelect.appendChild(opt);
            opt.textContent = label;
          });
        }

        const editSelect = document.getElementById("edit-facility-select");
        if (editSelect) {
          editSelect.innerHTML = '<option value="">(none)</option>';
          snfFacilities.forEach(f => {
            const opt = document.createElement("option");
            opt.value = String(f.id);
            let label = f.facility_name || "(no name)";
            opt.textContent = label;   // 👈 add this line
            editSelect.appendChild(opt);
          });
        }
        // If a row is open, refresh the note so facility/alias highlighting updates immediately
        try {
          if (selectedId != null) await selectRow(selectedId);
        } catch (e) {
          // non-fatal
        }

      } catch (err) {
        console.error("loadSnfFacilities error", err);
      }
    }

    function setEditFacilityByLabel(label) {
      const select = document.getElementById("edit-facility-select");
      if (!select) return;

      if (!label) {
        select.value = "";
        return;
      }

      const target = label.toLowerCase();
      let foundId = "";

      snfFacilities.forEach(f => {
        const name = (f.facility_name || "").toLowerCase();
        const aliases = (f.aliases || "").toLowerCase();
        if (foundId) return;
        if (name && (target.includes(name) || name.includes(target))) {
          foundId = String(f.id);
        } else if (aliases && aliases.split(/[,\|;]+/).some(a => target.includes(a.trim().toLowerCase()))) {
          foundId = String(f.id);
        }
      });

      select.value = foundId || "";
    }


    function formatISOToMDY(iso) {
      // Accepts "YYYY-MM-DD" (or "YYYY-MM-DDTHH:MM:SS"), returns "MM-DD-YYYY"
      if (!iso) return "";
      const m = String(iso).match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (!m) return String(iso); // if it's not ISO, leave it alone
      const [_, yyyy, mm, dd] = m;
      return `${mm}-${dd}-${yyyy}`;
    }

    function parseMDYToISO(val) {
      // Accepts:
      //  - "YYYY-MM-DD" (from <input type="date">)  ✅ return as-is
      //  - "MM-DD-YYYY" or "MM/DD/YYYY"            ✅ convert to ISO
      if (!val) return "";
      const s = String(val).trim();

      // Already ISO?
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

      const cleaned = s.replace(/\//g, "-");
      const m = cleaned.match(/^(\d{2})-(\d{2})-(\d{4})$/);
      if (!m) return "";
      const [_, mm, dd, yyyy] = m;
      return `${yyyy}-${mm}-${dd}`;
    }

    let facilityModalMode = "add";   // "add" | "edit"
    let facilityModalId = null;

    function openFacilityModal(mode) {
      const token = getAdminToken();
      if (!token) {
        showToast("Please paste your ADMIN_TOKEN first.", "error");
        return;
      }

      facilityModalMode = mode;
      facilityModalId = null;

      // Reset fields
      setFacilityModalValues({
        facility_name: "",
        attending: "",
        notes: "",
        notes2: "",
        aliases: "",
        facility_emails: "",
        pin_set: false
      });
      document.getElementById("facility-pin").value = "";
      document.getElementById("facility-clear-pin").checked = false;

      if (mode === "edit") {
        // Prefer the Settings modal dropdown for edit selection
        const settingsSelect = document.getElementById("settings-facility-select");
        const filterSelect = document.getElementById("filter-facility");

        const idVal =
          (settingsSelect && settingsSelect.value) ||
          (filterSelect && filterSelect.value) ||
          "";

        if (!idVal) {
          showToast("Pick a facility in Settings first (SNF facilities dropdown).", "error");
          return;
        }

        const fac = snfFacilities.find(f => String(f.id) === String(idVal));
        if (!fac) {
          showToast("Could not find that facility in the list.", "error");
          return;
        }

        facilityModalId = fac.id;
        setFacilityModalValues({
          facility_name: fac.facility_name || "",
          facility_phone: fac.facility_phone || "",
          attending: fac.attending || "",
          notes: fac.notes || "",
          notes2: fac.notes2 || "",
          aliases: fac.aliases || "",
          facility_emails: fac.facility_emails || "",
          pin_set: !!fac.pin_set
        });
      }

      document.getElementById("facility-modal-title").textContent =
        mode === "add" ? "Add SNF facility" : "Edit SNF facility";

      document.getElementById("facility-modal").classList.add("open");
    }

    function closeFacilityModal() {
      document.getElementById("facility-modal").classList.remove("open");
    }

    function setFacilityModalValues(f) {
      document.getElementById("facility-name").value = f.facility_name || "";
      document.getElementById("facility-phone").value = f.facility_phone || "";
      document.getElementById("facility-attending").value = f.attending || "";
      document.getElementById("facility-notes").value = f.notes || "";
      document.getElementById("facility-notes2").value = f.notes2 || "";
      document.getElementById("facility-aliases").value = f.aliases || "";
      document.getElementById("facility-emails").value = f.facility_emails || "";

      const pinStatus = document.getElementById("facility-pin-status");
      pinStatus.textContent = f.pin_set ? "PIN: Set" : "PIN: Not set";
    }

    async function saveFacilityFromModal() {
      const token = getAdminToken();
      if (!token) {
        showToast("Please paste your ADMIN_TOKEN first.", "error");
        return;
      }

      const name = (document.getElementById("facility-name").value || "").trim();
      if (!name) {
        showToast("Facility name is required.", "error");
        return;
      }

      const payload = {
        id: facilityModalMode === "edit" ? facilityModalId : null,
        facility_name: name,
        facility_phone: (document.getElementById("facility-phone").value || "").trim(),
        attending: (document.getElementById("facility-attending").value || "").trim(),
        notes: (document.getElementById("facility-notes").value || "").trim(),
        notes2: (document.getElementById("facility-notes2").value || "").trim(),
        aliases: (document.getElementById("facility-aliases").value || "").trim(),
        facility_emails: (document.getElementById("facility-emails").value || "").trim(),

        // NEW: facility PIN controls
        facility_pin: (document.getElementById("facility-pin").value || "").trim(),
        clear_pin: !!document.getElementById("facility-clear-pin").checked
      };

      // UX safety: if user checks clear_pin, ignore facility_pin
      if (payload.clear_pin) payload.facility_pin = "";

      setModalMessage("facility-modal-msg", "Saving…", "info");

      try {
        const resp = await fetch("/admin/snf-facilities/upsert", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Admin-Token": token
          },
          body: JSON.stringify(payload)
        });

        let data = null;
        try { data = await resp.json(); } catch (e) {}

        if (!resp.ok) {
          const detail = data && (data.detail || data.message);
          throw new Error("HTTP " + resp.status + (detail ? " – " + detail : ""));
        }
        if (data && data.ok === false) throw new Error(data.detail || "ok=false");

        await loadSnfFacilities();
        setModalMessage(
          "facility-modal-msg",
          facilityModalMode === "add" ? "Facility saved." : "Facility updated.",
          "success"
        );

        // Close after a beat so the user sees success
        setTimeout(() => closeFacilityModal(), 450);
      } catch (err) {
        console.error("saveFacilityFromModal error", err);
        setModalMessage("facility-modal-msg", "Error: " + err, "error");
      }
    }

    /* ------- Universal PIN editor (fallback PIN) ------- */

    async function loadUniversalPinStatus() {
      const token = getAdminToken();
      if (!token) return;

      try {
        const resp = await fetch("/admin/snf/universal-pin/get", {
          headers: { "X-Admin-Token": token }
        });
        if (!resp.ok) return;

        const data = await resp.json();
        if (!data.ok) return;

        const top = document.getElementById("universal-pin-status-top");
        if (top) top.textContent = data.pin_set ? "Universal PIN: Set" : "Universal PIN: Not set";

        const modal = document.getElementById("universal-pin-status-modal");
        if (modal) modal.textContent = data.pin_set ? "Universal PIN: Set" : "Universal PIN: Not set";
      } catch (e) {
        // silent
      }
    }

    async function saveUniversalPin() {
      const token = getAdminToken();
      if (!token) {
        showToast("Please paste your ADMIN_TOKEN first.", "error");
        return;
      }

      const pin = (document.getElementById("universal-pin").value || "").trim();
      if (!pin) {
        showToast("Enter a universal PIN (or use Clear).", "error");
        return;
      }

      try {
        const resp = await fetch("/admin/snf/universal-pin/set", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Admin-Token": token
          },
          body: JSON.stringify({ pin })
        });
        if (!resp.ok) throw new Error("HTTP " + resp.status);

        const data = await resp.json();
        if (!data.ok) throw new Error(data.detail || "ok=false");

        document.getElementById("universal-pin").value = "";
        await loadUniversalPinStatus();
        showToast("Universal PIN saved.", "success");
      } catch (err) {
        console.error("saveUniversalPin error", err);
        showToast("Error saving universal PIN: " + err, "error");
      }
    }

    async function clearUniversalPin() {
      const token = getAdminToken();
      if (!token) {
        showToast("Please paste your ADMIN_TOKEN first.", "error");
        return;
      }

      try {
        const resp = await fetch("/admin/snf/universal-pin/clear", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Admin-Token": token
          },
          body: JSON.stringify({})
        });
        if (!resp.ok) throw new Error("HTTP " + resp.status);

        const data = await resp.json();
        if (!data.ok) throw new Error(data.detail || "ok=false");

        document.getElementById("universal-pin").value = "";
        await loadUniversalPinStatus();
        showToast("Universal PIN cleared.", "success");
      } catch (err) {
        console.error("clearUniversalPin error", err);
        showToast("Error clearing universal PIN: " + err, "error");
      }
    }

    /* ------- simple toast + modal message helpers ------- */

    function setModalMessage(id, text, kind) {
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = text || "";
      el.className = "modal-msg " + (kind || "info");
    }

    function showToast(text, kind) {
      const el = document.getElementById("toast");
      el.textContent = text;
      el.className = "toast show " + (kind || "info");
      setTimeout(() => el.className = "toast", 2600);
    }

    async function loadHospitalOptionsForManualModal() {
      const token = getAdminToken();
      const sel = document.getElementById("mcn-hospital-name");
      if (!sel) return;

      // reset options
      sel.innerHTML = `<option value="">(select)</option>`;

      if (!token) return; // allow modal to open; dropdown stays minimal until token exists

      try {
        const resp = await fetch("/admin/snf/cm-notes/hospitals", {
          headers: { "X-Admin-Token": token }
        });
        if (!resp.ok) throw new Error("HTTP " + resp.status);

        const data = await resp.json();
        const hospitals = Array.isArray(data?.hospitals) ? data.hospitals : [];

        hospitals.forEach(h => {
          const name = (h || "").toString().trim();
          if (!name) return;
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          sel.appendChild(opt);
        });
      } catch (e) {
        console.warn("loadHospitalOptionsForManualModal failed:", e);
      }
    }

    function ensureHospitalOption(name) {
      const sel = document.getElementById("mcn-hospital-name");
      if (!sel) return;
      const v = (name || "").toString().trim();
      if (!v) return;

      const exists = Array.from(sel.options).some(o => o.value === v);
      if (!exists) {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        sel.appendChild(opt);
      }
    }

    async function openManualCmNoteModal(){
      const m = document.getElementById("manual-cm-note-modal");
      if (m) m.classList.add("open");

      // load hospital dropdown values
      await loadHospitalOptionsForManualModal();

      // always clear status message
      const msg = document.getElementById("mcn-msg");
      if (msg) msg.textContent = "";

      // ALWAYS start blank (so if no row is selected, it's clean)
      const idsToClear = [
        "mcn-patient-mrn",
        "mcn-patient-name",
        "mcn-dob",
        "mcn-visit-id",
        "mcn-hospital-name",
        "mcn-admit-date",
        "mcn-attending",
        "mcn-note-datetime",
        "mcn-note-text"
      ];

      idsToClear.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = "";
      });

      // keep your existing defaults (don’t blank them)
      const noteType = document.getElementById("mcn-note-type");
      if (noteType && !noteType.value) noteType.value = "Case Management";

      const src = document.getElementById("mcn-source-system");
      if (src && !src.value) src.value = "EMR";

      // PREFILL ONLY if a SNF admission row is currently selected
      const adm = (Array.isArray(admissions) && selectedId != null)
        ? admissions.find(x => String(x.id) === String(selectedId))
        : null;

      if (!adm) return; // <- no row selected, stays blank

      const setVal = (id, v) => {
        const el = document.getElementById(id);
        if (!el) return;
        const val = (v == null) ? "" : String(v);
        if (val.trim() !== "") el.value = val;
      };

      setVal("mcn-patient-mrn", adm.patient_mrn || adm.mrn);
      setVal("mcn-patient-name", adm.patient_name);
      setVal("mcn-dob", adm.dob);
      setVal("mcn-visit-id", adm.visit_id);
      setVal("mcn-admit-date", adm.admit_date);
      setVal("mcn-attending", adm.attending);

      // hospital dropdown: ensure options loaded, then select matching value
      const hosp = (adm.hospital_name || adm.from_hospital_name || "").toString();
      if (hosp.trim() !== "") {
        ensureHospitalOption(hosp);
        const sel = document.getElementById("mcn-hospital-name");
        if (sel) sel.value = hosp;
      }
    } // ✅ IMPORTANT: close the function properly


    function closeManualCmNoteModal(){
      const m = document.getElementById("manual-cm-note-modal");
      if (m) m.classList.remove("open");
    }

    async function submitManualCmNote(){
      const msg = document.getElementById("mcn-msg");
      if (msg) msg.textContent = "";

      const payload = {
        patient_mrn: (document.getElementById("mcn-patient-mrn")?.value || "").trim(),
        patient_name: (document.getElementById("mcn-patient-name")?.value || "").trim(),
        dob: (document.getElementById("mcn-dob")?.value || "").trim(),
        visit_id: (document.getElementById("mcn-visit-id")?.value || "").trim(),
        hospital_name: (document.getElementById("mcn-hospital-name")?.value || "").trim(),
        admit_date: (document.getElementById("mcn-admit-date")?.value || "").trim(),
        attending: (document.getElementById("mcn-attending")?.value || "").trim(),
        note_datetime: (document.getElementById("mcn-note-datetime")?.value || "").trim(),
        note_type: (document.getElementById("mcn-note-type")?.value || "Case Management").trim(),
        note_text: (document.getElementById("mcn-note-text")?.value || "").trim(),
        source_system: (document.getElementById("mcn-source-system")?.value || "EMR").trim()
      };

      if (!payload.patient_mrn || !payload.visit_id || !payload.note_datetime || !payload.note_text){
        if (msg) msg.textContent = "Patient MRN, Visit ID, Note Date/Time, and Note Text are required.";
        return;
      }

      try{
        // Uses the same admin token pattern as your other admin calls
        const token = getAdminToken();
        if (!token) {
          if (msg) msg.textContent = "Please paste your ADMIN_TOKEN in Settings first.";
          return;
        }

        const res = await fetch("/admin/snf/cm-notes/manual-add", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Admin-Token": token
          },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok){
          if (msg) msg.textContent = data?.detail || "Failed to add note.";
          return;
        }

        if (msg) msg.textContent = data?.message || "Note added.";

        // Refresh the admissions list so the new / updated visit appears
        if (typeof loadAdmissions === "function") {
          await loadAdmissions();
        }

        // Close after a short beat (keeps UI feeling clean)
        setTimeout(() => closeManualCmNoteModal(), 350);

      }catch(err){
        if (msg) msg.textContent = "Error adding note: " + (err?.message || err);
      }
    }


    /* ------- Email Log modal ------- */

    let emailLogItems = [];
    let emailLogSelectedId = null;

    function openEmailLogModal() {
      const modal = document.getElementById("email-log-modal");
      if (!modal) return;
      modal.classList.add("open");   // ✅ must match .modal.open CSS
      loadEmailLog();
    }

    function closeEmailLogModal() {
      const modal = document.getElementById("email-log-modal");
      if (!modal) return;
      modal.classList.remove("open"); // ✅ must match .modal.open CSS
    }

    // ------- Reports modal -------
    function openReportsModal() {
      const modal = document.getElementById("reports-modal");
      if (!modal) return;
      modal.classList.add("open");
    }

    function closeReportsModal() {
      const modal = document.getElementById("reports-modal");
      if (!modal) return;
      modal.classList.remove("open");
    }

    function setReportsMsg(text, type) {
      const el = document.getElementById("reports-msg");
      if (!el) return;
      if (!text) {
        el.style.display = "none";
        el.textContent = "";
        return;
      }
      el.style.display = "block";
      el.textContent = text;
      el.style.border = "1px solid #e5e7eb";
      el.style.background = "#fff";
      if (type === "error") { el.style.borderColor = "#fecaca"; el.style.background = "#fef2f2"; }
      if (type === "success") { el.style.borderColor = "#bbf7d0"; el.style.background = "#f0fdf4"; }
    }

    async function runSelectedReport() {
      const token = getAdminToken();
      if (!token) {
        showToast("Please paste your ADMIN_TOKEN first.", "error");
        return;
      }

      const reportKey = (document.getElementById("report-select") || {}).value || "";
      const dcFrom = (document.getElementById("report-dc-from") || {}).value || "";
      const dcTo = (document.getElementById("report-dc-to") || {}).value || "";

      if (!dcFrom || !dcTo) {
        setReportsMsg("Please select both DC Date From and DC Date To.", "error");
        return;
      }

      setReportsMsg("", "");
      const out = document.getElementById("reports-output");
      if (out) out.innerHTML = `<div class="message">Running report…</div>`;

      try {
        const resp = await fetch("/admin/snf/reports/run", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Admin-Token": token
          },
          body: JSON.stringify({
            report_key: reportKey,
            dc_from: dcFrom,
            dc_to: dcTo
          })
        });

        const data = await resp.json().catch(() => ({}));
        if (!resp.ok || !data.ok) {
          throw new Error(data.detail || ("HTTP " + resp.status));
        }

        renderSnfAdmissionSummaryReport(data);

      } catch (err) {
        console.error("runSelectedReport error", err);
        if (out) out.innerHTML = `<div class="message">Error running report.</div>`;
        setReportsMsg("Error running report: " + (err?.message || err), "error");
      }
    }

    function renderSnfAdmissionSummaryReport(data) {
      const out = document.getElementById("reports-output");
      if (!out) return;

      const m = data.metrics || {};
      const t = data.totals || {};
      const top = Array.isArray(data.top_facilities) ? data.top_facilities : [];

      const notifiedPct = m.notified_pct != null ? m.notified_pct : 0;
      const unopenedPct = m.facility_pin_unopened_pct != null ? m.facility_pin_unopened_pct : 0;
      const openedPct = m.facility_pin_opened_pct != null ? m.facility_pin_opened_pct : 0;
      const aiAccPct = m.ai_accuracy_pct != null ? m.ai_accuracy_pct : 0;

      const aPct = (m.assignment_pct || {});
      const assignedPct = aPct["Assigned"] != null ? aPct["Assigned"] : 0;

      const assignedOutBase = (aPct["Assigned Out"] != null ? aPct["Assigned Out"] : 0);
      const assignedOutLtc  = (aPct["Assigned Out (LTC)"] != null ? aPct["Assigned Out (LTC)"] : 0);
      const assignedOutPct  = assignedOutBase + assignedOutLtc;

      const unknownPct = aPct["Unknown"] != null ? aPct["Unknown"] : 0;

      const dcFrom = escapeHtml((data.filters && data.filters.dc_from) || "");
      const dcTo = escapeHtml((data.filters && data.filters.dc_to) || "");

      out.innerHTML = `
        <div class="report-head">
          <div class="report-title">SNF Admission Summary</div>
          <div class="report-sub">Filtered by Hospital Discharge DC Date: <strong>${dcFrom}</strong> → <strong>${dcTo}</strong></div>
        </div>

        <div class="report-kpis">
          ${reportKpi("Emails opened (Facility PIN)", `${openedPct}%`, `${t.emails_in_cohort || 0} emails in cohort`)}
          ${reportKpi("Emails unopened (Facility PIN)", `${unopenedPct}%`, "1 open max per email")}
          ${reportKpi("Notified by Hospital", `${notifiedPct}%`, `${m.notified_count || 0} / ${t.snf_rows || 0}`)}
          ${reportKpi("AI candidate accuracy", `${aiAccPct}%`, `${m.ai_accuracy_correct || 0} / ${m.ai_accuracy_total || 0} scored`)}
        </div>

        <div class="report-grid">
          <div class="report-card">
            <div class="report-card-title">SNF Physician Assignment</div>
            <div class="report-row"><span>Assigned</span><strong>${assignedPct}%</strong></div>
            <div class="report-row"><span>Assigned Out</span><strong>${assignedOutPct}%</strong></div>
            <div class="report-row"><span>Unknown</span><strong>${unknownPct}%</strong></div>
          </div>

          <div class="report-card">
            <div class="report-card-title">Top 10 SNFs by Volume</div>
            <div class="report-list">
              ${top.length ? top.map((x, i) => {
                const name = escapeHtml(x.facility || "(Unknown)");
                const star = x.is_starred ? " <span class='report-star'>★</span>" : "";
                const count = (x.count != null) ? x.count : 0;
                return `<div class="report-list-item">
                          <div class="report-list-left">
                            <div class="report-rank">${i + 1}</div>
                            <div class="report-fac">${name}${star}</div>
                          </div>
                          <div class="report-pill">${count}</div>
                        </div>`;
              }).join("") : `<div class="message">No facility data in this range.</div>`}
            </div>
          </div>
        </div>

        <div class="report-foot muted" style="margin-top:10px;">
          Cohort rows (discharges): <strong>${t.joined_rows || 0}</strong> • SNF rows joined: <strong>${t.snf_rows || 0}</strong> • AI scored rows: <strong>${t.scored_ai_rows || 0}</strong>
        </div>
      `;
    }

    function reportKpi(label, value, sub) {
      return `
        <div class="report-kpi">
          <div class="report-kpi-label">${escapeHtml(label)}</div>
          <div class="report-kpi-value">${escapeHtml(String(value))}</div>
          <div class="report-kpi-sub">${escapeHtml(sub || "")}</div>
        </div>
      `;
    }

    async function loadEmailLog() {
      const token = getAdminToken();
      if (!token) {
        showToast("Please paste your ADMIN_TOKEN first.", "error");
        return;
      }

      const leftStatus = document.getElementById("email-log-left-status");
      const rightStatus = document.getElementById("email-log-right-status");
      const listEl = document.getElementById("email-log-list");
      const opensEl = document.getElementById("email-log-opens");

      if (leftStatus) leftStatus.textContent = "Loading…";
      if (rightStatus) rightStatus.textContent = "";
      if (listEl) listEl.innerHTML = "";
      if (opensEl) opensEl.innerHTML = `<div class="message">Select an email on the left.</div>`;

      try {
        const resp = await fetch("/admin/snf/email-log/list", {
          headers: { "X-Admin-Token": token }
        });
        if (!resp.ok) throw new Error("HTTP " + resp.status);

        const data = await resp.json();
        if (!data.ok) throw new Error(data.detail || "ok=false");

        emailLogItems = Array.isArray(data.items) ? data.items : [];
        emailLogSelectedId = null;

        renderEmailLogList();
        if (leftStatus) leftStatus.textContent = emailLogItems.length ? "" : "No sent emails found.";
      } catch (err) {
        console.error("loadEmailLog error", err);
        if (leftStatus) leftStatus.textContent = "Error loading.";
        showToast("Error loading email log: " + err, "error");
      }
    }

    function renderEmailLogList() {
      const listEl = document.getElementById("email-log-list");
      if (!listEl) return;

      listEl.innerHTML = "";

      emailLogItems.forEach(item => {
        const div = document.createElement("div");
        div.className = "email-item" + (String(item.secure_link_id) === String(emailLogSelectedId) ? " active" : "");

        const fac = item.snf_facility_name || "(Receiving facility)";
        const count = (item.patient_count != null) ? item.patient_count : "";
        const when = item.sent_at_local || item.sent_at || "";
        const to = item.sent_to || "";
        const facilityOpens = (item.facility_open_count != null) ? item.facility_open_count : 0;
        const universalOpens = (item.universal_open_count != null) ? item.universal_open_count : 0;


        div.innerHTML = `
          <div class="email-item-top">
            <div style="min-width:0;">
              <div class="email-fac">${escapeHtml(fac)}</div>
              <div class="email-meta">
                <div><strong>Patients:</strong> ${escapeHtml(String(count))}</div>
                <div><strong>Sent:</strong> ${escapeHtml(when)}</div>
                <div><strong>Recipients:</strong> ${escapeHtml(to)}</div>
                <div><strong>Facility Opens:</strong> ${escapeHtml(String(facilityOpens))}</div>
                <div><strong>Universal Opens:</strong> ${escapeHtml(String(universalOpens))}</div>
              </div>
            </div>

            <button class="pdf-btn" title="Download PDF" onclick="event.stopPropagation(); downloadEmailLogPdf(${item.secure_link_id});">
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 3v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M8 11l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M5 21h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
          </div>
        `;

        div.onclick = () => selectEmailLogItem(item.secure_link_id);
        listEl.appendChild(div);
      });
    }

    async function selectEmailLogItem(secureLinkId) {
      emailLogSelectedId = secureLinkId;
      renderEmailLogList();

      const token = getAdminToken();
      const rightStatus = document.getElementById("email-log-right-status");
      const opensEl = document.getElementById("email-log-opens");

      if (rightStatus) rightStatus.textContent = "Loading…";
      if (opensEl) opensEl.innerHTML = "";

      try {
        const resp = await fetch(`/admin/snf/email-log/opens/${secureLinkId}`, {
          headers: { "X-Admin-Token": token }
        });
        if (!resp.ok) throw new Error("HTTP " + resp.status);

        const data = await resp.json();
        if (!data.ok) throw new Error(data.detail || "ok=false");

        const rows = Array.isArray(data.items) ? data.items : [];
        if (!rows.length) {
          if (opensEl) opensEl.innerHTML = `<div class="message">No opens yet for this email.</div>`;
          if (rightStatus) rightStatus.textContent = "";
          return;
        }

        if (opensEl) {
          opensEl.innerHTML = "";
          rows.forEach(r => {
            const pinType = (r.pin_type || "").toLowerCase() || "unknown";
            const pillClass =
              pinType === "facility" ? "facility" :
              pinType === "universal" ? "universal" :
              pinType === "default" ? "default" : "";

            const card = document.createElement("div");
            card.className = "open-row";
            card.innerHTML = `
              <div class="open-top">
                <span class="pin-pill ${pillClass}">${escapeHtml(pinType)}</span>
                <div style="font-size:11px;color:#111827;font-weight:700;">
                  ${escapeHtml((r.accessed_at_et || r.accessed_at_local || r.accessed_at || "") + " ET")}
                </div>
              </div>
              <div class="open-sub">
                <div><strong>IP:</strong> ${escapeHtml(r.ip || "")}</div>
                <div><strong>User-Agent:</strong> ${escapeHtml(r.user_agent || "")}</div>
              </div>
            `;
            opensEl.appendChild(card);
          });
        }

        if (rightStatus) rightStatus.textContent = "";
      } catch (err) {
        console.error("selectEmailLogItem error", err);
        if (rightStatus) rightStatus.textContent = "Error loading.";
        if (opensEl) opensEl.innerHTML = `<div class="message">Error loading opens: ${escapeHtml(String(err))}</div>`;
      }
    }

    async function downloadEmailLogPdf(secureLinkId) {
      const token = getAdminToken();
      if (!token) {
        showToast("Please paste your ADMIN_TOKEN first.", "error");
        return;
      }

      try {
        const resp = await fetch(`/admin/snf/email-log/pdf/${secureLinkId}`, {
          headers: { "X-Admin-Token": token }
        });
        if (!resp.ok) throw new Error("HTTP " + resp.status);

        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = `SNF_Email_${secureLinkId}.pdf`;
        document.body.appendChild(a);
        a.click();
        a.remove();

        setTimeout(() => URL.revokeObjectURL(url), 1500);
      } catch (err) {
        console.error("downloadEmailLogPdf error", err);
        showToast("Error downloading PDF: " + err, "error");
      }
    }

    // ===============================
    // Facility(AI) name resolution
    // ===============================
    function normFacilityStr(s) {
      return String(s || "")
        .toLowerCase()
        .replace(/[\.\,\(\)\[\]\{\}\-_/\\]/g, " ")
        .replace(/\s+/g, " ")
        .trim();
    }

    function splitAliases(raw) {
      return String(raw || "")
        .split(/[,\|;]+/)
        .map(a => a.trim())
        .filter(Boolean);
    }

    function getFacilityAiPhone(r) {
      // IMPORTANT:
      // Phone should follow what the user is actually seeing as the facility label.
      // So try Manual override -> Effective facility -> AI raw (fallback)
      const candidate =
        String(r.final_snf_name_display || "").trim() ||
        String(r.effective_facility_name || "").trim() ||
        String(r.ai_snf_name_raw || "").trim();

      const match = resolveAiToSystemFacility(candidate);
      return (match && (match.facility_phone || "").trim()) || "";
    }

    function resolveAiToSystemFacility(aiRaw) {
      const aiNorm = normFacilityStr(aiRaw);
      if (!aiNorm) return null;

      for (const f of (snfFacilities || [])) {
        const name = f.facility_name || "";
        const nameNorm = normFacilityStr(name);
        if (nameNorm && (aiNorm.includes(nameNorm) || nameNorm.includes(aiNorm))) {
          return f; // matched by facility_name
        }

        const aliases = splitAliases(f.aliases);
        for (const a of aliases) {
          const aNorm = normFacilityStr(a);
          if (aNorm && (aiNorm.includes(aNorm) || aNorm.includes(aiNorm))) {
            return f; // matched by alias
          }
        }
      }
      return null;
    }

    function getFacilityAttendingsForRow(r) {
      // Match the same “what user is seeing” logic:
      // Manual override -> Effective facility -> AI raw
      const candidate =
        String(r.final_snf_name_display || "").trim() ||
        String(r.effective_facility_name || "").trim() ||
        String(r.ai_snf_name_raw || "").trim();

      const match = resolveAiToSystemFacility(candidate);
      const raw = (match && match.attending) ? String(match.attending).trim() : "";
      if (!raw) return "";

      // Normalize separators (commas, pipes, semicolons, newlines) into newlines for tooltip
      const parts = raw
        .split(/[\n,;|]+/g)
        .map(s => s.trim())
        .filter(Boolean);

      return parts.join("\n");
    }

    // What to display specifically in the "Facility (AI)" column
    // - If AI matches a system facility (name or alias): show system name
    // - If NO match: show raw AI text + " *" so you can spot it instantly
    function getFacilityAiDisplayName(r) {
      const aiRaw = (r.ai_snf_name_raw || "").trim();
      const match = resolveAiToSystemFacility(aiRaw);

      if (match && match.facility_name) return match.facility_name;

      if (aiRaw) return aiRaw + " *";     // 👈 AI-only marker
      return "(unknown)";
    }

    let snfSearchTerm = "";

    function onSnfSearchInput() {
      const el = document.getElementById("snf-search");
      snfSearchTerm = (el ? el.value : "").trim().toLowerCase();
      applyClientFiltersAndRender(); // re-render instantly (no API call)
    }

    function applyClientFiltersAndRender() {
      const facilityId = document.getElementById("filter-facility").value || "";

      // Start from the latest fetched admissions
      let filtered = (admissions || []).slice();

      // -------------------------------
      // Client-side facility name filter using SNF Admission Facilities
      // (this is your existing logic, moved here)
      // -------------------------------
      filtered = filtered.filter(r => {
        if (!facilityId) return true;

        const rowText = normFacilityStr(
          (r.effective_facility_name || "") + " " +
          (r.final_snf_name_display || "") + " " +
          (r.ai_snf_name_raw || "")
        );

        // Starred filter
        if (facilityId === "__starred__") {
          const starredFacilities = (snfFacilities || []).filter(f => (f.attending || "").trim());
          if (!starredFacilities.length) return false;

          for (const f of starredFacilities) {
            const tokens = [];
            if (f.facility_name) tokens.push(f.facility_name);
            splitAliases(f.aliases).forEach(a => tokens.push(a));

            const hit = tokens
              .map(t => normFacilityStr(t))
              .filter(Boolean)
              .some(tn => rowText.includes(tn));

            if (hit) return true;
          }
          return false;
        }

        // Normal single-facility filter
        const fac = snfFacilities.find(f => String(f.id) === String(facilityId));
        if (!fac) return true;

        const tokens = [];
        if (fac.facility_name) tokens.push(fac.facility_name);
        splitAliases(fac.aliases).forEach(a => tokens.push(a));

        if (!tokens.length) return true;
        return tokens
          .map(t => normFacilityStr(t))
          .filter(Boolean)
          .some(tn => rowText.includes(tn));
      });

      // -------------------------------
      // NEW: Free-text search (patient_name + visit_id)
      // -------------------------------
      if (snfSearchTerm) {
        filtered = filtered.filter(r => {
          const pn = String(r.patient_name || "").toLowerCase();
          const vid = String(r.visit_id || "").toLowerCase();
          return pn.includes(snfSearchTerm) || vid.includes(snfSearchTerm);
        });
      }

      // -------------------------------
      // Apply Sort by / Direction (your existing logic)
      // -------------------------------
      const sortBy = document.getElementById("sort-by")?.value || "";
      const sortDir = document.getElementById("sort-dir")?.value || "asc";
      const dir = (sortDir === "desc") ? -1 : 1;

      if (sortBy) {
        filtered.sort((a, b) => {
          let av = "", bv = "";

          if (sortBy === "patient") {
            av = (a.patient_name || "").toLowerCase();
            bv = (b.patient_name || "").toLowerCase();
          } else if (sortBy === "facility") {
            av = (getSortFacilityLabel(a) || "").toLowerCase();
            bv = (getSortFacilityLabel(b) || "").toLowerCase();
          }

          if (av < bv) return -1 * dir;
          if (av > bv) return  1 * dir;
          return 0;
        });
      }

      currentRows = filtered;
      renderTable(filtered);

      document.getElementById("list-message").innerHTML =
        `<strong>${filtered.length}</strong> rows (from ${admissions.length} total).`;
    }

    async function loadAdmissions() {
      const token = getAdminToken();
      if (!token) {
        alert("Please paste your ADMIN_TOKEN first.");
        return;
      }
      const date = document.getElementById("filter-date").value;
      const days = document.getElementById("filter-days").value || "0";
      const status = document.getElementById("filter-status").value;
      const facilityId = document.getElementById("filter-facility").value || "";

      const params = new URLSearchParams();
      if (status) params.set("status", status);
      const dateIso = parseMDYToISO(date);
      if (dateIso) params.set("for_date", dateIso);
      if (days) params.set("days_ahead", days);
      
      const emailAt = document.getElementById("filter-email-at")?.value || "";
      const emailDays = document.getElementById("filter-email-days")?.value || "0";
      if (emailAt) params.set("email_at", emailAt);
      if (emailAt && emailDays) params.set("email_days_ahead", emailDays);
      
      const notified = document.getElementById("filter-notified")?.value || "";
      if (notified) params.set("notified_only", notified);

      document.getElementById("list-message").textContent = "Loading...";
      selectedId = null;
      document.getElementById("note-meta").innerHTML = "<div>Select a row to load the note.</div>";
      document.getElementById("note-text").textContent = "";
      document.getElementById("note-message").textContent = "";
      document.getElementById("note-header-summary").textContent = "";

      try {
        const resp = await fetch(`/admin/snf/list?${params.toString()}`, {
          headers: { "X-Admin-Token": token }
        });
        if (!resp.ok) {
          throw new Error("HTTP " + resp.status);
        }
        const data = await resp.json();
        if (!data.ok) {
          throw new Error(data.detail || "Server returned ok=false");
        }

         admissions = data.items || [];

         // Re-render using facility filters + NEW search term + sort
         applyClientFiltersAndRender();


      } catch (err) {
        console.error("loadAdmissions error", err);
        document.getElementById("list-message").textContent = "Error loading admissions: " + err;
      }
    }


    function getDisplayFacilityLabel(r) {
      // 1) Manual override always wins
      if (r.final_snf_name_display) {
        return r.final_snf_name_display;
      }

      // 2) System facility name if AI matches name or aliases
      const aiDisplay = getFacilityAiDisplayName(r);
      if (aiDisplay) {
        return aiDisplay;
      }

      // 3) Absolute fallback
      return "";
    }

    // Sort-safe facility label (don’t let the " *" change ordering)
    function getSortFacilityLabel(r) {
      const label = (getDisplayFacilityLabel(r) || "").trim();
      return label.replace(/\s*\*$/, "").trim();
    }

    function getAssignmentDotHtml(r) {
      const c = (r && r.assignment_confirmation ? String(r.assignment_confirmation) : "Unknown").trim();
      if (c === "Assigned") {
        return `<span class="assign-dot mint-accent" title="Physician Assigned" aria-label="Physician Assigned"></span>`;
      }
      if (c === "Assigned Out" || c === "Assigned Out (LTC)") {
        const label = (c === "Assigned Out (LTC)") ? "Assigned Out (LTC)" : "Assigned Out";
        return `<span class="assign-dot neg-accent" title="${label}" aria-label="${label}"></span>`;
      }
      return "";
    }

    function renderTable(rows) {
      const tbody = document.getElementById("snf-body");
      tbody.innerHTML = "";
      rows.forEach(r => {
        const tr = document.createElement("tr");
        tr.className = (r.status || "new") + (r.id === selectedId ? " selected" : "");
        tr.onclick = () => selectRow(r.id);
        // Prefer the reviewer-confirmed / manual facility name if present,
        // then fall back to the facility from the DB, then AI (mapped to system facility name if possible).
        let facLabel = "";

        if (r.final_snf_name_display) {
          facLabel = r.final_snf_name_display;
        } else {
          const facLabelParts = [];
          if (r.effective_facility_name) facLabelParts.push(r.effective_facility_name);
          if (r.effective_facility_city || r.effective_facility_state) {
            facLabelParts.push(
              `(${[r.effective_facility_city, r.effective_facility_state].filter(Boolean).join(", ")})`
            );
          }

          // NOTE: intentionally NOT appending attending name here
          const aiDisplay = getFacilityAiDisplayName(r);

          facLabel = facLabelParts.join(" ") || aiDisplay || "(unknown)";
        }

        const underName = r.visit_id
          ? `${r.visit_id}`
          : (r.patient_mrn ? `MRN ${r.patient_mrn}` : "");

        const emailed = r.emailed_at ? "Yes" : "No";

        tr.innerHTML = `
          <td>${r.id}</td>
          <td>
            <div><strong>${r.patient_name || ""}</strong></div>
            <div style="color:#6b7280;">${underName}</div>
          </td>
          <td>
            <div>${escapeHtml(r.hospital_name || "")}</div>
            <div style="color:#6b7280;">
              ${r.admit_date ? `Admit: ${escapeHtml(formatISOToMDY(r.admit_date))}` : ""}
            </div>
            ${
              r.notified_by_hospital
                ? ` <span class="notif-dot" title="Notified by Hospital" aria-label="Notified by Hospital">
                      <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M12 22a2 2 0 0 0 2-2H10a2 2 0 0 0 2 2Z" stroke="currentColor" stroke-width="2"/>
                        <path d="M18 16v-5a6 6 0 1 0-12 0v5l-2 2h16l-2-2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                      </svg>
                    </span>`
                : ""
            }
          </td>
          <td>
            ${
              (() => {
                const att = getFacilityAttendingsForRow(r);
                if (att) {
                  return `
                    <div class="fac-hover" style="font-weight:600; line-height:1.15;">
                      ${escapeHtml(facLabel)}
                      <div class="fac-tip" role="tooltip">
                        <div class="fac-tip-title">Attendings</div>
                        <div class="fac-tip-body">${escapeHtml(att)}</div>
                      </div>
                    </div>
                  `;
                }
                // No attendings configured → just show the label normally (no tooltip)
                return `<div style="font-weight:600; line-height:1.15;">${escapeHtml(facLabel)}</div>`;
              })()
            }

            ${
              (getFacilityAiPhone(r) || "").trim()
                ? `<div class="fac-subrow">
                     <span>${escapeHtml(getFacilityAiPhone(r))}</span>
                     ${getAssignmentDotHtml(r)}
                   </div>`
                : ""
            }
          </td>
          <td>${formatISOToMDY(r.effective_date)}</td>
          <td>${(r.ai_confidence != null ? r.ai_confidence.toFixed(2) : "")}</td>
          <td>
            ${(() => {
              const st = (r.status || "new");
              const label = st.charAt(0).toUpperCase() + st.slice(1);
              return `<span class="status-pill ${st}">${label}</span>`;
            })()}
          </td>
          <td>${emailed}</td>
          <td>${formatISOToMDY(r.last_seen_active_date_et || r.last_seen_active_date)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function selectRow(id) {
      selectedId = id;
      const token = getAdminToken();
      if (!token) {
        alert("Please paste your ADMIN_TOKEN first.");
        return;
      }
      // Highlight
      const trs = document.querySelectorAll("#snf-body tr");
      trs.forEach(tr => {
        if (tr.firstElementChild && parseInt(tr.firstElementChild.textContent, 10) === id) {
          tr.classList.add("selected");
        } else {
          tr.classList.remove("selected");
        }
      });

      document.getElementById("note-message").textContent = "Loading note...";
      try {
        const resp = await fetch(`/admin/snf/note/${id}`, {
          headers: { "X-Admin-Token": token }
        });
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();
        if (!data.ok) throw new Error(data.detail || "ok=false");
        const adm = data.admission;
        const note = data.note;

        const visitLabel = adm.visit_id
          ? `Visit ${adm.visit_id}`
          : (adm.patient_mrn ? `MRN ${adm.patient_mrn}` : "");

        // New: emailed badge label + class
        const emailedLabel = adm.emailed_at
          ? `Emailed on ${adm.emailed_at}`
          : "Not yet emailed";
        const emailedClass = adm.emailed_at ? "sent" : "not-sent";

        const admitTag = (adm.admit_date || "").trim()
          ? ` <span style="color:#6b7280;">(Admit: ${adm.admit_date})</span>`
          : "";

        document.getElementById("note-meta").innerHTML = `
          <div><strong>${adm.patient_name || ""}</strong>${visitLabel ? " (" + visitLabel + ")" : ""}</div>
          <div>${adm.hospital_name || ""}${admitTag}</div>
          <div>AI SNF: ${adm.ai_snf_name_raw || "(none)"} | AI DC Date: ${adm.ai_expected_transfer_date || "(none)"} | AI conf: ${adm.ai_confidence != null ? adm.ai_confidence.toFixed(2) : "(n/a)"}</div>
          <div>
            <span class="email-badge ${emailedClass}">${emailedLabel}</span>
          </div>
        `;


        // Render all notes for this admission
        const noteTextEl = document.getElementById("note-text");
        noteTextEl.innerHTML = "";
        const allNotes = (data.notes && Array.isArray(data.notes) && data.notes.length) ? data.notes : [note];
        
        // Sort notes newest -> oldest
        allNotes.sort((a, b) => {
          const ad = a.note_datetime || "";
          const bd = b.note_datetime || "";
          if (ad === bd) return (b.id || 0) - (a.id || 0);
          return bd.localeCompare(ad);
        });

        allNotes.forEach(n => {
          const wrapper = document.createElement("div");
          wrapper.className = "note-entry";

          const header = document.createElement("div");
          header.className = "note-entry-header";

          const headerRow = document.createElement("div");
          headerRow.className = "note-entry-header-row";

          const left = document.createElement("div");
          left.className = "note-entry-header-left";
          const headerBits = [];
          if (n.note_datetime) headerBits.push(n.note_datetime);
          if (n.note_type) headerBits.push(n.note_type);
          if (n.note_author) headerBits.push("by " + n.note_author);
          left.textContent = headerBits.join(" – ");

          const right = document.createElement("div");
          right.className = "note-entry-header-right";

          const created = document.createElement("div");
          created.className = "note-created-at";
          const addedTs = n.created_at_et || n.created_at;
          created.textContent = addedTs ? ("Added: " + addedTs + " ET") : "";


          const delBtn = document.createElement("button");
          delBtn.className = "note-mini-btn";
          delBtn.title = "Ignore this note (hide + AI ignore)";
          delBtn.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <!-- circle -->
              <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2" />
              <!-- perfectly centered X -->
              <path d="M9 9l6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M15 9l-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          `;
          delBtn.onclick = async (ev) => {
            ev.preventDefault();
            ev.stopPropagation();
            const token = getAdminToken();
            if (!token) {
              alert("Paste ADMIN_TOKEN in Settings first.");
              return;
            }
            const ok = confirm("Ignore this note? It will be removed from the list and ignored by the AI.");
            if (!ok) return;

            try {
              const resp2 = await fetch("/admin/snf/cm-note/ignore", {
                method: "POST",
                headers: { "Content-Type": "application/json", "X-Admin-Token": token },
                body: JSON.stringify({ note_id: n.id })
              });
              let data2 = null;
              try { data2 = await resp2.json(); } catch (e) {}
              if (!resp2.ok || (data2 && data2.ok === false)) {
                throw new Error((data2 && (data2.detail || data2.message)) || ("HTTP " + resp2.status));
              }
              // NEW: recompute AI for this admission immediately after ignoring a note
              try {
                const payload3 = {
                  visit_id: (adm && adm.visit_id) ? String(adm.visit_id) : "",
                  patient_mrn: (adm && adm.patient_mrn) ? String(adm.patient_mrn) : ""
                };
                await fetch("/admin/snf/admission/recompute", {
                  method: "POST",
                  headers: { "Content-Type": "application/json", "X-Admin-Token": token },
                  body: JSON.stringify(payload3)
                });
              } catch (e3) {
                console.warn("Recompute failed (non-fatal):", e3);
              }

              if (selectedId != null) await selectRow(selectedId);
              // Optional: refresh the left list too so the facility column updates instantly
              try { await loadAdmissions(); } catch (e4) {}

            } catch (e) {
              console.error(e);
              alert("Could not ignore note: " + e);
            }
          };

          right.appendChild(created);
          right.appendChild(delBtn);

          headerRow.appendChild(left);
          headerRow.appendChild(right);

          header.appendChild(headerRow);


          const body = document.createElement("div");
          body.className = "note-entry-body";
          body.innerHTML = highlightText(n.note_text || "", getEffectiveHighlightKeywords());


          wrapper.appendChild(header);
          wrapper.appendChild(body);
          noteTextEl.appendChild(wrapper);
        });

        document.getElementById("edit-status").value = adm.status || "new";
        document.getElementById("edit-disposition").value = adm.disposition || "";
        document.getElementById("edit-date").value = adm.final_expected_transfer_date || (adm.ai_expected_transfer_date || "");
        document.getElementById("edit-comments").value = adm.review_comments || "";

        const aiRaw = (adm.ai_snf_name_raw || "").trim();
        const aiMatchesSystem = !!resolveAiToSystemFacility(aiRaw);

        // Decide which facility label to use to preselect the dropdown
        const facilityLabel =
          adm.final_snf_name_display ||
          adm.facility_free_text ||
          adm.ai_snf_name_raw ||
          "";
        setEditFacilityByLabel(facilityLabel);

        document.getElementById("note-header-summary").textContent = `Editing SNF record ID ${adm.id}`;
        
        const btn = document.getElementById("notif-btn");
        if (btn) {
          if (adm.notified_by_hospital) btn.classList.add("on");
          else btn.classList.remove("on");
        }

        /* NEW: sync physician assignment icon state with the selected admission */
        const pbtn = document.getElementById("phys-assign-btn");
        if (pbtn) {
          const conf = (adm.assignment_confirmation || "Unknown").toString().trim();
          if (conf && conf !== "Unknown") pbtn.classList.add("on");
          else pbtn.classList.remove("on");
        }
        document.getElementById("note-message").textContent = "";
      } catch (err) {
        console.error("selectRow error", err);
        document.getElementById("note-message").textContent = "Error loading note: " + err;
      }
    }

    async function saveCurrent() {
      if (!selectedId) {
        alert("Select a row first.");
        return;
      }
      const token = getAdminToken();
      if (!token) {
        alert("Please paste your ADMIN_TOKEN first.");
        return;
      }
      const status = document.getElementById("edit-status").value;
      const disposition = document.getElementById("edit-disposition").value;
      const date = document.getElementById("edit-date").value;
      const facilitySelect = document.getElementById("edit-facility-select");
      const facilityLabel =
        facilitySelect && facilitySelect.value
          ? facilitySelect.options[facilitySelect.selectedIndex].text
          : "";
      const comments = document.getElementById("edit-comments").value;

      document.getElementById("note-message").textContent = "Saving...";
      try {
        const resp = await fetch("/admin/snf/update", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Admin-Token": token
          },
          body: JSON.stringify({
            id: selectedId,
            status: status,
            disposition: disposition || "",
            final_expected_transfer_date: date || null,
            facility_free_text: facilityLabel || "",
            review_comments: comments || ""
          })
        });
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();
        if (!data.ok) throw new Error(data.detail || "ok=false");
        document.getElementById("note-message").textContent = "Saved.";
        // Reload list to refresh colors/dates
        loadAdmissions();
      } catch (err) {
        console.error("saveCurrent error", err);
        document.getElementById("note-message").textContent = "Error saving: " + err;
      }
    }

    async function sendEmails(testOnly) {
      const token = getAdminToken();
      if (!token) {
        alert("Please paste your ADMIN_TOKEN first.");
        return;
      }

      const date = document.getElementById("filter-date").value;
      const facilityId = document.getElementById("filter-facility").value;

      if (!facilityId) {
        alert("Please choose a SNF facility from the dropdown first.");
        return;
      }
      if (!currentRows.length) {
        alert("There are no admissions in the current filtered list to include.");
        return;
      }

      const testTo = document.getElementById("test-email-to").value;
      if (testOnly && !testTo) {
        alert("Enter a test email address.");
        return;
      }

      const admissionIds = currentRows.map(r => r.id);

      const payload = {
        snf_facility_id: parseInt(facilityId, 10),
        for_date: date || "",
        admission_ids: admissionIds,
        test_only: !!testOnly,
        test_email_to: testOnly ? testTo : ""
      };

      document.getElementById("list-message").textContent = "Sending email with PDF...";
      try {
        const resp = await fetch("/admin/snf/email-pdf", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Admin-Token": token
          },
          body: JSON.stringify(payload)
        });

        let data = null;
        if (!resp.ok) {
          try {
            data = await resp.json();
          } catch (e) {
            // ignore JSON parse errors
          }
          const detail = data && (data.detail || data.message);
          throw new Error("HTTP " + resp.status + (detail ? " – " + detail : ""));
        }

        data = data || await resp.json();
        if (!data.ok && data.ok !== undefined) {
          throw new Error(data.detail || "ok=false");
        }


        const msgParts = [];
        msgParts.push(testOnly ? "Test email sent." : "Email with PDF sent.");
        if (data.emails_sent != null) msgParts.push(`emails_sent=${data.emails_sent}`);
        if (data.admissions_tagged != null) msgParts.push(`admissions_tagged=${data.admissions_tagged}`);
        document.getElementById("list-message").textContent = msgParts.join(" ");

        if (!testOnly) {
          // Refresh list so emailed rows show emailed_at
          loadAdmissions();
        }
      } catch (err) {
        console.error("sendEmails error", err);
        document.getElementById("list-message").textContent = "Error sending emails: " + err;
      }
    }


    // Init on load
    window.addEventListener("DOMContentLoaded", () => {
      initToken();
      initDate();
      loadSnfFacilities();
      loadUniversalPinStatus();
      loadKeywords(); // <-- add this
    });

  </script>
  
  <!-- Toast -->
  <div id="toast" class="toast" aria-live="polite"></div>

  <!-- Facility Add/Edit Modal -->
  <div id="facility-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="facility-modal-title">
    <div class="modal-card">
      <div class="modal-head">
        <div>
          <div id="facility-modal-title" class="modal-title">Add SNF facility</div>
          <div class="modal-sub">Matches the site styling. PIN is stored securely (hash).</div>
        </div>
        <button class="modal-x" onclick="closeFacilityModal()" aria-label="Close">✕</button>
      </div>

      <div class="modal-body">
        <div id="facility-modal-msg" class="modal-msg" style="display:none;"></div>

        <div class="grid2">
          <div>
            <label>Facility name *</label>
            <input id="facility-name" type="text" placeholder="e.g., Luxe Rehab" />
            
            <label class="label" style="margin-top:10px;">Facility Phone</label>
            <input id="facility-phone" class="input" type="text" placeholder="e.g., (555) 123-4567" />
          </div>
          <div>
            <label>Attending(s)</label>
            <input id="facility-attending" type="text" placeholder="e.g., Pandey, Ravi MD" />
          </div>
        </div>

        <label>Aliases (comma separated)</label>
        <input id="facility-aliases" type="text" placeholder="e.g., Luxe Rehab at Wellington, Luxe Wellington" />

        <label>Facility email recipients (comma separated)</label>
        <textarea id="facility-emails" rows="3" placeholder="admissions@…, referrals@…"
                  style="resize:vertical;"></textarea>

        <div class="grid2">
          <div>
            <label>Notes</label>
            <textarea id="facility-notes" rows="3" placeholder="Optional notes…"></textarea>
          </div>
          <div>
            <label>Notes2</label>
            <textarea id="facility-notes2" rows="3" placeholder="Optional notes…"></textarea>
          </div>
        </div>

        <div class="pin-row">
          <div class="pin-left">
            <label>Facility PIN</label>
            <input id="facility-pin" type="password" placeholder="Set a new PIN (leave blank to keep unchanged)" />
            <div class="pin-help">
              <span id="facility-pin-status">PIN: Not set</span>
              <span class="dot" aria-hidden="true"></span>
              <span>Stored as a hash. You can set a new one any time.</span>
            </div>
          </div>
          <div class="pin-right">
            <label>&nbsp;</label>
            <label class="checkline">
              <input id="facility-clear-pin" type="checkbox" />
              Clear facility PIN (forces universal PIN fallback)
            </label>
          </div>
        </div>
      </div>

      <div class="modal-foot">
        <button class="btn-lite" onclick="closeFacilityModal()">Cancel</button>
        <button class="btn-primary" onclick="saveFacilityFromModal()">Save</button>
      </div>
    </div>
  </div>

  <style>
    /* --- Modal / Toast styling that fits your existing clean UI --- */
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);opacity:0;pointer-events:none;
      padding:10px 12px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;box-shadow:0 10px 30px rgba(0,0,0,.12);
      font-size:13px;color:#111827;min-width:260px;max-width:560px;z-index:9999;}
    .toast.show{opacity:1;pointer-events:auto;transition:opacity .15s ease;}
    .toast.success{border-color:#bbf7d0;background:#f0fdf4;}
    .toast.error{border-color:#fecaca;background:#fef2f2;}
    .toast.info{border-color:#e5e7eb;background:#fff;}

    .modal{position:fixed;inset:0;background:rgba(17,24,39,.55);display:none;align-items:center;justify-content:center;z-index:9998;padding:18px;}
    .modal.open{display:flex;}
    .modal-card{width:min(920px,100%);background:#fff;border-radius:16px;box-shadow:0 18px 60px rgba(0,0,0,.25);overflow:hidden;border:1px solid #e5e7eb;}
    .modal-head{display:flex;align-items:flex-start;justify-content:space-between;padding:16px 18px;border-bottom:1px solid #e5e7eb;}
    .modal-title{font-size:16px;font-weight:800;color:#111827;}
    .modal-sub{margin-top:2px;font-size:12px;color:#6b7280;}
    .modal-x{border:0;background:transparent;font-size:18px;cursor:pointer;color:#6b7280;padding:4px 8px;border-radius:10px;}
    .modal-x:hover{background:#f3f4f6;}
    .modal-body{padding:16px 18px;}
    .modal-foot{display:flex;justify-content:flex-end;gap:8px;padding:14px 18px;border-top:1px solid #e5e7eb;background:#fafafa;}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media(max-width:760px){.grid2{grid-template-columns:1fr;}}

    .modal-body label{display:block;font-size:12px;font-weight:700;color:#374151;margin:10px 0 6px;}
    .modal-body input,
    .modal-body textarea,
    .modal-body select{
      width:100%;
      box-sizing:border-box;
      border:1px solid #d1d5db;
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      min-width:0;
      background:#fff;
    }
    .modal-body input:focus,
    .modal-body textarea:focus,
    .modal-body select:focus{
      outline:none;
      border-color:#A8E6CF;
      box-shadow:0 0 0 3px rgba(168,230,207,0.35);
    }

    .modal-msg{display:none;margin-bottom:10px;padding:10px 12px;border-radius:12px;border:1px solid #e5e7eb;font-size:13px;}
    .modal-msg.info{display:block;background:#fff;}
    .modal-msg.success{display:block;border-color:#bbf7d0;background:#f0fdf4;}
    .modal-msg.error{display:block;border-color:#fecaca;background:#fef2f2;}

    .pin-row{display:flex;gap:12px;align-items:flex-start;margin-top:6px;}
    .pin-left{flex:1;min-width:0;}
    .pin-right{width:300px;}
    @media(max-width:760px){.pin-row{flex-direction:column;}.pin-right{width:100%;}}
    .pin-help{margin-top:6px;font-size:12px;color:#6b7280;display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .pin-help .dot{width:4px;height:4px;border-radius:999px;background:#A8E6CF;display:inline-block;}
    .checkline{display:flex;align-items:center;gap:8px;font-size:13px;color:#374151;font-weight:600;margin-top:6px;}
    .nm-toggle-row{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .toggle-pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      color:#6b7280;
      font-weight:800;
      font-size:13px;
      cursor:pointer;
      user-select:none;
      line-height:1;
    }

    .toggle-pill:hover{
      background:#ffffff;
    }

    .toggle-pill.active{
      background:#ffffff;
      border-color:#A8E6CF;
      color:#A8E6CF;
      box-shadow: 0 0 0 3px rgba(168,230,207,0.25);
    }

    .btn-primary{background:#0D3B66;color:#fff;border:0;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer;}
    .btn-primary:hover{background:#0b3357;}
    .btn-lite{background:#fff;color:#111827;border:1px solid #e5e7eb;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;}
    .btn-lite:hover{background:#f9fafb;}

    /* --- Reports UI (keeps your clean navy + mint styling) --- */
    .report-head{display:flex;flex-direction:column;gap:4px;margin-bottom:12px;}
    .report-title{font-size:16px;font-weight:900;color:#111827;}
    .report-sub{font-size:12px;color:#6b7280;}

    .report-kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;}
    @media(max-width:980px){.report-kpis{grid-template-columns:repeat(2,1fr);}}
    @media(max-width:520px){.report-kpis{grid-template-columns:1fr;}}

    .report-kpi{
      border:1px solid #e5e7eb;
      background:#ffffff;
      border-radius:14px;
      padding:10px 12px;
      box-shadow:0 10px 24px rgba(15,23,42,0.06);
    }
    .report-kpi-label{font-size:11px;color:#6b7280;font-weight:800;letter-spacing:.02em;text-transform:uppercase;}
    .report-kpi-value{font-size:18px;font-weight:950;color:#0D3B66;margin-top:4px;}
    .report-kpi-sub{font-size:12px;color:#6b7280;margin-top:2px;}

    .report-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}
    @media(max-width:860px){.report-grid{grid-template-columns:1fr;}}

    .report-card{
      border:1px solid #e5e7eb;
      background:#ffffff;
      border-radius:16px;
      padding:12px 12px;
      box-shadow:0 12px 30px rgba(15,23,42,0.07);
    }
    .report-card-title{font-size:13px;font-weight:950;color:#111827;margin-bottom:10px;}
    .report-row{display:flex;align-items:center;justify-content:space-between;padding:8px 2px;border-top:1px solid #f3f4f6;}
    .report-row:first-of-type{border-top:0;}
    .report-row span{font-size:12px;color:#6b7280;font-weight:800;}
    .report-row strong{font-size:13px;color:#111827;font-weight:950;}

    .report-list{display:flex;flex-direction:column;gap:8px;}
    .report-list-item{
      border:1px solid #e5e7eb;
      background:#fafafa;
      border-radius:14px;
      padding:10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .report-list-left{display:flex;align-items:center;gap:10px;min-width:0;}
    .report-rank{
      width:24px;height:24px;border-radius:10px;
      display:flex;align-items:center;justify-content:center;
      font-size:12px;font-weight:950;color:#0D3B66;
      border:1px solid rgba(13,59,102,.16);
      background:rgba(13,59,102,.04);
      flex:0 0 auto;
    }
    .report-fac{font-size:13px;font-weight:900;color:#111827;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .report-star{color:#A8E6CF;font-weight:950;margin-left:6px;}
    .report-pill{
      font-size:12px;font-weight:950;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(168,230,207,0.65);
      background:rgba(168,230,207,0.12);
      color:#0D3B66;
      flex:0 0 auto;
    }
  </style>


  
</body>
</html>
