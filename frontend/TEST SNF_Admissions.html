<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SNF Admissions – Audit & Notifications</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f5f7;
      color: #111827;
      line-height: 1.5;
    }

    header {
      padding: 10px 18px;
      background: #111827;
      color: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.35);
    }

    header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.03em;
    }

    header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.03em;
    }

    /* Header right-side group: status chips + buttons */
    .header-right{
      display:flex;
      align-items:center;
      gap:10px;
    }

    /* Small status chips (right side, not behind buttons) */
    .header-status{
      font-size:12px;
      color:#e5e7eb;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(229,231,235,0.22);
      background:rgba(255,255,255,0.06);
      white-space:nowrap;
    }

    /* Icon links: NO absolute positioning anymore */
    .admin-link,
    .email-link{
      width:34px;
      height:34px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:12px;
      color:#e5e7eb;
      text-decoration:none;
      border:1px solid rgba(229,231,235,0.22);
      background:rgba(255,255,255,0.06);
      transition:transform .08s ease, background .15s ease, border-color .15s ease, color .15s ease;
    }

    .email-link:hover{
      background:rgba(255,255,255,0.12);
      border-color:rgba(168,230,207,0.55);
      color:#ffffff;
    }
    .email-link:active{
      transform:scale(0.96);
    }

    /* NEW: Email Log modal layout */
    .email-log-wrap{
      display:grid;
      grid-template-columns: 1.05fr 1fr;
      gap:12px;
      height: min(70vh, 620px);   /* not too tall; fits screen */
      min-height: 360px;
    }
    .email-log-card{
      border:1px solid #e5e7eb;
      border-radius:14px;
      background:#fafafa;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .email-log-card-head{
      padding:10px 12px;
      border-bottom:1px solid #e5e7eb;
      background:#ffffff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .email-log-card-title{
      font-weight:800;
      color:#111827;
      font-size:13px;
    }
    .email-log-scroll{
      padding:10px 12px;
      overflow:auto;
      min-height:0;
    }

    .email-item{
      border:1px solid #e5e7eb;
      background:#ffffff;
      border-radius:12px;
      padding:10px 10px;
      margin-bottom:10px;
      cursor:pointer;
      transition: border-color .15s ease, box-shadow .15s ease, transform .08s ease;
    }
    .email-item:hover{
      border-color: rgba(168,230,207,0.75);
      box-shadow: 0 10px 24px rgba(15,23,42,0.10);
    }
    .email-item:active{ transform: scale(0.99); }
    .email-item.active{
      border-color:#A8E6CF;
      box-shadow: 0 0 0 3px rgba(168,230,207,0.30);
    }
    .email-item-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .email-fac{
      font-weight:800;
      font-size:13px;
      color:#111827;
      line-height:1.2;
    }
    .email-meta{
      font-size:11px;
      color:#6b7280;
      margin-top:6px;
      line-height:1.35;
      word-break:break-word;
    }
    .pdf-btn{
      border:1px solid #e5e7eb;
      background:#ffffff;
      border-radius:10px;
      width:30px;
      height:30px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      flex:0 0 auto;
    }
    .pdf-btn:hover{
      border-color: rgba(168,230,207,0.85);
    }
    .pdf-btn svg{ width:16px; height:16px; color:#0D3B66; }

    .open-row{
      border:1px solid #e5e7eb;
      background:#ffffff;
      border-radius:12px;
      padding:10px 10px;
      margin-bottom:10px;
    }
    .open-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .pin-pill{
      font-size:11px;
      font-weight:800;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      color:#111827;
      text-transform:uppercase;
      letter-spacing:0.03em;
    }
    .pin-pill.facility{ border-color:#A8E6CF; }
    .pin-pill.universal{ border-color:#93c5fd; }
    .pin-pill.default{ border-color:#fca5a5; }

    .open-sub{
      font-size:11px;
      color:#6b7280;
      margin-top:6px;
      word-break:break-word;
    }
    
    .admin-link:hover{
      background:rgba(255,255,255,0.12);
      border-color:rgba(168,230,207,0.55);
      color:#ffffff;
    }
    .admin-link:active{
      transform:scale(0.96);
    }

    main {
      display: grid;
      grid-template-columns: 2fr 1.3fr;
      gap: 16px;
      padding: 24px 24px 32px;
      box-sizing: border-box;
    }

    .panel {
      background: #ffffff;
      border-radius: 20px;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.12);
      display: flex;
      flex-direction: column;
      border: 1px solid #e5e7eb;
      overflow: hidden;
    }

    .panel-header {
      padding: 12px 16px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      background: #f9fafb;
    }

    .panel-header h2 {
      margin: 0;
      font-size: 15px;
      font-weight: 700;
      color: #111827;
    }


    /* Make the two panels fill the viewport under the header */
    main {
      height: calc(100vh - 70px); /* adjust 70px if your header height changes */
    }

    /* Critical for nested flex scroll areas */
    .panel,
    .table-wrapper,
    #note-panel {
      min-height: 0;
    }

    /* Left table already scrolls via .table-wrapper { overflow:auto; } */

    /* Right panel: ONLY the note text area scrolls */
    #note-text {
      overflow: auto;
      flex: 1;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: flex-end;
      font-size: 12px;
    }

    label {
      font-size: 11px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.09em;
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    select,
    textarea {
      padding: 5px 8px;
      font-size: 12px;
      border: 1px solid #d1d5db;
      border-radius: 999px;
      background: #ffffff;
      box-sizing: border-box;
    }

    button {
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 4px;
      border: 1px solid #4b5563;
      background: #f9fafb;
      cursor: pointer;
    }
    button.primary {
      background: #2563eb;
      border-color: #2563eb;
      color: #f9fafb;
    }
    button.small {
      font-size: 11px;
      padding: 2px 6px;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .token-box {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
    }
    .token-box input {
      width: 180px;
    }
    .table-wrapper {
      flex: 1;
      overflow: auto;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead {
      position: sticky;
      top: 0;
      background: #f3f4ff;
      z-index: 1;
    }

    th,
    td {
      border-bottom: 1px solid #e5e7eb;
      padding: 8px 10px;
      vertical-align: middle;
      text-align: left;
    }

    th {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: #4b5563;
      white-space: nowrap;
    }

    tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    tbody tr:hover {
      background: #eef2ff;
    }

    td {
      color: #111827;
    }

    /* Status rows: no fill colors — keep zebra (white + cool grey) */
    tr.pending,
    tr.projected,
    tr.confirmed,
    tr.corrected,
    tr.rejected,
    tr.removed{
      background: transparent;
    }

    tr.selected {
      outline: 2px solid #2563eb;
    }
    .status-pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 500;
      text-transform: capitalize;
      border: 1px solid transparent;
    }

    .status-pill.pending {
      background: #fffbeb;
      color: #92400e;
      border-color: #fed7aa;
    }

    .status-pill.confirmed {
      background: #ecfdf3;
      color: #166534;
      border-color: #bbf7d0;
    }

    .status-pill.corrected {
      background: #e0f2fe;
      color: #075985;
      border-color: #bae6fd;
    }

    .status-pill.rejected {
      background: #fef2f2;
      color: #991b1b;
      border-color: #fecaca;
    }

    .status-pill.removed {
      background: #e5e7eb;
      color: #374151;
      border-color: #d1d5db;
    }

    .note-body {
      flex: 1;
      padding: 12px 16px;
      overflow: auto;
      background: #ffffff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      font-size: 12px;
    }
    .note-entry {
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px dashed #e5e7eb;
    }
    .note-entry:last-child {
      border-bottom: none;
    }
    .note-entry-header {
      font-weight: 600;
      margin-bottom: 4px;
      color: #111827;
    }
    .note-entry-body {
      color: #4b5563;
    }
    
    /* NEW: note header row with created_at + delete */
    .note-entry-header-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .note-entry-header-left{
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .note-entry-header-right{
      display:inline-flex;
      align-items:center;
      gap:8px;
      flex: 0 0 auto;
    }
    .note-created-at{
      font-size:11px;
      color:#6b7280;
      font-weight:600;
      white-space:nowrap;
    }
    /* NOTE delete icon — no button box, icon-only */
    .note-mini-btn{
      border:none;
      background:transparent;
      width:auto;
      height:auto;
      padding:0;
      margin:0;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }

    .note-mini-btn:hover{
      opacity:0.65;   /* subtle hover, no box */
    }

    .note-mini-btn svg{
      width:16px;
      height:16px;
      color: rgba(13,59,102,0.78);
    }

    /* NEW: keyword highlight */
    .kw-hl {
      background: #A8E6CF;
      padding: 0 2px;
      border-radius: 4px;
    }

    /* NEW: bell icon button in note card header */
    .note-tools {
      margin-left: auto;
      display: inline-flex;
      gap: 8px;
      align-items: center;
    }
    .icon-btn {
      width: 40px;                 /* ← change me */
      height: 40px;                /* ← change me */
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
      overflow: hidden;            /* keeps it clean if icon is large */
    }
    .icon-btn:hover { background: #f9fafb; }

    .icon-btn.on {
      border-color: #A8E6CF;
      box-shadow: 0 0 0 3px rgba(168, 230, 207, 0.28);
    }

    .icon-btn .bell {
      width: 50%;                  /* ← change me (icon size inside box) */
      height: 50%;                 /* ← change me */
      display: block;
      color: #9ca3af;
    }
    .icon-btn.on .bell {
      color: #A8E6CF;      /* mint when checked */
    }

    /* NEW: subtle list icon */
    .notif-dot {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
      margin-left: 6px;
    }
    .notif-dot svg { width: 12px; height: 12px; color: #A8E6CF; }

    .note-meta {
      padding: 10px 16px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 12px;
      background: #f9fafb;
      color: #4b5563;
    }
    .note-meta div:first-child {
      font-weight: 600;
      color: #111827;
    }
    .note-meta div {
      margin-bottom: 2px;
    }

    /* New: emailed badge styling */
    .email-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 500;
      border: 1px solid #d1d5db;
    }
    .email-badge.sent {
      background: #ecfdf3;
      color: #166534;
      border-color: #bbf7d0;
    }
    .email-badge.not-sent {
      background: #fef2f2;
      color: #991b1b;
      border-color: #fecaca;
    }

    .note-footer {
      padding: 8px 12px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      gap: 4px;
      background: #ffffff;
    }

    .note-footer textarea {
      width: 100%;
      min-height: 40px;
      resize: vertical;
    }
    .flex-row {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .message {
      font-size: 11px;
      color: #4b5563;
    }
    .message strong {
      color: #111827;
    }
    
    /* =========================================================
       EVOLV — Palette A (Main Page Overhaul)
       NOTE: Scoped to header/main/panels/table only.
             Modals keep their existing styling.
       ========================================================= */

    :root{
      --navy:#0D3B66;
      --mint:#A8E6CF;
      --sky:#4DA8DA; /* micro accent only */
      --cool:#F5F7FA;

      --surface:#ffffff;
      --text:#0f172a;
      --muted:#55657f;

      --line: rgba(13,59,102,.14);
      --line-strong: rgba(13,59,102,.22);

      --shadow: 0 10px 28px rgba(0,0,0,.08);
      --shadow-soft: 0 8px 18px rgba(13,59,102,.12);

      --r-xl:18px;
      --r-lg:16px;
      --r-md:12px;
      --r-sm:10px;

      --ring: 0 0 0 3px rgba(168,230,207,.50);
      --ring2: 0 0 0 4px rgba(168,230,207,.35);
    }

    /* Page background */
    body{
      background:
        radial-gradient(900px 520px at 10% 0%, rgba(77,168,218,.10), transparent 55%),
        radial-gradient(900px 520px at 95% 12%, rgba(168,230,207,.10), transparent 55%),
        var(--cool);
      color: var(--text);
    }

    /* Header becomes Evolv “glass card” (keep your same markup + JS) */
    header{
      position: sticky;
      top: 12px;
      z-index: 50;
      margin: 12px 16px 0;
      padding: 14px 16px;
      border-radius: var(--r-xl);
      border: 1px solid var(--line);
      background: rgba(255,255,255,.78);
      backdrop-filter: blur(6px);
      box-shadow: var(--shadow);
      color: var(--text);
    }

    header h1{
      color: var(--navy);
      font-size: 18px;
      font-weight: 900;
      letter-spacing: .2px;
    }

    /* Right side chips */
    .header-status{
      font-size: 12px;
      font-weight: 900;
      color: rgba(13,59,102,.90);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line-strong);
      background: rgba(13,59,102,.04);
      white-space: nowrap;
    }

    /* Icon buttons (Email Log / Settings) */
    .icon-btn{
      display:inline-flex; align-items:center; justify-content:center;
      width:42px; height:38px;
      border-radius:12px;
      border:1px solid var(--line-strong);
      background:#fff;
      cursor:pointer;
      transition: box-shadow .15s ease, border-color .15s ease, transform .15s ease;
      color: var(--navy);
    }
    .icon-btn:hover{
      border-color: rgba(168,230,207,.9);
      box-shadow: var(--ring2);
      transform: translateY(-1px);
    }
    .icon-btn:active{ transform: translateY(0px); }

    /* Make your header <a> links look like icon buttons */
    /* Keep header links as links, but allow icon-btn to control the box */
    a.email-link, a.admin-link{
      color:inherit;
      text-decoration:none;
    }

    /* Layout: keep your grid, but use Evolv spacing */
    main{
      padding: 16px;
      gap: 16px;
      height: calc(100vh - 110px); /* header is taller now */
    }

    /* Panels become Evolv cards */
    .panel{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.84);
      backdrop-filter: blur(4px);
      border-radius: var(--r-xl);
      box-shadow: var(--shadow);
    }

    .panel-header{
      border-bottom: 1px solid rgba(13,59,102,.10);
      background: linear-gradient(180deg, rgba(13,59,102,.06), rgba(255,255,255,0));
      padding: 12px 14px;
    }

    .panel-header h2{
      margin: 0;
      color: var(--navy);
      font-size: 15px;
      font-weight: 900;
      letter-spacing: .2px;
    }

    /* Filters + labels */
    .filters{
      gap: 12px;
      align-items: end;
      font-size: 12px;
    }
    .filters label,
    .note-footer label,
    .panel-header label{
      display:block;
      font-size:12px;
      color:#374151;
      margin:0 0 2px; /* tighter */
      font-weight:900;
      text-transform:none;
      letter-spacing:0;
    }

    /* remove the extra line-gap created by the <br /> after labels in filters */
    .filters br{ display:none; }

    /* Evolv inputs/selects for MAIN page (modals override later anyway) */
    input[type="text"],
    input[type="date"],
    input[type="number"],
    input[type="datetime-local"],
    select,
    textarea{
      padding: 10px 12px;
      font-size: 14px;
      border-radius: 12px;
      border: 1px solid rgba(13,59,102,.18);
      background:#fff;
      outline:none;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(168,230,207,.95);
      box-shadow: var(--ring);
    }

    /* Buttons (MAIN page only) — use these classes in the HTML edits below */
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      border-radius:12px; padding:10px 14px;
      border:1px solid var(--line-strong);
      background:#fff; color:var(--navy);
      font-weight:900; font-size:13px;
      cursor:pointer;
      transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease, background .15s ease, color .15s ease;
    }
    .btn:hover{ border-color: rgba(168,230,207,.9); box-shadow: var(--ring2); transform: translateY(-1px); }
    .btn:active{ transform: translateY(0px); }
    .btn-primary{ background: var(--navy); border-color: rgba(13,59,102,.95); color:#fff; box-shadow: var(--shadow-soft); }
    .btn-primary:hover{ background:#0b3357; border-color:#0b3357; box-shadow: 0 10px 26px rgba(13,59,102,.18); }
    .btn-small{ padding:8px 12px; border-radius:10px; font-size:12px; }

    /* Message text */
    .message{ color: var(--muted); font-size: 12px; font-weight: 800; }

    /* Table wrapper becomes Evolv */
    .table-wrapper{
      border-radius: 16px;
      border: 1px solid rgba(13,59,102,.14);
      background:#fff;
      overflow:auto;
    }
    thead{
      background: rgba(13,59,102,.05);
    }
    th{
      font-size:10px;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:.09em;
      color:#4b5563;
      border-bottom:1px solid rgba(13,59,102,.12);
      white-space:nowrap;
    }
    td{
      border-bottom:1px solid rgba(13,59,102,.10);
      color:#111827;
      vertical-align:middle;
    }
    tbody tr:nth-child(even){ background: rgba(13,59,102,.02); }
    tbody tr:hover{ background: rgba(168,230,207,.18); }

    /* Status pill becomes subtle + navy-first */
    .status-pill{
      display:inline-flex;
      align-items:center;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 900;
      border: 1px solid rgba(13,59,102,.16);
      background: rgba(13,59,102,.04);
      color: rgba(13,59,102,.92);
      text-transform: capitalize;
      letter-spacing: .02em;
    }

    /* Selected row uses mint outline (instead of bright blue) */
    tr.selected{
      outline: 2px solid rgba(168,230,207,.95);
    }

    /* Status rows: do NOT tint rows (keep zebra only) */
    tr.pending,
    tr.projected,
    tr.confirmed,
    tr.corrected,
    tr.rejected,
    tr.removed{
      background: transparent !important;
    }

    /* Note panel area */
    .note-body{ background:#fff; }

    /* Keep your notif dot, but make it micro-accent (sky) */
    .notif-dot svg{ color: var(--sky); }

  </style>
</head>
<body>
  <header>
    <h1>SNF Admissions – Audit & Notifications</h1>

    <div class="header-right">
      <div id="universal-pin-status-top" class="header-status">Universal PIN: …</div>
      <div id="last-processed-status-top" class="header-status">Last API: …</div>
      <div id="admin-token-status-top" class="header-status">Admin Token: …</div>

      <!-- Email log link -->
      <a href="#"
         class="email-link icon-btn"
         aria-label="Open Email Log"
         title="Email Log"
         onclick="openEmailLogModal(); return false;">
        <!-- mail icon (SVG) -->
        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
          <path d="M4 6h16v12H4V6z" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
          <path d="M4 7l8 6 8-6" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
        </svg>
      </a>

      <!-- Settings link -->
      <a href="#"
         class="admin-link icon-btn"
         aria-label="Open Settings"
         title="Settings"
         onclick="openSettingsModal(); return false;">
        <!-- lock icon (SVG) -->
        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
          <path d="M7 10V8a5 5 0 0 1 10 0v2m-9 0h8a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2v-6a2 2 0 0 1 2-2z"
                fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </a>
    </div>
  </header>

  <main>
    <!-- Left panel: admissions list -->
    <section class="panel">
      <div class="panel-header">
        <h2>Upcoming SNF admissions</h2>
        <div class="filters" style="display:none;"></div>
      </div>
      <div class="panel-header" style="border-top:1px solid #e5e7eb; justify-content:space-between;">
        <div class="flex-row" style="flex:1;">
          <button class="btn btn-primary btn-small" onclick="sendEmails(false)">Send Email</button>
          <button class="btn btn-small" onclick="sendEmails(true)">Test email</button>
          <input id="test-email-to" type="text" placeholder="test@example.com (for test only)" style="width:180px;" />
        </div>

        <div class="flex-row" style="gap:8px;">
          <!-- Load (icon button) -->
          <button class="icon-btn" title="Load" aria-label="Load" onclick="loadAdmissions()">
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
              <path d="M21 12a9 9 0 1 1-2.6-6.4" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
              <path d="M21 3v6h-6" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>

          <!-- Filter (icon button) -->
          <button class="icon-btn" title="Filters" aria-label="Filters" onclick="openFiltersModal()">
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
              <path d="M4 6h16" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
              <path d="M7 12h10" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
              <path d="M10 18h4" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
      </div>

      <div class="panel-header" style="border-top:0; padding-top:6px;">
        <div id="list-message" class="message"></div>
      </div>
      <div class="table-wrapper">
        <table id="snf-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Patient</th>
              <th>From (Hospital)</th>
              <th>Facility (AI)</th>
              <th>Effective date</th>
              <th>AI conf</th>
              <th>Status</th>
              <th>Emailed</th>
              <th>Last Updated</th>
            </tr>
          </thead>
          <tbody id="snf-body">
            <!-- rows injected via JS -->
          </tbody>
        </table>
      </div>
    </section>

    <!-- Right panel: note viewer + edit form -->
    <section class="panel" id="note-panel">
      <div class="panel-header">
        <h2>Case Management Note</h2>

        <div class="note-tools">
          <button class="icon-btn" id="notif-btn" title="Notification details" onclick="openNotifModal()">
            <!-- bell icon (SVG) -->
            <svg class="bell" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 22a2 2 0 0 0 2-2H10a2 2 0 0 0 2 2Z" stroke="currentColor" stroke-width="2"/>
              <path d="M18 16v-5a6 6 0 1 0-12 0v5l-2 2h16l-2-2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            </svg>
          </button>

          <div id="note-header-summary" class="message"></div>
        </div>
      </div>
      <div class="note-meta" id="note-meta">
        <div>Select a row to load the note.</div>
      </div>
      <div class="note-body" id="note-text">
        <!-- Raw note text -->
      </div>
      <div class="note-footer">
        <div class="flex-row">
          <label for="edit-status">Status</label>
          <select id="edit-status">
            <option value="pending">Pending</option>
            <option value="projected">Projected</option>
            <option value="confirmed">Confirmed</option>
            <option value="corrected">Corrected</option>
            <option value="rejected">Rejected</option>
            <option value="removed">Removed</option>
          </select>

          <label for="edit-disposition">Disposition</label>
          <select id="edit-disposition">
            <option value="">(none)</option>
            <option value="SNF">SNF</option>
            <option value="Home Health">Home Health</option>
            <option value="Home Self-care">Home Self-care</option>
            <option value="IRF">IRF</option>
            <option value="LTACH">LTACH</option>
            <option value="Other">Other</option>
            <option value="Unknown">Unknown</option>
          </select>

          <label for="edit-date">DC Date</label>
          <input id="edit-date" type="date" />
        </div>
        <div>
          <label for="edit-facility-select">Facility</label>
          <select id="edit-facility-select" style="width:100%;">
            <option value="">(none)</option>
          </select>
        </div>
        <div>
          <label for="edit-comments">Review comments</label>
          <textarea id="edit-comments" placeholder="Notes on why SNF / corrections, etc."></textarea>
        </div>
        <div class="flex-row">
          <button class="btn btn-primary btn-small" onclick="saveCurrent()">Save</button>
          <span id="note-message" class="message"></span>
        </div>
      </div>
    </section>
      <!-- Settings modal (styled like Facility modal) -->
      <div id="settings-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="settings-modal-title">
        <div class="modal-card">
          <div class="modal-head">
            <div>
              <div id="settings-modal-title" class="modal-title">Settings</div>
              <div class="modal-sub">Admin token, universal PIN, and keyword highlighting.</div>
            </div>
            <button class="modal-x" onclick="closeSettingsModal()" aria-label="Close">✕</button>
          </div>

          <div class="modal-body">
            <!-- Admin token -->
            <div style="border:1px solid #e5e7eb; border-radius:14px; padding:12px; background:#fafafa;">
              <div style="font-weight:800; color:#111827; margin-bottom:8px;">Admin token</div>
              <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                <input id="admin-token-input" type="password" placeholder="Paste ADMIN_TOKEN" style="width:320px;" />
                <button class="small" onclick="saveAdminToken()">Save</button>
                <span id="token-status" class="message"></span>
              </div>
            </div>

            <!-- Last processed API -->
            <div style="border:1px solid #e5e7eb; border-radius:14px; padding:12px; background:#fafafa; margin-top:12px;">
              <div style="font-weight:800; color:#111827;">Last processed API</div>
              <div id="last-processed-status-modal" style="font-size:12px; color:#6b7280; margin-top:2px;">Last API: …</div>
            </div>

            <!-- Universal PIN -->
            <div style="border:1px solid #e5e7eb; border-radius:14px; padding:12px; background:#fafafa; margin-top:12px;">
              <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                <div>
                  <div style="font-weight:800; color:#111827;">Universal PIN (fallback)</div>
                  <div id="universal-pin-status-modal" style="font-size:12px; color:#6b7280; margin-top:2px;">Universal PIN: …</div>
                </div>
                <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                  <input id="universal-pin" type="password" placeholder="Set universal PIN" style="width:220px;" />
                  <button class="small" onclick="saveUniversalPin()">Save</button>
                  <button class="small" onclick="clearUniversalPin()">Clear</button>
                </div>
              </div>
            </div>

            <!-- Highlight Keywords -->
            <div style="border:1px solid #e5e7eb; border-radius:14px; padding:12px; background:#fafafa; margin-top:12px;">
              <div style="font-weight:800; color:#111827; margin-bottom:6px;">Highlighted keywords</div>
              <div style="font-size:12px; color:#6b7280; margin-bottom:8px;">
                One per line. These will be highlighted in Case Management Notes with mint.
              </div>
              <textarea id="kw-list" style="width:100%; min-height:90px;"
                        placeholder="denied&#10;appeal&#10;peer to peer&#10;auth"></textarea>
              <div style="display:flex; gap:8px; margin-top:8px; align-items:center;">
                <button class="small" onclick="saveKeywords()">Save keywords</button>
                <span id="kw-status" class="message"></span>
              </div>
            </div>

            <!-- Global recompute -->
            <div style="border:1px solid #e5e7eb; border-radius:14px; padding:12px; background:#fafafa; margin-top:12px;">
              <div style="font-weight:800; color:#111827; margin-bottom:6px;">Global recompute</div>
              <div style="font-size:12px; color:#6b7280; margin-bottom:10px;">
                Re-runs SNF AI using only non-ignored notes. Use this after removing notes if you want every row refreshed.
              </div>
              <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                <button class="btn btn-primary btn-small" onclick="globalRecomputeSnfAi()">Recompute SNF AI (All)</button>
                <span id="global-recompute-status" class="message"></span>
              </div>
            </div>

            <!-- Facilities -->
            <div style="border:1px solid #e5e7eb; border-radius:14px; padding:12px; background:#fafafa; margin-top:12px;">
              <div style="font-weight:800; color:#111827; margin-bottom:8px;">SNF facilities</div>

              <label for="settings-facility-select" style="margin-top:0;">Facility</label>
              <select id="settings-facility-select">
                <option value="">(Select a facility to edit)</option>
              </select>

              <div style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;">
                <button class="small" onclick="openFacilityModal('add')">Add facility</button>
                <button class="small" onclick="openFacilityModal('edit')">Edit selected</button>
              </div>

              <div style="font-size:12px; color:#6b7280; margin-top:8px;">
                Tip: choose a facility here, then click <strong>Edit selected</strong>.
              </div>
            </div>
          </div>

          <div class="modal-foot">
            <button class="btn-lite" onclick="closeSettingsModal()">Close</button>
          </div>
        </div>
      </div>

      <!-- Email Log modal (styled like Settings modal) -->
      <div id="email-log-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="email-log-modal-title">
        <div class="modal-card" style="width:min(980px,100%);">
          <div class="modal-head">
            <div>
              <div id="email-log-modal-title" class="modal-title">Email Log</div>
              <div class="modal-sub">Sent emails + access/open log (facility vs universal PIN).</div>
            </div>
            <button class="modal-x" onclick="closeEmailLogModal()" aria-label="Close">✕</button>
          </div>

          <div class="modal-body" style="overflow:hidden;">
            <div class="email-log-wrap">
              <!-- Left: emails -->
              <div class="email-log-card">
                <div class="email-log-card-head">
                  <div class="email-log-card-title">Sent emails</div>
                  <span id="email-log-left-status" class="message"></span>
                </div>
                <div id="email-log-list" class="email-log-scroll"></div>
              </div>

              <!-- Right: opens -->
              <div class="email-log-card">
                <div class="email-log-card-head">
                  <div class="email-log-card-title">Opens / Access log</div>
                  <span id="email-log-right-status" class="message"></span>
                </div>
                <div id="email-log-opens" class="email-log-scroll">
                  <div class="message">Select an email on the left.</div>
                </div>
              </div>
            </div>
          </div>

          <div class="modal-foot">
            <button class="btn-lite" onclick="closeEmailLogModal()">Close</button>
          </div>
        </div>
      </div>

      <!-- Filters modal -->
      <div id="filters-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="filters-modal-title">
        <div class="modal-card" style="width:min(860px,100%);">
          <div class="modal-head">
            <div>
              <div id="filters-modal-title" class="modal-title">Filters</div>
              <div class="modal-sub">Adjust filters for the SNF Admissions table.</div>
            </div>
            <button class="modal-x" onclick="closeFiltersModal()" aria-label="Close">✕</button>
          </div>

          <div class="modal-body">
            <div class="grid2">
              <div>
                <label for="filter-date">Active Date</label>
                <input id="filter-date" type="date" />
              </div>

              <div>
                <label for="filter-days">Days ahead</label>
                <input id="filter-days" type="number" value="0" min="0" max="30" />
              </div>
            </div>

            <div class="grid2" style="margin-top:10px;">
              <div>
                <label for="filter-status">Status</label>
                <select id="filter-status">
                  <option value="pending">Pending</option>
                  <option value="projected">Projected</option>
                  <option value="confirmed">Confirmed</option>
                  <option value="corrected">Corrected</option>
                  <option value="rejected">Rejected</option>
                  <option value="removed">Removed</option>
                  <option value="all">All</option>
                </select>
              </div>

              <div>
                <label for="filter-facility">SNF facility</label>
                <select id="filter-facility">
                  <option value="">(All facilities)</option>
                </select>
              </div>
            </div>

            <div class="grid2" style="margin-top:10px;">
              <div>
                <label for="sort-by">Sort by</label>
                <select id="sort-by">
                  <option value="">(none)</option>
                  <option value="patient">Patient</option>
                  <option value="facility">Facility</option>
                </select>
              </div>

              <div>
                <label for="sort-dir">Direction</label>
                <select id="sort-dir">
                  <option value="asc">A → Z</option>
                  <option value="desc">Z → A</option>
                </select>
              </div>
            </div>

            <div style="margin-top:10px;">
              <label for="filter-notified">Notified</label>
              <select id="filter-notified">
                <option value="">All</option>
                <option value="1">Notified only</option>
              </select>
            </div>
          </div>

          <div class="modal-foot" style="justify-content:center;">
            <button class="btn-lite" onclick="closeFiltersModal()">Cancel</button>
            <button class="btn-primary" onclick="applyFiltersAndLoad()">Apply &amp; Load</button>
          </div>
        </div>
      </div>

      <!-- Notification modal (styled like Facility modal) -->
      <div id="notif-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="notif-modal-title">
        <div class="modal-card" style="width:min(780px,100%);">
          <div class="modal-head">
            <div>
              <div id="notif-modal-title" class="modal-title">Notification</div>
              <div class="modal-sub">Capture hospital notification details for this admission.</div>
            </div>
            <button class="modal-x" onclick="closeNotifModal()" aria-label="Close">✕</button>
          </div>

          <div class="modal-body">
            <div class="nm-toggle-row" style="margin-top:0;">
              <!-- keep the checkbox in the DOM (hidden) so your existing saveNotif() logic still works -->
              <input id="nm-checked" type="checkbox" onchange="onNotifCheckedChanged()" style="display:none;" />

              <button id="nm-checked-btn"
                      type="button"
                      class="toggle-pill"
                      aria-pressed="false"
                      onclick="toggleNmChecked()">
                Notified by Hospital
              </button>
            </div>

            <div class="grid2" style="margin-top:10px;">
              <div>
                <label for="nm-by">Notified by</label>
                <input id="nm-by" type="text" placeholder="Name / dept (optional)" />
              </div>

              <div>
                <label for="nm-dt">Notification date/time</label>
                <input id="nm-dt" type="datetime-local" />
              </div>
            </div>

            <label for="nm-fac">Hospital reported Facility</label>
            <input id="nm-fac" type="text" placeholder="Facility name as hospital stated" />

            <label for="nm-details">Notification details</label>
            <textarea id="nm-details" rows="4"
                      placeholder="Any details you want saved with this admission..."></textarea>

            <div class="flex-row" style="margin-top:10px;">
              <button class="btn-primary" onclick="saveNotif()">Save notification</button>
              <span id="nm-status" class="message"></span>
            </div>
          </div>
        </div>
      </div>

  </main>

  <script>
    let admissions = [];
    let selectedId = null;

    let snfFacilities = [];
    let currentRows = [];

    let highlightKeywords = []; // loaded from backend

    function escapeHtml(s) {
      return String(s || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function splitKeywords(raw) {
      return String(raw || "")
        .split(/\r?\n/)
        .map(x => x.trim())
        .filter(Boolean);
    }

    /**
     * Auto-keywords: all system facility names + aliases (NOT shown in the textarea).
     * Uses the already-loaded snfFacilities array from /admin/snf-facilities/list.
     */
    function getAutoFacilityHighlightKeywords() {
      const out = [];
      for (const f of (snfFacilities || [])) {
        const name = (f.facility_name || "").trim();
        if (name) out.push(name);

        // reuse your existing alias splitter
        splitAliases(f.aliases).forEach(a => {
          const aa = (a || "").trim();
          if (aa) out.push(aa);
        });
      }
      return out;
    }

    /**
     * Combine user-entered highlightKeywords + auto facility keywords
     * without crowding the UI field. Dedup case-insensitively.
     */
    function getEffectiveHighlightKeywords() {
      const user = Array.isArray(highlightKeywords) ? highlightKeywords : [];
      const auto = getAutoFacilityHighlightKeywords();

      const seen = new Set();
      const merged = [];

      // Keep longer tokens; skip ultra-short tokens to avoid noise
      const add = (k) => {
        const kk = String(k || "").trim();
        if (!kk) return;
        if (kk.length < 3) return; // safety: prevents highlighting "St", "of", etc.
        const key = kk.toLowerCase();
        if (seen.has(key)) return;
        seen.add(key);
        merged.push(kk);
      };

      user.forEach(add);
      auto.forEach(add);

      return merged;
    }

    function highlightText(rawText, keywords) {
      const safe = escapeHtml(rawText);

      const list = Array.isArray(keywords) ? keywords : [];
      if (!list.length) return safe;

      // longest-first prevents partial masking of longer phrases
      const sorted = [...list].sort((a, b) => b.length - a.length);

      // build a single alternation regex
      const escaped = sorted.map(k => String(k).replace(/[.*+?^${}()|[\]\\]/g, "\\$&"));

      const re = new RegExp("(" + escaped.join("|") + ")", "gi");
      return safe.replace(re, `<span class="kw-hl">$1</span>`);
    }

    function getAdminToken() {
      // Source of truth: localStorage
      return (localStorage.getItem("evolv_admin_token") || "").trim();
    }

    function updateAdminTokenStatus() {
      const hasToken = !!getAdminToken();

      const top = document.getElementById("admin-token-status-top");
      if (top) top.textContent = hasToken ? "Admin Token: Set" : "Admin Token: Not set";

      const modalStatus = document.getElementById("token-status");
      // (modalStatus is your small “Saved.” message area; we won’t overwrite it here)
    }

    async function loadLastProcessedStatus() {
      const token = getAdminToken();

      const top = document.getElementById("last-processed-status-top");
      const modal = document.getElementById("last-processed-status-modal");
      if (!token) {
        if (top) top.textContent = "Last API: (token required)";
        if (modal) modal.textContent = "Last API: (paste ADMIN_TOKEN above)";
        return;
      }

      try {
        const resp = await fetch("/admin/snf/last-processed", {
          headers: { "X-Admin-Token": token }
        });
        let data = null;
        try { data = await resp.json(); } catch (e) {}
        if (!resp.ok || (data && data.ok === false)) throw new Error("HTTP " + resp.status);

        const ts = (data && (data.last_processed_et || data.last_processed))
          ? (data.last_processed_et || data.last_processed)
          : "(none yet)";
        if (top) top.textContent = "Last API: " + ts + " ET";
        if (modal) modal.textContent = "Last API: " + ts + " ET";
      } catch (e) {
        console.error("loadLastProcessedStatus error", e);
        if (top) top.textContent = "Last API: (error)";
        if (modal) modal.textContent = "Last API: (error)";
      }
    }

    function saveAdminToken() {
      const input = document.getElementById("admin-token-input");
      const token = (input?.value || "").trim();

      if (token) {
        localStorage.setItem("evolv_admin_token", token);
        document.getElementById("token-status").textContent = "Saved.";
      } else {
        localStorage.removeItem("evolv_admin_token");
        document.getElementById("token-status").textContent = "Cleared.";
      }

      // Keep UI in sync everywhere
      updateAdminTokenStatus();
      loadLastProcessedStatus();

      // Refresh SNF facility dropdowns using the new/cleared token
      loadSnfFacilities();

      setTimeout(() => {
        document.getElementById("token-status").textContent = "";
      }, 2000);
    }

    function initToken() {
      const saved = localStorage.getItem("evolv_admin_token") || "";

      // Populate ONLY the Settings modal field
      const input = document.getElementById("admin-token-input");
      if (input) input.value = saved;

      // Update top-bar status text
      updateAdminTokenStatus();
      loadLastProcessedStatus();
    }

    // ===============================
    // Settings modal (open/close)
    // ===============================
    function openSettingsModal() {
      const m = document.getElementById("settings-modal");
      if (m) m.classList.add("open");

      // NEW: ensure modal shows the current saved token
      const input = document.getElementById("admin-token-input");
      if (input) input.value = localStorage.getItem("evolv_admin_token") || "";

      updateAdminTokenStatus();
      loadLastProcessedStatus();

      // load keywords into textarea whenever opened
      loadKeywords();
    }

    function closeSettingsModal() {
      const m = document.getElementById("settings-modal");
      if (m) m.classList.remove("open");
    }

    // ===============================
    // Highlight keywords (load/save)
    // ===============================
    async function loadKeywords() {
      const token = getAdminToken();
      const status = document.getElementById("kw-status");
      if (status) status.textContent = "";

      // ✅ Don’t even call the API if the token is missing
      if (!token) {
        if (status) status.textContent = "Paste ADMIN_TOKEN above, then reopen Settings.";
        return;
      }

      try {
        const resp = await fetch("/admin/snf/highlight-keywords/get", {
          headers: { "X-Admin-Token": token }
        });

        if (!resp.ok) throw new Error("Failed to load keywords");
        const data = await resp.json();

        // API returns keywords as a single string; convert to list for the UI
        const list = splitKeywords(data.keywords || "");
        highlightKeywords = list;

        const ta = document.getElementById("kw-list");
        if (ta) ta.value = (list || []).join("\n");

        // refresh note body if one is selected so highlights apply immediately
        // (but don’t mark keyword LOAD as failed if only the UI refresh fails)
        try {
          if (selectedId != null) {
            const adm = admissions.find(x => x.id === selectedId);
            if (adm) renderSelectedAdmission(adm);
          }
        } catch (uiErr) {
          console.error("Post-load UI refresh error (keywords):", uiErr);
          // keep status blank because keywords DID load
        }
      } catch (e) {
        if (status) status.textContent = "Could not load keywords.";
        console.error(e);
      }
    }

    async function saveKeywords() {
      const token = getAdminToken();
      const status = document.getElementById("kw-status");
      if (status) status.textContent = "Saving…";

      // ✅ Don’t call the API if the token is missing
      if (!token) {
        if (status) status.textContent = "Paste ADMIN_TOKEN above, then try again.";
        return;
      }

      try {
        const raw = (document.getElementById("kw-list")?.value || "");
        const list = splitKeywords(raw);

        // API expects keywords as ONE string blob (newline separated)
        const keywordsBlob = list.join("\n");

        const resp = await fetch("/admin/snf/highlight-keywords/set", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Admin-Token": token
          },
          body: JSON.stringify({ keywords: keywordsBlob })
        });

        let data = null;
        try { data = await resp.json(); } catch (e) {}

        if (!resp.ok) {
          const detail = data && (data.detail || data.message);
          throw new Error("HTTP " + resp.status + (detail ? " – " + detail : ""));
        }
        if (data && data.ok === false) throw new Error(data.detail || "ok=false");

        // ✅ Save succeeded — set UI/state now
        highlightKeywords = list;
        if (status) status.textContent = "Saved.";

        // ✅ If the UI refresh fails, don’t lie and say “Save failed.”
        try {
          if (selectedId != null) {
            const adm = admissions.find(x => x.id === selectedId);
            if (adm) renderSelectedAdmission(adm);
          }
        } catch (uiErr) {
          console.error("Post-save UI refresh error (keywords):", uiErr);
        }

        setTimeout(() => { if (status) status.textContent = ""; }, 2000);
      } catch (e) {
        console.error(e);
        if (status) status.textContent = "Save failed: " + e;
      }
    }

    // ===============================
    // Global recompute SNF AI (admin)
    // ===============================
    async function globalRecomputeSnfAi() {
      const token = getAdminToken();
      const statusEl = document.getElementById("global-recompute-status");

      if (!token) {
        if (statusEl) statusEl.textContent = "Paste ADMIN_TOKEN above first.";
        return;
      }

      const ok = confirm(
        "This will recompute SNF AI for ALL admissions using only non-ignored notes.\n\nContinue?"
      );
      if (!ok) return;

      if (statusEl) statusEl.textContent = "Recomputing…";

      try {
        const resp = await fetch("/admin/snf/recompute-all", {
          method: "POST",
          headers: { "X-Admin-Token": token }
        });

        let data = null;
        try { data = await resp.json(); } catch (e) {}

        if (!resp.ok) {
          const detail = data && (data.detail || data.message);
          throw new Error("HTTP " + resp.status + (detail ? " – " + detail : ""));
        }
        if (data && data.ok === false) throw new Error(data.detail || "ok=false");

        const msg =
          `Done. Groups=${data.total_groups}, OK=${data.recomputed_ok}, Failed=${data.recomputed_failed}`;
        if (statusEl) statusEl.textContent = msg;

        // Refresh the table so Facility(AI) updates immediately
        try { await loadAdmissions(); } catch (e2) {}

        // Re-select row if user had one open
        if (selectedId != null) {
          try { await selectRow(selectedId); } catch (e3) {}
        }

        setTimeout(() => { if (statusEl) statusEl.textContent = ""; }, 4000);
      } catch (e) {
        console.error("globalRecomputeSnfAi error", e);
        if (statusEl) statusEl.textContent = "Recompute failed: " + e;
      }
    }

    // ===============================
    // Filters modal (open/close/apply)
    // ===============================

    function openFiltersModal() {
      const m = document.getElementById("filters-modal");
      if (m) m.classList.add("open");
    }

    function closeFiltersModal() {
      const m = document.getElementById("filters-modal");
      if (m) m.classList.remove("open");
    }

    function applyFiltersAndLoad() {
      closeFiltersModal();
      loadAdmissions();
    }

    // ===============================
    // Notification modal (open/close/save)
    // ===============================
    function openNotifModal() {
      const m = document.getElementById("notif-modal");
      if (m) m.classList.add("open");

      // load current selected admission fields into modal
      const adm = admissions.find(x => x.id === selectedId);
      if (!adm) return;

      document.getElementById("nm-checked").checked = !!adm.notified_by_hospital;
      document.getElementById("nm-by").value = adm.notified_by || "";
      document.getElementById("nm-dt").value = adm.notification_dt || "";
      document.getElementById("nm-fac").value = adm.hospital_reported_facility || "";
      document.getElementById("nm-details").value = adm.notification_details || "";

      onNotifCheckedChanged();
    }

    function closeNotifModal() {
      const m = document.getElementById("notif-modal");
      if (m) m.classList.remove("open");
    }

    function toggleNmChecked() {
      const cb = document.getElementById("nm-checked");
      if (!cb) return;

      cb.checked = !cb.checked;
      onNotifCheckedChanged();
    }

    function onNotifCheckedChanged() {
      const checked = document.getElementById("nm-checked").checked;

      // existing bell highlight behavior
      const btn = document.getElementById("notif-btn");
      if (btn) {
        if (checked) btn.classList.add("on");
        else btn.classList.remove("on");
      }

      // NEW: update the modal toggle button style/state
      const tbtn = document.getElementById("nm-checked-btn");
      if (tbtn) {
        tbtn.classList.toggle("active", checked);
        tbtn.setAttribute("aria-pressed", checked ? "true" : "false");
      }
    }

    async function saveNotif() {
      const status = document.getElementById("nm-status");
      if (status) status.textContent = "Saving…";

      const adm = admissions.find(x => x.id === selectedId);
      if (!adm) {
        if (status) status.textContent = "No admission selected.";
        return;
      }

      const token = getAdminToken();
      if (!token) {
        if (status) status.textContent = "Paste ADMIN_TOKEN in Settings first.";
        return;
      }
      const payload = {
        notified_by_hospital: document.getElementById("nm-checked").checked,
        notified_by: document.getElementById("nm-by").value || "",
        notification_dt: document.getElementById("nm-dt").value || "",
        hospital_reported_facility: document.getElementById("nm-fac").value || "",
        notification_details: document.getElementById("nm-details").value || ""
      };

      try {
        // IMPORTANT: the backend save endpoint is /admin/snf/update
        // and it requires status + the normal edit fields too.
        const statusVal = (document.getElementById("edit-status")?.value || adm.status || "pending");
        const dispositionVal = (document.getElementById("edit-disposition")?.value || adm.disposition || "");
        const dateVal = (document.getElementById("edit-date")?.value || adm.final_expected_transfer_date || (adm.ai_expected_transfer_date || "") || "");

        const facilitySelect = document.getElementById("edit-facility-select");
        const facilityLabel =
          facilitySelect && facilitySelect.value
            ? facilitySelect.options[facilitySelect.selectedIndex].text
            : "";

        const commentsVal = (document.getElementById("edit-comments")?.value || adm.review_comments || "");

        const resp = await fetch(`/admin/snf/update`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Admin-Token": token
          },
          body: JSON.stringify({
            // required base fields
            id: adm.id,
            status: statusVal,
            disposition: dispositionVal,
            final_expected_transfer_date: dateVal || null,
            facility_free_text: facilityLabel || "",
            review_comments: commentsVal || "",

            // notification modal fields
            notified_by_hospital: payload.notified_by_hospital,
            notified_by: payload.notified_by,
            notification_dt: payload.notification_dt,
            hospital_reported_facility: payload.hospital_reported_facility,
            notification_details: payload.notification_details
          })
        });

        let data = null;
        try { data = await resp.json(); } catch (e) {}

        if (!resp.ok) {
          const detail = data && (data.detail || data.message);
          throw new Error("HTTP " + resp.status + (detail ? " – " + detail : ""));
        }
        if (data && data.ok === false) throw new Error(data.detail || "ok=false");


        // Update local copy so the list + bell update immediately
        adm.notified_by_hospital = payload.notified_by_hospital ? 1 : 0;
        adm.notified_by = payload.notified_by;
        adm.notification_dt = payload.notification_dt;
        adm.hospital_reported_facility = payload.hospital_reported_facility;
        adm.notification_details = payload.notification_details;

        onNotifCheckedChanged();
        if (status) status.textContent = "Saved.";

        // re-render list to show subtle icon
        try {
          renderRows(currentRows);
        } catch (uiErr) {
          console.error("Post-save UI refresh error (notif):", uiErr);
          // Keep "Saved." — backend update already happened
        }

        setTimeout(() => { if (status) status.textContent = ""; }, 2000);
      } catch (e) {
        console.error(e);
        if (status) status.textContent = "Save failed.";
      }
    }


    function initDate() {
      // Default to no date selected so the backend returns all dates
      const input = document.getElementById("filter-date");
      if (input) {
        input.value = "";
      }
    }

    function getFacilityLabel(r) {
      // Use whatever you already display in the “Facility” column first (AI name or chosen facility)
      return String(r.facility_free_text || r.snf_facility_name || r.facility_ai || "").trim();
    }

    async function loadSnfFacilities() {
      const token = localStorage.getItem("evolv_admin_token") || getAdminToken();
      if (!token) {
        // No token yet; user will paste it and we can reload facilities afterward.
        return;
      }
      try {
        const resp = await fetch("/admin/snf-facilities/list", {
          headers: { "X-Admin-Token": token }
        });
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();
        if (!data.ok) throw new Error(data.detail || "ok=false");

        snfFacilities = data.items || [];

        const filterSelect = document.getElementById("filter-facility");
        if (filterSelect) {
          filterSelect.innerHTML = '<option value="">(All facilities)</option>';

          // NEW: special filter option for starred facilities
          const starredOpt = document.createElement("option");
          starredOpt.value = "__starred__";
          starredOpt.textContent = "(All Starred ★)";
          filterSelect.appendChild(starredOpt);

          const withAttending = (snfFacilities || []).filter(f => (f.attending || "").trim());
          const withoutAttending = (snfFacilities || []).filter(f => !(f.attending || "").trim());

          // Put “attending” facilities first + star them
          [...withAttending, ...withoutAttending].forEach(f => {
            const opt = document.createElement("option");
            opt.value = String(f.id);

            const name = f.facility_name || "(no name)";
            const star = (f.attending || "").trim() ? "★ " : "";
            opt.textContent = star + name;

            filterSelect.appendChild(opt);
          });
        }

        const settingsSelect = document.getElementById("settings-facility-select");
        if (settingsSelect) {
          settingsSelect.innerHTML = '<option value="">(Select a facility to edit)</option>';
          snfFacilities.forEach(f => {
            const opt = document.createElement("option");
            opt.value = String(f.id);

            let label = f.facility_name || "(no name)";
            if (f.attending) label += " – " + f.attending;

            settingsSelect.appendChild(opt);
            opt.textContent = label;
          });
        }

        const editSelect = document.getElementById("edit-facility-select");
        if (editSelect) {
          editSelect.innerHTML = '<option value="">(none)</option>';
          snfFacilities.forEach(f => {
            const opt = document.createElement("option");
            opt.value = String(f.id);
            let label = f.facility_name || "(no name)";
            if (f.attending) {
              label += " – " + f.attending;
            }
            opt.textContent = label;   // 👈 add this line
            editSelect.appendChild(opt);
          });
        }
        // If a row is open, refresh the note so facility/alias highlighting updates immediately
        try {
          if (selectedId != null) await selectRow(selectedId);
        } catch (e) {
          // non-fatal
        }

      } catch (err) {
        console.error("loadSnfFacilities error", err);
      }
    }

    function setEditFacilityByLabel(label) {
      const select = document.getElementById("edit-facility-select");
      if (!select) return;

      if (!label) {
        select.value = "";
        return;
      }

      const target = label.toLowerCase();
      let foundId = "";

      snfFacilities.forEach(f => {
        const name = (f.facility_name || "").toLowerCase();
        const aliases = (f.aliases || "").toLowerCase();
        if (foundId) return;
        if (name && (target.includes(name) || name.includes(target))) {
          foundId = String(f.id);
        } else if (aliases && aliases.split(/[,\|;]+/).some(a => target.includes(a.trim().toLowerCase()))) {
          foundId = String(f.id);
        }
      });

      select.value = foundId || "";
    }


    function formatISOToMDY(iso) {
      // Accepts "YYYY-MM-DD" (or "YYYY-MM-DDTHH:MM:SS"), returns "MM-DD-YYYY"
      if (!iso) return "";
      const m = String(iso).match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (!m) return String(iso); // if it's not ISO, leave it alone
      const [_, yyyy, mm, dd] = m;
      return `${mm}-${dd}-${yyyy}`;
    }

    function parseMDYToISO(val) {
      // Accepts:
      //  - "YYYY-MM-DD" (from <input type="date">)  ✅ return as-is
      //  - "MM-DD-YYYY" or "MM/DD/YYYY"            ✅ convert to ISO
      if (!val) return "";
      const s = String(val).trim();

      // Already ISO?
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

      const cleaned = s.replace(/\//g, "-");
      const m = cleaned.match(/^(\d{2})-(\d{2})-(\d{4})$/);
      if (!m) return "";
      const [_, mm, dd, yyyy] = m;
      return `${yyyy}-${mm}-${dd}`;
    }

    let facilityModalMode = "add";   // "add" | "edit"
    let facilityModalId = null;

    function openFacilityModal(mode) {
      const token = getAdminToken();
      if (!token) {
        showToast("Please paste your ADMIN_TOKEN first.", "error");
        return;
      }

      facilityModalMode = mode;
      facilityModalId = null;

      // Reset fields
      setFacilityModalValues({
        facility_name: "",
        attending: "",
        notes: "",
        notes2: "",
        aliases: "",
        facility_emails: "",
        pin_set: false
      });
      document.getElementById("facility-pin").value = "";
      document.getElementById("facility-clear-pin").checked = false;

      if (mode === "edit") {
        // Prefer the Settings modal dropdown for edit selection
        const settingsSelect = document.getElementById("settings-facility-select");
        const filterSelect = document.getElementById("filter-facility");

        const idVal =
          (settingsSelect && settingsSelect.value) ||
          (filterSelect && filterSelect.value) ||
          "";

        if (!idVal) {
          showToast("Pick a facility in Settings first (SNF facilities dropdown).", "error");
          return;
        }

        const fac = snfFacilities.find(f => String(f.id) === String(idVal));
        if (!fac) {
          showToast("Could not find that facility in the list.", "error");
          return;
        }

        facilityModalId = fac.id;
        setFacilityModalValues({
          facility_name: fac.facility_name || "",
          attending: fac.attending || "",
          notes: fac.notes || "",
          notes2: fac.notes2 || "",
          aliases: fac.aliases || "",
          facility_emails: fac.facility_emails || "",
          pin_set: !!fac.pin_set
        });
      }

      document.getElementById("facility-modal-title").textContent =
        mode === "add" ? "Add SNF facility" : "Edit SNF facility";

      document.getElementById("facility-modal").classList.add("open");
    }

    function closeFacilityModal() {
      document.getElementById("facility-modal").classList.remove("open");
    }

    function setFacilityModalValues(f) {
      document.getElementById("facility-name").value = f.facility_name || "";
      document.getElementById("facility-attending").value = f.attending || "";
      document.getElementById("facility-notes").value = f.notes || "";
      document.getElementById("facility-notes2").value = f.notes2 || "";
      document.getElementById("facility-aliases").value = f.aliases || "";
      document.getElementById("facility-emails").value = f.facility_emails || "";

      const pinStatus = document.getElementById("facility-pin-status");
      pinStatus.textContent = f.pin_set ? "PIN: Set" : "PIN: Not set";
    }

    async function saveFacilityFromModal() {
      const token = getAdminToken();
      if (!token) {
        showToast("Please paste your ADMIN_TOKEN first.", "error");
        return;
      }

      const name = (document.getElementById("facility-name").value || "").trim();
      if (!name) {
        showToast("Facility name is required.", "error");
        return;
      }

      const payload = {
        id: facilityModalMode === "edit" ? facilityModalId : null,
        facility_name: name,
        attending: (document.getElementById("facility-attending").value || "").trim(),
        notes: (document.getElementById("facility-notes").value || "").trim(),
        notes2: (document.getElementById("facility-notes2").value || "").trim(),
        aliases: (document.getElementById("facility-aliases").value || "").trim(),
        facility_emails: (document.getElementById("facility-emails").value || "").trim(),

        // NEW: facility PIN controls
        facility_pin: (document.getElementById("facility-pin").value || "").trim(),
        clear_pin: !!document.getElementById("facility-clear-pin").checked
      };

      // UX safety: if user checks clear_pin, ignore facility_pin
      if (payload.clear_pin) payload.facility_pin = "";

      setModalMessage("facility-modal-msg", "Saving…", "info");

      try {
        const resp = await fetch("/admin/snf-facilities/upsert", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Admin-Token": token
          },
          body: JSON.stringify(payload)
        });

        let data = null;
        try { data = await resp.json(); } catch (e) {}

        if (!resp.ok) {
          const detail = data && (data.detail || data.message);
          throw new Error("HTTP " + resp.status + (detail ? " – " + detail : ""));
        }
        if (data && data.ok === false) throw new Error(data.detail || "ok=false");

        await loadSnfFacilities();
        setModalMessage(
          "facility-modal-msg",
          facilityModalMode === "add" ? "Facility saved." : "Facility updated.",
          "success"
        );

        // Close after a beat so the user sees success
        setTimeout(() => closeFacilityModal(), 450);
      } catch (err) {
        console.error("saveFacilityFromModal error", err);
        setModalMessage("facility-modal-msg", "Error: " + err, "error");
      }
    }

    /* ------- Universal PIN editor (fallback PIN) ------- */

    async function loadUniversalPinStatus() {
      const token = getAdminToken();
      if (!token) return;

      try {
        const resp = await fetch("/admin/snf/universal-pin/get", {
          headers: { "X-Admin-Token": token }
        });
        if (!resp.ok) return;

        const data = await resp.json();
        if (!data.ok) return;

        const top = document.getElementById("universal-pin-status-top");
        if (top) top.textContent = data.pin_set ? "Universal PIN: Set" : "Universal PIN: Not set";

        const modal = document.getElementById("universal-pin-status-modal");
        if (modal) modal.textContent = data.pin_set ? "Universal PIN: Set" : "Universal PIN: Not set";
      } catch (e) {
        // silent
      }
    }

    async function saveUniversalPin() {
      const token = getAdminToken();
      if (!token) {
        showToast("Please paste your ADMIN_TOKEN first.", "error");
        return;
      }

      const pin = (document.getElementById("universal-pin").value || "").trim();
      if (!pin) {
        showToast("Enter a universal PIN (or use Clear).", "error");
        return;
      }

      try {
        const resp = await fetch("/admin/snf/universal-pin/set", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Admin-Token": token
          },
          body: JSON.stringify({ pin })
        });
        if (!resp.ok) throw new Error("HTTP " + resp.status);

        const data = await resp.json();
        if (!data.ok) throw new Error(data.detail || "ok=false");

        document.getElementById("universal-pin").value = "";
        await loadUniversalPinStatus();
        showToast("Universal PIN saved.", "success");
      } catch (err) {
        console.error("saveUniversalPin error", err);
        showToast("Error saving universal PIN: " + err, "error");
      }
    }

    async function clearUniversalPin() {
      const token = getAdminToken();
      if (!token) {
        showToast("Please paste your ADMIN_TOKEN first.", "error");
        return;
      }

      try {
        const resp = await fetch("/admin/snf/universal-pin/clear", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Admin-Token": token
          },
          body: JSON.stringify({})
        });
        if (!resp.ok) throw new Error("HTTP " + resp.status);

        const data = await resp.json();
        if (!data.ok) throw new Error(data.detail || "ok=false");

        document.getElementById("universal-pin").value = "";
        await loadUniversalPinStatus();
        showToast("Universal PIN cleared.", "success");
      } catch (err) {
        console.error("clearUniversalPin error", err);
        showToast("Error clearing universal PIN: " + err, "error");
      }
    }

    /* ------- simple toast + modal message helpers ------- */

    function setModalMessage(id, text, kind) {
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = text || "";
      el.className = "modal-msg " + (kind || "info");
    }

    function showToast(text, kind) {
      const el = document.getElementById("toast");
      el.textContent = text;
      el.className = "toast show " + (kind || "info");
      setTimeout(() => el.className = "toast", 2600);
    }

    /* ------- Email Log modal ------- */

    let emailLogItems = [];
    let emailLogSelectedId = null;

    function openEmailLogModal() {
      const modal = document.getElementById("email-log-modal");
      if (!modal) return;
      modal.classList.add("open");   // ✅ must match .modal.open CSS
      loadEmailLog();
    }

    function closeEmailLogModal() {
      const modal = document.getElementById("email-log-modal");
      if (!modal) return;
      modal.classList.remove("open"); // ✅ must match .modal.open CSS
    }

    async function loadEmailLog() {
      const token = getAdminToken();
      if (!token) {
        showToast("Please paste your ADMIN_TOKEN first.", "error");
        return;
      }

      const leftStatus = document.getElementById("email-log-left-status");
      const rightStatus = document.getElementById("email-log-right-status");
      const listEl = document.getElementById("email-log-list");
      const opensEl = document.getElementById("email-log-opens");

      if (leftStatus) leftStatus.textContent = "Loading…";
      if (rightStatus) rightStatus.textContent = "";
      if (listEl) listEl.innerHTML = "";
      if (opensEl) opensEl.innerHTML = `<div class="message">Select an email on the left.</div>`;

      try {
        const resp = await fetch("/admin/snf/email-log/list", {
          headers: { "X-Admin-Token": token }
        });
        if (!resp.ok) throw new Error("HTTP " + resp.status);

        const data = await resp.json();
        if (!data.ok) throw new Error(data.detail || "ok=false");

        emailLogItems = Array.isArray(data.items) ? data.items : [];
        emailLogSelectedId = null;

        renderEmailLogList();
        if (leftStatus) leftStatus.textContent = emailLogItems.length ? "" : "No sent emails found.";
      } catch (err) {
        console.error("loadEmailLog error", err);
        if (leftStatus) leftStatus.textContent = "Error loading.";
        showToast("Error loading email log: " + err, "error");
      }
    }

    function renderEmailLogList() {
      const listEl = document.getElementById("email-log-list");
      if (!listEl) return;

      listEl.innerHTML = "";

      emailLogItems.forEach(item => {
        const div = document.createElement("div");
        div.className = "email-item" + (String(item.secure_link_id) === String(emailLogSelectedId) ? " active" : "");

        const fac = item.snf_facility_name || "(Receiving facility)";
        const count = (item.patient_count != null) ? item.patient_count : "";
        const when = item.sent_at_local || item.sent_at || "";
        const to = item.sent_to || "";
        const openCount = (item.open_count != null) ? item.open_count : 0;

        div.innerHTML = `
          <div class="email-item-top">
            <div style="min-width:0;">
              <div class="email-fac">${escapeHtml(fac)}</div>
              <div class="email-meta">
                <div><strong>Patients:</strong> ${escapeHtml(String(count))}</div>
                <div><strong>Sent:</strong> ${escapeHtml(when)}</div>
                <div><strong>Recipients:</strong> ${escapeHtml(to)}</div>
                <div><strong>Total opens:</strong> ${escapeHtml(String(openCount))}</div>
              </div>
            </div>

            <button class="pdf-btn" title="Download PDF" onclick="event.stopPropagation(); downloadEmailLogPdf(${item.secure_link_id});">
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 3v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M8 11l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M5 21h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
          </div>
        `;

        div.onclick = () => selectEmailLogItem(item.secure_link_id);
        listEl.appendChild(div);
      });
    }

    async function selectEmailLogItem(secureLinkId) {
      emailLogSelectedId = secureLinkId;
      renderEmailLogList();

      const token = getAdminToken();
      const rightStatus = document.getElementById("email-log-right-status");
      const opensEl = document.getElementById("email-log-opens");

      if (rightStatus) rightStatus.textContent = "Loading…";
      if (opensEl) opensEl.innerHTML = "";

      try {
        const resp = await fetch(`/admin/snf/email-log/opens/${secureLinkId}`, {
          headers: { "X-Admin-Token": token }
        });
        if (!resp.ok) throw new Error("HTTP " + resp.status);

        const data = await resp.json();
        if (!data.ok) throw new Error(data.detail || "ok=false");

        const rows = Array.isArray(data.items) ? data.items : [];
        if (!rows.length) {
          if (opensEl) opensEl.innerHTML = `<div class="message">No opens yet for this email.</div>`;
          if (rightStatus) rightStatus.textContent = "";
          return;
        }

        if (opensEl) {
          opensEl.innerHTML = "";
          rows.forEach(r => {
            const pinType = (r.pin_type || "").toLowerCase() || "unknown";
            const pillClass =
              pinType === "facility" ? "facility" :
              pinType === "universal" ? "universal" :
              pinType === "default" ? "default" : "";

            const card = document.createElement("div");
            card.className = "open-row";
            card.innerHTML = `
              <div class="open-top">
                <span class="pin-pill ${pillClass}">${escapeHtml(pinType)}</span>
                <div style="font-size:11px;color:#111827;font-weight:700;">
                  ${escapeHtml((r.accessed_at_et || r.accessed_at_local || r.accessed_at || "") + " ET")}
                </div>
              </div>
              <div class="open-sub">
                <div><strong>IP:</strong> ${escapeHtml(r.ip || "")}</div>
                <div><strong>User-Agent:</strong> ${escapeHtml(r.user_agent || "")}</div>
              </div>
            `;
            opensEl.appendChild(card);
          });
        }

        if (rightStatus) rightStatus.textContent = "";
      } catch (err) {
        console.error("selectEmailLogItem error", err);
        if (rightStatus) rightStatus.textContent = "Error loading.";
        if (opensEl) opensEl.innerHTML = `<div class="message">Error loading opens: ${escapeHtml(String(err))}</div>`;
      }
    }

    async function downloadEmailLogPdf(secureLinkId) {
      const token = getAdminToken();
      if (!token) {
        showToast("Please paste your ADMIN_TOKEN first.", "error");
        return;
      }

      try {
        const resp = await fetch(`/admin/snf/email-log/pdf/${secureLinkId}`, {
          headers: { "X-Admin-Token": token }
        });
        if (!resp.ok) throw new Error("HTTP " + resp.status);

        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = `SNF_Email_${secureLinkId}.pdf`;
        document.body.appendChild(a);
        a.click();
        a.remove();

        setTimeout(() => URL.revokeObjectURL(url), 1500);
      } catch (err) {
        console.error("downloadEmailLogPdf error", err);
        showToast("Error downloading PDF: " + err, "error");
      }
    }

    // ===============================
    // Facility(AI) name resolution
    // ===============================
    function normFacilityStr(s) {
      return String(s || "")
        .toLowerCase()
        .replace(/[\.\,\(\)\[\]\{\}\-_/\\]/g, " ")
        .replace(/\s+/g, " ")
        .trim();
    }

    function splitAliases(raw) {
      return String(raw || "")
        .split(/[,\|;]+/)
        .map(a => a.trim())
        .filter(Boolean);
    }

    function resolveAiToSystemFacility(aiRaw) {
      const aiNorm = normFacilityStr(aiRaw);
      if (!aiNorm) return null;

      for (const f of (snfFacilities || [])) {
        const name = f.facility_name || "";
        const nameNorm = normFacilityStr(name);
        if (nameNorm && (aiNorm.includes(nameNorm) || nameNorm.includes(aiNorm))) {
          return f; // matched by facility_name
        }

        const aliases = splitAliases(f.aliases);
        for (const a of aliases) {
          const aNorm = normFacilityStr(a);
          if (aNorm && (aiNorm.includes(aNorm) || aNorm.includes(aiNorm))) {
            return f; // matched by alias
          }
        }
      }
      return null;
    }

    // What to display specifically in the "Facility (AI)" column
    // - If AI matches a system facility (name or alias): show system name
    // - If NO match: show raw AI text + " *" so you can spot it instantly
    function getFacilityAiDisplayName(r) {
      const aiRaw = (r.ai_snf_name_raw || "").trim();
      const match = resolveAiToSystemFacility(aiRaw);

      if (match && match.facility_name) return match.facility_name;

      if (aiRaw) return aiRaw + " *";     // 👈 AI-only marker
      return "(unknown)";
    }

    async function loadAdmissions() {
      const token = getAdminToken();
      if (!token) {
        alert("Please paste your ADMIN_TOKEN first.");
        return;
      }
      const date = document.getElementById("filter-date").value;
      const days = document.getElementById("filter-days").value || "0";
      const status = document.getElementById("filter-status").value;
      const facilityId = document.getElementById("filter-facility").value || "";

      const params = new URLSearchParams();
      if (status) params.set("status", status);
      const dateIso = parseMDYToISO(date);
      if (dateIso) params.set("for_date", dateIso);
      if (days) params.set("days_ahead", days);
      
      const notified = document.getElementById("filter-notified").value;
      if (notified) params.set("notified_only", notified);

      document.getElementById("list-message").textContent = "Loading...";
      selectedId = null;
      document.getElementById("note-meta").innerHTML = "<div>Select a row to load the note.</div>";
      document.getElementById("note-text").textContent = "";
      document.getElementById("note-message").textContent = "";
      document.getElementById("note-header-summary").textContent = "";

      try {
        const resp = await fetch(`/admin/snf/list?${params.toString()}`, {
          headers: { "X-Admin-Token": token }
        });
        if (!resp.ok) {
          throw new Error("HTTP " + resp.status);
        }
        const data = await resp.json();
        if (!data.ok) {
          throw new Error(data.detail || "Server returned ok=false");
        }
        admissions = data.items || [];

        // Client-side facility name filter using SNF Admission Facilities
        const filtered = admissions.filter(r => {
          if (!facilityId) return true;

          const rowText = normFacilityStr(
            (r.effective_facility_name || "") + " " +
            (r.final_snf_name_display || "") + " " +
            (r.ai_snf_name_raw || "")
          );

          // NEW: Starred filter
          if (facilityId === "__starred__") {
            const starredFacilities = (snfFacilities || []).filter(f => (f.attending || "").trim());
            if (!starredFacilities.length) return false;

            // include row if it matches ANY starred facility name/alias
            for (const f of starredFacilities) {
              const tokens = [];
              if (f.facility_name) tokens.push(f.facility_name);
              splitAliases(f.aliases).forEach(a => tokens.push(a));

              const hit = tokens
                .map(t => normFacilityStr(t))
                .filter(Boolean)
                .some(tn => rowText.includes(tn));

              if (hit) return true;
            }
            return false;
          }

          // Normal single-facility filter
          const fac = snfFacilities.find(f => String(f.id) === String(facilityId));
          if (!fac) return true;

          const tokens = [];
          if (fac.facility_name) tokens.push(fac.facility_name);
          splitAliases(fac.aliases).forEach(a => tokens.push(a));

          if (!tokens.length) return true;
          return tokens
            .map(t => normFacilityStr(t))
            .filter(Boolean)
            .some(tn => rowText.includes(tn));
        });


        // Apply Sort by / Direction
        const sortBy = document.getElementById("sort-by")?.value || "";
        const sortDir = document.getElementById("sort-dir")?.value || "asc";
        const dir = (sortDir === "desc") ? -1 : 1;

        if (sortBy) {
          filtered.sort((a, b) => {
            let av = "", bv = "";

            if (sortBy === "patient") {
              av = (a.patient_name || "").toLowerCase();
              bv = (b.patient_name || "").toLowerCase();
            } else if (sortBy === "facility") {
              av = (getSortFacilityLabel(a) || "").toLowerCase();
              bv = (getSortFacilityLabel(b) || "").toLowerCase();
            }

            if (av < bv) return -1 * dir;
            if (av > bv) return  1 * dir;
            return 0;
          });
        }

        currentRows = filtered;

        renderTable(filtered);
        document.getElementById("list-message").innerHTML =
          `<strong>${filtered.length}</strong> rows (from ${admissions.length} total).`;

      } catch (err) {
        console.error("loadAdmissions error", err);
        document.getElementById("list-message").textContent = "Error loading admissions: " + err;
      }
    }


    function getDisplayFacilityLabel(r) {
      // 1) Manual override always wins
      if (r.final_snf_name_display) {
        return r.final_snf_name_display;
      }

      // 2) System facility name if AI matches name or aliases
      const aiDisplay = getFacilityAiDisplayName(r);
      if (aiDisplay) {
        return aiDisplay;
      }

      // 3) Absolute fallback
      return "";
    }

    function getDisplayFacilityLabel(r) {
      // 1) Manual override always wins
      if (r.final_snf_name_display) {
        return r.final_snf_name_display;
      }

      // 2) System facility name if AI matches name or aliases
      const aiDisplay = getFacilityAiDisplayName(r);
      if (aiDisplay) {
        return aiDisplay;
      }

      // 3) Absolute fallback
      return "";
    }

    // Sort-safe facility label (don’t let the " *" change ordering)
    function getSortFacilityLabel(r) {
      const label = (getDisplayFacilityLabel(r) || "").trim();
      return label.replace(/\s*\*$/, "").trim();
    }

    function renderTable(rows) {
      const tbody = document.getElementById("snf-body");
      tbody.innerHTML = "";
      rows.forEach(r => {
        const tr = document.createElement("tr");
        tr.className = (r.status || "pending") + (r.id === selectedId ? " selected" : "");
        tr.onclick = () => selectRow(r.id);
        // Prefer the reviewer-confirmed / manual facility name if present,
        // then fall back to the facility from the DB, then AI (mapped to system facility name if possible).
        let facLabel = "";

        if (r.final_snf_name_display) {
          // Manual override from the Facility (free text) field
          facLabel = r.final_snf_name_display;
        } else {
          const facLabelParts = [];
          if (r.effective_facility_name) facLabelParts.push(r.effective_facility_name);
          if (r.effective_facility_city || r.effective_facility_state) {
            facLabelParts.push(
              `(${[r.effective_facility_city, r.effective_facility_state].filter(Boolean).join(", ")})`
            );
          }

          // NEW: use mapped AI display (system facility name if matched; else raw AI)
          const aiDisplay = getFacilityAiDisplayName(r);

          facLabel = facLabelParts.join(" ") || aiDisplay || "(unknown)";
        }


        const underName = r.visit_id
          ? `Visit ${r.visit_id}`
          : (r.patient_mrn ? `MRN ${r.patient_mrn}` : "");

        const emailed = r.emailed_at ? "Yes" : "No";

        tr.innerHTML = `
          <td>${r.id}</td>
          <td>
            <div><strong>${r.patient_name || ""}</strong></div>
            <div style="color:#6b7280;">${underName}</div>
          </td>
          <td>
            ${escapeHtml(r.hospital_name || "")}
            ${
              r.notified_by_hospital
                ? ` <span class="notif-dot" title="Notified by Hospital" aria-label="Notified by Hospital">
                      <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M12 22a2 2 0 0 0 2-2H10a2 2 0 0 0 2 2Z" stroke="currentColor" stroke-width="2"/>
                        <path d="M18 16v-5a6 6 0 1 0-12 0v5l-2 2h16l-2-2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                      </svg>
                    </span>`
                : ""
            }
          </td>
          <td>${facLabel}</td>
          <td>${formatISOToMDY(r.effective_date)}</td>
          <td>${(r.ai_confidence != null ? r.ai_confidence.toFixed(2) : "")}</td>
          <td>
            <span class="status-pill ${r.status || "pending"}">${r.status || "pending"}</span>
          </td>
          <td>${emailed}</td>
          <td>${formatISOToMDY(r.last_seen_active_date_et || r.last_seen_active_date)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function selectRow(id) {
      selectedId = id;
      const token = getAdminToken();
      if (!token) {
        alert("Please paste your ADMIN_TOKEN first.");
        return;
      }
      // Highlight
      const trs = document.querySelectorAll("#snf-body tr");
      trs.forEach(tr => {
        if (tr.firstElementChild && parseInt(tr.firstElementChild.textContent, 10) === id) {
          tr.classList.add("selected");
        } else {
          tr.classList.remove("selected");
        }
      });

      document.getElementById("note-message").textContent = "Loading note...";
      try {
        const resp = await fetch(`/admin/snf/note/${id}`, {
          headers: { "X-Admin-Token": token }
        });
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();
        if (!data.ok) throw new Error(data.detail || "ok=false");
        const adm = data.admission;
        const note = data.note;

        const visitLabel = adm.visit_id
          ? `Visit ${adm.visit_id}`
          : (adm.patient_mrn ? `MRN ${adm.patient_mrn}` : "");

        // New: emailed badge label + class
        const emailedLabel = adm.emailed_at
          ? `Emailed on ${adm.emailed_at}`
          : "Not yet emailed";
        const emailedClass = adm.emailed_at ? "sent" : "not-sent";

        const admitTag = (adm.admit_date || "").trim()
          ? ` <span style="color:#6b7280;">(Admit: ${adm.admit_date})</span>`
          : "";

        document.getElementById("note-meta").innerHTML = `
          <div><strong>${adm.patient_name || ""}</strong>${visitLabel ? " (" + visitLabel + ")" : ""}</div>
          <div>${adm.hospital_name || ""}${admitTag}</div>
          <div>AI SNF: ${adm.ai_snf_name_raw || "(none)"} | AI DC Date: ${adm.ai_expected_transfer_date || "(none)"} | AI conf: ${adm.ai_confidence != null ? adm.ai_confidence.toFixed(2) : "(n/a)"}</div>
          <div>
            <span class="email-badge ${emailedClass}">${emailedLabel}</span>
          </div>
        `;


        // Render all notes for this admission
        const noteTextEl = document.getElementById("note-text");
        noteTextEl.innerHTML = "";
        const allNotes = (data.notes && Array.isArray(data.notes) && data.notes.length) ? data.notes : [note];
        
        // Sort notes newest -> oldest
        allNotes.sort((a, b) => {
          const ad = a.note_datetime || "";
          const bd = b.note_datetime || "";
          if (ad === bd) return (b.id || 0) - (a.id || 0);
          return bd.localeCompare(ad);
        });

        allNotes.forEach(n => {
          const wrapper = document.createElement("div");
          wrapper.className = "note-entry";

          const header = document.createElement("div");
          header.className = "note-entry-header";

          const headerRow = document.createElement("div");
          headerRow.className = "note-entry-header-row";

          const left = document.createElement("div");
          left.className = "note-entry-header-left";
          const headerBits = [];
          if (n.note_datetime) headerBits.push(n.note_datetime);
          if (n.note_type) headerBits.push(n.note_type);
          if (n.note_author) headerBits.push("by " + n.note_author);
          left.textContent = headerBits.join(" – ");

          const right = document.createElement("div");
          right.className = "note-entry-header-right";

          const created = document.createElement("div");
          created.className = "note-created-at";
          const addedTs = n.created_at_et || n.created_at;
          created.textContent = addedTs ? ("Added: " + addedTs + " ET") : "";


          const delBtn = document.createElement("button");
          delBtn.className = "note-mini-btn";
          delBtn.title = "Ignore this note (hide + AI ignore)";
          delBtn.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <!-- circle -->
              <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2" />
              <!-- perfectly centered X -->
              <path d="M9 9l6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M15 9l-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          `;
          delBtn.onclick = async (ev) => {
            ev.preventDefault();
            ev.stopPropagation();
            const token = getAdminToken();
            if (!token) {
              alert("Paste ADMIN_TOKEN in Settings first.");
              return;
            }
            const ok = confirm("Ignore this note? It will be removed from the list and ignored by the AI.");
            if (!ok) return;

            try {
              const resp2 = await fetch("/admin/snf/cm-note/ignore", {
                method: "POST",
                headers: { "Content-Type": "application/json", "X-Admin-Token": token },
                body: JSON.stringify({ note_id: n.id })
              });
              let data2 = null;
              try { data2 = await resp2.json(); } catch (e) {}
              if (!resp2.ok || (data2 && data2.ok === false)) {
                throw new Error((data2 && (data2.detail || data2.message)) || ("HTTP " + resp2.status));
              }
              // NEW: recompute AI for this admission immediately after ignoring a note
              try {
                const payload3 = {
                  visit_id: (adm && adm.visit_id) ? String(adm.visit_id) : "",
                  patient_mrn: (adm && adm.patient_mrn) ? String(adm.patient_mrn) : ""
                };
                await fetch("/admin/snf/admission/recompute", {
                  method: "POST",
                  headers: { "Content-Type": "application/json", "X-Admin-Token": token },
                  body: JSON.stringify(payload3)
                });
              } catch (e3) {
                console.warn("Recompute failed (non-fatal):", e3);
              }

              if (selectedId != null) await selectRow(selectedId);
              // Optional: refresh the left list too so the facility column updates instantly
              try { await loadAdmissions(); } catch (e4) {}

            } catch (e) {
              console.error(e);
              alert("Could not ignore note: " + e);
            }
          };

          right.appendChild(created);
          right.appendChild(delBtn);

          headerRow.appendChild(left);
          headerRow.appendChild(right);

          header.appendChild(headerRow);


          const body = document.createElement("div");
          body.className = "note-entry-body";
          body.innerHTML = highlightText(n.note_text || "", getEffectiveHighlightKeywords());


          wrapper.appendChild(header);
          wrapper.appendChild(body);
          noteTextEl.appendChild(wrapper);
        });

        document.getElementById("edit-status").value = adm.status || "pending";
        document.getElementById("edit-disposition").value = adm.disposition || "";
        document.getElementById("edit-date").value = adm.final_expected_transfer_date || (adm.ai_expected_transfer_date || "");
        document.getElementById("edit-comments").value = adm.review_comments || "";

        // Decide which facility label to use to preselect the dropdown
        const facilityLabel =
          adm.final_snf_name_display ||
          adm.facility_free_text ||
          adm.ai_snf_name_raw ||
          "";
        setEditFacilityByLabel(facilityLabel);

        document.getElementById("note-header-summary").textContent = `Editing SNF record ID ${adm.id}`;
        
        /* NEW: sync bell state with the selected admission */
        const btn = document.getElementById("notif-btn");
        if (btn) {
          if (adm.notified_by_hospital) btn.classList.add("on");
          else btn.classList.remove("on");
        }
        document.getElementById("note-message").textContent = "";
      } catch (err) {
        console.error("selectRow error", err);
        document.getElementById("note-message").textContent = "Error loading note: " + err;
      }
    }

    async function saveCurrent() {
      if (!selectedId) {
        alert("Select a row first.");
        return;
      }
      const token = getAdminToken();
      if (!token) {
        alert("Please paste your ADMIN_TOKEN first.");
        return;
      }
      const status = document.getElementById("edit-status").value;
      const disposition = document.getElementById("edit-disposition").value;
      const date = document.getElementById("edit-date").value;
      const facilitySelect = document.getElementById("edit-facility-select");
      const facilityLabel =
        facilitySelect && facilitySelect.value
          ? facilitySelect.options[facilitySelect.selectedIndex].text
          : "";
      const comments = document.getElementById("edit-comments").value;

      document.getElementById("note-message").textContent = "Saving...";
      try {
        const resp = await fetch("/admin/snf/update", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Admin-Token": token
          },
          body: JSON.stringify({
            id: selectedId,
            status: status,
            disposition: disposition || "",
            final_expected_transfer_date: date || null,
            facility_free_text: facilityLabel || "",
            review_comments: comments || ""
          })
        });
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();
        if (!data.ok) throw new Error(data.detail || "ok=false");
        document.getElementById("note-message").textContent = "Saved.";
        // Reload list to refresh colors/dates
        loadAdmissions();
      } catch (err) {
        console.error("saveCurrent error", err);
        document.getElementById("note-message").textContent = "Error saving: " + err;
      }
    }

    async function sendEmails(testOnly) {
      const token = getAdminToken();
      if (!token) {
        alert("Please paste your ADMIN_TOKEN first.");
        return;
      }

      const date = document.getElementById("filter-date").value;
      const facilityId = document.getElementById("filter-facility").value;

      if (!facilityId) {
        alert("Please choose a SNF facility from the dropdown first.");
        return;
      }
      if (!currentRows.length) {
        alert("There are no admissions in the current filtered list to include.");
        return;
      }

      const testTo = document.getElementById("test-email-to").value;
      if (testOnly && !testTo) {
        alert("Enter a test email address.");
        return;
      }

      const admissionIds = currentRows.map(r => r.id);

      const payload = {
        snf_facility_id: parseInt(facilityId, 10),
        for_date: date || "",
        admission_ids: admissionIds,
        test_only: !!testOnly,
        test_email_to: testOnly ? testTo : ""
      };

      document.getElementById("list-message").textContent = "Sending email with PDF...";
      try {
        const resp = await fetch("/admin/snf/email-pdf", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Admin-Token": token
          },
          body: JSON.stringify(payload)
        });

        let data = null;
        if (!resp.ok) {
          try {
            data = await resp.json();
          } catch (e) {
            // ignore JSON parse errors
          }
          const detail = data && (data.detail || data.message);
          throw new Error("HTTP " + resp.status + (detail ? " – " + detail : ""));
        }

        data = data || await resp.json();
        if (!data.ok && data.ok !== undefined) {
          throw new Error(data.detail || "ok=false");
        }


        const msgParts = [];
        msgParts.push(testOnly ? "Test email sent." : "Email with PDF sent.");
        if (data.emails_sent != null) msgParts.push(`emails_sent=${data.emails_sent}`);
        if (data.admissions_tagged != null) msgParts.push(`admissions_tagged=${data.admissions_tagged}`);
        document.getElementById("list-message").textContent = msgParts.join(" ");

        if (!testOnly) {
          // Refresh list so emailed rows show emailed_at
          loadAdmissions();
        }
      } catch (err) {
        console.error("sendEmails error", err);
        document.getElementById("list-message").textContent = "Error sending emails: " + err;
      }
    }


    // Init on load
    window.addEventListener("DOMContentLoaded", () => {
      initToken();
      initDate();
      loadSnfFacilities();
      loadUniversalPinStatus();
      loadKeywords(); // <-- add this
    });

  </script>
  
  <!-- Toast -->
  <div id="toast" class="toast" aria-live="polite"></div>

  <!-- Facility Add/Edit Modal -->
  <div id="facility-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="facility-modal-title">
    <div class="modal-card">
      <div class="modal-head">
        <div>
          <div id="facility-modal-title" class="modal-title">Add SNF facility</div>
          <div class="modal-sub">Matches the site styling. PIN is stored securely (hash).</div>
        </div>
        <button class="modal-x" onclick="closeFacilityModal()" aria-label="Close">✕</button>
      </div>

      <div class="modal-body">
        <div id="facility-modal-msg" class="modal-msg info"></div>

        <div class="grid2">
          <div>
            <label>Facility name *</label>
            <input id="facility-name" type="text" placeholder="e.g., Luxe Rehab" />
          </div>
          <div>
            <label>Attending(s)</label>
            <input id="facility-attending" type="text" placeholder="e.g., Pandey, Ravi MD" />
          </div>
        </div>

        <label>Aliases (comma separated)</label>
        <input id="facility-aliases" type="text" placeholder="e.g., Luxe Rehab at Wellington, Luxe Wellington" />

        <label>Facility email recipients (comma separated)</label>
        <input id="facility-emails" type="text" placeholder="admissions@…, referrals@…" />

        <div class="grid2">
          <div>
            <label>Notes</label>
            <textarea id="facility-notes" rows="3" placeholder="Optional notes…"></textarea>
          </div>
          <div>
            <label>Notes2</label>
            <textarea id="facility-notes2" rows="3" placeholder="Optional notes…"></textarea>
          </div>
        </div>

        <div class="pin-row">
          <div class="pin-left">
            <label>Facility PIN</label>
            <input id="facility-pin" type="password" placeholder="Set a new PIN (leave blank to keep unchanged)" />
            <div class="pin-help">
              <span id="facility-pin-status">PIN: Not set</span>
              <span class="dot" aria-hidden="true"></span>
              <span>Stored as a hash. You can set a new one any time.</span>
            </div>
          </div>
          <div class="pin-right">
            <label>&nbsp;</label>
            <label class="checkline">
              <input id="facility-clear-pin" type="checkbox" />
              Clear facility PIN (forces universal PIN fallback)
            </label>
          </div>
        </div>
      </div>

      <div class="modal-foot">
        <button class="btn-lite" onclick="closeFacilityModal()">Cancel</button>
        <button class="btn-primary" onclick="saveFacilityFromModal()">Save</button>
      </div>
    </div>
  </div>

  <style>
    /* --- Modal / Toast styling that fits your existing clean UI --- */
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);opacity:0;pointer-events:none;
      padding:10px 12px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;box-shadow:0 10px 30px rgba(0,0,0,.12);
      font-size:13px;color:#111827;min-width:260px;max-width:560px;z-index:9999;}
    .toast.show{opacity:1;pointer-events:auto;transition:opacity .15s ease;}
    .toast.success{border-color:#bbf7d0;background:#f0fdf4;}
    .toast.error{border-color:#fecaca;background:#fef2f2;}
    .toast.info{border-color:#e5e7eb;background:#fff;}

    .modal{position:fixed;inset:0;background:rgba(17,24,39,.55);display:none;align-items:center;justify-content:center;z-index:9998;padding:18px;}
    .modal.open{display:flex;}
    .modal-card{width:min(920px,100%);background:#fff;border-radius:16px;box-shadow:0 18px 60px rgba(0,0,0,.25);overflow:hidden;border:1px solid #e5e7eb;}
    .modal-head{display:flex;align-items:flex-start;justify-content:space-between;padding:16px 18px;border-bottom:1px solid #e5e7eb;}
    .modal-title{font-size:16px;font-weight:800;color:#111827;}
    .modal-sub{margin-top:2px;font-size:12px;color:#6b7280;}
    .modal-x{border:0;background:transparent;font-size:18px;cursor:pointer;color:#6b7280;padding:4px 8px;border-radius:10px;}
    .modal-x:hover{background:#f3f4f6;}
    .modal-body{padding:16px 18px;}
    .modal-foot{display:flex;justify-content:flex-end;gap:8px;padding:14px 18px;border-top:1px solid #e5e7eb;background:#fafafa;}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media(max-width:760px){.grid2{grid-template-columns:1fr;}}

    .modal-body label{display:block;font-size:12px;font-weight:700;color:#374151;margin:10px 0 6px;}
    .modal-body input,.modal-body textarea{
      width:100%;box-sizing:border-box;border:1px solid #d1d5db;border-radius:12px;padding:10px 12px;font-size:14px;min-width:0;
    }
    .modal-body textarea{resize:vertical;}
    .modal-body input:focus,.modal-body textarea:focus{
      outline:none;border-color:#A8E6CF;box-shadow:0 0 0 3px rgba(168,230,207,.35);
    }

    .modal-msg{display:none;margin-bottom:10px;padding:10px 12px;border-radius:12px;border:1px solid #e5e7eb;font-size:13px;}
    .modal-msg.info{display:block;background:#fff;}
    .modal-msg.success{display:block;border-color:#bbf7d0;background:#f0fdf4;}
    .modal-msg.error{display:block;border-color:#fecaca;background:#fef2f2;}

    .pin-row{display:flex;gap:12px;align-items:flex-start;margin-top:6px;}
    .pin-left{flex:1;min-width:0;}
    .pin-right{width:300px;}
    @media(max-width:760px){.pin-row{flex-direction:column;}.pin-right{width:100%;}}
    .pin-help{margin-top:6px;font-size:12px;color:#6b7280;display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .pin-help .dot{width:4px;height:4px;border-radius:999px;background:#A8E6CF;display:inline-block;}
    .checkline{display:flex;align-items:center;gap:8px;font-size:13px;color:#374151;font-weight:600;margin-top:6px;}
    .nm-toggle-row{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .toggle-pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      color:#6b7280;
      font-weight:800;
      font-size:13px;
      cursor:pointer;
      user-select:none;
      line-height:1;
    }

    .toggle-pill:hover{
      background:#ffffff;
    }

    .toggle-pill.active{
      background:#ffffff;
      border-color:#A8E6CF;
      color:#A8E6CF;
      box-shadow: 0 0 0 3px rgba(168,230,207,0.25);
    }

    .btn-primary{background:#0D3B66;color:#fff;border:0;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer;}
    .btn-primary:hover{background:#0b3357;}
    .btn-lite{background:#fff;color:#111827;border:1px solid #e5e7eb;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;}
    .btn-lite:hover{background:#f9fafb;}
  </style>

  
</body>
</html>
