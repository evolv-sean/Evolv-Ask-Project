<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SNF Admissions ‚Äì Audit & Notifications</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f5f7;
      color: #111827;
      line-height: 1.5;
    }

    header {
      padding: 10px 18px;
      background: #111827;
      color: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.35);
    }

    header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.03em;
    }

    main {
      display: grid;
      grid-template-columns: 2fr 1.3fr;
      gap: 16px;
      padding: 24px 24px 32px;
      box-sizing: border-box;
    }

    .panel {
      background: #ffffff;
      border-radius: 20px;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.12);
      display: flex;
      flex-direction: column;
      border: 1px solid #e5e7eb;
      overflow: hidden;
    }

    .panel-header {
      padding: 12px 16px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      background: #f9fafb;
    }

    .panel-header h2 {
      margin: 0;
      font-size: 15px;
      font-weight: 700;
      color: #111827;
    }


    /* Make the two panels fill the viewport under the header */
    main {
      height: calc(100vh - 70px); /* adjust 70px if your header height changes */
    }

    /* Critical for nested flex scroll areas */
    .panel,
    .table-wrapper,
    #note-panel {
      min-height: 0;
    }

    /* Left table already scrolls via .table-wrapper { overflow:auto; } */

    /* Right panel: ONLY the note text area scrolls */
    #note-text {
      overflow: auto;
      flex: 1;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: flex-end;
      font-size: 12px;
    }

    label {
      font-size: 11px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.09em;
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    select,
    textarea {
      padding: 5px 8px;
      font-size: 12px;
      border: 1px solid #d1d5db;
      border-radius: 999px;
      background: #ffffff;
      box-sizing: border-box;
    }

    button {
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 4px;
      border: 1px solid #4b5563;
      background: #f9fafb;
      cursor: pointer;
    }
    button.primary {
      background: #2563eb;
      border-color: #2563eb;
      color: #f9fafb;
    }
    button.small {
      font-size: 11px;
      padding: 2px 6px;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .token-box {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
    }
    .token-box input {
      width: 180px;
    }
    .table-wrapper {
      flex: 1;
      overflow: auto;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead {
      position: sticky;
      top: 0;
      background: #f3f4ff;
      z-index: 1;
    }

    th,
    td {
      border-bottom: 1px solid #e5e7eb;
      padding: 8px 10px;
      vertical-align: middle;
      text-align: left;
    }

    th {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: #4b5563;
      white-space: nowrap;
    }

    tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    tbody tr:hover {
      background: #eef2ff;
    }

    td {
      color: #111827;
    }

    tr.pending {
      background: #fff7ed;
    }
    tr.confirmed {
      background: #ecfdf3;
    }
    tr.corrected {
      background: #e0f2fe;
    }
    tr.rejected {
      background: #fee2e2;
    }
    tr.removed {
      background: #e5e7eb;
    }
    tr.selected {
      outline: 2px solid #2563eb;
    }
    .status-pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 500;
      text-transform: capitalize;
      border: 1px solid transparent;
    }

    .status-pill.pending {
      background: #fffbeb;
      color: #92400e;
      border-color: #fed7aa;
    }

    .status-pill.confirmed {
      background: #ecfdf3;
      color: #166534;
      border-color: #bbf7d0;
    }

    .status-pill.corrected {
      background: #e0f2fe;
      color: #075985;
      border-color: #bae6fd;
    }

    .status-pill.rejected {
      background: #fef2f2;
      color: #991b1b;
      border-color: #fecaca;
    }

    .status-pill.removed {
      background: #e5e7eb;
      color: #374151;
      border-color: #d1d5db;
    }

    .note-body {
      flex: 1;
      padding: 12px 16px;
      overflow: auto;
      background: #ffffff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      font-size: 12px;
    }
    .note-entry {
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px dashed #e5e7eb;
    }
    .note-entry:last-child {
      border-bottom: none;
    }
    .note-entry-header {
      font-weight: 600;
      margin-bottom: 4px;
      color: #111827;
    }
    .note-entry-body {
      color: #4b5563;
    }
    .note-meta {
      padding: 10px 16px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 12px;
      background: #f9fafb;
      color: #4b5563;
    }
    .note-meta div:first-child {
      font-weight: 600;
      color: #111827;
    }
    .note-meta div {
      margin-bottom: 2px;
    }

    /* New: emailed badge styling */
    .email-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 500;
      border: 1px solid #d1d5db;
    }
    .email-badge.sent {
      background: #ecfdf3;
      color: #166534;
      border-color: #bbf7d0;
    }
    .email-badge.not-sent {
      background: #fef2f2;
      color: #991b1b;
      border-color: #fecaca;
    }

    .note-footer {
      padding: 8px 12px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      gap: 4px;
      background: #ffffff;
    }

    .note-footer textarea {
      width: 100%;
      min-height: 40px;
      resize: vertical;
    }
    .flex-row {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .message {
      font-size: 11px;
      color: #4b5563;
    }
    .message strong {
      color: #111827;
    }
  </style>
</head>
<body>
  <header>
    <h1>SNF Admissions ‚Äì Audit & Notifications</h1>
    <div class="token-box">
      <label for="admin-token">Admin token:</label>
      <input id="admin-token" type="password" placeholder="Paste ADMIN_TOKEN" />
      <button class="small" onclick="saveAdminToken()">Save</button>
      <span id="token-status" class="message"></span>
    </div>
  </header>

  <main>
    <!-- Left panel: admissions list -->
    <section class="panel">
      <div class="panel-header">
        <h2>Upcoming SNF admissions</h2>
        <div class="filters">
          <div>
            <label for="filter-date">Active Date</label><br />
            <input id="filter-date" type="date" />
          </div>
          <div>
            <label for="filter-date">Days ahead</label><br />
            <input id="filter-days" type="number" value="0" min="0" max="30" style="width:60px;" />
          </div>
          <div>
            <label for="filter-status">Status</label><br />
            <select id="filter-status">
              <option value="pending">Pending</option>
              <option value="confirmed">Confirmed</option>
              <option value="corrected">Corrected</option>
              <option value="rejected">Rejected</option>
              <option value="removed">Removed</option>
              <option value="all">All</option>
            </select>
          </div>
          <div>
            <label for="filter-facility">SNF facility</label><br />
            <select id="filter-facility">
              <option value="">(All facilities)</option>
            </select>
          </div>
          <div>
            <label for="sort-by">Sort by</label><br />
            <select id="sort-by">
              <option value="">(none)</option>
              <option value="patient">Patient</option>
              <option value="facility">Facility</option>
            </select>
          </div>

          <div>
            <label for="sort-dir">Direction</label><br />
            <select id="sort-dir">
              <option value="asc">A ‚Üí Z</option>
              <option value="desc">Z ‚Üí A</option>
            </select>
          </div>
          <div style="margin-top:16px; display:flex; gap:4px; flex-wrap:wrap;">
            <button class="primary small" onclick="loadAdmissions()">Load</button>
            <button class="small" onclick="addSnfFacility()">Add facility</button>
            <button class="small" onclick="editSnfFacility()">Edit facility</button>
          </div>
        </div>
      </div>
      <div class="panel-header" style="border-top:1px solid #e5e7eb;">
        <div class="flex-row">
          <button class="small" onclick="sendEmails(false)">Send emails for date</button>
          <button class="small" onclick="sendEmails(true)">Test email</button>
          <input id="test-email-to" type="text" placeholder="test@example.com (for test only)" style="width:180px;" />
        </div>
        <div id="list-message" class="message"></div>
      </div>
      <div class="table-wrapper">
        <table id="snf-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Patient</th>
              <th>From (Hospital)</th>
              <th>Facility (AI)</th>
              <th>Effective date</th>
              <th>AI conf</th>
              <th>Status</th>
              <th>Emailed</th>
              <th>Last Updated</th>
            </tr>
          </thead>
          <tbody id="snf-body">
            <!-- rows injected via JS -->
          </tbody>
        </table>
      </div>
    </section>

    <!-- Right panel: note viewer + edit form -->
    <section class="panel" id="note-panel">
      <div class="panel-header">
        <h2>Case Management Note</h2>
        <div id="note-header-summary" class="message"></div>
      </div>
      <div class="note-meta" id="note-meta">
        <div>Select a row to load the note.</div>
      </div>
      <div class="note-body" id="note-text">
        <!-- Raw note text -->
      </div>
      <div class="note-footer">
        <div class="flex-row">
          <label for="edit-status">Status</label>
          <select id="edit-status">
            <option value="pending">Pending</option>
            <option value="confirmed">Confirmed</option>
            <option value="corrected">Corrected</option>
            <option value="rejected">Rejected</option>
            <option value="removed">Removed</option>
          </select>

          <label for="edit-disposition">Disposition</label>
          <select id="edit-disposition">
            <option value="">(none)</option>
            <option value="SNF">SNF</option>
            <option value="Home Health">Home Health</option>
            <option value="Home Self-care">Home Self-care</option>
            <option value="IRF">IRF</option>
            <option value="LTACH">LTACH</option>
            <option value="Other">Other</option>
            <option value="Unknown">Unknown</option>
          </select>

          <label for="edit-date">DC Date</label>
          <input id="edit-date" type="date" />
        </div>
        <div>
          <label for="edit-facility-select">Facility</label>
          <select id="edit-facility-select" style="width:100%;">
            <option value="">(none)</option>
          </select>
        </div>
        <div>
          <label for="edit-comments">Review comments</label>
          <textarea id="edit-comments" placeholder="Notes on why SNF / corrections, etc."></textarea>
        </div>
        <div class="flex-row">
          <button class="primary small" onclick="saveCurrent()">Save</button>
          <span id="note-message" class="message"></span>
        </div>
      </div>
    </section>
  </main>

  <script>
    let admissions = [];
    let selectedId = null;

    let snfFacilities = [];
    let currentRows = [];

    function getAdminToken() {
      const input = document.getElementById("admin-token");
      return (input.value || "").trim();
    }

    function saveAdminToken() {
      const token = getAdminToken();
      if (token) {
        localStorage.setItem("evolv_admin_token", token);
        document.getElementById("token-status").textContent = "Saved.";
      } else {
        localStorage.removeItem("evolv_admin_token");
        document.getElementById("token-status").textContent = "Cleared.";
      }

      // NEW: refresh SNF facility dropdowns using the new/cleared token
      loadSnfFacilities();

      setTimeout(() => {
        document.getElementById("token-status").textContent = "";
      }, 2000);
    }


    function initToken() {
      const saved = localStorage.getItem("evolv_admin_token") || "";
      if (saved) {
        document.getElementById("admin-token").value = saved;
      }
    }

    function initDate() {
      // Default to no date selected so the backend returns all dates
      const input = document.getElementById("filter-date");
      if (input) {
        input.value = "";
      }
    }

    function getFacilityLabel(r) {
      // Use whatever you already display in the ‚ÄúFacility‚Äù column first (AI name or chosen facility)
      return String(r.facility_free_text || r.snf_facility_name || r.facility_ai || "").trim();
    }

    async function loadSnfFacilities() {
      const token = localStorage.getItem("evolv_admin_token") || getAdminToken();
      if (!token) {
        // No token yet; user will paste it and we can reload facilities afterward.
        return;
      }
      try {
        const resp = await fetch("/admin/snf-facilities/list", {
          headers: { "X-Admin-Token": token }
        });
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();
        if (!data.ok) throw new Error(data.detail || "ok=false");

        snfFacilities = data.items || [];

        const filterSelect = document.getElementById("filter-facility");
        if (filterSelect) {
          filterSelect.innerHTML = '<option value="">(All facilities)</option>';

          const withAttending = (snfFacilities || []).filter(f => (f.attending || "").trim());
          const withoutAttending = (snfFacilities || []).filter(f => !(f.attending || "").trim());

          // Put ‚Äúattending‚Äù facilities first + star them
          [...withAttending, ...withoutAttending].forEach(f => {
            const opt = document.createElement("option");
            opt.value = String(f.id);

            const name = f.facility_name || "(no name)";
            const star = (f.attending || "").trim() ? "‚òÖ " : "";
            opt.textContent = star + name;

            filterSelect.appendChild(opt);
          });
        }

        const editSelect = document.getElementById("edit-facility-select");
        if (editSelect) {
          editSelect.innerHTML = '<option value="">(none)</option>';
          snfFacilities.forEach(f => {
            const opt = document.createElement("option");
            opt.value = String(f.id);
            let label = f.facility_name || "(no name)";
            if (f.attending) {
              label += " ‚Äì " + f.attending;
            }
            opt.textContent = label;   // üëà add this line
            editSelect.appendChild(opt);
          });
        }
      } catch (err) {
        console.error("loadSnfFacilities error", err);
      }
    }

    function setEditFacilityByLabel(label) {
      const select = document.getElementById("edit-facility-select");
      if (!select) return;

      if (!label) {
        select.value = "";
        return;
      }

      const target = label.toLowerCase();
      let foundId = "";

      snfFacilities.forEach(f => {
        const name = (f.facility_name || "").toLowerCase();
        const aliases = (f.aliases || "").toLowerCase();
        if (foundId) return;
        if (name && (target.includes(name) || name.includes(target))) {
          foundId = String(f.id);
        } else if (aliases && aliases.split(/[,\|;]+/).some(a => target.includes(a.trim().toLowerCase()))) {
          foundId = String(f.id);
        }
      });

      select.value = foundId || "";
    }


    function formatISOToMDY(iso) {
      // Accepts "YYYY-MM-DD" (or "YYYY-MM-DDTHH:MM:SS"), returns "MM-DD-YYYY"
      if (!iso) return "";
      const m = String(iso).match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (!m) return String(iso); // if it's not ISO, leave it alone
      const [_, yyyy, mm, dd] = m;
      return `${mm}-${dd}-${yyyy}`;
    }

    function parseMDYToISO(val) {
      // Accepts:
      //  - "YYYY-MM-DD" (from <input type="date">)  ‚úÖ return as-is
      //  - "MM-DD-YYYY" or "MM/DD/YYYY"            ‚úÖ convert to ISO
      if (!val) return "";
      const s = String(val).trim();

      // Already ISO?
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

      const cleaned = s.replace(/\//g, "-");
      const m = cleaned.match(/^(\d{2})-(\d{2})-(\d{4})$/);
      if (!m) return "";
      const [_, mm, dd, yyyy] = m;
      return `${yyyy}-${mm}-${dd}`;
    }

    async function addSnfFacility() {
      const token = getAdminToken();
      if (!token) {
        alert("Please paste your ADMIN_TOKEN first.");
        return;
      }

      const name = prompt("SNF facility name:");
      if (!name) return;

      const attending = prompt("Attending (optional):") || "";
      const notes = prompt("Notes (optional):") || "";
      const notes2 = "";
      const aliases = prompt("Aliases (optional, comma separated):") || "";
      const facility_emails = prompt("Facility email recipients (comma separated):") || "";

      try {
        const resp = await fetch("/admin/snf-facilities/upsert", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Admin-Token": token
          },
          body: JSON.stringify({
            id: null,
            facility_name: name,
            attending,
            notes,
            notes2,
            aliases,
            facility_emails
          })
        });
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();
        if (!data.ok) throw new Error(data.detail || "ok=false");
        await loadSnfFacilities();
        alert("SNF facility saved.");
      } catch (err) {
        console.error("addSnfFacility error", err);
        alert("Error saving SNF facility: " + err);
      }
    }

    async function editSnfFacility() {
      const token = getAdminToken();
      if (!token) {
        alert("Please paste your ADMIN_TOKEN first.");
        return;
      }

      const select = document.getElementById("filter-facility");
      const idVal = select.value;
      if (!idVal) {
        alert("Pick a facility in the SNF facility dropdown first.");
        return;
      }

      const fac = snfFacilities.find(f => String(f.id) === String(idVal));
      if (!fac) {
        alert("Could not find that facility in the list.");
        return;
      }

      const name = prompt("SNF facility name:", fac.facility_name || "") || fac.facility_name || "";
      const attending = prompt("Attending (optional):", fac.attending || "") || fac.attending || "";
      const notes = prompt("Notes (optional):", fac.notes || "") || fac.notes || "";
      const notes2 = prompt("Notes2 (optional):", fac.notes2 || "") || fac.notes2 || "";
      const aliases = prompt("Aliases (optional, comma separated):", fac.aliases || "") || fac.aliases || "";
      const facility_emails = prompt("Facility email recipients (comma separated):", fac.facility_emails || "") || fac.facility_emails || "";

      try {
        const resp = await fetch("/admin/snf-facilities/upsert", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Admin-Token": token
          },
          body: JSON.stringify({
            id: fac.id,
            facility_name: name,
            attending,
            notes,
            notes2,
            aliases,
            facility_emails
          })
        });
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();
        if (!data.ok) throw new Error(data.detail || "ok=false");
        await loadSnfFacilities();
        alert("SNF facility updated.");
      } catch (err) {
        console.error("editSnfFacility error", err);
        alert("Error updating SNF facility: " + err);
      }
    }

    async function loadAdmissions() {
      const token = getAdminToken();
      if (!token) {
        alert("Please paste your ADMIN_TOKEN first.");
        return;
      }
      const date = document.getElementById("filter-date").value;
      const days = document.getElementById("filter-days").value || "0";
      const status = document.getElementById("filter-status").value;
      const facilityId = document.getElementById("filter-facility").value || "";

      const params = new URLSearchParams();
      if (status) params.set("status", status);
      const dateIso = parseMDYToISO(date);
      if (dateIso) params.set("for_date", dateIso);
      if (days) params.set("days_ahead", days);

      document.getElementById("list-message").textContent = "Loading...";
      selectedId = null;
      document.getElementById("note-meta").innerHTML = "<div>Select a row to load the note.</div>";
      document.getElementById("note-text").textContent = "";
      document.getElementById("note-message").textContent = "";
      document.getElementById("note-header-summary").textContent = "";

      try {
        const resp = await fetch(`/admin/snf/list?${params.toString()}`, {
          headers: { "X-Admin-Token": token }
        });
        if (!resp.ok) {
          throw new Error("HTTP " + resp.status);
        }
        const data = await resp.json();
        if (!data.ok) {
          throw new Error(data.detail || "Server returned ok=false");
        }
        admissions = data.items || [];

        // Client-side facility name filter using SNF Admission Facilities
        const filtered = admissions.filter(r => {
          if (!facilityId) return true;
          const fac = snfFacilities.find(f => String(f.id) === String(facilityId));
          if (!fac) return true;

          const tokens = [];
          if (fac.facility_name) tokens.push(fac.facility_name);
          if (fac.aliases) {
            fac.aliases.split(/[,\|;]+/).forEach(a => {
              if (a && a.trim()) tokens.push(a.trim());
            });
          }

          const rowText = (
            (r.effective_facility_name || "") + " " +
            (r.final_snf_name_display || "") + " " +
            (r.ai_snf_name_raw || "")
          ).toLowerCase();

          if (!tokens.length) return true;
          return tokens.some(t => rowText.includes(t.toLowerCase()));
        });

        // Apply Sort by / Direction
        const sortBy = document.getElementById("sort-by")?.value || "";
        const sortDir = document.getElementById("sort-dir")?.value || "asc";
        const dir = (sortDir === "desc") ? -1 : 1;

        if (sortBy) {
          filtered.sort((a, b) => {
            let av = "", bv = "";

            if (sortBy === "patient") {
              av = (a.patient_name || "").toLowerCase();
              bv = (b.patient_name || "").toLowerCase();
            } else if (sortBy === "facility") {
              av = (getDisplayFacilityLabel(a) || "").toLowerCase();
              bv = (getDisplayFacilityLabel(b) || "").toLowerCase();
            }

            if (av < bv) return -1 * dir;
            if (av > bv) return  1 * dir;
            return 0;
          });
        }

        currentRows = filtered;

        renderTable(filtered);
        document.getElementById("list-message").innerHTML =
          `<strong>${filtered.length}</strong> rows (from ${admissions.length} total).`;

      } catch (err) {
        console.error("loadAdmissions error", err);
        document.getElementById("list-message").textContent = "Error loading admissions: " + err;
      }
    }


    function getDisplayFacilityLabel(r) {
      if (r.final_snf_name_display) return r.final_snf_name_display;

      const parts = [];
      if (r.effective_facility_name) parts.push(r.effective_facility_name);
      if (r.effective_facility_city || r.effective_facility_state) {
        parts.push(`(${[r.effective_facility_city, r.effective_facility_state].filter(Boolean).join(", ")})`);
      }
      return parts.join(" ") || (r.ai_snf_name_raw || "");
    }


    function renderTable(rows) {
      const tbody = document.getElementById("snf-body");
      tbody.innerHTML = "";
      rows.forEach(r => {
        const tr = document.createElement("tr");
        tr.className = (r.status || "pending") + (r.id === selectedId ? " selected" : "");
        tr.onclick = () => selectRow(r.id);
        // Prefer the reviewer-confirmed / manual facility name if present,
        // then fall back to the facility from the DB, then AI raw name.
        let facLabel = "";

        if (r.final_snf_name_display) {
          // Manual override from the Facility (free text) field
          facLabel = r.final_snf_name_display;
        } else {
          const facLabelParts = [];
          if (r.effective_facility_name) facLabelParts.push(r.effective_facility_name);
          if (r.effective_facility_city || r.effective_facility_state) {
            facLabelParts.push(
              `(${[r.effective_facility_city, r.effective_facility_state].filter(Boolean).join(", ")})`
            );
          }
          facLabel = facLabelParts.join(" ") || (r.ai_snf_name_raw || "(unknown)");
        }

        const underName = r.visit_id
          ? `Visit ${r.visit_id}`
          : (r.patient_mrn ? `MRN ${r.patient_mrn}` : "");

        const emailed = r.emailed_at ? "Yes" : "No";

        tr.innerHTML = `
          <td>${r.id}</td>
          <td>
            <div><strong>${r.patient_name || ""}</strong></div>
            <div style="color:#6b7280;">${underName}</div>
          </td>
          <td>${r.hospital_name || ""}</td>
          <td>${facLabel}</td>
          <td>${formatISOToMDY(r.effective_date)}</td>
          <td>${(r.ai_confidence != null ? r.ai_confidence.toFixed(2) : "")}</td>
          <td>
            <span class="status-pill ${r.status || "pending"}">${r.status || "pending"}</span>
          </td>
          <td>${emailed}</td>
          <td>${formatISOToMDY(r.last_seen_active_date)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function selectRow(id) {
      selectedId = id;
      const token = getAdminToken();
      if (!token) {
        alert("Please paste your ADMIN_TOKEN first.");
        return;
      }
      // Highlight
      const trs = document.querySelectorAll("#snf-body tr");
      trs.forEach(tr => {
        if (tr.firstElementChild && parseInt(tr.firstElementChild.textContent, 10) === id) {
          tr.classList.add("selected");
        } else {
          tr.classList.remove("selected");
        }
      });

      document.getElementById("note-message").textContent = "Loading note...";
      try {
        const resp = await fetch(`/admin/snf/note/${id}`, {
          headers: { "X-Admin-Token": token }
        });
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();
        if (!data.ok) throw new Error(data.detail || "ok=false");
        const adm = data.admission;
        const note = data.note;

        const visitLabel = adm.visit_id
          ? `Visit ${adm.visit_id}`
          : (adm.patient_mrn ? `MRN ${adm.patient_mrn}` : "");

        // New: emailed badge label + class
        const emailedLabel = adm.emailed_at
          ? `Emailed on ${adm.emailed_at}`
          : "Not yet emailed";
        const emailedClass = adm.emailed_at ? "sent" : "not-sent";

        document.getElementById("note-meta").innerHTML = `
          <div><strong>${adm.patient_name || ""}</strong>${visitLabel ? " (" + visitLabel + ")" : ""}</div>
          <div>${adm.hospital_name || ""}</div>
          <div>AI SNF: ${adm.ai_snf_name_raw || "(none)"} | AI date: ${adm.ai_expected_transfer_date || "(none)"} | AI conf: ${adm.ai_confidence != null ? adm.ai_confidence.toFixed(2) : "(n/a)"}</div>
          <div>
            <span class="email-badge ${emailedClass}">${emailedLabel}</span>
          </div>
        `;

        // Render all notes for this admission
        const noteTextEl = document.getElementById("note-text");
        noteTextEl.innerHTML = "";
        const allNotes = (data.notes && Array.isArray(data.notes) && data.notes.length) ? data.notes : [note];
        
        // Sort notes newest -> oldest
        allNotes.sort((a, b) => {
          const ad = a.note_datetime || "";
          const bd = b.note_datetime || "";
          if (ad === bd) return (b.id || 0) - (a.id || 0);
          return bd.localeCompare(ad);
        });

        allNotes.forEach(n => {
          const wrapper = document.createElement("div");
          wrapper.className = "note-entry";

          const header = document.createElement("div");
          header.className = "note-entry-header";
          const headerBits = [];
          if (n.note_datetime) headerBits.push(n.note_datetime);
          if (n.note_type) headerBits.push(n.note_type);
          if (n.note_author) headerBits.push("by " + n.note_author);
          header.textContent = headerBits.join(" ‚Äì ");

          const body = document.createElement("div");
          body.className = "note-entry-body";
          body.textContent = n.note_text || "";

          wrapper.appendChild(header);
          wrapper.appendChild(body);
          noteTextEl.appendChild(wrapper);
        });

        document.getElementById("edit-status").value = adm.status || "pending";
        document.getElementById("edit-disposition").value = adm.disposition || "";
        document.getElementById("edit-date").value = adm.final_expected_transfer_date || (adm.ai_expected_transfer_date || "");
        document.getElementById("edit-comments").value = adm.review_comments || "";

        // Decide which facility label to use to preselect the dropdown
        const facilityLabel =
          adm.final_snf_name_display ||
          adm.facility_free_text ||
          adm.ai_snf_name_raw ||
          "";
        setEditFacilityByLabel(facilityLabel);

        document.getElementById("note-header-summary").textContent = `Editing SNF record ID ${adm.id}`;
        document.getElementById("note-message").textContent = "";
      } catch (err) {
        console.error("selectRow error", err);
        document.getElementById("note-message").textContent = "Error loading note: " + err;
      }
    }

    async function saveCurrent() {
      if (!selectedId) {
        alert("Select a row first.");
        return;
      }
      const token = getAdminToken();
      if (!token) {
        alert("Please paste your ADMIN_TOKEN first.");
        return;
      }
      const status = document.getElementById("edit-status").value;
      const disposition = document.getElementById("edit-disposition").value;
      const date = document.getElementById("edit-date").value;
      const facilitySelect = document.getElementById("edit-facility-select");
      const facilityLabel =
        facilitySelect && facilitySelect.value
          ? facilitySelect.options[facilitySelect.selectedIndex].text
          : "";
      const comments = document.getElementById("edit-comments").value;

      document.getElementById("note-message").textContent = "Saving...";
      try {
        const resp = await fetch("/admin/snf/update", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Admin-Token": token
          },
          body: JSON.stringify({
            id: selectedId,
            status: status,
            disposition: disposition || "",
            final_expected_transfer_date: date || null,
            facility_free_text: facilityLabel || "",
            review_comments: comments || ""
          })
        });
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();
        if (!data.ok) throw new Error(data.detail || "ok=false");
        document.getElementById("note-message").textContent = "Saved.";
        // Reload list to refresh colors/dates
        loadAdmissions();
      } catch (err) {
        console.error("saveCurrent error", err);
        document.getElementById("note-message").textContent = "Error saving: " + err;
      }
    }

    async function sendEmails(testOnly) {
      const token = getAdminToken();
      if (!token) {
        alert("Please paste your ADMIN_TOKEN first.");
        return;
      }

      const date = document.getElementById("filter-date").value;
      const facilityId = document.getElementById("filter-facility").value;

      if (!facilityId) {
        alert("Please choose a SNF facility from the dropdown first.");
        return;
      }
      if (!currentRows.length) {
        alert("There are no admissions in the current filtered list to include.");
        return;
      }

      const testTo = document.getElementById("test-email-to").value;
      if (testOnly && !testTo) {
        alert("Enter a test email address.");
        return;
      }

      const admissionIds = currentRows.map(r => r.id);

      const payload = {
        snf_facility_id: parseInt(facilityId, 10),
        for_date: date || "",
        admission_ids: admissionIds,
        test_only: !!testOnly,
        test_email_to: testOnly ? testTo : ""
      };

      document.getElementById("list-message").textContent = "Sending email with PDF...";
      try {
        const resp = await fetch("/admin/snf/email-pdf", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Admin-Token": token
          },
          body: JSON.stringify(payload)
        });

        let data = null;
        if (!resp.ok) {
          try {
            data = await resp.json();
          } catch (e) {
            // ignore JSON parse errors
          }
          const detail = data && (data.detail || data.message);
          throw new Error("HTTP " + resp.status + (detail ? " ‚Äì " + detail : ""));
        }

        data = data || await resp.json();
        if (!data.ok && data.ok !== undefined) {
          throw new Error(data.detail || "ok=false");
        }


        const msgParts = [];
        msgParts.push(testOnly ? "Test email sent." : "Email with PDF sent.");
        if (data.emails_sent != null) msgParts.push(`emails_sent=${data.emails_sent}`);
        if (data.admissions_tagged != null) msgParts.push(`admissions_tagged=${data.admissions_tagged}`);
        document.getElementById("list-message").textContent = msgParts.join(" ");

        if (!testOnly) {
          // Refresh list so emailed rows show emailed_at
          loadAdmissions();
        }
      } catch (err) {
        console.error("sendEmails error", err);
        document.getElementById("list-message").textContent = "Error sending emails: " + err;
      }
    }


    // Init on load
    window.addEventListener("DOMContentLoaded", () => {
      initToken();
      initDate();
      loadSnfFacilities();
      // Optionally auto-load
      // loadAdmissions();
    });
  </script>
</body>
</html>
