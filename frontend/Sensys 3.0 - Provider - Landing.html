<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sensys - Provider Workspace</title>
  <style>
    :root{
      --navy:#0D3B66;
      --mint:#A8E6CF;
      --mint-strong:#86d9ba;
      --bg:#ffffff;
      --bg-2:#F5F7FA;
      --text:#0f172a;
      --muted:#5b6b84;
      --line: rgba(13,59,102,.14);
      --shadow:0 18px 36px rgba(13,59,102,.08);
      --r-lg:20px;
      --r-md:12px;
      --sidebar-w:78px;
      --logo-offset-x:-68px;
      --logo-offset-y:-58px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    html,body{
      margin:0;
      background:
        radial-gradient(900px 320px at 50% 1%, rgba(15,23,42,.035), rgba(255,255,255,0) 80%),
        linear-gradient(180deg, #ffffff 0%, #f5f7fa 100%);
      background-repeat:no-repeat;
      background-attachment:fixed;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    .layout{
      min-height:100vh;
      display:flex;
    }
    .sidebar{
      width:var(--sidebar-w);
      background:#fff;
      border-right:1px solid rgba(13,59,102,.08);
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      padding:0 0 14px;
      position:relative;
      overflow:hidden;
    }
    .sidebar-logo{
      width:100%;
      height:92px;
      overflow:hidden;
      margin-bottom:18px;
      position:relative;
      overflow:hidden;
    }
    .sidebar-logo img{
      width:150px;
      height:150px;
      position:absolute;
      left:-6px;
      top:-6px;
      transform: translate(var(--logo-offset-x), var(--logo-offset-y));
      display:block;
      margin:0;
      overflow:visible;
    }
    .side-nav{
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:12px;
      margin-top:12px;
      margin-left: 20px;
    }
    .side-btn{
      width:42px;
      height:42px;
      border-radius:14px;
      border:0;
      background:#fff;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      color:var(--navy);
      cursor:pointer;
      transition:border-color .15s ease, box-shadow .15s ease, transform .15s ease;
    }
    .side-btn:hover{
      box-shadow:0 0 0 2px rgba(168,230,207,.35);
      transform: translateY(-1px);
    }
    .side-btn svg{
      width:35px;
      height:35px;
    }
    .side-btn .cls-1{
      stroke:currentColor;
      fill:none;
      stroke-linecap:round;
      stroke-linejoin:round;
      stroke-width:3.2px;
    }
    .side-spacer{flex:1}
    .profile-wrap{
      margin-left:20px;
      position:relative;
      overflow:hidden;
      margin-bottom:0;
    }
    .profile-menu{
      position:absolute;
      left:52px;
      bottom:0;
      background:#fff;
      border:1px solid rgba(13,59,102,.12);
      border-radius:12px;
      box-shadow:0 18px 36px rgba(13,59,102,.16);
      padding:8px;
      min-width:170px;
      display:none;
      z-index:10;
    }
    .profile-menu button{
      width:100%;
      border:0;
      background:#fff;
      text-align:left;
      padding:8px 10px 48px;
      max-height:320px;
      overflow:hidden;
      border-radius:10px;
      font-size:12px;
      font-weight:800;
      color:#111827;
      cursor:pointer;
    }
    .profile-menu button:hover{
      background:rgba(168,230,207,.18);
    }
    .page{
      min-height:100vh;
      padding:22px 28px 5px;
      max-width:1280px;
      margin:0 0 0 40px;
      display:flex;
      flex-direction:column;
      flex:1;
    }
    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      margin-bottom:6px;
    }
    .brand{
      display:flex;
      align-items:flex-start;
      gap:16px;
    }
    .brand .icon{
      margin-top: -1px;
      width:84px;
      height:84px;
      color:var(--mint-strong);
      display:inline-flex;
      align-items:flex-start;
      justify-content:center;
    }
    .brand .icon svg{width:100%;height:100%}
    .brand .icon .cls-1{
      stroke:currentColor;
      fill:none;
      stroke-linecap:round;
      stroke-linejoin:round;
      stroke-width:2.1px;
    }
    .title h1{
      margin:0 0 6px;
      font-size:40px;
      font-weight:400;
      color:var(--navy);
      letter-spacing:.2px;
    }
    .title p{
      margin:0;
      font-size:14px;
      color:var(--muted);
    }
    .logo{
      height:96px;
      width:auto;
      display:block;
      margin:0;
      overflow:visible;
      opacity:0.0;
    }
    .toolbar{
      margin-top:18px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .toolbar-wrap{
      position:sticky;
      top:0;
      z-index:5;
      background:transparent;
      padding:14px 14px 10px;
      border-radius:18px 18px 0 0;
    }
    .tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .chip{
      padding:10px 16px;
      border-radius:999px;
      border:1px solid rgba(124,109,138,.35);
      background:#fff;
      font-size:13px;
      font-weight:800;
      color:#0D3B66;
      cursor:pointer;
      user-select:none;
      transition:border-color .15s ease, box-shadow .15s ease, transform .15s ease;
    }
    .chip:hover{
      border-color:rgba(124,109,138,.6);
      box-shadow:0 10px 18px rgba(124,109,138,.12);
      transform: translateY(-1px);
    }
    .chip.on{
      background:rgba(124,109,138,.2);
      border-color:rgba(124,109,138,.9);
      color:#3d2f4a;
    }
    .search-wrap{
      display:flex;
      gap:10px;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .search{
      width:min(360px, 92vw);
      padding:12px 14px;
      border-radius:12px;
      border:1px solid rgba(13,59,102,.18);
      background:#fff;
      font-size:14px;
      outline:none;
      box-shadow:0 8px 16px rgba(13,59,102,.06);
      transition:border-color .15s ease, box-shadow .15s ease, transform .15s ease;
    }
    .search:focus{
      border-color: rgba(168,230,207,.95);
      box-shadow: 0 10px 22px rgba(13,59,102,.12);
      transform: translateY(-1px);
    }
    .btn{
      border:1px solid var(--line);
      background:#fff;
      padding:10px 14px;
      border-radius:12px;
      font-size:13px;
      font-weight:800;
      color:var(--navy);
      cursor:pointer;
      transition:border-color .15s ease, box-shadow .15s ease, transform .15s ease;
    }
    .btn:hover{
      border-color: rgba(168,230,207,.9);
      box-shadow:0 10px 18px rgba(13,59,102,.10);
      transform: translateY(-1px);
    }
    .panel{
      margin-top:10px;
      margin-bottom:0;
      background:#fff;
      border:1px solid rgba(13,59,102,.12);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:0;
      overflow:hidden;
      flex:1;
      display:flex;
      flex-direction:column;
    }
    .list{
      margin-top: 2px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:12px;
      overflow:auto;
      padding:14px 14px 12px;
      flex:1;
      max-height:calc(100vh - 232px);
      align-content:flex-start;
      grid-auto-rows:max-content;
      background:transparent;
    }
    .row{
      background:#fff;
      border:1px solid rgba(168,230,207,.55);
      border-radius:14px;
      box-shadow:none;
      padding:8px 10px 18px;
      max-height:320px;
      overflow:hidden;
      display:grid;
      grid-template-columns: minmax(0, 1fr) auto;
      grid-template-areas:
        "header actions"
        "agency actions"
        "dates actions"
        "services actions";
      grid-template-rows: auto auto auto 72px;
      row-gap:12px;
      align-items:start;
      transition:border-color .15s ease, box-shadow .15s ease, transform .15s ease;
    }
    .row:hover{
      border-color:rgba(168,230,207,.95);
      box-shadow:0 10px 18px rgba(13,59,102,.10);
      transform: translateY(-1px);
    }
    .row-header{
      grid-area:header;
      display:flex;
      gap:12px;
      align-items:center;
      min-width:0;
      min-height:78px;
    }
    .avatar{
      width:70px;
      height:70px;
      border-radius:999px;
      border:2px solid #7C6D8A;
      background:#fff;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#7C6D8A;
      flex:0 0 auto;
    }
    .avatar svg{width:55px;height:55px}
    .avatar .cls-1{
      stroke:currentColor;
      fill:none;
      stroke-linecap:round;
      stroke-linejoin:round;
      stroke-width:1.2px;
    }
    .name{
      font-size:18px;
      font-weight:800;
      color:var(--navy);
    }
    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      color:var(--muted);
      font-size:13px;
    }
    .meta b{color:#0f172a}
    .agency-name{
      grid-area:agency;
      font-size:16px;
      font-weight:700;
      color:var(--navy);
      margin-top: 6px;
    }
    .row-dates{
      grid-area:dates;
      margin-top: 6px;
      min-height:18px;
    }
    .row-actions{
      grid-area:actions;
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:center;
      align-self:start;
      margin-top:2px;
    }
    .service-pills{
      grid-area:services;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top: 8px;
      max-height:72px;
      overflow:auto;
      align-content:flex-start;
    }
    .service-pill{
      padding:6px 10px;
      border-radius:999px;
      background:rgba(168,230,207,.35);
      border:1px solid rgba(168,230,207,.7);
      color:#0D3B66;
      font-size:12px;
      font-weight:700;
    }
    .signed-meta{
      font-size:11px;
      color:var(--muted);
      margin-top:6px;
    }
    .icon-btn{
      width:42px;
      height:42px;
      border-radius:12px;
      border:1.5px solid #0D3B66;
      background:transparent;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0;
      color:#0D3B66;
      line-height:0;
    }
    .icon-btn svg{
      width:22px;
      height:22px;
      display:block;
      margin:0;
      overflow:visible;
    }
    .icon-btn svg :where(path, line, polyline, polygon, rect, circle, ellipse){
      fill:none !important;
      stroke:currentColor !important;
      stroke-linecap:round !important;
      stroke-linejoin:round !important;
      stroke-width:5px !important;
    }
    .icon-btn.esign{color:var(--mint-strong);}
    .icon-btn.edit{color:#94a3b8;}
    .icon-btn.decline{color:#C76B6B;}
    .icon-btn.disabled{
      color:#94a3b8;
      border-color:#94a3b8;
      cursor:not-allowed;
      pointer-events:none;
    }
    .icon-btn.decline svg{transform: rotate(180deg);}
    .confirm-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .confirm-modal{
      width:min(520px, 94vw);
      background:#fff;
      border:1px solid rgba(13,59,102,.12);
      border-radius:18px;
      box-shadow:0 26px 60px rgba(13,59,102,.22);
      padding:18px;
    }
    .confirm-modal h3{
      margin:0 0 8px;
      font-size:16px;
      font-weight:900;
      color:#0f172a;
    }
    .confirm-text{
      font-size:13px;
      color:#475569;
      line-height:1.5;
    }
    .confirm-actions{
      margin-top:16px;
      display:flex;
      justify-content:flex-end;
      gap:10px;
    }
    .confirm-msg{
      display:none;
      margin-top:10px;
      padding:10px;
      border-radius:12px;
      background:rgba(239,68,68,.08);
      border:1px solid rgba(239,68,68,.25);
      color:#991b1b;
      font-size:12px;
    }
    .edit-modal{
      width:min(980px, 96vw);
      background:#fff;
      border:1px solid rgba(13,59,102,.12);
      border-radius:18px;
      box-shadow:0 26px 60px rgba(13,59,102,.22);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      max-height:92vh;
    }
    .edit-header{
      background:#E6EBF2;
      border-bottom:1px solid rgba(13,59,102,.12);
      padding:12px 16px;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:12px;
    }
    .edit-header h3{
      margin:0;
      font-size:16px;
      font-weight:900;
      color:#0f172a;
    }
    .edit-body{
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:14px;
      overflow:auto;
    }
    .order-sheet{
      background:#fff;
      border:1px solid #e2e8f0;
      border-radius:18px;
      box-shadow:0 16px 40px rgba(2, 6, 23, .10);
      overflow:hidden;
      position:relative;
    }
    .order-header{
      padding:22px 26px 18px 26px;
      background: linear-gradient(180deg, #ffffff 0%, #fbfdff 60%, #f8fafc 100%);
      border-bottom:1px solid #e2e8f0;
    }
    .order-brand{
      display:flex;
      align-items:center;
      gap:14px;
    }
    .order-rx{
      width:72px;
      height:72px;
      border-radius:16px;
      background: transparent;
      border:0;
      display:flex;
      align-items:center;
      justify-content:center;
      flex:0 0 auto;
    }
    .order-rx-mark{
      width:56px;
      height:82px;
      background: var(--navy);
      -webkit-mask: url("/static/images/rx-esign.svg") no-repeat center / contain;
      mask: url("/static/images/rx-esign.svg") no-repeat center / contain;
    }
    .order-facility{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .order-facility-name{
      font-size:22px;
      font-weight:850;
      line-height:1.1;
    }
    .order-facility-meta{
      display:flex;
      gap:14px;
      font-size:13.5px;
      color:#475569;
      flex-wrap:wrap;
    }
    .order-facility-meta b{color:#0f172a}
    .order-content{
      padding:22px 26px 42px 26px;
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
    }
    .order-section-title{
      margin:0 0 10px 0;
      font-size:13px;
      letter-spacing:.12em;
      text-transform: uppercase;
      color:#475569;
    }
    .order-card{
      background:#f8fafc;
      border:1px solid #e2e8f0;
      border-radius:14px;
      padding:14px;
    }
    .order-field-row{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap:10px;
      padding:10px 0;
      border-top:1px solid rgba(226,232,240,.7);
    }
    .order-field-row:first-of-type{ border-top:none; padding-top:0; }
    .order-label{ color:#475569; font-size:13px; }
    .order-value{ font-weight:650; font-size:14px; }
    .order-block{
      background:#fff;
      border:1px solid #e2e8f0;
      border-radius:16px;
      padding:14px 16px;
    }
    .order-divider{
      height:1px;
      background:#e2e8f0;
      margin:12px 0;
      width:100%;
    }
    .order-divider.short{
      width:50%;
      margin:14px 0 10px 0;
    }
    .order-line{
      display:grid;
      grid-template-columns: 150px 1fr;
      gap:6px;
      padding:8px 0 2px 0;
    }
    .order-service-label{
      font-weight:750;
      color:#0f172a;
      padding-left:10px;
    }
    .order-service-label::after{ content: ":"; }
    .order-comments{
      border:1px solid rgba(13,59,102,.16);
      border-radius:12px;
      padding:10px 12px;
      background:#fff;
      width:100%;
      min-height:90px;
      resize:vertical;
      font-size:13px;
      color:#0f172a;
      font-family: inherit;
      outline:none;
    }
    .order-comments:focus{
      border-color: rgba(168,230,207,.95);
      box-shadow:0 10px 18px rgba(13,59,102,.10);
    }
    .order-comments.readonly{
      border-color:#fff;
      box-shadow:none;
      background:#fff;
      resize:none;
    }
    .order-sig{
      display:flex;
      align-items:baseline;
      gap:10px;
      flex-wrap:wrap;
      font-size:13px;
      color:#0f172a;
      margin-top:2px;
    }
    .order-sig .at{
      font-weight:650;
    }
    .order-doc-stamp{
      position:absolute;
      right:18px;
      bottom:14px;
      font-size:12.5px;
      color:#475569;
    }
    .order-npi{
      margin-top:6px;
      font-size:13px;
      color:#475569;
    }
    .order-npi b{ color:#0f172a; }
    .edit-actions{
      display:flex;
      justify-content:flex-end;
      gap:10px;
    }
    .edit-msg{
      display:none;
      margin-top:6px;
      padding:10px;
      border-radius:12px;
      background:rgba(239,68,68,.08);
      border:1px solid rgba(239,68,68,.25);
      color:#991b1b;
      font-size:12px;
    }
    .empty{
      text-align:center;
      color:var(--muted);
      font-size:13px;
      margin-top:30px;
    }
    @media (max-height: 950px){
      .row{max-height:320px;}
      .row-header{min-height:78px;}
      .agency-name{margin-top:6px;}
      .row-dates{margin-top:6px;}
      .service-pills{margin-top:8px;}
    }
    @media (max-width: 1280px){
      .row{max-height:320px;}
      .row-header{min-height:78px;}
      .agency-name{margin-top:6px;}
      .row-dates{margin-top:6px;}
      .service-pills{margin-top:8px;}
    }
    @media (max-width: 900px){
      .list{grid-template-columns: 1fr;}
      .row{
        grid-template-columns: 1fr;
        grid-template-areas:
          "header"
          "actions"
          "agency"
          "dates"
          "services";
      }
      .row-actions{
        flex-direction:row;
        justify-content:flex-start;
      }
      .title h1{font-size:34px}
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-logo">
        <img src="/static/images/Evolv-Health-E-Color.svg" alt="Evolv Health" onerror="this.onerror=null;this.src='Logos/Evolv-Health-E-Color.svg';" />
      </div>
      <div class="side-nav">
        <button class="side-btn" id="navHome" title="Home" aria-label="Home">
          <svg viewBox="0 0 84.28 75.71" aria-hidden="true">
            <g>
              <polygon class="cls-1" points="72.76 74.32 72.76 41.92 82.89 41.92 82.89 35.62 71 25.54 71 7.55 58.75 7.55 58.75 15.16 42.14 1.79 1.39 35.62 1.39 41.92 11.52 41.92 11.52 74.31 32.09 74.32 32.09 52.8 52.18 52.8 52.18 74.32 72.76 74.32" />
              <polyline class="cls-1" points="11.52 41.92 42.14 16.92 72.76 41.92" />
            </g>
          </svg>
        </button>
      </div>
      <div class="side-spacer"></div>
      <div class="profile-wrap">
        <button class="side-btn" id="profileBtn" title="Account" aria-label="Account">
          <svg viewBox="0 0 65.83 73.85" aria-hidden="true">
            <g>
              <g>
                <path class="cls-1" d="M64.44,73.85v-21.35c-.11-.1-10.45-8.89-31.53-8.89S1.47,52.43,1.39,52.5h0v21.35" />
                <path class="cls-1" d="M46.83,16.09c0,9.32-6.14,16.65-13.71,16.65s-13.71-7.32-13.71-16.65S25.55,1.39,33.12,1.39s13.71,5.38,13.71,14.7Z" />
              </g>
              <line class="cls-1" x1="17.42" y1="73.85" x2="17.42" y2="60.4" />
              <line class="cls-1" x1="48.82" y1="73.85" x2="48.82" y2="60.4" />
            </g>
          </svg>
        </button>
        <div class="profile-menu" id="profileMenu">
          <button id="changePasswordBtn">Change Password</button>
          <button id="signOutBtn">Sign Out</button>
        </div>
      </div>
    </aside>

    <div class="page">
    <div class="topbar">
      <div class="brand">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 78.62 78.58">
            <g>
              <path class="cls-1" d="M15.7,77.19h53.85c4.25,0,7.69-3.44,7.69-7.69h0c0-4.25-3.44-7.69-7.69-7.69h-22.33c-3.55,0-6.43-2.88-6.43-6.43h0c0-3.55,2.88-6.43,6.43-6.43h15.8" />
              <g>
                <path class="cls-1" d="M61.74,1.39h0c13.11,0,20.27,15.28,11.88,25.35l-11.63,13.98h-.49l-11.63-13.98c-8.38-10.07-1.22-25.35,11.88-25.35Z" />
                <path class="cls-1" d="M68.65,16.88c0,3.82-3.09,6.91-6.91,6.91s-6.91-3.09-6.91-6.91,3.09-6.91,6.91-6.91,6.91,3.09,6.91,6.91Z" />
              </g>
              <g>
                <path class="cls-1" d="M16.88,30.16h0c13.11,0,20.27,15.28,11.88,25.35l-11.63,13.98h-.49l-11.63-13.98c-8.38-10.07-1.22-25.35,11.88-25.35Z" />
                <path class="cls-1" d="M23.79,45.64c0,3.82-3.09,6.91-6.91,6.91s-6.91-3.09-6.91-6.91,3.09-6.91,6.91-6.91,6.91,3.09,6.91,6.91Z" />
              </g>
            </g>
          </svg>
        </span>
        <div class="title">
          <h1>Provider Workspace</h1>
          <p>Manage your assigned E-Sign requests.</p>
        </div>
      </div>
      <img class="logo" src="/static/images/Sensys-S-blue2.svg" alt="Sensys" onerror="this.onerror=null;this.src='Logos/Sensys S blue2.svg';" />
    </div>

    <div class="panel">
      <div class="toolbar-wrap">
        <div class="toolbar">
          <div class="tabs">
            <div id="tabNew" class="chip on">New (0)</div>
            <div id="tabSigned" class="chip">Signed (0)</div>
            <div id="tabDeclined" class="chip">Declined (0)</div>
          </div>
          <div class="search-wrap">
            <input id="search" class="search" placeholder="Search patient, agency, insurance, or service..." />
          </div>
        </div>
      </div>

      <div id="list" class="list"></div>
      <div id="empty" class="empty" style="display:none;">No e-signs match your filters.</div>
    </div>
    </div>
  </div>

  <div id="esignConfirmBackdrop" class="confirm-backdrop" aria-hidden="true">
    <div class="confirm-modal" role="dialog" aria-modal="true">
      <h3>Confirm Electronic Signature</h3>
      <div class="confirm-text">
        By confirming, you acknowledge this electronic signature is legally binding. This will lock in the E-Sign and record your signature timestamp.
      </div>
      <div id="esignConfirmMsg" class="confirm-msg"></div>
      <div class="confirm-actions">
        <button id="esignConfirmCancel" class="btn">Cancel</button>
        <button id="esignConfirmOk" class="btn" style="background:var(--navy);color:#fff;border-color:transparent;">Confirm</button>
      </div>
    </div>
  </div>

  <div id="declineConfirmBackdrop" class="confirm-backdrop" aria-hidden="true">
    <div class="confirm-modal" role="dialog" aria-modal="true">
      <h3>Confirm Decline</h3>
      <div class="confirm-text">
        By declining, you acknowledge the order will be removed from your queue and a decline timestamp will be recorded.
      </div>
      <div id="declineConfirmMsg" class="confirm-msg"></div>
      <div class="confirm-actions">
        <button id="declineConfirmCancel" class="btn">Cancel</button>
        <button id="declineConfirmOk" class="btn" style="background:#C76B6B;color:#fff;border-color:transparent;">Confirm</button>
      </div>
    </div>
  </div>

  <div id="editBackdrop" class="confirm-backdrop" aria-hidden="true">
    <div class="edit-modal" role="dialog" aria-modal="true">
      <div class="edit-header">
        <h3>Edit Order</h3>
      </div>
      <div class="edit-body">
        <div class="order-sheet">
          <div class="order-header">
            <div class="order-brand">
              <div class="order-rx"><div class="order-rx-mark" aria-hidden="true"></div></div>
              <div class="order-facility">
                <div class="order-facility-name" id="editAgencyName">Admission Agency</div>
                <div class="order-facility-meta">
                  <div><b>Phone:</b> <span id="editAgencyPhone">--</span></div>
                  <div><b>Fax:</b> <span id="editAgencyFax">--</span></div>
                </div>
              </div>
            </div>
          </div>

          <div class="order-content">
            <section class="order-card">
              <h3 class="order-section-title">Patient Information</h3>
              <div class="order-field-row">
                <div class="order-label">Patient Name</div>
                <div class="order-value" id="editPatientName"></div>
              </div>
              <div class="order-field-row">
                <div class="order-label">DOB</div>
                <div class="order-value" id="editPatientDob"></div>
              </div>
              <div class="order-field-row">
                <div class="order-label">Address</div>
                <div class="order-value" id="editPatientAddress"></div>
              </div>
              <div class="order-field-row">
                <div class="order-label">Order Date</div>
                <div class="order-value" id="editOrderDate"></div>
              </div>
            </section>

            <section class="order-block">
              <h3 class="order-section-title" style="margin-bottom:0;">Order Details</h3>
              <div class="order-line">
                <div class="order-service-label" id="editServiceType">Home Health</div>
                <div class="order-value" id="editServices"></div>
              </div>
              <div></div>
              <textarea id="editOrderComments" class="order-comments" placeholder="Enter additional order comments here..."></textarea>
              <div class="order-divider short"></div>
              <div class="order-sig">
                <div>Electronically signed by <b id="editSignedBy"></b></div>
                <div class="at" id="editSignedAt"></div>
              </div>
              <div class="order-npi">NPI: <b id="editSignedNpi"></b></div>
            </section>
          </div>

          <div class="order-doc-stamp">DOC: EPAD-1.0</div>
        </div>
        <div id="editMsg" class="edit-msg"></div>
        <div class="edit-actions">
          <button id="editCancelBtn" class="btn" type="button">Cancel</button>
          <button id="editSaveBtn" class="btn" type="button">Save</button>
          <button id="editSaveSignBtn" class="btn" type="button" style="background:var(--navy);color:#fff;border-color:transparent;">Save &amp; E-Sign</button>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const listEl = document.getElementById("list");
  const emptyEl = document.getElementById("empty");
  const tabNew = document.getElementById("tabNew");
  const tabSigned = document.getElementById("tabSigned");
  const tabDeclined = document.getElementById("tabDeclined");
  const search = document.getElementById("search");
  const profileBtn = document.getElementById("profileBtn");
  const profileMenu = document.getElementById("profileMenu");
  const signOutBtn = document.getElementById("signOutBtn");
  const changePasswordBtn = document.getElementById("changePasswordBtn");
  const navHome = document.getElementById("navHome");

  let ALL_ROWS = [];
  let ACTIVE_TAB = "new";

  function token(){
    return (localStorage.getItem("sensys_token") || "").trim();
  }
  function authHeaders(){
    return { "Authorization": "Bearer " + token() };
  }
  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function rowStatus(r){
    const s = String(r.esign_status || "").toLowerCase();
    if(s.includes("signed")) return "signed";
    if(s.includes("declined")) return "declined";
    return "new";
  }

  function renderCounts(){
    const newCount = ALL_ROWS.filter(r => rowStatus(r) === "new").length;
    const signedCount = ALL_ROWS.filter(r => rowStatus(r) === "signed").length;
    const declinedCount = ALL_ROWS.filter(r => rowStatus(r) === "declined").length;
    tabNew.textContent = `New (${newCount})`;
    tabSigned.textContent = `Signed (${signedCount})`;
    tabDeclined.textContent = `Declined (${declinedCount})`;
  }

  function applyFilters(){
    const q = (search.value || "").trim().toLowerCase();

    let rows = ALL_ROWS.slice();

    if(ACTIVE_TAB === "signed"){
      rows = rows.filter(r => rowStatus(r) === "signed");
    }else if(ACTIVE_TAB === "declined"){
      rows = rows.filter(r => rowStatus(r) === "declined");
    }else{
      rows = rows.filter(r => rowStatus(r) === "new");
    }

    if(q){
      rows = rows.filter(r => {
        const services = Array.isArray(r.esign_services) ? r.esign_services.join(" ") : "";
        const hay = [
          r.patient_name,
          r.admission_agency,
          r.insurance_name1,
          r.insurance_number1,
          services
        ].join(" ").toLowerCase();
        return hay.includes(q);
      });
    }

    renderList(rows);
  }

  function renderList(rows){
    if(!rows.length){
      listEl.innerHTML = "";
      emptyEl.style.display = "block";
      return;
    }
    emptyEl.style.display = "none";
    listEl.innerHTML = rows.map(r => {
      const status = rowStatus(r);
      const name = r.patient_name || "Patient";
      const dob = r.patient_dob || "--";
      const insName = r.insurance_name1 || "--";
      const insNum = r.insurance_number1 || "--";
      const admit = r.admit_date || "--";
      const dc = r.dc_date || "--";
      const agency = r.admission_agency || "--";
      const services = Array.isArray(r.esign_services) ? r.esign_services : [];
      const servicePills = services.length
        ? services.map(s => `<span class="service-pill">${esc(s)}</span>`).join("")
        : `<span class="service-pill">--</span>`;
      const signedMeta = status === "signed"
        ? `<div class="signed-meta">Signed By: ${esc(r.signed_by || "--")} | Datetime: ${esc(r.signed_at || "--")}</div>`
        : "";
      const actions = status === "signed"
        ? `
            <button class="icon-btn esign disabled" type="button" title="Electronically Sign" aria-label="Electronically Sign" aria-disabled="true">
              <svg viewBox="0 0 75.21 75.69" aria-hidden="true">
                <g>
                  <path class="cls-1" d="M17.37,70.01H2.78c-.77,0-1.39-.62-1.39-1.39V30.8c0-.77.62-1.39,1.39-1.39h13.82c2.28,0,4.5-.86,6.12-2.45,6.52-6.39,13.88-21.06,16.68-24.19,1.27-1.5,3-1.5,4.16-1.28.02,0,.04.01.06.02,8.04,1.86,4.72,14.71,1.7,21.18h0c-1.26,2.45.51,5.37,3.27,5.37h17.33c5.44,0,9.25,5.38,7.44,10.51l-10.54,29.96c-1.22,3.46-4.48,5.77-8.15,5.77h-20.55c-3.57,0-7.11-.65-10.45-1.91l-6.32-2.39V29.37" />
                  <line class="cls-1" x1="72.55" y1="40.45" x2="58.67" y2="40.45" />
                  <line class="cls-1" x1="68.91" y1="51.66" x2="55.48" y2="51.66" />
                  <line class="cls-1" x1="65.27" y1="62.87" x2="52.3" y2="62.87" />
                </g>
              </svg>
            </button>
            <button class="icon-btn esign edit" type="button" title="Edit" aria-label="Edit" data-esign-edit="${esc(String(r.esign_id || ""))}">
              <svg viewBox="0 0 83.92 75.06" aria-hidden="true">
                <g>
                  <g>
                    <g>
                      <g>
                        <path class="cls-1" d="M72.39,10.9l-35.5,35.5-3.11,11.52,11.52-3.11,35.5-35.5c2.32-2.32,2.32-6.09,0-8.41h0c-2.32-2.32-6.09-2.32-8.41,0Z" />
                        <path class="cls-1" d="M76.73,23.71l2.11,2.11c1.49,1.49,1.49,3.91,0,5.4l-10.06,10.06" />
                      </g>
                      <line class="cls-1" x1="33.77" y1="57.93" x2="30.75" y2="60.95" />
                    </g>
                    <polyline class="cls-1" points="60.87 46.97 60.87 73.67 1.39 73.67 1.39 18.52 19.51 1.39 60.87 1.39 60.87 15.15" />
                    <line class="cls-1" x1="14.38" y1="34.58" x2="39.07" y2="34.58" />
                    <line class="cls-1" x1="14.38" y1="47.32" x2="29.52" y2="47.32" />
                    <line class="cls-1" x1="14.38" y1="60.06" x2="25.2" y2="60.06" />
                  </g>
                  <polyline class="cls-1" points="7.59 20.48 21.52 20.48 21.52 7.59" />
                  <line class="cls-1" x1="64.14" y1="36.3" x2="55.54" y2="27.7" />
                </g>
              </svg>
            </button>
          `
        : `
            <button class="icon-btn esign" type="button" title="Electronically Sign" aria-label="Electronically Sign" data-esign-sign="${esc(String(r.esign_id || ""))}">
              <svg viewBox="0 0 75.21 75.69" aria-hidden="true">
                <g>
                  <path class="cls-1" d="M17.37,70.01H2.78c-.77,0-1.39-.62-1.39-1.39V30.8c0-.77.62-1.39,1.39-1.39h13.82c2.28,0,4.5-.86,6.12-2.45,6.52-6.39,13.88-21.06,16.68-24.19,1.27-1.5,3-1.5,4.16-1.28.02,0,.04.01.06.02,8.04,1.86,4.72,14.71,1.7,21.18h0c-1.26,2.45.51,5.37,3.27,5.37h17.33c5.44,0,9.25,5.38,7.44,10.51l-10.54,29.96c-1.22,3.46-4.48,5.77-8.15,5.77h-20.55c-3.57,0-7.11-.65-10.45-1.91l-6.32-2.39V29.37" />
                  <line class="cls-1" x1="72.55" y1="40.45" x2="58.67" y2="40.45" />
                  <line class="cls-1" x1="68.91" y1="51.66" x2="55.48" y2="51.66" />
                  <line class="cls-1" x1="65.27" y1="62.87" x2="52.3" y2="62.87" />
                </g>
              </svg>
            </button>
            <button class="icon-btn edit" type="button" title="Edit" aria-label="Edit" data-esign-edit="${esc(String(r.esign_id || ""))}">
              <svg viewBox="0 0 83.92 75.06" aria-hidden="true">
                <g>
                  <g>
                    <g>
                      <g>
                        <path class="cls-1" d="M72.39,10.9l-35.5,35.5-3.11,11.52,11.52-3.11,35.5-35.5c2.32-2.32,2.32-6.09,0-8.41h0c-2.32-2.32-6.09-2.32-8.41,0Z" />
                        <path class="cls-1" d="M76.73,23.71l2.11,2.11c1.49,1.49,1.49,3.91,0,5.4l-10.06,10.06" />
                      </g>
                      <line class="cls-1" x1="33.77" y1="57.93" x2="30.75" y2="60.95" />
                    </g>
                    <polyline class="cls-1" points="60.87 46.97 60.87 73.67 1.39 73.67 1.39 18.52 19.51 1.39 60.87 1.39 60.87 15.15" />
                    <line class="cls-1" x1="14.38" y1="34.58" x2="39.07" y2="34.58" />
                    <line class="cls-1" x1="14.38" y1="47.32" x2="29.52" y2="47.32" />
                    <line class="cls-1" x1="14.38" y1="60.06" x2="25.2" y2="60.06" />
                  </g>
                  <polyline class="cls-1" points="7.59 20.48 21.52 20.48 21.52 7.59" />
                  <line class="cls-1" x1="64.14" y1="36.3" x2="55.54" y2="27.7" />
                </g>
              </svg>
            </button>
            <button class="icon-btn decline" type="button" title="Decline" aria-label="Decline" data-esign-decline="${esc(String(r.esign_id || ""))}">
              <svg viewBox="0 0 75.21 75.69" aria-hidden="true">
                <g>
                  <path class="cls-1" d="M17.37,70.01H2.78c-.77,0-1.39-.62-1.39-1.39V30.8c0-.77.62-1.39,1.39-1.39h13.82c2.28,0,4.5-.86,6.12-2.45,6.52-6.39,13.88-21.06,16.68-24.19,1.27-1.5,3-1.5,4.16-1.28.02,0,.04.01.06.02,8.04,1.86,4.72,14.71,1.7,21.18h0c-1.26,2.45.51,5.37,3.27,5.37h17.33c5.44,0,9.25,5.38,7.44,10.51l-10.54,29.96c-1.22,3.46-4.48,5.77-8.15,5.77h-20.55c-3.57,0-7.11-.65-10.45-1.91l-6.32-2.39V29.37" />
                  <line class="cls-1" x1="72.55" y1="40.45" x2="58.67" y2="40.45" />
                  <line class="cls-1" x1="68.91" y1="51.66" x2="55.48" y2="51.66" />
                  <line class="cls-1" x1="65.27" y1="62.87" x2="52.3" y2="62.87" />
                </g>
              </svg>
            </button>
          `;
      return `
        <div class="row">
          <div class="row-header">
            <div class="avatar" aria-hidden="true">
              <svg viewBox="0 0 74.42 77.39">
                <g>
                  <g>
                    <path class="cls-1" d="M29.76,41.57c-.05,3.12-.88,5.84-2.57,8.1l-16.67,4.74c-5.41,1.54-9.14,6.48-9.14,12.1v9.49h71.65v-9.49c0-5.62-3.73-10.56-9.14-12.1l-16.67-4.74c-1.69-2.27-2.52-4.98-2.57-8.1" />
                    <line class="cls-1" x1="16.08" y1="75.15" x2="16.08" y2="67.05" />
                    <line class="cls-1" x1="58.34" y1="75.15" x2="58.34" y2="67.05" />
                    <polyline class="cls-1" points="47.43 50.22 37.21 66.4 26.99 50.22" />
                    <line class="cls-1" x1="37.21" y1="66.4" x2="37.21" y2="75.17" />
                  </g>
                  <g>
                    <path class="cls-1" d="M53.48,20.19S56.92,1.39,37.06,1.39s-16.52,18.81-16.52,18.81" />
                    <path class="cls-1" d="M27.97,17.86c-1.92,1.59-4.24,2.6-7.2,2.6-1.55.02-2.82,1.12-3.12,2.56-.11.51-.05,1.04.09,1.54l.99,3.45c.3,1.04,1.11,1.83,2.11,2.13h0c.82.24,1.48.83,1.8,1.62,2.75,6.89,8.17,12.11,14.43,12.11s11.59-5.13,14.36-11.95c.35-.87,1.07-1.53,1.96-1.81h0c.95-.32,1.72-1.1,2.01-2.1l.99-3.45c.14-.5.2-1.03.09-1.54-.31-1.43-1.57-2.54-3.12-2.56-7.81,0-15.44-1.64-20.89-8.18" />
                  </g>
                </g>
              </svg>
            </div>
            <div>
              <div class="name">${esc(name)}</div>
              <div class="meta">
                <span>DOB: ${esc(dob)}</span>
              </div>
              <div class="meta">
                <span>Insurance: ${esc(insName)} (${esc(insNum)})</span>
              </div>
            </div>
          </div>
          <div class="row-actions">${actions}</div>
          <div class="agency-name">${esc(agency)}</div>
          <div class="meta row-dates">
            <span><b>Admit:</b> ${esc(admit)}</span>
            <span><b>DC:</b> ${esc(dc)}</span>
          </div>
          <div class="service-pills">${servicePills}</div>
          ${signedMeta}
        </div>
      `;
    }).join("");

    listEl.querySelectorAll("[data-esign-sign]").forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const id = Number(btn.getAttribute("data-esign-sign"));
        if(id) openEsignConfirm(id);
      });
    });
    listEl.querySelectorAll("[data-esign-decline]").forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const id = Number(btn.getAttribute("data-esign-decline"));
        if(id) openDeclineConfirm(id);
      });
    });
    listEl.querySelectorAll("[data-esign-edit]").forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const id = Number(btn.getAttribute("data-esign-edit"));
        if(!id) return;
        const row = ALL_ROWS.find(r => Number(r.esign_id) === id);
        if(row) openEditModal(row);
      });
    });
  }

  async function load(){
    if(!token()){
      ALL_ROWS = [];
      renderCounts();
      applyFilters();
      return;
    }
    try{
      const res = await fetch("/api/sensys/provider/esigns", { headers: authHeaders() });
      const data = await res.json();
      if(!res.ok || !data.ok){
        ALL_ROWS = [];
        renderCounts();
        applyFilters();
        return;
      }
      ALL_ROWS = (data.esigns || []).map(e => {
        const first = e.patient_first_name || "";
        const last = e.patient_last_name || "";
        const name = last || first ? `${last}, ${first}`.trim() : (e.patient_name || "");
        const services = Array.isArray(e.services) ? e.services : [];
        return {
          esign_id: e.id,
          patient_name: name,
          patient_dob: e.patient_dob || e.dob || "",
          insurance_name1: e.patient_insurance_name1 || e.insurance_name1 || "",
          insurance_number1: e.patient_insurance_number1 || e.insurance_number1 || "",
          admit_date: e.admit_date,
          dc_date: e.dc_date,
          admission_agency: e.agency_name,
          agency_phone: e.agency_phone,
          agency_fax: e.agency_fax,
          esign_status: e.status || "",
          esign_services: services.map(s => s.service_name || s.name).filter(Boolean),
          service_type_name: e.service_type_name || "",
          esign_comments: e.comments || "",
          patient_address1: e.patient_address1 || "",
          patient_address2: e.patient_address2 || "",
          patient_city: e.patient_city || "",
          patient_state: e.patient_state || "",
          patient_zip: e.patient_zip || "",
          signed_by: e.signed_by_name || "",
          signed_at: e.signed_at,
          signed_by_npi: e.signed_by_npi || ""
        };
      });
      renderCounts();
      applyFilters();
    }catch(e){
      ALL_ROWS = [];
      renderCounts();
      applyFilters();
    }
  }

  tabNew.addEventListener("click", () => {
    ACTIVE_TAB = "new";
    tabNew.classList.add("on");
    tabSigned.classList.remove("on");
    tabDeclined.classList.remove("on");
    applyFilters();
  });
  tabSigned.addEventListener("click", () => {
    ACTIVE_TAB = "signed";
    tabSigned.classList.add("on");
    tabNew.classList.remove("on");
    tabDeclined.classList.remove("on");
    applyFilters();
  });
  tabDeclined.addEventListener("click", () => {
    ACTIVE_TAB = "declined";
    tabDeclined.classList.add("on");
    tabNew.classList.remove("on");
    tabSigned.classList.remove("on");
    applyFilters();
  });

  search.addEventListener("input", applyFilters);

  const esignConfirmBackdrop = document.getElementById("esignConfirmBackdrop");
  const esignConfirmOk = document.getElementById("esignConfirmOk");
  const esignConfirmCancel = document.getElementById("esignConfirmCancel");
  const esignConfirmMsg = document.getElementById("esignConfirmMsg");
  const declineConfirmBackdrop = document.getElementById("declineConfirmBackdrop");
  const declineConfirmOk = document.getElementById("declineConfirmOk");
  const declineConfirmCancel = document.getElementById("declineConfirmCancel");
  const declineConfirmMsg = document.getElementById("declineConfirmMsg");
  const editBackdrop = document.getElementById("editBackdrop");
  const editCancelBtn = document.getElementById("editCancelBtn");
  const editSaveBtn = document.getElementById("editSaveBtn");
  const editSaveSignBtn = document.getElementById("editSaveSignBtn");
  const editMsg = document.getElementById("editMsg");
  const editOrderComments = document.getElementById("editOrderComments");
  const editAgencyName = document.getElementById("editAgencyName");
  const editAgencyPhone = document.getElementById("editAgencyPhone");
  const editAgencyFax = document.getElementById("editAgencyFax");
  const editPatientName = document.getElementById("editPatientName");
  const editPatientDob = document.getElementById("editPatientDob");
  const editPatientAddress = document.getElementById("editPatientAddress");
  const editOrderDate = document.getElementById("editOrderDate");
  const editServiceType = document.getElementById("editServiceType");
  const editServices = document.getElementById("editServices");
  const editSignedBy = document.getElementById("editSignedBy");
  const editSignedAt = document.getElementById("editSignedAt");
  const editSignedNpi = document.getElementById("editSignedNpi");
  let ACTIVE_ESIGN_ID = null;
  let ACTIVE_EDIT_ROW = null;

  function showConfirmMsg(el, text){
    if(!el) return;
    if(!text){
      el.style.display = "none";
      el.textContent = "";
      return;
    }
    el.style.display = "block";
    el.textContent = text;
  }
  function openEsignConfirm(id){
    ACTIVE_ESIGN_ID = id;
    showConfirmMsg(esignConfirmMsg, "");
    if(esignConfirmBackdrop) esignConfirmBackdrop.style.display = "flex";
  }
  function closeEsignConfirm(){
    if(esignConfirmBackdrop) esignConfirmBackdrop.style.display = "none";
    ACTIVE_ESIGN_ID = null;
  }
  function openDeclineConfirm(id){
    ACTIVE_ESIGN_ID = id;
    showConfirmMsg(declineConfirmMsg, "");
    if(declineConfirmBackdrop) declineConfirmBackdrop.style.display = "flex";
  }
  function closeDeclineConfirm(){
    if(declineConfirmBackdrop) declineConfirmBackdrop.style.display = "none";
    ACTIVE_ESIGN_ID = null;
  }
  function showEditMsg(text){
    if(!editMsg) return;
    if(!text){
      editMsg.style.display = "none";
      editMsg.textContent = "";
      return;
    }
    editMsg.style.display = "block";
    editMsg.textContent = text;
  }
  function formatAddress(row){
    const parts = [];
    if(row.patient_address1) parts.push(row.patient_address1);
    if(row.patient_address2) parts.push(row.patient_address2);
    const cityState = [row.patient_city, row.patient_state].filter(Boolean).join(", ");
    const zip = row.patient_zip || "";
    const line2 = [cityState, zip].filter(Boolean).join(" ");
    if(line2) parts.push(line2);
    return parts.join(", ");
  }
  function openEditModal(row){
    if(!row) return;
    ACTIVE_EDIT_ROW = row;
    const orderDate = row.signed_at ? row.signed_at : new Date().toLocaleDateString();
    const isSigned = rowStatus(row) === "signed";
    if(editAgencyName) editAgencyName.textContent = row.admission_agency || "--";
    if(editAgencyPhone) editAgencyPhone.textContent = row.agency_phone || "--";
    if(editAgencyFax) editAgencyFax.textContent = row.agency_fax || "--";
    if(editPatientName) editPatientName.textContent = row.patient_name || "--";
    if(editPatientDob) editPatientDob.textContent = row.patient_dob || "--";
    if(editPatientAddress) editPatientAddress.textContent = formatAddress(row) || "--";
    if(editOrderDate) editOrderDate.textContent = orderDate || "--";
    if(editServiceType){
      const st = String(row.service_type_name || "").toLowerCase();
      editServiceType.textContent = st.includes("dme") ? "DME" : "Home Health";
    }
    if(editServices) editServices.textContent = (row.esign_services || []).join(", ") || "--";
    if(editSignedBy) editSignedBy.textContent = row.signed_by || "";
    if(editSignedAt) editSignedAt.textContent = row.signed_at || "";
    if(editSignedNpi) editSignedNpi.textContent = row.signed_by_npi || "";
    if(editOrderComments){
      editOrderComments.value = row.esign_comments || "";
      editOrderComments.readOnly = isSigned;
      editOrderComments.classList.toggle("readonly", isSigned);
      editOrderComments.placeholder = isSigned ? "" : "Enter additional order comments here...";
    }
    if(editSaveBtn) editSaveBtn.style.display = isSigned ? "none" : "";
    if(editSaveSignBtn) editSaveSignBtn.style.display = isSigned ? "none" : "";
    if(editCancelBtn) editCancelBtn.textContent = isSigned ? "Close" : "Cancel";
    showEditMsg("");
    if(editBackdrop) editBackdrop.style.display = "flex";
  }
  function closeEditModal(){
    if(editBackdrop) editBackdrop.style.display = "none";
    ACTIVE_EDIT_ROW = null;
  }

  if(esignConfirmCancel){
    esignConfirmCancel.addEventListener("click", closeEsignConfirm);
  }
  if(declineConfirmCancel){
    declineConfirmCancel.addEventListener("click", closeDeclineConfirm);
  }
  if(esignConfirmBackdrop){
    esignConfirmBackdrop.addEventListener("click", (e) => {
      if(e.target === esignConfirmBackdrop) closeEsignConfirm();
    });
  }
  if(declineConfirmBackdrop){
    declineConfirmBackdrop.addEventListener("click", (e) => {
      if(e.target === declineConfirmBackdrop) closeDeclineConfirm();
    });
  }
  if(editBackdrop){
    editBackdrop.addEventListener("click", (e) => {
      if(e.target === editBackdrop) closeEditModal();
    });
  }
  if(editCancelBtn){
    editCancelBtn.addEventListener("click", closeEditModal);
  }
  async function saveEdit(signAfter){
    if(!ACTIVE_EDIT_ROW) return;
    try{
      showEditMsg("");
      const res = await fetch("/api/sensys/provider/esigns/update", {
        method:"POST",
        headers: { "Content-Type":"application/json", ...authHeaders() },
        body: JSON.stringify({
          esign_id: ACTIVE_EDIT_ROW.esign_id,
          comments: (editOrderComments ? editOrderComments.value : "") || ""
        })
      });
      const data = await res.json();
      if(!res.ok || !data.ok){
        showEditMsg(data.detail || "Unable to save order.");
        return;
      }
      if(signAfter){
        const signRes = await fetch("/api/sensys/provider/esigns/sign", {
          method:"POST",
          headers: { "Content-Type":"application/json", ...authHeaders() },
          body: JSON.stringify({ esign_id: ACTIVE_EDIT_ROW.esign_id })
        });
        const signData = await signRes.json();
        if(!signRes.ok || !signData.ok){
          showEditMsg(signData.detail || "Unable to sign.");
          return;
        }
      }
      closeEditModal();
      await load();
    }catch(e){
      showEditMsg(e.message || "Unable to save order.");
    }
  }
  if(editSaveBtn){
    editSaveBtn.addEventListener("click", () => saveEdit(false));
  }
  if(editSaveSignBtn){
    editSaveSignBtn.addEventListener("click", () => saveEdit(true));
  }
  if(esignConfirmOk){
    esignConfirmOk.addEventListener("click", async () => {
      if(!ACTIVE_ESIGN_ID) return;
      try{
        showConfirmMsg(esignConfirmMsg, "");
        await fetch("/api/sensys/provider/esigns/sign", {
          method:"POST",
          headers: { "Content-Type":"application/json", ...authHeaders() },
          body: JSON.stringify({ esign_id: ACTIVE_ESIGN_ID })
        });
        closeEsignConfirm();
        await load();
      }catch(e){
        showConfirmMsg(esignConfirmMsg, e.message || "Unable to sign.");
      }
    });
  }
  if(declineConfirmOk){
    declineConfirmOk.addEventListener("click", async () => {
      if(!ACTIVE_ESIGN_ID) return;
      try{
        showConfirmMsg(declineConfirmMsg, "");
        await fetch("/api/sensys/provider/esigns/decline", {
          method:"POST",
          headers: { "Content-Type":"application/json", ...authHeaders() },
          body: JSON.stringify({ esign_id: ACTIVE_ESIGN_ID })
        });
        closeDeclineConfirm();
        await load();
      }catch(e){
        showConfirmMsg(declineConfirmMsg, e.message || "Unable to decline.");
      }
    });
  }

  profileBtn.addEventListener("click", () => {
    const isOpen = profileMenu.style.display === "block";
    profileMenu.style.display = isOpen ? "none" : "block";
  });
  document.addEventListener("click", (e) => {
    if(!profileMenu.contains(e.target) && !profileBtn.contains(e.target)){
      profileMenu.style.display = "none";
    }
  });
  signOutBtn.addEventListener("click", () => {
    localStorage.removeItem("sensys_token");
    window.location.href = "/sensys/login";
  });
  changePasswordBtn.addEventListener("click", () => {
    window.location.href = "/sensys/change-password";
  });
  navHome.addEventListener("click", () => {
    window.location.href = "/sensys/provider-landing";
  });

  load();
})();
</script>
</body>
</html>
