<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sensys - Admission Details</title>
</head>

<body style="margin:0;font-family:Arial,Helvetica,sans-serif;background:#f6f7fb;">
  <div style="max-width:1100px;margin:0 auto;padding:18px;">

    <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;">
      <div>
        <div style="font-size:18px;font-weight:800;">Admission Details</div>
        <div id="subhead" style="font-size:12px;color:#667085;margin-top:4px;"></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button id="backBtn"
          style="padding:8px 10px;border:1px solid #d0d5dd;background:#fff;border-radius:10px;cursor:pointer;font-size:12px;">
          ← Back
        </button>
        <button id="logoutBtn"
          style="padding:8px 10px;border:1px solid #d0d5dd;background:#fff;border-radius:10px;cursor:pointer;font-size:12px;">
          Log out
        </button>
      </div>
    </div>

    <div id="msg" style="margin-top:10px;font-size:12px;color:#b42318;display:none;"></div>

    <!-- Header -->
    <div style="margin-top:14px;background:#fff;border:1px solid #e6e8ef;border-radius:14px;padding:14px;">
      <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;">
        <div>
          <div id="patientName" style="font-size:16px;font-weight:800;color:#111827;">—</div>
          <div id="metaLine" style="margin-top:4px;font-size:12px;color:#667085;">—</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
          <div style="font-size:12px;color:#475467;">Admission ID: <span id="admissionIdTag" style="font-weight:800;color:#111827;"></span></div>
          <button id="refreshBtn"
            style="padding:10px 12px;border:0;border-radius:10px;background:#111827;color:#fff;font-size:13px;font-weight:700;cursor:pointer;">
            Refresh
          </button>
        </div>
      </div>
    </div>

    <!-- GRID -->
    <div style="margin-top:14px;display:grid;grid-template-columns:1fr;gap:14px;">
      <!-- Tasks -->
      <div style="background:#fff;border:1px solid #e6e8ef;border-radius:14px;padding:14px;">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
          <div style="font-size:13px;color:#111827;font-weight:800;">Tasks</div>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
          <select id="taskStatus"
            style="padding:10px;border:1px solid #d0d5dd;border-radius:10px;font-size:13px;outline:none;">
            <option>New</option>
            <option>Moved</option>
            <option>Pending</option>
            <option>Completed</option>
          </select>
          <input id="taskName" placeholder="Task name"
            style="flex:1;min-width:220px;box-sizing:border-box;padding:10px;border:1px solid #d0d5dd;border-radius:10px;font-size:13px;outline:none;" />
          <input id="taskAssignedUser" placeholder="Assigned user id (optional)"
            style="width:220px;box-sizing:border-box;padding:10px;border:1px solid #d0d5dd;border-radius:10px;font-size:13px;outline:none;" />
          <input id="taskComments" placeholder="Comments (optional)"
            style="flex:1;min-width:260px;box-sizing:border-box;padding:10px;border:1px solid #d0d5dd;border-radius:10px;font-size:13px;outline:none;" />
          <button id="addTaskBtn"
            style="padding:10px 12px;border:0;border-radius:10px;background:#111827;color:#fff;font-size:13px;font-weight:800;cursor:pointer;">
            Add
          </button>
        </div>

        <div style="margin-top:12px;overflow:auto;border:1px solid #eef0f5;border-radius:12px;">
          <table style="width:100%;border-collapse:collapse;min-width:760px;">
            <thead>
              <tr style="background:#f9fafb;border-bottom:1px solid #eef0f5;">
                <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">Status</th>
                <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">Task</th>
                <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">Assigned</th>
                <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">Comments</th>
                <th style="text-align:right;padding:10px;font-size:12px;color:#475467;">Actions</th>
              </tr>
            </thead>
            <tbody id="tasksTbody"></tbody>
          </table>
        </div>
      </div>

      <!-- Notes -->
      <div style="background:#fff;border:1px solid #e6e8ef;border-radius:14px;padding:14px;">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
          <div style="font-size:13px;color:#111827;font-weight:800;">Notes</div>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;">

          <!-- NEW: Note template/type -->
          <select id="noteTemplateSelect"
            style="width:260px;box-sizing:border-box;padding:10px;border:1px solid #d0d5dd;border-radius:10px;font-size:13px;outline:none;background:#fff;">
            <option value="">Select note type…</option>
          </select>

          <!-- Keep legacy note_name (optional) -->
          <input id="noteName" placeholder="Note name (optional / legacy)"
            style="width:240px;box-sizing:border-box;padding:10px;border:1px solid #d0d5dd;border-radius:10px;font-size:13px;outline:none;" />

          <!-- NEW: Common fields -->
          <input id="noteTitle" placeholder="Note title"
            style="flex:1;min-width:220px;box-sizing:border-box;padding:10px;border:1px solid #d0d5dd;border-radius:10px;font-size:13px;outline:none;" />

          <select id="noteStatus"
            style="width:170px;box-sizing:border-box;padding:10px;border:1px solid #d0d5dd;border-radius:10px;font-size:13px;outline:none;background:#fff;">
            <option value="New">New</option>
            <option value="In Progress">In Progress</option>
            <option value="Completed">Completed</option>
          </select>

          <input id="noteResponse1" placeholder="Response 1"
            style="flex:1;min-width:220px;box-sizing:border-box;padding:10px;border:1px solid #d0d5dd;border-radius:10px;font-size:13px;outline:none;" />

          <input id="noteResponse2" placeholder="Response 2"
            style="flex:1;min-width:220px;box-sizing:border-box;padding:10px;border:1px solid #d0d5dd;border-radius:10px;font-size:13px;outline:none;" />

          <button id="addNoteBtn"
            style="padding:10px 12px;border:0;border-radius:10px;background:#111827;color:#fff;font-size:13px;font-weight:800;cursor:pointer;">
            Add
          </button>
        </div>

        <!-- Optional legacy comments (keep for now) -->
        <div style="margin-top:8px;">
          <input id="noteComments" placeholder="Legacy comments (optional)"
            style="width:100%;box-sizing:border-box;padding:10px;border:1px solid #d0d5dd;border-radius:10px;font-size:13px;outline:none;" />
        </div>

        <!-- NEW: dynamic template fields render here -->
        <div id="noteDynamicFields" style="margin-top:10px;"></div>

        <div style="margin-top:12px;overflow:auto;border:1px solid #eef0f5;border-radius:12px;">
          <table style="width:100%;border-collapse:collapse;min-width:760px;">
            <thead>
              <tr style="background:#f9fafb;border-bottom:1px solid #eef0f5;">
                <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">Name</th>
                <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">Comments</th>
                <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">Created</th>
                <th style="text-align:right;padding:10px;font-size:12px;color:#475467;">Actions</th>
              </tr>
            </thead>
            <tbody id="notesTbody"></tbody>
          </table>
        </div>
      </div>
      <!-- SMS -->
      <div style="background:#fff;border:1px solid #e6e8ef;border-radius:14px;padding:14px;">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
          <div>
            <div style="font-size:13px;color:#111827;font-weight:800;">SMS</div>
            <div id="smsAutoRefreshMeta" style="margin-top:2px;font-size:12px;color:#667085;">
              Auto-refresh: On • Last checked: —
            </div>
          </div>

          <div style="display:flex;gap:8px;align-items:center;">
            <button id="smsRefreshBtn"
              style="padding:8px 10px;border:1px solid #d0d5dd;background:#fff;border-radius:10px;cursor:pointer;font-size:12px;">
              Refresh SMS
            </button>
          </div>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
          <input id="smsToPhone" placeholder="To phone (E.164 preferred, e.g. +15551234567)"
            style="width:280px;box-sizing:border-box;padding:10px;border:1px solid #d0d5dd;border-radius:10px;font-size:13px;outline:none;" />

          <input id="smsText" placeholder="Message"
            style="flex:1;min-width:300px;box-sizing:border-box;padding:10px;border:1px solid #d0d5dd;border-radius:10px;font-size:13px;outline:none;" />

          <button id="sendSmsBtn"
            style="padding:10px 12px;border:0;border-radius:10px;background:#111827;color:#fff;font-size:13px;font-weight:800;cursor:pointer;">
            Send SMS
          </button>
        </div>

        <div style="margin-top:12px;overflow:auto;border:1px solid #eef0f5;border-radius:12px;">
          <table style="width:100%;border-collapse:collapse;min-width:760px;">
            <thead>
              <tr style="background:#f9fafb;border-bottom:1px solid #eef0f5;">
                <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">To</th>
                <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">Message</th>
                <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">Created</th>
                <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">Status</th>
              </tr>
            </thead>
            <tbody id="smsTbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- DC submissions (full width) -->
    <div style="margin-top:14px;background:#fff;border:1px solid #e6e8ef;border-radius:14px;padding:14px;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
        <div style="font-size:13px;color:#111827;font-weight:800;">DC Submissions</div>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
        <input id="dcDate" placeholder="DC date (YYYY-MM-DD)"
          style="width:190px;box-sizing:border-box;padding:10px;border:1px solid #d0d5dd;border-radius:10px;font-size:13px;outline:none;" />
        <input id="dcTime" placeholder="DC time (HH:MM)"
          style="width:150px;box-sizing:border-box;padding:10px;border:1px solid #d0d5dd;border-radius:10px;font-size:13px;outline:none;" />

        <label style="font-size:12px;color:#475467;display:flex;gap:6px;align-items:center;">
          <input id="dcConfirmed" type="checkbox" /> Confirmed
        </label>
        <label style="font-size:12px;color:#475467;display:flex;gap:6px;align-items:center;">
          <input id="dcUrgent" type="checkbox" /> Urgent
        </label>

        <input id="urgentComments" placeholder="Urgent comments"
          style="flex:1;min-width:220px;box-sizing:border-box;padding:10px;border:1px solid #d0d5dd;border-radius:10px;font-size:13px;outline:none;" />

        <select id="dcDestination"
          style="padding:10px;border:1px solid #d0d5dd;border-radius:10px;font-size:13px;outline:none;">
          <option>Home</option>
          <option>ALF</option>
          <option>ILF</option>
          <option>Hospital</option>
          <option>LTC</option>
          <option>AMA</option>
          <option>Other</option>
        </select>

        <input id="destinationComments" placeholder="Destination comments"
          style="flex:1;min-width:220px;box-sizing:border-box;padding:10px;border:1px solid #d0d5dd;border-radius:10px;font-size:13px;outline:none;" />

        <select id="dcWith"
          style="padding:10px;border:1px solid #d0d5dd;border-radius:10px;font-size:13px;outline:none;">
          <option>alone</option>
          <option>spouse</option>
          <option>other family</option>
          <option>caregiver</option>
        </select>

        <select id="dcServicesMulti" multiple
          style="min-width:260px;max-width:320px;height:42px;padding:8px;border:1px solid #d0d5dd;border-radius:10px;font-size:13px;outline:none;background:#fff;">
        </select>

        <button id="addDcBtn"
          style="padding:10px 12px;border:0;border-radius:10px;background:#111827;color:#fff;font-size:13px;font-weight:800;cursor:pointer;">
          Add DC Submission
        </button>
      </div>

      <div style="margin-top:12px;overflow:auto;border:1px solid #eef0f5;border-radius:12px;">
        <table style="width:100%;border-collapse:collapse;min-width:1050px;">
          <thead>
            <tr style="background:#f9fafb;border-bottom:1px solid #eef0f5;">
              <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">DC</th>
              <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">Destination</th>
              <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">Urgent</th>
              <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">Services</th>
              <th style="text-align:right;padding:10px;font-size:12px;color:#475467;">Actions</th>
            </tr>
          </thead>
          <tbody id="dcTbody"></tbody>
        </table>
      </div>

      <div style="margin-top:10px;font-size:12px;color:#667085;">
        Tip: Services are loaded from your Services admin tab (DME / HH). Use “Edit services” per submission.
      </div>
    </div>

    <!-- Referrals (full width) -->
    <div style="margin-top:14px;background:#fff;border:1px solid #e6e8ef;border-radius:14px;padding:14px;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
        <div style="font-size:13px;color:#111827;font-weight:800;">Referrals</div>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
        <select id="referralAgencySelect"
          style="flex:1;min-width:320px;padding:10px;border:1px solid #d0d5dd;border-radius:10px;font-size:13px;outline:none;">
          <option value="">Loading agencies…</option>
        </select>

        <button id="addReferralBtn"
          style="padding:10px 12px;border:0;border-radius:10px;background:#111827;color:#fff;font-size:13px;font-weight:800;cursor:pointer;">
          Add Referral
        </button>
      </div>

      <div style="margin-top:12px;overflow:auto;border:1px solid #eef0f5;border-radius:12px;">
        <table style="width:100%;border-collapse:collapse;min-width:900px;">
          <thead>
            <tr style="background:#f9fafb;border-bottom:1px solid #eef0f5;">
              <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">Agency</th>
              <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">Type</th>
              <th style="text-align:right;padding:10px;font-size:12px;color:#475467;">Actions</th>
            </tr>
          </thead>
          <tbody id="referralsTbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Appointments (full width) -->
    <div style="margin-top:14px;background:#fff;border:1px solid #e6e8ef;border-radius:14px;padding:14px;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
        <div style="font-size:13px;color:#111827;font-weight:800;">Appointments</div>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
        <select id="apptCareTeamSelect"
          style="flex:1;min-width:320px;padding:10px;border:1px solid #d0d5dd;border-radius:10px;font-size:13px;outline:none;">
          <option value="">Loading care team…</option>
        </select>

        <input id="apptDatetime" type="datetime-local"
          style="width:240px;box-sizing:border-box;padding:10px;border:1px solid #d0d5dd;border-radius:10px;font-size:13px;outline:none;" />

        <select id="apptStatus"
          style="width:210px;padding:10px;border:1px solid #d0d5dd;border-radius:10px;font-size:13px;outline:none;">
          <option>New</option>
          <option>Attended</option>
          <option>Missed</option>
          <option>Rescheduled</option>
        </select>

        <button id="addApptBtn"
          style="padding:10px 12px;border:0;border-radius:10px;background:#111827;color:#fff;font-size:13px;font-weight:800;cursor:pointer;">
          Add Appointment
        </button>
      </div>

      <div style="margin-top:12px;overflow:auto;border:1px solid #eef0f5;border-radius:12px;">
        <table style="width:100%;border-collapse:collapse;min-width:1050px;">
          <thead>
            <tr style="background:#f9fafb;border-bottom:1px solid #eef0f5;">
              <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">Date/Time</th>
              <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">Care Team</th>
              <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">Status</th>
              <th style="text-align:right;padding:10px;font-size:12px;color:#475467;">Actions</th>
            </tr>
          </thead>
          <tbody id="apptsTbody"></tbody>
        </table>
      </div>
    </div>
    <!-- PDFs (uploaded docs) -->
    <div style="margin-top:14px;background:#fff;border:1px solid #e6e8ef;border-radius:14px;padding:14px;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
        <div style="font-size:13px;color:#111827;font-weight:800;">PDFs</div>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
        <input id="pdfDocType" placeholder="Doc type (e.g., SNF, Insurance, Orders)"
          style="flex:1;min-width:260px;box-sizing:border-box;padding:10px;border:1px solid #d0d5dd;border-radius:10px;font-size:13px;outline:none;" />

        <input id="pdfRetentionHours" type="number" min="0" placeholder="Retention hrs (0 = keep)"
          style="width:190px;box-sizing:border-box;padding:10px;border:1px solid #d0d5dd;border-radius:10px;font-size:13px;outline:none;" />

        <input id="pdfFile" type="file" accept="application/pdf"
          style="flex:1;min-width:260px;box-sizing:border-box;padding:8px;border:1px solid #d0d5dd;border-radius:10px;font-size:13px;outline:none;background:#fff;" />

        <button id="uploadPdfBtn"
          style="padding:10px 12px;border:0;border-radius:10px;background:#111827;color:#fff;font-size:13px;font-weight:800;cursor:pointer;">
          Upload PDF
        </button>
      </div>

      <div style="margin-top:12px;overflow:auto;border:1px solid #eef0f5;border-radius:12px;">
        <table style="width:100%;border-collapse:collapse;min-width:1050px;">
          <thead>
            <tr style="background:#f9fafb;border-bottom:1px solid #eef0f5;">
              <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">File</th>
              <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">Type</th>
              <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">Size</th>
              <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">Created</th>
              <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">Expires</th>
              <th style="text-align:right;padding:10px;font-size:12px;color:#475467;">Actions</th>
            </tr>
          </thead>
          <tbody id="pdfsTbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Care team (full width) -->
    <div style="margin-top:14px;background:#fff;border:1px solid #e6e8ef;border-radius:14px;padding:14px;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
        <div style="font-size:13px;color:#111827;font-weight:800;">Care Team (linked to this admission)</div>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
        <select id="careTeamSelect"
          style="flex:1;min-width:320px;padding:10px;border:1px solid #d0d5dd;border-radius:10px;font-size:13px;outline:none;">
          <option value="">Loading care team…</option>
        </select>

        <button id="addCareTeamBtn"
          style="padding:10px 12px;border:0;border-radius:10px;background:#111827;color:#fff;font-size:13px;font-weight:800;cursor:pointer;">
          Link to Admission
        </button>
      </div>

      <div style="margin-top:12px;overflow:auto;border:1px solid #eef0f5;border-radius:12px;">
        <table style="width:100%;border-collapse:collapse;min-width:900px;">
          <thead>
            <tr style="background:#f9fafb;border-bottom:1px solid #eef0f5;">
              <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">Name</th>
              <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">Type</th>
              <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">Phone</th>
              <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">Email</th>
              <th style="text-align:right;padding:10px;font-size:12px;color:#475467;">Actions</th>
            </tr>
          </thead>
          <tbody id="careTeamTbody"></tbody>
        </table>
      </div>
    </div>

  </div>

<script>
  function qs(name) {
    const u = new URL(window.location.href);
    return u.searchParams.get(name);
  }

  function showMsg(text) {
    const el = document.getElementById('msg');
    el.style.display = text ? 'block' : 'none';
    el.textContent = text || '';
  }

  function token() {
    return localStorage.getItem('sensys_token') || '';
  }

  async function api(path, opts) {
    const t = token();
    if (!t) {
      // Front-end visible error + console error
      console.error('[SENSYS][API][ERROR] Missing token for request:', path);
      showMsg("Missing token. Please log in again.");
      throw new Error("Missing token. Please log in again.");
    }

    let res;
    try {
      res = await fetch(path, {
        ...(opts || {}),
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + t,
          ...((opts && opts.headers) || {})
        }
      });
    } catch (err) {
      console.error('[SENSYS][API][NETWORK_ERROR]', path, err);
      showMsg("Network error calling " + path + ". Check connection / server logs.");
      throw err;
    }

    if (!res.ok) {
      let msg = 'Request failed (' + res.status + ')';
      try {
        const j = await res.json();
        if (j && j.detail) msg = j.detail;
      } catch (e) {}

      console.error('[SENSYS][API][HTTP_ERROR]', path, res.status, msg);

      // If auth-related, give a clearer message
      if (res.status === 401) {
        msg = "Unauthorized (401). Your session may be expired. Please log in again.";
      } else if (res.status === 403) {
        msg = "Forbidden (403). You may not have access to this admission.";
      }

      showMsg(msg + " (Endpoint: " + path + ")");
      throw new Error(msg);
    }

    return await res.json();
  }

  async function apiForm(path, formData, opts){
    const t = token();
    if(!t){
      console.error('[SENSYS][API_FORM][ERROR] Missing token for request:', path);
      showMsg("Missing token. Please log in again.");
      throw new Error("Missing token. Please log in again.");
    }

    let res;
    try{
      res = await fetch(path, {
        method: 'POST',
        body: formData,
        ...(opts || {}),
        headers: {
          'Authorization': 'Bearer ' + t,
          ...((opts && opts.headers) || {})
        }
      });
    }catch(err){
      console.error('[SENSYS][API_FORM][NETWORK_ERROR]', path, err);
      showMsg("Network error calling " + path + ". Check connection / server logs.");
      throw err;
    }

    if(!res.ok){
      let msg = 'Request failed (' + res.status + ')';
      try{
        const j = await res.json();
        if(j && j.detail) msg = j.detail;
      }catch(e){}
      console.error('[SENSYS][API_FORM][HTTP_ERROR]', path, res.status, msg);
      showMsg(msg + " (Endpoint: " + path + ")");
      throw new Error(msg);
    }

    return await res.json();
  }


  let ADMISSION_ID = null;
  let SERVICES = [];
  let CARE_TEAM = [];
  let DETAILS = null;
  let AGENCIES = [];
  let NOTE_TEMPLATES = []; // ✅ NEW
  let SMS_LOG = [];
  let PDFS = [];

  // ✅ NEW: SMS auto refresh controls (lightweight)
  let SMS_AUTO_REFRESH_MS = 60000; // 60s (change to 120000 for 2 min if you want even lighter)
  let SMS_POLL_TIMER = null;
  let SMS_LAST_CHECKED_AT = null;

  function setSmsMeta(){
    const el = document.getElementById('smsAutoRefreshMeta');
    if(!el) return;
    const ts = SMS_LAST_CHECKED_AT ? SMS_LAST_CHECKED_AT : '—';
    el.textContent = `Auto-refresh: On • Last checked: ${ts}`;
  }

  async function loadSmsOnly(opts){
    const refreshStatuses = !!(opts && opts.refreshStatuses);

    if(refreshStatuses){
      // ✅ call the light backend refresh (recent + capped)
      await api('/api/sensys/admission-sms/refresh-recent/' + ADMISSION_ID, {
        method:'POST',
        body: JSON.stringify({ max_age_minutes: 120, max_rows: 10 })
      });
    }

    const smsLogs = await api('/api/sensys/admission-sms/' + ADMISSION_ID, { method:'GET' });
    SMS_LOG = (smsLogs && smsLogs.sms) || [];
    renderSms();

    SMS_LAST_CHECKED_AT = new Date().toLocaleTimeString();
    setSmsMeta();
  }

  function stopSmsAutoRefresh(){
    if(SMS_POLL_TIMER){
      clearInterval(SMS_POLL_TIMER);
      SMS_POLL_TIMER = null;
    }
  }

  function startSmsAutoRefresh(){
    stopSmsAutoRefresh();

    // do an immediate lightweight refresh once
    loadSmsOnly({ refreshStatuses:true }).catch(e => console.error('[SENSYS][SMS][AUTO_REFRESH_ERR]', e));

    SMS_POLL_TIMER = setInterval(() => {
      // skip if tab hidden
      if(document.hidden) return;
      loadSmsOnly({ refreshStatuses:true }).catch(e => console.error('[SENSYS][SMS][AUTO_REFRESH_ERR]', e));
    }, SMS_AUTO_REFRESH_MS);
  }


  function escapeHtml(s) {
    return (s || '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
  }

  function renderNoteTemplatesSelect(){
    const sel = document.getElementById('noteTemplateSelect');
    if(!sel) return;

    sel.innerHTML = ['<option value="">Select note type…</option>']
      .concat((NOTE_TEMPLATES || []).map(t => {
        const name = t.template_name || t.name || '';
        return `<option value="${t.id}">${escapeHtml(name)}</option>`;
      }))
      .join('');
  }

  function renderDynamicNoteFieldsForSelectedTemplate(){
    const tplId = document.getElementById('noteTemplateSelect')?.value;
    const wrap = document.getElementById('noteDynamicFields');
    if(!wrap) return;

    wrap.innerHTML = '';
    if(!tplId) return;

    const tpl = (NOTE_TEMPLATES || []).find(x => String(x.id) === String(tplId));
    const fields = (tpl && tpl.fields) ? tpl.fields : [];

    wrap.innerHTML = fields
      .slice()
      .sort((a,b)=> (a.sort_order||0)-(b.sort_order||0))
      .map(f => {
        const key = f.field_key || '';
        const label = f.field_label || key;
        const type = (f.field_type || 'text').toLowerCase();

        // checkbox
        if(type === 'boolean' || type === 'checkbox'){
          return `
            <label style="display:flex;gap:10px;align-items:center;margin-top:10px;font-size:12px;color:#475467;">
              <input type="checkbox" data-note-field-key="${escapeHtml(key)}" />
              <span style="font-weight:800;color:#111827;">${escapeHtml(label)}</span>
            </label>`;
        }

        // date
        if(type === 'date'){
          return `
            <div style="margin-top:10px;">
              <div style="font-size:12px;color:#475467;font-weight:800;margin-bottom:6px;">${escapeHtml(label)}</div>
              <input type="date" data-note-field-key="${escapeHtml(key)}"
                style="width:100%;box-sizing:border-box;padding:10px;border:1px solid #d0d5dd;border-radius:10px;font-size:13px;outline:none;" />
            </div>`;
        }

        // number
        if(type === 'number' || type === 'int' || type === 'float'){
          return `
            <div style="margin-top:10px;">
              <div style="font-size:12px;color:#475467;font-weight:800;margin-bottom:6px;">${escapeHtml(label)}</div>
              <input type="number" data-note-field-key="${escapeHtml(key)}"
                style="width:100%;box-sizing:border-box;padding:10px;border:1px solid #d0d5dd;border-radius:10px;font-size:13px;outline:none;" />
            </div>`;
        }

        // select
        if(type === 'select'){
          let opts = [];
          try { opts = JSON.parse(f.options_json || '[]'); } catch(e) { opts = []; }
          const optionsHtml = ['<option value="">Select…</option>']
            .concat((opts||[]).map(o => `<option value="${escapeHtml(String(o))}">${escapeHtml(String(o))}</option>`))
            .join('');

          return `
            <div style="margin-top:10px;">
              <div style="font-size:12px;color:#475467;font-weight:800;margin-bottom:6px;">${escapeHtml(label)}</div>
              <select data-note-field-key="${escapeHtml(key)}"
                style="width:100%;box-sizing:border-box;padding:10px;border:1px solid #d0d5dd;border-radius:10px;font-size:13px;outline:none;background:#fff;">
                ${optionsHtml}
              </select>
            </div>`;
        }

        // default text
        return `
          <div style="margin-top:10px;">
            <div style="font-size:12px;color:#475467;font-weight:800;margin-bottom:6px;">${escapeHtml(label)}</div>
            <input type="text" data-note-field-key="${escapeHtml(key)}"
              style="width:100%;box-sizing:border-box;padding:10px;border:1px solid #d0d5dd;border-radius:10px;font-size:13px;outline:none;" />
          </div>`;
      })
      .join('');
  }

  // hook change event once
  document.getElementById('noteTemplateSelect')?.addEventListener('change', renderDynamicNoteFieldsForSelectedTemplate);


  function renderTasks() {
    const tb = document.getElementById('tasksTbody');
    const rows = (DETAILS && DETAILS.tasks) || [];
    tb.innerHTML = rows.map(r => {
      return `
        <tr style="border-bottom:1px solid #eef0f5;">
          <td style="padding:10px;font-size:13px;color:#111827;">${escapeHtml(r.task_status || '')}</td>
          <td style="padding:10px;font-size:13px;color:#111827;">${escapeHtml(r.task_name || '')}</td>
          <td style="padding:10px;font-size:13px;color:#111827;">${escapeHtml(String(r.assigned_user_id || ''))}</td>
          <td style="padding:10px;font-size:13px;color:#111827;">${escapeHtml(r.task_comments || '')}</td>
          <td style="padding:10px;text-align:right;">
            <button data-del-task="${r.id}"
              style="padding:7px 10px;border:1px solid #d0d5dd;background:#fff;border-radius:10px;cursor:pointer;font-size:12px;">
              Delete
            </button>
          </td>
        </tr>`;
    }).join('');

    tb.querySelectorAll('[data-del-task]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-del-task');
        try {
          showMsg('');
          await api('/api/sensys/admission-tasks/delete', {
            method:'POST',
            body: JSON.stringify({ id: Number(id) })
          });
          await loadAll();
        } catch(e) { showMsg(e.message); }
      });
    });
  }

  function renderNotes() {
    const tb = document.getElementById('notesTbody');
    const rows = (DETAILS && DETAILS.notes) || [];
    tb.innerHTML = rows.map(r => {
      return `
        <tr style="border-bottom:1px solid #eef0f5;">
          <td style="padding:10px;font-size:13px;color:#111827;">
            ${escapeHtml(r.note_name || '')}${r.note_title ? (' • ' + escapeHtml(r.note_title)) : ''}
          </td>
          <td style="padding:10px;font-size:13px;color:#111827;">
            <div style="font-size:12px;color:#475467;"><b>Status:</b> ${escapeHtml(r.status || '')}</div>
            <div style="margin-top:6px;"><b>R1:</b> ${escapeHtml(r.response1 || '')}</div>
            <div style="margin-top:4px;"><b>R2:</b> ${escapeHtml(r.response2 || '')}</div>
            ${r.note_comments ? (`<div style="margin-top:6px;color:#667085;">${escapeHtml(r.note_comments || '')}</div>`) : ''}
          </td>
          <td style="padding:10px;font-size:12px;color:#667085;">
            ${escapeHtml(r.created_at || '')}${r.created_by_name ? (' • ' + escapeHtml(r.created_by_name)) : ''}
          </td>
          <td style="padding:10px;text-align:right;">
            <button data-del-note="${r.id}"
              style="padding:7px 10px;border:1px solid #d0d5dd;background:#fff;border-radius:10px;cursor:pointer;font-size:12px;">
              Delete
            </button>
          </td>
        </tr>`;
    }).join('');

    tb.querySelectorAll('[data-del-note]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-del-note');
        try {
          showMsg('');
          await api('/api/sensys/admission-notes/delete', {
            method:'POST',
            body: JSON.stringify({ id: Number(id) })
          });
          await loadAll();
        } catch(e) { showMsg(e.message); }
      });
    });
  }

  function renderSms(){
    const tb = document.getElementById('smsTbody');
    if(!tb) return;

    const rows = (SMS_LOG || []);
    tb.innerHTML = rows.map(r => `
      <tr style="border-bottom:1px solid #eef0f5;">
        <td style="padding:10px;font-size:13px;color:#111827;">${escapeHtml(r.to_phone || '')}</td>
        <td style="padding:10px;font-size:13px;color:#111827;">${escapeHtml(r.message || '')}</td>
        <td style="padding:10px;font-size:13px;color:#111827;">${escapeHtml(r.created_at || '')}</td>
        <td style="padding:10px;font-size:13px;color:#111827;">
          ${escapeHtml(r.status || '')}${r.error ? (' • ' + escapeHtml(r.error)) : ''}
        </td>
      </tr>
    `).join('');
  }

  function renderReferralsSelect(){
    const sel = document.getElementById('referralAgencySelect');
    if(!sel) return;

    sel.innerHTML = ['<option value="">Select an agency…</option>']
      .concat((AGENCIES || []).map(a => {
        const label = (a.agency_name || '') + (a.agency_type ? (' — ' + a.agency_type) : '');
        return `<option value="${a.id}">${escapeHtml(label)}</option>`;
      }))
      .join('');
  }

  function renderReferrals(){
    const tb = document.getElementById('referralsTbody');
    if(!tb) return;

    const rows = (DETAILS && DETAILS.referrals) || [];
    tb.innerHTML = rows.map(r => {
      return `
        <tr style="border-bottom:1px solid #eef0f5;">
          <td style="padding:10px;font-size:13px;color:#111827;">${escapeHtml(r.agency_name || '')}</td>
          <td style="padding:10px;font-size:13px;color:#111827;">${escapeHtml(r.agency_type || '')}</td>
          <td style="padding:10px;text-align:right;">
            <button data-del-ref="${r.id}"
              style="padding:7px 10px;border:1px solid #d0d5dd;background:#fff;border-radius:10px;cursor:pointer;font-size:12px;">
              Delete
            </button>
          </td>
        </tr>`;
    }).join('');

    tb.querySelectorAll('[data-del-ref]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-del-ref');
        try{
          showMsg('');
          await api('/api/sensys/admission-referrals/delete', {
            method:'POST',
            body: JSON.stringify({ id: Number(id) })
          });
          await loadAll();
        }catch(e){ showMsg(e.message); }
      });
    });
  }

  function renderAppointmentsSelect(){
    const sel = document.getElementById('apptCareTeamSelect');
    if(!sel) return;

    sel.innerHTML = ['<option value="">Select a care team person…</option>']
      .concat((CARE_TEAM || []).map(c => {
        const label = (c.name || '') + ' — ' + (c.type || '');
        return `<option value="${c.id}">${escapeHtml(label)}</option>`;
      }))
      .join('');
  }

  function renderAppointments(){
    const tb = document.getElementById('apptsTbody');
    if(!tb) return;

    const rows = (DETAILS && DETAILS.appointments) || [];
    tb.innerHTML = rows.map(r => {
      return `
        <tr style="border-bottom:1px solid #eef0f5;">
          <td style="padding:10px;font-size:13px;color:#111827;">${escapeHtml(r.appt_datetime || '')}</td>
          <td style="padding:10px;font-size:13px;color:#111827;">${escapeHtml(r.care_team_name || '')}</td>
          <td style="padding:10px;font-size:13px;color:#111827;">${escapeHtml(r.appt_status || '')}</td>
          <td style="padding:10px;text-align:right;">
            <button data-del-appt="${r.id}"
              style="padding:7px 10px;border:1px solid #d0d5dd;background:#fff;border-radius:10px;cursor:pointer;font-size:12px;">
              Delete
            </button>
          </td>
        </tr>`;
    }).join('');

    tb.querySelectorAll('[data-del-appt]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-del-appt');
        try{
          showMsg('');
          await api('/api/sensys/admission-appointments/delete', {
            method:'POST',
            body: JSON.stringify({ id: Number(id) })
          });
          await loadAll();
        }catch(e){ showMsg(e.message); }
      });
    });
  }

  function prettyBytes(n){
    const x = Number(n || 0);
    if(!x) return '0 B';
    const units = ['B','KB','MB','GB'];
    let v = x, i = 0;
    while(v >= 1024 && i < units.length-1){ v /= 1024; i++; }
    return (v.toFixed(i===0?0:1) + ' ' + units[i]);
  }

  function renderPdfs(){
    const tb = document.getElementById('pdfsTbody');
    if(!tb) return;

    const rows = (PDFS || []);
    tb.innerHTML = rows.map(r => {
      const name = r.original_filename || ('PDF #' + r.id);
      const dl = `/api/sensys/pdfs/${r.id}/download?token=${encodeURIComponent(token())}`;
      return `
        <tr style="border-bottom:1px solid #eef0f5;">
          <td style="padding:10px;font-size:13px;color:#111827;">${escapeHtml(name)}</td>
          <td style="padding:10px;font-size:13px;color:#111827;">${escapeHtml(r.doc_type || '')}</td>
          <td style="padding:10px;font-size:13px;color:#111827;">${escapeHtml(prettyBytes(r.size_bytes))}</td>
          <td style="padding:10px;font-size:12px;color:#667085;">${escapeHtml(r.created_at || '')}</td>
          <td style="padding:10px;font-size:12px;color:#667085;">${escapeHtml(r.expires_at || '—')}</td>
          <td style="padding:10px;text-align:right;">
            <a href="${dl}" target="_blank"
               style="display:inline-block;padding:7px 10px;border:1px solid #d0d5dd;background:#fff;border-radius:10px;cursor:pointer;font-size:12px;text-decoration:none;color:#111827;">
              Download
            </a>
          </td>
        </tr>`;
    }).join('');
  }

  function serviceNameById(id) {
    const s = SERVICES.find(x => Number(x.id) === Number(id));
    return s ? (s.name + ' (' + s.service_type + ')') : ('#' + id);
  }

  function renderDc() {
    const tb = document.getElementById('dcTbody');
    const rows = (DETAILS && DETAILS.dc_submissions) || [];
    tb.innerHTML = rows.map(r => {
      const serviceIds = (r.services || []).map(x => Number(x.services_id));
      const svcLabel = serviceIds.length
        ? serviceIds.map(serviceNameById).join(', ')
        : '—';

      const urgent = Number(r.dc_urgent || 0) === 1 ? ('Yes: ' + (r.urgent_comments || '')) : 'No';

      return `
        <tr style="border-bottom:1px solid #eef0f5;">
          <td style="padding:10px;font-size:13px;color:#111827;">
            ${escapeHtml((r.dc_date || '') + ' ' + (r.dc_time || ''))}
            <div style="font-size:12px;color:#667085;margin-top:2px;">
              Confirmed: ${Number(r.dc_confirmed||0)===1 ? 'Yes' : 'No'} • With: ${escapeHtml(r.dc_with || '')}
            </div>
          </td>
          <td style="padding:10px;font-size:13px;color:#111827;">
            ${escapeHtml(r.dc_destination || '')}
            <div style="font-size:12px;color:#667085;margin-top:2px;">
              ${escapeHtml(r.destination_comments || '')}
            </div>
          </td>
          <td style="padding:10px;font-size:13px;color:#111827;">${escapeHtml(urgent)}</td>
          <td style="padding:10px;font-size:13px;color:#111827;">
            ${escapeHtml(svcLabel)}
            <div style="margin-top:6px;">
              <button data-edit-services="${r.id}"
                style="padding:7px 10px;border:1px solid #d0d5dd;background:#fff;border-radius:10px;cursor:pointer;font-size:12px;">
                Edit services
              </button>
            </div>
          </td>
          <td style="padding:10px;text-align:right;">
            <button data-del-dc="${r.id}"
              style="padding:7px 10px;border:1px solid #d0d5dd;background:#fff;border-radius:10px;cursor:pointer;font-size:12px;">
              Delete
            </button>
          </td>
        </tr>`;
    }).join('');

    tb.querySelectorAll('[data-del-dc]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-del-dc');
        try {
          showMsg('');
          await api('/api/sensys/admission-dc-submissions/delete', {
            method:'POST',
            body: JSON.stringify({ id: Number(id) })
          });
          await loadAll();
        } catch(e) { showMsg(e.message); }
      });
    });

    tb.querySelectorAll('[data-edit-services]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const submissionId = Number(btn.getAttribute('data-edit-services'));
        const row = rows.find(x => Number(x.id) === submissionId);
        const current = new Set(((row && row.services) || []).map(x => Number(x.services_id)));

        // simple prompt-based multi-select
        const lines = SERVICES.map(s => {
          const on = current.has(Number(s.id)) ? '[x]' : '[ ]';
          return `${on} ${s.id}: ${s.name} (${s.service_type})`;
        }).join('\n');

        const input = prompt(
          'Select services for DC Submission #' + submissionId + '\n\n' +
          'Copy/paste the service IDs you want, comma-separated.\n\n' +
          lines + '\n\nExample: 1,2,5'
        );

        if (input === null) return;

        const ids = input.split(',').map(x => Number((x||'').trim())).filter(x => Number.isFinite(x) && x > 0);

        try {
          showMsg('');
          await api('/api/sensys/dc-submission-services/set', {
            method:'POST',
            body: JSON.stringify({
              admission_dc_submission_id: submissionId,
              services_ids: ids
            })
          });
          await loadAll();
        } catch(e) { showMsg(e.message); }
      });
    });
  }

  function renderCareTeamSelect() {
    const sel = document.getElementById('careTeamSelect');
    sel.innerHTML = ['<option value="">Select a care team person…</option>']
      .concat(CARE_TEAM.map(c => {
        const label = (c.name || '') + ' — ' + (c.type || '');
        return `<option value="${c.id}">${escapeHtml(label)}</option>`;
      }))
      .join('');
  }

  function renderDcServicesMulti(){
    const el = document.getElementById("dcServicesMulti");
    const opts = ['']
      .concat((SERVICES || []).map(s => {
        const label = `${s.name || ''} (${(s.service_type || '').toUpperCase()})`;
        return `<option value="${s.id}">${escapeHtml(label)}</option>`;
      }));
    el.innerHTML = opts.join('');
  }

  function renderCareTeamLinked() {
    const tb = document.getElementById('careTeamTbody');
    const rows = (DETAILS && DETAILS.care_team) || [];
    tb.innerHTML = rows.map(r => {
      return `
        <tr style="border-bottom:1px solid #eef0f5;">
          <td style="padding:10px;font-size:13px;color:#111827;">${escapeHtml(r.name || '')}</td>
          <td style="padding:10px;font-size:13px;color:#111827;">${escapeHtml(r.type || '')}</td>
          <td style="padding:10px;font-size:13px;color:#111827;">${escapeHtml(r.phone1 || r.phone2 || '')}</td>
          <td style="padding:10px;font-size:13px;color:#111827;">${escapeHtml(r.email1 || r.email2 || '')}</td>
          <td style="padding:10px;text-align:right;">
            <button data-unlink-ct="${r.link_id}"
              style="padding:7px 10px;border:1px solid #d0d5dd;background:#fff;border-radius:10px;cursor:pointer;font-size:12px;">
              Unlink
            </button>
          </td>
        </tr>`;
    }).join('');

    tb.querySelectorAll('[data-unlink-ct]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const linkId = Number(btn.getAttribute('data-unlink-ct'));
        try {
          showMsg('');
          await api('/api/sensys/admission-care-team/unlink', {
            method:'POST',
            body: JSON.stringify({ id: linkId })
          });
          await loadAll();
        } catch(e) { showMsg(e.message); }
      });
    });
  }

  function renderHeader() {
    const a = DETAILS && DETAILS.admission;
    if (!a) return;
    document.getElementById('admissionIdTag').textContent = String(a.id || '');
    document.getElementById('patientName').textContent = a.patient_name || '—';
    document.getElementById('metaLine').textContent =
      (a.agency_name ? ('Agency: ' + a.agency_name + ' • ') : '') +
      (a.patient_dob ? ('DOB: ' + a.patient_dob + ' • ') : '') +
      ('Admit: ' + (a.admit_date || '—') + ' • DC: ' + (a.dc_date || '—')) +
      (a.room ? (' • Room: ' + a.room) : '');

    document.getElementById('subhead').textContent =
      (a.reason ? ('Reason: ' + a.reason) : 'View and edit tasks, notes, DC submissions, services, and care team.');
  }

  async function loadAll() {
    showMsg('');
    const [details, services, careTeam, agencies, noteTemplates, smsLogs, pdfsResp] = await Promise.all([
      api('/api/sensys/admission-details/' + ADMISSION_ID, { method:'GET' }),
      api('/api/sensys/services', { method:'GET' }),
      api('/api/sensys/care-team', { method:'GET' }),
      api('/api/sensys/agencies', { method:'GET' }),
      api('/api/sensys/note-templates', { method:'GET' }),
      api('/api/sensys/admission-sms/' + ADMISSION_ID, { method:'GET' }),
      api('/api/sensys/admissions/' + ADMISSION_ID + '/pdfs', { method:'GET' }).catch(() => ({ pdfs: [] }))
    ]);

    DETAILS = details;
    SERVICES = (services && services.services) || [];
    CARE_TEAM = (careTeam && careTeam.care_team) || [];
    AGENCIES = (agencies && agencies.agencies) || []; // ✅ NEW
    
    NOTE_TEMPLATES = (noteTemplates && noteTemplates.templates) || [];
    renderNoteTemplatesSelect();
    renderDynamicNoteFieldsForSelectedTemplate();
    SMS_LOG = (smsLogs && smsLogs.sms) || [];
    PDFS = (pdfsResp && pdfsResp.pdfs) || [];

    renderHeader();
    renderTasks();
    renderNotes();
    renderSms();
    renderDc();
    renderDcServicesMulti();
    renderReferralsSelect();
    renderReferrals();
    renderAppointmentsSelect();
    renderAppointments();
    renderPdfs();              // ✅ NEW
    renderCareTeamSelect();
    renderCareTeamLinked();

    // ✅ NEW: start the lightweight SMS polling after initial data load
    setSmsMeta();
    startSmsAutoRefresh();
    }


  document.getElementById('sendSmsBtn')?.addEventListener('click', async () => {
    try{
      showMsg('');
      const to_phone = document.getElementById('smsToPhone').value.trim();
      const text = document.getElementById('smsText').value.trim();

      if(!to_phone) throw new Error("SMS not sent: missing To phone.");
      if(!text) throw new Error("SMS not sent: missing message text.");
      if(!ADMISSION_ID) throw new Error("SMS not sent: missing ADMISSION_ID.");

      console.log('[SENSYS][SMS][SUBMIT]', { admission_id: Number(ADMISSION_ID), to_phone, text_len: text.length });

      const resp = await api('/api/sensys/admission-sms/send', {
        method:'POST',
        body: JSON.stringify({
          admission_id: Number(ADMISSION_ID),
          to_phone,
          text
        })
      });

      console.log('[SENSYS][SMS][SENT]', resp);
      showMsg(`SMS sent • sms_log_id=${resp.id} • rc_message_id=${resp.message_id}`);

      document.getElementById('smsText').value = '';
      await loadAll();

    }catch(e){
      showMsg(e.message || 'SMS not sent.');
    }
  });

  document.getElementById('refreshBtn').addEventListener('click', () => loadAll().catch(e => showMsg(e.message)));

  document.getElementById('uploadPdfBtn')?.addEventListener('click', async () => {
    try{
      showMsg('');

      if(!ADMISSION_ID) throw new Error("PDF not uploaded: missing ADMISSION_ID.");

      const f = document.getElementById('pdfFile').files[0];
      if(!f) throw new Error("Select a PDF file first.");

      const docType = (document.getElementById('pdfDocType').value || 'pdf').trim();
      const retention = (document.getElementById('pdfRetentionHours').value || '').trim();

      const fd = new FormData();
      fd.append('doc_type', docType);
      fd.append('retention_hours', retention ? retention : '0');
      fd.append('file', f);

      const resp = await apiForm('/api/sensys/admissions/' + ADMISSION_ID + '/pdfs/upload', fd);

      showMsg(`PDF uploaded • pdf_id=${resp.pdf_id}`); 
      document.getElementById('pdfFile').value = '';
      await loadAll();
    }catch(e){
      showMsg(e.message || 'PDF upload failed.');
    }
  });

  // ✅ NEW: manual SMS-only refresh (does NOT reload whole page)
  document.getElementById('smsRefreshBtn')?.addEventListener('click', async () => {
    try {
      showMsg('');
      await loadSmsOnly({ refreshStatuses:true });
    } catch(e) {
      showMsg(e.message || 'SMS refresh failed.');
    }
  });

  // ✅ NEW: auto polling start + visibility pause
  document.addEventListener('visibilitychange', () => {
    if(document.hidden){
      stopSmsAutoRefresh();
    } else {
      startSmsAutoRefresh();
    }
  });


  document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.removeItem('sensys_token');
    window.location.href = '/sensys/login';
  });

  document.getElementById('backBtn').addEventListener('click', () => {
    window.location.href = '/sensys/snf-sw';
  });

  document.getElementById('addReferralBtn')?.addEventListener('click', async () => {
    const endpoint = '/api/sensys/admission-referrals/upsert';

    try{
      showMsg('');

      const agencyId = document.getElementById('referralAgencySelect').value;
      if(!agencyId) throw new Error("Referral not saved: please select an agency first.");

      if(!ADMISSION_ID) throw new Error("Referral not saved: missing ADMISSION_ID on page.");

      console.log('[SENSYS][REFERRAL][SUBMIT]', { admission_id: Number(ADMISSION_ID), agency_id: Number(agencyId) });

      const resp = await api(endpoint, {
        method:'POST',
        body: JSON.stringify({
          admission_id: Number(ADMISSION_ID),
          agency_id: Number(agencyId)
        })
      });

      console.log('[SENSYS][REFERRAL][SAVED]', resp);
      showMsg(`Referral saved (id ${resp.id}) • verify=${resp.verify_exists} • db=${resp.db_file}`);

      document.getElementById('referralAgencySelect').value = '';
      await loadAll();
    }catch(e){
      console.error('[SENSYS][REFERRAL][ERROR]', endpoint, e);
      showMsg((e && e.message ? e.message : 'Referral not saved due to an unknown error.') + " (Referrals)");
    }
  });


  document.getElementById('addApptBtn')?.addEventListener('click', async () => {
    try{
      showMsg('');
      const careTeamId = document.getElementById('apptCareTeamSelect').value;
      const dt = document.getElementById('apptDatetime').value;
      const st = document.getElementById('apptStatus').value;

      if(!dt) throw new Error("Select an appointment date/time first.");

      await api('/api/sensys/admission-appointments/upsert', {
        method:'POST',
        body: JSON.stringify({
          admission_id: Number(ADMISSION_ID),
          appt_datetime: dt,
          care_team_id: careTeamId ? Number(careTeamId) : null,
          appt_status: st
        })
      });

      document.getElementById('apptCareTeamSelect').value = '';
      document.getElementById('apptDatetime').value = '';
      document.getElementById('apptStatus').value = 'New';
      await loadAll();
    }catch(e){ showMsg(e.message); }
  });

  document.getElementById('addTaskBtn').addEventListener('click', async () => {
    try {
      showMsg('');
      const payload = {
        admission_id: Number(ADMISSION_ID),
        assigned_user_id: document.getElementById('taskAssignedUser').value.trim() || null,
        task_status: document.getElementById('taskStatus').value,
        task_name: document.getElementById('taskName').value.trim(),
        task_comments: document.getElementById('taskComments').value.trim()
      };
      await api('/api/sensys/admission-tasks/upsert', { method:'POST', body: JSON.stringify(payload) });
      document.getElementById('taskName').value = '';
      document.getElementById('taskComments').value = '';
      document.getElementById('taskAssignedUser').value = '';
      await loadAll();
    } catch(e) { showMsg(e.message); }
  });

  document.getElementById('addNoteBtn').addEventListener('click', async () => {
    try {
      showMsg('');

      const tplIdRaw = document.getElementById('noteTemplateSelect').value;
      const template_id = tplIdRaw ? Number(tplIdRaw) : null;

      // collect dynamic template answers
      const answers = {};
      document.querySelectorAll('[data-note-field-key]').forEach(el => {
        const k = el.getAttribute('data-note-field-key');
        if (!k) return;

        if (el.type === 'checkbox') {
          answers[k] = el.checked ? 1 : 0;
        } else {
          answers[k] = (el.value ?? '').toString().trim();
        }
      });

      const payload = {
        admission_id: Number(ADMISSION_ID),

        // template + common fast fields
        note_template_id: template_id,
        note_name: document.getElementById('noteName').value.trim(),          // keep for now (legacy label)
        note_title: document.getElementById('noteTitle').value.trim(),
        status: document.getElementById('noteStatus').value,
        response1: document.getElementById('noteResponse1').value.trim(),
        response2: document.getElementById('noteResponse2').value.trim(),

        // keep legacy free text too (optional)
        note_comments: document.getElementById('noteComments').value.trim(),

        // template answers
        answers: answers
      };

      await api('/api/sensys/admission-notes/upsert', { method:'POST', body: JSON.stringify(payload) });

      // clear
      document.getElementById('noteName').value = '';
      document.getElementById('noteTitle').value = '';
      document.getElementById('noteStatus').value = 'New';
      document.getElementById('noteResponse1').value = '';
      document.getElementById('noteResponse2').value = '';
      document.getElementById('noteComments').value = '';
      document.getElementById('noteTemplateSelect').value = '';

      // clear dynamic fields
      document.getElementById('noteDynamicFields').innerHTML = '';

      await loadAll();
    } catch(e) { showMsg(e.message); }
  });

  document.getElementById('addDcBtn').addEventListener('click', async () => {
    try {
      showMsg('');
      const payload = {
        admission_id: Number(ADMISSION_ID),
        dc_date: document.getElementById('dcDate').value.trim(),
        dc_time: document.getElementById('dcTime').value.trim(),
        dc_confirmed: document.getElementById('dcConfirmed').checked ? 1 : 0,
        dc_urgent: document.getElementById('dcUrgent').checked ? 1 : 0,
        urgent_comments: document.getElementById('urgentComments').value.trim(),
        dc_destination: document.getElementById('dcDestination').value,
        destination_comments: document.getElementById('destinationComments').value.trim(),
        dc_with: document.getElementById('dcWith').value
      };
      const resp = await api('/api/sensys/admission-dc-submissions/upsert', {
        method:'POST',
        body: JSON.stringify(payload)
      });

      const submissionId = resp && resp.id ? Number(resp.id) : null;

      // ✅ write join table from the multi-select
      const selectedServiceIds = Array.from(document.getElementById("dcServicesMulti").selectedOptions)
        .map(o => Number(o.value))
        .filter(n => Number.isFinite(n) && n > 0);

      if(submissionId){
        await api('/api/sensys/dc-submission-services/set', {
          method:'POST',
          body: JSON.stringify({
            admission_dc_submission_id: submissionId,
            services_ids: selectedServiceIds
          })
        });
      }

      document.getElementById('dcDate').value = '';
      document.getElementById('dcTime').value = '';
      document.getElementById('dcConfirmed').checked = false;
      document.getElementById('dcUrgent').checked = false;
      document.getElementById('urgentComments').value = '';
      document.getElementById('destinationComments').value = '';
      document.getElementById('dcServicesMulti').selectedIndex = -1; // ✅ clear selection

      await loadAll();
    } catch(e) { showMsg(e.message); }
  });

  document.getElementById('addCareTeamBtn').addEventListener('click', async () => {
    try {
      showMsg('');
      const careTeamId = document.getElementById('careTeamSelect').value;
      if (!careTeamId) throw new Error("Select a care team person first.");
      await api('/api/sensys/admission-care-team/link', {
        method:'POST',
        body: JSON.stringify({ admission_id: Number(ADMISSION_ID), care_team_id: Number(careTeamId) })
      });
      document.getElementById('careTeamSelect').value = '';
      await loadAll();
    } catch(e) { showMsg(e.message); }
  });

  (async function init(){
    try {
      ADMISSION_ID = Number(qs('admission_id') || '');
      if (!ADMISSION_ID) throw new Error("Missing admission_id in URL.");
      document.getElementById('admissionIdTag').textContent = String(ADMISSION_ID);
      await loadAll();
    } catch(e) {
      showMsg(e.message);
    }
  })();
</script>

</body>
</html>
