<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sensys - SNF SW</title>
</head>
<body style="margin:0;font-family:Arial,Helvetica,sans-serif;background:#f6f7fb;">
  <div style="max-width:1050px;margin:0 auto;padding:18px;">
    <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;">
      <div>
        <div style="font-size:18px;font-weight:800;">SNF SW</div>
        <div style="font-size:12px;color:#667085;margin-top:4px;">
          Test page: shows admissions linked to your user (via assigned agencies).
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button id="logoutBtn"
          style="padding:8px 10px;border:1px solid #d0d5dd;background:#fff;border-radius:10px;cursor:pointer;font-size:12px;">
          Log out
        </button>
      </div>
    </div>

    <div style="margin-top:14px;background:#fff;border:1px solid #e6e8ef;border-radius:14px;padding:14px;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
        <div style="font-size:13px;color:#111827;font-weight:700;">My Admissions</div>
        <div id="userTag" style="font-size:12px;color:#667085;"></div>
      </div>

      <div style="margin-top:10px;display:flex;gap:10px;align-items:center;">
        <input id="q" placeholder="Search patient / agency / dates..."
          style="flex:1;box-sizing:border-box;padding:10px 10px;border:1px solid #d0d5dd;border-radius:10px;font-size:13px;outline:none;" />
        <button id="refreshBtn"
          style="padding:10px 12px;border:0;border-radius:10px;background:#111827;color:#fff;font-size:13px;font-weight:700;cursor:pointer;">
          Refresh
        </button>
      </div>

      <div id="msg" style="margin-top:10px;font-size:12px;color:#b42318;display:none;"></div>

      <div style="margin-top:10px;overflow:auto;border:1px solid #eef0f5;border-radius:12px;">
        <table style="width:100%;border-collapse:collapse;min-width:820px;">
          <thead>
            <tr style="background:#f9fafb;border-bottom:1px solid #eef0f5;">
              <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">Patient</th>
              <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">DOB</th>
              <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">Agency</th>
              <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">Admit</th>
              <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">DC</th>
              <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">Room</th>
              <th style="text-align:left;padding:10px;font-size:12px;color:#475467;">Active</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div id="count" style="margin-top:10px;font-size:12px;color:#667085;"></div>
    </div>
    <!-- ✅ NEW: Notifications card -->
    <div style="margin-top:14px;background:#fff;border:1px solid #e6e8ef;border-radius:14px;padding:14px;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
        <div style="font-size:13px;color:#111827;font-weight:800;">
          Notifications
          <span id="notifCount" style="margin-left:8px;font-size:12px;color:#667085;font-weight:700;"></span>
        </div>
        <button id="notifRefreshBtn"
          style="padding:10px 12px;border:0;border-radius:10px;background:#111827;color:#fff;font-size:13px;font-weight:700;cursor:pointer;">
          Refresh
        </button>
      </div>

      <div id="notifMsg" style="margin-top:10px;font-size:12px;color:#b42318;display:none;"></div>
      <div id="notifList" style="margin-top:10px;display:flex;flex-direction:column;gap:10px;"></div>
    </div>
  </div>

<script>
(function(){
  const tbody = document.getElementById('tbody');
  const msg = document.getElementById('msg');
  const q = document.getElementById('q');
  const refreshBtn = document.getElementById('refreshBtn');
  const userTag = document.getElementById('userTag');
  const count = document.getElementById('count');
  const logoutBtn = document.getElementById('logoutBtn');

  let allRows = [];

  let NOTIFS = [];

  function showNotifError(t){
    const el = document.getElementById('notifMsg');
    if(!el) return;
    if(!t){ el.style.display='none'; el.textContent=''; return; }
    el.style.display='block';
    el.textContent = t || 'Error';
  }

  async function apiPost(url, payload){
    const resp = await fetch(url, {
      method:'POST',
      headers: Object.assign({ 'Content-Type':'application/json' }, authHeaders()),
      body: JSON.stringify(payload || {})
    });
    if(!resp.ok){
      const t = await resp.text().catch(()=> '');
      throw new Error(t || ('Request failed: ' + resp.status));
    }
    return await resp.json();
  }

  function esc(s){
    return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function renderNotifs(){
    const host = document.getElementById('notifList');
    const badge = document.getElementById('notifCount');
    if(!host) return;

    const unread = (NOTIFS || []).filter(n => !n.read_at).length;
    if(badge) badge.textContent = unread ? (`${unread} unread`) : ('0 unread');

    if(!NOTIFS.length){
      host.innerHTML = `<div style="font-size:12px;color:#667085;">No notifications.</div>`;
      return;
    }

    host.innerHTML = '';
    NOTIFS.forEach(n => {
      const card = document.createElement('div');
      card.style.border = '1px solid #eef0f5';
      card.style.borderRadius = '12px';
      card.style.padding = '12px';
      card.style.background = n.read_at ? '#fbfcfe' : '#ffffff';

      card.innerHTML = `
        <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;">
          <div>
            <div style="font-size:13px;font-weight:800;color:#111827;">${esc(n.title || n.notif_name || n.notif_key || 'Notification')}</div>
            <div style="margin-top:4px;font-size:12px;color:#475467;white-space:pre-wrap;">${esc(n.body || '')}</div>
            <div style="margin-top:8px;font-size:11px;color:#667085;">${esc(n.created_at || '')}</div>
          </div>
          <div>
            ${n.read_at ? `<span style="font-size:11px;color:#667085;font-weight:700;">Read</span>` : `<button data-id="${esc(n.id)}"
              style="padding:8px 10px;border:1px solid #d0d5dd;background:#fff;border-radius:10px;cursor:pointer;font-size:12px;font-weight:700;">
              Mark read
            </button>`}
          </div>
        </div>
      `;

      const btn = card.querySelector('button[data-id]');
      if(btn){
        btn.onclick = async () => {
          try{
            btn.disabled = true;
            await apiPost('/api/sensys/notifications/mark-read', { id: Number(n.id) });
            await loadNotifs();
          }catch(e){
            showNotifError(e.message || String(e));
          }finally{
            btn.disabled = false;
          }
        };
      }

      host.appendChild(card);
    });
  }

  async function loadNotifs(){
    try{
      showNotifError('');
      const res = await fetch('/api/sensys/my-notifications', { headers: authHeaders() });
      const data = await res.json();
      if(!res.ok || !data.ok){
        showNotifError((data && data.detail) ? data.detail : 'Failed to load notifications');
        return;
      }
      NOTIFS = data.notifications || [];
      renderNotifs();
    }catch(e){
      showNotifError('Network error');
    }
  }

  function token(){
    return (localStorage.getItem('sensys_token') || '').trim();
  }

  function authHeaders(){
    return { 'Authorization': 'Bearer ' + token() };
  }

  function showError(t){
    msg.style.display = 'block';
    msg.textContent = t || 'Error';
  }

  function clearError(){
    msg.style.display = 'none';
    msg.textContent = '';
  }

  function safe(v){ return (v === null || v === undefined) ? '' : String(v); }

  function render(rows){
    tbody.innerHTML = '';
    for(const r of rows){
      const tr = document.createElement('tr');
      tr.style.borderBottom = '1px solid #eef0f5';

      tr.innerHTML = `
        <td style="padding:10px;font-size:13px;color:#111827;"><b>${safe(r.patient_name)}</b></td>
        <td style="padding:10px;font-size:13px;color:#111827;">${safe(r.patient_dob)}</td>
        <td style="padding:10px;font-size:13px;color:#111827;">${safe(r.agency_name)}</td>
        <td style="padding:10px;font-size:13px;color:#111827;">${safe(r.admit_date)}</td>
        <td style="padding:10px;font-size:13px;color:#111827;">${safe(r.dc_date)}</td>
        <td style="padding:10px;font-size:13px;color:#111827;">${safe(r.room)}</td>
        <td style="padding:10px;font-size:13px;color:#111827;">${(r.active ? 'Yes' : 'No')}</td>
      `;

      // ✅ click row to open Admission Details (new page)
      tr.style.cursor = "pointer";
      tr.addEventListener("click", () => {
        if(!r.id) return;
        window.location.href = "/sensys/admission-details?admission_id=" + encodeURIComponent(String(r.id));
      });

      tbody.appendChild(tr);
    }

    count.textContent = rows.length ? (rows.length + ' admissions') : 'No admissions found.';
  }

  function applyFilter(){
    const s = (q.value || '').trim().toLowerCase();
    if(!s){
      render(allRows);
      return;
    }
    const filtered = allRows.filter(r => {
      const blob = [
        r.patient_name, r.patient_dob, r.agency_name,
        r.admit_date, r.dc_date, r.room
      ].map(safe).join(' ').toLowerCase();
      return blob.includes(s);
    });
    render(filtered);
  }

  async function load(){
    clearError();

    if(!token()){
      window.location.href = '/sensys/login';
      return;
    }

    refreshBtn.disabled = true;
    refreshBtn.textContent = 'Loading...';

    try{
      // who am I
      const meRes = await fetch('/api/sensys/me', { headers: authHeaders() });
      const meData = await meRes.json();
      if(!meRes.ok || !meData.ok){
        localStorage.removeItem('sensys_token');
        window.location.href = '/sensys/login';
        return;
      }

      const u = meData.user || {};
      userTag.textContent = (u.display_name ? u.display_name + ' — ' : '') + (u.email || '');

      // admissions
      const res = await fetch('/api/sensys/my-admissions', { headers: authHeaders() });
      const data = await res.json();
      if(!res.ok || !data.ok){
        showError((data && data.detail) ? data.detail : 'Failed to load admissions');
        return;
      }

      allRows = data.admissions || [];
      applyFilter();
    }catch(e){
      showError('Network error');
    }finally{
      refreshBtn.disabled = false;
      refreshBtn.textContent = 'Refresh';
    }
  }

  refreshBtn.addEventListener('click', load);
  q.addEventListener('input', applyFilter);

  logoutBtn.addEventListener('click', function(){
    localStorage.removeItem('sensys_token');
    window.location.href = '/sensys/login';
  });

  const notifRefreshBtn = document.getElementById('notifRefreshBtn');
  if(notifRefreshBtn) notifRefreshBtn.addEventListener('click', loadNotifs);

  load();
  loadNotifs();
})();
</script>
</body>
</html>
