<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sensys — Post-Discharge Workspace</title>
  <style>
    body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:#f6f7fb; color:#111; }
    .topbar{ display:flex; align-items:center; justify-content:space-between; padding:14px 18px; background:#fff; border-bottom:1px solid #e6e7ee; }
    .wrap{ padding:16px; }
    .grid{ display:grid; grid-template-columns: 2fr 1fr; gap:14px; }
    .card{ background:#fff; border:1px solid #e6e7ee; border-radius:14px; box-shadow: 0 1px 0 rgba(0,0,0,.03); }
    .cardHd{ padding:12px 14px; border-bottom:1px solid #eef0f6; display:flex; align-items:center; justify-content:space-between; }
    .cardBd{ padding:12px 14px; }
    .tabs{ display:flex; gap:8px; }
    .tab{ padding:8px 10px; border-radius:999px; border:1px solid #e6e7ee; background:#fff; cursor:pointer; font-size:13px; }
    .tab.active{ background:#111; color:#fff; border-color:#111; }
    table{ width:100%; border-collapse:collapse; font-size:13px; }
    th, td{ padding:10px 8px; border-bottom:1px solid #eef0f6; text-align:left; vertical-align:top; }
    th{ font-size:12px; color:#444; }
    .muted{ color:#666; font-size:12px; }
    .rowBtns button{ padding:6px 8px; border-radius:10px; border:1px solid #e6e7ee; background:#fff; cursor:pointer; font-size:12px; }
    .rowBtns button:hover{ background:#f3f4f8; }
    .pill{ display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid #e6e7ee; font-size:12px; background:#fff; }
    .rightPlaceholder{ min-height:240px; display:flex; align-items:center; justify-content:center; color:#777; }
    .msg{ margin-top:10px; font-size:12px; color:#b00020; }
    .ok{ color:#0a7a2f; }
  </style>
</head>
<body>

<div class="topbar">
  <div>
    <div style="font-weight:700;">Post-Discharge Workspace</div>
    <div class="muted">PDW v1 — Work Items + Attempts Log</div>
  </div>
  <div style="display:flex; gap:10px; align-items:center;">
    <button onclick="openStaffSchedules()" style="padding:8px 10px;border-radius:10px;border:1px solid #e6e7ee;background:#fff;cursor:pointer;">
      Staff Schedules
    </button>
    <button onclick="logout()" style="padding:8px 10px;border-radius:10px;border:1px solid #e6e7ee;background:#fff;cursor:pointer;">Logout</button>
  </div>
</div>

<div class="wrap">
  <div class="grid">
    <!-- LEFT: Work Items (2/3) -->
    <div class="card">
      <div class="cardHd">
        <div style="font-weight:700;">Work Items</div>
        <div class="tabs">
          <button class="pill" style="margin-left:8px;" onclick="openSortFilter()">Sort / Filter</button>
          <button class="tab active" id="tabUnassigned" onclick="setBucket('unassigned')">Unassigned</button>
          <button class="tab" id="tabIncomplete" onclick="setBucket('incomplete')">Incomplete</button>
          <button class="tab" id="tabCompleted" onclick="setBucket('completed')">Completed</button>
        </div>
      </div>

      <div class="cardBd">

        <!-- ✅ Top summary mini cards -->
        <div id="summaryRow" style="display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-bottom:10px;">
          <div class="pill" style="padding:10px 12px; border-radius:14px;">
            <div class="muted" style="font-size:11px;">Unassigned Calls</div>
            <div style="font-weight:800; font-size:16px;" id="sumUnassigned">—</div>
          </div>
          <div class="pill" style="padding:10px 12px; border-radius:14px;">
            <div class="muted" style="font-size:11px;">Total Due Today</div>
            <div style="font-weight:800; font-size:16px;" id="sumDueToday">—</div>
          </div>
          <div class="pill" style="padding:10px 12px; border-radius:14px;">
            <div class="muted" style="font-size:11px;">Completed Today</div>
            <div style="font-weight:800; font-size:16px;" id="sumCompleted">—</div>
          </div>
          <div class="pill" style="padding:10px 12px; border-radius:14px;">
            <div class="muted" style="font-size:11px;">Incomplete Today</div>
            <div style="font-weight:800; font-size:16px;" id="sumIncomplete">—</div>
          </div>
        </div>

        <div class="muted" id="bucketHelp"></div>

        <div style="overflow:auto; margin-top:10px;">
          <table>
            <thead>
              <tr>
                <th>Patient</th>
                <th>Days Since DC</th>
                <th>Task</th>
                <th>Due</th>
                <th>Assign</th>
                <th></th> <!-- ✅ reserved for future icon buttons -->
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div id="msg" class="msg"></div>
      </div>
    </div>

    <!-- RIGHT: Placeholder (1/3) -->
    <div class="card">
      <div class="cardHd">
        <div style="font-weight:700;">Staff Availability</div>
        <div style="display:flex; gap:8px; align-items:center;">
          <span class="muted">Available Day</span>
          <select id="availDay" onchange="loadStaffAvailability()" style="padding:8px 10px;border-radius:10px;border:1px solid #e6e7ee;background:#fff;">
            <option value="0">Today</option>
            <option value="1">1 day out</option>
            <option value="2">2 days out</option>
            <option value="3">3 days out</option>
            <option value="4">4 days out</option>
            <option value="5">5 days out</option>
          </select>
        </div>
      </div>
      <div class="cardBd">
        <div id="staffAvailList" style="display:grid; gap:10px;"></div>
      </div>
    </div>
  </div>
</div>
<!-- ✅ Assign Modal -->
<div id="assignModalBg" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); align-items:center; justify-content:center; padding:18px; z-index:50;">
  <div style="width:min(860px, 96vw); background:#fff; border:1px solid #e6e7ee; border-radius:14px; overflow:hidden;">
    <div class="cardHd">
      <div>
        <div style="font-weight:800;">Assign Work Item</div>
        <div class="muted" id="assignSub">—</div>
      </div>
      <button class="pill" onclick="closeAssignModal()">Close</button>
    </div>

    <div class="cardBd">
      <div style="display:grid; grid-template-columns: 1.2fr .8fr; gap:14px;">
        <div>
          <div class="muted" style="margin-bottom:8px;">CCC Staff</div>
          <div id="assignStaffList" style="display:grid; gap:8px;"></div>
        </div>

        <div>
          <div class="muted" style="margin-bottom:8px;">Assignment Notes</div>
          <textarea id="assignNotes" placeholder="Add notes for staff…" style="width:100%; min-height:160px; border-radius:12px; border:1px solid #e6e7ee; padding:10px; font-size:13px;"></textarea>

          <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:10px;">
            <button class="pill" onclick="closeAssignModal()">Cancel</button>
            <button class="pill" style="border-color:#111; background:#111; color:#fff;" onclick="submitAssign()">Assign</button>
          </div>

          <div class="msg" id="assignMsg" style="margin-top:8px;"></div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- ✅ Staff Schedules Modal -->
<div id="staffSchedBg" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,35); align-items:center; justify-content:center; padding:18px; z-index:60;">
  <div style="width:min(980px, 96vw); background:#fff; border:1px solid #e6e7ee; border-radius:14px; overflow:hidden;">
    <div class="cardHd">
      <div>
        <div style="font-weight:800;">Staff Schedules</div>
        <div class="muted" style="margin-top:2px;">Edit CCC Staff capacity + schedules (days / start-stop). Last login is displayed.</div>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button onclick="closeStaffSchedules()" style="padding:8px 10px;border-radius:10px;border:1px solid #e6e7ee;background:#fff;cursor:pointer;">Close</button>
      </div>
    </div>

    <div class="cardBd">
      <div class="muted" id="staffSchedMsg" style="margin-bottom:10px;"></div>

      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>CCC Staff</th>
              <th>Last Login</th>
              <th>Calls / Hr</th>
              <th>Schedules</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="staffSchedTbody"></tbody>
        </table>
      </div>

      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:12px;">
        <button onclick="saveStaffSchedules()" style="padding:10px 12px;border-radius:12px;border:1px solid #111;background:#111;color:#fff;cursor:pointer;">Save Changes</button>
      </div>
    </div>
  </div>
</div>
<!-- ✅ Sort/Filter Modal -->
<div id="sfBg" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,35); align-items:center; justify-content:center; padding:18px; z-index:55;">
  <div style="width:min(720px, 96vw); background:#fff; border:1px solid #e6e7ee; border-radius:14px; overflow:hidden;">
    <div class="cardHd" style="display:flex; justify-content:space-between; align-items:center;">
      <div>
        <div style="font-weight:800;">Sort &amp; Filter</div>
        <div class="muted" style="margin-top:2px;">Affects the current tab list only.</div>
      </div>
      <button class="pill" onclick="closeSortFilter()">Close</button>
    </div>

    <div class="cardBd" style="display:grid; gap:12px;">
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
        <div>
          <div class="muted" style="margin-bottom:6px;">Sort</div>
          <select id="sfSort" style="width:100%; padding:10px; border-radius:12px; border:1px solid #e6e7ee;">
            <option value="due_at">Due Date</option>
            <option value="patient">Patient</option>
            <option value="agency">Agency</option>
            <option value="dc_date">DC Date</option>
          </select>
        </div>

        <div>
          <div class="muted" style="margin-bottom:6px;">Assigned Staff</div>
          <select id="sfStaff" style="width:100%; padding:10px; border-radius:12px; border:1px solid #e6e7ee;">
            <option value="">All</option>
          </select>
        </div>

        <div>
          <div class="muted" style="margin-bottom:6px;">Agency</div>
          <select id="sfAgency" style="width:100%; padding:10px; border-radius:12px; border:1px solid #e6e7ee;">
            <option value="">All</option>
          </select>
        </div>

        <div>
          <div class="muted" style="margin-bottom:6px;">Task Type</div>
          <select id="sfTask" style="width:100%; padding:10px; border-radius:12px; border:1px solid #e6e7ee;">
            <option value="">All</option>
          </select>
        </div>
      </div>

      <div style="display:flex; justify-content:flex-end; gap:10px;">
        <button class="pill" onclick="clearSortFilter()">Clear</button>
        <button class="pill" style="border-color:#111; background:#111; color:#fff;" onclick="applySortFilter()">Apply</button>
      </div>
    </div>
  </div>
</div>

<script>
  function getToken(){ return localStorage.getItem("sensys_token") || ""; }

  // ✅ CCC-PDW v1: force login if token missing
  (function guard(){
    const t = getToken();
    if(!t){
      window.location.href = "/sensys/login";
      return;
    }
  })();

  function setMsg(text, ok){
    const el = document.getElementById("msg");
    el.textContent = text || "";
    if(ok){ el.classList.add("ok"); } else { el.classList.remove("ok"); }
  }

  let currentBucket = "unassigned";
  let itemsCache = []; // raw items from API for the current bucket

  let sfState = {
    sort: "due_at",
    agency: "",
    task: "",
    staff: ""
  };

  function setBucket(b){
    currentBucket = b;
    document.getElementById("tabUnassigned").classList.toggle("active", b==="unassigned");
    document.getElementById("tabIncomplete").classList.toggle("active", b==="incomplete");
    document.getElementById("tabCompleted").classList.toggle("active", b==="completed");

    const help = document.getElementById("bucketHelp");
    if(b==="unassigned") help.textContent = "Items due now that have not been assigned yet.";
    if(b==="incomplete") help.textContent = "Assigned items not completed yet (end-of-day review).";
    if(b==="completed") help.textContent = "Items completed by staff.";
    loadItems();
  }

  async function apiGet(url){
    const resp = await fetch(url, {
      headers: { "Authorization": "Bearer " + getToken() }
    });
    const data = await resp.json().catch(()=>({}));
    if(!resp.ok) throw new Error(data.detail || "Request failed");
    return data;
  }

  async function apiPost(url, payload){
    const resp = await fetch(url, {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + getToken(),
        "Content-Type": "application/json"
      },
      body: JSON.stringify(payload || {})
    });
    const data = await resp.json().catch(()=>({}));
    if(!resp.ok) throw new Error(data.detail || "Request failed");
    return data;
  }

  function fmt(s){
    if(!s) return "";
    return String(s).replace("T"," ").slice(0,16);
  }
  function fmtDateOnly(s){
    if(!s) return "";
    // expects "YYYY-MM-DD ..." → keep only the date
    return String(s).replace("T"," ").slice(0,10);
  }


  function esc(s){
    return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
  }

  async function loadItems(){
    setMsg("", true);
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "<tr><td colspan='6' class='muted'>Loading…</td></tr>";

    try{
      const data = await apiGet("/api/sensys/postdc/work-items?bucket=" + encodeURIComponent(currentBucket));
      itemsCache = data.items || [];

      renderItemsFromCache();
      return;

      tbody.innerHTML = "";
      items.forEach(it => {
        const patient = (it.patient_last_name||"") + ", " + (it.patient_first_name||"");
        const adm = "Adm #" + (it.admission_id||"");
        const assigned = it.assigned_to_name ? it.assigned_to_name : "—";

        const tr = document.createElement("tr");
        const agency = it.agency_name || "—"; // ✅ moved up BEFORE patientLabel uses it
        const dc = it.dc_date ? String(it.dc_date).slice(0,10) : "";
        const daysSinceDc = (it.dc_date ? Math.max(0, Math.floor((Date.now() - new Date(it.dc_date).getTime()) / 86400000)) : "—");

        let btns = "";
        if(currentBucket === "unassigned"){
          const patientLabel = `${patient} (${agency})`; // ✅ now safe
          btns = `<div class="rowBtns">
                    <button onclick="openAssignModal(${Number(it.id)}, '${esc(patientLabel)}')">Assign…</button>
                  </div>`;
        } else if(currentBucket === "incomplete"){
          btns = `<div class="rowBtns">
                    <button onclick="openAssignModal(${Number(it.id)}, '${esc(patientLabel)}')">Re-assign…</button>
                    <button onclick="logAttempt(${Number(it.id)})">Log Attempt</button>
                    <button onclick="markComplete(${Number(it.id)})">Complete</button>
                  </div>`;
        } else {
          btns = `<span class="pill">${esc(it.last_outcome||"Done")}</span>`;
        }

        tr.innerHTML = `
          <td>
            <b>${esc(patient)}</b>
            <div class="muted">${esc(agency)}${dc ? " • DC " + esc(dc) : ""}</div>
          </td>
          <td>${esc(daysSinceDc)}</td>
          <td>
            <b>${esc(it.task_label||it.task_type||"")}</b>
            <div class="muted">Attempts: ${(it.attempt_count||0)}/${(it.max_attempts||2)}</div>
          </td>
          <td>
            <div class="muted" style="margin-bottom:2px;">Assigned To: ${esc(it.assigned_to_name || "—")}</div>
            <div><b>${esc(fmtDateOnly(it.due_at))}</b></div>
          </td>
          <td style="white-space:nowrap;">${btns}</td>
          <td style="white-space:nowrap;" id="rowIcons_${Number(it.id)}"></td>
        `;
        tbody.appendChild(tr);
      });

    }catch(e){
      tbody.innerHTML = "<tr><td colspan='6' class='muted'>Error loading.</td></tr>";
      setMsg(e.message || "Error", false);
    }
  }

  let assignWorkItemId = null;
  let assignSelectedStaffId = null;

  function openAssignModal(workItemId, patientLabel){
    assignWorkItemId = Number(workItemId);
    assignSelectedStaffId = null;
    document.getElementById("assignNotes").value = "";
    document.getElementById("assignMsg").textContent = "";
    document.getElementById("assignSub").textContent = patientLabel || "—";
    document.getElementById("assignModalBg").style.display = "flex";
    loadAssignStaff();
  }

  function renderItemsFromCache(){
    const tbody = document.getElementById("tbody"); // ✅ matches <tbody id="tbody"></tbody>
    if(!tbody) return;

    const items = getFilteredSortedItems();

    if(!items.length){
      tbody.innerHTML = "<tr><td colspan='6' class='muted'>No items.</td></tr>";
      return;
    }

    // ✅ Use your EXISTING row rendering that already builds <tr> and tbody.appendChild(tr)
    tbody.innerHTML = "";
    items.forEach(it => {
      const patient = (it.patient_last_name||"") + ", " + (it.patient_first_name||"");
      const tr = document.createElement("tr");
      const agency = it.agency_name || "—";
      const dc = it.dc_date ? String(it.dc_date).slice(0,10) : "";
      const daysSinceDc = (it.dc_date ? Math.max(0, Math.floor((Date.now() - new Date(it.dc_date).getTime()) / 86400000)) : "—");

      let btns = "";
      const patientLabel = `${patient} (${agency})`;

      if(currentBucket === "unassigned"){
        btns = `<div class="rowBtns">
                  <button onclick="openAssignModal(${Number(it.id)}, '${esc(patientLabel)}')">Assign…</button>
                </div>`;
      } else if(currentBucket === "incomplete"){
        btns = `<div class="rowBtns">
                  <button onclick="openAssignModal(${Number(it.id)}, '${esc(patientLabel)}')">Re-assign…</button>
                  <button onclick="logAttempt(${Number(it.id)})">Log Attempt</button>
                  <button onclick="markComplete(${Number(it.id)})">Complete</button>
                </div>`;
      } else {
        btns = `<span class="pill">${esc(it.last_outcome||"Done")}</span>`;
      }

      tr.innerHTML = `
        <td>
          <b>${esc(patient)}</b>
          <div class="muted">${esc(agency)}${dc ? " • DC " + esc(dc) : ""}</div>
        </td>
        <td>${esc(daysSinceDc)}</td>
        <td>
          <b>${esc(it.task_label||it.task_type||"")}</b>
          <div class="muted">Attempts: ${(it.attempt_count||0)}/${(it.max_attempts||2)}</div>
        </td>
        <td>
          <div class="muted" style="margin-bottom:2px;">Assigned To: ${esc(it.assigned_to_name || "—")}</div>
          <div><b>${esc(fmtDateOnly(it.due_at))}</b></div>
        </td>
        <td style="white-space:nowrap;">${btns}</td>
        <td style="white-space:nowrap;" id="rowIcons_${Number(it.id)}"></td>
      `;
      tbody.appendChild(tr);
    });
  }

  function closeAssignModal(){
    document.getElementById("assignModalBg").style.display = "none";
  }

  async function loadAssignStaff(){
    const box = document.getElementById("assignStaffList");
    box.innerHTML = `<div class="muted">Loading staff…</div>`;

    try{
      const data = await apiGet("/api/sensys/postdc/staff/overview?day_offset=0");
      const staff = data.staff || [];
      if(staff.length === 0){
        box.innerHTML = `<div class="muted">No CCC Staff found.</div>`;
        return;
      }

      box.innerHTML = "";
      staff.forEach(s => {
        const pct = Number(s.caseload_pct||0);
        const start = s.available_start ? s.available_start : "—";
        const end = s.available_end ? s.available_end : "—";
        const cph = (s.calls_per_hour!=null) ? s.calls_per_hour : 0;

        const row = document.createElement("div");
        row.className = "pill";
        row.style.padding = "10px 12px";
        row.style.borderRadius = "14px";
        row.style.cursor = "pointer";
        row.onclick = () => {
          assignSelectedStaffId = Number(s.user_id);
          [...box.children].forEach(ch => ch.style.boxShadow = "");
          row.style.boxShadow = "0 0 0 3px rgba(0,0,0,.10)";
        };

        row.innerHTML = `
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
            <div>
              <div style="font-weight:800;">${esc(s.display_name || s.email || "")}</div>
              <div class="muted">Next availability: ${esc(start)}–${esc(end)}</div>
              <div class="muted">Calls/hr: ${esc(String(cph))}</div>
            </div>
            <div style="min-width:150px;">
              <div class="muted" style="text-align:right;">Caseload</div>
              <div style="height:10px; border:1px solid #e6e7ee; border-radius:999px; overflow:hidden; margin-top:6px;">
                <div style="height:10px; width:${pct}%; background:#111;"></div>
              </div>
              <div class="muted" style="text-align:right; margin-top:6px;">${pct}%</div>
            </div>
          </div>
        `;
        box.appendChild(row);
      });

    }catch(e){
      box.innerHTML = `<div class="muted">Error loading staff.</div>`;
    }
  }

  function openSortFilter(){
    document.getElementById("sfBg").style.display = "flex";
    rebuildSortFilterOptions();
    // set current UI values
    document.getElementById("sfSort").value = sfState.sort || "due_at";
    document.getElementById("sfAgency").value = sfState.agency || "";
    document.getElementById("sfTask").value = sfState.task || "";
    document.getElementById("sfStaff").value = sfState.staff || "";
  }
  function closeSortFilter(){
    document.getElementById("sfBg").style.display = "none";
  }

  function clearSortFilter(){
    sfState = { sort:"due_at", agency:"", task:"", staff:"" };
    closeSortFilter();
    renderItemsFromCache();
  }

  function applySortFilter(){
    sfState.sort = document.getElementById("sfSort").value || "due_at";
    sfState.agency = document.getElementById("sfAgency").value || "";
    sfState.task = document.getElementById("sfTask").value || "";
    sfState.staff = document.getElementById("sfStaff").value || "";
    closeSortFilter();
    renderItemsFromCache();
  }

  function rebuildSortFilterOptions(){
    const ag = document.getElementById("sfAgency");
    const tk = document.getElementById("sfTask");
    const st = document.getElementById("sfStaff");

    const uniq = (arr) => Array.from(new Set(arr.filter(Boolean).map(x => String(x).trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));

    const agencies = uniq(itemsCache.map(it => it.agency_name));
    const tasks = uniq(itemsCache.map(it => it.task_label || it.task_type));
    const staff = uniq(itemsCache.map(it => it.assigned_to_name));

    ag.innerHTML = `<option value="">All</option>` + agencies.map(a => `<option value="${esc(a)}">${esc(a)}</option>`).join("");
    tk.innerHTML = `<option value="">All</option>` + tasks.map(t => `<option value="${esc(t)}">${esc(t)}</option>`).join("");
    st.innerHTML = `<option value="">All</option>` + staff.map(s => `<option value="${esc(s)}">${esc(s)}</option>`).join("");
  }

  function getFilteredSortedItems(){
    let list = (itemsCache || []).slice();

    if(sfState.agency){
      list = list.filter(it => String(it.agency_name||"") === sfState.agency);
    }
    if(sfState.task){
      list = list.filter(it => String(it.task_label||it.task_type||"") === sfState.task);
    }
    if(sfState.staff){
      list = list.filter(it => String(it.assigned_to_name||"") === sfState.staff);
    }

    const key = sfState.sort || "due_at";
    const safe = (v) => (v==null ? "" : String(v));

    list.sort((a,b)=>{
      if(key === "patient"){
        const ap = (safe(a.patient_last_name) + ", " + safe(a.patient_first_name)).toLowerCase();
        const bp = (safe(b.patient_last_name) + ", " + safe(b.patient_first_name)).toLowerCase();
        return ap.localeCompare(bp);
      }
      if(key === "agency"){
        return safe(a.agency_name).toLowerCase().localeCompare(safe(b.agency_name).toLowerCase());
      }
      if(key === "dc_date"){
        return safe(a.dc_date).localeCompare(safe(b.dc_date));
      }
      // default: due_at
      return safe(a.due_at).localeCompare(safe(b.due_at));
    });

    return list;
  }

  async function submitAssign(){
    const msg = document.getElementById("assignMsg");
    msg.textContent = "";
    if(!assignWorkItemId || !assignSelectedStaffId){
      msg.textContent = "Pick a CCC Staff member first.";
      return;
    }
    const notes = (document.getElementById("assignNotes").value || "").trim();

    try{
      await apiPost("/api/sensys/postdc/work-items/assign", {
        work_item_id: assignWorkItemId,
        assigned_to_user_id: assignSelectedStaffId,
        assignment_notes: notes
      });
      closeAssignModal();
      setMsg("Assigned.", true);
      loadItems();
      loadSummary();
      loadStaffAvailability();
    }catch(e){
      msg.textContent = e.message || "Assign failed";
    }
  }

  async function loadStaffAvailability(){
    const dayOffset = Number(document.getElementById("availDay").value || 0);
    const box = document.getElementById("staffAvailList");
    box.innerHTML = `<div class="muted">Loading…</div>`;

    try{
      const data = await apiGet("/api/sensys/postdc/staff/overview?day_offset=" + encodeURIComponent(dayOffset));
      const staff = data.staff || [];
      if(staff.length === 0){
        box.innerHTML = `<div class="muted">No CCC Staff scheduled for the selected day.</div>`;
        return;
      }


      box.innerHTML = "";
      staff.forEach(s => {
        const pct = Number(s.caseload_pct||0);
        const start = s.available_start ? s.available_start : "—";
        const end = s.available_end ? s.available_end : "—";
        const cph = (s.calls_per_hour!=null) ? s.calls_per_hour : 0;

        const row = document.createElement("div");
        row.className = "pill";
        row.style.padding = "10px 12px";
        row.style.borderRadius = "14px";

        row.innerHTML = `
          <div style="display:flex; justify-content:space-between; gap:10px;">
            <div>
              <div style="font-weight:800;">${esc(s.display_name || s.email || "")}</div>
              <div class="muted">${esc(start)}–${esc(end)} • Calls/hr: ${esc(String(cph))}</div>
            </div>
            <div style="min-width:160px;">
              <div class="muted" style="text-align:right;">Caseload %</div>
              <div style="height:10px; border:1px solid #e6e7ee; border-radius:999px; overflow:hidden; margin-top:6px;">
                <div style="height:10px; width:${pct}%; background:#111;"></div>
              </div>
              <div class="muted" style="text-align:right; margin-top:6px;">${pct}%</div>
            </div>
          </div>
        `;
        box.appendChild(row);
      });

    }catch(e){
      box.innerHTML = `<div class="muted">Error loading staff availability.</div>`;
    }
  }

  function staffSchedSetMsg(text, ok){
    const el = document.getElementById("staffSchedMsg");
    el.textContent = text || "";
    el.style.color = ok ? "#0a7a2f" : "#b00020";
  }

  function openStaffSchedules(){
    document.getElementById("staffSchedBg").style.display = "flex";
    staffSchedSetMsg("", true);
    loadStaffSchedules();
  }

  function closeStaffSchedules(){
    document.getElementById("staffSchedBg").style.display = "none";
  }

  async function loadStaffSchedules(){
    const tbody = document.getElementById("staffSchedTbody");
    tbody.innerHTML = `<tr><td colspan="5" class="muted">Loading…</td></tr>`;

    try{
      // ✅ You need a backend route that returns CCC Staff + their schedules
      // Expected shape:
      // { ok:true, staff:[ { user_id, display_name, last_login_at, calls_per_hour, schedules:[{id, day_of_week, start_time, end_time}] } ] }
      const d = await apiGet("/api/sensys/postdc/staff/schedules");

      const staff = d.staff || [];
      if(!staff.length){
        tbody.innerHTML = `<tr><td colspan="5" class="muted">No CCC Staff found.</td></tr>`;
        return;
      }

      tbody.innerHTML = "";
      staff.forEach(u => {
        const tr = document.createElement("tr");

        const schedRows = (u.schedules || []).map(s => scheduleRowHtml(u.user_id, s)).join("");
        const schedBox = `
          <div style="display:grid; gap:8px;">
            <div data-schedwrap="${u.user_id}" style="display:grid; gap:8px;">
              ${schedRows || `<div class="muted">No schedules yet.</div>`}
            </div>
            <div>
              <button class="pill" style="cursor:pointer;" onclick="addScheduleRow(${Number(u.user_id)})">+ Add schedule</button>
            </div>
          </div>
        `;

        tr.innerHTML = `
          <td><b>${esc(u.display_name || "")}</b></td>
          <td class="muted">${fmt(u.last_login_at) || "—"}</td>
          <td>
            <input data-cph="${u.user_id}"
                   type="number"
                   step="0.1"
                   min="0"
                   value="${Number(u.calls_per_hour || 0)}"
                   style="width:110px; padding:8px 10px; border:1px solid #e6e7ee; border-radius:10px;">
          </td>
          <td>${schedBox}</td>
          <td></td>
        `;

        tbody.appendChild(tr);
      });

    }catch(e){
      tbody.innerHTML = `<tr><td colspan="5" class="muted">Error loading staff schedules.</td></tr>`;
      staffSchedSetMsg(e.message || "Error", false);
    }
  }

  function scheduleRowHtml(userId, s){
    const sid = s.id ? Number(s.id) : 0;
    const day = (s.day_of_week ?? "");
    const start = (s.start_time ?? "");
    const end = (s.end_time ?? "");
    return `
      <div data-schedrow="${userId}" data-scheduleid="${sid}" style="display:grid; grid-template-columns: 160px 140px 140px auto; gap:8px; align-items:center;">
        <select data-day style="padding:8px 10px;border-radius:10px;border:1px solid #e6e7ee;background:#fff;">
          ${dayOpt(1, day)}${dayOpt(2, day)}${dayOpt(3, day)}${dayOpt(4, day)}${dayOpt(5, day)}${dayOpt(6, day)}${dayOpt(0, day)}
        </select>
        <input data-start type="time" value="${esc(start)}" style="padding:8px 10px;border-radius:10px;border:1px solid #e6e7ee;">
        <input data-end type="time" value="${esc(end)}" style="padding:8px 10px;border-radius:10px;border:1px solid #e6e7ee;">
        <button class="pill" style="cursor:pointer; width:max-content;" onclick="removeScheduleRow(this)">Remove</button>
      </div>
    `;
  }

  function dayOpt(val, current){
    // Backend uses 0=Sun..6=Sat
    const label = ({
      1:"Mon", 2:"Tue", 3:"Wed", 4:"Thu", 5:"Fri", 6:"Sat", 0:"Sun"
    })[val] || String(val);

    const sel = (String(current) === String(val)) ? "selected" : "";
    return `<option value="${val}" ${sel}>${label}</option>`;
  }

  function addScheduleRow(userId){
    const wrap = document.querySelector(`[data-schedwrap="${userId}"]`);
    if(!wrap) return;

    // if the wrap currently has the "No schedules yet." line, remove it
    if(wrap.querySelector(".muted")) wrap.innerHTML = "";

    wrap.insertAdjacentHTML("beforeend", scheduleRowHtml(userId, { id: 0, day_of_week: 1, start_time: "09:00", end_time: "17:00" }));
  }

  function removeScheduleRow(btn){
    const row = btn.closest("[data-schedrow]");
    if(row) row.remove();
  }

  async function saveStaffSchedules(){
    staffSchedSetMsg("Saving…", true);

    try{
      // Build payload: calls/hr + schedules per user
      const tbody = document.getElementById("staffSchedTbody");
      const userIds = Array.from(tbody.querySelectorAll("[data-cph]")).map(i => Number(i.getAttribute("data-cph")));
      const uniqUserIds = Array.from(new Set(userIds));

      const payload = uniqUserIds.map(uid => {
        const cphEl = tbody.querySelector(`[data-cph="${uid}"]`);
        const cph = Number(cphEl ? cphEl.value : 0);

        const schedRows = Array.from(tbody.querySelectorAll(`[data-schedrow="${uid}"]`)).map(r => {
          return {
            id: Number(r.getAttribute("data-scheduleid") || 0) || 0,
            day_of_week: (r.querySelector("[data-day]")?.value || "").trim(),
            start_time: (r.querySelector("[data-start]")?.value || "").trim(),
            end_time: (r.querySelector("[data-end]")?.value || "").trim(),
          };
        });

        return { user_id: uid, calls_per_hour: cph, schedules: schedRows };
      });

      // ✅ You need a backend route that upserts schedules + saves capacity
      // Expected: POST /api/sensys/postdc/staff/schedules/upsert
      // Backend expects ONE StaffScheduleUpsertIn per call.
      // So we upsert each staff member separately.
      await Promise.all((payload || []).map(row =>
        apiPost("/api/sensys/postdc/staff/schedules/upsert", row)
      ));

      staffSchedSetMsg("Saved.", true);
      loadStaffSchedules();      // refresh view
      loadStaffAvailability();   // refresh right-side availability too
    }catch(e){
      staffSchedSetMsg(e.message || "Save failed", false);
    }
  }

  async function logAttempt(workItemId){
    const outcome = prompt("Outcome (voicemail/no_answer/reached/etc):");
    if(!outcome) return;
    const note = prompt("Note (optional):") || "";
    const nextDue = prompt("Next due datetime (optional, e.g. 2026-01-14 09:00:00). Leave blank to keep:", "") || "";

    try{
      await apiPost("/api/sensys/postdc/work-items/attempt", {
        work_item_id: workItemId,
        outcome: outcome,
        note: note,
        next_due_at: nextDue.trim() ? nextDue.trim() : null
      });
      setMsg("Attempt saved.", true);
      loadItems();
    }catch(e){
      setMsg(e.message || "Attempt failed", false);
    }
  }

  async function loadSummary(){
    try{
      const d = await apiGet("/api/sensys/postdc/summary");
      document.getElementById("sumUnassigned").textContent = d.unassigned_calls ?? "—";
      document.getElementById("sumDueToday").textContent = d.total_due_today ?? "—";
      document.getElementById("sumCompleted").textContent = d.completed_today ?? "—";
      document.getElementById("sumIncomplete").textContent = d.incomplete_today ?? "—";
    }catch(e){
      // ignore
    }
  }

  async function markComplete(workItemId){
    const outcome = prompt("Completion outcome (reached/voicemail/no_answer/etc):");
    if(!outcome) return;
    const note = prompt("Completion note (optional):") || "";

    try{
      await apiPost("/api/sensys/postdc/work-items/complete", {
        work_item_id: workItemId,
        outcome: outcome,
        note: note
      });
      setMsg("Completed.", true);
      loadItems();
    }catch(e){
      setMsg(e.message || "Complete failed", false);
    }
  }

  function logout(){
    localStorage.removeItem("sensys_token");
    window.location.href = "/sensys/login";
  }

  // init
  setBucket("unassigned");
  loadSummary();
  loadStaffAvailability();
</script>

</body>
</html>
